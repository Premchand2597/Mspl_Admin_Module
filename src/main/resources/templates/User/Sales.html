<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Sale</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <!-- <link href="https://fonts.gstatic.com" rel="preconnect"> -->
  <!-- <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet"> -->
  
  <link rel="stylesheet" href="/assets/font/fonts.css"> 
  
  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">
  <link href="assets/css/style_1.css" rel="stylesheet">
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="assets/js/sweetalert2.all.min.js"></script>
  
  <!-- =======================================================
  * Template Name: NiceAdmin
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Updated: Apr 20 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  </head>
   <style>
        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            width: 22.5%;
            z-index: 1000;
            display: none;
            font-size:14px;
        }
        .suggestions div {
            padding: 8px;
            cursor: pointer;
        }
        .suggestions div:hover {
            background: #f1f1f1;
        }
		/* Ensure version number appears on a new line */
								.release-note-text {
								  display: flex;
								  flex-direction: column; /* Stacks elements vertically */
								  font-size: 1rem;
								}

								/* Optional: Adjust the version number styling */
								.version-number {
								  font-size: 0.9rem;
								  font-weight: bold;
								  color: #555;
								}
								
    </style>
  <style>
   .table-container {
            max-height: 345px; /* Adjust as needed */
            overflow-y: auto;
            border-radius: 4px;
            position: relative;
        }

        .table-container thead {
            position: sticky;
            top: 0;
            background-color: #f8f9fa; /* Light background for the header */
            z-index: 1; /* Ensure the header is above the scrolling content */
        }

        .table-container::-webkit-scrollbar {
            width: 5px; /* Width of the scrollbar */
        }

        .table-container::-webkit-scrollbar-track {
            background:#edeef5; /* Track color */
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888; /* Scrollbar color */
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555; /* Hover color */
        }
        .form-label{
        	 
        }
        .profile-table th{
        	 
   			 color: rgba(1, 41, 112, 0.6);
        }
        
        .updateEmployeeForm input,
        .updateEmployeeForm select,
        .updateEmployeeForm textarea
        {
        	font-size:12px;
        }
        .changePassword label{
        	font-size:12px;
        }
        	  /* Custom select container */
		.select-container {
		  position: relative;
		  display: inline-block;
		}
		
		/* Hide default arrow */
		.select-container select {
		  appearance: none;
		  -webkit-appearance: none;
		  -moz-appearance: none;
		  background: transparent;
		  padding-right: 2.5rem; /* Adjust based on the size of the arrow */
		}
		
		/* Custom arrow icon */
		.select-container::after {
		  content: "";
		  position: absolute;
		  top: 50%;
		  right: 0.5rem; /* Adjust based on the size of the arrow */
		  transform: translateY(-50%);
		  width: 2rem; /* Adjust based on the size of the arrow */
		  height: 0.8rem; /* Adjust based on the size of the arrow */
		  background: url('assets/img/down-arrow.png') no-repeat center center;
		  background-size: contain;
		  pointer-events: none;
		}
		
		/* Optional: Add focus style to the select element */
		.select-container select:focus {
		  outline: none;
		}
		
		/* Container styling */
		.select-container {
		    position: relative;
		    width: 100%;
		}
		
		/* Styling the multi-select dropdown */
		#department {
		    display: block;
		    width: 100%;
		    height: 32px; /* Default height when not extended */
		    overflow: hidden; /* Hide overflow */
		    white-space: nowrap;
		    text-overflow: ellipsis; /* Adds ellipsis for overflow text */
		    transition: all 0.3s ease; /* Smooth transition for height */
		}
		
		/* Dropdown expands when clicked */
		#department:focus, #department:hover {
		    height: auto; /* Expands to fit content */
		    overflow: auto; /* Allows scrolling when expanded */
		}
		
		/* Adjust scrollbar visibility (optional) */
		#department::-webkit-scrollbar {
		    width: 6px;
		}
		
		#department::-webkit-scrollbar-thumb {
		    background-color: #ccc;
		    border-radius: 4px;
		}
		
		#department::-webkit-scrollbar-thumb:hover {
		    background-color: #888;
		}
		
		/* Optional: Style error message */
		#dept_error {
		    color: red;
		    font-size:12px;
		    margin-top: 5px;
		}
		/* Optional: Style error message */
		.summary-container { 
		    display: flex;
		    justify-content: flex-end;
		}		
		.summary-table {
		    width: 300px;
		    border-collapse: collapse;
		    
		    background-color: #f9f9f9;
		}
		.summary-table td {
		    padding: 2px 12px;
		    font-size:12px;
		}
		.summary-table td:first-child {
		    font-weight: bold;
		    background-color: #f1f1f1;
		}
		.final-row td {
		    font-weight: bold !important;
		}
		.summary-table td:nth-child(2) {
		    text-align: right;
		    border: 1px solid #ccc;
		    
		}

  </style>
  

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center" th:if="${empDetailsByEmpId.deptId>0}">
 
		   <div class="d-flex align-items-center logo-container" style="width:45%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/userDashboard}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
				    <!-- <i class="bi bi-chevron-double-left toggle-sidebar-btn" onclick="toggleIconRotation()"></i> -->
			</div>				
			<div th:replace="fragments/header :: header" ></div>
	
  </header><!-- End Header -->
  
  <!-- =======Super Admin Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center" th:if="${empDetailsByEmpId.deptId == 0}">

    <div class="d-flex align-items-center logo-container" style="width:45%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/navbar}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
	</div><!-- End Logo -->

    <div th:replace="fragments/superAdminHeader :: header"></div>

  </header><!-- End Header -->


  <!-- ======= Sidebar ======= -->
  
<aside id="sidebar" class="sidebar">
<input type="hidden" id="employee-id" th:value="${empDetailsByEmpId.deptId}">
<input type="hidden" id="employeeId1" name="empId" th:value="${empDetailsByEmpId.empid}" />
<input type="hidden" id="loggedEmpEmail" th:value="${empDetailsByEmpId.email}">

    <ul class="sidebar-nav" id="sidebar-nav">
		 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/userDashboard}">
                <i class="bi bi-grid"></i>
                <span>Dashboard</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link " th:href="@{/navbar}">
		        <i class="bi bi-grid"></i>
		        <span>Dashboard</span>
		    </a>
	    </li>
	    <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
			<a class="nav-link" th:href="@{/Departmentdoc}">
				<i class="bi bi-journal-bookmark"></i>
				<span>MSPL DocVault</span>
			</a>
		</li>
		
		<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
			<a class="nav-link" th:href="@{/Departmentdoc}">
				<i class="bi bi-journal-bookmark"></i>
				<span>MSPL DocVault</span>
			</a>
		</li>    
		<li class="nav-item" th:if="${session.permissions.dispatch && empDetailsByEmpId.deptId==0}">
            <a class="nav-link" th:href="@{/dispatchIframe}">
                <i class="bi bi-truck"></i>
                <span>Dispatched Details</span>
            </a>
        </li>
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminProfile(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-person"></i>
                 <span>My Profile</span>
            </a>
        </li>  
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/attendanceLive(email=${empDetailsByEmpId.email})}">
                <i class="bi bi-calendar3"></i>
                <span>Attendence</span>
            </a> 
        </li>      
       <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/groupMailId}">
                <i class="bi bi-telephone"></i>
                <span>Employee Contacts</span>
            </a>
        </li>
       <!--  <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link " th:href="@{/InterCommDetails}">
                <i class="bi bi-telephone"></i>
                <span>InterComm Details</span>
            </a>
        </li> -->
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/adminHoliday}">
                <i class="bi bi-calendar4-week"></i>
                <span>Holiday List</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
		    <a class="nav-link" th:href="@{/employee}">
		        <i class="bi bi-people"></i>	
		        <span>Employee</span>
		    </a>
	   </li> 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-card-text"></i>
                <span>Team Leaves</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/events}">
                <i class="bi bi-megaphone"></i>
                <span>Announcement</span>
            </a>
        </li>               
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/asset}">
                <i class="bi bi-wallet"></i>
                <span>Assets</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/ongoingProject}">
                <i class="bi bi-card-heading"></i>
                <span>Projects</span>
            </a>
        </li> 
         <!-- <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminPayslip(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-file-text"></i>
                <span>Payslip</span>
            </a>
        </li>     --> 
         <!-- Loop through the permissions map -->
       <li class="nav-item" th:if="${permissions.interviewAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
        </li>
         <li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId>0}">
			    <a class="nav-link collapsed" data-bs-target="#presales-submenu" data-bs-toggle="collapse" href="#">
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Pre-sales</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a> 
			    <ul id="presales-submenu" class="nav-content collapse" data-bs-parent="#sidebar-nav">
			        <li>
			            <a th:href="@{/crm}">
			                <i class="bi bi-circle"></i><span>Activity</span>
			            </a>
			        </li>
			        <li>
			            <a th:href="@{/deals}">
			                <i class="bi bi-circle"></i><span>Pipedrive</span>
			            </a>
			        </li>
			    </ul>
			</li>
        <li class="nav-item" th:if="${permissions.sales && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link active" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.accountsAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/store}">
                <i class="bi bi-shop-window"></i>
                <span>Store</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.apprisalAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" id="apprisalLink" th:href="@{/apprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Appraisal</span>
		    </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
		    <a class="nav-link" id="apprisalLink" th:href="@{/employeeApprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Employee Appraisal</span>
		    </a>
		</li>
		<li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
				<a class="nav-link" th:href="@{/my-favorites}">
					<i class="bi bi-layout-text-window-reverse"></i>
					<span>To-Chat & Remind</span>
					<span id="unreadCountBadge" class="badge bg-primary" style="display: none;"></span>
				</a>
		</li>
       		<li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId>0}">
					    <a class="nav-link" th:href="@{/releasenotes}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					            Release Note 
					            <span class="version-number">(V.0.1.2)</span>
					        </span>
					    </a>
		</li>
        
	    <!-- <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link" th:href="@{/attendanceLive(email=${empDetailsByEmpId.email})}">
                <i class="bi bi-calendar3"></i>
                <span>Attendence</span>
            </a>
        </li>  -->
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/adminHoliday}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Holiday List</span>
		    </a>
	 </li>	
	 
	<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		     <a class="nav-link" th:href="@{/addInterComm}">
                <i class="bi bi-telephone"></i>
                <span>Communication</span>
            </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		     <a class="nav-link" th:href="@{/groupMailId}">
                <i class="bi bi-envelope-open"></i>
                <span>Group Mail Id</span>
            </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		<a class="nav-link" th:href="@{/hikeRatingForm}">
			<i class="bi bi-arrow-up-circle"></i><span>Appraisal Ratings</span>
		</a>
	</li>
	<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		<a class="nav-link" th:href="@{/apprisalEmployee}">
			<i class="bi bi-check-square"></i><span>Submitted Appraisals</span>
		</a>
	</li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
          <a class="nav-link" href="hrActivity">
	        <i class="bi bi-file-lock"></i><span>Permissions</span>
	    </a>
      </li>
	 <!--  <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/InterCommDetails}">
                <i class="bi bi-telephone"></i>
                <span>InterComm Details</span>
            </a>
      </li> -->
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link"  th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Employee Leaves</span>
		    </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/events}">
		        <i class="bi bi-megaphone"></i>
		        <span>Announcement</span>
		    </a>
	 </li> 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/addDepartment}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Department</span>
		    </a>
	   </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link"  th:href="@{/addRole}">
		        <i class="bi bi-receipt"></i>
		        <span>Role</span>
		    </a>
	 </li>
	 
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/employee}">
		        <i class="bi bi-people"></i>
		        <span>Employee</span>
		    </a>
	 </li> 
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/ongoingProject}">
                <i class="bi bi-calendar3"></i>
                <span>Projects</span>
            </a>
      </li>  
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/asset}">
                <i class="bi bi-wallet"></i>
                <span>Assets</span>
            </a>
      </li>  
      <li class="nav-item" th:if="${permissions.interviewAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
        </li>
              <li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId==0}">
			    <a class="nav-link collapsed" data-bs-target="#interview-summary-submenu" data-bs-toggle="collapse" href="#">
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Interview Summary</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a> 
			    <ul id="interview-summary-submenu" class="nav-content collapse" data-bs-parent="#sidebar-nav">
			        <li>
		            <a href="totalCandidatesList">
		              <i class="bi bi-circle"></i><span>Total Candidates</span>
			            </a>
			          </li>
			        <li>
		            <a href="selectedCandidatesList">
		              <i class="bi bi-circle"></i><span>Selected Candidates</span>
		            </a>
		          </li>
		          <li>
		            <a href="rejectedCandidatesList">
		              <i class="bi bi-circle"></i><span>Rejected Candidates</span>
		            </a>
		          </li>
			    </ul>
			</li>
         <li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId==0}">
			    <a class="nav-link collapsed" data-bs-target="#presales-submenu" data-bs-toggle="collapse" href="#">
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Pre-sales</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a> 
			    <ul id="presales-submenu" class="nav-content collapse" data-bs-parent="#sidebar-nav">
			        <li>
			            <a th:href="@{/crm}">
			                <i class="bi bi-circle"></i><span>Activity</span>
			            </a>
			        </li>
			        <li>
			            <a th:href="@{/deals}">
			                <i class="bi bi-circle"></i><span>Pipedrive</span>
			            </a>
			        </li>
			    </ul>
			</li>
        <li class="nav-item" th:if="${permissions.sales && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:classappend="${empDetailsByEmpId.deptId==0} ? ' active'" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.accountsAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/store}">
                <i class="bi bi-shop-window"></i>
                <span>Store</span>
            </a>
        </li>  
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
			    <a class="nav-link" href="feedbackReports">
			        <i class="bi bi-chat-square-text"></i>
			        <span>Feedback Reports</span>
			    </a>
		 </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}">
				<a class="nav-link" th:href="@{/my-favorites}">
					<i class="bi bi-layout-text-window-reverse"></i>
					<span>To-Chat & Remind</span>
				</a>
		</li>
		<li class="nav-item new-feature"  th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}">
					    <a class="nav-link" th:href="@{/releasenotes}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					            Release Note 
					            <span class="version-number">(Policy Update)</span>
					        </span>
					    </a>
		</li>
    </ul>
</aside>
  <!-- End Sidebar-->

  <main id="main" class="main p-0 pt-2">
  				<!-- Feedback Modal -->
  				<input type="hidden" id="loggedInDeptName" th:value="${empDetailsByEmpId.deptName}">
			<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
			    <div class="modal-dialog">
			        <div class="modal-content rounded-4 shadow-lg">
			            <div class="modal-header border-0">
			                <h5 class="modal-title" id="feedbackModalLabel">Feedback Form</h5>
			                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			            </div>
			            <div class="modal-body">
			                <form id="feedbackForm" method="post" enctype="multipart/form-data">
			                    <div class="mb-3" style="display: none;">
			                        <label for="feedbackName" class="form-label fw-bold">Your Name</label>
			                        <input type="text" class="form-control" id="feedbackName" name="name" th:value="${empDetailsByEmpId.fullName}" readonly>
			                    </div>
			                    <div class="mb-3" style="display: none;">
			                        <label for="feedbackEmail" class="form-label fw-bold">Your Email</label>
			                        <input type="email" class="form-control" id="feedbackEmail" name="email" th:value="${empDetailsByEmpId.email}" readonly>
			                    </div>
			                    <div class="mb-3">
			                        <label for="feedbackEmailyy" class="form-label fw-bold">To</label>
			                        <div class="to-field-container">
			                            <span class="to-field rounded-pill px-3 py-2 shadow-sm">bugs_msplconnect@melangesystems.com</span>
			                        </div>
			                    </div>
								<div class="mb-3">
								    <label for="bugType" class="form-label fw-bold">Bug Type</label>
								    <select class="form-control" id="bugType" name="bugType" required>
								        <option value="About Application">About Application</option>
								        <option value="New Feature">New Feature</option>
								    </select>
								</div>

			                    <div class="mb-3">
			                        <label for="feedbackMessage" class="form-label fw-bold">Message</label>
			                        <textarea class="form-control" id="feedbackMessage" name="message" rows="4" placeholder="Enter your feedback here..." required></textarea>
			                    </div>
			                    <div class="mb-3">
			                        <label for="feedbackAttachment" class="form-label fw-bold">Attachment (optional)</label>
			                        <input type="file" class="form-control" id="feedbackAttachment" name="attachment" accept=".png, .jpg, .jpeg" multiple>
			                        <small class="text-muted">Max size: 5MB. You can upload multiple images.</small>
			                    </div>
			                    <button type="submit" class="btn btn-primary w-100 mt-3 py-2 shadow-sm" id="submitFeedbackBtn">Submit Feedback</button>
			                </form>
			            </div>
			        </div>
			    </div>
			</div>
			
<!-- Purchase Order Modal -->
<div class="modal fade" id="purchaseOrderModal" tabindex="-1" aria-labelledby="purchaseOrderModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="purchaseOrderModalLabel">Add Sales Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Purchase Order Form -->
        <form id="purchaseOrderForm" enctype="multipart/form-data">
			<div class="row mb-3 justify-content-between">
			  <div class="col-md-3">
			    <label class="form-label">Date & Time</label>
				<input type="text" class="form-control text-center" id="podateTime" readonly />
				
			  </div>
			  <div class="col-md-4">
						    <label class="form-label">Sales Order ID</label>
						    <input type="text" class="form-control" id="poid" placeholder="Purchase Order ID" readonly />
						  </div>
			</div>
 			
          <!-- Row 1 -->
          <div class="row mb-2">
			
            <div class="col-md-4">
				
              <label class="form-label">PO Number</label>
              <input type="text" class="form-control" id="po_number" required>
            </div>
            
            <div class="col-md-4">
              <label class="form-label">Vendor Code</label>
              <input type="text" class="form-control" id="vendor_code" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">PO Date</label>
              <input type="date" class="form-control" id="po_date" required>
            </div>
          </div>
            <!-- New Row for Mode of Payment -->
		  <div class="row mb-2">
		    <div class="col-md-4">
		      <label class="form-label">Mode of Payment</label>
		      <input type="text" class="form-control" id="mode_of_payment" placeholder="Enter payment mode (e.g., NEFT, UPI)" required>
		    </div>
		  </div>
          <hr>
        
            <div class="row mb-3">
            <!-- <div class="col-md-4">
              <label class="form-label">Supplier Name</label>
              <input type="text" class="form-control" id="supplier_name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Supplier GST</label>
              <input type="text" class="form-control" id="supplier_gst" required>
            </div> -->
           
          </div>
		  <div class="col-md-3">
			    <label class="form-label">Quotation ID</label> 			     
			    <!-- <select class="form-select" id="quotationId" name="quotationId">
			    	<option value="" selected disabled>Select a Quotation ID</option>
			    	        <th:block th:each="qid : ${quotationIds}">
					            <option th:value="${qid}" th:text="${qid}"></option>
					        </th:block>
			    </select> -->
			    <input type="text" id="quotationId" name="quotationId" class="form-control" >
			</div>
			   <hr>
			        <div class="row">      
                    	<div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="company_honorifics1" class="form-control" readonly>
                        </div>              
                        <div class="col-md-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="vendorName1" class="form-control"  list="customerList" autocomplete="off" readonly required>
                            <div id="suggestionsBox1" class="suggestions"></div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Customer Legal Name</label>
                            <input type="text" id="vendorlegalNamee1" class="form-control" readonly required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST Number</label>
                            <input type="text" id="gstnumberr1" class="form-control" readonly required>
                        </div>
                         <div class="col-md-2">
                            <label class="form-label">Order Method</label>
                             <input type="text" id="orderMethod1" class="form-control" required>                           
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="contact_person_honorifics1" class="form-control" readonly>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Contact Person Name</label>
                           	 <select id="personName1" class="form-control form-select" required>
       						 <option value="">Select Contact Person</option>
    						</select>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label">Designation</label>
                            <input type="text" id="designation1" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mobile Number</label>
                            <input type="text" id="contactDetails1" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Email ID</label>
                            <input type="email" id="emailId1" class="form-control" readonly>
                        </div>
                   </div>   
		          <!-- Row 2 -->
		          <div class="row mb-3">
		            <div class="col-md-6">
		              <label class="form-label">Customer Billing Address</label>
		              <textarea class="form-control" id="billing_address" rows="2" required></textarea>
		            </div>
		            <!-- <div class="col-md-6">
		              <label class="form-label">Shipping Address</label>
		              <textarea class="form-control" id="shipping_address" rows="2" required></textarea>
		            </div> -->
		            <div class="col-md-6 mt-2"> 
                            <label class="form-label">Delivery Address</label>
                            <!-- <textarea id="deliveryAddress" class="form-control"></textarea> -->
                            <select id="shipping_address" class="form-control form-select"onchange="enableDeliveryAddressEdit()" required>
       						 <!-- <option value="">Select Delivery Address</option> -->
    						</select>
                        </div>
		          </div>
			
				 <hr>
            <!-- Row 3 -->
 			<h5>Tax Type</h5>
                    
                    <hr> 
                    <div class="d-flex align-items-center mb-3">
                        
                        <input type="checkbox" id="interState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGSTnew('interState1')"> 
                        <label class="form-check-label me-3" style="font-size: 14px;">Intrastate(CGST 9% + SGST 9%)</label>

                        <input type="checkbox" id="outerState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGSTnew('outerState1')"> 
                        <label class="form-check-label me-3" style="font-size: 14px;">Interstate(IGST 18%)</label> 
 
                   </div>        

		          <!-- Table for Items -->
		          <div class="table-responsive mb-3">
					<!-- Corrected table headers and body to match -->
					<table class="table table-bordered mb-0" id="po_items_table">
					  <thead class="table-light">
					    <tr>
					      <th>Sl No</th>
					      <th>Part No</th>
					      <th>HSN Code</th>
					      <th>Description</th>
					      <th>Quantity</th>
					      <th>Price</th>
						  <th>Taxable Value</th>
					      <th class="cgst-saleheader">CGST (9%)</th>
					      <th class="sgst-saleheader">SGST (9%)</th>
					      <th class="igst-saleheader">IGST (18%)</th> 
						  <th>Total Value</th>
					      <th class="action-col">Action</th> 
					    </tr>
					  </thead>
					  <tbody>
					    <tr>
					      <td><input type="number" class="form-control" name="slno[]" value="1" readonly></td>
					      <td><input type="text" class="form-control" name="part_no[]"></td>
					      <td><input type="text" class="form-control" name="hsn_code[]"></td>
					      <td><input type="text" class="form-control" name="description[]"></td>
					      <td><input type="number" class="form-control salequantity" name="quantity[]" oninput="calculateTotalsale(this)"></td>
					      <td><input type="number" class="form-control saleprice" name="price[]" oninput="calculateTotalsale(this)"></td>
						  <td><input type="number" class="form-control saletotal-without-gst" name="line_total[]" readonly></td>
						  <td class="cgst-value">
				             <input type="number" class="form-control salecgst" name="cgst[]" value="${product.cgst}" readonly/>
				          </td>
				          <td class="sgst-value">
				              <input type="number" class="form-control salesgst" name="sgst[]"  value="${product.sgst}" readonly/>
				          </td>
				          <td class="igst-value">
				             <input type="number" class="form-control saleigst" name="igst[]"  value="${product.igst}" readonly />
				          </td>
						  <!-- <td class="cgst-value d-none">—</td>
					      <td class="sgst-value d-none">—</td>
					      <td class="igst-value d-none">—</td> -->
						  <td><input type="number" class="form-control saletotal-with-gst" name="total_line_total[]" readonly></td>
					      <td class="action-col">
					        <button type="button" class="btn btn-danger removeRowBtn" onclick="removeRow(this)">Remove</button>
					      </td>
					      <td style="display:none;"><input type="hidden" class="form-control productId" name="product_id[]"></td>
					    </tr>
					  </tbody>
					</table>
					<div class="summary-container"> 
					    <table class="summary-table">
					        <tr>
					            <td>Total Amount:</td>
					            <td><span id="taxableTotalValue">0.00</span></td>
					        </tr>
					       <tr id="cgstTotalTaxValueCell">
							    <td>CGST:</td>
							    <td><span id="cgstTotalTaxValue">0.00</span></td>
							</tr>
							<tr id="sgstTotalTaxValueCell">
							    <td>SGST:</td>
							    <td><span id="sgstTotalTaxValue">0.00</span></td>
							</tr>
							<tr id="igstTotalTaxValueCell">
							    <td>IGST:</td>
							    <td><span id="igstTotalTaxValue">0.00</span></td>
							</tr>
					        <tr>
					            <td>Total Tax:</td>
					            <td><span id="taxTotalValue">0.00</span></td>
					        </tr>
					        <tr>
					            <td>Amount with Tax:</td>
					            <td><span id="amountWithTax">0.00</span></td>
					        </tr>
					        <tr>
					            <td>Round to:</td>
					            <td>
					                <select id="roundPreference" style="width:100%">
					                    <option value="even">Even</option>
					                    <option value="odd">Odd</option>
					                </select>
					            </td>
					        </tr>
					        <tr>
					            <td>Round Off (Decimal):</td>
					            <td><span id="roundOffDecimal">0.00</span></td>
					        </tr>
					        <tr class="final-row">
						       <td><strong>Final Amount:</strong></td>
						       <td><strong><span id="grandTotalValue">0.00</span></strong></td>
						   </tr>
					    </table>
					</div>
		            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addNewRow()">Add Item</button>
		          </div>
	
	          <!-- Grand Total -->
	      <!--    <div class="row mb-3">
	            <div class="col-md-3 ms-auto">
	              <label class="form-label">Grand Total</label>
	              <input type="number" class="form-control" id="grand_total" >
	            </div>
	          </div>-->
			  
			  
			  <!-- File Input for PDF Attachment -->
			  <div class="row mb-3">
			      <div class="col-md-6">
			          <label class="form-label">Attach PDF</label>
			          <input type="file" class="form-control" id="po_attachment" name="po_attachment" accept="application/pdf" onchange="showPreviewButton()">
			          <small class="form-text text-muted">Only PDF files are allowed.</small>
			      </div>
			  </div>

			  <!-- Preview Button (Initially Hidden) -->
			  <div id="previewButtonDiv" style="display:none;">
			      <button type="button" class="btn btn-primary" id="previewButton" onclick="previewPDF()">Preview PDF</button>
			  </div>
			  
			  <!-- Terms and Conditions Section -->
			            <div class="col-md-12 mt-3">
			              <label class="form-label">Terms And Conditions</label>
			              <textarea class="form-control" id="terms_and_conditionnew" rows="3"  style="font-size: 14px;">
			               
			              </textarea>
			            </div>
			            
			            <div class="col-md-12 mt-3">
							 <label class="form-label">Terms of Delivery</label>
							 <textarea class="form-control" id="terms_of_delivery" rows="3"  style="font-size: 14px;">
							 </textarea>
						</div>
	          <!-- Submit Button -->
	          <div class="text-end">
	            <button type="submit" class="btn btn-success">Submit Purchase Order</button>
	          </div>
	        </form>
	      </div>
	    </div>
	  </div>
	</div>
<!-- Modal for PDF Preview -->
	<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="pdfModalLabel">PDF Preview</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <!-- PDF iframe -->
	                <iframe id="pdfViewer" style="width:100%; height:500px;" frameborder="0"></iframe>
	            </div>
	        </div>
	    </div>
	</div>

			
  <input type="hidden" id="emp_idSessionValue" th:value="${empDetailsByEmpId.empid}">
     <!-- Display Success Message -->
        <div th:if="${message}" class="alert alert-success" role="alert">
            <span th:text="${message}"></span>
        </div>

        <!-- Display Error Message -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <span th:text="${error}"></span>
        </div>
        <div class="pagetitle  mb-0 d-flex"  th:if="${empDetailsByEmpId.deptId==0}">
         <i class="bi bi-chevron-double-left toggle-sidebar-btn mb-1" onclick="toggleIconRotation()" style="font-size:24px;color:#2F73B9;padding:0 10px;margin-left:-10px;margin-top:-10px;cursor:pointer;"></i>
      
			<nav class="w-100">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a th:href="@{/navbar}">Home</a></li>
							<li class="breadcrumb-item active">Sales</li>
						</ol>
					</div> 
					<div class="ms-auto mb-1">
				    <div class="d-flex justify-content-start gap-2">
					    <button type="button" class="btn btn-info  btn-width" data-bs-toggle="modal" data-bs-target="#quotationModal">Add Quotation</button>
					    <button type="button" class="btn btn-secondary  btn-width" data-bs-toggle="modal" data-bs-target="#customerModal">Add Customer</button>
					    <button type="button" class="btn btn-secondary  btn-width" data-bs-toggle="modal" data-bs-target="#productModal">Add Product</button>
						<!-- Purchase Order Button -->
						<button type="button" class="btn btn-secondary  btn-width p-0" data-bs-toggle="modal" data-bs-target="#purchaseOrderModal">
						   Sales Order
						</button>
					</div>
	            </div>
				</div>
			</nav>
		</div>
		
		<div class="pagetitle mb-0 d-flex" th:if="${empDetailsByEmpId.deptId > 0}">
	    <i class="bi bi-chevron-double-left toggle-sidebar-btn mb-1" onclick="toggleIconRotation()" style="font-size:24px; color:#2F73B9; padding:0 10px; margin-left:-10px; margin-top:-10px; cursor:pointer;"></i>
	
	    <nav class="w-100">
	        <div class="d-flex justify-content-between align-items-center">
	            <div>
	                <ol class="breadcrumb">
	                    <li class="breadcrumb-item"><a th:href="@{/userDashboard}">Home</a></li>
	                    <li class="breadcrumb-item active">Sales</li>
	                </ol>
	            </div>
	        	<div class="ms-auto mb-1">
				     <div class="d-flex justify-content-start gap-2">
					    <button type="button" class="btn btn-info  btn-width" data-bs-toggle="modal" data-bs-target="#quotationModal">Add Quotation</button>
					    <button type="button" class="btn btn-secondary  btn-width" data-bs-toggle="modal" data-bs-target="#customerModal">Add Customer</button>
					    <button type="button" class="btn btn-secondary  btn-width" data-bs-toggle="modal" data-bs-target="#productModal">Add Product</button>
						<!-- Purchase Order Button -->
						<button type="button" class="btn btn-secondary  btn-width p-0" data-bs-toggle="modal" data-bs-target="#purchaseOrderModal">
						  Sale Order
						</button>
					</div>
	            </div>
	        </div>
	    </nav>
	</div>

   <div class="text-end mb-1" >
		  <div class="navbar navbar-expand-lg navbar-light" style="background-color:#DEF5FA;border-radius:5px;padding:0 10px 0 10px;">
				<div id="main-content">
		   			 <!-- Sales Content (Initial Load) -->
				    <div id="sales" class="tab-content">
						<nav class="links" style="--items: 10;">
							<a href="add_products" class="nav-links" target="content-iframe">Products</a>
							<a href="add_vendors" class="nav-links" target="content-iframe">Customers</a>		
							<a href="add_quotation" class="nav-links" target="content-iframe" id="quotationTab">Quotation</a>
							<a href="salesOrder" class="nav-links" target="content-iframe" style="white-space: nowrap;">Sales Order</a>
							<!-- <a href="add_review" class="nav-links" target="content-iframe">Review</a> -->
							<a href="q_won" class="nav-links" target="content-iframe">Q.Won</a>
							<a href="dcData" class="nav-links" target="content-iframe" style="min-width: 160px;">Delivery Challan</a>
							<a href="performaInvoice" class="nav-links" target="content-iframe" style="min-width: 180px;">Performa Invoice</a>	
							<!-- <a href="performaInvoice" style="min-width: 170px;">Performa Invoice</a> -->
							<a href="invoice" class="nav-links" target="content-iframe" style="white-space: nowrap;">Invoice</a>
							<a href="q_loss" class="nav-links" target="content-iframe">Q.Loss</a>
							<span class="line"></span>
						</nav>
				    </div>
				</div>
			</div>
		</div>

<!-- Add Quotation Modal -->
<div class="modal fade" id="quotationModal" tabindex="-1" aria-labelledby="quotationModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quotationModalLabel">Add Quotation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Quotation Form -->
                <form id="quotationForm">
                
                <div class="row mb-3 justify-content-between">
						<div class="col-md-3">
							<input type="text" class="form-control" id="qid" placeholder="Quotation ID" disabled />
						</div>
						<div class="col-md-3">
							<input type="datetime-local" class="form-control text-center" id="qdateTime" disabled />
						</div>
					</div>
                
                
                    <div class="row">   
                    	<div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="company_honorifics" class="form-control" readonly>
                        </div>                 
                        <div class="col-md-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="vendorName" class="form-control"  list="customerList" autocomplete="off" required>
                            <div id="suggestionsBox" class="suggestions"></div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Customer Legal Name</label>
                            <input type="text" id="vendorlegalNamee" class="form-control" readonly required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST Number</label>
                            <input type="text" id="gstnumberr" class="form-control" readonly required>
                        </div>
                         <div class="col-md-2">
                            <label class="form-label">Order Method</label>
                            <select id="orderMethod" class="form-select">
                                <option value="Online">Online</option>
                                <option value="Phone">Phone</option>
                                <option value="In-Person">In-Person</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="contact_person_honorifics" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contact Person Name</label>
                           	 <select id="personName" class="form-control form-select" >
       						 <option value="">Select Contact Person</option>
    						</select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Designation</label>
                            <input type="text" id="designation" readonly class="form-control" >
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mobile Number</label>
                            <input type="text" readonly id="contactDetails" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Email ID</label>
                            <input type="email" readonly id="emailId" class="form-control">
                        </div>
                         <div class="col-md-6 mt-2">
                            <label class="form-label">Billing Address</label>
                             <!-- <input type="checkbox" id="sameAddress" onchange="copyAddress()" style="margin-left:10px;"> Same as Billing Address -->
                            <textarea readonly id="shipmentAddress" rows="2" class="form-control"></textarea>
						</div>
                        <div class="col-md-6 mt-2"> 
                            <label class="form-label">Delivery Address</label>
                            <!-- <textarea id="deliveryAddress" class="form-control"></textarea> -->
                            <select id="deliveryAddress" class="form-control form-select">
       						 <!-- <option value="">Select Delivery Address</option> -->
    						</select>
                        </div>
                   </div>

                   <hr>
                    <!-- GST Selection -->
                    <h5>Tax Type</h5>
                    
                     <hr>
                    <div class="d-flex align-items-center mb-3">
                        
                        <input type="checkbox" id="interState" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('interState')"> 
                        <label class="form-check-label me-3" style="font-size: 14px;">Intrastate(CGST 9% + SGST 9%)</label>

                        <input type="checkbox" id="outerState" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('outerState')"> 
                        <label class="form-check-label me-3" style="font-size: 14px;">Interstate(IGST 18%)</label>
 
                   </div>

                   <!-- Product Table -->
                  <hr>
                    <h5>Product Details</h5>
                   <hr>
			<div class="d-flex justify-content-between align-items-center" style="gap: 10px;">
			   
			     <div class="col-md-3">
			        <select class="form-control form-select" id="productName">
			            <option value="">Select Product</option>
			        </select>
			    </div>
			    <div class="col-md-3">
			        <input type="text"  class="form-control" id="hsnCode" readonly>
			            <!-- <option value="">Select HSN Code</option> -->
			    </div>
			    <div class="col-md-3">
			        <input type="text"  class="form-control" id="partNumber" readonly>
			          <!--   <option value="">Select Part Number</option> -->
			            
			      
			    </div>
			    <div class="col-md-3" style="display: none;">
			        <input type="text"  class="form-control" id="productDescription" readonly>
			    </div>
			    <div class="col-md-3" style="display:none">
			        <input type="text"  class="form-control" id="productId" readonly>
			        <!-- <option value="">Select Description</option> -->
			    </div>
			    
			    <div class="col-md-2">
			       <button type="button" class="btn btn-secondary w-100" onclick="addProduct()">Add Product</button>
			    </div>
			
			</div>
			<table class="table table-bordered mt-3">
			    <thead class="table bg-secondary">
			        <tr>
			            <th>Sl No</th>
			            <!-- <th>Product Name</th> -->
			            <th>HSN Code</th>
			            <th>Part Number</th>
			            <th>Description</th>
			            <th>Quantity</th>
			            <th>Price</th>
			            <th>Taxable Value</th>
			            <th class="cgst-header d-none">CGST (9%)</th>
			            <th class="sgst-header d-none">SGST (9%)</th>
			            <th class="igst-header d-none">IGST (18%)</th>            
			            <th>Total Value</th>
			            <th>Actions</th>
			        </tr>
			    </thead>
			    <tbody id="productTableBody">
			        <!-- Rows will be dynamically added here -->
			    </tbody>
			</table>

			<div class="col-md-12 mt-2">
				<label>Terms And Condition</label>
				<textarea class="form-control" style="font-size: 14px;" id="terms_and_condition" rows="3"></textarea>
			</div>
        </form>
            </div>
            <div class="modal-footer table-responsive p-2">
                <button type="button" class="btn btn-secondary mx-1" style="font-size: 14px;" onclick="location.reload();" data-bs-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary mx-1" style="font-size: 14px; display: none;" id="quotationSubmitBtnForReview" onclick="forwardQuotationForReview()">Submit</button>
                <button type="button" class="btn btn-primary mx-1" style="font-size: 14px;" id="saveQuotationBtn" onclick="saveQuotation()">Save Quotation</button>
            </div>
        </div>
    </div>
</div>



<!-- Add Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true" data-bs-backdrop="static">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<!-- Header -->
			<div class="modal-header">
				<h5 class="modal-title" id="quotationModalLabel">Customer Registration</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
			</div>

			<!-- Body -->
			<div class="modal-body">
					<!-- Quotation ID and Date-Time -->
					<div class="row mb-3 justify-content-between">
						<div class="col-md-3">

							<input type="text" class="form-control" id="vendorRegId" placeholder="Customer ID" disabled />
						</div>
						<div class="col-md-4 text-end">

							<input type="datetime-local" class="form-control" id="cdateTime" disabled />
						</div>
					</div>



					<!-- Vendor and Person Details -->
					<div class="row mb-3">
						<div class="col-md-2">
							<label for="main_honorifics" class="form-label">Select Honorifics</label>
							<select id="main_honorifics" class="form-select">
								<option value="" selected disabled="disabled"></option>
								<option value="M/s.">M/s.</option>
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
						</div>
						<div class="col-md-3">
							<label for="vendorName" class="form-label">Customer Name</label>
							<input type="text" class="form-control" oninput="onInputValidation()" id="vendorRegName"
								placeholder="Enter Customer Name" />
							<span id="customerNameErrorSpan"></span>
						</div>
						<div class="col-md-3">
							<label for="personName" class="form-label">Customer Legal Name</label>
							<input type="text" class="form-control" oninput="onInputValidation()" id="vendorLegalName"
								placeholder="Enter Customer Legal Name" />
								<span id="customerLegalNameErrorSpan"></span>
						</div>
						<div class="col-md-4">
							<label for="designation" class="form-label">GST Number</label>
							<input type="text" class="form-control" maxlength="15" id="vendorGstNumber" oninput="onInputValidation()" placeholder="Enter GST Number" />
							<span id="gstNumberErrorSpan"></span>
						</div>
					</div>
					
					<nav class="navbar navbar-light bg-light mb-3 border border-right-0 border-left-0">
					    <div class="container-fluid ">
					        <span class="navbar-brand mb-0 h4">Contact Details</span>
					        <div>
					            <button type="button" class="btn btn-primary me-2" id="addContactBtn">Add Contact</button>
					            <button type="button" class="btn btn-danger d-none" style="color: white;" id="removeContactBtn">Remove Contact</button>
					        </div>
					    </div>
					</nav>

				<div class="container mb-3">
				    <div id="contactContainer" class="row g-3">
				        <!-- Default Contact Person 1 -->
				        <div class="col-md-4 contact-group" id="contact_1">
				            <label>Contact Person 1</label>
				            <select class="form-select">
								<option value="" selected disabled="disabled">Select Honorifics</option>
								<!-- <option value="M/S.">M/S.</option> -->
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
				            <input type="text" oninput="onInputValidation()" id="contactPerson1" class="form-control mt-2" placeholder="Contact Person 1 Name">
				            <span id="contactPersonName1ErrorSpan"></span>
				            <input type="text" oninput="onInputValidation()" id="contactDesignation1" class="form-control mt-2" placeholder= "Designation 1">
				            <span id="contactPersonDesignation1ErrorSpan"></span>
				            <input type="text" oninput="onInputValidation()" id="contactMobile1" maxlength="10" class="form-control mt-2" placeholder="Mobile Number 1">
				            <span id="contactPersonMobile1ErrorSpan"></span>
				            <input type="email" oninput="onInputValidation()" id="contactEmail1" class="form-control mt-2" placeholder="Email ID 1">
				        	<span id="contactPersonEmail1ErrorSpan"></span>
				        </div>
				    </div>
				</div>
				
				<nav class="navbar navbar-light bg-light mb-3 border border-right-0 border-left-0">
					    <div class="container-fluid ">
					        <span class="navbar-brand mb-0 h4">Billing Address Details</span>
					    </div>
					</nav>
					
					<div class="row mb-3 mt-2">
						<div class="col-md-12 mt-2">
						
						<div class="d-flex align-items-center justify-content-between">
							<label for="billingAddress" class="form-label">Billing Address</label>
							<span class="d-flex align-items-center"><input type="checkbox" id="sameAddress" onchange="copyAddress()"><label style="margin-left: 5px; font-size: 14px;">Delivery Address same as Billing Address</label></span>
						</div>
							<textarea class="form-control" id="billingAddress" placeholder="Enter Billing Address"></textarea>
						</div>
					</div>

				<nav class="navbar navbar-light bg-light mb-3 border border-right-0 border-left-0">
				    <div class="container-fluid ">
				        <span class="navbar-brand mb-0 h4">Delivery Address Details</span>
				    </div>
				</nav>

					<!-- Vendor and Shipment Address -->
					<div class="row mb-3 mt-2">
						<!-- <div class="col-md-6">
                            <label for="vendorAddress" class="form-label">Vendor Address</label>
                            <textarea
                                class="form-control"
                                id="vendorAddress"
                                rows="2"
                                placeholder="Enter Vendor Address"
                            ></textarea>
                        </div>-->
                        
                        <div class="col-md-4 mt-2">
							<label for="delivery_Address1" class="form-label">Delivery Address 1</label>
							<textarea class="form-control" id="delivery_Address1" placeholder="Enter Delivery Address 1"></textarea>
						</div>
						
						<div class="col-md-4 mt-2">
							<label for="delivery_Address2" class="form-label">Delivery Address 2</label>
							<textarea class="form-control" id="delivery_Address2" placeholder="Enter Delivery Address 2"></textarea>
						</div>
						
						<div class="col-md-4 mt-2">
							<label for="delivery_Address3" class="form-label">Delivery Address 3</label>
							<textarea class="form-control" id="delivery_Address3" placeholder="Enter Delivery Address 3"></textarea>
						</div>

						<!-- <div class="col-md-12 mt-2">
							<label for="billingAddress" class="form-label">Billing Address</label>
							<textarea class="form-control" id="billingAddress" placeholder="Enter Billing Address"></textarea>
						</div> -->
						<!-- <div class="col-md-6">
							<label for="shipmentAddresss" class="form-label">Shipment Address</label>
							<textarea class="form-control" id="shipmentAddresss" placeholder="Enter Shipment Address"></textarea>
						</div> -->
					</div>
					
			</div>

			<!-- Footer -->
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="location.reload();" data-bs-dismiss="modal">
					Close
				</button>
				<button type="button" class="btn btn-primary" id="saveCustomerBtn" onclick="saveVendors()">
					Save
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="quotationModalLabel">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
            </div>
			<div class="modal-body">
					<div class="row mb-3 justify-content-between">
						<div class="col-md-4 ">			
							<input type="text" class="form-control" id="product_id" placeholder="Product ID" disabled autocomplete="off" />
						</div>
						<div class="col-md-4 text-end">			
							<input type="datetime-local" class="form-control text-center" id="pdateTime" disabled autocomplete="off"/>
						</div>
					</div>
					<div class="row mb-3">
						<!-- <div class="col-md-4">
							<label for="productName" class="form-label">Product Name</label>
							<input type="text" class="form-control" id="product_name" placeholder="Enter Product Name" autocomplete="off"/>
						</div> -->
						<div class="col-md-6">
							<label for="productName" class="form-label">HSN Code</label>
							<input type="text" class="form-control" oninput="validateForHsnCode(this.value)" id="hsn_code" placeholder="Enter HSN Code" autocomplete="off"/>
							<span id="productHsnCodeErrorSpan"></span>
						</div>
						<div class="col-md-6">
							<label for="productName" class="form-label">Part Number</label>
							<input type="text" class="form-control" id="part_number" placeholder="Enter Part Number" autocomplete="off"/>
						</div>								
					</div>		
					
					<div class="row mb-3">
					<div class="col-md-6">
							<label for="productDescription" class="form-label">Product Description</label>
							<textarea type="text" class="form-control" id="product_description" autocomplete="off"
								placeholder="Enter Product Description" ></textarea>
						</div>	
						
							<div class="col-md-6">
							<label for="remarks" class="form-label">Remarks</label>
							<textarea class="form-control" id="remarks" autocomplete="off"
								placeholder="Enter Remarks" ></textarea>
						</div>	
					</div>	
					
					
			</div>
			
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="location.reload();" data-bs-dismiss="modal">
					Close
				</button>
				<button type="button" id="saveNewProductBtn" class="btn btn-primary" onclick="saveProduct()">
					Save Product
				</button>
				
				
			</div>
			</div>
			</div>
			</div>
  
		
		<!-- End Page Title -->

		<section class="section profile" >
  
		<div class="card " id="addProjectContainer">
				       <div class="card-body" > 
				    <iframe id="sales-iframe" name="content-iframe" src="add_products" ></iframe>
					</div>
				</div>
    </section>
  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>Melange System pvt ltd</span></strong>. All Rights Reserved
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>
<!-- script to check the New Password and Re-enter New Password are equal or not if equal update the password -->
<script>

const onlyCharPattern = /^[a-zA-Z]+(?:\s[a-zA-Z]+)*$/; // Should not contain numbers or special characters or spaces at starting and ending
const onlyNumberPattern = /^[0-9]+$/; // Should not contain alphabets or any special characters

const onlyCharPatternWithSpace = /^[a-zA-Z\s]+$/;
const onlyNumberWithSpacePattern = /^[0-9\s]+$/;
const nameWithSpecialCharsPattern = /^[a-zA-Z0-9\s.,&()\-':@#!$%*+=?\/]+$/;

var gstPattern = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[0-9]{1}[A-Z]{1}[A-Z0-9]{1}$/; // GST format
var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/; // Email format

function validateForHsnCode(value){
	var successFlag = 0;
	
	if (value === "") {
        $('#productHsnCodeErrorSpan').text("");
    } else if (!onlyNumberPattern.test(value)) {
        $('#productHsnCodeErrorSpan').text("Only digits are allowed!")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else {
        $('#productHsnCodeErrorSpan').text("");
    }
	
	$('#saveNewProductBtn').prop("disabled", successFlag === 1);

    return successFlag === 0;
}


 
function onInputValidation() {
    var custName = $('#vendorRegName').val().trim();
    var custLegalName = $('#vendorLegalName').val().trim();
    var gstNumber = $('#vendorGstNumber').val().trim();
    
    var contactName1 = $('#contactPerson1').val().trim();
    var contactDesignation1 = $('#contactDesignation1').val().trim();
    var contactMobile1 = $('#contactMobile1').val().trim();
    var contactEmail1 = $('#contactEmail1').val().trim();
    
    let contact2Visible = isElementVisible(document.querySelector("#contact_2"));
    let contact3Visible = isElementVisible(document.querySelector("#contact_3"));
    
    var successFlag = 0;

    if (custName === "") {
        $('#customerNameErrorSpan').text("");
    } else if (!nameWithSpecialCharsPattern.test(custName)) {
        $('#customerNameErrorSpan').text("Only letters, numbers, and certain special characters (e.g., . , & ( ) - ' @ # !) are allowed.")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else {
        $('#customerNameErrorSpan').text("");
    }

    if (custLegalName === "") {
        $('#customerLegalNameErrorSpan').text("");
    } else if (!nameWithSpecialCharsPattern.test(custLegalName)) {
        $('#customerLegalNameErrorSpan').text("Only letters, numbers, and certain special characters (e.g., . , & ( ) - ' @ # !) are allowed.")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else {
        $('#customerLegalNameErrorSpan').text("");
    }
    
    if (gstNumber === "") {
        $('#gstNumberErrorSpan').text("");
    } else if (!gstPattern.test(gstNumber)) {
        $('#gstNumberErrorSpan').text("Invalid GST format! [e.g., 12ABCDE1234F1Z(9orA)]")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else {
        $('#gstNumberErrorSpan').text("");
    }
    
    if (contactName1 === "") {
        $('#contactPersonName1ErrorSpan').text("");
    } else if (!onlyCharPatternWithSpace.test(contactName1)) {
        $('#contactPersonName1ErrorSpan').text("Only alphabets are allowed!")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else {
        $('#contactPersonName1ErrorSpan').text("");
    }
    
    if (contactDesignation1 === "") {
        $('#contactPersonDesignation1ErrorSpan').text("");
    } else if (!nameWithSpecialCharsPattern.test(contactDesignation1)) {
        $('#contactPersonDesignation1ErrorSpan').text("Only letters, numbers, and certain special characters (e.g., . , & ( ) - ' @ # !) are allowed.")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else {
        $('#contactPersonDesignation1ErrorSpan').text("");
    }
    
    if (contactMobile1 === "") {
        $('#contactPersonMobile1ErrorSpan').text("");
    } else if (!onlyNumberPattern.test(contactMobile1)) {
        $('#contactPersonMobile1ErrorSpan').text("Only digits are allowed!")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else if (contactMobile1.length !== 10) {
	    $('#contactPersonMobile1ErrorSpan').text("Mobile number must be exactly 10 digits!")
	    .css({ "color": "#ec7063", "font-size": "14px" });
	    successFlag = 1;
	} else {
        $('#contactPersonMobile1ErrorSpan').text("");
    }
    
    if (contactEmail1 === "") {
        $('#contactPersonEmail1ErrorSpan').text("");
    } else if (!emailPattern.test(contactEmail1)) {
        $('#contactPersonEmail1ErrorSpan').text("Invalid email format! (e.g., example@mail.com)")
            .css({ "color": "#ec7063", "font-size": "14px" });
        successFlag = 1;
    } else {
        $('#contactPersonEmail1ErrorSpan').text("");
    }
    
    if(contact2Visible){
    	var contactName2 = $('#contact_2_name').val().trim();
        var contactDesignation2 = $('#contact_2_designation').val().trim();
        var contactMobile2 = $('#contact_2_mobile').val().trim();
        var contactEmail2 = $('#contact_2_email').val().trim();
        
        if (contactName2 === "") {
            $('#contact_2_name_error').text("");
        } else if (!onlyCharPatternWithSpace.test(contactName2)) {
            $('#contact_2_name_error').text("Only alphabets are allowed!")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_2_name_error').text("");
        }
        
        if (contactDesignation2 === "") {
            $('#contact_2_designation_error').text("");
        } else if (!onlyCharPatternWithSpace.test(contactDesignation2)) {
            $('#contact_2_designation_error').text("Only alphabets are allowed!")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_2_designation_error').text("");
        }
        
        if (contactMobile2 === "") {
            $('#contact_2_mobile_error').text("");
        } else if (!onlyNumberPattern.test(contactMobile2)) {
            $('#contact_2_mobile_error').text("Only digits are allowed!")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_2_mobile_error').text("");
        }
        
        if (contactEmail2 === "") {
            $('#contact_2_email_error').text("");
        } else if (!emailPattern.test(contactEmail2)) {
            $('#contact_2_email_error').text("Invalid email format! (e.g., example@mail.com)")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_2_email_error').text("");
        }
    }
    
    if(contact3Visible){
    	var contactName3 = $('#contact_3_name').val().trim();
        var contactDesignation3 = $('#contact_3_designation').val().trim();
        var contactMobile3 = $('#contact_3_mobile').val().trim();
        var contactEmail3 = $('#contact_3_email').val().trim();
        
        if (contactName3 === "") {
            $('#contact_3_name_error').text("");
        } else if (!onlyCharPatternWithSpace.test(contactName3)) {
            $('#contact_3_name_error').text("Only alphabets are allowed!")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_3_name_error').text("");
        }
        
        if (contactDesignation3 === "") {
            $('#contact_3_designation_error').text("");
        } else if (!onlyCharPatternWithSpace.test(contactDesignation3)) {
            $('#contact_3_designation_error').text("Only alphabets are allowed!")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_3_designation_error').text("");
        }
        
        if (contactMobile3 === "") {
            $('#contact_3_mobile_error').text("");
        } else if (!onlyNumberPattern.test(contactMobile3)) {
            $('#contact_3_mobile_error').text("Only digits are allowed!")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_3_mobile_error').text("");
        }
        
        if (contactEmail3 === "") {
            $('#contact_3_email_error').text("");
        } else if (!emailPattern.test(contactEmail3)) {
            $('#contact_3_email_error').text("Invalid email format! (e.g., example@mail.com)")
                .css({ "color": "#ec7063", "font-size": "14px" });
            successFlag = 1;
        } else {
            $('#contact_3_email_error').text("");
        }
    }
    
    $('#saveCustomerBtn').prop("disabled", successFlag === 1);

    return successFlag === 0;
}


 
 
 
 
 
 


function isElementVisible(element) {
    return element && element.offsetParent !== null;  // Returns true if element is visible
}


var quotationModal = new bootstrap.Modal(document.getElementById('quotationModal'), {
    backdrop: 'static',
    keyboard: false // Prevents closing with the "Esc" key
});

document.querySelector('[data-bs-target="#quotationModal"]').addEventListener('click', function () {
    quotationModal.show();
});

function forwardQuotationForReview(){
	
	// Disable the button immediately to prevent multiple clicks
    $('#quotationSubmitBtnForReview').prop("disabled", true).text("Submitting...");
	
	$.ajax({
        type: 'GET',
        url: '/get_qidBasedOnPreparedBy',
        success: function (data) {
        	
        	$.ajax({
                type: 'POST',
                url: '/updateReviewStatusForQuotationReview',
                data: {
                    "reviewStatus": 1,
                    "quotationId": data
                },
                success: function (response) {
                    if (response === 'success') {
                    	$('#quotationSubmitBtnForReview').text("Submitted");
                    	 $('#quotationModal').modal('hide');
                    	$('#quotationSubmitBtnForReview').prop("disabled", true);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error updating quotation review status record:');
                    console.log('XHR object:', xhr);
                    console.log('Status:', status);
                    console.log('Error:', error);
                }
            });
        	
        },
        error: function (xhr, status, error) {
            console.error('Error fetching last quotationId Based On Prepared By:');
            console.log('XHR object:', xhr);
            console.log('Status:', status);
            console.log('Error:', error);
        }
    });
}


document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('passwordChangeForm');
    
    const currentPassword = document.getElementById('currentPassword');
    const newPasswordField = document.getElementById('newPassword');
    const renewPasswordField = document.getElementById('renewPassword');
    const empIdField = form.querySelector('input[name="empId"]');
    
    const successAlert = document.querySelector('.alert-success');
    const errorAlert = document.querySelector('.alert-danger');

    form.addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the default form submission

        const newPassword = newPasswordField.value;
        const renewPassword = renewPasswordField.value;

        // Clear any previous alerts
        successAlert.style.display = 'none';
        errorAlert.style.display = 'none';

        if (newPassword !== renewPassword) {
            errorAlert.querySelector('span').textContent = 'New Password and Re-enter New Password do not match.';
            errorAlert.style.display = 'block';
            return;
        }
		
        // Create a FormData object from the form
        const formData = new FormData();
        formData.append('newPassword', newPassword);
        formData.append('empId', empIdField.value);
        formData.append('currentPassword', currentPassword.value);
        
        // Prepare the AJAX request
        fetch('/updatePassword', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                successAlert.querySelector('span').textContent = 'Password updated successfully!';
                successAlert.style.display = 'block';
            } else {
                errorAlert.querySelector('span').textContent = 'Error updating password: ' + data.message;
                errorAlert.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorAlert.querySelector('span').textContent = 'An error occurred while updating the password.';
            errorAlert.style.display = 'block';
        });
    });
});


</script>
<!-- script to fetch the designation based on selected department -->
<script>
function fetchDesignations(deptId) {
     if(deptId) {
        fetch(`/getDesignations?deptId=${deptId}`)
            .then(response => response.json())
            .then(data => {
                let designationSelect = document.getElementById('roleId');
                designationSelect.innerHTML = '<option value="" selected>Select Designation</option>';
                data.forEach(designation => {
                    let option = document.createElement('option');
                    option.value = designation.role_id;
                    option.text = designation.roleName;
                    designationSelect.add(option);
                });
            })
            .catch(error => console.error('Error fetching designations:', error));
    }
}
</script>

<!-- script to update the permission -->
<!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
<script src="assets/js/jquery-3.6.4.min.js"></script> 
<script>
$(document).ready(function() {
    $('#interviewAccess').on('change', function() {
        var isChecked = $(this).is(':checked');
        var employeeId = document.getElementById("employeeId").value;
        
        // Confirming values        
        $.ajax({
            url: '/updateInterviewPermission',
            type: 'POST',
            contentType: 'application/json', // Specify content type
            data: JSON.stringify({
                "userId": employeeId,
                "enabled": isChecked
            }),
            success: function(response) {
                console.log('Permission updated successfully');
            },
            error: function(xhr, status, error) {
                console.error('Failed to update permission:', error);
                console.error('Response text:', xhr.responseText);
            }
        });
    });
});

$.ajax({
    url: '/returnRecentlyInsertedTermsAndConditionDetail',
    type: 'GET',
    contentType: 'application/json', // Specify content type
    success: function(data) {
    	$('#terms_and_condition').val(data.terms_and_condition_data);
    },
    error: function(xhr, status, error) {
        console.error('Failed to get terms and condition details:', error);
        console.error('Response text:', xhr.responseText);
    }
});
</script>

<!-- script for profile pic -->
<script>
$.ajax({
    type: "GET",
    url: "fetchEmployeeDocumentDetailsOnlyByEmpId",
    data: {
        "emp_id": $('#emp_idSessionValue').val()
    },
    success: function(data) {
    	console.log("++++data"+JSON.stringify(data));
        $('#dynamicProfilePic').attr('src', `${data.profilePicPath}`);
    },
    error: function(xhr, status, error) {
        console.error("Error invoking data:", error);
    }
});
</script>

<!-- script to fill the current date into hidden datefield on add new project form -->
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('assignedSubmitDate').value = formattedDate;
            document.getElementById('delivery_date').setAttribute('min', formattedDate);
        });
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    // Handle sidebar switching (Sales, Interview)
    document.querySelectorAll(".main-tab").forEach(tab => {
        tab.addEventListener("click", function (event) {
            event.preventDefault();

            // Get target tab content ID
            const target = this.getAttribute("data-target");

            // Hide all tab contents
            document.querySelectorAll(".tab-content").forEach(content => {
                content.style.display = "none";
            });

            // Show the selected tab content
            document.getElementById(target).style.display = "block";
        });
    });

    // Handle sales navigation inside iframe
    document.querySelectorAll(".nav-links").forEach(link => {
        link.addEventListener("click", function (event) {
            event.preventDefault();
            document.getElementById("sales-iframe").src = this.getAttribute("href");
        });
    });
});

</script>

<script>
function saveProduct() {
    const productId = document.getElementById("product_id")?.value.trim();
    //const productName = document.getElementById("product_name")?.value.trim();
    const hsnCode = document.getElementById("hsn_code")?.value.trim();
    const partNumber = document.getElementById("part_number")?.value.trim();
    const productDescription = document.getElementById("product_description")?.value.trim();
    const productDate = document.getElementById("pdateTime")?.value;
    const remarks = document.getElementById("remarks")?.value.trim();

    // Debugging logs
    console.log("Product ID:", productId);
    //console.log("Product Name:", productName);
    console.log("Product Description:", productDescription);
    console.log("HSN:", hsnCode);
    console.log("PART :", partNumber);
    console.log("Product Date (Raw):", productDate); 

    if (!productId || !productDescription || !productDate || !hsnCode || !partNumber) {
        alert("HSN Code, Part Number and Product Description are required!");
        return;
    }

    // Format date-time properly before sending
    const formattedDate = formatDate(productDate);
    console.log("Formatted Date:", formattedDate);

    // Create the product object
    const product = {
        pid: productId,
        //pname: productName,
        hsn_code : hsnCode,
        part_number : partNumber,
        pdescription: productDescription,
        dateTime: formattedDate,
        remarks : remarks
    };

    console.log("Sending Product:", JSON.stringify(product));

    // Make an AJAX request to save the product
    fetch('/save_product', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(product)
    })
    .then(response => response.text())
    .then(data => {
        alert('Product saved successfully!');
        
        localStorage.setItem("refreshTable", "true");         
        $('#productModal').modal('hide'); // Close the modal
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        location.reload();
    })
    .catch((error) => {
        alert('Error saving product');
        console.error('Error:', error);
    });
}

// Function to format date-time as dd/mm/yyyy hh:mm:ss
/* function formatDate(dateString) {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
        console.error("Invalid Date Format:", dateString);
        return dateString;
    }

    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const yyyy = date.getFullYear();
    const hh = String(date.getHours()).padStart(2, '0');
    const min = String(date.getMinutes()).padStart(2, '0');
    const ss = String(date.getSeconds()).padStart(2, '0');

    return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
} */

//Convert date to MySQL DATETIME format (YYYY-MM-DD HH:MM:SS)
function formatDate(dateString) {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
        console.error("Invalid Date Format:", dateString);
        return dateString;
    }

    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, '0'); // Month is zero-based
    const dd = String(date.getDate()).padStart(2, '0');
    const hh = String(date.getHours()).padStart(2, '0');
    const min = String(date.getMinutes()).padStart(2, '0');
    const ss = String(date.getSeconds()).padStart(2, '0');

    return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`; // ✅ MySQL-friendly format
}


</script>

<script type="text/javascript">

function fetchProductId() {
	fetch("/get_pid")
    .then(response => response.text())  // Expecting plain text response
    .then(data => {
        const productInput = document.getElementById("product_id");

        if (!productInput) {
            console.error("Product ID input field not found");
            return;
        }

        productInput.value = data.trim();  // Set product ID in input field
    })
    .catch(error => console.error("Error fetching product ID:", error));
}

// Call the function every second (1000 milliseconds)
setInterval(fetchProductId, 1000);

document.addEventListener("DOMContentLoaded", function () {
    
    // Function to format date-time in dd/mm/yyyy hh:mm:ss
    function formatDisplayDateTime(date) {
        let dd = String(date.getDate()).padStart(2, '0');
        let mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        let yyyy = date.getFullYear();
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }

    // Function to format date-time for input type datetime-local
    function formatISODateTime(date) {
        let yyyy = date.getFullYear();
        let mm = String(date.getMonth() + 1).padStart(2, '0');
        let dd = String(date.getDate()).padStart(2, '0');
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    const dateTimeInput = document.getElementById("pdateTime");

    function updateDateTime() {
        let now = new Date();
        if (dateTimeInput) {
            dateTimeInput.value = formatISODateTime(now); // Update datetime-local input
            dateTimeInput.setAttribute("data-display", formatDisplayDateTime(now)); // Store formatted value
        } else {
            console.error("Date-Time input field not found");
        }
    }

    updateDateTime(); // Set initial value
    setInterval(updateDateTime, 1000); // Update every second
});
</script>

<script type="text/javascript">
function fetchQuotationId() {
    fetch("/get_qid")
        .then(response => response.text())  // Expecting plain text response
        .then(data => {
            const qoteInput = document.getElementById("qid");

            if (!qoteInput) {
                console.error("Quotation ID input field not found");
                return;
            }

            qoteInput.value = data.trim();  // Set product ID in input field
        })
        .catch(error => console.error("Error fetching product ID:", error));
}

// Call the function every second (1000 milliseconds)
setInterval(fetchQuotationId, 1000);
document.addEventListener("DOMContentLoaded", function () {
  
    // Function to format date-time in dd/mm/yyyy hh:mm:ss
    function formatDisplayDateTime(date) {
        let dd = String(date.getDate()).padStart(2, '0');
        let mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        let yyyy = date.getFullYear();
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }

    // Function to format date-time for input type datetime-local
    function formatISODateTime(date) {
        let yyyy = date.getFullYear();
        let mm = String(date.getMonth() + 1).padStart(2, '0');
        let dd = String(date.getDate()).padStart(2, '0');
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    const dateTimeInput = document.getElementById("qdateTime");

    function updateDateTime() {
        let now = new Date();
        if (dateTimeInput) {
            dateTimeInput.value = formatISODateTime(now); // Update datetime-local input
            dateTimeInput.setAttribute("data-display", formatDisplayDateTime(now)); // Store formatted value
        } else {
            console.error("Date-Time input field not found");
        }
    }

    updateDateTime(); // Set initial value
    setInterval(updateDateTime, 1000); // Update every second
});


</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let contactCount = 1; // Start with 1 contact
    const maxContacts = 3;
    const contactContainer = document.getElementById("contactContainer");
    const addContactBtn = document.getElementById("addContactBtn");
    const removeContactBtn = document.getElementById("removeContactBtn");

    addContactBtn.addEventListener("click", function () {
        if (contactCount < maxContacts) {
            contactCount++;

            const contactDiv = document.createElement("div");
            contactDiv.classList.add("col-md-4", "contact-group");
            contactDiv.setAttribute("id", `contact_${contactCount}`);
            contactDiv.innerHTML = `
                <label>Contact Person ${contactCount}</label>
                <select class="form-select" id="contact_${contactCount}_honorifics">
					<option value="" selected disabled="disabled">Select Honorifics</option>
	                <option value="Mr.">Mr.</option>
	                <option value="Ms.">Ms.</option>
	            </select>
                <input type="text" id="contact_${contactCount}_name" oninput="onInputValidation()" class="form-control mt-2" placeholder="Contact Person ${contactCount} Name">
                <span id="contact_${contactCount}_name_error"></span>
                <input type="text" id="contact_${contactCount}_designation" oninput="onInputValidation()" class="form-control mt-2" placeholder="Designation ${contactCount}">
                <span id="contact_${contactCount}_designation_error"></span>
                <input type="text" id="contact_${contactCount}_mobile" oninput="onInputValidation()" maxlength="10" class="form-control mt-2" placeholder="Mobile Number ${contactCount}">
                <span id="contact_${contactCount}_mobile_error"></span>
                <input type="email" id="contact_${contactCount}_email" oninput="onInputValidation()" class="form-control mt-2" placeholder="Email ID ${contactCount}">
                <span id="contact_${contactCount}_email_error"></span>
                `;

            contactContainer.appendChild(contactDiv);

            // Show remove button after adding second contact
            if (contactCount > 1) {
                removeContactBtn.classList.remove("d-none");
            }

            // Disable add button if max contacts reached
            if (contactCount === maxContacts) {
                addContactBtn.disabled = true;
            }
        }
    });

    removeContactBtn.addEventListener("click", function () {
        if (contactCount > 1) {
            const lastContact = document.getElementById(`contact_${contactCount}`);
            if (lastContact) {
                lastContact.remove();
                contactCount--;

                // Enable add button if contacts are less than max
                addContactBtn.disabled = false;
            }

            // Hide remove button if only 1 contact remains
            if (contactCount === 1) {
                removeContactBtn.classList.add("d-none");
            }
        }
    });
});

// Save function
function saveVendors() {
	
	if(!document.getElementById("main_honorifics").value.trim() || !document.getElementById("vendorGstNumber").value.trim() || 
		!document.getElementById("vendorRegName").value.trim() || !document.getElementById("vendorLegalName").value.trim() ||
		!document.getElementById("billingAddress").value.trim() || !document.querySelector("#delivery_Address1").value.trim() ||
		!document.querySelector("#contact_1 select:nth-child(2)").value.trim() || !document.querySelector("#contact_1 input:nth-child(3)").value.trim() ||
		!document.querySelector("#contact_1 input:nth-child(5)").value.trim() || !document.querySelector("#contact_1 input:nth-child(7)").value.trim() ||
		!document.querySelector("#contact_1 input:nth-child(9)").value.trim()){
		alert("Please fill all required fields!");
		return;
	}
	
	function isElementVisible(element) {
        return element && element.offsetParent !== null;  // Returns true if element is visible
    }

    let contact2Visible = isElementVisible(document.querySelector("#contact_2"));
    let contact3Visible = isElementVisible(document.querySelector("#contact_3"));
	
    const vendorData = {
        vid: document.getElementById("vendorRegId").value.trim() || null,
        dateTime: new Date().toISOString(),
        honorifics_main: document.getElementById("main_honorifics").value.trim() || null,
        vname: document.getElementById("vendorRegName").value.trim() || null,
        vlname: document.getElementById("vendorLegalName").value.trim() || null,
        gstnumber: document.getElementById("vendorGstNumber").value.trim() || null,
        //delivery_address: document.getElementById("deliveryAddresss").value.trim() || null,
        billing_address: document.getElementById("billingAddress").value.trim() || null,
        delivery_address_1: document.querySelector("#delivery_Address1").value.trim() || null,
        delivery_address_2: document.querySelector("#delivery_Address2").value.trim() || null,
        delivery_address_3: document.querySelector("#delivery_Address3").value.trim() || null,

        honorifics_1: document.querySelector("#contact_1 select:nth-child(2)").value.trim() || null,
        contact_p1_name: document.querySelector("#contact_1 input:nth-child(3)").value.trim() || null,
        contact_p1_designation: document.querySelector("#contact_1 input:nth-child(5)").value.trim() || null,
        contact_p1_mobile: document.querySelector("#contact_1 input:nth-child(7)").value.trim() || null,
        contact_p1_email: document.querySelector("#contact_1 input:nth-child(9)").value.trim() || null,

     	// Contact 2 (Only if visible)
        honorifics_2: contact2Visible ? document.querySelector("#contact_2 select:nth-child(2)").value.trim() || null : null,
        contact_p2_name: contact2Visible ? document.querySelector("#contact_2 input:nth-child(3)").value.trim() || null : null,
        contact_p2_designation: contact2Visible ? document.querySelector("#contact_2 input:nth-child(5)").value.trim() || null : null,
        contact_p2_mobile: contact2Visible ? document.querySelector("#contact_2 input:nth-child(7)").value.trim() || null : null,
        contact_p2_email: contact2Visible ? document.querySelector("#contact_2 input:nth-child(9)").value.trim() || null : null,

        // Contact 3 (Only if visible)
        honorifics_3: contact3Visible ? document.querySelector("#contact_3 select:nth-child(2)").value.trim() || null : null,
        contact_p3_name: contact3Visible ? document.querySelector("#contact_3 input:nth-child(3)").value.trim() || null : null,
        contact_p3_designation: contact3Visible ? document.querySelector("#contact_3 input:nth-child(5)").value.trim() || null : null,
        contact_p3_mobile: contact3Visible ? document.querySelector("#contact_3 input:nth-child(7)").value.trim() || null : null,
        contact_p3_email: contact3Visible ? document.querySelector("#contact_3 input:nth-child(9)").value.trim() || null : null
    };

    //alert("Sending Data:", vendorData);

    fetch("/saveVendor", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(vendorData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert("Success: " + data.message);
            closeModal();  // Close the modal
            $('#sameAddress').prop("checked", false);
            clearFields(); // Clear input fields
        } else if (data.error) {
            alert("Error: " + data.error);
        }
    })
    .catch(error => alert("Request failed: " + error));
}



// Function to close the modal popup
function closeModal() {
    const modal = document.getElementById("vendorModal"); // Change to your modal ID
    if (modal) {
        modal.style.display = "none"; // Hide the modal
    }
}

// Function to clear all input fields
function clearFields() {
    document.querySelectorAll("input").forEach(input => input.value = "");
    document.querySelectorAll("textarea").forEach(input => input.value = "");
    document.querySelectorAll("select").forEach(input => input.value = "");
}

    


</script>

<script type="text/javascript">

function fetchVendorId() {
	fetch("/get_vid")
    .then(response => response.text())  // Expecting plain text response
    .then(data => {
        const productInput = document.getElementById("vendorRegId");

        if (!productInput) {
            console.error("Product ID input field not found");
            return;
        }

        productInput.value = data.trim();  // Set product ID in input field
    })
    .catch(error => console.error("Error fetching product ID:", error));
}

// Call the function every second (1000 milliseconds)
setInterval(fetchVendorId, 1000);

document.addEventListener("DOMContentLoaded", function () {
    
    // Function to format date-time in dd/mm/yyyy hh:mm:ss
    function formatDisplayDateTime(date) {
        let dd = String(date.getDate()).padStart(2, '0');
        let mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        let yyyy = date.getFullYear();
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }

    // Function to format date-time for input type datetime-local
    function formatISODateTime(date) {
        let yyyy = date.getFullYear();
        let mm = String(date.getMonth() + 1).padStart(2, '0');
        let dd = String(date.getDate()).padStart(2, '0');
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    const dateTimeInput = document.getElementById("cdateTime");

    function updateDateTime() {
        let now = new Date();
        if (dateTimeInput) {
            dateTimeInput.value = formatISODateTime(now); // Update datetime-local input
            dateTimeInput.setAttribute("data-display", formatDisplayDateTime(now)); // Store formatted value
        } else {
            console.error("Date-Time input field not found");
        }
    }

    updateDateTime(); // Set initial value
    setInterval(updateDateTime, 1000); // Update every second
});


</script>


<script>
let productCount = 0;
const GST_PERCENTAGE = 18; // Fixed 18% GST

function addProduct() {
	productCount++;
    const tableBody = document.getElementById("productTableBody");
     
    // Get selected values from dropdowns
    /* const productName = document.getElementById("productName").value;
    const hsnCode = document.getElementById("hsnCode").value;
    const partNumber = document.getElementById("partNumber").value;
    const productDescription = document.getElementById("productDescription").value; */
     
    const productName = document.getElementById("productDescription").value;
    const hsnCode = document.getElementById("partNumber").value;
    const partNumber = document.getElementById("productName").value;
    const productDescription = document.getElementById("hsnCode").value;
    const prdId = document.getElementById("productId").value;
   
    /*const productName = document.getElementById("productName").value;
    const hsnCode = document.getElementById("hsnCode").value;
    const partNumber = document.getElementById("partNumber").value;
    const productDescription = document.getElementById("productDescription").value;*/
     
    // Get checkbox elements correctly
    const interState = document.getElementById("interState");
    const outerState = document.getElementById("outerState");

    // Ensure values are selected before adding
    if (!hsnCode || !partNumber || !productDescription) {
        alert("Please select all product details before adding.");
        return;
    }
    
    if (!(interState.checked) && !(outerState.checked)) {
        alert("Please select Tax Type Before Adding Products.");
        return;
    }

    // Create a new row
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${productCount}</td>
        <td style="display: none;">${productName}</td>
        <td>${hsnCode}</td>
        <td>${partNumber}</td>
        <td>${productDescription}</td>
        
        <td><input type="number" class="form-control quantity" oninput="calculateTotal(this)"></td>
        <td><input type="number" class="form-control price" oninput="calculateTotal(this)"></td>
        <td class="total-without-gst">0.00</td>
        <td class="cgst-value">0.00</td>
        <td class="sgst-value">0.00</td>
        <td class="igst-value">0.00</td>
        <td class="total-with-gst">0.00</td>
        <td style="display: none;" class="product-id">${prdId}</td>
        <td><button class="btn btn-outline-danger btn-sm" onclick="removeProduct(this)">Remove</button></td>
        
    `;

    tableBody.appendChild(row);
    
    // Apply tax selection logic
    applyGSTSelection();

    // Hide IGST column immediately after adding if Interstate is selected
    const igstCell = row.querySelector(".igst-value");
    if (interState.checked) {
        igstCell.style.display = "none"; // Hide IGST
        igstCell.innerText = ""; // Remove text
    }

    // Reset dropdown selections
    document.getElementById("productName").selectedIndex = 0;
    document.getElementById("hsnCode").selectedIndex = 0;
    document.getElementById("partNumber").selectedIndex = 0;
    document.getElementById("productDescription").selectedIndex = 0;
}


function removeProduct(button) {
    button.closest("tr").remove();
    productCount--;
    updateSlNumbers();
}

function updateSlNumbers() {
    document.querySelectorAll("#productTableBody tr").forEach((row, index) => {
        row.cells[0].innerText = index + 1;
    });
}

function calculateTotal(input) {
    const row = input.closest("tr");
    const quantity = parseFloat(row.querySelector(".quantity").value) || 0;
    const price = parseFloat(row.querySelector(".price").value) || 0;
    
    let totalWithoutGST = quantity * price;
    let cgst = 0, sgst = 0, igst = 0, totalWithGST = totalWithoutGST;

    if (document.getElementById("interState").checked) {
        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        totalWithGST += cgst + sgst;
        row.querySelector(".cgst-value").innerText = cgst.toFixed(2);
        row.querySelector(".sgst-value").innerText = sgst.toFixed(2);
        row.querySelector(".igst-value").innerText = "—";
    } else if (document.getElementById("outerState").checked) {
        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
        totalWithGST += igst;
        row.querySelector(".cgst-value").innerText = "—";
        row.querySelector(".sgst-value").innerText = "—";
        row.querySelector(".igst-value").innerText = igst.toFixed(2);
    }

    row.querySelector(".total-without-gst").innerText = totalWithoutGST.toFixed(2);
    row.querySelector(".total-with-gst").innerText = totalWithGST.toFixed(2);
}

function toggleGST(type) {
    if (type === "interState") {
        document.getElementById("outerState").checked = false;
    } else {
        document.getElementById("interState").checked = false;
    }

    applyGSTSelection();
}

function applyGSTSelection() {

    const isInterState = document.getElementById("interState").checked;
    const isOuterState = document.getElementById("outerState").checked;

    // Toggle visibility of header columns
    document.querySelector(".cgst-header").classList.toggle("d-none", !isInterState);
    document.querySelector(".sgst-header").classList.toggle("d-none", !isInterState);
    document.querySelector(".igst-header").classList.toggle("d-none", !isOuterState);

    // Apply correct values and visibility to each row
    document.querySelectorAll("#productTableBody tr").forEach(row => {
        const cgstCell = row.querySelector(".cgst-value");
        const sgstCell = row.querySelector(".sgst-value");
        const igstCell = row.querySelector(".igst-value");

        if (isInterState) {
            cgstCell.style.display = "";
            sgstCell.style.display = "";
            igstCell.style.display = "none"; // Hide IGST
            igstCell.innerText = ""; // Remove text
        } else if (isOuterState) {
            cgstCell.style.display = "none"; // Hide CGST
            sgstCell.style.display = "none"; // Hide SGST
            igstCell.style.display = "";
        } else {
            // If neither is selected, hide all tax columns
            cgstCell.style.display = "none";
            sgstCell.style.display = "none";
            igstCell.style.display = "none";
        }

        // Ensure tax values are recalculated
        calculateTotal(row.querySelector(".quantity"));
    });
}


</script>



<!-- <script>
let productCount = 0;

function addProduct() {
    productCount++;
    const tableBody = document.getElementById("productTableBody");
    const row = document.createElement("tr");

    row.innerHTML = `
        <td>${productCount}</td>
        <td><input type="text" class="form-control product-name"></td>
        <td><input type="number" class="form-control quantity" oninput="calculateTotal(this)"></td>
        <td><input type="number" class="form-control price" oninput="calculateTotal(this)"></td>
        <td class="total-without-gst">0.00</td>
        <td class="cgst-value ${document.getElementById("interState").checked ? "" : "d-none"}">0.00</td>
        <td class="sgst-value ${document.getElementById("interState").checked ? "" : "d-none"}">0.00</td>
        <td class="igst-value ${document.getElementById("outerState").checked ? "" : "d-none"}">0.00</td>        
        <td class="total-with-gst">0.00</td>
        <td><button class="btn btn-outline-danger btn-sm" onclick="removeProduct(this)">Remove</button></td>
    `;

    tableBody.appendChild(row);
}

function removeProduct(button) {
    button.closest("tr").remove();
    productCount--;
    updateSlNumbers();
}

function updateSlNumbers() {
    document.querySelectorAll("#productTableBody tr").forEach((row, index) => {
        row.cells[0].innerText = index + 1;
    });
}

function calculateTotal(input) {
    const row = input.closest("tr");
    const quantity = parseFloat(row.querySelector(".quantity").value) || 0;
    const price = parseFloat(row.querySelector(".price").value) || 0;
    const gstPercentage = parseFloat(document.getElementById("gstPercentage").value) || 0;
    
    let totalWithoutGST = quantity * price;
    let cgst = 0, sgst = 0, igst = 0, totalWithGST = totalWithoutGST;

    if (document.getElementById("interState").checked) {
        cgst = (totalWithoutGST * gstPercentage) / 200;
        sgst = (totalWithoutGST * gstPercentage) / 200;
        totalWithGST += cgst + sgst;
        row.querySelector(".cgst-value").innerText = cgst.toFixed(2);
        row.querySelector(".sgst-value").innerText = sgst.toFixed(2);
        row.querySelector(".igst-value").innerText = "";
    } else if (document.getElementById("outerState").checked) {
        igst = (totalWithoutGST * gstPercentage) / 100;
        totalWithGST += igst;
        row.querySelector(".cgst-value").innerText = "";
        row.querySelector(".sgst-value").innerText = "";
        row.querySelector(".igst-value").innerText = igst.toFixed(2);
    }

    row.querySelector(".total-without-gst").innerText = totalWithoutGST.toFixed(2);
    row.querySelector(".total-with-gst").innerText = totalWithGST.toFixed(2);
}

function toggleGST(type) {
    if (type === "interState") {
        document.getElementById("outerState").checked = false;
        document.querySelectorAll(".cgst-header, .sgst-header").forEach(el => el.classList.remove("d-none"));
        document.querySelectorAll(".igst-header").forEach(el => el.classList.add("d-none"));
    } else {
        document.getElementById("interState").checked = false;
        document.querySelectorAll(".igst-header").forEach(el => el.classList.remove("d-none"));
        document.querySelectorAll(".cgst-header, .sgst-header").forEach(el => el.classList.add("d-none"));
    }

    document.querySelectorAll("#productTableBody tr").forEach(row => {
        row.querySelector(".cgst-value").classList.toggle("d-none", !document.getElementById("interState").checked);
        row.querySelector(".sgst-value").classList.toggle("d-none", !document.getElementById("interState").checked);
        row.querySelector(".igst-value").classList.toggle("d-none", !document.getElementById("outerState").checked);
    });

    document.querySelectorAll(".quantity, .price").forEach(input => calculateTotal(input));
}

</script> -->

<script>
/* history.scrollRestoration = "manual"

    $(window).on('beforeunload', function(){
          $(window).scrollTop(0);
    }); */
    
   /*  var objDiv = document.getElementById("chatbox");
    if ( window.history.replaceState ) {
      objDiv.scrollTop = objDiv.scrollHeight;

        window.history.replaceState( null, null, window.location.href );
    } */
</script>
<script>history.scrollRestoration = "manual"</script>


<!-- <script>
let customers = [];

document.addEventListener("DOMContentLoaded", function() {
    fetchCustomers();
});

function fetchCustomers() {
    fetch('/customers')
        .then(response => response.json())
        .then(data => {
            customers = data; // Now it's an array of objects { name, legalName, gst }
            
        })
        .catch(error => console.error('Error fetching customers:', error));
}

// Filter customer names based on input
document.getElementById("vendorName").addEventListener("input", function() {
    const input = this.value.toLowerCase();
    const suggestionsBox = document.getElementById("suggestionsBox");

    if (!input) {
        suggestionsBox.style.display = "none";
        return;
    }

    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(input)
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
    }

    // Display suggestions
    suggestionsBox.innerHTML = filteredCustomers.map(customer =>
        `<div onclick="selectCustomer('${customer.name}', '${customer.legalName}', '${customer.gst}')">${customer.name}</div>`
    ).join("");

    suggestionsBox.style.display = "block";
});

// Select a customer from the suggestions
function selectCustomer(name, legalName, gst) {
    document.getElementById("vendorName").value = name;
    document.getElementById("vendorlegalName").value = legalName;
    document.getElementById("gstnumber").value = gst;
    document.getElementById("suggestionsBox").style.display = "none";
}

// Hide suggestions when clicking outside
document.addEventListener("click", function(event) {
    if (!event.target.closest("#vendorName") && !event.target.closest("#suggestionsBox")) {
        document.getElementById("suggestionsBox").style.display = "none";
    }
});

document.getElementById("vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        const suggestionsBox = document.getElementById("suggestionsBox");
        if (suggestionsBox.style.display === "block") {
            const firstSuggestion = suggestionsBox.querySelector("div");
            if (firstSuggestion) {
                firstSuggestion.click(); // Simulate a click on the first suggestion
                event.preventDefault(); // Prevent form submission or newline
            }
        }
    }
});

document.getElementById("vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Backspace" && this.value === "") {
        document.getElementById("vendorlegalName").value = "";
        document.getElementById("gstnumber").value = "";
    }
});

</script> -->


<!-- <script>

let customers = [];
let selectedContacts = {}; // Stores contacts for each customer

document.addEventListener("DOMContentLoaded", function() {
    fetchCustomers();
});

function fetchCustomers() {
    fetch('/customers')
        .then(response => response.json())
        .then(data => {
            customers = data;
        })
        .catch(error => console.error('Error fetching customers:', error));
}

// Filter customer names based on input
document.getElementById("vendorName").addEventListener("input", function() {
    const input = this.value.toLowerCase();
    const suggestionsBox = document.getElementById("suggestionsBox");

    if (!input) {
        suggestionsBox.style.display = "none";
        return;
    }

    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(input)
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
    }

    // Store contacts globally and show suggestions
    suggestionsBox.innerHTML = filteredCustomers.map((customer, index) => {
        selectedContacts[index] = [
            { name: customer.c1, designation: customer.c11, mobile: customer.c111, email: customer.c1111 },
            { name: customer.c2, designation: customer.c22, mobile: customer.c222, email: customer.c2222 },
            { name: customer.c3, designation: customer.c33, mobile: customer.c333, email: customer.c3333 }
        ].filter(contact => contact.name); // Remove empty contacts

        return `<div onclick="selectCustomer('${customer.name}', '${customer.legalName}', '${customer.gst}', '${index}')">${customer.name}</div>`;
    }).join("");

    suggestionsBox.style.display = "block";
});

// Select customer and populate contact person dropdown
function selectCustomer(name, legalName, gst, index) {
    document.getElementById("vendorName").value = name;
    document.getElementById("vendorlegalName").value = legalName;
    document.getElementById("gstnumber").value = gst;

    populateContactsDropdown(selectedContacts[index]);

    document.getElementById("suggestionsBox").style.display = "none";
}

// Populate contact dropdown dynamically
function populateContactsDropdown(contacts) {
    const contactDropdown = document.getElementById("personName");
    contactDropdown.innerHTML = `<option value="">Select Contact Person</option>` +
        contacts.map(contact => `<option value="${contact.name}" data-designation="${contact.designation}" data-mobile="${contact.mobile}" data-email="${contact.email}">${contact.name}</option>`).join("");
}

// Auto-fill details when selecting a contact person
document.getElementById("personName").addEventListener("change", function() {
    const selectedOption = this.options[this.selectedIndex];

    if (selectedOption.value) {
        document.getElementById("designation").value = selectedOption.dataset.designation || "";
        document.getElementById("contactDetails").value = selectedOption.dataset.mobile || "";
        document.getElementById("emailId").value = selectedOption.dataset.email || "";
    } else {
        clearContactFields();
    }
});

// Hide suggestions when clicking outside
document.addEventListener("click", function(event) {
    if (!event.target.closest("#vendorName") && !event.target.closest("#suggestionsBox")) {
        document.getElementById("suggestionsBox").style.display = "none";
    }
});

// Select first suggestion on Enter
document.getElementById("vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        const suggestionsBox = document.getElementById("suggestionsBox");
        if (suggestionsBox.style.display === "block") {
            const firstSuggestion = Box.querySelector("div");
            if (firstSuggestion) {
                firstSuggestion.click(); // Simulate a click on the first suggestion
                event.preventDefault(); // Prevent form submission
            }
        }
    }
});

// Clear all related fields on backspace when empty
document.getElementById("vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Backspace" && this.value === "") {
        clearCustomerFields();
    }
});

// Clear customer fields
function clearCustomerFields() {
    document.getElementById("vendorlegalName").value = "";
    document.getElementById("gstnumber").value = "";
    document.getElementById("personName").innerHTML = `<option value="">Select Contact Person</option>`;
    clearContactFields();
}

// Clear contact person fields
function clearContactFields() {
    document.getElementById("designation").value = "";
    document.getElementById("contactDetails").value = "";
    document.getElementById("emailId").value = "";
}
</script> -->

<script>
let customers = [];
let selectedContacts = {}; // Stores contacts for each customer

document.addEventListener("DOMContentLoaded", function() {
    fetchCustomers();
});

function fetchCustomers() {
    fetch('/customers')
        .then(response => response.json())
        .then(data => {
            customers = data;
        })
        .catch(error => console.error('Error fetching customers:', error));
}

// Filter customer names based on input
document.getElementById("vendorName").addEventListener("input", function() {
    const input = this.value.toLowerCase();
    const suggestionsBox = document.getElementById("suggestionsBox");

    if (!input) {
        suggestionsBox.style.display = "none";
        return;
    }

    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(input)
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
    }

    // Store contacts globally and show suggestions
    suggestionsBox.innerHTML = filteredCustomers.map((customer, index) => {
        selectedContacts[index] = [
            { name: customer.c1, designation: customer.c11, mobile: customer.c111, email: customer.c1111, honorifics: customer.honorifics_1 },
            { name: customer.c2, designation: customer.c22, mobile: customer.c222, email: customer.c2222, honorifics: customer.honorifics_2 },
            { name: customer.c3, designation: customer.c33, mobile: customer.c333, email: customer.c3333, honorifics: customer.honorifics_3 }
        ].filter(contact => contact.name); // Remove empty contacts

       // return `<div onclick="selectCustomer('${customer.name}', '${customer.legalName}', '${customer.gst}', '${customer.billing_address}', '${customer.delivery_address_1}', '${customer.delivery_address_2}', '${customer.delivery_address_3}', '${customer.honorifics_main}', '${index}')">${customer.name}</div>`;
	   function escapeForJS(str) {
	       return (str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
	   }

	   return `<div onclick="selectCustomer('${escapeForJS(customer.name)}', '${escapeForJS(customer.legalName)}', '${escapeForJS(customer.gst)}', '${escapeForJS(customer.billing_address)}', '${escapeForJS(customer.delivery_address_1)}', '${escapeForJS(customer.delivery_address_2)}', '${escapeForJS(customer.delivery_address_3)}', '${escapeForJS(customer.honorifics_main)}', '${index}')">${customer.name}</div>`;

    }).join("");

    suggestionsBox.style.display = "block";
});


// Select customer and populate fields
function selectCustomer(name, legalName, gst, billingAddresss, deliveryAddress1, deliveryAddress2, deliveryAddress3, mainHonorifics, index) {
	//alert("hi");
    document.getElementById("vendorName").value = name;
    document.getElementById("vendorlegalNamee").value = legalName;
    document.getElementById("gstnumberr").value = gst;
    document.getElementById("shipmentAddress").value = billingAddresss; // Populate billing address
    document.getElementById("company_honorifics").value = mainHonorifics;
    
    //alert(billingAddresss+" "+deliveryAddress1+" "+deliveryAddress2+" "+deliveryAddress3);
    
 	// Get the dropdown element
    let deliverySelect = document.getElementById("deliveryAddress");
    
    // Clear existing options
    deliverySelect.innerHTML = "<option value=''>Select Delivery Address</option>";
	
    // Array of delivery addresses
    let deliveryAddresses = [deliveryAddress1, deliveryAddress2, deliveryAddress3];
	
    // Add only non-null and non-empty addresses to the dropdown
    deliveryAddresses.forEach(address => {
        if (address && address.trim() !== "") {
            let option = document.createElement("option");
            option.value = address;
            option.textContent = address;
            deliverySelect.appendChild(option);
        }
    });

    populateContactsDropdown(selectedContacts[index]);

    document.getElementById("suggestionsBox").style.display = "none";
}

// Populate contact dropdown dynamically
function populateContactsDropdown(contacts) {
	//alert(JSON.stringify(contacts));
    const contactDropdown = document.getElementById("personName");
    contactDropdown.innerHTML = `<option value="">Select Contact Person</option>` +
        contacts.map(contact => `<option value="${contact.name}" data-designation="${contact.designation}" data-mobile="${contact.mobile}" data-email="${contact.email}" data-honorifics="${contact.honorifics}">${contact.name}</option>`).join("");
}

// Auto-fill details when selecting a contact person
document.getElementById("personName").addEventListener("change", function() {
    const selectedOption = this.options[this.selectedIndex];

    if (selectedOption.value) {
    	document.getElementById("contact_person_honorifics").value = selectedOption.dataset.honorifics;
        document.getElementById("designation").value = selectedOption.dataset.designation || "";
        document.getElementById("contactDetails").value = selectedOption.dataset.mobile || "";
        document.getElementById("emailId").value = selectedOption.dataset.email || "";
    } else {
        clearContactFields();
    }
});

// Hide suggestions when clicking outside
document.addEventListener("click", function(event) {
    if (!event.target.closest("#vendorName") && !event.target.closest("#suggestionsBox")) {
        document.getElementById("suggestionsBox").style.display = "none";
    }
});

// Select first suggestion on Enter
document.getElementById("vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        const suggestionsBox = document.getElementById("suggestionsBox");
        if (suggestionsBox.style.display === "block") {
            const firstSuggestion = suggestionsBox.querySelector("div");
            if (firstSuggestion) {
                firstSuggestion.click(); // Simulate a click on the first suggestion
                event.preventDefault(); // Prevent form submission
            }
        }
    }
});

// Clear all related fields on backspace when empty
document.getElementById("vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Backspace" && this.value === "") {
        clearCustomerFields();
    }
});

// Clear customer fields
function clearCustomerFields() {
    document.getElementById("vendorlegalNamee").value = "";
    document.getElementById("gstnumberr").value = "";
    document.getElementById("shipmentAddress").value = "";
    document.getElementById("personName").innerHTML = `<option value="">Select Contact Person</option>`;
    clearContactFields();
}

// Clear contact person fields
function clearContactFields() {
    document.getElementById("designation").value = "";
    document.getElementById("contactDetails").value = "";
    document.getElementById("emailId").value = "";
    document.getElementById("contact_person_honorifics").value = "";
}








document.getElementById("vendorName1").addEventListener("input", function() {
    const input = this.value.toLowerCase();
    const suggestionsBox1 = document.getElementById("suggestionsBox1");

    if (!input) {
        suggestionsBox1.style.display = "none";
        return;
    }

    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(input)
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox1.style.display = "none";
        return;
    }

    // Store contacts globally and show suggestions
    suggestionsBox1.innerHTML = filteredCustomers.map((customer, index) => {
        selectedContacts[index] = [
            { name: customer.c1, designation: customer.c11, mobile: customer.c111, email: customer.c1111, honorifics: customer.honorifics_1 },
            { name: customer.c2, designation: customer.c22, mobile: customer.c222, email: customer.c2222, honorifics: customer.honorifics_2 },
            { name: customer.c3, designation: customer.c33, mobile: customer.c333, email: customer.c3333, honorifics: customer.honorifics_3 }
        ].filter(contact => contact.name); // Remove empty contacts

       // return `<div onclick="selectCustomer1('${customer.name}', '${customer.legalName}', '${customer.gst}', '${customer.billing_address}', '${customer.delivery_address_1}', '${customer.delivery_address_2}', '${customer.delivery_address_3}', '${customer.honorifics_main}', '${index}')">${customer.name}</div>`;
	   function escapeForJS(str) {
	       return (str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
	   }

	   return `<div onclick="selectCustomer1('${escapeForJS(customer.name)}', '${escapeForJS(customer.legalName)}', '${escapeForJS(customer.gst)}', '${escapeForJS(customer.billing_address)}', '${escapeForJS(customer.delivery_address_1)}', '${escapeForJS(customer.delivery_address_2)}', '${escapeForJS(customer.delivery_address_3)}', '${escapeForJS(customer.honorifics_main)}', '${index}')">${customer.name}</div>`;

    }).join("");

    suggestionsBox1.style.display = "block";
});

//Select customer and populate fields
function selectCustomer1(name, legalName, gst, billingAddresss, deliveryAddress1, deliveryAddress2, deliveryAddress3, mainHonorifics, index) {
	//alert("hi");
    document.getElementById("vendorName1").value = name;
    document.getElementById("vendorlegalNamee1").value = legalName;
    document.getElementById("gstnumberr1").value = gst;
    document.getElementById("billing_address").value = billingAddresss; // Populate billing address
    document.getElementById("company_honorifics1").value = mainHonorifics;
    
    //alert(billingAddresss+" "+deliveryAddress1+" "+deliveryAddress2+" "+deliveryAddress3);
    
 	// Get the dropdown element
    let deliverySelect = document.getElementById("shipping_address");
    
    // Clear existing options
    deliverySelect.innerHTML = "<option value=''>Select Delivery Address</option>";

    // Array of delivery addresses
    let deliveryAddresses = [deliveryAddress1, deliveryAddress2, deliveryAddress3];

    // Add only non-null and non-empty addresses to the dropdown
    deliveryAddresses.forEach(address => {
        if (address && address.trim() !== "") {
            let option = document.createElement("option");
            option.value = address;
            option.textContent = address;
            deliverySelect.appendChild(option);
        }
    });

    document.getElementById("suggestionsBox1").style.display = "none";
    
    populateContactsDropdown1(selectedContacts[index]);

    
}

//Populate contact dropdown dynamically
function populateContactsDropdown1(contacts) {
	//alert(JSON.stringify(contacts));
    const contactDropdown = document.getElementById("personName1");
    contactDropdown.innerHTML = `<option value="">Select Contact Person</option>` +
        contacts.map(contact => `<option value="${contact.name}" data-designation="${contact.designation}" data-mobile="${contact.mobile}" data-email="${contact.email}" data-honorifics="${contact.honorifics}">${contact.name}</option>`).join("");
}
 

//Hide suggestions when clicking outside
document.addEventListener("click", function(event) {
    if (!event.target.closest("#vendorName1") && !event.target.closest("#suggestionsBox1")) {
        document.getElementById("suggestionsBox1").style.display = "none";
    }
});
</script>


<script>
/* document.addEventListener("DOMContentLoaded", function () {
    fetch("/product_list")
        .then(response => response.json())
        .then(data => {
            console.log("Fetched Data:", data); // Debugging

            if (data.length > 0) {
                const productSelect = document.getElementById("productName");
                const hsnCodeSelect = document.getElementById("hsnCode");
                const partNumberSelect = document.getElementById("partNumber");
                const productDescriptionSelect = document.getElementById("productDescription");

                // Clear previous options
                productSelect.innerHTML = `<option value="">Select a Product</option>`;
                hsnCodeSelect.innerHTML = `<option value="">Select HSN Code</option>`;
                partNumberSelect.innerHTML = `<option value="">Select Part Number</option>`;
                productDescriptionSelect.innerHTML = `<option value="">Select Description</option>`;

                // Loop through data and add options
                data.forEach(product => {
                    productSelect.innerHTML += `<option value="${product.pname}">${product.pname}</option>`;
                    hsnCodeSelect.innerHTML += `<option value="${product.hsn_code}">${product.hsn_code}</option>`;
                    partNumberSelect.innerHTML += `<option value="${product.part_number}">${product.part_number}</option>`;
                    productDescriptionSelect.innerHTML += `<option value="${product.pdescription}">${product.pdescription}</option>`;
                });
            } else {
                console.log("No products found.");
            }
        })
        .catch(error => console.error("Error fetching products:", error));
});
 */
 
 let productData = []; // Store fetched data globally

 document.addEventListener("DOMContentLoaded", function () {
     fetch("/product_list")
         .then(response => response.json())
         .then(data => {
             console.log("Fetched Data:", data); // Debugging
             productData = data; // Store the fetched data globally

             if (data.length > 0) {
                 const productSelect = document.getElementById("productName");
                 const hsnCodeSelect = document.getElementById("hsnCode");
                 const partNumberSelect = document.getElementById("partNumber");
                 const productDescriptionSelect = document.getElementById("productDescription");//
                 const productId = document.getElementById("productId");
                 
                 // Clear previous options
                 productSelect.innerHTML = `<option value="">Select a Part Number</option>`;
                 hsnCodeSelect.innerHTML = `<option value="">Select HSN Code</option>`;
                 partNumberSelect.innerHTML = `<option value="">Select Part Number</option>`;
                 productDescriptionSelect.innerHTML = `<option value="">Select Description</option>`;
                  

                 // Loop through data and add options for Product Name
                 data.forEach(product => {
                     productSelect.innerHTML += `<option value="${product.part_number}">${product.part_number}</option>`;
                 });

                 
                 
              // Add event listener to detect product selection change
                 productSelect.addEventListener("change", function () {
                     const selectedProduct = this.value;
                     const selectedData = productData.find(p => p.part_number === selectedProduct);
                     
                     //alert(JSON.stringify(selectedData));
                     if (selectedData) {
                         hsnCodeSelect.value = selectedData.pdescription;
                         partNumberSelect.value = selectedData.hsn_code;
                         productDescriptionSelect.value = selectedData.pname;
                         productId.value = selectedData.pid;
                     } else {
                         // Reset input fields if no product is selected
                         hsnCodeSelect.value = "";
                         partNumberSelect.value = "";
                         productDescriptionSelect.value = "";
                     }
                 });

             } else {
                 console.log("No products found.");
             }
         })
         .catch(error => console.error("Error fetching products:", error));
 });

 /* function copyAddress() {
	    const shipmentAddress = document.getElementById("shipmentAddress").value;
	    const deliveryAddress = document.getElementById("deliveryAddress");
	    const sameAddress = document.getElementById("sameAddress");

	    if (sameAddress.checked) {
	        deliveryAddress.value = shipmentAddress;
	        deliveryAddress.setAttribute("readonly", true);
	    } else {
	        deliveryAddress.value = "";
	        deliveryAddress.removeAttribute("readonly");
	    }
	} */
	
	function copyAddress() {
	    const billingAddress = document.getElementById("billingAddress").value;
	    const delivery_Address1 = document.getElementById("delivery_Address1");
	    //const delivery_Address2 = document.getElementById("delivery_Address2");
	    //const delivery_Address3 = document.getElementById("delivery_Address3");
	    const sameAddress = document.getElementById("sameAddress");

	    if (sameAddress.checked) {
	    	delivery_Address1.value = billingAddress;
	    	//delivery_Address2.value = billingAddress;
	    	//delivery_Address3.value = billingAddress;
	    	/* delivery_Address1.setAttribute("readonly", true);
	    	delivery_Address2.setAttribute("readonly", true);
	    	delivery_Address3.setAttribute("readonly", true); */
	    } else {
	    	delivery_Address1.value = "";
	    	//delivery_Address2.value = "";
	    	//delivery_Address3.value = "";
	    	/* delivery_Address1.removeAttribute("readonly");
	    	delivery_Address2.removeAttribute("readonly");
	    	delivery_Address3.removeAttribute("readonly"); */
	    }
	}

</script>

<script>
function saveQuotation() {
    let products = [];
	let isProductInvalid = false;
    $("#productTableBody tr").each(function() {
        let row = $(this);
		let quantity = parseFloat(row.find(".quantity").val()) || 0;
	    let price = parseFloat(row.find(".price").val()) || 0;

		       // ✅ Check if quantity or price is missing/zero
		       if (quantity <= 0 || price <= 0) {
		           alert(`Please enter valid quantity and price for product.`);
		           isProductInvalid = true;
		           return false; // Exit .each() early
		       }
		//alert("huuuu"+ row.find(".product-id").text().trim())
        let product = {
            productName: row.find("td:eq(1)").text().trim(),
            hsnCode: row.find("td:eq(2)").text().trim(),
            partNumber: row.find("td:eq(3)").text().trim(),
            description: row.find("td:eq(4)").text().trim(),
			quantity: quantity,
			price: price,
            taxableValue: parseFloat(row.find(".total-without-gst").text().trim()) || 0,
            cgst: parseFloat(row.find(".cgst-value").text().trim()) || 0,
            sgst: parseFloat(row.find(".sgst-value").text().trim()) || 0,
            igst: parseFloat(row.find(".igst-value").text().trim()) || 0,
            total: parseFloat(row.find(".total-with-gst").text().trim()) || 0,
            pId: row.find(".product-id").text().trim(), // ✅ Added line
            qid: $("#qid").val().trim(),
        };

        // Ensure no invalid values (remove "—" which is causing backend errors)
        product.cgst = isNaN(product.cgst) ? 0 : product.cgst;
        product.sgst = isNaN(product.sgst) ? 0 : product.sgst;
        product.igst = isNaN(product.igst) ? 0 : product.igst;

        // console.log("Row Data:", product);
        products.push(product);
        
    });
	
	// ✅ Stop if invalid product found
	   if (isProductInvalid) {
	       return;
	   }

	   // ✅ Check if products list is empty
	   if (products.length === 0) {
	       alert("Please add at least one product before saving the quotation.");
	       return;
	   }
	   // ✅ Validate required fields
	       const requiredFields = [
	           { id: "#qid", name: "Quotation ID" },
	           { id: "#qdateTime", name: "Quotation Date" },
	           { id: "#vendorName", name: "Vendor Name" },
	           { id: "#vendorlegalNamee", name: "Vendor Legal Name" },
	           { id: "#gstnumberr", name: "GST Number" },
	           { id: "#orderMethod", name: "Order Method" },
	           { id: "#personName", name: "Contact Person Name" },
	           { id: "#designation", name: "Designation" },
	           { id: "#contactDetails", name: "Contact Details" },
	           { id: "#emailId", name: "Email ID" },
	           { id: "#shipmentAddress", name: "Shipment Address" },
	           { id: "#deliveryAddress", name: "Delivery Address" },
	           { id: "#company_honorifics", name: "Company Honorific" },
	           { id: "#contact_person_honorifics", name: "Contact Person Honorific" }
	       ];

	       for (let field of requiredFields) {
	           if (!$(field.id).val() || $(field.id).val().trim() === "") {
	               alert(`Please enter ${field.name}.`);
	               $(field.id).focus();
	               return;
	           }
	       }
		   
    var taxTypeValue;
    
    let checkboxes = document.querySelectorAll('.taxTypeCheckBox');
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
        	taxTypeValue = checkbox.id; // Logs the ID of the checked checkbox
        }
    });
    
    //var vendorNameWithHonorifics = $('#company_honorifics').val()+""+$("#vendorName").val();
    //var personNameWithHonorifics = $('#contact_person_honorifics').val()+""+$("#personName").val();
    
    let quotationData = {
        qid: $("#qid").val().trim(),
        qdateTime: $("#qdateTime").val(),
        vendorName: $("#vendorName").val(),
        vendorlegalName: $("#vendorlegalNamee").val(),
        gstnumber: $("#gstnumberr").val(),
        orderMethod: $("#orderMethod").val(),
        personName: $("#personName").val(),
        designation: $("#designation").val(),
        contactDetails: $("#contactDetails").val(),
        emailId: $("#emailId").val(),
        shipmentAddress: $("#shipmentAddress").val(),
        deliveryAddress: $("#deliveryAddress").val(),
        taxType: taxTypeValue,
        products: products,
        honorifics1: $('#company_honorifics').val(),
        honorifics2: $('#contact_person_honorifics').val()
    };

    //alert("Sending Data:", JSON.stringify(quotationData));
    console.log("Sending Data: ", quotationData); // Debugging Output
    //alert($('#terms_and_condition').val());
    
    let termsAndConditionValue = $('#terms_and_condition').val() || "";  // Ensure it is not null

    $.ajax({
        type: "POST",
        url: "/quotation/save?termsAndConditionValue=" + encodeURIComponent(termsAndConditionValue),
        contentType: "application/json",
        data: JSON.stringify(quotationData),
        success: function(response) {
        	$('#saveQuotationBtn').css("display", "none");
        	$('#quotationSubmitBtnForReview').css("display", "block");
            alert("Quotation saved successfully!");
            // Close the modal
            let modal = bootstrap.Modal.getInstance(document.getElementById('quotationModal'));
            if (modal) {
                modal.hide();
            }
        },
        error: function(xhr) {
            alert("Error: " + xhr.responseText);
        }
    });
}

document.addEventListener("DOMContentLoaded", function () {
    const links = document.querySelectorAll(".links > a");

    // Set "add_products" as active on initial load
    links.forEach(link => {
        if (link.getAttribute("href") === "add_products") {
            link.classList.add("active");
        }
    });

    links.forEach(link => {
        link.addEventListener("click", function () {
            // Remove active class from all links
            links.forEach(l => l.classList.remove("active"));

            // Add active class to the clicked link
            this.classList.add("active");
        });
    });
});

</script>
<!-- script to focuse the side nav link when page gets loaded -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let activeLink = document.querySelector(".nav-link.active");
        if (activeLink) {
            activeLink.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    });
</script>

<!-- script to save purchase order -->
<script>
  function updateDateTime1() {
    const dateTimeInput = document.getElementById('podateTime');
    const now = new Date();

    // Format date: dd-MM-yyyy
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();

    // Format time in 12-hour format with AM/PM
    let hours = now.getHours();
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12; // Convert 0 to 12

    const time = `${String(hours).padStart(2, '0')}:${minutes}:${seconds} ${ampm}`;
    const date = `${day}-${month}-${year}`;

    dateTimeInput.value = `${date} ${time}`;
  }

  // Initial call + update every second
  window.onload = updateDateTime1;
  setInterval(updateDateTime1, 1000);
  
  

  function addItemRow() {
    const table = document.getElementById('po_items_table').getElementsByTagName('tbody')[0];
    const rowCount = table.rows.length;

    const newRow = table.insertRow();
    newRow.innerHTML = `
      <td><input type="number" class="form-control" name="slno[]" value="${rowCount + 1}" readonly></td>
      <td><input type="text" class="form-control" name="modules[]"></td>
      <td><input type="text" class="form-control" name="part_no[]"></td>
      <td><input type="text" class="form-control" name="hsn_code[]"></td>
      <td><input type="text" class="form-control" name="description[]"></td>
      <td><input type="number" class="form-control" name="quantity[]" min="1" oninput="calculateTotal(this)"></td>
      <td><input type="number" class="form-control" name="price[]" min="0" step="0.01" oninput="calculateTotal(this)"></td>
      <td><input type="number" class="form-control" name="line_total[]" ></td>
    `;
  }
  
  const form = document.getElementById('purchaseOrderForm');
  const submitButton = document.querySelector('.btn-success');

 /*  form.addEventListener('submit', async function (e) {
	  
      e.preventDefault();

      // Change the button text and disable it during submission
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';

      const items = [];
      const rows = document.querySelectorAll('#po_items_table tbody tr');
      rows.forEach((row, index) => {
          items.push({
              slNo: index + 1,
              moduleName: row.querySelector('[name="modules[]"]').value,
              partNo: row.querySelector('[name="part_no[]"]').value,
              hsnCode: row.querySelector('[name="hsn_code[]"]').value,
              description: row.querySelector('[name="description[]"]').value,
              quantity: parseInt(row.querySelector('[name="quantity[]"]').value),
              price: parseFloat(row.querySelector('[name="price[]"]').value),
              lineTotal: parseFloat(row.querySelector('[name="line_total[]"]').value),
          });
      });

      const data = {
          poNumber: document.getElementById('po_number').value,
          poDate: document.getElementById('po_date').value,
          poGst: document.getElementById('po_gst').value,
          billingAddress: document.getElementById('billing_address').value,
          shippingAddress: document.getElementById('shipping_address').value,
          supplierName: document.getElementById('supplier_name').value,
          supplierGst: document.getElementById('supplier_gst').value,
          vendorCode: document.getElementById('vendor_code').value,
          createdDateTime: new Date().toISOString(),
          grandTotal: parseFloat(document.getElementById('grand_total').value),
          
          cust_honorifics: document.getElementById('company_honorifics1').value,
          cust_name: document.getElementById('vendorName1').value,
          cus_leagal_name: document.getElementById('vendorlegalNamee1').value,
          gst_no: document.getElementById('gstnumberr1').value,
          order_mehtod: document.getElementById('orderMethod1').value,
          contact_honorifics:document.getElementById('contact_person_honorifics1').value,
          cont_person_name:document.getElementById('personName1').value,
          designation:document.getElementById('designation1').value,
          mobile_no:document.getElementById('contactDetails1').value,
          email:document.getElementById('emailId1').value,
          items
      };
      
      console.log("daaattttaaa---",data);

      await fetch('/purchase-orders', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
      }).then(res => res.json())
        .then(res => {
            // After submission, show success message and disable the submit button
            alert('Purchase Order Saved!');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitted';
            location.reload(); // Optional, if you want to reload the page
        })
        .catch(err => {
            // If there's an error, re-enable the button and reset the text
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Purchase Order';
            alert('Error occurred while saving the purchase order');
        });
  });
 */
</script>


<!-- script to get quotation data based on selected quotation id -->
<script>
document.getElementById('quotationId').addEventListener('input', function () {	 
    const selectedQid = this.value;
     
    
    
    if (selectedQid === "") {
        // Clear all fields
        document.getElementById("company_honorifics1").value = "";
        document.getElementById("vendorName1").value = "";
        document.getElementById("vendorlegalNamee1").value = "";
        document.getElementById("gstnumberr1").value = "";
        document.getElementById("orderMethod1").value = "";

        document.getElementById("contact_person_honorifics1").value = "";
        document.getElementById("personName1").value = "";
        document.getElementById("designation1").value = "";
        document.getElementById("contactDetails1").value = "";
        document.getElementById("emailId1").value = "";
        document.getElementById("billing_address").value = "";
        document.getElementById("shipping_address").value = "";

        document.getElementById("outerState1").checked = false;
        document.getElementById("interState1").checked = false;

        document.querySelector("#po_items_table tbody").innerHTML = "";
        return; // Stop the fetch call
    }

    // Step 1: Check if quotation is already used
    fetch(`/checkQuotationUsed?quotationId=${selectedQid}`)
        .then(response => response.json())
        .then(checkData => {
            console.log("Quotation usage check response:", checkData);
            if (checkData.used) {
                alert("This Quotation is already linked to a Sales Order. Please select another.");
                document.getElementById('quotationId').value = "";
                return;
            }

            // Step 2: Fetch quotation details
	    fetch(`/getQuotationDetails?id=${selectedQid}`) // API call to fetch data
	    .then(response => response.json()) 
	    .then(data => {
		// Alert the full JSON data (prettified)
	
		 // Check if quotation is approved
	                        if (data.review !== 2 ) {
	                          alert("This quotation is not in 'Approved' stage. Please review it before proceeding.");
	                          document.getElementById("quotationId").value = "";
	                          return;
	                        }
	
	    	document.getElementById("company_honorifics1").value = data.honorifics1;
	    	document.getElementById("vendorName1").value = data.customerName;
	    	document.getElementById("vendorlegalNamee1").value = data.customerLegalName;
	    	document.getElementById("gstnumberr1").value = data.gstNumber;
	    	document.getElementById("orderMethod1").value = data.orderMethod;
	
	    	document.getElementById("contact_person_honorifics1").value = data.honorifics2;
	    	//document.getElementById("personName1").value = data.contactPersonName;
	    	document.getElementById("designation1").value = data.designation;
	    	document.getElementById("contactDetails1").value = data.contactDetails;
	    	document.getElementById("emailId1").value = data.emailId;
	    	document.getElementById("billing_address").value = data.deliveryAddress;
	    //	document.getElementById("shipping_address").value = data.shipmentAddress;
	    	
			// --- 🧑‍💼 Handle multiple contact person names ---
			    const personNameSelect = document.getElementById("personName1");
			    personNameSelect.innerHTML = `<option value="">Select Contact Person</option>`; // reset
	
			    if (Array.isArray(data.contactPersonName)) {
			        data.contactPersonName.forEach(name => {
			            const option = document.createElement("option");
			            option.value = name;
			            option.text = name;
			            personNameSelect.appendChild(option);
			        });
			    } else if (typeof data.contactPersonName === "string") {
			        const option = document.createElement("option");
			        option.value = data.contactPersonName;
			        option.text = data.contactPersonName;
			        personNameSelect.appendChild(option);
			    }
	
			    // --- 📦 Handle multiple delivery/shipment addresses ---
			    const shippingSelect = document.getElementById("shipping_address");
			    shippingSelect.innerHTML = `<option value="">Select Delivery Address</option>`; // reset
	
			    if (Array.isArray(data.shipmentAddress)) {
			        data.shipmentAddress.forEach(address => {
			            const option = document.createElement("option");
			            option.value = address;
			            option.text = address;
			            shippingSelect.appendChild(option);
			        });
			    } else if (typeof data.shipmentAddress === "string") {
			        const option = document.createElement("option");
			        option.value = data.shipmentAddress;
			        option.text = data.shipmentAddress;
			        shippingSelect.appendChild(option);
			    }
	
			    // Fill billing address (assumed to be a single string)
			    document.getElementById("billing_address").value = data.deliveryAddress;
	
		    	// Set the correct GST checkbox based on tax_type
		    	if (data.tax_type === 'outerState') {
		    	    document.getElementById("outerState1").checked = true;
		    	    document.getElementById("interState1").checked = false;
		    	    toggleGST('outerState');
					toggleGSTColumns('outerState');
					 
				    // Hide CGST and SGST rows
				    document.getElementById("cgstTotalTaxValueCell").style.display = 'none';
				    document.getElementById("sgstTotalTaxValueCell").style.display = 'none';
	
				    // Show IGST row
				    document.getElementById("igstTotalTaxValueCell").style.display = '';
					
		    	} else {
		    	    document.getElementById("interState1").checked = true;
		    	    document.getElementById("outerState1").checked = false;
		    	    toggleGST('interState');
					toggleGSTColumns('interState');
					
					// Show CGST and SGST rows
				    document.getElementById("cgstTotalTaxValueCell").style.display = '';
				    document.getElementById("sgstTotalTaxValueCell").style.display = '';
	
				    // Hide IGST row
				    document.getElementById("igstTotalTaxValueCell").style.display = 'none';
					 
		    	}
		    	
	    	// Fill the products table
	        const tbody = document.querySelector("#po_items_table tbody");
	        tbody.innerHTML = ""; // Clear any existing rows
			
	        let totalTaxable = 0;
	        let totalTax = 0;
	        let grandTotal = 0;
	        let totalCGST = 0; // Initialize CGST total
	        let totalSGST = 0; // Initialize SGST total
	        let totalIGST = 0; // Initialize IGST total
	        let amountWithTax = 0;
	        let roundOffDecimal = 0;
	        let roundedFinalAmount = 0;
	        
	        console.log("data..."+JSON.stringify(data));
	        
	        data.products.forEach((product, index) => {
	        	
	        const row = document.createElement("tr");
	        
	        // Add this line to accumulate total
	        totalTaxable += parseFloat(product.total || 0);
	        totalCGST += parseFloat(product.cgst || 0);
            totalSGST += parseFloat(product.sgst || 0);
            totalIGST += parseFloat(product.igst || 0);
            
            if (data.tax_type === 'outerState') {
            	 totalTax += parseFloat(product.igst || 0);
            }
            else{
            	 totalTax += parseFloat(product.cgst || 0) + parseFloat(product.sgst || 0) ;
            }
	       
	        grandTotal += parseFloat(product.total_value || 0);
	        
	        amountWithTax = totalTaxable + totalTax;
	        roundOffDecimal = amountWithTax - Math.floor(amountWithTax); // e.g., 432.78 -> 0.78
	        //roundedFinalAmount = Math.round(amountWithTax); // e.g., 433
	        
			// Check if tax values are valid (>= 0), otherwise add style to hide
			const cgstDisplay = parseFloat(product.cgst || 0) > 0 ? '' : 'style="display:none;"';
			const sgstDisplay = parseFloat(product.sgst || 0) > 0 ? '' : 'style="display:none;"';
			const igstDisplay = parseFloat(product.igst || 0) > 0 ? '' : 'style="display:none;"';
		
            row.innerHTML = `
                <td><input type="number" class="form-control" name="slno[]" value="${index + 1}" readonly></td>
                
                <td><input type="text" class="form-control" name="part_no[]" value="${product.partNumber}"></td>
                <td><input type="text" class="form-control" name="hsn_code[]" value="${product.hsnCode}"></td>
                <td><input type="text" class="form-control" name="description[]" value="${product.description}"></td>
                <td><input type="number" class="form-control salequantity" name="quantity[]" min="1" step="any" value="${product.quantity}" oninput="calculateTotalsaleneww(this)"></td>
                <td><input type="number" class="form-control saleproduct" name="price[]" min="0" step="any" value="${product.price}" oninput="calculateTotalsaleneww(this)"></td>
				<td><input type="number" class="form-control saletaxableValue" name="line_total[]" step="any" value="${product.total}" readonly></td>
				         
						<td class="cgst-value" ${cgstDisplay}>
				            <input type="number" class="form-control salecgst" name="cgst[]" step="any" value="${product.cgst}" readonly/>
				        </td>
				        <td class="sgst-value" ${sgstDisplay}>
				            <input type="number" class="form-control salesgst" name="sgst[]" step="any"  value="${product.sgst}" readonly/>
				        </td>
				        <td class="igst-value" ${igstDisplay}>
				            <input type="number" class="form-control saleigst" name="igst[]" step="any"  value="${product.igst}" readonly />
				        </td>

				<td><input type="number" class="form-control totalvalue" name="total_line_total[]" step="any" value="${product.total_value}" readonly></td>
				
				<td class="action-col" style="display: none;">
				       <button type="button" class="btn btn-outline-danger btn-sm w-100 removeRowBtn" onclick="removeRow(this)">Remove</button>
				</td>
				
				<td style="display:none;"><input type="hidden" class="form-control productId" name="product_id[]" value="${product.pId}" readonly ></td>
				
            `;
            tbody.appendChild(row);
        });
		
		// After all rows are added
		document.getElementById("taxableTotalValue").textContent = totalTaxable.toFixed(2);
		document.getElementById("taxTotalValue").textContent = totalTax.toFixed(2);
		document.getElementById("amountWithTax").textContent = amountWithTax.toFixed(2);

		// Set round off and rounded amount immediately
		// const initialRounded = customRound(amountWithTax);
		const initialRounded = customRound(amountWithTax);
		roundOffDecimal = initialRounded - amountWithTax;
		const sign = roundOffDecimal >= 0 ? "+" : "-";
		document.getElementById("roundOffDecimal").textContent = `${sign}${Math.abs(roundOffDecimal).toFixed(2)}`;

		//document.getElementById("roundOffDecimal").textContent = (amountWithTax - Math.floor(amountWithTax)).toFixed(2);
		 
		document.getElementById("grandTotalValue").textContent = initialRounded.toFixed(2);

		 // Set the total CGST, SGST, and IGST
        document.getElementById("cgstTotalTaxValue").textContent = totalCGST.toFixed(2);
        document.getElementById("sgstTotalTaxValue").textContent = totalSGST.toFixed(2);
        document.getElementById("igstTotalTaxValue").textContent = totalIGST.toFixed(2);
        
		// ✅ Ensure this listener is only attached ONCE
		const roundSelect = document.getElementById("roundPreference");
		if (!roundSelect.dataset.listenerAttached) {
			roundSelect.addEventListener("change", () => {
			    const newAmountWithTax = parseFloat(document.getElementById("amountWithTax").textContent) || 0;
			    const newRounded = customRound(newAmountWithTax);
			    const roundOff = newRounded - newAmountWithTax;
			    const sign = roundOff >= 0 ? "+" : "-";
			    
			    document.getElementById("roundOffDecimal").textContent = `${sign}${Math.abs(roundOff).toFixed(2)}`;
			    document.getElementById("grandTotalValue").textContent = newRounded.toFixed(2);
			});
		    roundSelect.dataset.listenerAttached = "true"; // Mark it attached
		}		
		// ✅ Show Action column
		document.querySelectorAll(".action-col").forEach(col => {
		    col.style.display = "table-cell";
		});
        })
        .catch(error => {
            console.error("Error fetching quotation details:", error);
        });
        })
        .catch(error => {
            console.error("Error checking quotation usage:", error);
        });
});

function customRound(value) {
    const preference = document.getElementById("roundPreference").value;
    let rounded = Math.round(value); // First, apply regular rounding (to nearest integer)

    if (preference === "even") {
        if (rounded % 2 !== 0) {
            // If rounded value is odd, make it even
            if (rounded > value) {
                rounded -= 1;  // Round down to nearest even
            } else {
                rounded += 1;  // Round up to nearest even
            }
        }
    } else if (preference === "odd") {
        if (rounded % 2 === 0) {
            // If rounded value is even, make it odd
            if (rounded > value) {
                rounded -= 1;  // Round down to nearest odd
            } else {
                rounded += 1;  // Round up to nearest odd
            }
        }
    }

    return rounded;
}

	
function removeRow(button) {
    const row = button.closest("tr");
    row.remove();
    updateSlNo();
    recalculateTotals();
}
function updateSlNo() {
    const rows = document.querySelectorAll("#po_items_table tbody tr");
    rows.forEach((row, index) => {
        const slNoInput = row.querySelector("input[name='slno[]']");
        if (slNoInput) {
            slNoInput.value = index + 1;
        }
    });
}

function toggleGSTColumns(taxType) {
    const cgstHeaders = document.querySelectorAll('.cgst-saleheader, .cgst-value');
    const sgstHeaders = document.querySelectorAll('.sgst-saleheader, .sgst-value');
    const igstHeaders = document.querySelectorAll('.igst-saleheader, .igst-value');

	const cgstCells = document.querySelectorAll('.cgst-value');
	const sgstCells = document.querySelectorAll('.sgst-value');
	const igstCells = document.querySelectorAll('.igst-value');
	
    if (taxType === 'outerState') {
        cgstHeaders.forEach(el => el.classList.add('d-none'));
        sgstHeaders.forEach(el => el.classList.add('d-none'));
        igstHeaders.forEach(el => el.classList.remove('d-none'));
		 
    } else {
        cgstHeaders.forEach(el => el.classList.remove('d-none'));
        sgstHeaders.forEach(el => el.classList.remove('d-none'));
        igstHeaders.forEach(el => el.classList.add('d-none'));
		 
    }
}

</script>

<!-- script to active the quotation tab when user click on notification -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const hash = window.location.hash;

    if (hash === "#quotation") {
        const quotationLink = document.querySelector('a[href="add_quotation"]');
        if (quotationLink) {
            quotationLink.click(); // programmatically triggers the quotation tab
        }
    }
});
</script>

<!-- script to save sale order -->
<!-- script to save purchase order -->
	<script>
		// Function to enable editing of delivery address
		function enableDeliveryAddressEdit() {
		    var shippingAddressSelect = document.getElementById('shipping_address');
		    var shippingAddressInput = document.createElement('input');
		    shippingAddressInput.type = 'text';
		    shippingAddressInput.classList.add('form-control');
		    shippingAddressInput.id = 'shipping_address_edit';
		    
		    // Replace the select element with the input field
		    shippingAddressSelect.parentNode.replaceChild(shippingAddressInput, shippingAddressSelect);
		    
		    // Optionally, populate the input field with the selected value
		    shippingAddressInput.value = shippingAddressSelect.options[shippingAddressSelect.selectedIndex].text;
		    
		    // Re-enable the input field for editing
		    shippingAddressInput.disabled = false;
		}

		function generatePurchaseOrderId() {
		  fetch('/generate-po-id')
		    .then(response => response.text())
		    .then(poId => {
		      document.getElementById('poid').value = poId;
		    })
		    .catch(error => {
		      console.error('Error generating PO ID:', error);
		    });
		}

		 // Run when modal is shown
		 const poModal = document.getElementById('purchaseOrderModal');
		 poModal.addEventListener('shown.bs.modal', generatePurchaseOrderId);	
			
			// Show the Preview button when a file is selected
			   function showPreviewButton() {
			       const fileInput = document.getElementById('po_attachment');
			       const previewButtonDiv = document.getElementById('previewButtonDiv');
			       if (fileInput.files.length > 0) {
			           previewButtonDiv.style.display = 'block';  // Show the preview button
			       } else {
			           previewButtonDiv.style.display = 'none';  // Hide the preview button if no file selected
			       }
			   }

			   // Preview the PDF when the Preview button is clicked
			   function previewPDF() {
			       const file = document.getElementById('po_attachment').files[0];  // Get the selected file

			       // Check if the selected file is a PDF
			       if (file && file.type === 'application/pdf') {
			           const reader = new FileReader();  // Create a FileReader instance

			           reader.onload = function(e) {
			               const pdfData = e.target.result;  // Get the PDF file data
			               const iframe = document.getElementById('pdfViewer');  // Get the iframe
			             //  iframe.src = pdfData;  // Set the iframe source to the PDF data
						 iframe.src = pdfData + "#toolbar=0"; 
			               // Show the modal
			               const pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
			               pdfModal.show();  // Open the modal
			           };

			           reader.readAsDataURL(file);  // Read the file as Data URL
			       } else {
			           alert('Please select a valid PDF file.');
			       }
			   }
			   
	  function updateDateTime1() {
	    const dateTimeInput = document.getElementById('podateTime');
	    const now = new Date();

	    // Format date: dd-MM-yyyy
	    const day = String(now.getDate()).padStart(2, '0');
	    const month = String(now.getMonth() + 1).padStart(2, '0');
	    const year = now.getFullYear();

	    // Format time in 12-hour format with AM/PM
	    let hours = now.getHours();
	    const minutes = String(now.getMinutes()).padStart(2, '0');
	    const seconds = String(now.getSeconds()).padStart(2, '0');
	    const ampm = hours >= 12 ? 'PM' : 'AM';
	    hours = hours % 12 || 12; // Convert 0 to 12

	    const time = `${String(hours).padStart(2, '0')}:${minutes}:${seconds} ${ampm}`;
	    const date = `${day}-${month}-${year}`;

	    dateTimeInput.value = `${date} ${time}`;
	  }

	  // Initial call + update every second
	  window.onload = updateDateTime1;
	  setInterval(updateDateTime1, 1000);
	  
	    function addNewRow() {
	      const tableBody = document.querySelector("#po_items_table tbody");
	      const firstRow = tableBody.querySelector("tr");
	      const newRow = firstRow.cloneNode(true); // Clone the first row

	      // Reset the input values in the cloned row
	      newRow.querySelectorAll("input").forEach((input, index) => {
	        input.value = ""; // Clear value

	        // If it's the Sl No column, update the number
	        if (input.name === "slno[]") {
	          input.value = tableBody.rows.length + 1;
	        }
	      });

	      // Show the remove button for newly added rows
	      newRow.querySelector(".action-col").style.display = "";
	      tableBody.appendChild(newRow);
	    }

	    // Optional: Remove row function
	    function removeRow(button) {
	      const row = button.closest("tr");
	      const tableBody = row.closest("tbody");

	      // Prevent removing the last remaining row
	      if (tableBody.rows.length > 1) {
	        row.remove();

	        // Update serial numbers after removing
	        [...tableBody.rows].forEach((tr, idx) => {
	          const slNoInput = tr.querySelector('input[name="slno[]"]');
	          if (slNoInput) slNoInput.value = idx + 1;
	        });
	      }
	    }  

	  function addItemRow() {
	    const table = document.getElementById('po_items_table').getElementsByTagName('tbody')[0];
	    const rowCount = table.rows.length;

	    const newRow = table.insertRow();
	    newRow.innerHTML = `
	      <td><input type="number" class="form-control" name="slno[]" value="${rowCount + 1}" readonly></td>
	      <td><input type="text" class="form-control" name="modules[]"></td>
	      <td><input type="text" class="form-control" name="part_no[]"></td>
	      <td><input type="text" class="form-control" name="hsn_code[]"></td>
	      <td><input type="text" class="form-control" name="description[]"></td>
	      <td><input type="number" class="form-control salequantity" name="quantity[]" min="1" oninput="calculateTotalsale(this)"></td>
	      <td><input type="number" class="form-control saleprice" name="price[]" min="0" step="0.01" oninput="calculateTotalsale(this)"></td>
		  <td><input type="number" class="form-control taxable-value saletotal-without-gst d-none" name="line_total_without_gst[]"></td>
		  <td class="cgst-value d-none">
		      <input type="number" class="form-control" name="cgst[]" value="${product.cgst}" />
		  </td>
		  <td class="sgst-value d-none">
		      <input type="number" class="form-control" name="sgst[]" value="${product.sgst}" />
		  </td>
		  <td class="igst-value d-none">
		      <input type="number" class="form-control" name="igst[]" value="${product.igst}" />
		  </td>
	      <td><input type="number" class="form-control" name="line_total[]" ></td>
		  <td class="action-col" style="display: table-cell;">
		       <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeRow(this)">Remove</button>
		     </td>
	    `;
	  }
	  
	 /* const form = document.getElementById('purchaseOrderForm');
	  const submitButton = document.querySelector('.btn-success');

	  form.addEventListener('submit', async function (e) {
		  
	      e.preventDefault();
		  alert("Form submission started.");

	      // Change the button text and disable it during submission
	      submitButton.disabled = true;
	      submitButton.textContent = 'Submitting...';
		  alert("Submit button disabled and text changed.");

	      const items = [];
		  const rows = document.q												uerySelectorAll('#po_items_table tbody tr');
		  rows.forEach((row, index) => {
		      let lineTotal = parseFloat(row.querySelector('[name="total_line_total[]"]').value || 0);
		      let totalValue = parseFloat(row.querySelector('.totalvalue').value || 0);

		      let cgst = 0, sgst = 0, igst = 0;

		      if (!row.querySelector('.cgst-value').classList.contains('d-none')) {
		          cgst = parseFloat((lineTotal * 0.09).toFixed(2));
		      }
		      if (!row.querySelector('.sgst-value').classList.contains('d-none')) {
		          sgst = parseFloat((lineTotal * 0.09).toFixed(2));
		      }
		      if (!row.querySelector('.igst-value').classList.contains('d-none')) {
		          igst = parseFloat((lineTotal * 0.18).toFixed(2));
		      }

		      items.push({
		          slNo: index + 1,
		          moduleName: row.querySelector('[name="modules[]"]').value,
		          partNo: row.querySelector('[name="part_no[]"]').value,
		          hsnCode: row.querySelector('[name="hsn_code[]"]').value,
		          description: row.querySelector('[name="description[]"]').value,
		          quantity: parseInt(row.querySelector('[name="quantity[]"]').value),
		          price: parseFloat(row.querySelector('[name="price[]"]').value),
		          lineTotal: lineTotal,
		          cgst: cgst,
		          sgst: sgst,
		          igst: igst,
		          totalValue: totalValue
		      });
		  });
		  alert("Items processed: " + JSON.stringify(items));
		  console.log('Items:', items);

	      const data = {
		
	          poNumber: document.getElementById('po_number').value,
	          poDate: document.getElementById('po_date').value,
	          //poGst: document.getElementById('po_gst').value,
	          billingAddress: document.getElementById('billing_address').value,
	          shippingAddress: document.getElementById('shipping_address').value,
	          supplierName: document.getElementById('supplier_name').value,
	          supplierGst: document.getElementById('supplier_gst').value,
	          vendorCode: document.getElementById('vendor_code').value,
	          createdDateTime: new Date().toISOString(),
	          grandTotal: parseFloat(document.getElementById('grand_total').value),
	          
	          cust_honorifics: document.getElementById('company_honorifics1').value,
	          cust_name: document.getElementById('vendorName1').value,
	          cus_leagal_name: document.getElementById('vendorlegalNamee1').value,
	          gst_no: document.getElementById('gstnumberr1').value,
	          order_mehtod: document.getElementById('orderMethod1').value,
	          contact_honorifics:document.getElementById('contact_person_honorifics1').value,
	          cont_person_name:document.getElementById('personName1').value,
	          designation:document.getElementById('designation1').value,
	          mobile_no:document.getElementById('contactDetails1').value,
	          email:document.getElementById('emailId1').value,
			  // Include Terms and Conditions
			    termsAndConditions: document.getElementById('terms_and_conditionnew').value,
				purchaseId: document.getElementById('poid').value,
				quotationId: document.getElementById('quotationId').value, 
	          items
	      };
		  
		  // Alert the entire data object as a string
		  // Alert the entire data object as a string
		  alert("PO Data: " + JSON.stringify(data, null, 2));		  // 🔍 Alert individual key values to debug
		  alert("PO Number: " + data.poNumber);
		  alert("PO Date: " + data.poDate);
		  alert("Billing Address: " + data.billingAddress);
		  alert("Shipping Address: " + data.shippingAddress);
		  alert("Supplier Name: " + data.supplierName);
		  alert("Grand Total: " + data.grandTotal);
		  alert("First Item CGST: " + (data.items[0]?.cgst ?? 'No items'));
		  alert("First Item Total Value: " + (data.items[0]?.totalValue ?? 'No items'));

		  // 🔍 Full object log in console
		  console.log("Submitting PO Data:", data);

	      console.log("daaattttaaa---",data);

	      await fetch('/purchase-orders', {
	          method: 'POST',
	          headers: {
	              'Content-Type': 'application/json',
	          },
	          body: JSON.stringify(data)
	      }).then(res => res.json())
	        .then(res => {
			
	            // After submission, show success message and disable the submit button
	            alert('Purchase Order Saved!');
	            submitButton.disabled = true;
	            submitButton.textContent = 'Submitted';
	            location.reload(); // Optional, if you want to reload the page
	        })
	        .catch(err => {
	            // If there's an error, re-enable the button and reset the text
	            submitButton.disabled = false;
	            submitButton.textContent = 'Submit Purchase Order';
	            alert('Error occurred while saving the purchase order');
	        });
	  });*/
	  
	  
	  document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
	      e.preventDefault();
	      
	      // Prepare the form data as an object
	      const formData = {
	          poNumber: document.getElementById('po_number').value,
	          poDate: document.getElementById('po_date').value,  
	          vendorCode: document.getElementById('vendor_code').value,
			  createdDateTime: new Date().toISOString(),
	          quotationId: document.getElementById('quotationId').value,
	          billingAddress: document.getElementById('billing_address').value,
	          shippingAddress: document.getElementById('shipping_address_edit').value,
	          cust_honorifics: document.getElementById('company_honorifics1').value,
	          cust_name: document.getElementById('vendorName1').value,
	          cus_leagal_name: document.getElementById('vendorlegalNamee1').value,
	          gst_no: document.getElementById('gstnumberr1').value,
	          order_mehtod: document.getElementById('orderMethod1').value,
	          contact_honorifics: document.getElementById('contact_person_honorifics1').value,
	          cont_person_name: document.getElementById('personName1').value,
	          designation: document.getElementById('designation1').value,
	          mobile_no: document.getElementById('contactDetails1').value,
	          email: document.getElementById('emailId1').value,
	          termsAndConditions: document.getElementById('terms_and_conditionnew').value,
			  purchaseId: document.getElementById('poid').value,
			  tax_type: document.getElementById('interState1').checked
			    ? 'intrastate'
			    : document.getElementById('outerState1').checked
			    ? 'interstate'
			    : '',
			  // ✅ New fields added below:
			  modeOfPayment: document.getElementById('mode_of_payment').value,
			  termsOfDelivery: document.getElementById('terms_of_delivery').value,

	          // Items (loop through the table rows to get item details)
	          items: Array.from(document.querySelectorAll('#po_items_table tbody tr')).map(row => ({ 
	              partNo: row.querySelector('input[name="part_no[]"]').value,
	              hsnCode: row.querySelector('input[name="hsn_code[]"]').value,
	              description: row.querySelector('input[name="description[]"]').value,
	              quantity: row.querySelector('input[name="quantity[]"]').value,
	              price: row.querySelector('input[name="price[]"]').value,
				  lineTotal: row.querySelector('input[name="line_total[]"]').value,
	              cgst: row.querySelector('input[name="cgst[]"]').value,
	              sgst: row.querySelector('input[name="sgst[]"]').value,
	              igst: row.querySelector('input[name="igst[]"]').value,
	              totalValue: row.querySelector('input[name="total_line_total[]"]').value,
	              p_id: row.querySelector('input[name="product_id[]"]').value,
	          }))
	      };
	      
	      //alert(JSON.stringify(formData, null, 2));
	      console.log("aaaaaaaaa",JSON.stringify(formData, null, 2));
		  // Alert full form data as JSON string
		  // alert('Form Data:\n' + JSON.stringify(formData, null, 2));

	      // Send data to backend using fetch or AJAX
	      fetch('/purchase-orders', {
	          method: 'POST',
	          headers: {
	              'Content-Type': 'application/json',
	          },
	          body: JSON.stringify(formData)
	      })
	      .then(response => response.json())
	      .then(data => {
	    	  
	          // Handle success
	          alert('saved successfully');
	          // Close the modal
	          const modalElement = document.getElementById('purchaseOrderModal');
	          const modalInstance = bootstrap.Modal.getInstance(modalElement);
	          modalInstance.hide(); 
	          
	      })
	      .catch((error) => {
	          alert('Error:', error);
	      });
	  });

	</script>
<script>
function calculateTotalsaleneww(inputElement) {
	    // alert("Step 1: Function called");

	    const row = inputElement.closest("tr");
	    console.log("ROW HTML:\n" + (row ? row.innerHTML : "No row found"));
	    if (!row) {
	      //  alert("Step 2: Row not found");
	        return;
	    }
	      //  alert("Step 2: Row found");

	    const quantityInput = row.querySelector(".salequantity");
	    const priceInput = row.querySelector(".saleproduct");
	    const totalWithoutGstInput = row.querySelector(".saletaxableValue");
	    const totalWithGstInput = row.querySelector(".totalvalue");
	    
	    const cgstInput = row.querySelector(".salecgst");
	    const sgstInput = row.querySelector(".salesgst");
	    const igstInput = row.querySelector(".saleigst");

	    if (!quantityInput) {
	       // alert("❌ .salequantity not found");
	        return;
	    }
	    if (!priceInput) {
	        //  alert("❌ .saleproduct (price) not found");
	        return;
	    }

	    // alert("Step 3: Required inputs found");

	    const quantity = parseFloat(quantityInput.value) || 0;
	    const price = parseFloat(priceInput.value) || 0;
	    //alert("Step 4: Quantity = " + quantity + ", Price = " + price);

	    const totalWithoutGST = quantity * price;
	   // alert("Step 5: Total without GST = " + totalWithoutGST.toFixed(2));form-control saleigst

	    let cgst = 0, sgst = 0, igst = 0;
	    let totalWithGST = totalWithoutGST;

	    const cgstCell = row.querySelector(".cgst-value");
	    const sgstCell = row.querySelector(".sgst-value");
	    const igstCell = row.querySelector(".igst-value");
	    
	    if (typeof GST_PERCENTAGE === 'undefined') {
	       // alert("Error: GST_PERCENTAGE is not defined!");
	        return;
	    }
		
	    if (document.getElementById("interState1").checked) {
	        //  alert("Step 6: Intra-state selected");

	        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
	        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
	        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
	        
	        totalWithGST += cgst + sgst;

	        if (cgstInput) cgstInput.value = cgst.toFixed(2);
	        if (sgstInput) sgstInput.value = sgst.toFixed(2);
	        if (igstInput) igstInput.value = igst.toFixed(2);      
	        // recalculateTotals();
	        
	    } else if (document.getElementById("outerState1").checked) {
	       // alert("Step 6: Inter-state selected");

	        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
	        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
	        
	        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
	        totalWithGST += igst;

	        if (cgstInput) cgstInput.value = cgst.toFixed(2);
	        if (sgstInput) sgstInput.value = sgst.toFixed(2);
	        if (igstInput) igstInput.value = igst.toFixed(2);
	        //recalculateTotals();
	    } else {
	        //  alert("Step 6: No tax type selected (neither interState1 nor outerState1)");
	    }
		
	    // alert("Step 7: Total with GST = " + totalWithGST.toFixed(2));
		
	    // These fields are optional now
	    if (totalWithoutGstInput) {
	        totalWithoutGstInput.value = totalWithoutGST.toFixed(2);
	    }
		
	    if (totalWithGstInput) {
	        totalWithGstInput.value = totalWithGST.toFixed(2);
	    }
	   
	    // Recalculate totals after the GST selection changes 
	   if (document.getElementById("interState1").checked) {
		    recalculateTotals("interState1");
		} else if (document.getElementById("outerState1").checked) {
		    recalculateTotals("outerState1");
		} else {
		    recalculateTotals(); // fallback
		}
	    
	    // alert("Step 8: Values calculated and optionally updated");
	    
	}

function applyGSTSelectionnew() {
    const isInterState = document.getElementById("interState1").checked;
    const isOuterState = document.getElementById("outerState1").checked;

    // Toggle header visibility
    document.querySelector(".cgst-saleheader").classList.toggle("d-none", !isInterState);
    document.querySelector(".sgst-saleheader").classList.toggle("d-none", !isInterState);
    document.querySelector(".igst-saleheader").classList.toggle("d-none", !isOuterState);

    const rows = document.querySelectorAll("#po_items_table tbody tr");
    console.log("Total rows found:", rows.length);

    rows.forEach((row, index) => {
        console.log("Processing row:", index);

        const quantityInput = row.querySelector(".salequantity");
        const priceInput = row.querySelector(".saleprice");

        const taxableValueInput = row.querySelector(".saletaxableValue");

        const cgstInput = row.querySelector(".salecgst");
        const sgstInput = row.querySelector(".salesgst");
        const igstInput = row.querySelector(".saleigst");

        const cgstCell = row.querySelector(".cgst-value");
        const sgstCell = row.querySelector(".sgst-value");
        const igstCell = row.querySelector(".igst-value");

        // Calculate taxable value based on quantity and price
        if (quantityInput && priceInput) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const calculatedTaxableValue = (quantity * price).toFixed(2);
            taxableValueInput.value = calculatedTaxableValue;
        }

        // Recalculate taxableValue after updating the input
        const taxableValue = parseFloat(taxableValueInput.value) || 0;

        // Update CGST/SGST/IGST based on selection
        if (isInterState) {
            cgstCell.style.display = "";
            sgstCell.style.display = "";
            igstCell.style.display = "none";

            const cgstValue = (taxableValue * (GST_PERCENTAGE / 200)).toFixed(2);
            const sgstValue = (taxableValue * (GST_PERCENTAGE / 200)).toFixed(2);
            const igstValue = (taxableValue * (GST_PERCENTAGE / 100)).toFixed(2);

            cgstInput.value = cgstValue;
            sgstInput.value = sgstValue;
            igstInput.value = igstValue;

        } else if (isOuterState) {
            cgstCell.style.display = "none";
            sgstCell.style.display = "none";
            igstCell.style.display = "";

            const cgstValue = (taxableValue * (GST_PERCENTAGE / 200)).toFixed(2);
            const sgstValue = (taxableValue * (GST_PERCENTAGE / 200)).toFixed(2);
            const igstValue = (taxableValue * (GST_PERCENTAGE / 100)).toFixed(2);

            igstInput.value = igstValue;
            cgstInput.value = cgstValue;
            sgstInput.value = sgstValue;
        } else {
            cgstCell.style.display = "none";
            sgstCell.style.display = "none";
            igstCell.style.display = "none";

            cgstInput.value = "";
            sgstInput.value = "";
            igstInput.value = "";
        }

        console.log("Calling calculateTotalsale for row:", index);
        calculateTotalsale(row);
    });
}



function calculateTotalsale(inputElement) {
     
    const row = inputElement.closest("tr"); 
    
    if (!row) {
       // alert("Step 2: Row not found");
        return;
    } 
	
    const quantityInput = row.querySelector(".salequantity");
    const priceInput = row.querySelector(".saleproduct");
    const totalWithoutGstInput = row.querySelector(".saletotal-without-gst");
    const totalWithGstInput = row.querySelector(".saletotal-with-gst");
	document.querySelectorAll('.saleprice').forEach(el => console.log("forcee"+el));

   /*  if (!quantityInput) alert("❌ .salequantity not found");
    if (!priceInput) alert("❌ .saleprice not found");
    if (!totalWithoutGstInput) alert("❌ .saletotal-without-gst not found");
    if (!totalWithGstInput) alert("❌ .saletotal-with-gst not found");
    */
    if (!quantityInput || !priceInput || !totalWithoutGstInput || !totalWithGstInput) {
        return;
    }

    // Always retrieve the quantity and price values from the inputs
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;

    const totalWithoutGST = quantity * price;

    let cgst = 0, sgst = 0, igst = 0;
    let totalWithGST = totalWithoutGST;

    const cgstCell = row.querySelector(".cgst-value");
    const sgstCell = row.querySelector(".sgst-value");
    const igstCell = row.querySelector(".igst-value");

    // Make sure GST_PERCENTAGE is defined
    if (typeof GST_PERCENTAGE === 'undefined') {
        return;
    }

    if (document.getElementById("interState1").checked) {
		
        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        totalWithGST += cgst + sgst;
		
        if (cgstCell) cgstCell.innerText = cgst.toFixed(2);
        if (sgstCell) sgstCell.innerText = sgst.toFixed(2);
        if (igstCell) igstCell.innerText = "—";
        
    } else if (document.getElementById("outerState1").checked) {

        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
        totalWithGST += igst;

        if (cgstCell) cgstCell.innerText = "—";
        if (sgstCell) sgstCell.innerText = "—";
        if (igstCell) igstCell.innerText = igst.toFixed(2);
        
    } else {
        alert("Step 6: No tax type selected (neither interState1 nor outerState1)");
    }

    totalWithoutGstInput.value = totalWithoutGST.toFixed(2);
    totalWithGstInput.value = totalWithGST.toFixed(2);
    
}

function toggleGSTnew(type) {
    if (type === "interState1") {
        document.getElementById("outerState1").checked = false;
    } else {
        document.getElementById("interState1").checked = false;
    }

    applyGSTSelectionnew();
    
    // Recalculate totals after the GST selection changes
    recalculateTotals(type);
    
}

// Create a new function to recalculate totals when user change the tax type or price or quantity
function recalculateTotals(type) {
	if (type) {
        if (type === "interState1") {
            
            document.getElementById("igstTotalTaxValueCell").style.display = "none";
            document.getElementById("cgstTotalTaxValueCell").style.display = "table-row";
            document.getElementById("sgstTotalTaxValueCell").style.display = "table-row";
            
        } else {
        	
        	// Show IGST, hide CGST & SGST
            document.getElementById("igstTotalTaxValueCell").style.display = "table-row";
            document.getElementById("cgstTotalTaxValueCell").style.display = "none";
            document.getElementById("sgstTotalTaxValueCell").style.display = "none"; 
        }
    }
	
	let totalTaxable = 0;
    let totalTax = 0;
    let grandTotal = 0;
    let amountWithTax = 0;
    let roundOffDecimal = 0;
    let roundedFinalAmount = 0;
    
    // New: individual tax totals
    let totalCgst = 0;
    let totalSgst = 0;
    let totalIgst = 0;
	
    const tbody = document.querySelector("#po_items_table tbody");
    const rows = tbody.querySelectorAll("tr");

    rows.forEach(row => {
         
    	// Get product details
        const taxableValue = parseFloat(row.querySelector('.saletaxableValue')?.value || 0);
	   /*  const cgst = parseFloat(row.querySelector('.salecgst')?.value || 0);
	    const sgst = parseFloat(row.querySelector('.salesgst')?.value || 0);
	    const igst = parseFloat(row.querySelector('.saleigst')?.value || 0); */
	    
	    // .igst-value .cgst-value .sgst-value 
	    
	   // Read tax values from updated class if present, else fallback
		const cgst = parseFloat(
			row.querySelector('.cgst-value')?.value || 
			row.querySelector('.salecgst')?.value || 
			0
		);
		const sgst = parseFloat(
			row.querySelector('.sgst-value')?.value || 
			row.querySelector('.salesgst')?.value || 
			0
		);
		const igst = parseFloat(
			row.querySelector('.igst-value')?.value || 
			row.querySelector('.saleigst')?.value || 
			0
		);
		
		/* const temp_igst = row.querySelector('.igst-value')?.value || 0;
		alert(temp_igst); */
		
	    const totalValue = parseFloat(row.querySelector('.totalvalue')?.value || 0);
		
		 // Add to individual tax totals
        totalCgst += cgst;
        totalSgst += sgst;
        totalIgst += igst;
        
        // Update totals
        totalTaxable += taxableValue;
        
        if (type) {
            if (type === "interState1") {
            	totalTax += cgst + sgst;
            }else{
            	totalTax += igst;
            }        	
        }
        
        grandTotal += totalValue;
		
        amountWithTax = totalTaxable + totalTax;
        
        roundOffDecimal = amountWithTax - Math.floor(amountWithTax);
		
    });
 
    // Update total values in the UI
    document.getElementById("taxableTotalValue").textContent = totalTaxable.toFixed(2);
    document.getElementById("taxTotalValue").textContent = totalTax.toFixed(2);
    document.getElementById("amountWithTax").textContent = amountWithTax.toFixed(2);

    // Set round off and rounded amount
    const initialRounded = customRound(amountWithTax);
    const sign = roundOffDecimal >= 0 ? "+" : "-";
    document.getElementById("roundOffDecimal").textContent = `${sign}${Math.abs(roundOffDecimal).toFixed(2)}`;

    document.getElementById("grandTotalValue").textContent = initialRounded.toFixed(2);
    
    // ✅ Set the individual tax values
    document.getElementById("cgstTotalTaxValue").textContent = totalCgst.toFixed(2);
    document.getElementById("sgstTotalTaxValue").textContent = totalSgst.toFixed(2);
    document.getElementById("igstTotalTaxValue").textContent = totalIgst.toFixed(2);
    
}

// Add event listeners to recalculate totals when the tax fields change
document.querySelectorAll('.salequantity, .saleproduct, .salecgst, .salesgst, .saleigst').forEach(element => {
    element.addEventListener('input', function() {
        recalculateTotals();  // Recalculate totals when any of the tax-related inputs change
    });
});

</script>

<!-- script to disable the feature dates -->
<script>
  // Set today's date as the max value
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('po_date').setAttribute('max', today);
</script>

	<script>
		document.getElementById("feedbackForm").addEventListener("submit", function (event) {
			    event.preventDefault(); // Prevent default form submission

			    $.ajax({
			        url: 'recentlySavedTicketNumber',
			        type: 'GET',
			        success: function (response) {
			            let recentlyInsertedTicketIdData = response;

			            // Get the current date
			            var today = new Date();
			            var year = today.getFullYear();
			            var month = today.getMonth() + 1; // JavaScript months are 0-based

			            // Calculate the financial year
			            var financialYearStart = month >= 4 ? year : year - 1; // Fiscal year starts in April
			            var financialYearEnd = financialYearStart + 1;

			            // Format as FYY-YY
			            var financialYear = `F${financialYearStart % 100}-${financialYearEnd % 100}`;

			            // Department Name
			            var loggedInDeptName = $('#loggedInDeptName').val();

			            let incrementedNumber = "0001"; // Default number if response is empty or null

			            // Check if recentlyInsertedTicketIdData is not empty or null
			            if (recentlyInsertedTicketIdData) {
			                // Extract the last part of the ticket (e.g., 0001)
			                let ticketParts = recentlyInsertedTicketIdData.split("/");
			                let lastPart = ticketParts[ticketParts.length - 1];

			                // Increment the extracted number
			                let numericValue = parseInt(lastPart, 10) + 1;
			                incrementedNumber = numericValue.toString().padStart(4, '0'); // Pad with leading zeros
			            }

			            // Construct the feedback ticket
			            var feedbackTicket = `MSPL/FT/${financialYear}/${loggedInDeptName}/${incrementedNumber}`;

			            // Add feedback ticket to the form data
			            let formData = new FormData(document.getElementById("feedbackForm"));
			            formData.append("id", feedbackTicket);
			            formData.append("emp_id", $('#emp_idSessionValue').val());

			            const submitButton = document.getElementById("submitFeedbackBtn");
			            submitButton.disabled = true; // Disable the submit button to prevent multiple submissions

			            const loadingSwal = Swal.fire({
			                title: 'Submitting feedback...',
			                text: 'Please wait while we submit your feedback.',
			                showConfirmButton: false,
			                allowOutsideClick: false, // Prevent closing when clicking outside
			                            allowEscapeKey: false, // Prevent closing when pressing escape key
			                didOpen: () => {
			                    Swal.showLoading(); // Display the loading spinner
			                }
			            });

			            // Append files to form data
			            let files = document.getElementById("feedbackAttachment").files;
			            if (files.length > 0) {
			                for (let i = 0; i < files.length; i++) {
			                    formData.append(`attachment[${i}]`, files[i]); // Use unique keys
			                }
			            }

			            let bugType = document.getElementById("bugType").value;
			            formData.append("bugTypeff", bugType); // Add the bug type to the form data

			            // Debugging: Log formData entries before the fetch call
			            console.log("Logging formData entries:");
			            for (let [key, value] of formData.entries()) {
			                if (value instanceof File) {
			                    console.log(`Key: ${key}, File Name: ${value.name}, Size: ${value.size}`);
			                } else {
			                    console.log(`Key: ${key}, Value: ${value}`);
			                }
			            }

			            // Make AJAX request to submit feedback
			            fetch("/submitFeedback", {
			                method: "POST",
			                body: formData
			            })
			                .then(response => response.json())
			                .then(data => {
			                    loadingSwal.close();
			                    submitButton.disabled = false; // Re-enable the button
			                    if (data.success) {
			                        $('#feedbackModal').modal('hide');
			                        Swal.fire({
			                            title: 'Success!',
			                            text: 'Your feedback has been submitted successfully.',
			                            icon: 'success',
			                            allowOutsideClick: false, // Prevent closing when clicking outside
			                                        allowEscapeKey: false, // Prevent closing when pressing escape key
			                            customClass: {
			                                popup: 'custom-swal-font'
			                            },
			                            confirmButtonText: 'OK'
			                        }).then((result) => {
			                            if (result.isConfirmed) {
			                                    Swal.fire({
			                                            html: 'We sincerely appreciate your feedback! Please find your feedback ticket details below.<br><br>' + 
			                                    '<strong>' + feedbackTicket + '</strong>', // Display the feedback ticket on a new line
			                                    allowOutsideClick: false, // Prevent closing when clicking outside
			                                                allowEscapeKey: false, // Prevent closing when pressing escape key
			                                    customClass: {
			                                        popup: 'custom-swal-font'
			                                    },
			                                    confirmButtonText: 'OK'
			                                });
			                            }
			                        });
			                    } else {
			                        Swal.fire({
			                            title: 'Error!',
			                            text: 'There was an error submitting your feedback.',
			                            icon: 'error',
			                            allowOutsideClick: false, // Prevent closing when clicking outside
			                                        allowEscapeKey: false, // Prevent closing when pressing escape key
			                            customClass: {
			                                popup: 'custom-swal-font'
			                            },
			                            confirmButtonText: 'OK'
			                        });
			                    }
			                })
			                .catch(error => {
			                    console.error('Error:', error);
			                    loadingSwal.close();
			                    submitButton.disabled = false; // Re-enable the button
			                    Swal.fire({
			                        title: 'Error!',
			                        text: 'There was an error submitting your feedback.',
			                        icon: 'error',
			                        allowOutsideClick: false, // Prevent closing when clicking outside
			                                    allowEscapeKey: false, // Prevent closing when pressing escape key
			                        customClass: {
			                            popup: 'custom-swal-font'
			                        },
			                        confirmButtonText: 'OK'
			                    });
			                });
			        },
			        error: function (xhr, status, error) {
			            alert('Failed to fetch recently inserted feedback ticket: ' + error);
			        }
			    });
			});


			   // Clear form fields when the modal is closed
			   document.getElementById('feedbackModal').addEventListener('hidden.bs.modal', function () {
			       const feedbackForm = document.getElementById('feedbackForm');
			       feedbackForm.reset(); // Reset the form fields
			       document.getElementById('feedbackAttachment').value = ""; // Clear file input manually
			   });
	</script>

</body>

</html>