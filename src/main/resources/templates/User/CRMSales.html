<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport">

	<title>MSPL CONNECT</title>
	<meta content="" name="description">
	<meta content="" name="keywords">

	<!-- Favicons -->
	<link href="assets/img/favicon.png" rel="icon">
	<link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

	<!-- Google Fonts -->
	<!-- <link href="https://fonts.gstatic.com" rel="preconnect">
	<link
		href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
		rel="stylesheet"> -->
		 <link rel="stylesheet" href="/assets/font/fonts.css"> 

	<!-- Vendor CSS Files -->
	<link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
	<link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
	<link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
	<link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
	<link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
	<link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

	<!-- Template Main CSS File -->
	<link href="assets/css/style.css" rel="stylesheet">
	<!-- 	<script src="https://code.highcharts.com/highcharts.js"></script> -->
 	<script src="assets/js/highcharts.js"></script>
 	
	<!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
	  <script src="assets/js/jquery-3.6.4.min.js"></script>
	  
	<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
	<script src="assets/js/sweetalert2@11.js"></script>
	<!--CHAT BOOT-->

	<!-- Include SockJS and Stomp.js libraries -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

	<style>
		* {
			font-size: 14px;
		}

		.card {
			border: 1px solid #ddd;
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 20px;
		}

		.info-card {
			background-color: #fff;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		#attendence-chart {
			width: 100%;
			height: 190px;
			/* Adjust the height as needed */
		}

		/* Example CSS to style disabled items */
		.activity-item .disabled {
			pointer-events: none;
			/* Disable interactions */
			opacity: 0.5;
			/* Make the item appear grayed out */
		}

		.profile-picture {
			width: 40px;
			/* Adjust the size as needed */
			height: 150px;
			/* Ensure the height and width are the same */
			border-radius: 50%;
			/* This makes the image a circle */
			object-fit: cover;
			/* Ensures the image fits within the circle */
		}

		/* Make the body take up the full height of the viewport */
		body {
			display: flex;
			flex-direction: column;
			min-height: 100vh;
			margin: 0;
		}

		/* Ensure the main content takes up all available space */
		main {
			flex: 1;
		}

		/* Style the footer */
		.footer {
			background-color: #f8f9fa;
			/* Light gray background */
			text-align: center;
			/* Center-align text */
			padding: 10px 0;
			/* Add some padding */
			font-size: 14px;
			/* Set font size */
		}

		.toast-notification {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: linear-gradient(135deg, #007bff, #00d4ff);
			color: white;
			padding: 15px 20px;
			border-radius: 10px;
			box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			opacity: 0;
			transform: translateX(100%);
			transition: opacity 0.3s ease, transform 0.3s ease-in-out;
			font-family: 'Arial', sans-serif;
			font-size: 14px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			min-width: 250px;
			gap: 10px;
		}

		/* Fade-in effect */
		.toast-notification.show {
			opacity: 1;
			transform: translateX(0);
		}

		/* Close button */
		.toast-close {
			cursor: pointer;
			font-size: 16px;
			opacity: 0.8;
			transition: opacity 0.2s;
		}

		.toast-close:hover {
			opacity: 1;
		}

		/* Fade-out effect */
		.toast-notification:not(.show) {
			opacity: 0;
			transform: translateX(100%);
			transition: opacity 0.3s ease, transform 0.3s ease-in-out;
		}
		

		/* Style for the new feature list item */
			.nav-item.new-feature {
			  position: relative; /* Needed for pseudo-element positioning */
			}

			/* Create the "New" badge with a pseudo-element */
		/*	.nav-item.new-feature::after {
			  content: 'New';
			  position: absolute;
			  top: -8px;
			  right: -10px;
			  background-color: #28a745;
			  color: #fff;
			  font-size: 0.7rem;
			  font-weight: bold;
			  padding: 2px 6px;
			  border-radius: 10px;
			  animation: pulse 2s infinite;
			}*/

			/* Keyframes for a simple pulsating effect */
			/*@keyframes pulse {
			  0% {
			    transform: scale(1);
			    opacity: 1;
			  }
			  50% {
			    transform: scale(1.1);
			    opacity: 0.8;
			  }
			  100% {
			    transform: scale(1);
			    opacity: 1;
			  }
			}*/
			
			/* Ensure version number appears on a new line */
						.release-note-text {
						  display: flex;
						  flex-direction: column; /* Stacks elements vertically */
						  font-size: 1rem;
						}

						/* Optional: Adjust the version number styling */
						.version-number {
						  font-size: 0.9rem;
						  font-weight: bold;
						  color: #555;
						}
						/* Custom Modal Styles */
						.modal {
						    display: none;
						    position: fixed;
						    z-index: 9999;
						    top: 0;
						    left: 0;
						    width: 100%;
						    height: 100%;
						    background-color: rgba(0, 0, 0, 0.5);
						    padding-top: 60px;
						}

						.modal-dialog {
						    max-width: 90%;
						    margin: 0 auto;
						}

						.modal-content {
						    border-radius: 8px;
						    padding: 20px;
						    background-color: #fff;
						    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
						}

						.modal-header {
						    border-bottom: 1px solid #dee2e6;
						    padding-bottom: 15px;
						}

						.modal-title {
						    color: #1a99aa;
						}

						.btn-close {
						    color: #aaa;
						    font-size: 1.5rem;
						    opacity: 1;
						}

						.btn-close:hover {
						    color: #000;
						    opacity: 1;
						}

						.form-control {
						    border-radius: 5px;
						    box-shadow: none;
						    border: 1px solid #ddd;
						}

						textarea.form-control {
						    resize: vertical;
						}

						button[type="submit"] {
						    background-color: #1a99aa;
						    color: white;
						    border: none;
						    padding: 10px 30px;
						    font-size: 14px;
						    border-radius: 4px;
						    cursor: pointer;
						}

						button[type="submit"]:hover {
						    background-color: #148f89;
						}

						.dragging {
						    opacity: 0.5;
						    border: 2px dashed #007bff;
						}
						/* Reduce spacing above/below the submenu */
						ul.submenu {
						    margin-top: 0px;  /* Adjust as needed */
						    padding-top: 2px; /* Reduce top padding */
						}

						/* Optional: tighten spacing for submenu items */
						ul.submenu li a.nav-link {
						    padding: 4px 10px;  /* Adjust to your desired tightness */
						    line-height: 1.2;   /* Reduce line height for compactness */
						}
						
						
						.swal22-custom-z {
						  z-index: 9999 !important;
						}
						.modal-backdrop {
						  z-index: 1040 !important;
						}
						.modal {
						  z-index: 1050 !important;
						}
						
						/* Compact modal content */
						 #addDropdownModal .modal-content {
						   padding: 10px;
						 }

						 #addDropdownModal .modal-body {
						   padding: 10px;
						 }

						 #addDropdownModal .modal-header,
						 #addDropdownModal .modal-footer {
						   padding: 10px;
						 }

						 #addDropdownModal input.form-control {
						   font-size: 0.875rem;
						   padding: 6px 10px;
						 }

						 #addDropdownModal .modal-dialog {
						   max-width: 350px; /* Controls the width */
						   margin-top: 10vh;  /* Moves it slightly down */
						 }
						 #addDropdownModal {
						   z-index: 11000 !important; /* Bootstrap default modals have z-index ~1050-1070 */
						 }
						 /* Compact modal content */
						 						 #addDropdownModal1 .modal-content {
						 						   padding: 10px;
						 						 }

						 						 #addDropdownModal1 .modal-body {
						 						   padding: 10px;
						 						 }

						 						 #addDropdownModal1 .modal-header,
						 						 #addDropdownModal1 .modal-footer {
						 						   padding: 10px;
						 						 }

						 						 #addDropdownModal1 input.form-control {
						 						   font-size: 0.875rem;
						 						   padding: 6px 10px;
						 						 }

						 						 #addDropdownModal1 .modal-dialog {
						 						   max-width: 350px; /* Controls the width */
						 						   margin-top: 10vh;  /* Moves it slightly down */
						 						 }
						 						 #addDropdownModal1 {
						 						   z-index: 11000 !important; /* Bootstrap default modals have z-index ~1050-1070 */
						 						 }

	</style>
</head> 

<body>
	<input type="hidden" id="loggedInDeptName" th:value="${empDetailsByEmpId.deptName}">
	<!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center" th:if="${empDetailsByEmpId.deptId>0}">
 
		   <div class="d-flex align-items-center logo-container" style="width:45%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/userDashboard}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
				    <!-- <i class="bi bi-chevron-double-left toggle-sidebar-btn" onclick="toggleIconRotation()"></i> -->
			</div>				
			<div th:replace="fragments/header :: header" ></div>
	
    </header><!-- End Header -->
  
  <!-- =======Super Admin Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center" th:if="${empDetailsByEmpId.deptId == 0}">

    <div class="d-flex align-items-center logo-container" style="width:45%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/navbar}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
	</div><!-- End Logo -->

    <div th:replace="fragments/superAdminHeader :: header"></div>

  </header><!-- End Header -->
	
	<script>
			function clearSessionStorage() {
			    sessionStorage.clear(); // Clear all session storage data
			}
    </script>
	<!-- ======= Sidebar ======= -->

<aside id="sidebar" class="sidebar">
<input type="hidden" id="employee-id" th:value="${empDetailsByEmpId.deptId}">
<input type="hidden" id="employeeId1" name="empId" th:value="${empDetailsByEmpId.empid}" />
<input type="hidden" id="loggedEmpEmail" th:value="${empDetailsByEmpId.email}">

    <ul class="sidebar-nav" id="sidebar-nav">
		 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/userDashboard}">
                <i class="bi bi-grid"></i>
                <span>Dashboard</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link " th:href="@{/navbar}">
		        <i class="bi bi-grid"></i>
		        <span>Dashboard</span>
		    </a>
	    </li>
	    <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
			<a class="nav-link" th:href="@{/Departmentdoc}">
				<i class="bi bi-journal-bookmark"></i>
				<span>MSPL DocVault</span>
			</a>
		</li>
		
		<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
			<a class="nav-link" th:href="@{/Departmentdoc}">
				<i class="bi bi-journal-bookmark"></i>
				<span>MSPL DocVault</span>
			</a>
		</li>  
		<li class="nav-item" th:if="${session.permissions.dispatch && empDetailsByEmpId.deptId==0}">
            <a class="nav-link" th:href="@{/dispatchIframe}">
                <i class="bi bi-truck"></i>
                <span>Dispatched Details</span>
            </a>
        </li>
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminProfile(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-person"></i>
                 <span>My Profile</span>
            </a>
        </li>  
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/attendanceLive(email=${empDetailsByEmpId.email})}">
                <i class="bi bi-calendar3"></i>
                <span>Attendence</span>
            </a> 
        </li>      
       <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/groupMailId}">
                <i class="bi bi-telephone"></i>
                <span>Employee Contacts</span>
            </a>
        </li>
       <!--  <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link " th:href="@{/InterCommDetails}">
                <i class="bi bi-telephone"></i>
                <span>InterComm Details</span>
            </a>
        </li> -->
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/adminHoliday}">
                <i class="bi bi-calendar4-week"></i>
                <span>Holiday List</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
		    <a class="nav-link" th:href="@{/employee}">
		        <i class="bi bi-people"></i>	
		        <span>Employee</span>
		    </a>
	   </li> 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-card-text"></i>
                <span>Team Leaves</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/events}">
                <i class="bi bi-megaphone"></i>
                <span>Announcement</span>
            </a>
        </li>               
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/asset}">
                <i class="bi bi-wallet"></i>
                <span>Assets</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/ongoingProject}">
                <i class="bi bi-card-heading"></i>
                <span>Projects</span>
            </a>
        </li> 
         <!-- <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminPayslip(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-file-text"></i>
                <span>Payslip</span>
            </a>
        </li>     --> 
         <!-- Loop through the permissions map -->
       <li class="nav-item" th:if="${permissions.interviewAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
        </li>
 		<li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId>0}">
			    <a class="nav-link  active" data-bs-target="#presales-submenu" data-bs-toggle="collapse" href="#" >
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Pre-sales</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a>
			    <ul id="presales-submenu" class="nav-content" data-bs-parent="#sidebar-nav">
			        <li>
			            <a th:href="@{/crm}" class="active">
			                <i class="bi bi-circle"></i><span>Activity</span>
			            </a>
			        </li>
			        <li>
			            <a th:href="@{/deals}">
			                <i class="bi bi-circle"></i><span>Pipedrive</span>
			            </a>
			        </li>			         
			    </ul>
			</li>
        <li class="nav-item" th:if="${permissions.sales && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
        
        <li class="nav-item" th:if="${permissions.accountsAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/store}">
                <i class="bi bi-shop-window"></i>
                <span>Store</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.apprisalAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" id="apprisalLink" th:href="@{/apprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Appraisal</span>
		    </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
		    <a class="nav-link" id="apprisalLink" th:href="@{/employeeApprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Employee Appraisal</span>
		    </a>
		</li>
		<li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
				<a class="nav-link" th:href="@{/my-favorites}">
					<i class="bi bi-layout-text-window-reverse"></i>
					<span>To-Chat & Remind</span>
					<span id="unreadCountBadge" class="badge bg-primary" style="display: none;"></span>
				</a>
		</li>
       	<li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId>0}">
					    <a class="nav-link" th:href="@{/releasenotes}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					            Release Note 
					            <span class="version-number">(V.0.1.2)</span>
					        </span>
					    </a>
		</li>
		
		<!-- <li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId>0}">
					    <a class="nav-link active" th:href="@{/crm}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					             <span>Pre-sales Activity</span>
					        </span>
					    </a>
		</li> -->
        
	    <!-- <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link" th:href="@{/attendanceLive(email=${empDetailsByEmpId.email})}">
                <i class="bi bi-calendar3"></i>
                <span>Attendence</span>
            </a>
        </li>  -->
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/adminHoliday}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Holiday List</span>
		    </a>
	 </li>	
	 
	<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		     <a class="nav-link" th:href="@{/addInterComm}">
                <i class="bi bi-telephone"></i>
                <span>Communication</span>
            </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		     <a class="nav-link" th:href="@{/groupMailId}">
                <i class="bi bi-envelope-open"></i>
                <span>Group Mail Id</span>
            </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		<a class="nav-link" th:href="@{/hikeRatingForm}">
			<i class="bi bi-arrow-up-circle"></i><span>Appraisal Ratings</span>
		</a>
	</li>
	<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		<a class="nav-link" th:href="@{/apprisalEmployee}">
			<i class="bi bi-check-square"></i><span>Submitted Appraisals</span>
		</a>
	</li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
          <a class="nav-link" href="hrActivity">
	        <i class="bi bi-file-lock"></i><span>Permissions</span>
	    </a>
      </li>
	 <!--  <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/InterCommDetails}">
                <i class="bi bi-telephone"></i>
                <span>InterComm Details</span>
            </a>
      </li> -->
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link"  th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Employee Leaves</span>
		    </a>
	 	</li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/events}">
		        <i class="bi bi-megaphone"></i>
		        <span>Announcement</span>
		    </a>
	 </li> 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/addDepartment}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Department</span>
		    </a>
	   </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link"  th:href="@{/addRole}">
		        <i class="bi bi-receipt"></i>
		        <span>Role</span>
		    </a>
	 </li>
	 
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/employee}">
		        <i class="bi bi-people"></i>
		        <span>Employee</span>
		    </a>
	 </li> 
	
       
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/ongoingProject}">
                <i class="bi bi-calendar3"></i>
                <span>Projects</span>
            </a>
      </li>  
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/asset}">
                <i class="bi bi-wallet"></i>
                <span>Assets</span>
            </a>
      </li>  
      <li class="nav-item" th:if="${permissions.interviewAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
        </li>
              <li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId==0}">
			    <a class="nav-link collapsed" data-bs-target="#interview-summary-submenu" data-bs-toggle="collapse" href="#">
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Interview Summary</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a> 
			    <ul id="interview-summary-submenu" class="nav-content collapse" data-bs-parent="#sidebar-nav">
			        <li>
		            <a href="totalCandidatesList">
		              <i class="bi bi-circle"></i><span>Total Candidates</span>
			            </a>
			          </li>
			        <li>
		            <a href="selectedCandidatesList">
		              <i class="bi bi-circle"></i><span>Selected Candidates</span>
		            </a>
		          </li>
		          <li>
		            <a href="rejectedCandidatesList">
		              <i class="bi bi-circle"></i><span>Rejected Candidates</span>
		            </a>
		          </li>
			    </ul>
			</li>
        <li class="nav-item new-feature" th:if="${permissions.sales && empDetailsByEmpId.deptId==0}">
			    <a class="nav-link  active" data-bs-target="#presales-submenu" data-bs-toggle="collapse" href="#" >
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Pre-sales</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a>
			    <ul id="presales-submenu" class="nav-content" data-bs-parent="#sidebar-nav">
			        <li>
			            <a th:href="@{/crm}" class="active">
			                <i class="bi bi-circle"></i><span>Activity</span>
			            </a>
			        </li>
			        <li>
			            <a th:href="@{/deals}">
			                <i class="bi bi-circle"></i><span>Pipedrive</span>
			            </a>
			        </li>
			         
			    </ul>
			</li>
        <li class="nav-item" th:if="${permissions.sales && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.accountsAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/store}">
                <i class="bi bi-shop-window"></i>
                <span>Store</span>
            </a>
        </li>  
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
			    <a class="nav-link" href="feedbackReports">
			        <i class="bi bi-chat-square-text"></i>
			        <span>Feedback Reports</span>
			    </a>
		 </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}">
				<a class="nav-link" th:href="@{/my-favorites}">
					<i class="bi bi-layout-text-window-reverse"></i>
					<span>To-Chat & Remind</span>
				</a>
		</li>
		<li class="nav-item new-feature"  th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}">
					    <a class="nav-link" th:href="@{/releasenotes}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					            Release Note 
					            <span class="version-number">(Policy Update)</span>
					        </span>
					    </a>
		</li> 
    </ul>
</aside>
<main id="main" class="main">

		<div class="pagetitle  mb-0 d-flex">
			<i class="bi bi-chevron-double-left toggle-sidebar-btn mb-1" onclick="toggleIconRotation()"
				style="font-size:24px;color:#2F73B9;padding:0 10px;margin-left:-10px;margin-top:-10px"></i>
			<nav>
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="userDashboard">Home</a></li>
					<li class="breadcrumb-item active">CRM</li>
				</ol>
			</nav>
			<!-- Add Company Button -->
			                <div style="margin-left: auto;">
			                    <button class="btn btn-primary" style="background-color: #007bff; border: none; padding: 8px 20px; font-size: 14px; border-radius: 4px;" onclick="openAddCompanyModal()">Add Customer</button>
			                </div>
		</div><!-- End Page Title -->

		<input type="hidden" id="roleValue" th:value="${session.role_name}">

		<section class="section dashboard">
			<div class="row">
				<div class="col-lg-12" id="holidayTable">
					
					<div class="row">
						<div class="col-lg-12">

							<!-- CRM Details Table -->
							            <div class="card">
							                <div class="card-body table-responsive" >
												<!-- Flex container with title and search input side by side -->
												<!-- Flex container with title and search input side by side -->
												<div class="d-flex justify-content-between align-items-center mb-3">
												    <h5 class="card-title mb-0">Customer Details</h5>
													<input type="text" id="crmSearchInput" class="form-control ms-3" style="max-width: 300px;" placeholder="Search..." onkeyup="filterCRMTable()">

											
													 	</div>
														<div class="table-responsive custom_table_div" style="max-height: 400px; overflow-y: auto;">
														    <table id="crmDetailsTable" class="table table-hover mb-0 text-center table-fixed-header">
														        <thead class="table-light" style="position: sticky; top: 0; z-index: 2;">
														            <tr>
														                <th scope="col">SL No</th>
														                <th scope="col">Company Name</th>
																		<th scope="col">GST Number</th>
																		<th scope="col">Contact Person</th>
														                <th scope="col">Contact Number</th>
														              
														                <th scope="col">Technology</th>
														                <th scope="col">Interested Level</th>
														                <th scope="col">Actions</th>
														            </tr>
														        </thead>
														        <tbody id="crmDetailsTBody">
														            <tr th:each="company, index : ${crmDetails}">
														                <td th:text="${index.index + 1}"></td>
														                <td th:text="${company.customerName}"></td>
																		<td th:text="${company.gstNumber}"></td>

																		<!-- Replace this line to show contact number from primary contact person -->
																		        <td th:text="${#lists.isEmpty(company.contactPersons) ? '' : company.contactPersons[0].contactPerson}"></td>
																		        
																		<td th:text="${#lists.isEmpty(company.contactPersons) ? '' : company.contactPersons[0].contactNumber}"></td>
																																			        
														               
																	      <td th:text="${company.technology}"></td>
														                <td th:text="${company.interestedLevel}"></td>
														                <td>
														                    <div class="d-flex justify-content-center gap-2">
														                        <button class="btn btn-sm" th:onclick="'editCompanynew(' + ${company.id} + ')'">üñäÔ∏è</button>
														                        <button class="btn btn-sm" th:onclick="'deleteCompany(' + ${company.id} + ', this)'">üóëÔ∏è</button>
														                        <button class="btn btn-sm" th:onclick="'viewCompanyDetails(' + ${company.id} + ')'">üëÅÔ∏è</button>
														                    </div>
														                </td>
														            </tr>
														        </tbody>
														    </table>
														</div>

							                </div>
							            </div>
						</div>
					</div>
				</div>




			</div><!-- End Left side columns -->

<script>
	
	function filterCRMTable() {
	    const input = document.getElementById('crmSearchInput');
	    const filter = input.value.toLowerCase();
	    const table = document.getElementById('crmDetailsTable');
	    const tbody = table.getElementsByTagName('tbody')[0];
	    const rows = tbody.getElementsByTagName('tr');

	    let visibleRowCount = 0;

	    for (let i = 0; i < rows.length; i++) {
	        const cells = rows[i].getElementsByTagName('td');
	        let matchFound = false;

	        for (let j = 0; j < cells.length; j++) {
	            const cellText = cells[j].textContent.toLowerCase();
	            if (cellText.includes(filter)) {
	                matchFound = true;
	                break;
	            }
	        }

	        if (matchFound) {
	            rows[i].style.display = '';
	            visibleRowCount++;
	        } else {
	            rows[i].style.display = 'none';
	        }
	    }

	    // Handle "No data found" row
	    let noDataRow = document.getElementById('noDataRow');

	    if (visibleRowCount === 0) {
	        if (!noDataRow) {
	            noDataRow = document.createElement('tr');
	            noDataRow.id = 'noDataRow';
	            const td = document.createElement('td');
	            td.colSpan = 8; // Adjust to match the number of columns
	            td.className = "text-center fw-bold text-muted";
	            td.textContent = 'No data found';
	            noDataRow.appendChild(td);
	            tbody.appendChild(noDataRow);
	        }
	    } else {
	        if (noDataRow) {
	            noDataRow.remove();
	        }
	    }
	}

	
	/*function editCompanynew(companyId) {
		  //  alert("hii");
		    fetch(`/crmget/${companyId}`)
		        .then(response => response.json())
		        .then(data => {
		            // Populate company details
		            document.getElementById("companyId").value = data.id;
		            document.getElementById("customerName1").value = data.customerName;
		            document.getElementById("contactNumber1").value = data.contactNumber;
		            document.getElementById("gstNumber1").value = data.gstNumber;
		            document.getElementById("lookingFor1").value = data.lookingFor;
		            document.getElementById("qty1").value = data.quantity;
		            document.getElementById("interestedLevel1").value = data.interestedLevel;
		            document.getElementById("referredBy1").value = data.referredBy;
		            document.getElementById("referredPhoneCompany1").value = data.referredPhoneCompany;
		            document.getElementById("moreInfo1").value = data.moreInfo;
		            document.getElementById("projectName1").value = data.projectName;
		            document.getElementById("productName1").value = data.productName;
		            document.getElementById("segment1").value = data.segment;
					document.getElementById("technology1").value = data.technology;
					document.getElementById("leadEmail1").value = data.leadEmail;
					document.getElementById("leadPhone1").value = data.leadCompany;
					//document.getElementById("designation1").value = data.designation;
					//document.getElementById("companyName1").value = data.companyName;
				 document.getElementById("companyAddress1").value = data.companyAddress;


				 // Populate contact persons dynamically (4 fields per row)
				 const contactPersonsContainer = document.getElementById("contactPersonsContainer");
				 contactPersonsContainer.innerHTML = "";  // Clear previous entries

				 if (data.contactPersons && data.contactPersons.length > 0) {
				     data.contactPersons.forEach((person, index) => {
				         const priorityClass = person.priority === 'Primary' ? 'bg-primary' : 'bg-secondary';
				         
				         const contactPersonRow = `
				             <div class="row contact-person-row mb-3 position-relative" 
				                  data-index="${index}" 
				                  draggable="true" 
				                  ondragstart="handleRowDragStart(event)"
				                  ondragover="handleRowDragOver(event)"
				                  ondrop="handleRowDrop(event)">
				                 <div class="col-md-3">
				                     <label>Contact Person:</label>
				                     <input type="text" class="form-control" value="${person.contactPerson}" data-contact-person-index="${index}">
				                 </div>
				                 <div class="col-md-3">
				                     <label>Contact Number:</label>
				                     <input type="text" class="form-control" value="${person.contactNumber}" data-contact-number-index="${index}">
				                 </div>
				                 <div class="col-md-3">
				                     <label>Email:</label>
				                     <input type="email" class="form-control" value="${person.email}" data-contact-email-index="${index}">
				                 </div>
				                 <div class="col-md-3 position-relative">
				                     <label>Designation:</label>
				                     <input type="text" class="form-control" value="${person.designation}" data-contact-designation-index="${index}">
				                     <span class="badge ${priorityClass}" 
				                         style="position: absolute; top: -5px; right: 10px; font-size: 12px;">
				                         ${person.priority}
				                     </span>
				                 </div>
				             </div>
				         `;
				         contactPersonsContainer.insertAdjacentHTML("beforeend", contactPersonRow);
				     });
				 }

		            // Open the modal
		            document.getElementById("updateCompanyModal").style.display = "block";
					// Load dropdown data for update modal dropdowns
					  loadDropdown1('technology', 'technology1');
					  loadDropdown1('segment', 'segment1');
					  loadDropdown1('looking_for', 'lookingFor1');

		        })
		        .catch(error => {
		            console.error('Error fetching company details:', error);
		            alert("Failed to load company details. Please try again.");
		        });
		}*/
		
		function editCompanynew(companyId) {
			    fetch(`/crmget/${companyId}`)
			        .then(response => response.json())
			        .then(data => {
			            // Populate company details
			            document.getElementById("companyId").value = data.id;
			            document.getElementById("customerName1").value = data.customerName;
			            document.getElementById("contactNumber1").value = data.contactNumber;
			            document.getElementById("gstNumber1").value = data.gstNumber;
			            document.getElementById("lookingFor1").value = data.lookingFor;
			            document.getElementById("qty1").value = data.quantity;
			            document.getElementById("interestedLevel1").value = data.interestedLevel;
			            document.getElementById("referredBy1").value = data.referredBy;
			            document.getElementById("referredPhoneCompany1").value = data.referredPhoneCompany;
			            document.getElementById("moreInfo1").value = data.moreInfo;
			            document.getElementById("projectName1").value = data.projectName;
			            document.getElementById("productName1").value = data.productName;
			            document.getElementById("segment1").value = data.segment;
			            document.getElementById("technology1").value = data.technology;
			            document.getElementById("leadEmail1").value = data.leadEmail;
			            document.getElementById("leadPhone1").value = data.leadCompany;
			            document.getElementById("companyAddress1").value = data.companyAddress;

			            // Populate contact persons
			            const contactPersonsContainer = document.getElementById("contactPersonsContainer");
			            contactPersonsContainer.innerHTML = "";

			            if (data.contactPersons && data.contactPersons.length > 0) {
			                data.contactPersons.forEach((person, index) => {
			                    const priorityClass = person.priority === 'Primary' ? 'bg-primary' : 'bg-secondary';
			                    const contactPersonRow = `
			                        <div class="row contact-person-row mb-3 position-relative">
			                            <div class="col-md-3">
			                                <label>Contact Person:</label>
			                                <input type="text" class="form-control" value="${person.contactPerson}">
			                            </div>
			                            <div class="col-md-3">
			                                <label>Contact Number:</label>
			                                <input type="text" class="form-control" value="${person.contactNumber}">
			                            </div>
			                            <div class="col-md-3">
			                                <label>Email:</label>
			                                <input type="email" class="form-control" value="${person.email}">
			                            </div>
			                            <div class="col-md-3 position-relative">
			                                <label>Designation:</label>
			                                <input type="text" class="form-control" value="${person.designation}">
			                                <span class="badge ${priorityClass}" 
			                                    style="position: absolute; top: -5px; right: 10px; font-size: 12px;">
			                                    ${person.priority}
			                                </span>
			                            </div>
			                        </div>`;
			                    contactPersonsContainer.insertAdjacentHTML("beforeend", contactPersonRow);
			                });
			            }

			            // Open modal
			            document.getElementById("updateCompanyModal").style.display = "block";

			            // Load dropdowns
			            loadDropdown1('technology', 'technology1');
			            loadDropdown1('segment', 'segment1');
			            loadDropdown1('looking_for', 'lookingFor1');

			            // === Enable Submit button only when fields change ===
			            const form = document.getElementById("addCompanyForm");
			            const submitBtn = form.querySelector("button[type='submit']");
			            submitBtn.disabled = true; // Disable initially

			            // Store initial values *AFTER* populating the form
			            const initialDataObj = {};
			            form.querySelectorAll("input, select, textarea").forEach(el => {
			                initialDataObj[el.id || el.name] = el.value;
			            });

			            function checkForChanges() {
			                let changed = false;
			                form.querySelectorAll("input, select, textarea").forEach(el => {
			                    const key = el.id || el.name;
			                    if (initialDataObj[key] !== el.value) {
			                        changed = true;
			                    }
			                });
			                submitBtn.disabled = !changed;
			            }

			            // Attach listeners
			            form.querySelectorAll("input, select, textarea").forEach(el => {
			                el.addEventListener("input", checkForChanges);
			                el.addEventListener("change", checkForChanges);
			            });
			        })
			        .catch(error => {
			            console.error("Error fetching company details:", error);
			            alert("Failed to load company details. Please try again.");
			        });
			}


		function addContactPersonRow1() {
		    const container = document.getElementById("contactPersonsContainer");
		    const index = container.children.length; // Next index
		    const newRow = createContactPersonRow(index);
		    container.insertAdjacentHTML("beforeend", newRow);
		}
		function createContactPersonRow(index, person = {}) {
		    const priorityClass = person.priority === 'Primary' ? 'bg-primary' : 'bg-secondary';
		    const contactPerson = person.contactPerson || '';
		    const contactNumber = person.contactNumber || '';
		    const email = person.email || '';
		    const designation = person.designation || '';
		    const priority = person.priority || 'Secondary';

		    return `
		        <div class="row contact-person-row mb-3 position-relative" 
		             data-index="${index}" 
		             draggable="true" 
		             ondragstart="handleRowDragStart(event)"
		             ondragover="handleRowDragOver(event)"
		             ondrop="handleRowDrop(event)">
		            <div class="col-md-3">
		                <label>Contact Person:</label>
		                <input type="text" class="form-control" value="${contactPerson}" data-contact-person-index="${index}">
		            </div>
		            <div class="col-md-3">
		                <label>Contact Number:</label>
		                <input type="text" class="form-control" value="${contactNumber}" data-contact-number-index="${index}">
		            </div>
		            <div class="col-md-3">
		                <label>Email:</label>
		                <input type="email" class="form-control" value="${email}" data-contact-email-index="${index}">
		            </div>
		            <div class="col-md-3 position-relative">
		                <label>Designation:</label>
		                <input type="text" class="form-control" value="${designation}" data-contact-designation-index="${index}">
		                <span class="badge ${priorityClass}" 
		                      style="position: absolute; top: -5px; right: 10px; font-size: 12px;">
		                    ${priority}
		                </span>
		            </div>
		        </div>
		    `;
		}

	 
	 function openAddCompanyModal() {
	 	    document.getElementById("addCompanyModal").style.display = "block";
			
			// Manually call loadDropdown functions (since 'shown.bs.modal' won't fire)
			        loadDropdown("technology", "technology");
			        loadDropdown("segment", "segment");
			        loadDropdown("looking_for", "lookingFor");
	 	}

	 	function closeAddCompanyModal() {
	 	    document.getElementById("addCompanyModal").style.display = "none";
	 	}
		
		function closeAddCompanyModalupdate() {
			 	    document.getElementById("updateCompanyModal").style.display = "none";
			 	}
	
				
				// Drag and drop handlers
				let draggedRow = null;

				function handleRowDragStart(event) {
				    draggedRow = event.currentTarget;
				    event.dataTransfer.setData("text/plain", draggedRow.dataset.index);
				    event.dataTransfer.effectAllowed = "move";
				}

				function handleRowDragOver(event) {
				    event.preventDefault();  // Allow drop
				}
				
				function handleRowDrop(event) {
				    event.preventDefault();
				    const targetRow = event.currentTarget;
				    const targetIndex = parseInt(targetRow.dataset.index);
				    const draggedIndex = parseInt(draggedRow.dataset.index);

				    if (targetIndex !== draggedIndex) {
				        // Swap the rows in the DOM (your existing code)
				        const container = document.getElementById("contactPersonsContainer");
				        const rows = Array.from(container.children);
				        if (draggedIndex < targetIndex) {
				            container.insertBefore(draggedRow, rows[targetIndex].nextSibling);
				        } else {
				            container.insertBefore(draggedRow, rows[targetIndex]);
				        }

				        // Update the data-index attributes for rows in the DOM
				        const updatedRows = Array.from(container.children);
				        updatedRows.forEach((row, i) => {
				            row.dataset.index = i;
				        });

				        // Swap the entries in your data.contactPersons array
				        const temp = data.contactPersons[draggedIndex];
				        data.contactPersons.splice(draggedIndex, 1);
				        data.contactPersons.splice(targetIndex, 0, temp);

				        // Now update the priority:
				        // Find current Primary index
				        const currentPrimaryIndex = data.contactPersons.findIndex(p => p.priority === 'Primary');
				        
				        // If the dragged person was Primary and moved, swap priority with the person at targetIndex
				        if (draggedIndex === currentPrimaryIndex) {
				            // Remove primary from dragged (now at targetIndex)
				            data.contactPersons[targetIndex].priority = 'Primary';

				            // Remove primary from old target position (if different)
				            if (targetIndex !== draggedIndex) {
				                // The person originally at targetIndex before swap is now shifted
				                // Since we already swapped, the old target person is at draggedIndex now
				                data.contactPersons[draggedIndex].priority = 'Secondary';
				            }
				        } else if (targetIndex === currentPrimaryIndex) {
				            // If dragged person is dropped on Primary person, swap priorities
				            data.contactPersons[targetIndex].priority = data.contactPersons[targetIndex].priority; // Primary remains
				            data.contactPersons[draggedIndex].priority = 'Secondary';
				        }
				        
				        // Re-render the contact persons rows to update the UI badges and indexes
				        renderContactPersons();
				    }

				    draggedRow = null;
				}

					
	</script>
		
			<!-- Add Company Modal -->
		<!--	<div id="addCompanyModal" class="modal" tabindex="-1" style="display: none;">
				
			    <div class="modal-dialog modal-lg">
			        <div class="modal-content">
			            <div class="modal-header">
			                <h5 class="modal-title">Add Customer</h5>
			                <button type="button" class="btn-close" onclick="closeAddCompanyModal()"></button>
			            </div>
			            <div class="modal-body">
			                <form id="addCompanyForm" onsubmit="submitCompanyForm(event)">
								<input type="hidden" id="companyId" />
			                    <div class="row">
			                        <div class="col-md-4 mb-3">
			                            <label for="customerName">Customer Name</label>
			                            <input type="text" id="customerName" class="form-control" required>
			                        </div>
			                        <div class="col-md-4 mb-3">
			                            <label for="contactNumber">Contact Number</label>
			                            <input type="text" id="contactNumber" class="form-control" required>
			                        </div>
			                        <div class="col-md-4 mb-3">
			                            <label for="emailId">Email ID</label>
			                            <input type="email" id="emailId" class="form-control" required>
			                        </div>
			                    </div>
			                    <div class="row">
			                        <div class="col-md-4 mb-3">
			                            <label for="companyName">Company Name</label>
			                            <input type="text" id="companyName" class="form-control"  required>
			                        </div>
			                        <div class="col-md-4 mb-3">
			                            <label for="companyAddress">Company Address</label>
			                            <textarea id="companyAddress" class="form-control" rows="3" ></textarea>
			                        </div>
									<div class="col-md-4 mb-3">
									    <label for="technology">C.Segment / Technology</label>
									    <select id="technology" class="form-control" required>
									        <option value="" disabled selected>Select Technology</option>
									        <option value="test1">Test1</option>
									        <option value="test2">Test2</option>
									        <option value="test3">Test3</option>
									        <option value="test4">Test4</option>
									        <option value="test5">Test5</option>
									    </select>
									</div>

			                    </div>
								<div class="row">
								                      <div class="col-md-4 mb-3">
								                          <label for="contactPerson">Contact Person</label>
								                          <input type="text" id="contactPerson" class="form-control">
								                      </div>
								                      <div class="col-md-4 mb-3">
								                          <label for="designation">Designation</label>
								                          <input type="text" id="designation" class="form-control">
								                      </div>
								                      <div class="col-md-4 mb-3">
								                          <label for="domain">Domain</label>
								                          <input type="text" id="domain" class="form-control">
								                      </div>
								                  </div>
			                    <div class="row">
									<div class="col-md-4 mb-3">
									    <label for="lookingFor">Looking For</label>
									    <select id="lookingFor" class="form-control" required>
									        <option value="" disabled selected>Select Looking For</option>
									        <option value="wifi">WiFi</option>
									        <option value="rf">RF</option>
									        <option value="ble">BLE</option>
									        <option value="cluster">Cluster</option>
									        <option value="testing">Testing</option>
									    </select>
									</div>

			                        <div class="col-md-4 mb-3">
			                            <label for="whichMc">Which MC</label>
			                            <input type="text" id="whichMc" class="form-control" >
			                        </div>
			                        <div class="col-md-4 mb-3">
			                            <label for="qty">Quantity (Qty)</label>
			                            <input type="number" id="qty" class="form-control" >
			                        </div>
			                    </div>
			                    <div class="row">
									<div class="col-md-4 mb-3">
									    <label for="interestedLevel">Interested Level</label>
									    <select id="interestedLevel" class="form-control" >
									        <option value="" disabled selected>Select Interested Level</option>
									        <option value="hot">Hot</option>
									        <option value="warm">Warm</option>
									        <option value="cold">Cold</option>
									    </select>
									</div>

			                        <div class="col-md-4 mb-3">
			                            <label for="referredBy">Referred By</label>
			                            <input type="text" id="referredBy" class="form-control">
			                        </div>
			                        <div class="col-md-4 mb-3">
			                            <label for="referredPhoneCompany">Referred Phone/Company</label>
			                            <input type="text" id="referredPhoneCompany" class="form-control">
			                        </div>
			                    </div>
			                    <div class="row">
			                        <div class="col-md-12 mb-3">
			                            <label for="moreInfo">More Info</label>
			                            <textarea id="moreInfo" class="form-control" rows="4"></textarea>
			                        </div>
			                    </div>
			                    <div class="text-center">
			                        <button type="submit" class="btn btn-primary">Submit</button>
			                    </div>
			                </form>
			            </div>
			        </div>
			    </div>
			</div>-->
			<!-- Add Company Modal -->
			<div id="addCompanyModal" class="modal" tabindex="-1" style="display: none;">
			    <div class="modal-dialog modal-lg">
			        <div class="modal-content">
			            <div class="modal-header">
			                <h5 class="modal-title" style="font-weight: 700; color: #007bff;">Add Company</h5>
			                <button type="button" class="btn-close" onclick="closeAddCompanyModal()"></button>
			            </div>
			            <div class="modal-body">
			                <form id="addCompanyForm1" onsubmit="submitCompanyForm(event)">
			                    <input type="hidden" id="companyId" />
			                    
			                    <!-- Customer Info Section -->
			                    <h5 class="mb-3" style="font-size: 16px; font-weight: 600; color: black;">Customer Info</h5>
			                    <div class="row mb-4">
			                        <div class="col-md-3">
			                            <label for="customerName">Company Name <span style="color: red;">*</span></label>
			                            <input type="text" id="customerName" class="form-control" required>
										        </div>
			                        <div class="col-md-3">
			                            <label for="contactNumber">Company Contact </label>
			                            <input type="text" id="contactNumber" class="form-control">
			                        </div>
			                        <div class="col-md-3">
			                            <label for="gstNumber">GST Number</label>
			                            <input type="text" id="gstNumber" class="form-control" >
			                        </div>
			                        <div class="col-md-3">
			                            <label for="companyAddress">Company Address</label>
			                            <textarea id="companyAddress" class="form-control" rows="3" ></textarea>
			                        </div>
			                    </div>
			                    
			                    <!-- Contact Person Section -->
			                    <div id="contactPersons">
			                        <div class="row mb-3 contact-person-row">
			                            <div class="col-md-3">
			                                <label>Contact Person </label>
			                                <input type="text" class="form-control" placeholder="Name" >
			                            </div>
			                            <div class="col-md-3 ">
			                                <label>Contact Number</label>
			                                <input type="text" class="form-control" placeholder="Contact Number">
			                            </div>
			                            <div class="col-md-3">
			                                <label>Email </label>
			                                <input type="email" class="form-control" placeholder="Email" >
			                            </div>
			                            <div class="col-md-3 position-relative">
			                                <label>Designation</label>
			                                <input type="text" class="form-control" placeholder="Designation" >
			                                <span class="badge bg-primary" draggable="true" ondragstart="handleBadgeDragStart(event)" ondragover="handleBadgeDragOver(event)" ondrop="handleBadgeDrop(event)" style="position: absolute; top: -5px; right: 10px; font-size: 12px;">Primary</span>
			                            </div>
			                        </div>
			                    </div>
			                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" style="font-weight: 900;" onclick="addContactPersonRow()">+ Add Another Contact Person</button>
			                    
			                    <!-- Lead Info Section -->
			                    <h5 class="mb-3" style="font-size: 16px; font-weight: 600; color: black;">Lead Info</h5>
			                    <div class="row mb-4">
			                        <div class="col-md-3 mb-3">
			                            <label for="referredBy">Lead Given By</label>
			                            <input type="text" id="referredBy" class="form-control">
			                        </div>
			                        <div class="col-md-3 mb-3">
			                            <label for="leadCompany">Lead Given Company</label>
			                            <input type="text" id="leadCompany" class="form-control">
			                        </div>
			                        <div class="col-md-3 mb-3">
			                            <label for="referredPhoneCompany">Lead Given Phone</label>
			                            <input type="text" id="referredPhoneCompany" class="form-control">
			                        </div>
			                        <div class="col-md-3 mb-3">
			                            <label for="leadEmail">Lead Given Email</label>
			                            <input type="email" id="leadEmail" class="form-control">
			                        </div>
			                    </div>
			                    
			                    <!-- Project Info Section -->
			                    <h5 class="mb-3" style="font-size: 16px; font-weight: 600; color: black;">Project Info</h5>
			                    <div class="row mb-4">
			                        <div class="col-md-3 mb-3">
			                            <label for="projectName">Project Name</label>
			                            <input type="text" id="projectName" class="form-control">
			                        </div>
			                        <div class="col-md-3 mb-3">
			                            <label for="productName">Product Name</label>
			                            <input type="text" id="productName" class="form-control">
			                        </div>
									

			                        <div class="col-md-3 mb-3">
			                            <label for="segment">Segment</label>
			                           <!-- <input type="text" id="segment" class="form-control">-->
									   <select id="segment" class="form-control" name="segment" onchange="checkAddOption(this, 'segment')" required>
									                             <!-- Options will be loaded dynamically -->
									                         </select>
			                        </div>
			                       <div class="col-md-3 mb-3">
			                            <label for="technology">Technology</label>
			                            <!-- <select id="technology" class="form-control" >
			                                <option value="" disabled selected>Select Technology</option>
			                                <option value="test1">Test1</option>
			                                <option value="test2">Test2</option>
			                                <option value="test3">Test3</option>
			                                <option value="test4">Test4</option>
			                                <option value="test5">Test5</option>
			                            </select>-->
										<select id="technology" class="form-control" onchange="checkAddOption(this, 'technology')">
										   <!-- Options will be populated dynamically -->
										</select>

			                        </div>
									
			                        <div class="col-md-3 mb-3">
			                            <label for="interestedLevel">Interested Level</label>
			                            <select id="interestedLevel" class="form-control" >
			                                <option value="" disabled selected>Select Interested Level</option>
			                                <option value="hot">Hot</option>
			                                <option value="warm">Warm</option>
			                                <option value="cold">Cold</option>
			                                <option value="closed">Closed</option>
			                            </select>
										
			                        </div>
			                        <div class="col-md-4 mb-3">
			                            <label for="lookingFor">Looking For</label>
			                        <!--    <select id="lookingFor" class="form-control" >
			                                <option value="" disabled selected>Select Looking For</option>
			                                <option value="wifi">WiFi</option>
			                                <option value="rf">RF</option>
			                                <option value="ble">BLE</option>
			                                <option value="cluster">Cluster</option>
			                                <option value="testing">Testing</option>
			                            </select>-->
										<select id="lookingFor" class="form-control" name="lookingFor" onchange="checkAddOption(this, 'looking_for')" required>
																				                          <!-- Options will be loaded dynamically -->
																				                      </select>
			                        </div>
			                        <div class="col-md-3 mb-3">
			                            <label for="qty">Quantity (Qty)</label>
			                            <input type="number" id="qty" class="form-control" >
			                        </div>
			                    </div>
			                    <div class="row">
			                        <div class="col-md-12 mb-3">
			                            <label for="moreInfo">Additional Info</label>
			                            <textarea id="moreInfo" class="form-control" rows="4"></textarea>
			                        </div>
			                    </div>
			                    <div class="text-center mt-4">
			                        <button type="submit" class="btn btn-primary" style="background-color: #007bff;">Submit</button>
			                    </div>
			                </form>
			            </div>
			        </div>
			    </div>
			</div>
			
			<!-- Compact Small Modal -->
			<div class="modal fade" id="addDropdownModal" tabindex="-1" aria-labelledby="addDropdownModalLabel" aria-hidden="true">
			  <div class="modal-dialog modal-sm">
			    <div class="modal-content">
			      <form id="addDropdownForm">
			        <div class="modal-header">
			          <h5 class="modal-title text-primary" id="addDropdownModalLabel">Add New Value</h5>
			          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			        </div>
			        <div class="modal-body">
			          <input type="hidden" id="dropdownType">
			          <input type="hidden" id="dropdownId">
			          <div class="mb-2">
			            <label for="newDropdownValue" class="form-label" id="dropdownLabel"></label>
			            <input type="text" class="form-control" id="newDropdownValue" placeholder="Enter value" required>
			          </div>
			        </div>
			        <div class="modal-footer">
			          <button type="submit" class="btn btn-sm " style="background-color: #0d6efd; color: white;">Add</button>
			          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
			        </div>
			      </form>
			    </div>
			  </div>
			</div>

			<!-- Compact Small Modal -->
						<div class="modal fade" id="addDropdownModal1" tabindex="-1" aria-labelledby="addDropdownModalLabel" aria-hidden="true">
						  <div class="modal-dialog modal-sm">
						    <div class="modal-content">
						      <form id="addDropdownForm1">
						        <div class="modal-header">
						          <h5 class="modal-title text-primary" id="addDropdownModalLabel">Add New Value</h5>
						          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						        </div>
						        <div class="modal-body">
						          <input type="hidden" id="dropdownType1">
						          <input type="hidden" id="dropdownId1">
						          <div class="mb-2">
						            <label for="newDropdownValue1" class="form-label" id="dropdownLabel1"></label>
						            <input type="text" class="form-control" id="newDropdownValue1" placeholder="Enter value" required>
						          </div>
						        </div>
						        <div class="modal-footer">
						          <button type="submit" class="btn btn-sm " style="background-color: #0d6efd; color: white;">Add</button>
						          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
						        </div>
						      </form>
						    </div>
						  </div>
						</div>

<script>

// Load dropdown data from backend
function loadDropdown(type, dropdownId) {
    fetch(`/api/dropdown/${type}`)
        .then(response => response.json())
        .then(data => {
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = `<option  value="" disabled selected>Select ${type.replace('_', ' ')}</option>`;

            if (data.length === 0) {
                dropdown.innerHTML += `<option value="add_new">Add New</option>`;
            } else {
                data.forEach(value => {
                    dropdown.innerHTML += `<option value="${value}">${value}</option>`;
                });
                dropdown.innerHTML += `<option value="add_new">Add New</option>`;
            }
        })
        .catch(error => {
            console.error("Error loading dropdown:", error);
        });
}

// Handle "Add New" option with modal
function checkAddOption(selectElement, type) {
    if (selectElement.value === 'add_new') {
        document.getElementById('dropdownType').value = type;
        document.getElementById('dropdownId').value = selectElement.id;
        document.getElementById('newDropdownValue').value = '';
        document.getElementById('dropdownLabel').textContent = `Enter new ${type.replace('_', ' ')} value:`;
        const modal = new bootstrap.Modal(document.getElementById('addDropdownModal'));
        modal.show();
    }
}

// Submit new value from modal
document.getElementById('addDropdownForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const type = document.getElementById('dropdownType').value;
    const value = document.getElementById('newDropdownValue').value.trim();
    const dropdownId = document.getElementById('dropdownId').value;

    if (value !== '') {
        fetch(`/api/dropdown/add?type=${type}&value=${encodeURIComponent(value)}`, {
            method: 'POST'
        }).then(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDropdownModal'));
            modal.hide();
            loadDropdown(type, dropdownId);
        });
    }
});

	   // Submit form to save company
	   document.getElementById('addCompanyForm').addEventListener('submit', function (e) {
	       e.preventDefault();

	       const data = {
	           technology: document.getElementById('technology').value,
	           segment: document.getElementById('segment').value,
	           lookingFor: document.getElementById('lookingFor').value
	       };

	       fetch('/api/company/add', {
	           method: 'POST',
	           headers: { 'Content-Type': 'application/json' },
	           body: JSON.stringify(data)
	       })
	       .then(res => {
	           if (res.ok) {
	               alert("Company added successfully!");
	               $('#addCompanyModal').modal('hide'); // If using jQuery for outer modal
	               this.reset();
	           } else {
	               alert("Error saving company.");
	           }
	       });
	   });

			</script>
			<script>
				let existingCompanyProjectProductCombos = [];

				async function loadCompanies() {
				  try {
				    const response = await fetch('/fetchCrmDetailserror');
				    if (!response.ok) {
				      throw new Error('Failed to fetch companies');
				    }
				    const data = await response.json();

				    // Create combo keys: companyName|projectName|productName
				    existingCompanyProjectProductCombos = data.map(item => {
				      const company = (item.customerName || '').toLowerCase().trim();
				      const project = (item.projectName || '').toLowerCase().trim();
				      const product = (item.productName || '').toLowerCase().trim();
				      return `${company}|${project}|${product}`;
				    });

				  } catch (error) {
				    console.error('Error loading companies:', error);
				  }
				}

				function validateInputs() {
				  const companyInput = document.getElementById('customerName').value.trim().toLowerCase();
				  const projectInput = document.getElementById('projectName').value.trim().toLowerCase();
				  const productInput = document.getElementById('productName').value.trim().toLowerCase();

				  const submitBtn = document.querySelector('#addCompanyForm1 button[type="submit"]');

				  if (!companyInput || !projectInput || !productInput) {
				    submitBtn.disabled = false;
				    return;
				  }

				  const combinedKey = `${companyInput}|${projectInput}|${productInput}`;
				  if (existingCompanyProjectProductCombos.includes(combinedKey)) {
				    submitBtn.disabled = true;

				    // Capitalize for display
				    const companyDisplay = companyInput.charAt(0).toUpperCase() + companyInput.slice(1);
				    const projectDisplay = projectInput.charAt(0).toUpperCase() + projectInput.slice(1);
				    const productDisplay = productInput.charAt(0).toUpperCase() + productInput.slice(1);

					Swal.fire({
					  title: 'Duplicate Entry',
					  html: `
					    <strong>Company:</strong> ${companyDisplay}<br>
					    <strong>Project:</strong> ${projectDisplay}<br>
					    <strong>Product:</strong> ${productDisplay}
					  `,
					  icon: 'error',
					  confirmButtonText: 'OK',
					  customClass: {
					    popup: 'swal22-custom-z'
					  }
					});


				  } else {
				    submitBtn.disabled = false;
				  }
				}


				// Attach events on DOM ready
				document.addEventListener('DOMContentLoaded', () => {
				  loadCompanies();

				  document.getElementById('customerName').addEventListener('input', validateInputs);
				  document.getElementById('projectName').addEventListener('input', validateInputs);
				  document.getElementById('productName').addEventListener('input', validateInputs);
				});

			</script>

<script>
	


	function handleBadgeDrop(e) {
	    e.preventDefault();

	    // Find the actual row the badge was dropped onto
	    let targetRow = e.target;
	    while (targetRow && !targetRow.classList.contains('contact-person-row')) {
	        targetRow = targetRow.parentElement;
	    }

	    if (draggedRow && targetRow && draggedRow !== targetRow) {
	        const contactSection = document.getElementById('contactPersons');

	        // Move the dragged row before or after the target row as needed
	        if (targetRow.nextSibling === draggedRow) {
	            contactSection.insertBefore(draggedRow, targetRow);
	        } else {
	            contactSection.insertBefore(draggedRow, targetRow.nextSibling);
	        }

	        // Swap primary and secondary badges
	        const draggedBadge = draggedRow.querySelector('.badge');
	        const targetBadge = targetRow.querySelector('.badge');

	        if (draggedBadge && targetBadge) {
	            const isDraggedPrimary = draggedBadge.classList.contains('bg-primary');
	            const isTargetPrimary = targetBadge.classList.contains('bg-primary');

	            if (isDraggedPrimary) {
	                // Make the target primary
	                draggedBadge.textContent = 'Secondary';
	                draggedBadge.classList.remove('bg-primary');
	                draggedBadge.classList.add('bg-secondary');
	                
	                targetBadge.textContent = 'Primary';
	                targetBadge.classList.remove('bg-secondary');
	                targetBadge.classList.add('bg-primary');
	            } else if (isTargetPrimary) {
	                // Make the dragged row primary
	                targetBadge.textContent = 'Secondary';
	                targetBadge.classList.remove('bg-primary');
	                targetBadge.classList.add('bg-secondary');
	                
	                draggedBadge.textContent = 'Primary';
	                draggedBadge.classList.remove('bg-secondary');
	                draggedBadge.classList.add('bg-primary');
	            }
	        }
	    }

	    if (draggedRow) {
	        draggedRow.style.opacity = 1;
	    }
	    draggedRow = null;
	}
	
	function handleBadgeDragStart(e) {
		      draggedRow = e.target.closest('.contact-person-row');
		      e.dataTransfer.effectAllowed = 'move';
		      draggedRow.style.opacity = 0.5;
		  }

	function handleBadgeDragOver(e) {
		      e.preventDefault(); // Allow drop
		      e.dataTransfer.dropEffect = 'move';
		  }
	function removeContactPerson(button) {
			    const row = button.closest('.contact-person-row');
			    if (row) {
			        row.remove();
			        updateContactBadges();

			        // Show add button if row count is less than 5
			        const contactSection = document.getElementById('contactPersons');
			        if (contactSection.querySelectorAll('.contact-person-row').length < 5) {
			            document.getElementById('addContactButton').style.display = 'block';
			        }
			    }
			}

	function addContactPersonRow() {
			    const contactSection = document.getElementById('contactPersons');
			    const currentRowCount = contactSection.querySelectorAll('.contact-person-row').length;

			    // Restrict to 5 rows
			    if (currentRowCount >= 5) {
			        alert("You can only add up to 5 contact persons.");
			        return;
			    }

			    const newRow = document.createElement('div');
			    newRow.classList.add('row', 'mb-3', 'contact-person-row');
			    newRow.innerHTML = `
			        <div class="col-md-3">
			            <label>Contact Person</label>
			            <input type="text" class="form-control" placeholder="Name" required>
			        </div>
			        <div class="col-md-3">
			            <label>Contact Number</label>
			            <input type="text" class="form-control" placeholder="Contact Number" required>
			        </div>
			        <div class="col-md-3">
			            <label>Email</label>
			            <input type="email" class="form-control" placeholder="Email" required>
			        </div>
			        <div class="col-md-3 position-relative">
			            <label>Designation</label>
			            <input type="text" class="form-control" placeholder="Designation" required>
			            <span class="badge bg-secondary" draggable="true" 
			                ondragstart="handleBadgeDragStart(event)" 
			                ondragover="handleBadgeDragOver(event)" 
			                ondrop="handleBadgeDrop(event)" 
			                style="position: absolute; top: -5px; right: 10px; font-size: 12px;">
			                Secondary
			            </span>
			            <button type="button" class="btn-close remove-contact" 
			                onclick="removeContactPerson(this)" 
			                style="position: absolute; top: 5px; right: -10px;"></button>
			        </div>`;

			    contactSection.appendChild(newRow);
			    updateContactBadges();

			    // Hide add button if 5 rows are added
			    if (contactSection.querySelectorAll('.contact-person-row').length >= 5) {
			        document.getElementById('addContactButton').style.display = 'none';
			    }
			}

	function submitCompanyForm(event) {
			
		       event.preventDefault();

		       const companyDetails = {
		           customerName: document.getElementById("customerName").value,
		           contactNumber: document.getElementById("contactNumber").value,
		           gstNumber: document.getElementById("gstNumber").value,
		          // companyName: document.getElementById("companyName").value,
		           companyAddress: document.getElementById("companyAddress").value,
		           technology: document.getElementById("technology").value,
		           lookingFor: document.getElementById("lookingFor").value,
		           //whichMc: document.getElementById("whichMc").value,
		           quantity: document.getElementById("qty").value,
		           interestedLevel: document.getElementById("interestedLevel").value,
		           referredBy: document.getElementById("referredBy").value,
		           referredPhoneCompany: document.getElementById("referredPhoneCompany").value,
		           moreInfo: document.getElementById("moreInfo").value,
				 //  contactPerson: document.getElementById("contactPerson").value,
				     //     designation: document.getElementById("designation").value,
				      //    domain: document.getElementById("domain").value,
						  leadCompany: document.getElementById("leadCompany").value,
						     leadEmail: document.getElementById("leadEmail").value,
						     projectName: document.getElementById("projectName").value,
						     productName: document.getElementById("productName").value,
						     segment: document.getElementById("segment").value,
							 contactPersons: [] // Initialize the array here
		       };
			  
			   
			   const contactRows = document.querySelectorAll('.contact-person-row');
			   contactRows.forEach(row => {
			       const person = row.querySelector("input[placeholder='Name']").value;
			       const number = row.querySelector("input[placeholder='Contact Number']").value;
			       const email = row.querySelector("input[placeholder='Email']").value;
			       const designation = row.querySelector("input[placeholder='Designation']").value;

			       // Extract the badge text ("Primary", or whatever is inside the span)
			       const badgeElement = row.querySelector(".badge");
			       const priority = badgeElement ? badgeElement.textContent.trim() : null;

			       companyDetails.contactPersons.push({
			           contactPerson: person,
			           contactNumber: number,
			           email: email,
			           designation: designation,
			           priority: priority
			       });
			   });


			      // Alert the details before sending
			      console.log("Submitting company details:\n" + JSON.stringify(companyDetails, null, 2));

		       fetch("/crmadd", {
		           method: "POST",
		           headers: {
		               "Content-Type": "application/json"
		           },
		           body: JSON.stringify(companyDetails)
		       })
		       .then(response => response.json())
		       .then(data => {
		           alert("Company details added successfully!");
		           document.getElementById("addCompanyForm1").reset();
		           closeAddCompanyModal();
		       })
		       .catch(error => {
		           console.error("Error:", error);
		           alert("Error adding company details. Please try again.");
		       });
		   }
	</script>
	


			<!--update Company Modal -->
					<!--	<div id="updateCompanyModal" class="modal" tabindex="-1" style="display: none;">
							
						    <div class="modal-dialog modal-lg">
						        <div class="modal-content">
						            <div class="modal-header">
						                <h5 class="modal-title">Update Company details</h5>
						                <button type="button" class="btn-close" onclick="closeAddCompanyModalupdate()"></button>
						            </div>
						            <div class="modal-body">
						                <form id="addCompanyForm" onsubmit="submitCompanyFormupdate(event)">
											<input type="hidden" id="companyId" />
						                    <div class="row">
						                        <div class="col-md-4 mb-3">
						                            <label for="customerName1">Customer Name</label>
						                            <input type="text" id="customerName1" class="form-control" required>
						                        </div>
						                        <div class="col-md-4 mb-3">
						                            <label for="contactNumber1">Contact Number</label>
						                            <input type="text" id="contactNumber1" class="form-control" required>
						                        </div>
						                        <div class="col-md-4 mb-3">
						                            <label for="emailId1">Email ID</label>
						                            <input type="email" id="emailId1" class="form-control" required>
						                        </div>
						                    </div>
						                    <div class="row">
						                        <div class="col-md-4 mb-3">
						                            <label for="companyName1">Company Name</label>
						                            <input type="text" id="companyName1" class="form-control" >
						                        </div>
						                        <div class="col-md-4 mb-3">
						                            <label for="companyAddress1">Company Address</label>
						                            <textarea id="companyAddress1" class="form-control" rows="3" ></textarea>
						                        </div>
												<div class="col-md-4 mb-3">
												    <label for="technology1">C.Segment / Technology</label>
												    <select id="technology1" class="form-control" required>
												        <option value="" disabled selected>Select Technology</option>
												        <option value="test1">Test1</option>
												        <option value="test2">Test2</option>
												        <option value="test3">Test3</option>
												        <option value="test4">Test4</option>
												        <option value="test5">Test5</option>
												    </select>
												</div>

						                    </div>
										
											                  <div class="row">
											                      <div class="col-md-4 mb-3">
											                          <label for="contactPerson1">Contact Person</label>
											                          <input type="text" id="contactPerson1" class="form-control">
											                      </div>
											                      <div class="col-md-4 mb-3">
											                          <label for="designation1">Designation</label>
											                          <input type="text" id="designation1" class="form-control">
											                      </div>
											                      <div class="col-md-4 mb-3">
											                          <label for="domain1">Domain</label>
											                          <input type="text" id="domain1" class="form-control">
											                      </div>
											                  </div>
						                    <div class="row">
												<div class="col-md-4 mb-3">
												    <label for="lookingFor1">Looking For</label>
												    <select id="lookingFor1" class="form-control" required>
												        <option value="" disabled selected>Select Looking For</option>
												        <option value="wifi">WiFi</option>
												        <option value="rf">RF</option>
												        <option value="ble">BLE</option>
												        <option value="cluster">Cluster</option>
												        <option value="testing">Testing</option>
												    </select>
												</div>

						                        <div class="col-md-4 mb-3">
						                            <label for="whichMc1">Which MC</label>
						                            <input type="text" id="whichMc1" class="form-control" >
						                        </div>
						                        <div class="col-md-4 mb-3">
						                            <label for="qty1">Quantity (Qty)</label>
						                            <input type="number" id="qty1" class="form-control" >
						                        </div>
						                    </div>
						                    <div class="row">
												<div class="col-md-4 mb-3">
												    <label for="interestedLevel1">Interested Level</label>
												    <select id="interestedLevel1" class="form-control" >
												        <option value="" disabled selected>Select Interested Level</option>
												        <option value="hot">Hot</option>
												        <option value="warm">Warm</option>
												        <option value="cold">Cold</option>
												    </select>
												</div>

						                        <div class="col-md-4 mb-3">
						                            <label for="referredBy1">Referred By</label>
						                            <input type="text" id="referredBy1" class="form-control">
						                        </div>
						                        <div class="col-md-4 mb-3">
						                            <label for="referredPhoneCompany1">Referred Phone/Company</label>
						                            <input type="text" id="referredPhoneCompany1" class="form-control">
						                        </div>
						                    </div>
						                    <div class="row">
						                        <div class="col-md-12 mb-3">
						                            <label for="moreInfo1">More Info</label>
						                            <textarea id="moreInfo1" class="form-control" rows="4"></textarea>
						                        </div>
						                    </div>
						                    <div class="text-center">
						                        <button type="submit" class="btn btn-primary">Submit</button>
						                    </div>
						                </form>
						            </div>
						        </div>
						    </div>
						</div>-->
						
						<!-- Update Company Modal -->
												<div id="updateCompanyModal" class="modal" tabindex="-1" style="display: none;">
												    <div class="modal-dialog modal-lg">
												        <div class="modal-content">
												            <div class="modal-header">
												                <h5 class="modal-title" style="font-weight: 700;color: #007bff;" >Update Company Details</h5>
												                <button type="button" class="btn-close" onclick="closeAddCompanyModalupdate()"></button>
												            </div>
												            <div class="modal-body">
												                <form id="addCompanyForm" onsubmit="submitCompanyFormupdate(event)">
												                    <input type="hidden" id="companyId" />

												                    <!-- Customer Details -->
												                    <div class="col-md-12 mb-3">
												                        <h5 style="color: black;"><b>Customer Details</b></h5>
												                    </div>
												                    <div class="row">
												                        <div class="col-md-3 mb-3">
												                            <label for="customerName1">Company Name</label>
												                            <input type="text" id="customerName1" class="form-control" required>
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="contactNumber1">Company Contact</label>
												                            <input type="text" id="contactNumber1" class="form-control" required>
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="gstNumber1">GST Number</label>
												                            <input type="text" id="gstNumber1" class="form-control" >
												                        </div>
												                        <div class="col-md-3 mb-3" >
												                            <label for="companyAddress1">Company Address</label>
												                            <input type="text" id="companyAddress1" class="form-control">
												                        </div>
																		<!--<div class="col-md-3 mb-3" style="display: none;">
																		       <label for="companyName1">Company Name</label>
																		       <input type="text" id="companyName1" class="form-control">
																		   </div>
																		   <div class="col-md-3 mb-3" style="display: none;">
																		       <label for="companyAddress1">Company Address</label>
																		       <input type="text" id="companyAddress1" class="form-control">
																		   </div>-->
												                    </div>

												                    <!-- Contact Persons -->
												                    <div class="col-md-12 mb-3">
												                        <h5 style="color: black;"><b>Contact Persons</b></h5>
												                    </div>
												                    <div id="contactPersonsContainer" class="mb-3 "></div>
																	<!-- Add Contact Person Button -->
																	<button type="button" class="btn btn-sm btn-outline-primary mb-3" style="font-weight: 900;" onclick="addContactPersonRow1()">+ Add Another Contact Person</button>
												                    <!-- Lead Info -->
												                    <div class="col-md-12 mb-3">
												                        <h5 style="color: black;"><b>Lead Info</b></h5>
												                    </div>
												                    <div class="row">
												                        <div class="col-md-3 mb-3">
												                            <label for="referredBy1">Lead Given By</label>
												                            <input type="text" id="referredBy1" class="form-control">
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="referredPhoneCompany1">Lead Given Phone</label>
												                            <input type="text" id="referredPhoneCompany1" class="form-control">
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="leadEmail1">Lead Given Email</label>
												                            <input type="email" id="leadEmail1" class="form-control">
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="leadPhone1">Lead Given Company</label>
												                            <input type="text" id="leadPhone1" class="form-control">
												                        </div>
												                    </div>

												                    <!-- Project Info -->
												                    <div class="col-md-12 mb-3">
												                        <h5 style="color: black;"><b>Project Info</b></h5>
												                    </div>
												                    <div class="row">
												                        <div class="col-md-3 mb-3">
												                            <label for="projectName1">Project Name</label>
												                            <input type="text" id="projectName1" class="form-control">
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="productName1">Product Name</label>
												                            <input type="text" id="productName1" class="form-control">
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="segment1">Segment</label>
												                           <!-- <input type="text" id="segment1" class="form-control">-->
																		   <select id="segment1" class="form-control" onchange="checkAddOption1(this, 'segment')">
																		       <!-- options will be loaded dynamically -->
																		   </select>
												                        </div>
																		<div class="col-md-3 mb-3">
																		    <label for="technology1">Technology </label>
																		   <!-- <select id="technology1" class="form-control" >
																		        <option value="" disabled selected>Select Technology</option>
																		        <option value="test1">Test1</option>
																		        <option value="test2">Test2</option>
																		        <option value="test3">Test3</option>
																		        <option value="test4">Test4</option>
																		        <option value="test5">Test5</option>
																		    </select>-->
																			<select id="technology1" class="form-control" onchange="checkAddOption1(this, 'technology')">
																			    <!-- options will be loaded dynamically -->
																			</select>
																		</div>

																		
												                        <div class="col-md-3 mb-3">
												                            <label for="interestedLevel1">Interested Level</label>
												                            <select id="interestedLevel1" class="form-control">
												                                <option value="" disabled selected>Select Interested Level</option>
												                                <option value="hot">Hot</option>
												                                <option value="warm">Warm</option>
												                                <option value="cold">Cold</option>
												                            </select>
												                        </div>
												                        <div class="col-md-3 mb-3">
												                            <label for="lookingFor1">Looking For</label>
												                        <!--    <select id="lookingFor1" class="form-control" >
												                                <option value="" disabled selected>Select Looking For</option>
												                                <option value="wifi">WiFi</option>
												                                <option value="rf">RF</option>
												                                <option value="ble">BLE</option>
												                                <option value="cluster">Cluster</option>
												                                <option value="testing">Testing</option>
												                            </select>-->
																			<select id="lookingFor1" class="form-control" onchange="checkAddOption1(this, 'looking_for')">
																			    <!-- options will be loaded dynamically -->
																			</select>
												                        </div>
																		<div class="col-md-3 mb-3">
																													                            <label for="qty1">Quantity (Qty)</label>
																													                            <input type="number" id="qty1" class="form-control">
																													                        </div>
												                    </div>

												                    <!-- Additional Info -->
												                    <div class="row">
												                        <div class="col-md-12 mb-3">
												                            <label for="moreInfo1">More Info</label>
												                            <textarea id="moreInfo1" class="form-control" rows="4"></textarea>
												                        </div>
												                    </div>

												                    <!-- Submit Button -->
												                    <div class="text-center">
												                        <button type="submit" class="btn btn-primary" style="background-color: #007bff; border-color: #007bff;">Submit</button>
												                    </div>

												                </form>
												            </div>
												        </div>
												    </div>
												</div>

<script>

			
	function loadDropdown1(type, dropdownId) {
	    fetch(`/api/dropdown/${type}`)
	        .then(response => response.json())
	        .then(data => {
	            const dropdown = document.getElementById(dropdownId);
	            dropdown.innerHTML = `<option disabled selected>Select ${type.replace('_', ' ')}</option>`;

	            if (data.length === 0) {
	                dropdown.innerHTML += `<option value="add_new">Add New</option>`;
	            } else {
	                data.forEach(value => {
	                    dropdown.innerHTML += `<option value="${value}">${value}</option>`;
	                });
	                dropdown.innerHTML += `<option value="add_new">Add New</option>`;
	            }
	        })
	        .catch(error => {
	            console.error("Error loading dropdown:", error);
	        });
	}


	function checkAddOption1(selectElement, type) {
	    if (selectElement.value === 'add_new') {
	        document.getElementById('dropdownType1').value = type;
	        document.getElementById('dropdownId1').value = selectElement.id;
	        document.getElementById('newDropdownValue1').value = '';
	        document.getElementById('dropdownLabel1').textContent = `Enter new ${type.replace('_', ' ')} value:`;
	        const modal = new bootstrap.Modal(document.getElementById('addDropdownModal1'));
	        modal.show();
	    }
	}

	document.getElementById('addDropdownForm1').addEventListener('submit', function (e) {
	    e.preventDefault();

	    const type = document.getElementById('dropdownType1').value;
	    const value = document.getElementById('newDropdownValue1').value.trim();
	    const dropdownId = document.getElementById('dropdownId1').value;

	    if (value !== '') {
	        fetch(`/api/dropdown/add?type=${type}&value=${encodeURIComponent(value)}`, {
	            method: 'POST'
	        }).then(() => {
	            const modal = bootstrap.Modal.getInstance(document.getElementById('addDropdownModal1'));
	            modal.hide();
	            loadDropdown(type, dropdownId);  // reload the dropdown, whatever dropdown triggered it
	        });
	    }
	});

	// Submit form to save company
	   document.getElementById('addCompanyForm1').addEventListener('submit', function (e) {
	       e.preventDefault();

	       const data = {
	           technology: document.getElementById('technology1').value,
	           segment: document.getElementById('segment1').value,
	           lookingFor: document.getElementById('lookingFor1').value
	       };

	       fetch('/api/company/add', {
	           method: 'POST',
	           headers: { 'Content-Type': 'application/json' },
	           body: JSON.stringify(data)
	       })
	       .then(res => {
	           if (res.ok) {
	               alert("Company added successfully!");
	               $('#addCompanyModal').modal('hide'); // If using jQuery for outer modal
	               this.reset();
	           } else {
	               alert("Error saving company.");
	           }
	       });
	   });

	</script>
						
						<!-- View Company Modal -->
						<div id="viewCompanyModal" class="modal" tabindex="-1" style="display: none;">
						    <div class="modal-dialog modal-xl">
						        <div class="modal-content">
						            <div class="modal-header">
						                <h5 class="modal-title" style="font-weight: 700;color: #007bff;">Company Details</h5>
						                <button type="button" class="btn-close" onclick="closeViewCompanyModal()"></button>
						            </div>
						            <div class="modal-body">
						                <div class="container-fluid">
						                    <!-- Customer Details -->
						                    <div class="col-md-12 mb-3">
						                        <h5 style="color: black;"><b>Customer Details</b></h5>
						                    </div>
						                    <div class="row">
						                        <div class="col-md-3 mb-3">
						                            <label>Company Name:</label>
						                            <p id="viewCustomerName"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Company Contact:</label>
						                            <p id="viewContactNumber"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>GST Number:</label>
						                            <p id="viewEmailId"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Company Address:</label>
						                            <p id="viewDesignation"></p>
						                        </div>
												<div class="col-md-3 mb-3" style="display: none;">
												       <label >Company Name</label>
													   <p id="viewcompanyName"></p>
												     
												   </div>
												   <div class="col-md-3 mb-3" style="display: none;">
												       <label >Company Address</label>
													   <p id="viewcompanyAddress"></p>
												       
												   </div>
						                    </div>

						                    <!-- Contact Person Details -->
						                    <div class="col-md-12 mb-3">
						                        <h5 style="color: black;"><b>Contact Person Details</b></h5>
						                    </div>
						                    <div id="contactPersonsContainer1" class="row"></div>

						                    <!-- Lead Info -->
						                    <div class="col-md-12 mb-3">
						                        <h5 style="color: black;"><b>Lead Info</b></h5>
						                    </div>
						                    <div class="row">
						                        <div class="col-md-3 mb-3">
						                            <label>Lead Given By:</label>
						                            <p id="viewReferredBy"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Lead Given Phone:</label>
						                            <p id="viewReferredPhoneCompany"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Lead Given Email:</label>
						                            <p id="viewLeadEmail"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Lead Given Company:</label>
						                            <p id="viewLeadPhone"></p>
						                        </div>
						                    </div>

						                    <!-- Project Info -->
						                    <div class="col-md-12 mb-3">
						                        <h5 style="color: black;"><b>Project Info</b></h5>
						                    </div>
						                    <div class="row">
						                        <div class="col-md-3 mb-3">
						                            <label>Project Name:</label>
						                            <p id="viewProjectName"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Product Name:</label>
						                            <p id="viewProductName"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Segment:</label>
						                            <p id="viewSegment"></p>
						                        </div>
												<div class="col-md-3 mb-3">
												    <label>Technology:</label>
												    <p id="viewTechnology"></p>
												</div>

						                        <div class="col-md-3 mb-3">
						                            <label>Interested Level:</label>
						                            <p id="viewInterestedLevel"></p>
						                        </div>
						                        <div class="col-md-3 mb-3">
						                            <label>Looking For:</label>
						                            <p id="viewLookingFor"></p>
						                        </div>
												<div class="col-md-3 mb-3">
																		                            <label>Quantity (Qty):</label>
																		                            <p id="viewQty"></p>
																		                        </div>
						                       
						                    </div>
											<div class="row">
											    <div class="col-md-12 mb-3">
											        <label>Additional Info:</label>
											        <p id="viewMoreInfo" style="white-space: pre-wrap;"></p>
											    </div>
						                </div>
						            </div>
						        </div>
						    </div>
						</div>






<script>
	/*function viewCompanyDetails(companyId) {
		       fetch(`/crmcompany/${companyId}`)
		           .then(response => response.json())
		           .then(company => {
		               document.getElementById("viewCustomerName").textContent = company.customerName || 'N/A';
		               document.getElementById("viewContactNumber").textContent = company.contactNumber || 'N/A';
		               document.getElementById("viewEmailId").textContent = company.emailId || 'N/A';
		               document.getElementById("viewCompanyName").textContent = company.companyName || 'N/A';
		               document.getElementById("viewTechnology").textContent = company.technology || 'N/A';
		               document.getElementById("viewInterestedLevel").textContent = company.interestedLevel || 'N/A';
		               document.getElementById("viewLookingFor").textContent = company.lookingFor || 'N/A';
		              // document.getElementById("viewWhichMc").textContent = company.whichMc || 'N/A';
		               document.getElementById("viewQty").textContent = company.quantity || 'N/A';
		               document.getElementById("viewReferredBy").textContent = company.referredBy || 'N/A';
		               document.getElementById("viewReferredPhoneCompany").textContent = company.referredPhoneCompany || 'N/A';
		               document.getElementById("viewCompanyAddress").textContent = company.companyAddress || 'N/A';
		               document.getElementById("viewMoreInfo").textContent = company.moreInfo || 'N/A';
					   // New Fields
					              document.getElementById("viewContactPerson").textContent = company.contactPerson || 'N/A';
					              document.getElementById("viewDesignation").textContent = company.designation || 'N/A';
					              document.getElementById("viewDomain").textContent = company.domain || 'N/A';
		               openViewCompanyModal();
		           })
		           .catch(error => {
		               console.error('Error fetching company details:', error);
		               alert("Failed to fetch company details. Please try again.");
		           });
		   }*/
		   
		   function viewCompanyDetails(companyId) {
		       fetch(`/crmcompany/${companyId}`)
		           .then(response => response.json())
		           .then(company => {
					console.log("Company Details Response:sss", company); // ‚úÖ Log the response

		               // Populate Customer Details
		               document.getElementById("viewCustomerName").textContent = company.customerName || 'N/A';
		               document.getElementById("viewContactNumber").textContent = company.contactNumber || 'N/A';
		               document.getElementById("viewEmailId").textContent = company.gstNumber || 'N/A';
		               document.getElementById("viewDesignation").textContent = company.companyAddress || 'N/A';
					  // document.getElementById("viewcompanyName").textContent = company.companyName || 'N/A';
					// document.getElementById("viewcompanyAddress").textContent = company.companyAddress || 'N/A';

		               // Populate Lead Info
		               document.getElementById("viewReferredBy").textContent = company.referredBy || 'N/A';
		               document.getElementById("viewReferredPhoneCompany").textContent = company.referredPhoneCompany || 'N/A';
		               document.getElementById("viewLeadEmail").textContent = company.leadEmail || 'N/A';
		               document.getElementById("viewLeadPhone").textContent = company.leadCompany || 'N/A';

		               // Populate Project Info
		               document.getElementById("viewProjectName").textContent = company.projectName || 'N/A';
		               document.getElementById("viewProductName").textContent = company.productName || 'N/A';
		               document.getElementById("viewSegment").textContent = company.segment || 'N/A';
					   document.getElementById("viewTechnology").textContent = company.technology || 'N/A';

		               document.getElementById("viewQty").textContent = company.quantity || 'N/A';
		               document.getElementById("viewInterestedLevel").textContent = company.interestedLevel || 'N/A';
		               document.getElementById("viewLookingFor").textContent = company.lookingFor || 'N/A';
		               document.getElementById("viewMoreInfo").textContent = company.moreInfo || 'N/A';

		               // Populate Contact Persons
		               const container = document.getElementById("contactPersonsContainer1");
		               container.innerHTML = ""; // Clear previous data

		               if (company.contactPersons && company.contactPersons.length > 0) {
						console.log("Contact Persons:", company.contactPersons);

		                   company.contactPersons.forEach(person => {
		                       const contactRow = `
		                           <div class="col-md-3 mb-3">
		                               <label>Name:</label>
									   <p>${person.contactPerson || 'N/A'} (${person.priority || 'N/A'})</p>
		                           </div>
		                           <div class="col-md-3 mb-3">
		                               <label>Contact Number:</label>
									   <p>${person.contactNumber || 'N/A'}</p>
		                           </div>
		                           <div class="col-md-3 mb-3">
		                               <label>Email:</label>
									   <p>${person.email || 'N/A'}</p>
		                           </div>
		                           <div class="col-md-3 mb-3">
		                               <label>Designation:</label>
									   <p>${person.designation || 'N/A'}</p>
		                           </div>
		                       `;
		                       container.insertAdjacentHTML("beforeend", contactRow);
		                   });
		               } else {
		                   container.innerHTML = `
		                       <div class="col-md-12 mb-3">
		                           <p>No contact persons available</p>
		                       </div>
		                   `;
		               }

		               openViewCompanyModal();
		           })
		           .catch(error => {
		               console.error('Error fetching company details:', error);
		               alert("Failed to fetch company details. Please try again.");
		           });
		   }

		   function openViewCompanyModal() {
		       document.getElementById("viewCompanyModal").style.display = "block";
		   }

		   function closeViewCompanyModal() {
		       document.getElementById("viewCompanyModal").style.display = "none";
		   }

	</script>
			<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
						    <div class="modal-dialog">
						        <div class="modal-content rounded-4 shadow-lg">
						            <div class="modal-header border-0">
						                <h5 class="modal-title" id="feedbackModalLabel">Feedback Form</h5>
						                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						            </div>
						            <div class="modal-body">
						                <form id="feedbackForm" method="post" enctype="multipart/form-data">
						                    <div class="mb-3" style="display: none;">
						                        <label for="feedbackName" class="form-label fw-bold">Your Name</label>
						                        <input type="text" class="form-control" id="feedbackName" name="name" th:value="${empDetailsByEmpId.fullName}" readonly>
						                    </div>
						                    <div class="mb-3" style="display: none;">
						                        <label for="feedbackEmail" class="form-label fw-bold">Your Email</label>
						                        <input type="email" class="form-control" id="feedbackEmail" name="email" th:value="${empDetailsByEmpId.email}" readonly>
						                    </div>
						                    <div class="mb-3">
						                        <label for="feedbackEmailyy" class="form-label fw-bold">To</label>
						                        <div class="to-field-container">
						                            <span class="to-field rounded-pill px-3 py-2 shadow-sm">bugs_msplconnect@melangesystems.com</span>
						                        </div>
						                    </div>
											<div class="mb-3">
											    <label for="bugType" class="form-label fw-bold">Bug Type</label>
											    <select class="form-control" id="bugType" name="bugType" required>
											        <option value="About Application">About Application</option>
											        <option value="New Feature">New Feature</option>
											    </select>
											</div>

						                    <div class="mb-3">
						                        <label for="feedbackMessage" class="form-label fw-bold">Message</label>
						                        <textarea class="form-control" id="feedbackMessage" name="message" rows="4" placeholder="Enter your feedback here..." required></textarea>
						                    </div>
						                    <div class="mb-3">
						                        <label for="feedbackAttachment" class="form-label fw-bold">Attachment (optional)</label>
						                        <input type="file" class="form-control" id="feedbackAttachment" name="attachment" accept=".png, .jpg, .jpeg" multiple>
						                        <small class="text-muted">Max size: 5MB. You can upload multiple images.</small>
						                    </div>
						                    <button type="submit" class="btn btn-primary w-100 mt-3 py-2 shadow-sm" id="submitFeedbackBtn">Submit Feedback</button>
						                </form>
						            </div>
						        </div>
						    </div>
						</div>

		</section>




	</main><!-- End #main -->

	<!-- ======= Footer ======= -->
	<!--<footer id="footer" class="footer">
  		<div class="copyright">
  			Copyright &copy; <span id="currentYear"></span> <strong><span>Melange Systems Private
  					Limited</span></strong>. All Rights Reserved
  		</div>
  	</footer>-->
	<script>
		var currentYear = new Date().getFullYear();
		document.getElementById("currentYear").innerHTML = currentYear;
	</script>

	<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
			class="bi bi-arrow-up-short"></i></a>

	<!-- Vendor JS Files -->
	<script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
	<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="assets/vendor/chart.js/chart.umd.js"></script>
	<script src="assets/vendor/echarts/echarts.min.js"></script>
	<script src="assets/vendor/quill/quill.js"></script>
	<script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
	<script src="assets/vendor/tinymce/tinymce.min.js"></script>
	<script src="assets/vendor/php-email-form/validate.js"></script>

	<!-- Template Main JS File -->
	<script src="assets/js/main.js"></script>
	 

	<script>
		
		

		  function removeContactPerson(button) {
		      const row = button.closest('.contact-person-row');
		      if (row) {
		          row.remove();
		          updateContactBadges();
		      }
		  }

		  function updateContactBadges() {
		      const rows = document.querySelectorAll('#contactPersons .contact-person-row');
		      rows.forEach((row, index) => {
		          const badge = row.querySelector('.badge');
		          if (!badge) return;
		          
		          // Set the first row as Primary
		          if (index === 0) {
		              badge.textContent = 'Primary';
		              badge.classList.add('bg-primary');
		              badge.classList.remove('bg-secondary');
		          } else {
		              badge.textContent = 'Secondary';
		              badge.classList.add('bg-secondary');
		              badge.classList.remove('bg-primary');
		          }
		      });
		  }

		  // Drag and Drop Functions
		  // let draggedRow = null;

		
		

		  // Initialize badges on page load
		  window.addEventListener("DOMContentLoaded", () => {
		      updateContactBadges();
		  });
	</script>

		<script>
		document.getElementById("feedbackForm").addEventListener("submit", function (event) {
			    event.preventDefault(); // Prevent default form submission

			    $.ajax({
			        url: 'recentlySavedTicketNumber',
			        type: 'GET',
			        success: function (response) {
			            let recentlyInsertedTicketIdData = response;

			            // Get the current date
			            var today = new Date();
			            var year = today.getFullYear();
			            var month = today.getMonth() + 1; // JavaScript months are 0-based

			            // Calculate the financial year
			            var financialYearStart = month >= 4 ? year : year - 1; // Fiscal year starts in April
			            var financialYearEnd = financialYearStart + 1;

			            // Format as FYY-YY
			            var financialYear = `F${financialYearStart % 100}-${financialYearEnd % 100}`;

			            // Department Name
			            var loggedInDeptName = $('#loggedInDeptName').val();

			            let incrementedNumber = "0001"; // Default number if response is empty or null

			            // Check if recentlyInsertedTicketIdData is not empty or null
			            if (recentlyInsertedTicketIdData) {
			                // Extract the last part of the ticket (e.g., 0001)
			                let ticketParts = recentlyInsertedTicketIdData.split("/");
			                let lastPart = ticketParts[ticketParts.length - 1];

			                // Increment the extracted number
			                let numericValue = parseInt(lastPart, 10) + 1;
			                incrementedNumber = numericValue.toString().padStart(4, '0'); // Pad with leading zeros
			            }

			            // Construct the feedback ticket
			            var feedbackTicket = `MSPL/FT/${financialYear}/${loggedInDeptName}/${incrementedNumber}`;

			            // Add feedback ticket to the form data
			            let formData = new FormData(document.getElementById("feedbackForm"));
			            formData.append("id", feedbackTicket);
			            formData.append("emp_id", $('#emp_idSessionValue').val());

			            const submitButton = document.getElementById("submitFeedbackBtn");
			            submitButton.disabled = true; // Disable the submit button to prevent multiple submissions

			            const loadingSwal = Swal.fire({
			                title: 'Submitting feedback...',
			                text: 'Please wait while we submit your feedback.',
			                showConfirmButton: false,
			                allowOutsideClick: false, // Prevent closing when clicking outside
			                            allowEscapeKey: false, // Prevent closing when pressing escape key
			                didOpen: () => {
			                    Swal.showLoading(); // Display the loading spinner
			                }
			            });

			            // Append files to form data
			            let files = document.getElementById("feedbackAttachment").files;
			            if (files.length > 0) {
			                for (let i = 0; i < files.length; i++) {
			                    formData.append(`attachment[${i}]`, files[i]); // Use unique keys
			                }
			            }

			            let bugType = document.getElementById("bugType").value;
			            formData.append("bugTypeff", bugType); // Add the bug type to the form data

			            // Debugging: Log formData entries before the fetch call
			            console.log("Logging formData entries:");
			            for (let [key, value] of formData.entries()) {
			                if (value instanceof File) {
			                    console.log(`Key: ${key}, File Name: ${value.name}, Size: ${value.size}`);
			                } else {
			                    console.log(`Key: ${key}, Value: ${value}`);
			                }
			            }

			            // Make AJAX request to submit feedback
			            fetch("/submitFeedback", {
			                method: "POST",
			                body: formData
			            })
			                .then(response => response.json())
			                .then(data => {
			                    loadingSwal.close();
			                    submitButton.disabled = false; // Re-enable the button
			                    if (data.success) {
			                        $('#feedbackModal').modal('hide');
			                        Swal.fire({
			                            title: 'Success!',
			                            text: 'Your feedback has been submitted successfully.',
			                            icon: 'success',
			                            allowOutsideClick: false, // Prevent closing when clicking outside
			                                        allowEscapeKey: false, // Prevent closing when pressing escape key
			                            customClass: {
			                                popup: 'custom-swal-font'
			                            },
			                            confirmButtonText: 'OK'
			                        }).then((result) => {
			                            if (result.isConfirmed) {
			                                    Swal.fire({
			                                            html: 'We sincerely appreciate your feedback! Please find your feedback ticket details below.<br><br>' + 
			                                    '<strong>' + feedbackTicket + '</strong>', // Display the feedback ticket on a new line
			                                    allowOutsideClick: false, // Prevent closing when clicking outside
			                                                allowEscapeKey: false, // Prevent closing when pressing escape key
			                                    customClass: {
			                                        popup: 'custom-swal-font'
			                                    },
			                                    confirmButtonText: 'OK'
			                                });
			                            }
			                        });
			                    } else {
			                        Swal.fire({
			                            title: 'Error!',
			                            text: 'There was an error submitting your feedback.',
			                            icon: 'error',
			                            allowOutsideClick: false, // Prevent closing when clicking outside
			                                        allowEscapeKey: false, // Prevent closing when pressing escape key
			                            customClass: {
			                                popup: 'custom-swal-font'
			                            },
			                            confirmButtonText: 'OK'
			                        });
			                    }
			                })
			                .catch(error => {
			                    console.error('Error:', error);
			                    loadingSwal.close();
			                    submitButton.disabled = false; // Re-enable the button
			                    Swal.fire({
			                        title: 'Error!',
			                        text: 'There was an error submitting your feedback.',
			                        icon: 'error',
			                        allowOutsideClick: false, // Prevent closing when clicking outside
			                                    allowEscapeKey: false, // Prevent closing when pressing escape key
			                        customClass: {
			                            popup: 'custom-swal-font'
			                        },
			                        confirmButtonText: 'OK'
			                    });
			                });
			        },
			        error: function (xhr, status, error) {
			            alert('Failed to fetch recently inserted feedback ticket: ' + error);
			        }
			    });
			});


			   // Clear form fields when the modal is closed
			   document.getElementById('feedbackModal').addEventListener('hidden.bs.modal', function () {
			       const feedbackForm = document.getElementById('feedbackForm');
			       feedbackForm.reset(); // Reset the form fields
			       document.getElementById('feedbackAttachment').value = ""; // Clear file input manually
			   });
	</script>


<script>
	
	

	
	
	   
	   function deleteCompany(companyId, button) {
	       Swal.fire({
	           title: 'Are you sure?',
	           text: "Do you really want to delete this company?",
	           icon: 'warning',
	           showCancelButton: true,
	           confirmButtonColor: '#d33',
	           cancelButtonColor: '#3085d6',
	           confirmButtonText: 'Yes, delete it!',
	           cancelButtonText: 'Cancel'
	       }).then((result) => {
	           if (result.isConfirmed) {
	               // Send the delete request to the server
	               fetch(`/crmdelete/${companyId}`, {
	                   method: 'DELETE'
	               })
	               .then(response => {
	                   if (response.ok) {
	                       // Remove the row from the DOM
	                       const row = button.closest('tr');
	                       row.remove();

	                       // Show success message
	                       Swal.fire(
	                           'Deleted!',
	                           'Company deleted successfully.',
	                           'success'
	                       );
	                   } else {
	                       Swal.fire(
	                           'Error!',
	                           'Failed to delete the company. Please try again.',
	                           'error'
	                       );
	                   }
	               })
	               .catch(error => {
	                   console.error('Error:', error);
	                   Swal.fire(
	                       'Error!',
	                       'An error occurred. Please try again.',
	                       'error'
	                   );
	               });
	           }
	       });
	   }
	   
	   
	/*   function submitCompanyFormupdate(event) {
	       event.preventDefault();
	       
	       const companyId = document.getElementById("companyId").value;
	       const url = companyId ? `/crmupdate/${companyId}` : '/crmcreate';
	       const method = companyId ? 'PUT' : 'POST';

	       const formData = {
	           customerName: document.getElementById("customerName1").value,
	           contactNumber: document.getElementById("contactNumber1").value,
	           emailId: document.getElementById("emailId1").value,
	           companyName: document.getElementById("companyName1").value,
	           companyAddress: document.getElementById("companyAddress1").value,
	           technology: document.getElementById("technology1").value,
	           lookingFor: document.getElementById("lookingFor1").value,
	           whichMc: document.getElementById("whichMc1").value,
	           quantity: document.getElementById("qty1").value,
	           interestedLevel: document.getElementById("interestedLevel1").value,
	           referredBy: document.getElementById("referredBy1").value,
	           referredPhoneCompany: document.getElementById("referredPhoneCompany1").value,
	           moreInfo: document.getElementById("moreInfo1").value,
			   contactPerson: document.getElementById("contactPerson1").value,
			          designation: document.getElementById("designation1").value,
			          domain: document.getElementById("domain1").value
	       };

	       fetch(url, {
	           method: method,
	           headers: {
	               'Content-Type': 'application/json',
	           },
	           body: JSON.stringify(formData),
	       })
	       .then(response => {
	           if (response.ok) {
	               alert("Company saved successfully.");
	               closeAddCompanyModalupdate();
	               location.reload(); // Refresh the page to show the updated list
	           } else {
	               alert("Failed to save company. Please try again.");
	           }
	       })
	       .catch(error => {
	           console.error('Error saving company:', error);
	           alert("An error occurred. Please try again.");
	       });
	   }*/
	   
	   function submitCompanyFormupdate(event) {
	       event.preventDefault();

	       const companyId = document.getElementById("companyId").value;
	       const url = companyId ? `/crmupdate/${companyId}` : '/crmcreate';
	       const method = companyId ? 'PUT' : 'POST';

	       const formData = {
	           customerName: document.getElementById("customerName1").value,
	           contactNumber: document.getElementById("contactNumber1").value,
	           gstNumber: document.getElementById("gstNumber1").value,
			 //  designation : document.getElementById("designation1").value,
	         //  companyName: document.getElementById("companyName1").value,
	           companyAddress: document.getElementById("companyAddress1").value,
	           technology: document.getElementById("technology1").value,
	           lookingFor: document.getElementById("lookingFor1").value,
	        //   whichMc: document.getElementById("whichMc1").value,
			leadEmail:document.getElementById("leadEmail1").value,
			leadCompany:document.getElementById("leadPhone1").value,
			projectName:document.getElementById("projectName1").value ,
			productName: document.getElementById("productName1").value, 
			segment: document.getElementById("segment1").value ,
	           quantity: document.getElementById("qty1").value,
	           interestedLevel: document.getElementById("interestedLevel1").value,
	           referredBy: document.getElementById("referredBy1").value,
	           referredPhoneCompany: document.getElementById("referredPhoneCompany1").value,
	           moreInfo: document.getElementById("moreInfo1").value,
	       //    domain: document.getElementById("domain1").value,
	           contactPersons: []
	       };
		   const contactPersonRows = document.querySelectorAll(".contact-person-row");
		     console.log("Total Contact Persons Found: " + contactPersonRows.length);

		     contactPersonRows.forEach((row, index) => {
		         console.log("Processing Contact Person Row: " + (index + 1));

		         const contactPersonElement = row.querySelector(`[data-contact-person-index]`);
		         const contactNumberElement = row.querySelector(`[data-contact-number-index]`);
		         const emailElement = row.querySelector(`[data-contact-email-index]`);
		         const designationElement = row.querySelector(`[data-contact-designation-index]`);

		         // Get priority text from the badge inside the same row
		         const priorityBadge = row.querySelector("span.badge");
		         const priority = priorityBadge ? priorityBadge.textContent.trim() : 'Secondary';

		         const contactPerson = contactPersonElement ? contactPersonElement.value : '';
		         const contactNumber = contactNumberElement ? contactNumberElement.value : '';
		         const email = emailElement ? emailElement.value : '';
		         const designation = designationElement ? designationElement.value : '';

		         console.log(`Extracted Values:
		         Contact Person: ${contactPerson}
		         Contact Number: ${contactNumber}
		         Email: ${email}
		         Designation: ${designation}
		         Priority: ${priority}`);


				 if (contactPerson || contactNumber || email || designation) {
				          const contactPersonData = {
				              contactPerson,
				              contactNumber,
				              email,
				              designation,
				              priority   // <-- now storing the actual priority text
				          };

				          console.log("Adding Contact Person to Form Data:\n" + JSON.stringify(contactPersonData, null, 2));

		           formData.contactPersons.push(contactPersonData);
		       }
		   });

		   console.log("Final Contact Persons Array:\n" + JSON.stringify(formData.contactPersons, null, 2));


		   // Print the formData to the console
		       console.log("Form Data Being Sent:", JSON.stringify(formData, null, 2));

		    fetch(url, {
	           method: method,
	           headers: {
	               'Content-Type': 'application/json',
	           },
	           body: JSON.stringify(formData),
	       })
	       .then(response => {
	           if (response.ok) {
	               alert("Company saved successfully.");
	               closeAddCompanyModalupdate();
	               location.reload(); // Refresh the page to show the updated list
	           } else {
	               alert("Failed to save company. Please try again.");
	           }
	       })
	       .catch(error => {
	           console.error('Error saving company:', error);
	           alert("An error occurred. Please try again.");
	       });
	   }


	      // Fetch CRM details on page load
	     // document.addEventListener("DOMContentLoaded", fetchCrmDetails);
	</script>
	 
	<script>
		function getLeavePendingCount() {
			$.ajax({
				type: 'GET',
				url: '/getProjectNames',
				success: function (projectNames) {
					console.log('Project namesssss:', projectNames);

					if (projectNames.length > 0) {
						projectNames.forEach(function (projectName) {
							console.log('Fetching notifications for project:', projectName); // Debug log
							getNotificationCounts(projectName); // Pass projectName here
						});
					} else {

						console.error('No project names found for the given user.');
						$('#notification_list_message').text('No projects found for your email.');
						$('#defaultBox').show();
						getDefaultNotificationCounts();

					}
				},
				error: function (xhr, status, error) {
					console.error('Error fetching project names:', error);
					$('#notification_list_message').text('Error fetching project names. Please try again later.');
					$('#defaultBox').show();
					getDefaultNotificationCounts();

				}
			});
		}


		function getNotificationCounts(projectName) {
					console.log('Inside getNotificationCounts for project:', projectName);
					$.ajax({
						type: 'GET',
						url: 'fetchNotificationCountForAllPages',
						data: {projectName: projectName},
						success: function (data) {
							console.log("=======" + JSON.stringify(data));

							var totalNotificationCount = data.total_notification;
							var leavePendingCountValue = data.leave_pending_count;
							var newProjectCountValue = data.newProjectCount;
							var appraisalCountValue = data.appraisalCountValue;
							var appraisalTwoDaysCountValue = data.appraisalTwoDaysCountValue;
							var appraisalOneDayCountValue = data.appraisalOneDayCountValue;
							var ToDoListNotification = data.toDoListNotification;
							var eventsNotification = data.eventsNotification;
							var featuresNotification = data.featuresNotification;
							var releaseNotification = data.releaseNotification;
							var quotationNotification = data.quotationNotification || 0;
							var revisedQuotationNotification = data.revisedQuotationNotification || 0;
							$('#notificationCount').text(totalNotificationCount);
							updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, newProjectCountValue, appraisalCountValue, appraisalTwoDaysCountValue, appraisalOneDayCountValue, ToDoListNotification, eventsNotification, featuresNotification,releaseNotification,quotationNotification,revisedQuotationNotification);
						},
						error: function (xhr, status, error) {
							console.error('Error fetching data:', error);
							console.log('Error fetching data. Please try again.');
						}
					});
				}

				function getDefaultNotificationCounts() {
					//console.log('Fetching general notification counts.');
					$.ajax({
						type: 'GET',
						url: 'fetchNotificationCountForAllPagesWithoutProject',
						success: function (data) {
							console.log("General notification data:", JSON.stringify(data));

							var totalNotificationCount = data.total_notification || 0;
							var leavePendingCountValue = data.leave_pending_count || 0;
							var newProjectCountValue = data.newProjectCount || 0;
							var appraisalCountValue = data.appraisalCountValue || 0;
							var appraisalTwoDaysCountValue = data.appraisalTwoDaysCountValue || 0;
							var appraisalOneDayCountValue = data.appraisalOneDayCountValue || 0;
							var toDoListNotification = data.toDoListNotification || 0;
							var eventsNotification = data.eventsNotification || 0;
							var featuresNotification = data.featuresNotification || 0;
							var releaseNotification = data.releaseNotification || 0;
							var quotationNotification = data.quotationNotification || 0;
							var revisedQuotationNotification = data.revisedQuotationNotification || 0;
							$('#notificationCount').text(totalNotificationCount);
							updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, newProjectCountValue, appraisalCountValue, appraisalTwoDaysCountValue, appraisalOneDayCountValue, toDoListNotification, eventsNotification, featuresNotification,releaseNotification,quotationNotification,revisedQuotationNotification);
						},
						error: function (xhr, status, error) {
							//console.error('Error fetching general notifications:', error);
							$('#notification_list_message').text('Error fetching notifications. Please try again later.');
						}
					});
				}


				$(document).ready(function () {
					getLeavePendingCount();
				setInterval(getLeavePendingCount, 1000);
				});

				function updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, newprojectCountValue, appraisalCountValue, appraisalTwoDaysCountValue, appraisalOneDayCountValue, ToDoListNotification, eventsNotification, featuresNotification,releaseNotification,quotationNotification,revisedQuotationNotification) {
					var emptyNotifyDiv = $('#emptyNotifyDiv');
					//var leaveRequestNotifyDiv = $('#leaveRequestNotifyDiv');

					var leaveRequestNotifyDiv = $('#leaveRequestNotifyDiv');
					var leaveRequestNotifyDivHorizontalRow = $('#leaveRequestNotifyDivHorizontalRow');

					var moatNewCandidateNotifyDiv = $('#moatNewCandidateNotifyDiv');
					var moatNewCandidateNotifyDivHorizontalRow = $('#moatNewCandidateNotifyDivHorizontalRow');

					var appraisalNotifyDiv = $('#appraisalNotifyDiv');
					var appraisalNotifyDivHorizontalRow = $('#appraisalNotifyDivHorizontalRow');

					var appraisalTwoDaysNotifyDiv = $('#appraisalTwoDaysNotifyDiv');
					var appraisalTwoDaysNotifyDivHorizontalRow = $('#appraisalTwoDaysNotifyDivHorizontalRow');

					var appraisalOneDayNotifyDiv = $('#appraisalOneDayNotifyDiv');
					var appraisalOneDayNotifyDivHorizontalRow = $('#appraisalOneDayNotifyDivHorizontalRow');

					var ToDoListNotifyDiv = $('#ToDoListNotifyDiv');
					var ToDoListNotifyDivHorizontalRow = $('#ToDoListNotifyDivHorizontalRow');

					var EventNotifyDiv = $('#EventNotifyDiv');
					var EventNotifyDivHorizontalRow = $('#EventNotifyDivHorizontalRow');

					var FeaturesNotifyDiv = $('#FeaturesNotifyDiv');
					var FeaturesNotifyDivHorizontalRow = $('#FeaturesNotifyDivHorizontalRow');

					var ReleaseNotifyDiv = $('#ReleaseNotifyDiv');
								var ReleaseNotifyDivHorizontalRow = $('#ReleaseNotifyDivHorizontalRow');

								var QuotationNotifyDiv = $('#quotationNotifyDiv');
								var QuotationNotifyDivHorizontalRow = $('#quotationNotifyDivHorizontalRow');

								var ReviseQuotationNotifyDiv = $('#RevisequotationNotifyDiv');
														var ReviseQuotationNotifyDivHorizontalRow = $('#RevisequotationNotifyDivHorizontalRow');

								
					if (totalNotificationCount > 0) {
						$("#bellIcon").show();
						$("#emptyNotifyDiv").hide();
						$('#emptyNotificationHeaderMessage').text("");

						if (leavePendingCountValue > 0) {
							leaveRequestNotifyDiv.show();
							$('#leaveNotificationMessage').text("You have " + leavePendingCountValue + " new leave Notification");
							$('#leaveNotificationNumberHeader').text("Leave Request!");
						} else {
							leaveRequestNotifyDiv.hide();
						}
						if (newprojectCountValue > 0) {
							moatNewCandidateNotifyDiv.show();
							moatNewCandidateNotifyDivHorizontalRow.show();
							$('#moatNewCandidateNotificationMessage').text("There is " + newprojectCountValue + " New Project Task Assigned");
							$('#moatNewCandidateNumberHeader').text("Project!");
						} else {
							moatNewCandidateNotifyDiv.hide();

						} if (appraisalCountValue > 0) {
							appraisalNotifyDiv.show();
							appraisalNotifyDivHorizontalRow.show();
							$('#appraisalNotificationMessage').text("There is " + appraisalCountValue + " Appraisal Form Assigned");
							$('#appraisalNumberHeader').text("Appraisal!");
						} else {
							appraisalNotifyDiv.hide();
						} if (appraisalTwoDaysCountValue > 0) {
							appraisalTwoDaysNotifyDiv.show();
							appraisalTwoDaysNotifyDivHorizontalRow.show();
							$('#appraisalTwoDaysNotificationMessage').text("Reminder: Complete and submit your appraisal form at your earliest convenience.");
							$('#appraisalTwoDaysNumberHeader').text("Appraisal!");
						} else {
							appraisalTwoDaysNotifyDiv.hide();
						} if (appraisalOneDayCountValue > 0) {
							appraisalOneDayNotifyDiv.show();
							appraisalOneDayNotifyDivHorizontalRow.show();
							$('#appraisalOneDayNotificationMessage').text("Reminder: Just one more day until the appraisal form submission deadline. Please take action!");
							$('#appraisalOneDayNumberHeader').text("Appraisal!");
						} else {
							appraisalOneDayNotifyDiv.hide();
						} if (ToDoListNotification > 0) {
							ToDoListNotifyDiv.show();
							ToDoListNotifyDivHorizontalRow.show();
							$('#ToDoListNotificationMessage').text("Time is ticking! Don't forget to complete your task before the deadline.");
							$('#ToDoListNumberHeader').text("Reminder!");
						} else {
							ToDoListNotifyDiv.hide();
						} if (eventsNotification > 0) {
							EventNotifyDiv.show();
							EventNotifyDivHorizontalRow.show();
							$('#EventNotificationMessage').text("There is  " + eventsNotification + " new event has been scheduled. Mark your calendars!");
							$('#EventNumberHeader').text("Announcements!");
						} else {
							EventNotifyDiv.hide();
						} if (featuresNotification > 0) {
							FeaturesNotifyDiv.show();
							FeaturesNotifyDivHorizontalRow.show();
							$('#FeaturesNotificationMessage').text("There is  " + featuresNotification + " new feature update is now available! explore the latest enhancements.");
							$('#FeaturesNumberHeader').text("Latest Update!");
						} else {
							FeaturesNotifyDiv.hide();
						}				if (releaseNotification > 0) {
											ReleaseNotifyDiv.show();
											ReleaseNotifyDivHorizontalRow.show();
											$('#ReleaseNotificationMessage').html(
											    /*'There is a latest release available! Click here to see the details. Version: <b>V.0.1.1</b>'*/
											);	$('#ReleaseNumberHeader').text("Latest Release About Policy Update!");
										} else {
											ReleaseNotifyDiv.hide();
										}								if (quotationNotification > 0) {
																			QuotationNotifyDiv.show();
																			QuotationNotifyDivHorizontalRow.show();
																			$('#quotationNotificationMessage').html(
																			    /*'There is a latest release available! Click here to see the details. Version: <b>V.0.1.1</b>'*/
																				`You have <b>${quotationNotification}</b> approved quotation${quotationNotification > 1 ? 's' : ''} . Click to view.`
																			);	$('#quotationNumberHeader').text("Approved Quotations");
																		} else {
																			QuotationNotifyDiv.hide();
																		}																if (revisedQuotationNotification > 0) {
																																			ReviseQuotationNotifyDiv.show();
																																			ReviseQuotationNotifyDivHorizontalRow.show();
																																			$('#RevisequotationNotificationMessage').html(
																																			    /*'There is a latest release available! Click here to see the details. Version: <b>V.0.1.1</b>'*/
																																				`You have <b>${revisedQuotationNotification}</b> revised quotation${revisedQuotationNotification > 1 ? 's' : ''} awaiting your attention.`
																																			);	$('#RevisequotationNumberHeader').text("Revised Quotations");
																																		} else {
																																			ReviseQuotationNotifyDiv.hide();
																																		}
					} else {
						$("#bellIcon").hide();
						$("#emptyNotifyDiv").show();
						$('#emptyNotificationHeaderMessage').text("Currently there are no notifications");
					}
				}
	</script>
	<input type="hidden" id="emp_idSessionValue" th:value="${empId}" />

	<script>
		$.ajax({
			type: "GET",
			url: "fetchEmployeeDocumentDetailsOnlyByEmpId",
			data: {
				"emp_id": $('#emp_idSessionValue').val()
			},
			success: function (data) {
				$('#dynamicProfilePic').attr('src', `${data.profilePicPath}`);
			},
			error: function (xhr, status, error) {
				console.error("Error invoking data:", error);
			}
		});
	</script>

	<div class="chat-app" style="display: none;">
		<div id="plist" class="people-list">
			<div class="input-group mb-3">
				<input type="text" id="searchInputModal" class="form-control" placeholder="Search..."
					aria-label="Search">
				<span class="input-group-text">
					<i class="bi bi-search"></i>
				</span>

			</div>
			<ul id="employeeNames" class="list-unstyled chat-list mt-2 mb-0">
				<!-- Employee names will be dynamically populated here -->
			</ul>
		</div>

		<div class="chat">
			<div class="chat-header clearfix">
				<div class="row w-100">

					<!-- Employee Photo and Name Section -->
					<div class="col-lg-6 d-flex align-items-center">
						<div class="chat-about d-flex align-items-center">
							<img id="employeePhoto" class="employee-photo" src="default-avatar.png"
								alt="Employee Photo" />
							<h6 class="m-b-0 ml-2" id="employeeName">Select an Employee</h6>
						</div>
					</div>
					<!-- Right aligned three dots (Vertical) -->
					<div class="col-lg-6 text-right">
						<div class="dropdown custom-dropdown">
							<button class="btn btn-outline-secondary" type="button" id="dropdownMenuButton"
								data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fa fa-ellipsis-v"></i>
							</button>
							<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
								<li><a class="dropdown-item" href="#">Delete Chat</a></li>
								<li><a class="dropdown-item" href="#">Mute</a></li>
								<li><a class="dropdown-item" href="#">Contact Info</a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<div id="chat-window" class="chat-history">
				<ul class="m-b-0">
					<!-- Chat messages will be populated here dynamically -->

				</ul>
				<div id="message-icon-container" class="message-icon" style="display: none;">

					<!-- Plain square message icon SVG (behind) -->
					<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
						<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
						<g id="SVGRepo_iconCarrier">
							<path
								d="M10 9H17M10 13H17M7 9H7.01M7 13H7.01M21 20L17.6757 18.3378C17.4237 18.2118 17.2977 18.1488 17.1656 18.1044C17.0484 18.065 16.9277 18.0365 16.8052 18.0193C16.6672 18 16.5263 18 16.2446 18H6.2C5.07989 18 4.51984 18 4.09202 17.782C3.71569 17.5903 3.40973 17.2843 3.21799 16.908C3 16.4802 3 15.9201 3 14.8V7.2C3 6.07989 3 5.51984 3.21799 5.09202C3.40973 4.71569 3.71569 4.40973 4.09202 4.21799C4.51984 4 5.0799 4 6.2 4H17.8C18.9201 4 19.4802 4 19.908 4.21799C20.2843 4.40973 20.5903 4.71569 20.782 5.09202C21 5.51984 21 6.0799 21 7.2V20Z"
								stroke="#94b7db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
						</g>
					</svg>

					<!-- SVG with animation -->
					<svg class="animated-icon" viewBox="0 0 374 374" fill="none" xmlns="http://www.w3.org/2000/svg">
						<g clip-path="url(#clip0)">
							<path
								d="M318.084 132.622C311.339 101.37 287.642 82 256.652 82C238.423 82 217.459 89.3248 197.954 102.509C191.574 106.904 182.642 106.904 176.079 102.672C155.298 88.9992 135.246 82 116.652 82C85.6626 82 61.9647 101.533 55.2199 133.111C44.2824 183.896 80.923 252.26 187.017 291C292.746 251.446 329.204 183.082 318.084 132.622Z" />
							<path
								d="M187.466 0C187.366 0 187.166 0 186.866 0C85.666 0 3.36603 82.3 3.36603 183.5C3.36603 224.8 17.466 264.9 43.266 297.2L16.566 359.3C14.366 364.4 16.766 370.3 21.766 372.4C23.566 373.2 25.566 373.4 27.466 373.1L125.366 355.9C144.966 363 165.566 366.6 186.366 366.5C287.566 366.5 369.866 284.2 369.866 183C370.066 82.1 288.366 0.1 187.466 0ZM192.966 269.8C188.966 271.3 184.666 271.3 180.666 269.8C149.066 257.1 124.466 238.3 109.466 215.4C95.966 194.7 90.766 171.4 94.866 149.9C100.466 121.4 121.866 102.3 148.266 102.3C160.966 102.3 173.866 106.5 186.766 114.7C199.366 106.5 212.466 102.3 225.066 102.3C251.866 102.3 272.866 120.9 278.466 149.6C286.066 188.8 262.666 241.3 192.966 269.8Z" />
						</g>
						<defs>
							<clipPath id="clip0">
								<rect width="373.232" height="373.232" fill="white" />
							</clipPath>
						</defs>
					</svg>



					<!-- Dots Animation -->
					<div class="dots">
						<div class="dot"></div>
						<div class="dot"></div>
						<div class="dot"></div>
					</div>




				</div>


			</div>
			<!-- Move the paragraph outside the chat window -->
			<p id="logo-text"
				style="text-align: center; font-size: 14px; color: #6c757d; margin-top: 10px; display: none;">
				"Reach out to your colleagues and stay on top of your projects with quick, seamless communication."
			</p>
			<div class="chat-message clearfix">
				<div class="custom-input-group mb-0">
					<input type="text" id="message" class="custom-form-control" placeholder="Enter your message..." />
					<div class="custom-input-group-append">
						<button class="custom-send-btn" onclick="sendMessage()">
							<i class="ri ri-send-plane-2-fill"></i>
						</button>
					</div>
				</div>

			</div>
		</div>
	</div>
	<input type="hidden" th:value="${loggedInUserEmail}" id="loggedInMail">
	<input type="hidden" id="loggedAdminEmpId2" th:value="${empId}">

	<script>
		    function fetchUnreadCount() {
		        console.log("Fetching unread message count...");

		        var userEmailElement = document.getElementById('loggedInMail');
		        if (!userEmailElement) {
		            console.error("Error: #loggedInMail element not found!");
		            return;
		        }

		        var userEmail = userEmailElement.value;
		        console.log("User email:", userEmail);

		        if (!userEmail) {
		            console.warn("No email found, skipping fetch.");
		            return;
		        }

		        fetch(`/unread-count?email=${encodeURIComponent(userEmail)}`)
		            .then(response => {
		                console.log("Response received:", response);
		                return response.json();
		            })
		            .then(count => {
		                console.log("Unread count:", count);

		                const badge = document.getElementById("unreadCountBadge");
						
						
						
		                if (!badge) {
		                    console.error("Error: #unreadCountBadge element not found!");
		                    return;
		                }

		                if (count > 0) {
		                    badge.textContent = count;
		                    badge.style.display = "inline-block";
							
							
		                } else {
		                    badge.style.display = "none";
							
		                }
		            })
		            .catch(error => console.error("Error fetching unread messages:", error));
		    }

		    setInterval(fetchUnreadCount, 5000); // Fetch count every 5 seconds
		    fetchUnreadCount(); // Initial fetch
		</script>

	<script>
		//CODE FOR CHATBOOT NOTIFICATION 
		var stompClient = null;
		var employeeMap = {}; // To store the mapping of employee names to emails
		let employeePhotoMap = {};
		let emailToNameMap = {}; // New map for email -> name lookup
		var email = null;
		var visibilityState = document.visibilityState; // Track tab visibility
		var heartbeatInterval = null; // Track heartbeat interval

		function connectWebSocket() {
			
			var socket = new SockJS('/chat-websocket');
						  stompClient = Stomp.over(socket);

						  var email = document.getElementById('loggedInMail').value;
						  console.log(`Connecting WebSocket as: ${email}`);

						  stompClient.connect({ 'email': email }, function (frame) {
						      console.log('Connected to WebSocket:', frame);

							 // subscribeToTypingEvents();
						      // Mark user as active
						      stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));

						      // Subscribe to active users list
						      stompClient.subscribe('/topic/activeUsers', function (message) {
						          var activeUsers = JSON.parse(message.body);
						          updateActiveUserUI(activeUsers);
						      });
							  // Subscribe to user messages
							        stompClient.subscribe('/user/queue/messages', function (message) {
									//	loadMessages();
									//	alert("po2");
							            console.log('Raw WebSocket Message:11', message);
							            var msg = JSON.parse(message.body);
										//alert(msg);
							            console.log('Parsed Messag111e:', msg);
							            console.log(`Received messagesdsd: ${JSON.stringify(msg)}`);
										//alert("(message.read"+msg.read);
									
							            // Display message if it matches the selected employee
							            if (selectedEmployee === msg.senderEmail || selectedEmployee === msg.recipientEmail) {
											console.log(`New message fromss ${msg.senderEmail}: ${msg.content}`);
											console.log("plk "+selectedEmployee);
											console.log("plk "+msg.senderEmail);
											console.log("plk "+msg.recipientEmail);
											//loadMessages();
							                showMessage(
							                    msg.id,               // Message ID
							                    msg.senderEmail,      // Sender's email
							                    msg.content,          // Message content
							                    msg.recipientEmail,   // Recipient's email
							                    msg.timestamp,        // Message timestamp
							                    email,
												msg.read                    // Logged-in user's email
							                );
							            }
								
										loadEmployees();
										loadMessages();
									 	
							        });

							        // Subscribe to notifications
							        stompClient.subscribe('/user/queue/notifications', function (notification) {
										//alert("00");
							            console.log('New Notification:', notification.body);
							            showToastNotification(notification.body);
										loadEmployees();
										//alert("01");
							        });

									//alert("Subscribing to chat updates...");
									stompClient.subscribe('/user/queue/messages', function (message) {
									    console.log('WebSocket Chat Update Received:', message.body); // Log raw message

									    let parsedMessage = JSON.parse(message.body);
									    console.log('Parsed Message:', parsedMessage); // Log parsed JSON

									    if (Array.isArray(parsedMessage)) {
									        parsedMessage.forEach(msg => {
									            console.log(`Message ID: ${msg.id}, Read: ${msg.read}`);
									            if (msg.read) {
									                updateMessageUI(msg);
									            }
									        });
									    } else {
									        console.log("Unexpected message format:", parsedMessage);
									    }

									    // Refresh messages after a delay
									    setTimeout(() => {
									        console.log("Refreshing messages...");
									        loadMessages();
									    }, 3000);
									});

									stompClient.subscribe('/topic/typing', function (message) {
									    console.log("üì© Typing notification received:", message.body);

									    let typingData;
									    try {
									        typingData = JSON.parse(message.body);
									        console.log("‚úÖ Parsed Typing Data:", typingData);
									    } catch (error) {
									        console.error("‚ùå Error parsing typing notification message:", error);
									        return;
									    }

									    let loggedInUserEmail = document.getElementById('loggedInMail')?.value;
									    if (!loggedInUserEmail) return;

									    if (loggedInUserEmail === typingData.recipientEmail && typingData.senderEmail === selectedEmployee) {
									        // Fetch actual typing status from the backend
									        fetch(`/getTypingStatus?senderEmail=${typingData.senderEmail}&recipientEmail=${typingData.recipientEmail}`)
									            .then(response => response.json())
									            .then(data => {
									                console.log("üéØ Actual Typing Status from DB:", data.typing);
													console.log("üéØ Actual Typing Status from DB:", data);
													                console.log("‚ÑπÔ∏è Typing Status (0 or 1):", data.typing);
													                
									                let chatMessages = document.querySelector(".chat-history ul");
									                let chatContainer = document.querySelector(".chat-history"); // The scrollable chat area

									                let typingIndicator = document.getElementById("typingIndicator");
									                
									                if (!typingIndicator) {
									                    typingIndicator = document.createElement("li");
									                    typingIndicator.id = "typingIndicator";
									                    typingIndicator.classList.add("typing-indicator");
									                    typingIndicator.innerHTML = `
									                        <img src="${employeePhotoMap[selectedEmployee] || 'default-profile.jpg'}" alt="User Photo" class="typing-photo">
									                        <span>Typing...</span>
									                    `;
									                    chatMessages.appendChild(typingIndicator);
									                }

									                if (data.typing === 1) { // Ensure it checks the latest typing status
									                    typingIndicator.style.display = "flex";

									                    // Move typing indicator to the bottom
									                    chatMessages.appendChild(typingIndicator);

									                    // Auto-scroll to the bottom
									                    setTimeout(() => {
									                        chatContainer.scrollTop = chatContainer.scrollHeight;
									                    }, 100);
									                } else {
									                    typingIndicator.style.display = "none";
									                }
									            })
									            .catch(error => console.error("‚ùå Error fetching typing status:", error));
									    }
									});


						      // Start heartbeat initially
						      heartbeatInterval = setInterval(() => {
						          if (stompClient && stompClient.connected) {
						              stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
						              console.log("Heartbeat sent for user: " + email);
						          }
						      }, 20000); // 30 seconds

						      // Detect tab visibility change
						  /*    document.addEventListener("visibilitychange", function () {
						          if (document.hidden) {
						              console.log("User switched to another tab. Marking as inactive.");
						              stompClient.send("/app/userInactive", {}, JSON.stringify({ email }));
						              clearInterval(heartbeatInterval); // Stop heartbeat
						              heartbeatInterval = null;
						          } else {
						              console.log("User returned to the application tab. Marking as active.");
						              stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));
						              if (!heartbeatInterval) {
						                  heartbeatInterval = setInterval(() => {
						                      if (stompClient && stompClient.connected) {
						                          stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
						                          console.log("Heartbeat sent for user: " + email);
						                      }
						                  }, 30000);
						              }
						          }
						      });*/

						      // Detect tab close or WebSocket disconnect
						      socket.onclose = function () {
						          console.log("WebSocket disconnected. Updating user status.");
						          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
						      };

						      window.addEventListener('beforeunload', function () {
						          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
						      });

						  });
		}

		function updateActiveUserUI(activeUsers) {
		//	alert("1");
		    const employeeItems = document.getElementById('employeeNames').getElementsByTagName('li');

		    Array.from(employeeItems).forEach(item => {
		        const employeeName = item.querySelector('span').textContent;
		        const email = employeeMap[employeeName]; 
		        const statusIndicator = item.querySelector('.status-indicator'); // Get the status dot

		        if (activeUsers.includes(email)) {
		            item.classList.add('active-user');
		            statusIndicator.style.backgroundColor = '#66cc66'; // Green for active users
		        } else {
		            item.classList.remove('active-user');
		            statusIndicator.style.backgroundColor = '#ff6666'; // Red for inactive users
		        }

		        // If this employee is currently selected, update chat header status
				if (selectedEmployee === email) {
				           const chatStatusIndicator = document.getElementById('chatStatusIndicator');
				           if (activeUsers.includes(email)) {
				               chatStatusIndicator.style.backgroundColor = '#66cc66'; // Green (Online)
				           } else {
				               chatStatusIndicator.style.backgroundColor = '#ff6666'; // Red (Offline)
				           }
				       }
		    });
		}


		// Select an employee to chat with
		function selectEmployee(employeeName) {
			selectedEmployee = employeeMap[employeeName]; // Get the email from the map
			console.log(`Employee selected: ${selectedEmployee}`);

			// Highlight the selected employee
			var employeeItems = document.querySelectorAll('#employeeNames li');
			employeeItems.forEach(function (item) {
				item.classList.remove('active');
			});
			var selectedItem = Array.from(employeeItems).find(item => item.innerHTML === employeeName);
			if (selectedItem) {
				selectedItem.classList.add('active');
			}

			// Update chat header with employee name and photo
			document.querySelector('.chat-about h6').innerText = employeeName;
			document.querySelector('#employeePhoto').src = employeePhotoMap[selectedEmployee] || 'default-profile.jpg';

			// Hide the message icon and dots when an employee is selected
			document.getElementById('message-icon-container').style.display = 'none';
			// Hide the paragraph when an employee is selected
			document.getElementById('logo-text').style.display = 'none';

			// Load messages for the selected employee
			loadMessages();
		}

		function loadEmployees() {
			console.log("Loading employee names...");

			// Fetch employee names from the endpoint
			fetch('/employees/names')
				.then(response => {
					console.log("Response received:", response);
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then(data => {
					console.log("Employee data fetched:", data); // Log the raw data

					const employeeList = document.getElementById('employeeNames');
					if (!employeeList) {
						console.error("Element with ID 'employeeNames' not found.");
						return;
					}

					employeeList.innerHTML = ''; // Clear the list before adding new items

					// Iterate through employee data
					data.forEach(employee => {
						console.log("Processing employee:", employee);

						// Create a list item for each employee
						const li = document.createElement('li');
						li.classList.add('d-flex', 'align-items-center', 'employee-item');

						// Handle missing or empty profile photo paths
						const profilePic = employeePhotoMap[employee.email] || '/static/default-profile.jpg';
						console.log(`Profile picture for ${employee.name}: ${profilePic}`);

						li.innerHTML = `
			                    <img src="${profilePic}" 
			                         alt="Employee Photo" 
			                         class="employee-photo mr-2" />
			                    <span>${employee.name}</span>
			                `;

						// Map employee name to email
						employeeMap[employee.name] = employee.email;
						console.log("Mapped employee:", employee.name, "->", employee.email);
						// Add new reverse mapping (email -> name)
						emailToNameMap[employee.email] = employee.name;
						// Add click event to list item
						li.onclick = () => {
							console.log(`Selected employee: ${employee.name}`);
							selectEmployee(employee.name);
						};

						// Append the list item to the employee list
						employeeList.appendChild(li);

					});

					console.log("Employee names loaded successfully. Employee map:", employeeMap);
					// Call the unread messages function after loading employee data
					fetchUnreadMessages();

					// Set interval to check for new messages every 10 seconds
						setInterval(fetchUnreadMessages, 10000);
				})
				.catch(error => {
					console.error("Error loading employees:", error);
				});
		}


		function loadMessages() {
			// alert("Loading messages...");
			// Get the logged-in user's email and selected employee's email
			var loggedInEmail = document.getElementById('loggedInMail').value;
			var selectedEmployeeEmail = selectedEmployee; // Email is already stored in selectedEmployee

			console.log(`Loading messages between: ${loggedInEmail} and ${selectedEmployeeEmail}`);

			fetch(`/messages?loggedInEmail=${encodeURIComponent(loggedInEmail)}&selectedEmployeeEmail=${encodeURIComponent(selectedEmployeeEmail)}`)
				.then(response => response.json())
				.then(data => {
					console.log("Chat messages loaded:", data);
					// Clear the chat window before displaying messages
					var chatWindow = document.getElementById('chat-window').querySelector('ul');
					chatWindow.innerHTML = '';

					// Display messages
					data.forEach(function (msg) {
						// showMessage(msg.senderEmail, msg.content, msg.recipientEmail, loggedInEmail);
						showMessage(msg.id, msg.senderEmail, msg.content, msg.recipientEmail, msg.timestamp, loggedInEmail);
					});
				})
				.catch(error => console.error("Error loading chat messages:", error));
		}
		let activeDeleteDropdown = null;
		function showMessage(id, senderEmail, message, recipientEmail, timestamp, loggedInEmail) {
			console.log("Message ID:", id);
			console.log(`LoggedInEmailrrr: ${loggedInEmail}, SenderEmail: ${senderEmail}`);

			const isSender = senderEmail === loggedInEmail;
			const senderName = isSender ? "Me" : Object.keys(employeeMap).find(name => employeeMap[name] === senderEmail) || senderEmail;
			const senderPhoto = employeePhotoMap[senderEmail] || 'default-avatar.png';
			const formattedTime = new Date(timestamp).toLocaleString(); // Format timestamp

			console.log(`Message ID: ${id}, Time: ${formattedTime}, From: ${senderEmail}, To: ${recipientEmail}, Content: "${message}"`);

			var chatWindow = document.getElementById('chat-window').querySelector('ul');
			var li = document.createElement('li');
			li.className = isSender ? 'clearfix right' : 'clearfix left';

			li.innerHTML = `
					    <div class="message-container" data-message-id="${id}" onclick="toggleDeleteOption(this)">
					        <img class="sender-photo" src="${senderPhoto}" alt="Sender Photo" />
					        <div class="message ${isSender ? 'my-message' : 'other-message'}">
					            <strong>${senderName}:</strong> ${message}
					        </div>
					    </div>
					    <div class="timestamp" style="text-align: ${isSender ? 'right' : 'left'};">
					        ${formattedTime}
					    </div>
					    ${isSender ? `
					        <div class="message-action-dropdown" >
					            <a class="dropdown-item" href="#" onclick="deleteMessage(this, ${id})">Delete Message</a>
					        </div>
					    ` : ''}`;

			chatWindow.appendChild(li);
			chatWindow.scrollTop = chatWindow.scrollHeight;
		}
		
		/*function fetchUnreadMessages() {
			console.log("Fetching unread messages...");
			var loggedInEmail = document.getElementById('loggedInMail').value;

			fetch(`/unread?email=${loggedInEmail}`)
				.then(response => response.json())
				.then(messages => {
					messages.forEach(message => {
						let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;

						// Show notification with sender's email as a parameter
						showToastNotification(`New message from ${senderName}: ${message.content}`, message.senderEmail);
					});
				})
				.catch(error => console.error("Error fetching unread messages:", error));
		}*/

		let displayedMessageIds = new Set(); // Track displayed messages
		let closedMessageIds = new Set(); // Track closed messages

		function fetchUnreadMessages() {
		    console.log("Fetching unread messages...");
		    var loggedInEmail = document.getElementById('loggedInMail').value;

		    fetch(`/unread?email=${loggedInEmail}`)
		        .then(response => response.json())
		        .then(messages => {
		            messages.forEach(message => {
		                console.log("Processing message ID:", message.id); // Print message ID to console
		                
		                // Ignore messages that were previously closed
		                if (!displayedMessageIds.has(message.id) && !closedMessageIds.has(message.id)) {
							//alert(1);
		                    let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;
		                    showToastNotification(`New message from ${senderName}: ${message.content}`, message.id, message.senderEmail);
		                    displayedMessageIds.add(message.id); // Mark message as displayed
		                }
						//alert(2);
		            });
		        })
		        .catch(error => console.error("Error fetching unread messages:", error));
		}
		// Global flag to track if the user manually dismissed notifications
		
		/*function showToastNotification(message, senderEmail) {
			
			var toastContainer = document.createElement('div');
			toastContainer.className = 'toast-notification';

			// Add message and close button
			toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close">‚úñ</span>`;

			document.body.appendChild(toastContainer);

			// Animate in
			setTimeout(() => {
				toastContainer.classList.add('show');
			}, 100);

			// Auto-hide after 8 seconds
			let autoHideTimeout = setTimeout(() => closeToast(toastContainer), 10000);

			// Prevent opening chat when clicking the close button
			toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
				event.stopPropagation(); // Prevent click from bubbling to toastContainer
				clearTimeout(autoHideTimeout);
				
				closeToast(toastContainer);
			});

			// Open chat when clicking on the notification
			toastContainer.addEventListener('click', () => {
				openChatWithSender(senderEmail);
				closeToast(toastContainer); // Remove notification when chat opens
			});
		}*/
		let displayedMessageIdsonreload = new Set(JSON.parse(sessionStorage.getItem("displayedNotifications")) || []);

		function showToastNotification(message, messageId, senderEmail) {
			//alert(1);
			if (displayedMessageIdsonreload.has(messageId)) {
						       return; // Skip if already shown
						   }

						   displayedMessageIdsonreload.add(messageId);
						   sessionStorage.setItem("displayedNotifications", JSON.stringify([...displayedMessageIdsonreload]));

		    var toastContainer = document.createElement('div');
		    toastContainer.className = 'toast-notification';
		    toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close">‚úñ</span>`;

		    document.body.appendChild(toastContainer);

		    // Animate in
		    setTimeout(() => {
		        toastContainer.classList.add('show');
		    }, 100);

		    // Auto-hide after 8 seconds
		    let autoHideTimeout = setTimeout(() => closeToast(toastContainer, messageId), 8000);

		    // Prevent opening chat when clicking the close button
		    toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
		        event.stopPropagation(); // Prevent click from bubbling to toastContainer
		        clearTimeout(autoHideTimeout);
		        closedMessageIds.add(messageId); // Mark as closed so it won't be shown again
		        closeToast(toastContainer, messageId);
		    });

		    // Open chat when clicking on the notification
		    toastContainer.addEventListener('click', () => {
		        openChatWithSender(senderEmail);
		        closeToast(toastContainer, messageId); // Remove notification when chat opens
		    });
		}

		// Function to handle toast closing
		/*function closeToast(toast) {
			toast.classList.remove('show');
			setTimeout(() => toast.remove(), 300); // Faster fade-out
		}*/
		// Function to handle toast closing and mark as dismissed
		// Function to handle toast closing
		function closeToast(toast, messageId) {
		    toast.classList.remove('show');
		    setTimeout(() => toast.remove(), 300); // Faster fade-out
		}
		/*	function openChatWithSender(senderEmail) {
				console.log("Opening chat with:", senderEmail);
			    
				// Construct the URL for the UserFavorite page with the senderEmail as a query parameter
				const url = `/my-favorites?email=${encodeURIComponent(senderEmail)}`;
			    
				// Redirect to the UserFavorite page
				window.location.href = url;
			}*/

		function openChatWithSender(senderEmail) {
			console.log("Opening chat with:", senderEmail);

			// Store sender email in sessionStorage
			sessionStorage.setItem("chatSenderEmail", senderEmail);

			// Redirect to the UserFavorite page
			window.location.href = `/my-favorites`;
		}

		// Connect to the WebSocket server and load employees when the page is loaded
		document.addEventListener('DOMContentLoaded', function () {
			//fetchUnreadMessages();
			loadEmployees();
			connectWebSocket();
		});

	</script>
<!-- script to focuse the side nav link when page gets loaded -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let activeLink = document.querySelector(".nav-link.active");
        if (activeLink) {
            activeLink.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    });
</script>
</body>

</html>

	