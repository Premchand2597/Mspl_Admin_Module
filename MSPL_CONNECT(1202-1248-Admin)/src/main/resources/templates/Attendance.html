<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Attendence</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  
 <!--  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- SweetAlert2 Library -->
  
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  <script defer src="https://unpkg.com/alpinejs@3.2.1/dist/cdn.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
		/* Hide the vertical scrollbar for the whole page */
		.card {
			border: 1px solid #ddd;
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 20px;
		}

		.info-card {
			background-color: #fff;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		#attendence-chart {
			width: 100%;
			height: 190px;
			/* Adjust the height as needed */
		}

		/* Example CSS to style disabled items */
		.activity-item .disabled {
			pointer-events: none;
			/* Disable interactions */
			opacity: 0.5;
			/* Make the item appear grayed out */
		}

		.card-container {
			margin-top: 10px;
		}

		.card {
			margin-bottom: 40px;
		}

		.btn-light-custom {
			background-color: #f8f9fa;
			/* Light background color */
			color: #333;
			/* Dark text color */
			border: 1px solid #ddd;
			/* Light border color */
		}

		.btn-light-custom:hover {
			background-color: #e2e6ea;
			/* Slightly darker background on hover */
		}

		.btn-border-custom-sm {
			border: 1px solid #d1d1d1;
			/* Light grey border */
			padding: 0.25rem 0.5rem;
			/* Adjust padding for smaller button */
			font-size: 0.875rem;
			/* Adjust font size */
			border-radius: 0.2rem;
			/* Optional: Adjust border radius */
		}

		/* Custom CSS for modal */
		.modal-dialog-scrollable {
			max-height: calc(100vh - 1rem);
			/* Adjust as needed */
		}

		.modal-body {
			max-height: calc(100vh - 180px);
			/* Adjust based on your modal header and footer height */
			overflow-y: auto;
		}

	    #modalAttendanceTable thead th {
			background-color: #E9EAEC !important;
			/* Background color for table headers */
			color: black;
			/* Text color for table headers */
		}

		#modalTable thead th {
			background-color: #E9EAEC !important;
			/* Background color for table headers */
			color: black;
			/* Text color for table headers */
		}

		.details-table thead th {
			background-color: #E9EAEC;
			/* Background color for table headers */
			color: #000000;
		}

		#holidayTable thead th {
			background-color: #E9EAEC;
			color: #000000;
		}


		#modalMonthlyAttendanceTable thead th {
			background-color: #E9EAEC;
			color: #000000;
		}

		.highlight-today {
			background-color: #ffff00 !important;
			/* Yellow color for highlight */
			color: #000;
			/* Ensure text color is readable */
			font-weight: bold;
			/* Optional: makes the text stand out */
		}

		.bg-gray-200 {
			background-color: #d3d3d3;
			/* Light gray color */
		}

		.compact-card-body {
			padding: 10px;
			/* Decrease the padding as needed */
			margin: -10px;
			/* Optional: Remove any margins if needed */
		}

		/* You may also want to adjust margins and padding for the content within the card-body */
		.compact-card-body .nav-tabs {
			margin-bottom: 0px;
			/* Adjust as needed */
		}

		.compact-card-body .tab-content {
			margin-top: 0px;
			/* Adjust as needed */
		}

		#requestLeaveModal + .modal-backdrop {
		    z-index: 1050 !important;
		}

	
				/* Fullscreen overlay with dim background */
				#loadingPopup {
				    position: fixed;
				    top: 0;
				    left: 0;
				    width: 100%;
				    height: 100%;
				    background: rgba(0, 0, 0, 0.5); /* Dim background */
				    display: flex;
				    flex-direction: column;
				    justify-content: center;
				    align-items: center;
				    z-index: 9999;
				    font-family: Arial, sans-serif;
				    color: white; /* Text color for better contrast */
				}
				
				/* Spinner animation */
				.spinner {
				    width: 50px;
				    height: 50px;
				    border: 6px solid rgba(255, 255, 255, 0.3); /* Semi-transparent border */
				    border-top-color: white; /* Bright top border */
				    border-radius: 50%;
				    animation: spin 1s linear infinite;
				}
				
				/* Loading text */
				#loadingPopup p {
				    margin-top: 20px;
				    font-size: 18px;
				    font-weight: bold;
				    color: white;
				}
				
				/* Spinner keyframe animation */
				@keyframes spin {
				    to {
				        transform: rotate(360deg);
				    }
				}
				
				#performanceChartContainer {
				    display: none;
				}

				#quarterlyChartContainer{
					display:none;
				}
				.dot {
				    width: 0.5rem; /* Smaller width */
				    height: 0.5rem; /* Smaller height */
				    background-color: #facc15; /* Yellow-500 */
				    border-radius: 50%;
				    position: absolute;
				    top: 0;
				    left: 0; /* Move dot to the left side */
				    transform: translate(3px, 1px); /* Adjust positioning */
				}
			
				.bg-absence {
					background-color: #ffe4c4;
				}

			
			 /* Half-day circle with half green and half red */
		      .half-day-circle {
		          width: 18px;
		          height: 18px;
		          border-radius: 50%;
		          background: conic-gradient(green 0% 50%, red 50% 100%);
		          display: inline-block;
		          position: absolute;
		          top: 0;
		          right: 0;
		          transform: translate(3px, 3px);
		      }
		      
		     	   .bg-halfDay {
						background: linear-gradient(to right, #d1fae5 50%, transparent 50%);
					}
			
					.bg-firstHalfDay {
						background: linear-gradient(to right, #d1fae5 50%, #fecaca 50%);
						/* Green on the left, red (same as 'bg-red-100') on the right */
					}
			
					.bg-secondHalfDay {
						background: linear-gradient(to right, #fecaca 50%, #d1fae5 50%);
						/* Red (same as 'bg-red-100') on the left, green on the right */
					}
					.bg-WithinSevenHours {
							background: linear-gradient(to right, #d1fae5 50%, #fecaca 50%);
							/* Red (same as 'bg-red-100') on the left, green on the right */
					}	 				
					
					.ring-blue-400 {
					    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Thinner blue ring effect */
					}			
					.bg-blue-700 {
					    background-color: rgba(59, 130, 246, 0.1); /* Adjust light blue background for a subtler effect */
					    border-radius: 0.5rem; /* Optional rounded corners */
					    /* Reduce padding to make it visually thinner */
					}
					
					.bg-lessThanTwoAndHalf {
						background-color: #fee2e2;
						color: #dc2626 !important;						
					}
					
					.bg-darkGreen{
						background-color: #fee2e2;
						/* Light red background */
						color: #dc2626 !important;
						/* Matches text-red-600 color */
						/* Rounded corners */
					}
	</style>
</head>

<body>
 <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center" th:if="${empDetailsByEmpId.deptId>0}">

   <!--  <div class="app-branding" style="width:100%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/dashboard}>
				        <img class="logo-icon" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
				</div> --><!-- End Logo -->
	
		   <div class="d-flex align-items-center" style="width:100%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/dashboard}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
				    <!-- <i class="bi bi-chevron-double-left toggle-sidebar-btn" onclick="toggleIconRotation()"></i> -->
			</div>
				
   <!--  <div class="search-bar">
      <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Search" title="Enter search keyword">
        <button type="submit" title="Search"><i class="bi bi-search"></i></button>
      </form>
    </div> --><!-- End Search Bar -->

	<div th:replace="fragments/header :: header" ></div>
	
  </header><!-- End Header -->
  
  <!-- =======Super Admin Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center" th:if="${empDetailsByEmpId.deptId == 0}">

    <div class="d-flex align-items-center" style="width:100%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/dashboard}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
				    <!-- <i class="bi bi-chevron-double-left toggle-sidebar-btn" onclick="toggleIconRotation()"></i> -->
	</div><!-- End Logo -->

    <!-- <div class="search-bar">
      <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Search" title="Enter search keyword">
        <button type="submit" title="Search"><i class="bi bi-search"></i></button>
      </form>
    </div> --><!-- End Search Bar -->

    <div th:replace="fragments/superAdminHeader :: header"></div>

  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
  
<aside id="sidebar" class="sidebar">
<input type="hidden" id="employee-id" th:value="${empDetailsByEmpId.deptId}">
<input type="hidden" id="employeeId1" name="empId" th:value="${empDetailsByEmpId.empid}" />
<input type="hidden" id="loggedEmpEmail" th:value="${empDetailsByEmpId.email}">

    <ul class="sidebar-nav" id="sidebar-nav">
		 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/userDashboard}">
                <i class="bi bi-grid"></i>
                <span>Dashboard	</span>
            </a>
        </li>
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminProfile(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-person"></i>
                 <span>My Profile</span>
            </a>
        </li>  
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:classappend="${empDetailsByEmpId.email == loogedAdminDetailsByEmpId.email ? 'active' : ''}" th:href="@{/attendanceLive(email=${empDetailsByEmpId.email})}">
                <i class="bi bi-calendar3"></i>
                <span>Attendence</span>
            </a> 
        </li>      
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link " th:href="@{/groupMailId}">
                <i class="bi bi-telephone"></i>
                <span>Employee Contacts</span>
            </a>
        </li>
        <!-- <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link " th:href="@{/InterCommDetails}">
                <i class="bi bi-telephone"></i>
                <span>InterComm Details</span>
            </a>
        </li> -->
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/adminHoliday}">
                <i class="bi bi-calendar4-week"></i>
                <span>Holiday List</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
		    <a class="nav-link" th:classappend="${empDetailsByEmpId.email != loogedAdminDetailsByEmpId.email ? 'active' : ''}" th:href="@{/employee}">
		        <i class="bi bi-people"></i>	
		        <span>Employee</span>
		    </a>
	   </li> 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-card-text"></i>
                <span>Team Leaves</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/events}">
                <i class="bi bi-megaphone"></i>
                <span>Announcement</span>
            </a>
        </li>               
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/asset}">
                <i class="bi bi-wallet"></i>
                <span>Assets</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/ongoingProject}">
                <i class="bi bi-card-heading"></i>
                <span>Projects</span>
            </a>
        </li>   
        <!--  <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminPayslip(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-file-text"></i>
                <span>Payslip</span>
            </a>
        </li>    -->  
         <!-- Loop through the permissions map -->
       <li class="nav-item" th:if="${permissions.interviewAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.sales && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.accountsAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" th:href="@{/store}">
                <i class="bi bi-shop-window"></i>
                <span>Store</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.apprisalAccess && empDetailsByEmpId.deptId>0}" >
            <a class="nav-link" id="apprisalLink" th:href="@{/apprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Appraisal</span>
		    </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
		    <a class="nav-link" id="apprisalLink" th:href="@{/employeeApprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Employee Appraisal</span>
		    </a>
		</li>
		<li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
				<a class="nav-link" th:href="@{/my-favorites}">
					<i class="bi bi-layout-text-window-reverse"></i>
					<span>To-Chat & Remind</span><span id="unreadCountBadge" class="badge bg-primary" style="display: none;"></span>
				</a>
		</li>
		<li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId>0}">
					    <a class="nav-link" th:href="@{/releasenotes}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					            Release Note 
					            <span class="version-number">(0.1.1)</span>
					        </span>
					    </a>
		</li>
		
		
		
		
		
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link " th:href="@{/navbar}">
		        <i class="bi bi-grid"></i>
		        <span>Dashboard</span>
		    </a>
	    </li>
	    <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link" th:classappend="${empDetailsByEmpId.deptId==0} ? ' active'" th:href="@{/attendanceLive(email=${empDetailsByEmpId.email})}">
                <i class="bi bi-calendar3"></i>
                <span>Attendence</span>
            </a>
      </li> 
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/adminHoliday}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Holiday List</span>
		    </a>
	 </li>	
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/groupMailId}">
		        <i class="bi bi-telephone"></i>
		        <span>Employee Contacts</span>
		    </a>
	 </li>
	  <!-- <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link" th:href="@{/InterCommDetails}">
                <i class="bi bi-telephone"></i>
                <span>InterComm Details</span>
            </a>
      </li> -->
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link"  th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Team Leaves</span>
		    </a>
	 </li> 
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/events}">
		        <i class="bi bi-megaphone"></i>
		        <span>Announcement</span>
		    </a>
	 </li> 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/addDepartment}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Department</span>
		    </a>
	   </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link"  th:href="@{/addRole}">
		        <i class="bi bi-receipt"></i>
		        <span>Role</span>
		    </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link" th:href="@{/employee}">
		        <i class="bi bi-people"></i>
		        <span>Employee</span>
		    </a>
	 </li> 
	 
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/ongoingProject}">
                <i class="bi bi-calendar3"></i>
                <span>Projects</span>
            </a>
      </li>  
      <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
            <a class="nav-link"  th:href="@{/asset}">
                <i class="bi bi-wallet"></i>
                <span>Assets</span>
            </a>
      </li> 
      <li class="nav-item" th:if="${permissions.interviewAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.sales && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.accountsAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}" >
            <a class="nav-link" th:href="@{/store}">
                <i class="bi bi-shop-window"></i>
                <span>Store</span>
            </a>
        </li>  
        <li class="nav-item" th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}">
				<a class="nav-link" th:href="@{/my-favorites}">
					<i class="bi bi-layout-text-window-reverse"></i>
					<span>To-Chat & Remind</span><span id="unreadCountBadge" class="badge bg-primary" style="display: none;"></span>
				</a>
		</li> 
		<li class="nav-item new-feature"  th:if="${permissions.storeAccess && empDetailsByEmpId.deptId==0}">
					    <a class="nav-link" th:href="@{/releasenotes}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					            Release Note 
					            <span class="version-number">(0.1.1)</span>
					        </span>
					    </a>
		</li>
    </ul>
</aside>
<div class="chat-app" style="display: none;">
                <div id="plist" class="people-list">
                        <div class="input-group mb-3">
                                <input type="text" id="searchInputModal" class="form-control" placeholder="Search..."
                                        aria-label="Search">
                                <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                </span>

                        </div>
                        <ul id="employeeNames" class="list-unstyled chat-list mt-2 mb-0">
                                <!-- Employee names will be dynamically populated here -->
                        </ul>
                </div>

                <div class="chat">
                        <div class="chat-header clearfix">
                                <div class="row w-100">

                                        <!-- Employee Photo and Name Section -->
                                        <div class="col-lg-6 d-flex align-items-center">
                                                <div class="chat-about d-flex align-items-center">
                                                        <img id="employeePhoto" class="employee-photo" src="default-avatar.png"
                                                                alt="Employee Photo" />
                                                        <h6 class="m-b-0 ml-2" id="employeeNameForChatBoot">Select an Employee</h6>
                                                </div>
                                        </div>
                                        <!-- Right aligned three dots (Vertical) -->
                                        <div class="col-lg-6 text-right">
                                                <div class="dropdown custom-dropdown">
                                                        <button class="btn btn-outline-secondary" type="button" id="dropdownMenuButton"
                                                                data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="fa fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                                                <li><a class="dropdown-item" href="#">Delete Chat</a></li>
                                                                <li><a class="dropdown-item" href="#">Mute</a></li>
                                                                <li><a class="dropdown-item" href="#">Contact Info</a></li>
                                                        </ul>
                                                </div>
                                        </div>
                                </div>
                        </div>
                        <div id="chat-window" class="chat-history">
                                <ul class="m-b-0">
                                        <!-- Chat messages will be populated here dynamically -->

                                </ul>
                                <div id="message-icon-container" class="message-icon" style="display: none;">

                                        <!-- Plain square message icon SVG (behind) -->
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                                <g id="SVGRepo_iconCarrier">
                                                        <path
                                                                d="M10 9H17M10 13H17M7 9H7.01M7 13H7.01M21 20L17.6757 18.3378C17.4237 18.2118 17.2977 18.1488 17.1656 18.1044C17.0484 18.065 16.9277 18.0365 16.8052 18.0193C16.6672 18 16.5263 18 16.2446 18H6.2C5.07989 18 4.51984 18 4.09202 17.782C3.71569 17.5903 3.40973 17.2843 3.21799 16.908C3 16.4802 3 15.9201 3 14.8V7.2C3 6.07989 3 5.51984 3.21799 5.09202C3.40973 4.71569 3.71569 4.40973 4.09202 4.21799C4.51984 4 5.0799 4 6.2 4H17.8C18.9201 4 19.4802 4 19.908 4.21799C20.2843 4.40973 20.5903 4.71569 20.782 5.09202C21 5.51984 21 6.0799 21 7.2V20Z"
                                                                stroke="#94b7db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                </g>
                                        </svg>

                                        <!-- SVG with animation -->
                                        <svg class="animated-icon" viewBox="0 0 374 374" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <g clip-path="url(#clip0)">
                                                        <path
                                                                d="M318.084 132.622C311.339 101.37 287.642 82 256.652 82C238.423 82 217.459 89.3248 197.954 102.509C191.574 106.904 182.642 106.904 176.079 102.672C155.298 88.9992 135.246 82 116.652 82C85.6626 82 61.9647 101.533 55.2199 133.111C44.2824 183.896 80.923 252.26 187.017 291C292.746 251.446 329.204 183.082 318.084 132.622Z" />
                                                        <path
                                                                d="M187.466 0C187.366 0 187.166 0 186.866 0C85.666 0 3.36603 82.3 3.36603 183.5C3.36603 224.8 17.466 264.9 43.266 297.2L16.566 359.3C14.366 364.4 16.766 370.3 21.766 372.4C23.566 373.2 25.566 373.4 27.466 373.1L125.366 355.9C144.966 363 165.566 366.6 186.366 366.5C287.566 366.5 369.866 284.2 369.866 183C370.066 82.1 288.366 0.1 187.466 0ZM192.966 269.8C188.966 271.3 184.666 271.3 180.666 269.8C149.066 257.1 124.466 238.3 109.466 215.4C95.966 194.7 90.766 171.4 94.866 149.9C100.466 121.4 121.866 102.3 148.266 102.3C160.966 102.3 173.866 106.5 186.766 114.7C199.366 106.5 212.466 102.3 225.066 102.3C251.866 102.3 272.866 120.9 278.466 149.6C286.066 188.8 262.666 241.3 192.966 269.8Z" />
                                                </g>
                                                <defs>
                                                        <clipPath id="clip0">
                                                                <rect width="373.232" height="373.232" fill="white" />
                                                        </clipPath>
                                                </defs>
                                        </svg>



                                        <!-- Dots Animation -->
                                        <div class="dots">
                                                <div class="dot"></div>
                                                <div class="dot"></div>
                                                <div class="dot"></div>
                                        </div>




                                </div>


                        </div>
                        <!-- Move the paragraph outside the chat window -->
                        <p id="logo-text"
                                style="text-align: center; font-size: 14px; color: #6c757d; margin-top: 10px; display: none;">
                                "Reach out to your colleagues and stay on top of your projects with quick, seamless communication."
                        </p>
                        <div class="chat-message clearfix">
                                <div class="custom-input-group mb-0">
                                        <input type="text" id="message" class="custom-form-control" placeholder="Enter your message..." />
                                        <div class="custom-input-group-append">
                                                <button class="custom-send-btn" onclick="sendMessage()">
                                                        <i class="ri ri-send-plane-2-fill"></i>
                                                </button>
                                        </div>
                                </div>

                        </div>
                </div>
        </div>
        <input type="hidden" th:value="${empDetailsByEmpId.email}" id="loggedInMail">
<!-- End Sidebar-->
<input type="hidden" id="emp_idSessionValue" th:value="${empDetailsByEmpId.empid}">
	<!-- Hidden element to store attendance permission -->
	<div id="attendancePermission" style="display:none;" th:attr="data-attendance-permission=${attendancePermission}">
	</div>

							<!-- Leave Request Modal -->
							<!-- <div class="modal fade" id="requestLeaveModal" tabindex="-1" aria-labelledby="requestLeaveModalLabel" aria-hidden="true">
							    <div class="modal-dialog custom-modal-dialog">
							        <div class="modal-content">
							            <div class="modal-header">
							                <h5 class="modal-title" id="requestLeaveModalLabel">Request Leave</h5>
							                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							            </div>
							            <div class="modal-body">
							                Leave Request Form
							                <form id="leaveForm">
							                    Leave Duration Selection
							                    <div class="mb-3">
							                        <label>Leave Duration</label>
							                        <div class="d-flex align-items-center">
							                            <div class="form-check me-3">
							                                <input class="form-check-input" type="radio" name="leaveDuration" id="fullDay" value="Full Day" checked>
							                                <label class="form-check-label" for="fullDay">Full Day</label>
							                            </div>
							                            <div class="form-check">
							                                <input class="form-check-input" type="radio" name="leaveDuration" id="halfDay" value="Half Day">
							                                <label class="form-check-label" for="halfDay">Half Day</label>
							                            </div>
							                        </div>
							                    </div>

							                    Date Fields Side by Side
							                    <div class="row mb-2">
							                        <div class="col">
							                            <label for="fromDate">From</label>
							                            <input type="date" id="fromDate" class="form-control" name="fromDate" required>
							                        </div>
							                        <div class="col">
							                            <label for="toDate">To</label>
							                            <input type="date" id="toDate" class="form-control" name="toDate" required>
							                        </div>
							                    </div>

							                    Error Message for Invalid Date Range
							                    <div id="dateError" class="text-danger mb-2" style="display: none;">
							                        <strong>Invalid Date Range:</strong> The "To Date" must be later than or equal to the "From Date".
							                    </div>

							                    <div id="dateOverlap" class="text-danger mb-2" style="display: none;">
							                        <strong>Invalid Date Range:</strong> You have already requested leave for the selected dates.
							                    </div>

							                    Reason for Leave
							                    <div class="form-group mb-2">
							                        <label for="reason">Reason for Leave</label>
							                        <textarea id="reason" rows="3" name="reason" class="form-control" placeholder="Reasons for Leave" required></textarea>
							                    </div>

							                    Leave Type and Out of Station Fields Side by Side
							                    <div class="row mb-2">
							                        <div class="col">
							                            <label for="leaveType">Leave Type</label>
							                            <select id="leaveType" class="form-control custom-select" name="leaveType" required>
							                                Options will be populated dynamically
							                            </select>
							                        </div>
							                        <div class="col">
							                            <label for="outOfStation">Out of Station</label>
							                            <select id="outOfStation" class="form-control" name="out_of_station" required>
							                                <option value="No">No</option>
							                                <option value="Yes">Yes</option>
							                            </select>
							                        </div>
							                    </div>

							                    Available on Phone and Email Access Fields Side by Side
							                    <div class="row mb-2">
							                        <div class="col">
							                            <label for="availableOnPhone">Available on Phone</label>
							                            <select id="availableOnPhone" class="form-control" name="available_on_phone" required>
							                                <option value="Yes">Yes</option>
							                                <option value="No">No</option>
							                            </select>
							                        </div>
							                        <div class="col">
							                            <label for="emailAccess">Email Access</label>
							                            <select id="emailAccess" class="form-control" name="email_access" required>
							                                <option value="Yes">Yes</option>
							                                <option value="No">No</option>
							                            </select>
							                        </div>
							                    </div>

							                    Designation Field
							                    <div class="form-group mb-2">
							                        <label for="approvingAuthority">Approving Authority</label>
							                        <select id="approvingAuthority" class="form-control" name="approvingAuthority" multiple required>
							                            Options will be populated dynamically
							                        </select>
							                    </div>

							                    Hidden Fields
							                    <div class="form-group mb-2">
							                        <input type="hidden" id="reportingTo" name="reportingTo">
							                    </div>

							                    Submit and Reset Buttons
							                    <div class="form-group mt-4 text-end">
							                        <button type="submit" id="submitBtn" class="btn btn-primary">Submit</button>
							                        <button type="reset" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
							                    </div>
							                </form>
							            </div>
							        </div>
							    </div>
							</div> --><!----->

<input type="hidden" id="employeeEmail1" th:value="${loogedAdminDetailsByEmpId.email}" th:text="${loogedAdminDetailsByEmpId.email}" >

<div id="loadingPopup">
    <div class="spinner"></div>
    <p>Loading please wait...</p>
</div>
  <main id="main" class="main pt-0">
<!-- Feedback Modal -->
			<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
			    <div class="modal-dialog">
			        <div class="modal-content rounded-4 shadow-lg">
			            <div class="modal-header border-0">
			                <h5 class="modal-title" id="feedbackModalLabel">Feedback Form</h5>
			                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			            </div>
			            <div class="modal-body">
			                <form id="feedbackForm" method="post" enctype="multipart/form-data">
			                    <div class="mb-3" style="display: none;">
			                        <label for="feedbackName" class="form-label fw-bold">Your Name</label>
			                        <input type="text" class="form-control" id="feedbackName" name="name" th:value="${empDetailsByEmpId.fullName}" readonly>
			                    </div>
			                    <div class="mb-3" style="display: none;">
			                        <label for="feedbackEmail" class="form-label fw-bold">Your Email</label>
			                        <input type="email" class="form-control" id="feedbackEmail" name="email" th:value="${empDetailsByEmpId.email}" readonly>
			                    </div>
			                    <div class="mb-3">
			                        <label for="feedbackEmailyy" class="form-label fw-bold">To</label>
			                        <div class="to-field-container">
			                            <span class="to-field rounded-pill px-3 py-2 shadow-sm">bugs_msplconnect@melangesystems.com</span>
			                        </div>
			                    </div>
								<div class="mb-3">
								    <label for="bugType" class="form-label fw-bold">Bug Type</label>
								    <select class="form-control" id="bugType" name="bugType" required>
								        <option value="About Application">About Application</option>
								        <option value="New Feature">New Feature</option>
								    </select>
								</div>

			                    <div class="mb-3">
			                        <label for="feedbackMessage" class="form-label fw-bold">Message</label>
			                        <textarea class="form-control" id="feedbackMessage" name="message" rows="4" placeholder="Enter your feedback here..." required></textarea>
			                    </div>
			                    <div class="mb-3">
			                        <label for="feedbackAttachment" class="form-label fw-bold">Attachment (optional)</label>
			                        <input type="file" class="form-control" id="feedbackAttachment" name="attachment" accept=".png, .jpg, .jpeg" multiple>
			                        <small class="text-muted">Max size: 5MB. You can upload multiple images.</small>
			                    </div>
			                    <button type="submit" class="btn btn-primary w-100 mt-3 py-2 shadow-sm" id="submitFeedbackBtn">Submit Feedback</button>
			                </form>
			            </div>
			        </div>
			    </div>
			</div>
    <div class="pagetitle adjust-up d-flex mb-0" th:if="${empDetailsByEmpId.deptId>0}">
    <i class="bi bi-chevron-double-left toggle-sidebar-btn mb-0" onclick="toggleIconRotation()" style="font-size:24px;color:#2F73B9;padding:0 10px;margin-left:-10px;margin-top:-10px"></i>
     
      <nav>
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a th:href="@{/userDashboard}">Home</a></li>          
          <li class="breadcrumb-item active">Attendance</li>
        </ol>
      </nav>
      
    </div><!-- End Page Title -->
    
    <div class="pagetitle adjust-up d-flex" th:if="${empDetailsByEmpId.deptId==0}">
    <i class="bi bi-chevron-double-left toggle-sidebar-btn mb-1" onclick="toggleIconRotation()" style="font-size:24px;color:#2F73B9;padding:0 10px;margin-left:-10px;margin-top:-10px"></i>
     
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a th:href="@{/navbar}">Home</a></li>
          <li class="breadcrumb-item active">Attendance</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->
    
    <input type="hidden" id="roleValue" th:value="${session.role_name}">
    <input type="hidden" id="selectedCandidateIdValue" th:value="${selected_Candidate_Id}">
    
    <section class="section dashboard">
      <div class="row">

            <div class="col-lg-12" id="holidayForm">
					<div class="card p-0">
						<div class="card-body">
							   <div class="d-flex justify-content-between">
							   		<h5 class="card-title">Employee Data | <span th:text='${loogedAdminDetailsByEmpId.fullName}'></span></h5>
							   		<button class="btn btn-primary mt-2" th:onclick="openDateRangeModal([[${loogedAdminDetailsByEmpId.empid}]])">
									    Download
									</button>						   
							   </div>
							

							<!-- Main Bordered Tabs Justified -->
								<ul class="nav nav-tabs nav-tabs-bordered d-flex" id="borderedTabJustified" role="tablist">
									<li class="nav-item flex-fill" role="presentation">
										<button class="nav-link w-100" id="home-tab" data-bs-toggle="tab"
											th:classappend="${leaveTabActive == null ? 'active' : ''}" 
											data-bs-target="#bordered-justified-home" type="button" role="tab" aria-controls="home"
											aria-selected="true">Attendance</button>
									</li>
									<li class="nav-item flex-fill" role="presentation">
										<button class="nav-link w-100" id="profile-tab" data-bs-toggle="tab"
											data-bs-target="#bordered-justified-profile" type="button" role="tab"
											th:classappend="${leaveTabActive != null ? 'active' : ''}" 
											aria-controls="profile" aria-selected="false">Leaves</button>
									</li>
									<li class="nav-item flex-fill" role="presentation" th:if="${empDetailsByEmpId.email != loogedAdminDetailsByEmpId.email}">
										<button class="nav-link w-100" id="contact-tab" data-bs-toggle="tab"
											data-bs-target="#bordered-justified-contact" type="button" role="tab"
											aria-controls="contact" aria-selected="false">Performance</button>
									</li>
								</ul>
				
								<div class="tab-content pt-2" id="borderedTabJustifiedContent">
					<!-- Attendance Tab with Sub-tabs -->
					<div class="tab-pane fade show active" id="bordered-justified-home" role="tabpanel"
						aria-labelledby="home-tab">
						<!-- Sub-tabs for Attendance -->
						<ul class="nav nav-tabs nav-tabs-bordered d-flex" id="attendanceSubTabs" role="tablist">
							<li class="nav-item flex-fill" role="presentation">
								<button class="nav-link w-100 active" id="attendance-sub-tab1" data-bs-toggle="tab"
									data-bs-target="#attendance-tab1" type="button" role="tab"
									aria-controls="attendance-tab1" aria-selected="true">Calendar View</button>
							</li>
							<li class="nav-item flex-fill" role="presentation">
								<button class="nav-link w-100" id="attendance-sub-tab2" data-bs-toggle="tab"
									data-bs-target="#attendance-tab2" type="button" role="tab"
									aria-controls="attendance-tab2" aria-selected="false">Table View</button>
							</li>
						</ul>
						<!-- Button to Toggle Views -->
						<!--    <div class="d-flex justify-content-end mb-2">
			        <button id="toggleViewButton" class="btn btn-primary " type="button">Table View</button>
			    </div>-->
						<!-- Content for Attendance Sub-tabs -->
						<div class="tab-content pt-2">
							<div class="tab-pane fade show active" id="attendance-tab1" role="tabpanel"
								aria-labelledby="attendance-sub-tab1">
								<!--<div id="calendarView" class="tab-pane fade show active">-->
								<!--	<div class="w-full p-1 m-1 bg-gray-100 rounded-lg">
				    <div class="flex flex-wrap justify-center w-full mx-auto" x-data="genCalendar()" x-init="currentDate()" x-cloak>
				      
				        <div class="w-full p-2 mb-2 text-2xl font-bold text-center text-gray-800 bg-white rounded-lg shadow-lg">
				            <p x-text="year"></p>
				        </div>
				
				        <template x-for="(month, index) in month_names">
							
				            <div class="p-1 m-1 font-sans bg-white rounded shadow-md lg:w-72 w-80 bg-blend-luminosity bg-gradient-to-b from-green-50 via-white to-green-50">
				                <p class="p-1 text-xl font-semibold text-center text-indigo-800" x-text="month"></p>
				                <div class="p-1 m-1">
				                    <div class="grid grid-cols-7 font-semibold text-green-800 border-b-2">
				                        <template x-for="days in day_names">
				                            <div class="grid place-items-center" :class="{'text-red-600': days == 'Su'}">
				                                <p x-text="days"></p>
				                            </div>
				                        </template>
				                    </div>
				                  
				                    <div class="grid grid-cols-7 gap-1 font-semibold text-center text-gray-800">
				                        <template x-for="day in daysGenerator()[index]">
				                            <div :class="{
				                                'ring-blue-400 ring-4 rounded-full': isToday(day, index),
				                                'bg-green-100 text-black': isPresentDay(day, index),
				                                'text-red-600': isSunday(day, index) || isAbsentDay(day, index),
				                                'bg-red-100': isAbsentDay(day, index),
				                                'bg-gray-200': isHoliday(day, index) // Gray background for holidays
				                            }">
				                                <p x-text="day"></p>
				                            </div>
				                        </template>
				                    </div>
				                  
				                </div>
				            </div>
				        </template>
				    </div>
				</div>-->
								<div class="w-full p-1 m-1 bg-gray-100 rounded-lg">
								<div class="mb-2 bg-white p-1 m-1 rounded-md shadow-md mx-auto"  style="margin:0 12px 4px 12px !important">
                                      <div class="flex justify-end space-x-3">
                                          <div class="flex items-center">
                                              <div class="w-3 h-3 bg-green-200 rounded-full"></div>
                                              <span class="ml-1 text-xs font-bold text-gray-800">Present</span> <!-- Bold text -->
                                          </div>
                                          <div class="flex items-center">
                                              <div class="w-3 h-3 bg-red-200 rounded-full"></div>
                                              <span class="ml-1 text-xs font-bold text-gray-800">Absent</span> <!-- Bold text -->
                                          </div>
                                          <div class="flex items-center">
                                              <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                              <span class="ml-1 text-xs font-bold text-gray-800">MSPL Holiday</span> <!-- Bold text -->
                                          </div>
                                          <div class="flex items-center">
                                              <div class="w-3 h-3 bg-yellow-300 rounded-full"></div>
                                              <span class="ml-1 text-xs font-bold text-gray-800">Earned Leave</span> <!-- Bold text -->
                                          </div>
                                          <div class="flex items-center">
                                              <!-- Half circle with green and red -->
                                              <div class="w-3 h-3 rounded-full flex">
                                                  <div class="w-1/2 h-full bg-green-200 rounded-l-full"></div>
                                                  <div class="w-1/2 h-full bg-red-200 rounded-r-full"></div>
                                              </div>
                                              <span class="ml-1 text-xs font-bold text-gray-800">Half-Day Absent</span> <!-- Bold text -->
                                          </div>
                                          <div class="flex items-center">
                                              <!-- Missed Punch -->
                                              <div class="w-3 h-3 bg-absence rounded-full"></div>
                                              <span class="ml-1 text-xs font-bold text-gray-800">Missed Punch</span> <!-- Bold text -->
                                          </div>
                                      </div>
                                  </div>
									<div class="flex flex-wrap p-1 m-0" x-data="genCalendar()" x-init="currentDate()"
										x-cloak>
										<!-- Year Header -->
										<!--	<div
											class="w-full p-2 mb-2 text-2xl font-bold text-center text-gray-800 bg-white rounded-lg shadow-lg">
											<p x-text="year">2024</p>
											
										</div>-->
										<!--	<div class="flex flex-wrap w-full h-12 p-1 m-1 text-xl font-bold bg-white rounded-lg shadow-lg">
										       <p class="w-1/3 p-1 text-center text-green-900 shadow-md cursor-pointer hover:text-green-600 hover:shadow-inner bg-gray-50 rounded-l-md" @click="year -= 1">
										           <svg xmlns="http://www.w3.org/2000/svg" class="block w-6 h-8 m-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
										           </svg>
										       </p>
										       <p class="w-1/3 p-1 text-center text-green-900 shadow-md cursor-pointer hover:text-green-600 hover:shadow-inner bg-gray-50" x-text="year"></p>
										       <p class="w-1/3 p-1 text-center text-green-900 shadow-md cursor-pointer hover:text-green-600 hover:shadow-inner bg-gray-50 rounded-r-md" @click="year += 1">
										           <svg xmlns="http://www.w3.org/2000/svg" class="block w-6 h-8 m-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
										           </svg>
										       </p>
										   </div>-->
										<!-- Year Header -->
                                                                                <div
                                                                                        class="flex flex-wrap w-full h-12 p-1 m-1 text-xl font-bold bg-white rounded-lg shadow-lg"  style="margin:0 8px !important">
                                                                                        <!-- Back Arrow -->
                                                                                        <p class="w-1/3 p-1 text-center text-green-900 shadow-md cursor-pointer hover:text-green-600 hover:shadow-inner bg-gray-50 rounded-l-md"
                                                                                                :class="{ 'cursor-not-allowed opacity-50': year <= startYear }"
                                                                                                @click="year >  startYear ? year -= 1 : null">
                                                                                                <svg xmlns="http://www.w3.org/2000/svg" class="block w-6 h-8 m-auto"
                                                                                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                                                                                stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
                                                                                                </svg>
                                                                                        </p>


											<!-- Current Year -->
											<p class="w-1/3 p-1 text-center text-green-900 shadow-md cursor-pointer hover:text-green-600 hover:shadow-inner bg-gray-50"
												x-text="year"></p>

											<!-- Forward Arrow -->
											<p class="w-1/3 p-1 text-center text-green-900 shadow-md cursor-pointer hover:text-green-600 hover:shadow-inner bg-gray-50 rounded-r-md"
												:class="{ 'cursor-not-allowed opacity-50': year >= new Date().getFullYear() }"
												@click="year < new Date().getFullYear() ? year += 1 : null">
												<svg xmlns="http://www.w3.org/2000/svg" class="block w-6 h-8 m-auto"
													fill="none" viewBox="0 0 24 24" stroke="currentColor">
													<path stroke-linecap="round" stroke-linejoin="round"
														stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
												</svg>
											</p>
										</div>

										<!-- Month Cards -->
										<template x-for="(month, index) in month_names" :key="index">
											<div class="w-full sm:w-1/2 lg:w-1/3 p-2">
												<div
													class="flex flex-col h-full font-sans bg-white rounded shadow-md bg-blend-luminosity bg-gradient-to-b from-green-50 via-white to-green-50"  :id="'month-' + (index + 1)"  												:class="{
												        'ring-blue-400 ring-4': isCurrentMonth(index), 
												        'bg-blue-700': isCurrentMonth(index)
												    }">
													<div class="flex-grow">
														<p class="p-1 text-xl font-semibold text-center text-indigo-800"
															x-text="month">January</p>
														<div class="p-1 m-1">
															<div
																class="grid grid-cols-7 font-semibold text-green-800 border-b-2">
																<template x-for="days in day_names">
																	<div class="grid place-items-center"
																		:class="{'text-red-600': days == 'Su'}">
																		<p x-text="days"></p>
																	</div>
																</template>
															</div>

															<div
																class="grid grid-cols-7 gap-1 font-semibold text-center text-gray-800">
																<template x-for="day in daysGenerator()[index]">
																	<div :class="{
				                                        'ring-blue-400 ring-3 ': day && isToday(day, index),
				                                        'bg-green-100 text-black': isPresentDay(day, index),
														
														'bg-firstHalfDay': isHalfDay(day, index) && isFirstHalfDay(day, index), // For first half days
														       'bg-secondHalfDay': isHalfDay(day, index) && isSecondHalfDay(day, index), // For second half days
														  'text-red-600': isSunday(day, index) || isAbsentDay(day, index)|| isSecondOrFourthSaturday(day, index),
				                                        'bg-red-100': isAbsentDay(day, index) , 
														'ring-green-300 ring-2': isAttendanceOnSkipDay(day, index),

				                                        'bg-gray-200': isHoliday(day, index), // Gray background for holidays
														'bg-darkGreen': !isHoliday(day, index) && isSandwichLeave(day, index),// Dark green for sandwich leave
														'bg-absence': isNoAttendanceRecord(day, index), 
														'bg-lessThanTwoAndHalf ': isLessThanTwoAndHalfHours(day, index) ,
														
														'bg-WithinSevenHours': isWithinSevenHours(day, index)
				                                    }" @click="onDateClick(day, index)"
																		x-bind:title="isNoAttendanceRecord(day, index) ? 'Missed Punch' : isLessThanTwoAndHalfHours(day, index) ? 'Worked less than 2.5 hours' :   (isHoliday(day, index) && isSandwichLeave(day, index)) ? ` Sandwich Leave,${getHolidayReason(day, index)}` :  isSandwichLeave(day, index) ? 'Sandwich Leave' :getLeaveReason(day, index) || getHolidayReason(day, index)">
																		<!--	<p x-text="day"></p>
																		<template x-if="isEarnedLeaveDate(day, index)">
																		       <div class="w-2 h-2 bg-yellow-500 rounded-full mx-auto mt-1"></div>
																		   </template>-->
																		<div
																			class="flex items-center justify-center relative">
																			<p x-text="day"></p>
																			<template
																				x-if="isEarnedLeaveDate(day, index)">
																				<div
																					class="dot absolute top-0 right-0 transform translate-x-1 translate-y-1">
																				</div>
																			</template>
																		</div>

																	</div>
																</template>
															</div>
														</div>
													</div>
												</div>
											</div>
										</template>
									</div>



								</div>
							</div><!--close of first tab-->


							<div class="tab-pane fade" id="attendance-tab2" role="tabpanel"
								aria-labelledby="attendance-sub-tab2">
								<div class="container mt-4">
								       <label for="yearSelect">Select Year:</label>
								       <select id="yearSelect" class="form-select" >
								           <option th:each="year : ${years}" th:value="${year}" th:text="${year}" th:selected="${year == selectedYear}"></option>
								       </select>
								   </div>

								<!--<div id="tableView" class="tab-pane fade">-->
								<div class="container card-container">
									

									<div class="row">

										<div th:each="month : ${months}" class="col-md-4">
											<div class="card">
												<div class="card-body">
													<h5 class="card-title" th:text="${month}">Month Name</h5>

													
													<a href="#"
														class="btn btn-light btn-border-custom-sm btn-view-weekly-data"
														th:data-month="${month}" data-bs-toggle="modal"
														data-bs-target="#weeklyModal">
														Week
													</a>
													<a th:href="@{/attendanceLive/{month}(month=${month})}"
														class="btn btn-light btn-border-custom-sm btn-view-data"
														th:data-month="${month}">View Data</a>
												</div>
											</div>
										</div>
									</div>
								</div>


								<!-- Add the button to check yearly data -->
								<div class="container mt-4">
									<button id="checkYearlyData" class="btn btn-primary">Check Yearly Data</button>
								</div>



								<!-- Modal -->
								<div class="modal fade" id="attendanceModal" tabindex="-1"
									aria-labelledby="attendanceModalLabel" aria-hidden="true">
									<div class="modal-dialog modal-xl modal-dialog-scrollable">
										<!-- Changed modal-lg to modal-xl -->
										<div class="modal-content">
											<div class="modal-header"> <!-- Custom background color and text color -->
												<h5 class="modal-title" id="attendanceModalLabel">Monthly Attendance
													Data</h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal"
													aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<!-- Employee details and search bar container -->
												<div class="d-flex justify-content-between mb-3 align-items-center">
													<div class="employee-info">
													    <div class="info-item">
													        <span class="label">Emp ID:</span> <span id="employeeId"></span>
													    </div>
													    <div class="info-item">
													        <span class="label">Emp Name:</span> <span id="employeeName"></span>
													    </div>
													    <div class="info-item">
													        <span class="label">Month:</span> <span id="employeeMonth"></span>
													    </div>
													</div>



													<!-- Search bar -->
													<div class="input-group" style="width: 300px;">
														<input type="text" id="searchInputModal" class="form-control"
															placeholder="Search..." aria-label="Search">
														<!-- <span class="input-group-text">
															<i class="bi bi-search"></i>
														</span> -->
													</div>
												</div>

											<!-- Monthly Attendance Data Table -->
												<div class="mt-4">
													<table class="table table-hover table-striped"
														id="modalMonthlyAttendanceTable">
														<thead>
															<tr>
																<th>Total Working Days</th>
																<th>Total Expected Working Hours</th>
																<th id="expectedHoursTillDateHeader"
																	style="display: none;">Expected Hours Till Date</th>

																<th>Total Hours Worked</th>
																<th>Days Present</th>
																<th>Days Absent</th>
																<!-- <th>Remaining Working Days</th>-->
																<th id="remainingWorkingDaysHeader">Remaining Working
																	Days</th>
																<th>Overtime</th>
																<th>Undertime</th>
															</tr>
														</thead>
														<tbody>
															<tr id="modalNoDataRow" style="display: none;">
																<td colspan="8" class="text-center">No data available
																</td>
															</tr>
															<!-- Data rows will be populated here -->
														</tbody>
													</table>
												</div>
												<!-- Attendance Table -->
												<div class="table-responsive">
													<table class="table table-hover table-striped"
														id="modalAttendanceTable">
														<thead>
															<tr>
																<th>Date</th>
																<th>In Time</th>
																<th>Out Time</th>
																<th>Overtime</th>
																<th>UnderTime</th>
																<th>Total Hours</th>
															</tr>
														</thead>
														<tbody>
															<!-- Data rows will be dynamically added here -->
														</tbody>
													</table>
												</div>

												<!-- No data available message for the first table -->
												<div id="modalNoDataRow" style="display: none;">
													<p class="text-center">No data available</p>
												</div>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-secondary"
													data-bs-dismiss="modal">Close</button>
											</div>
										</div>
									</div>
								</div>




								<div class="modal fade" id="weeklyModal" tabindex="-1"
									aria-labelledby="weeklyModalLabel" aria-hidden="true">
									<div class="modal-dialog modal-lg">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title" id="weeklyModalLabel">Weekly Data</h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal"
													aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<ul class="nav nav-tabs" id="weekTabs" role="tablist">
													<!-- Tabs will be inserted here -->
												</ul>
												<div class="tab-content" id="weekTabContent">
													<!-- Tab content will be inserted here -->
												</div>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-secondary"
													data-bs-dismiss="modal">Close</button>
											</div>
										</div>
									</div>
								</div>


								<!-- Modal Structure -->
								<div class="modal fade" id="yearlyDataModal" tabindex="-1"
									aria-labelledby="yearlyDataModalLabel" aria-hidden="true">
									<div class="modal-dialog modal-lg">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title" id="yearlyDataModalLabel">Yearly Attendance Data
												</h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal"
													aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<div class="table-container">


													<table class="table table-hover table-striped" id="holidayTable">
														<thead>
															<tr>
																<th>Employee Id</th>
																<th>Employee Name</th>
																<th>Total Hours Worked</th>
																<th>Total Expected Working Hours</th>
																<th>Total Working Days</th>
																<th>Days Present</th>
																<th>Days Absent</th>
																<th>Remaining Working days</th>
																<th>Overtime</th>
															</tr>
														</thead>
														<tbody id="attendanceTableBody">
															<!-- Data will be injected here by JavaScript -->
														</tbody>
													</table>
												</div>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-secondary"
													data-bs-dismiss="modal">Close</button>
											</div>
										</div>
									</div>
								</div>
								
								
							</div><!--second tab-->





						</div><!--dont remove-->
					</div><!--		bordered-justified-home-->

					<!-- Profile Tab -->
<!-- Modal to select date range to download attendence data-->
								<div id="dateRangeModal" class="modal fade" tabindex="-1" aria-hidden="true">
								    <div class="modal-dialog">
								        <div class="modal-content">
								            <div class="modal-header">
								                <h5 class="modal-title">Select Date Range</h5>
								                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								            </div>
								            <div class="modal-body">
								                <form id="dateRangeForm">
								                    <div class="mb-3">
								                        <label for="fromDate" class="form-label">From Date</label>
								                        <input type="date" id="fromDate1" class="form-control" required>
								                    </div>
								                    <div class="mb-3">
								                        <label for="toDate" class="form-label">To Date</label>
								                        <input type="date" id="toDate1" class="form-control" required>
								                    </div>
								                </form>
								            </div>
								            <div class="modal-footer">
								                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
								                <button type="button" class="btn btn-primary" th:onclick="submitDateRange([[${loogedAdminDetailsByEmpId.empid}]])">
								                    Submit
								                </button>
								            </div>
								        </div>
								    </div>
								</div>



								<!-- Profile Tab -->
								<div class="tab-pane fade" id="bordered-justified-profile" role="tabpanel"
									aria-labelledby="profile-tab">
			
										<div class="col-lg-12 d-flex align-items-center" style="overflow: auto;">
											<div class="card" style="width: 100%; height: 100%;"> <!-- Adjust width of the card -->
												<div class="card-body d-flex justify-content-between align-items-center"
													style="padding: 0;">
													<!-- Donut Chart -->
													<div id="donutChart" style="flex: 1;"></div>
													<div style="text-align: center;"> <!-- Center the buttons -->
														<button type="button" class="btn btn-primary ms-2" id="requestLeaveBtn"
															style="margin-top: -120px;">Request Leave</button>
														<!-- New Link Below Request Leave -->
														<a href="#" class="btn btn-primary ms-2" id="leaveDetailsLink"
															style="margin-top: -120px; display: inline-block;">Leave Details</a>
													</div>
												</div>
											</div>
										</div>

										<script>
											document.addEventListener("DOMContentLoaded", () => {
												
												const leaveBalances = {sl: 0, cl: 0, el: 0}; // Initialize leave balances

												function updateChart() {
													console.log("hiiiiiiiiiiiiiiiii");
													if (leaveBalances.sl === 0 && leaveBalances.cl === 0 && leaveBalances.el === 0) {
														// Display a message or create a minimal chart
														document.querySelector("#donutChart").innerHTML = "<p style='text-align: center; color: #888;'>No leave available</p>";
														return;
													}
													// Create the donut chart using leave balances
													new ApexCharts(document.querySelector("#donutChart"), {
														series: [leaveBalances.sl, leaveBalances.cl, leaveBalances.el], // Available leaves
														chart: {
															height: 200,
															type: 'pie',
															toolbar: {
																show: false
															}
														},
														labels: ['Sick Leave', 'Casual Leave', 'Earned Leave'],
														plotOptions: {
															pie: {
																donut: {
																	labels: {
																		show: true,
																		name: {
																			show: true,
																			fontSize: '14px',
																			offsetY: 30,
																		},
																		value: {
																			show: true,
																			fontSize: '14px',
																			offsetY: 10,
																		}
																	}
																}
															}
														},
													}).render();
												}

												function fetchLeavesData() {
													console.log("Fetching leave data..."); // Log statement to indicate the fetch operation has started
													var email = document.getElementById('employeeEmail1').value;
													fetch(`/leaveRecords/${email}`) 
														.then(response => {
															if (!response.ok) {
																throw new Error('Network response was not ok: ' + response.statusText);
															}
															return response.json();
														})
														.then(data => {
															//console.log("Leave records fetched:", data); // Log the raw leave records data
															data.forEach(record => {
																if (record.leaveType === "Sick Leave") {
																	leaveBalances.sl = record.remaining; // Available Sick Leave
																} else if (record.leaveType === "Casual Leave") {
																	leaveBalances.cl = record.remaining; // Available Casual Leave
																}
															});
															console.log("Leave balances after fetching leave records:", leaveBalances); // Log the balances after fetching SL and CL
															updateChart(); // Update chart with available leaves
														})
														.then(() => {
															console.log("Fetching earned leave data..."); // Log statement before fetching earned leave
															var email = document.getElementById('employeeEmail1').value;
															return fetch(`/calculate-earned-leave?year=${new Date().getFullYear()}&email=${email}`);
														})
														.then(response => {
															if (!response.ok) {
																throw new Error('Network response was not ok: ' + response.statusText);
															}
															return response.json();
														})
														.then(data => {
															console.log("Earned leave data fetched:", data); // Log the raw earned leave data
															if (data && data.elRemaining !== undefined) {
																leaveBalances.el = data.elRemaining; // Available Earned Leave
															}
															console.log("Final leave balances after fetching earned leave:", leaveBalances); // Log the final leave balances
															updateChart(); // Update chart again after fetching EL
														})	
														.catch(error => {
															console.error('Error fetching data:', error); // Log any errors encountered during fetching
														});
												}

												fetchLeavesData(); // Call the function to fetch leave data
											});

										</script>
										<!-- End Donut Chart -->
						<!-- Spinner -->
						<!--<div id="loadingSpinner" style="display: none; text-align: center; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050;">
						    <div class="spinner-border text-primary" role="status">
						        <span class="visually-hidden">Loading...</span>
						    </div>
						</div>-->
						<!-- Spinner with Black Background -->
						<!-- Spinner with Custom Red Color -->
						<div id="loadingSpinner" 
						     style="display: none; 
						            position: fixed; 
						            top: 0; 
						            left: 0; 
						            width: 100%; 
						            height: 100%; 
						            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
						            z-index: 1050; 
						            text-align: center;">
						    <div style="position: absolute; 
						                top: 50%; 
						                left: 50%; 
						                transform: translate(-50%, -50%);">
						        <div class="spinner-border text-dark" role="status"> <!-- Change color class -->
						            <span class="visually-hidden">Loading...</span>
						        </div>
						    </div>
						</div>




						<!-- Modal -->
						<div class="modal fade" id="leaveDetailsModal" tabindex="-1" role="dialog"
							aria-labelledby="leaveDetailsModalLabel" aria-hidden="true">
							<div class="modal-dialog" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="leaveDetailsModalLabel">Leave Details</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal"
											aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<table class="table">
											<thead>
												<tr>
													<th>Leave Type</th>
													<th>Added</th>
													<th>Used</th>
													<th>Remaining</th>
												</tr>
											</thead>
											<tbody id="leaveRecordsTable">
												<!-- Dynamic content will be inserted here -->
											</tbody>
										</table>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary"
											data-bs-dismiss="modal">Close</button>
									</div>
								</div>
							</div>
						</div>



						<div class="app-card app-card-orders-table shadow-sm data-container"
							style="border-radius:5px;width:100%;">
							<table class="table table-hover" id="leaveApplicationsTable"
								style="text-align: center !important; font-size: 14px; margin-right: 8px; margin-left: 0;">
								<thead>
									<tr>
										<th class="cell border">Date</th>
										<!-- <th class="cell border">To Date</th>-->
										<th class="cell border">Leave Type</th>
										<th class="cell border">Reason</th>
										<th class="cell border">Requested On</th>
										<th class="cell border">Status</th>
										<th class="cell border">Approved By</th>
										<th class="cell border">Rejection Reason</th>
										<th class="cell border">Remarks</th>
									</tr>
								</thead>
								<tbody>
									<!-- Data will be dynamically populated by JavaScript -->
									<tr>
										<td colspan="7" class="text-center">Loading...</td>
									</tr>
								</tbody>
							</table>
						</div>


						<!-- Ensure Thymeleaf is correctly set up -->
						<input type="hidden" id="employeeGender" th:value="${empDetailsByEmpId.gender}">

						<!-- Leave Request Modal -->
						<!--	<div class="modal fade" id="requestLeaveModal" tabindex="-1" aria-labelledby="requestLeaveModalLabel" aria-hidden="true">
							    <div class="modal-dialog custom-modal-dialog">
							        <div class="modal-content">
							            <div class="modal-header">
							                <h5 class="modal-title" id="requestLeaveModalLabel">Request Leave</h5>
							                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							            </div>
							            <div class="modal-body">
							              
							                <form id="leaveForm">
							                 
							                    <div class="form-group mb-2">
							                        <label for="fromDate">From</label>
							                        <input type="date" id="fromDate" class="form-control" name="fromDate" required>
							                    </div>
							                    <div class="form-group mb-2">
							                        <label for="toDate">To</label>
							                        <input type="date" id="toDate" class="form-control" name="toDate" required>
							                    </div>
												
												
												                   <div id="dateError" class="text-danger mb-2" style="display: none;">
																	<strong>Invalid Date Range:</strong> The "To Date" must be later than or equal to the "From Date".
												                       </div>
																	   
																	   <div id="dateOverlap" class="text-danger mb-2" style="display: none;">
																	       <strong>Invalid Date Range:</strong> You have already requested leave for the selected dates.
																	   </div>
		   
																	   
							                    <div class="form-group mb-2">
							                        <label for="leaveType">Leave Type</label>
							                        <select id="leaveType" class="form-control custom-select" name="leaveType" required>
							                            
							                        </select>
							                    </div>
												<div id="error-message" style="color: red; display: none;"></div> 
							                    <div class="form-group mb-2">
							                        <label for="reason">Reason for Leave</label>
							                        <textarea id="reason" rows="3" name="reason" class="form-control" placeholder="Reasons for Leave" required></textarea>
							                    </div>
							                    
							                   
							                    <div class="form-group mb-2">
							                        <label for="outOfStation">Out of Station</label>
							                        <select id="outOfStation" class="form-control" name="out_of_station" required>
							                            <option value="No">No</option>
							                            <option value="Yes">Yes</option>
							                        </select>
							                    </div>
							                    <div class="form-group mb-2">
							                        <label for="availableOnPhone">Available on Phone</label>
							                        <select id="availableOnPhone" class="form-control" name="available_on_phone" required>
							                            <option value="Yes">Yes</option>
							                            <option value="No">No</option>
							                        </select>
							                    </div>
							                    <div class="form-group mb-2">
							                        <label for="emailAccess">Email Access</label>
							                        <select id="emailAccess" class="form-control" name="email_access" required>
							                            <option value="Yes">Yes</option>
							                            <option value="No">No</option>
							                        </select>
							                    </div>
							                    <div class="form-group mb-2">
							                        <label for="approvingAuthority">Approving Authority</label>
							                        <select id="approvingAuthority" class="form-control" name="approvingAuthority" multiple required >
							                            
							                        </select>
							                    </div>
							                    
							             
							                    <div class="form-group mb-2">
							                        <input type="hidden" id="reportingTo" name="reportingTo">
							                    </div>
							
							                    
							                    <div class="form-group mt-4 text-end">
							                        <button type="submit" id="submitBtn" class="btn btn-primary">Submit</button>
							                        <button type="reset" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
							                    </div>
							                </form>
							            </div>
							        </div>
							    </div>
							</div>-->


						<!-- Leave Request Modal -->
						<div class="modal fade" id="requestLeaveModal" tabindex="-1"
							aria-labelledby="requestLeaveModalLabel" aria-hidden="true">
							<div class="modal-dialog custom-modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="requestLeaveModalLabel">Request Leave</h5>
										<!-- <button type="button" class="btn-close" data-bs-dismiss="modal"
											aria-label="Close"></button> -->
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<!-- Leave Request Form -->
										<form id="leaveForm">
											<!-- Leave Duration Selection -->
											<div class="mb-3">
												<label>Leave Duration</label>
												<div class="d-flex align-items-center">
													<div class="form-check me-3">
														<input class="form-check-input" type="radio"
															name="leaveDuration" id="fullDay" value="Full Day" checked>
														<label class="form-check-label" for="fullDay">Full Day</label>
													</div>
													<div class="form-check">
														<input class="form-check-input" type="radio"
															name="leaveDuration" id="halfDay" value="Half Day">
														<label class="form-check-label" for="halfDay">Half Day</label>
													</div>
												</div>
											</div>

											<!-- Date Fields Side by Side -->
											<div class="row mb-2">
												<div class="col">
													<label for="fromDate">From</label>
													<input type="date" id="fromDate" class="form-control"
														name="from_date" required>
														<div id="fromDateError" class="text-danger mt-1" style="display: none;">
														           <strong>Invalid Selection:</strong> Holidays cannot be selected.
														</div>
												</div>
												<div class="col">
													<label for="toDate">To</label>
													<input type="date" id="toDate" class="form-control" name="to_date"
														required>
												</div>
												<div id="toDateError" class="text-danger mt-1" style="display: none;">
												            <strong>Invalid Selection:</strong> Sundays cannot be selected.
												        </div>
											</div>
											<div id="dateErrorfromto" class="text-danger mt-1" style="display: none;">
											    <strong>Invalid Selection:</strong> Holidays cannot be selected.
											</div>
											<div id="dateErrorholiday" class="text-danger mt-1" style="display: none;">
											    <strong>Invalid Selection:</strong> Selected date cannot be a holiday.
											</div>

											<!-- Error Message for Invalid Date Range -->
											<div id="dateError" class="text-danger mb-2" style="display: none;">
												<strong>Invalid Date Range:</strong> The "To Date" must be later than or
												equal to the "From Date".
											</div>

											<div id="dateOverlap" class="text-danger mb-2" style="display: none;">
												<strong>Invalid Date Range:</strong> You have already requested leave
												for the selected dates.
											</div>

											<!-- Error Message for Invalid Maternity Leave -->
											<div id="maternityLeaveError" class="text-danger mb-2"
												style="display: none;">
												<strong>Invalid Maternity Leave:</strong> Maternity leave cannot be less
												than or greater than 6 months.
											</div>
											<div id="error-message" style="color: red; display: none;"></div>
											<!-- Reason for Leave -->
											<div class="form-group mb-2">
												<label for="reason">Reason for Leave</label>
												<textarea id="reason" rows="3" name="reason" class="form-control"
													placeholder="Reasons for Leave" required></textarea>
											</div>

											<!-- Leave Type and Out of Station Fields Side by Side -->
											<div class="row mb-2">
												<div class="col">
													<label for="leaveType">Leave Type</label>
													<select id="leaveType" class="form-control custom-select"
														name="leaveType" required>
														<!-- Options will be populated dynamically -->
													</select>
												</div>
												<div class="col">
													<label for="outOfStation">Out of Station</label>
													<select id="outOfStation" class="form-control" name="out_of_station"
														required>
														<option value="No">No</option>
														<option value="Yes">Yes</option>
													</select>
												</div>
											</div>

											<!-- Available on Phone and Email Access Fields Side by Side -->
											<div class="row mb-2">
												<div class="col">
													<label for="availableOnPhone">Available on Phone</label>
													<select id="availableOnPhone" class="form-control"
														name="available_on_phone" required>
														<option value="Yes">Yes</option>
														<option value="No">No</option>
													</select>
												</div>
												<div class="col">
													<label for="emailAccess">Email Access</label>
													<select id="emailAccess" class="form-control" name="email_access"
														required>
														<option value="Yes">Yes</option>
														<option value="No">No</option>
													</select>
												</div>
											</div>
											<!-- Remarks Field -->
											   <div class="form-group mb-2">
											       <label for="remarks">Remarks</label>
											       <textarea id="remarks" rows="3" name="remarks" class="form-control" placeholder="Enter any additional remarks here"></textarea>
											   </div>

											<!-- Designation Field -->
											<div class="form-group mb-2">
												<label for="approvingAuthority">Approving Authority</label>
												<select id="approvingAuthority" class="form-control"
													name="approvingAuthority" multiple required>
												</select>
											</div>

											<!-- Hidden Fields -->
											<div class="form-group mb-2">
												<input type="hidden" id="reportingTo" name="reportingTo">
											</div>

											<!-- Submit and Reset Buttons -->
											<div class="form-group mt-4 text-end">
												<button type="submit" id="submitBtn" class="btn btn-primary">Submit</button>
												<button type="reset" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
											</div>
										</form>
									</div>
								</div>
							</div>
						</div>


					</div>




					
					<!-- Contact Tab -->
				<!--	<div class="tab-pane fade" id="bordered-justified-contact" role="tabpanel" aria-labelledby="contact-tab">
					
					    
					   
					    <div id="projectPerformanceGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 10px;">
					       
					    </div>
					    
					   
					    <div id="performanceChartContainer" style="height: 400px; width: 100%;"></div>
					    
						<div id="completedProjectsToggle" style="margin-top: 20px; text-align: right; padding-right: 20px;">
						        <a href="#" id="showDetailsLink" onclick="openCompletedProjectsModal(); return false;" 
						           style="display: inline-block; padding: 10px 20px; font-weight: 600; color: black; background-color: whitesmoke; border-radius: 5px; text-decoration: none;">
						            Show Details
						        </a>
						    </div>
					</div>-->
					
					<!-- Performance Tab Content -->
					<div class="tab-pane fade" id="bordered-justified-contact" role="tabpanel" aria-labelledby="contact-tab">
					     
					    <!-- Sub-tabs for Performance -->
					    <ul class="nav nav-tabs nav-tabs-bordered d-flex" id="performanceSubTabs" role="tablist">
					        <!-- Projectwise Performance Tab -->
					        <li class="nav-item flex-fill" role="presentation">
					            <button class="nav-link w-100 active" id="performance-sub-tab1" data-bs-toggle="tab"
					                data-bs-target="#performance-tab1" type="button" role="tab"
					                aria-controls="performance-tab1" aria-selected="true">Project wise Performance</button>
					        </li>
					        <!-- Quarterly Performance Tab -->
					        <li class="nav-item flex-fill" role="presentation">
					            <button class="nav-link w-100" id="performance-sub-tab2" data-bs-toggle="tab"
					                data-bs-target="#performance-tab2" type="button" role="tab"
					                aria-controls="performance-tab2" aria-selected="false">Quarterly Performance</button>
					        </li>
					    </ul>

					    <!-- Performance Tab Content (Projectwise and Quarterly) -->
					    <div class="tab-content mt-3">
					        <!-- Projectwise Performance Tab Pane -->
					        <div class="tab-pane fade show active" id="performance-tab1" role="tabpanel" aria-labelledby="performance-sub-tab1">
					            <!-- Project Performance Grid -->
					         <div id="projectPerformanceGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 10px;">
					                
					            </div>
								
					          
					        </div>

					        <!-- Quarterly Performance Tab Pane -->
					        <div class="tab-pane fade" id="performance-tab2" role="tabpanel" aria-labelledby="performance-sub-tab2">
					            <!-- Performance Chart Container -->
					            <div id="performanceChartContainer" style="height: 400px; width: 100%;"></div>
   <!-- Completed Projects Toggle -->
					            <div id="completedProjectsToggle" style="margin-top: 20px; text-align: right; padding-right: 20px;">
					                <a href="#" id="showDetailsLink" onclick="openCompletedProjectsModal(); return false;" 
					                   style="display: inline-block; padding: 10px 20px; font-weight: 600; color: black; background-color: whitesmoke; border-radius: 5px; text-decoration: none;">
					                    Show Details
					                </a>
					            </div>
					        </div>
					    </div>
					</div>

							   
								
								<!-- Modal Structure for Completed Projects -->
								<div class="modal fade" id="completedProjectsModal" tabindex="-1" aria-labelledby="completedProjectsModalLabel" aria-hidden="true">
								    <div class="modal-dialog modal-lg">
								        <div class="modal-content">
								            <div class="modal-header">
								                <h5 class="modal-title" id="completedProjectsModalLabel">Project Performance Details by Quarter</h5>
								                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								            </div>
								            <div class="modal-body" id="completedProjectsContent">
								                <!-- Completed project details with tabs will be dynamically added here -->
								            </div>
								            <div class="modal-footer">
								                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
								            </div>
								        </div>
								    </div>
								</div>

								
								<!-- Modal for Highcharts Graph -->
								<div class="modal fade" id="projectChartModal" tabindex="-1" aria-labelledby="projectChartModalLabel" aria-hidden="true">
								    <div class="modal-dialog modal-lg">
								        <div class="modal-content">
								            <div class="modal-header">
								                <h5 class="modal-title" id="projectChartModalLabel">Project Details</h5>
								                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
								                    <span aria-hidden="true">&times;</span>
								                </button>
								            </div>
								            <div class="modal-body">
								                <!-- Chart Container for Highcharts -->
								               <div id="teamPrjDetails1-{{projectId}}" style="height: 400px;"></div>
												<!--<div id="teamPrjDetails1-'+data[i].id+'" style=" height: 400px;"></div>-->
												<!-- Chart Container for Performance Chart -->
												
											 <div id="performanceModal" style="height: 400px; width: 100%; margin-top: 20px;"></div>
											 
								            </div>
								        </div>
								    </div>
								</div>
							</div>

						</div>
					</div>
				</div>

        </div><!-- End Left side columns -->
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
       Copyright &copy; <span id="currentYear"></span> <strong><span>Melange Systems Private Limited</span></strong>. All Rights Reserved
    </div>
  </footer>
  
  <script>
      var currentYear = new Date().getFullYear();
      document.getElementById("currentYear").innerHTML = currentYear;
  </script>

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
<script src="assets/js/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

const modalElement = document.getElementById('requestLeaveModal');
const modalInstance = new bootstrap.Modal(modalElement);

// Listen for the 'hidden' event (triggered when the modal is fully closed)
modalElement.addEventListener('hidden.bs.modal', function () {
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove(); // Remove the backdrop manually
    }
});


document.addEventListener('DOMContentLoaded', function () {
	const weeklyButtons = document.querySelectorAll('.btn-view-weekly-data');
	let openDetailsRow = null;

	const today = new Date(); // Current date
	const currentYear = today.getFullYear(); // Get the current year
	const currentWeekNumber = getWeekNumber(today); // Get the current week number
	const currentMonth = today.getMonth(); // Current month (0-based, January = 0)

	weeklyButtons.forEach(button => {
		button.addEventListener('click', function () {
			const month = this.getAttribute('data-month');
			const modalLabel = document.getElementById('weeklyModalLabel');
			modalLabel.textContent = `Weekly Data for ${month} ${currentYear}`;
			
			
			var email=document.getElementById('employeeEmail1').value;

			// Fetch the data for the selected month in the current year
			fetch(`/weeks?month=${encodeURIComponent(month)}&year=${currentYear}&email=${encodeURIComponent(email)}`)
				.then(response => response.json())
				.then(data => {
					const weekTabs = document.getElementById('weekTabs');
					const weekTabContent = document.getElementById('weekTabContent');

					weekTabs.innerHTML = ''; // Clear previous tabs
					weekTabContent.innerHTML = ''; // Clear previous tab content

					const selectedMonthIndex = getMonthIndex(month); // Helper to get month index (0-based)

					data.forEach((weekData, index) => {
						const isPastMonth = selectedMonthIndex < currentMonth;
						let isActive;

						// For past months, default to Week 1 as active
						if (isPastMonth && index === 0) {
							isActive = true;
						}
						// For current or future months, determine active week based on current date
						else {
							isActive = !isPastMonth && isCurrentWeek(weekData.dates);
						}

						// Filter out dates from the previous month
						const filteredDates = weekData.dates.filter(dateStr => {
							const dateObj = new Date(dateStr);
							return dateObj.getMonth() === selectedMonthIndex; // Only keep dates from the selected month
						});

						if (filteredDates.length === 0) {
							return; // Skip rendering this week if no valid dates remain
						}

						const tabItem = document.createElement('li');
						tabItem.classList.add('nav-item');
						tabItem.innerHTML = `
                            <a class="nav-link${isActive ? ' active' : ''}" 
                               id="week${index + 1}-tab" 
                               data-bs-toggle="tab" 
                               href="#week${index + 1}" 
                               role="tab" 
                               aria-controls="week${index + 1}" 
                               aria-selected="${isActive}">
                                ${weekData.weekLabel}
                            </a>
                        `;
						weekTabs.appendChild(tabItem);

						const tabPane = document.createElement('div');
						tabPane.classList.add('tab-pane', 'fade');
						if (isActive) {
							tabPane.classList.add('show', 'active');
						}
						tabPane.id = `week${index + 1}`;
						tabPane.role = 'tabpanel';
						tabPane.innerHTML = `
                            <table class="table details-table">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Date</th>
                                        <th>In Time</th>
                                        <th>Out Time</th>
                                        <th>Total Hours</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredDates.map(dateStr => {
							const dateObj = new Date(dateStr);
							const dayName = dateObj.toLocaleDateString('default', {weekday: 'long'});
							const formattedDate = getFormattedDate(dateObj);
							return `
                                            <tr class="date-row" data-date="${formattedDate}">
                                                <td>${dayName}</td>
                                                <td>${formattedDate}</td>
                                                <td id="inTime-${formattedDate}">-</td>
                                                <td id="outTime-${formattedDate}">-</td>
                                                <td id="totalHours-${formattedDate}">-</td>
                                            </tr>
                                        `;
						}).join('')}
                                </tbody>
                            </table>
                        `;
						weekTabContent.appendChild(tabPane);

						// Fetch and display details for each row
						filteredDates.forEach(dateStr => {
							const formattedDate = getFormattedDate(new Date(dateStr));
							var email=document.getElementById('employeeEmail1').value;
							
							fetch(`/attendance-details?date=${encodeURIComponent(formattedDate)}&email=${email}`)
								.then(response => response.json())
								.then(details => {
									const inTimeElement = document.getElementById(`inTime-${formattedDate}`);
									const outTimeElement = document.getElementById(`outTime-${formattedDate}`);
									const totalHoursElement = document.getElementById(`totalHours-${formattedDate}`);

									if (inTimeElement) inTimeElement.textContent = details.inTime || '-';
									if (outTimeElement) outTimeElement.textContent = details.outTime || '-';
									if (totalHoursElement) totalHoursElement.textContent = details.totalHours || '-';

									// Highlight today's date row
									if (formattedDate === getFormattedDate(today)) {
										console.log('Highlighting:', formattedDate); // Debug line
										const row = document.querySelector(`tr[data-date="${formattedDate}"]`);
										if (row) {
											row.classList.add('highlight-today');
											console.log('Row found and highlighted:', row);
										} else {
											console.warn(`No row found for date: ${formattedDate}`);
										}
									}
								})
								.catch(error => console.error('Error fetching details:', error));
						});
					});
				})
				.catch(error => console.error('Error fetching data:', error));
		});
	});

	// Helper function to get the week number of a given date
	function getWeekNumber(date) {
		const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
		const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
		return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
	}

	// Helper function to check if the week is the current week
	function isCurrentWeek(dates) {
		const today = new Date();
		const startDate = new Date(dates[0]);
		const endDate = new Date(dates[dates.length - 1]);

		// Ensure that today falls within the start and end date range of the week
		return today >= startDate && today <= endDate;
	}

	// Helper function to get 0-based month index from month name (like "September")
	function getMonthIndex(monthName) {
		const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
		return monthNames.indexOf(monthName);
	}

	// Helper function to get the formatted date string in dd-MM-yyyy
	function getFormattedDate(date) {
		return `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`;
	}
});

</script>


<script>

		// Filter function for modal search
		document.getElementById("searchInputModal").addEventListener("input", function () {
			var input, filter, table, tr, td, i, txtValue;
			input = document.getElementById("searchInputModal"); // Get the search input from the modal
			filter = input.value.toUpperCase();
			table = document.getElementById("modalAttendanceTable"); // Get the table inside the modal
			tr = table.getElementsByTagName("tr");
			var dataAvailable = false;

			for (i = 1; i < tr.length; i++) { // Start from 1 to skip table header
				tr[i].style.display = "none"; // Hide the row initially

				// Loop through all table columns
				td = tr[i].getElementsByTagName("td");
				for (var j = 0; j < td.length; j++) {
					if (td[j]) {
						txtValue = td[j].textContent || td[j].innerText;
						if (txtValue.toUpperCase().indexOf(filter) > -1) {
							tr[i].style.display = ""; // Show the row if match found
							dataAvailable = true;
							break; // Stop checking other columns
						}
					}
				}
			}

			// Show or hide "No data available" row
			var noDataRow = document.getElementById("modalNoDataRow");
			if (noDataRow) {
				noDataRow.style.display = dataAvailable ? "none" : "";
			}
		});
	</script>





	<script>

		document.addEventListener('DOMContentLoaded', function () {
			
		    var email=document.getElementById('employeeEmail1').value;
			
			var modal = document.getElementById('MonthlyattendanceModal');
			var modalTableBody = document.querySelector('#modalTable tbody');
			var modalNoDataRow = document.querySelector('#modalNoDataRow');

			// Function to fetch data and populate the modal
			function fetchAndPopulateModal(monthName) {
			// Send AJAX request
			       
			fetch(`/EmployeeAttendanceLive?month=${encodeURIComponent(monthName)}&email=${encodeURIComponent(email)}`, {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => response.json())
				.then(data => {
					if (data) {
						populateModal(data);  // Pass the fetched data to populateModal
						var bootstrapModal = new bootstrap.Modal(modal);
						bootstrapModal.show();  // Show modal after data is loaded
					} else {
						console.error('No data returned from server');
					}
				})
				.catch(error => {
					console.error('Error:', error);
				});
		}

			// Function to populate modal with data
			function populateModal(data) {
				modalTableBody.innerHTML = ''; // Clear the table body first
				if (data.hoursWorkedByEmployee && Object.keys(data.hoursWorkedByEmployee).length > 0) {
					modalNoDataRow.style.display = 'none';  // Hide "no data" message if we have data
					for (var key in data.hoursWorkedByEmployee) {
						var row = document.createElement('tr');
						row.innerHTML = `
	                   <td>${key}</td>
					   <td>${data.employeeName}</td>
	                   <td>${data.hoursWorkedByEmployee[key]}</td>
	                   <td>${data.totalWorkingHoursInMonth}</td>
	                   <td>${data.totalWorkingDaysExcludingHolidays}</td>
	                   <td>${data.presentDays[key]}</td>
	                   <td>${data.absentDays[key]}</td>
	                   <td>${data.overtime[key] || 0}</td>
	               `;
						modalTableBody.appendChild(row);
					}
				} else {
					modalNoDataRow.style.display = ''; // Show "no data" message
				}
			}

			// Event delegation to handle click on any "View Monthly Data" anchor tag
			document.body.addEventListener('click', function (event) {
				if (event.target && event.target.classList.contains('btn-view-monthly-data')) {
					event.preventDefault();  // Prevent default anchor behavior
					var monthName = event.target.getAttribute('data-month');  // Get the month from data-month attribute
					//alert(monthName);
					fetchAndPopulateModal(monthName);  // Fetch data based on the month
				}
			});
		});
	</script>

	<script>
	document.getElementById('checkYearlyData').addEventListener('click', function () {
	    const yearSelect = document.getElementById("yearSelect");
	    const selectedYear = yearSelect ? yearSelect.value : new Date().getFullYear(); // Fallback to current year if no selection
		//alert(selectedYear);
	    // Fetch attendance data using AJAX or Fetch API
	    
	    var email=document.getElementById('employeeEmail1').value;
	    //alert(email);
	    fetch(`/EmployeeAttendanceYearLive?year=${selectedYear}&email=${email}`)
	        .then(response => response.json())
	        .then(data => {
	            const tableBody = document.getElementById('attendanceTableBody');
	            tableBody.innerHTML = '';  // Clear previous table data

	            // Check if valid data is returned
	            if (data && data.hoursWorkedByEmployee && Object.keys(data.hoursWorkedByEmployee).length > 0) {
	                const employeeId = Object.keys(data.hoursWorkedByEmployee)[0]; // Get the employee ID key

	                const row = `
	                <tr>
	                    <td>${employeeId}</td>
	                    <td>${data.employeeName || 'N/A'}</td>
	                    <td>${data.hoursWorkedByEmployee[employeeId]}</td>
	                    <td>${data.totalWorkingHoursInYear}</td>
	                    <td>${data.totalWorkingDaysExcludingHolidays}</td>
	                    <td>${data.presentDays[employeeId]}</td>
	                    <td>${data.absentDays[employeeId]}</td>
	                    <td>${data.remainingWorkingDaysInYear}</td>
	                    <td>${data.overtimeMap[employeeId]}</td>
	                </tr>`;
	                tableBody.innerHTML += row;

	                // Show the modal with data
	                const modal = new bootstrap.Modal(document.getElementById('yearlyDataModal'));
	                modal.show();
	            } else {
	                // If no data is returned, show 'No data available'
	                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No data available</td></tr>';

	                // Show the modal with the no-data message
	                const modal = new bootstrap.Modal(document.getElementById('yearlyDataModal'));
	                modal.show();
	            }
	        })
	        .catch(error => {
	            console.error('Error fetching data:', error);
	            alert('Failed to load data.');
	        });
	});
	</script>

	<script>

		document.addEventListener('DOMContentLoaded', function () {
			
			var email=document.getElementById('employeeEmail1').value;
			
			const attendanceModal = document.getElementById('attendanceModal');
			const modalAttendanceTableBody = document.querySelector('#modalAttendanceTable tbody');
			const modalMonthlyAttendanceTableBody = document.querySelector('#modalMonthlyAttendanceTable tbody');
			const modalNoDataRow = document.querySelector('#modalNoDataRow');
			const employeeNameElement = document.getElementById('employeeName');
			const employeeIdElement = document.getElementById('employeeId');
			const employeeMonthElement = document.getElementById('employeeMonth'); 

			const remainingWorkingDaysHeader = document.getElementById('remainingWorkingDaysHeader');
			const currentMonth = new Date().toLocaleString('default', {month: 'long'}); // Get the current month name

			// Function to fetch and populate individual attendance data
			function fetchAttendanceDataForModal(monthName) {
					console.log(`Fetching data for the month: ${monthName}`);
				
					// Fetch data via AJAX
					fetch(`/attendanceLive/${monthName}/${email}`, {
						method: 'GET',
						headers: {
							'Content-Type': 'application/json'
						}
					})
					.then(response => response.json())
					.then(data => {
						modalAttendanceTableBody.innerHTML = ''; // Clear existing data
						
						if (data.length > 0) {
							
							// Display employee name and ID once (using the first entry's details)
							employeeNameElement.textContent = data[0].employeeName;
							employeeIdElement.textContent = data[0].eid;
							employeeMonthElement.textContent = monthName; // Display the month

							data.forEach(entry => {
								const date = new Date(entry.date);
								const formattedDate = `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;

								const row = `
			                        <tr>
			                            <td>${formattedDate}</td>
			                            <td>${entry.inTime}</td>
			                            <td>${entry.outTime}</td>
			                            <td>${entry.overtime}</td>
			                            <td>${entry.undertime}</td>
			                            <td>${entry.totalHours}</td>
			                        </tr>
			                    `;
								modalAttendanceTableBody.insertAdjacentHTML('beforeend', row);
							});
							modalNoDataRow.style.display = 'none'; // Hide "no data" message
						} else {
							modalNoDataRow.style.display = 'block'; // Show "no data" message
						}
					})
					.catch(error => {
						console.error('Error fetching attendance data:', error);
					});
			}

			// Function to fetch and populate monthly attendance data
			function fetchAndPopulateMonthlyData(monthName) {
				var email=document.getElementById('employeeEmail1').value;
				
				//console.log("email==="+email);
				fetch(`/EmployeeAttendanceLive?month=${encodeURIComponent(monthName)}&email=${encodeURIComponent(email)}`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				})
					.then(response => response.json())
					.then(data => {
						if (data) {
							//alert(JSON.stringify(data));
							populateMonthlyData(data, monthName); // Pass the fetched data and month to populateMonthlyData
							var bootstrapModal = new bootstrap.Modal(attendanceModal);
							bootstrapModal.show(); // Show modal after data is loaded
						} else {
							console.error('No data returned from server');
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
			}

			// Function to populate monthly data
			function populateMonthlyData(data, monthName) {
				// console.log("dattaaaaaa"+data);
				// console.log("dattaaaaaa"+JSON.stringify(data));
				modalMonthlyAttendanceTableBody.innerHTML = ''; // Clear the table body
				const isCurrentMonth = monthName === currentMonth; // Check if the month is the current month

				// Adjust visibility of the "Remaining Working Days" header
				if (isCurrentMonth) {
					remainingWorkingDaysHeader.style.display = 'table-cell'; // Show the header
					expectedHoursTillDateHeader.style.display = 'table-cell';
					document.querySelectorAll('#modalMonthlyAttendanceTable th').forEach(th => {
						th.style.display = 'table-cell';
					});
				} else {
					remainingWorkingDaysHeader.style.display = 'none'; // Hide the header
					expectedHoursTillDateHeader.style.display = 'none';
					document.querySelectorAll('#modalMonthlyAttendanceTable th').forEach(th => {
						if (th.textContent.trim() === 'Remaining Working Days' || th.textContent.trim() === 'Expected Hours Till Date') {
							th.style.display = 'none';
						}
					});
				}

				if (data.hoursWorkedByEmployee && Object.keys(data.hoursWorkedByEmployee).length > 0) {
					
					modalNoDataRow.style.display = 'none'; // Hide "no data" message if we have data
					
					for (var key in data.hoursWorkedByEmployee) {
						var row = document.createElement('tr');
						row.innerHTML = `
			                    <td>${data.totalWorkingDaysExcludingHolidays}</td>
			                    <td>${data.totalWorkingHoursInMonthDisplay}</td>
								${isCurrentMonth ? `<td>${data.expectedHoursTillDate}</td>` : ''}
			                    <td>${data.hoursWorkedByEmployee[key]}</td>
			                    <td>${data.presentDays[key]}</td>
			                    <td>${data.absentDays[key]}</td>
			                    ${isCurrentMonth ? `<td>${data.remainingWorkingDays}</td>` : ''} <!-- Conditionally display remaining days -->
							
								 <td>${data.overtime[key] || 0}</td>
			                    <td>${data.undertime[key] || 0}</td> <!-- Added Undertime Column -->
			                `;
						modalMonthlyAttendanceTableBody.appendChild(row);
					}
				} else {
					modalNoDataRow.style.display = ''; // Show "no data" message
				}
			}


			// Event delegation to handle click on any "View Monthly Data" anchor tag
			document.body.addEventListener('click', function (event) {
				if (event.target && event.target.classList.contains('btn-view-data')) {
					event.preventDefault(); // Prevent default anchor behavior
					var monthName = event.target.getAttribute('data-month'); // Get the month from data-month attribute
					fetchAttendanceDataForModal(monthName); // Fetch data based on the month
					fetchAndPopulateMonthlyData(monthName); // Fetch monthly data and show modal
				}
			});
		});

	</script>
	<!-- Check-out Confirmation Modal -->
	<div class="modal fade" id="checkOutModal" tabindex="-1" aria-labelledby="checkOutModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="checkOutModalLabel">Check-Out Confirmation</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p id="modalCheckOutText"></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" id="cancelCheckOut"
						data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="confirmCheckOut">Check Out</button>
				</div>
			</div>
		</div>
	</div>
	
	<script th:inline="javascript">
		var attendanceData = /*[[${attendanceData}]]*/ '[]'; // Convert attendanceData into JSON format
		//console.log("Attendance data from backend:***", attendanceData);
	</script>
	<!--Calendar Script-->
	<script th:inline="javascript">
		var attendanceData = /*[[${attendanceData}]]*/ '[]'; // Convert attendanceData into JSON format
		//console.log("Attendance data from backend:***", attendanceData);
	</script>

	<!--Calendar Script-->
	<script>

		var attendancePermission = document.getElementById('attendancePermission').getAttribute('data-attendance-permission') === 'true';
		//console.log("Attendance Permission: ", attendancePermission);


		// Function to fetch attendance status for a specific date and employee
		async function checkAttendanceStatus(date) {
		   // console.log(`Initiating attendance check for date: ${date}`);
		    try {
		    	
		    	var email=document.getElementById('employeeEmail1').value;
				
		        // Send a GET request to the backend
		        //const response = await fetch(`/check?date=${date}`);
		        const response = await fetch(`/check?date=${date}&email=${email}`);

		        //console.log(`Request sent to backend for date: ${date}`);

		        // Parse the response
		        const data = await response.json();
		       // console.log("Response received from backend:", data);

		        // Validate the response structure
		        if (data && data.exists !== undefined) {
		            if (data.exists) {
		                //console.log(`Attendance record exists for date: ${date}.`);
		            } else {
		                //console.log(`No attendance record found for date: ${date}.`);
		            }
		            return data.exists; // Return the boolean status
		        } else {
		            console.error("Unexpected response structure:", data);
		            return false;
		        }
		    } catch (error) {
		        console.error(`Error checking attendance status for date: ${date}`, error);
		        return false; // Return false in case of error
		    }
		}

	

		function genCalendar() {

			return {
				month_names: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
				day_names: ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'],
				year: '',
				currentYear: new Date().getFullYear(),
				
				startYear: 2024,
				//attendanceData: [], // This will be populated with the attendance data
				attendanceData: attendanceData,
				holidayData: [], // Holiday data
				probationCompletedDate: '', // Add this property to hold the probation date
				secondSaturdaysAfterProbation: [],
				fourthSaturdaysAfterProbation: [],
				earnedLeaveDates: [],
				leaveReasons: {},
				attendancePermission: attendancePermission,

				days_of_month() {
					leapYear = (year) => {return (year % 4 === 0 && year % 100 !== 0 && year % 400 !== 0) || (year % 100 === 0 && year % 400 === 0)};
					february = (year) => {return leapYear(year) ? 29 : 28};
					return [31, february(this.year), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
				},

				weekStart(firstDay, month) {
					let dayOfWeek = new Date(firstDay, month).getDay();
					switch (dayOfWeek) {
						case 0: dayOfWeek = 6; break;
						case 1: dayOfWeek = 0; break;
						case 2: dayOfWeek = 1; break;
						case 3: dayOfWeek = 2; break;
						case 4: dayOfWeek = 3; break;
						case 5: dayOfWeek = 4; break;
						case 6: dayOfWeek = 5; break;
						default: dayOfWeek = new Date(firstDay, month).getDay(); break;
					}
					return dayOfWeek;
				},

				daysGenerator() {

					let days = [];
					const today = new Date().toDateString();

					for (let k = 0; k < this.days_of_month().length; k++) {
						days.push([]);
						for (let i = 1; i <= this.days_of_month()[k]; i++) {
							if (days[k].length < this.weekStart(this.year, k)) {
								i -= i;
								days[k].push(null);
								continue;
							}
							// Check if today and attendance permission is true
							/*const today = new Date();
							if (this.isToday(i, k) && this.attendancePermission) {
								// Show Swal confirmation dialog
								this.showAttendanceSwal(i, k);
							
							}*/
							//const formattedDate = `${this.year}-${String(k + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
							const formattedDate = `${this.year}-${String(k + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
														
							console.log(`Checking attendance for date: ${formattedDate}`);

							// Check attendance permission and call fetchCheckinStatus
							if (this.isToday(i, k) && this.attendancePermission) {
								console.log("Today’s date matches, and attendance permission is granted.");
								/*	this.fetchCheckinStatus(formattedDate).then((checkinStatus) => {
										console.log(`Fetched checkin status for ${formattedDate}:`, checkinStatus);
										if (!checkinStatus) {
											console.log(`No check-in recorded for ${formattedDate}. Showing Swal confirmation.`);
											this.showAttendanceSwal(i, k);
										} else {
											console.log(`Check-in already done for ${formattedDate}, skipping Swal.`);
										}
									}).catch(error => {
										console.error("Error in fetchCheckinStatus:", error);
									});*/
								checkAttendanceStatus(formattedDate, employeeId).then((attendanceExists) => {
									console.log(`Attendance check for ${formattedDate}:`, attendanceExists);
									if (!attendanceExists) {
										console.log(`No attendance recorded for ${formattedDate}. Showing Swal confirmation.`);
										this.showAttendanceSwal(i, k);
									} else {
										console.log(`Attendance already exists for ${formattedDate}. Skipping Swal.`);
									}
								}).catch(error => {
									console.error("Error in attendance check:", error);
								});
							}

							days[k].push(i);
						}
					}
					return days;
				},

				currentDate() {
					let today = new Date();
				 this.year = today.getFullYear();

					//this.fetchAttendance();
					this.fetchHolidays();
					this.fetchProbationDate();
					this.fetchCheckinStatus();
					this.fetchCheckoutStatus();
					this.fetchEarnedLeaveDates();
					this.fetchAttendanceLeaves();
					
				}, canNavigateBack() {
					return this.year > this.startYear;
				},

				canNavigateForward() {
					return this.year < this.currentYear;
				},

				navigateBack() {
					if (this.canNavigateBack()) {
						this.year--;
					}
				},

				navigateForward() {
					if (this.canNavigateForward()) {
						this.year++;
					}
				},

				fetchAttendanceLeaves() {
					var email = document.getElementById('employeeEmail1').value; 
				    fetch(`/employee-leaves-attendance?email=${encodeURIComponent(email)}`)
				        .then(response => response.json())
				        .then(data => {
				            // Build a map of leave reasons for absent days
				            data.leaveDetails.forEach(leave => {
				                const date = leave.date;
				                const reason = leave.reason;
				                this.leaveReasons[date] = reason; // Map date to reason
				            });
				        })
				        .catch(error => console.error("Error fetching leave reasons:", error));
				},

				getLeaveReason(day, month) {
					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;
					return this.leaveReasons[formattedDate] || ''; // Return the leave reason if available
				},
				fetchCheckinStatus(date) {
					console.log(`Fetching check-in status for date: ${date}`);
					var email = document.getElementById('employeeEmail1').value;
					
					return fetch(`/user-checkin/${email}?date=${date}`)  // Corrected URL format
						.then(response => {
							if (!response.ok) {
								throw new Error('Failed to fetch check-in status');
							}
							console.log(`Response received for check-in status on ${date}`);
							return response.json();
						})
						.then(data => {
							console.log(`Check-in data received for ${date}:`, data);

							// Check if any entry has a checkinFlag of 1
							const hasCheckin = data.some(checkin => checkin.checkinFlag === 1);
							//const hasCheckout = data.some(checkin => checkin.checkoutFlag === 0);

							console.log(`Computed check-in flag for ${date}: ${hasCheckin}`);
							return hasCheckin;
						})
						.catch(error => {
							console.error(`Error fetching check-in status for ${date}:`, error);
							return false; // Default to no check-in if there’s an error
						});
				},

				/*fetchCheckoutStatus(date) {
					alert(date)
					console.log(`Fetching check-out status for date: ${date}`);
					var email = document.getElementById('employeeEmail1').value;
					alert("hi");
					//return fetch(`/user-checkin?date=${date}`)
					return fetch(`/user-checkin/${email}?date=${date}`)  // Corrected URL format
						.then(response => {
							if (!response.ok) {
								throw new Error('Failed to fetch check-out status');
							}
							console.log(`Response received for check-out status on ${date}`);
							return response.json();
						})
						.then(data => {
							console.log(`Check-out data received for ${date}:`, data);

							// Check if any entry has a checkoutFlag of 0
							const hasCheckoutPending = data.some(checkin => checkin.checkoutFlag === 0);

							console.log(`Computed checkout flag for ${date}: ${hasCheckoutPending}`);
							return hasCheckoutPending;
						})
						.catch(error => {
							console.error(`Error fetching check-out status for ${date}:`, error);
							return false; // Default to no check-out if there’s an error
						});
				},*/
				
				fetchCheckoutStatus(date) {
					
					var email = document.getElementById('employeeEmail1').value;
					//return fetch(`/user-checkin?date=${date}`)
					//return fetch(`/user-checkin/${email}?date=${date}`) 
					return fetch(`/user-checkin/${encodeURIComponent(email)}?date=${encodeURIComponent(date)}`)
						.then(response => {
							
							if (!response.ok) {
								throw new Error('Failed to fetch check-out status');
							}
							console.log(`Response received for check-out status on ${date}`);
							return response.json(); 
							
						})
						.then(data => {
							console.log(`Check-out data received for ${date}:`, data);

							// Check if any entry has a checkoutFlag of 0
							const hasCheckoutPending = data.some(checkin => checkin.checkoutFlag === 0);

							console.log(`Computed checkout flag for ${date}: ${hasCheckoutPending}`);
							return hasCheckoutPending;
						})
						.catch(error => {
							console.error(`Error fetching check-out status for ${date}:`, error);
							return false; // Default to no check-out if there’s an error
						});
				},


				onDateClick(day, month) {
					const formattedDate = `${this.year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					console.log(`Date clicked: ${formattedDate}`); // Log the clicked date

					this.fetchCheckinStatus(formattedDate).then((checkinExists) => {
						console.log(`Fetched check-in status for ${formattedDate}: ${checkinExists ? 'Check-in exists' : 'No check-in'}`); // Log check-in status

						// If check-in exists, check for check-out pending
						if (checkinExists) {
							this.fetchCheckoutStatus(formattedDate).then((checkoutPending) => {
								if (checkoutPending) {
									console.log(`Check-in is done, check-out is pending, showing Swal for check-out confirmation on ${formattedDate}.`);
									this.showCheckOutSwal(day, month); // Show Swal for check-out
								} else {
									console.log(`Check-in is done, but no check-out pending for ${formattedDate}.`);
								}
							}).catch(error => {
								console.error("Error in fetchCheckoutStatus:", error); // Log any errors encountered during fetch
							});
						} else {
							console.log(`No check-in for ${formattedDate}, no action required.`);
						}
					}).catch(error => {
						console.error("Error in fetchCheckinStatus:", error); // Log any errors encountered during fetch
					});
				},




				showCheckOutSwal(day, month) {
					const formattedDate = `${String(day).padStart(2, '0')}-${String(month + 1).padStart(2, '0')}-${this.year}`;

					/*	Swal.fire({
							title: 'Check-Out Confirmation',
							text: `Do you want to check out for ${formattedDate}?`,
							icon: 'question',
							showCancelButton: true,
							confirmButtonText: 'Check Out',
							cancelButtonText: 'Cancel'
						}).then((result) => {
							if (result.isConfirmed) {
								this.checkOut(day, month);
							}
						});*/

					// Set modal content dynamically
					document.getElementById('modalCheckOutText').innerText = `Do you want to check out for ${formattedDate}?`;

					// Show the modal
					const modal = new bootstrap.Modal(document.getElementById('checkOutModal'));
					modal.show();

					// Set up the action for when the user confirms
					document.getElementById('confirmCheckOut').onclick = () => {
						this.checkOut(day, month);
						modal.hide(); // Close the modal after confirming
					};

					// Set up the action for when the user cancels
					document.getElementById('cancelCheckOut').onclick = () => {
						modal.hide(); // Just close the modal if the user cancels
					};
				},
				checkOut(day, month) {
					const currentDate = new Date();
					const inTime = currentDate.toTimeString().split(' ')[0]; // Get current time in HH:MM:SS format
					const date = `${this.year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; // Format date as yyyy-mm-dd
					const pdt = `${date} ${inTime}`; // Combine date and time

					// Prepare the data to send
					const attendanceData = {
						// The empId is not sent from here; it will be fetched on the server
						inTime: inTime,
						date: date,
						pdt: pdt
					};

					console.log("Prepared attendance data:", attendanceData);

					// Send a POST request to the backend to save attendance
					//fetch('/checkout', {
					var email=document.getElementById('employeeEmail1').value;
					// Send a POST request to the backend to save attendance
					fetch(`/checkout/${email}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify(attendanceData)
					})
						.then(response => {
							// Check if the response is okay (status in the range 200-299)
							if (!response.ok) {
								throw new Error('Network response was not ok: ' + response.statusText);
							}
							return response.json();
						})
						.then(data => {
							console.log('Check-in successful:', data);
							// Show a success message
							Swal.fire({
								title: 'Success!',
								text: 'Attendance saved successfully.',
								icon: 'success',
								confirmButtonText: 'OK'
							});
							// Optionally, update the UI to reflect the check-in status
						})
						.catch((error) => {
							console.error('Error during check-in:', error);
							Swal.fire({
								title: 'Error!',
								text: 'There was an error saving your attendance. Please try again.',
								icon: 'error',
								confirmButtonText: 'OK'
							});
						});
				},


				showAttendanceSwal(day, month) {
					// Format the date in dd-mm-yyyy
					const formattedDate = `${String(day).padStart(2, '0')}-${String(month + 1).padStart(2, '0')}-${this.year}`;

					Swal.fire({
						title: 'Attendance Confirmation',
						text: `Do you want to check in for ${formattedDate}?`,
						icon: 'question',
						showCancelButton: true,
						confirmButtonText: 'Check In',
						cancelButtonText: 'Cancel'
					}).then((result) => {
						if (result.isConfirmed) {
							// Logic to check in
							this.checkIn(day, month);
						}
					});
				},
				checkIn(day, month) {
					const currentDate = new Date();
					const inTime = currentDate.toTimeString().split(' ')[0]; // Get current time in HH:MM:SS format
					const date = `${this.year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; // Format date as yyyy-mm-dd
					const pdt = `${date} ${inTime}`; // Combine date and time

					// Prepare the data to send
					const attendanceData = {
						// The empId is not sent from here; it will be fetched on the server
						inTime: inTime,
						date: date,
						pdt: pdt
					};

					console.log("Prepared attendance data:", attendanceData);

					// Send a POST request to the backend to save attendance
					//fetch('/checkin', {
					// Send a POST request to the backend to save attendance
					var email=document.getElementById('employeeEmail1').value;
					    // Send a POST request to the backend to save attendance
					fetch(`/checkin/${email}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify(attendanceData)
					})
						.then(response => {
							// Check if the response is okay (status in the range 200-299)
							if (!response.ok) {
								throw new Error('Network response was not ok: ' + response.statusText);
							}
							return response.json();
						})
						.then(data => {
							console.log('Check-in successful:', data);
							// Show a success message
							Swal.fire({
								title: 'Success!',
								text: 'Attendance saved successfully.',
								icon: 'success',
								confirmButtonText: 'OK'
							});
							// Optionally, update the UI to reflect the check-in status
						})
						.catch((error) => {
							console.error('Error during check-in:', error);
							Swal.fire({
								title: 'Error!',
								text: 'There was an error saving your attendance. Please try again.',
								icon: 'error',
								confirmButtonText: 'OK'
							});
						});
				},



					isToday(day, month) {
						const today = new Date();
						const currentDay = new Date(this.year, month, day);
						return today.toDateString() === currentDay.toDateString();
					},
				
					isCurrentMonth(index) {
					    const today = new Date();
					    const currentYear = today.getFullYear(); // Get the current year
					    const currentMonth = today.getMonth(); // 0-based index for the current month

					    // Check if both the year and the month match
					    return this.year === currentYear && index === currentMonth;
					},
					 isSandwichLeave(day, month) {
                        if (!day || !this.attendanceData.length) {
                            console.log("Skipping: Invalid day or attendance data not loaded.");
                            return false; // Skip if no day or attendance data is not loaded
                        }

                        const formattedDay = day < 10 ? `0${day}` : day;
                        const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
                        const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

                        // Ensure the holiday date exists in the leave details
                        if (!this.leaveReasons[formattedDate]) {
                            console.log(`Skipping: ${formattedDate} is not part of the leave details.`);
                            return false; // Not considered sandwich leave
                        }

                        // Check if the day is a Sunday, holiday, or second/fourth Saturday
                        if (this.isSunday(day, month) || this.isHoliday(day, month) || this.isSecondOrFourthSaturday(day, month)) {
                            console.log(`Skipping: ${formattedDate} is a Sunday, Holiday, or Second/Fourth Saturday.`);

                            let prevDay, nextDay;

                            if (this.isSunday(day, month)) {
                                const saturday = new Date(this.year, month, day - 1); // Previous day (potential Saturday)
                                if (this.isSecondOrFourthSaturday(saturday.getDate(), saturday.getMonth())) {
                                    prevDay = new Date(this.year, month, day - 2); // Check Friday (two days before Sunday)
                                } else {
                                    prevDay = saturday; // Previous day (Saturday)
                                }
                                nextDay = new Date(this.year, month, day + 1); // Day after (Monday)
                            } else if (this.isSecondOrFourthSaturday(day, month)) {
                                prevDay = new Date(this.year, month, day - 1); // Friday
                                nextDay = new Date(this.year, month, day + 2); // Monday
                            } else {
                                prevDay = new Date(this.year, month, day - 1); // Day before
                                nextDay = new Date(this.year, month, day + 1); // Day after
                            }

                            const isBeforeHolidayAbsent = !this.isPresentDay(prevDay.getDate(), prevDay.getMonth()) && !this.isHoliday(prevDay.getDate(), prevDay.getMonth());
                            const isAfterHolidayAbsent = !this.isPresentDay(nextDay.getDate(), nextDay.getMonth()) && !this.isHoliday(nextDay.getDate(), nextDay.getMonth());

                            console.log(`- Before holiday absent (adjusted): ${isBeforeHolidayAbsent}`);
                            console.log(`- After holiday absent: ${isAfterHolidayAbsent}`);

                            const isSandwich = isBeforeHolidayAbsent && isAfterHolidayAbsent;
                            console.log(`Is sandwich leave: ${isSandwich}`);
                            return isSandwich;
                        }

                        console.log("Skipping: Not a Sunday, Holiday, or Second/Fourth Saturday.");
                        return false;
                    },




					// Helper method to get the earliest attendance date
					getEarliestAttendanceDate() {
					    // Assuming attendanceData is an array of objects with a 'date' property
					    const earliestDate = this.attendanceData.reduce((earliest, current) => {
					        return (new Date(current.date) < new Date(earliest.date)) ? current : earliest;
					    });

					    return earliestDate.date; // Return the earliest date
					},

					isSkipDay(day, month) {
					    if (!day) return true; // Skip invalid days
					    // Skip Sundays
					    if (this.isSunday(day, month)) return true;
					    // Skip second and fourth Saturdays
					    if (this.isSecondOrFourthSaturday(day, month)) return true;
					    return false;
					},


				isSunday(day, month) {
					const currentDay = new Date(this.year, month, day);
					return currentDay.getDay() === 0;
				},
				isSecondOrFourthSaturday(day, month) {
					// Format the current date as YYYY-MM-DD
					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					// Check if this date is in the second or fourth Saturdays list after probation
					return this.secondSaturdaysAfterProbation.includes(formattedDate) || this.fourthSaturdaysAfterProbation.includes(formattedDate);
				},
				isHoliday(day, month) {
					if (!day) return false; // Skip empty days

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					//  console.log("Checking holiday date:", formattedDate); // Debugging line

					return this.holidayData.some(holiday => holiday.date === formattedDate);
				},

				getHolidayReason(day, month) {
					if (!day) return ''; // Skip empty days

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					const holiday = this.holidayData.find(holiday => holiday.date === formattedDate);
					return holiday ? holiday.name || 'Holiday' : ''; // Show holiday name or default message
				},

				isPresentDay(day, month) {
					if (!day) return false; // Skip if day is empty
					if (this.isSkipDay(day, month)) return false; // Skip Sundays and second/fourth Saturdays

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					//  console.log("Checking date:", formattedDate); // Debugging line
					//   console.log("Attendance data:", this.attendanceData.map(att => att.date)); // Debugging line
					
					return this.attendanceData.some(att => att.date === formattedDate);
				},
				isAttendanceOnSkipDay(day, month) {
				    if (!day) return false; // Invalid day, skip it

				    const formattedDay = day < 10 ? `0${day}` : day;
				    const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
				    const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

				    // Check if the day is a "skip day" (Sunday, second/fourth Saturday) or a holiday
				    const isSkipOrHoliday = this.isSkipDay(day, month) || this.isHoliday(day, month);

				    // Check if attendance exists for this "skip day" or holiday
				    const isAttendanceRecorded = isSkipOrHoliday && this.attendanceData.some(att => att.date === formattedDate);

				    // Log the details
				    if (isAttendanceRecorded) {
				        console.log(`Attendance recorded on skip day or holiday: ${formattedDate}`);
				    }

				    return isAttendanceRecorded;
				}, 

				/*isHalfDay(day, month) {
					if (!day) return false; // Skip if day is empty

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					const attendanceRecord = this.attendanceData.find(att => att.date === formattedDate);

				   // console.log("Checking half day for:", formattedDate, attendanceRecord); // Debugging line

					if (!attendanceRecord) return false;

					const totalHours = attendanceRecord.totalHours;
					const hours = totalHours.split(':')[0]; // Get the hours part
					const isHalfDay = parseInt(hours) < 5; // Check if hours are less than 5

				  //  console.log(`Is ${formattedDate} a half day?`, isHalfDay); // Debugging line
					return isHalfDay; // Check if hours are less than 5
				},*/
				isHalfDay(day, month) {
					if (!day) return false; // Skip if day is empty
					if (this.isSkipDay(day, month)) return false;
					if(this.isHoliday(day, month)) return false;

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					console.log(`Formatted Date: ${formattedDate}`);

					const attendanceRecord = this.attendanceData.find(att => att.date === formattedDate);
					if (!attendanceRecord) return false;

					const totalHours = attendanceRecord.totalHours;
					console.log(`Total Hours: ${totalHours}`);

					const hours = totalHours.split(':');
					const totalMinutes = parseInt(hours[0]) * 60 + parseInt(hours[1]);

					// Check if work hours are less than 2.5 hours, consider it as absent
					if (totalMinutes < 150) {
						console.log("Absent: Worked less than 2.5 hours");
						return false; // Return false as the employee is absent
					}

					// Define conditions for half-day
					const isWithinHalfDayRange = totalMinutes > 150 && totalMinutes < 420; // 2.5 hours = 150 minutes, 7 hours = 420 minutes
					console.log(`isWithinHalfDayRange: ${isWithinHalfDayRange}`);

					const inTime = attendanceRecord.inTime.split(':');
					const outTime = attendanceRecord.outTime.split(':');
					const checkInHour = parseInt(inTime[0]);
					const checkInMinute = parseInt(inTime[1]);
					const checkOutHour = parseInt(outTime[0]);
					const checkOutMinute = parseInt(outTime[1]);

					// Check for first half (check-out before 2 PM)
					const isFirstHalfDay = (checkOutHour < 14) || (checkOutHour === 14 && checkOutMinute === 0);
					console.log(`isFirstHalfDay: ${isFirstHalfDay} (CheckOut: ${checkOutHour}:${checkOutMinute})`);
					// Check for second half (check-in after 12 PM)
					const isSecondHalfDay = (checkInHour > 12) || (checkInHour === 12 && checkInMinute > 0);
					console.log(`isSecondHalfDay: ${isSecondHalfDay} (CheckIn: ${checkInHour}:${checkInMinute})`);

					// Log the color you want to apply for the day
					return isWithinHalfDayRange && (isFirstHalfDay || isSecondHalfDay);
				},

				isFirstHalfDay(day, month) {
					const formattedDate = this.formatDate(day, month);
					const attendanceRecord = this.attendanceData.find(att => att.date === formattedDate);
					const outTime = attendanceRecord?.outTime.split(':') || [];
					const checkOutHour = parseInt(outTime[0]);
					const checkOutMinute = parseInt(outTime[1]);

					return (checkOutHour < 14) || (checkOutHour === 14 && checkOutMinute === 0);
				},

				isSecondHalfDay(day, month, isLessThanSevenHours) {
					const formattedDate = this.formatDate(day, month);
					const attendanceRecord = this.attendanceData.find(att => att.date === formattedDate);
					const inTime = attendanceRecord?.inTime.split(':') || [];
					const checkInHour = parseInt(inTime[0]);
					const checkInMinute = parseInt(inTime[1]);

					return (checkInHour > 12) || (checkInHour === 12 && checkInMinute > 0);
				},
				isLessThanTwoAndHalfHours(day, month) {
					if (!day) return false; // Skip if day is empty
					if (this.isSkipDay(day, month)) return false;

					const formattedDate = this.formatDate(day, month);
					const attendanceRecord = this.attendanceData.find(att => att.date === formattedDate);

					if (!attendanceRecord) return false;

					const totalHours = attendanceRecord.totalHours;

					// Exclude records where totalHours is "00:00:00"
					if (totalHours === "00:00:00") return false;

					//comented the bellow three line because it was not including the seconds 
					
					//const hours = totalHours.split(':');
				//	const totalMinutes = parseInt(hours[0]) * 60 + parseInt(hours[1]);

					// Return true if less than 150 minutes (2.5 hours) but not 0
					//return totalMinutes > 0 && totalMinutes < 150;
					const [hh, mm, ss] = totalHours.split(':').map(Number); // Convert all to numbers
					    const totalSeconds = hh * 3600 + mm * 60 + ss; // Convert hours, minutes, and seconds to total seconds

					    // Check if total time is less than 2.5 hours (150 minutes = 9000 seconds)
					    return totalSeconds > 0 && totalSeconds < 9000;
				},


				isWithinSevenHours(day, month) {
					if (!day) return false; // Skip if day is empty
					if (this.isSkipDay(day, month)) return false;

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					const attendanceRecord = this.attendanceData.find(att => att.date === formattedDate);
					if (!attendanceRecord) return false;



					const totalHours = attendanceRecord.totalHours;


					// If the total hours is 00:00, return false (don't consider this record)
					if (totalHours === '00:00:00') return false;

					const hours = totalHours.split(':');
					const totalMinutes = parseInt(hours[0]) * 60 + parseInt(hours[1]);

					// Define condition for less than 6 hours (less than 360 minutes)
					const isLessThanSevenHours = totalMinutes < 360;
					console.log(`isLessThanSevenHours: ${isLessThanSevenHours}`);

					// Check if the date is part of the first or second half day, and only consider it within seven hours if not
					const isFirstHalf = this.isFirstHalfDay(day, month);
					const isSecondHalf = this.isSecondHalfDay(day, month);

					// If it's not in the first or second half, we consider it within seven hours
					if (!(isFirstHalf || isSecondHalf)) {
						return isLessThanSevenHours;
					} else {
						return false; // If it's already in first or second half, do not include in seven-hour range
					}


				},
				isNoAttendanceRecord(day, month) {
					if (this.isSkipDay(day, month)) return false;
					const formattedDate = this.formatDate(day, month);
					const attendanceRecord = this.attendanceData.find(att => att.date === formattedDate);

					if (!attendanceRecord) return false;

					const totalHours = attendanceRecord.totalHours;

					// If total hours is '00:00:00', return true for absence
					return totalHours === '00:00:00';
				},
				isEarnedLeaveDate(day, month) {
					if (!day) return false;

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					if (!Array.isArray(this.earnedLeaveDates)) {
						console.error("earnedLeaveDates is not an array:", this.earnedLeaveDates);
						return false;
					}

					return this.earnedLeaveDates.includes(formattedDate);
				},







				formatDate(day, month) {
					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					return `${this.year}-${formattedMonth}-${formattedDay}`;
				},


				/*isAbsentDay(day, month) {
					if (!day || this.isSunday(day, month) || this.isHoliday(day, month)) return false; // Skip Sundays and holidays
					if (!this.attendanceData.length) return false; // Skip if attendance data is not loaded

					
					
					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					// Find the earliest date in the attendance data
					const earliestDate = new Date(Math.min(...this.attendanceData.map(att => new Date(att.date))));

					// Current date to compare
					const currentDate = new Date();

					// Check if the date is in the future
					const dateToCheck = new Date(this.year, month, day);
					if (dateToCheck > currentDate) return false; // Skip future dates

					// Check if the date is within the attendance range
					if (dateToCheck < earliestDate) return false;

					// Check if the date is not present in the attendance data
					return !this.isPresentDay(day, month) && !this.holidayData.some(holiday => holiday.date === formattedDate);
				},*/
				isAbsentDay(day, month) {
					if (!day || this.isSunday(day, month) || this.isHoliday(day, month)) return false; // Skip Sundays and holidays
					if (!this.attendanceData.length) return false; // Skip if attendance data is not loaded

					const formattedDay = day < 10 ? `0${day}` : day;
					const formattedMonth = month + 1 < 10 ? `0${month + 1}` : month + 1;
					const formattedDate = `${this.year}-${formattedMonth}-${formattedDay}`;

					// Find the earliest date in the attendance data
					const earliestDate = new Date(Math.min(...this.attendanceData.map(att => new Date(att.date))));

					// Current date to compare
					const currentDate = new Date();

					// Check if the date is in the future
					const dateToCheck = new Date(this.year, month, day);
					if (dateToCheck > currentDate) return false; // Skip future dates

					// Check if the date is within the attendance range
					if (dateToCheck < earliestDate) return false;
					
					

					// Check if the date is not present in the attendance data
					return !this.isPresentDay(day, month)
						&& !this.holidayData.some(holiday => holiday.date === formattedDate)
						&& !this.isSecondOrFourthSaturday(day, month); // Exclude second and fourth Saturdays
				},
				


				fetchEarnedLeaveDates() {
					//fetch('/last-increment-date')
					var email=document.getElementById('employeeEmail1').value;
				
			   	    fetch(`/last-increment-date?email=${encodeURIComponent(email)}`)
						.then(response => response.json())
						.then(data => {
							this.earnedLeaveDates = data || [];
							console.log("Fetched Earned Leave Dates:", this.earnedLeaveDates);
						})
						.catch(error => {
							console.error("Error fetching earned leave dates:", error);
							this.earnedLeaveDates = []; // Ensure it's always an array
						});
				},



				fetchProbationDate() {
					//fetch(`/getProbationDate`) // Endpoint to fetch probation completion date
					var email=document.getElementById('employeeEmail1').value;
				
				    fetch(`/getProbationDate?email=${encodeURIComponent(email)}`)
						.then(response => response.json())
						.then(data => {
							console.log("Probation Date Data:", data); // Log the response data
							this.probationCompletedDate = data.probation_completed_date; // Assuming the response has this property
							console.log("Probation Completed Date:", this.probationCompletedDate); // Log the probation date
							this.calculateSaturdays(); // Call the function to calculate Saturdays
						})
						.catch(error => console.error('Error fetching probation date:', error));
				},

				/*calculateSaturdays() {
					if (!this.probationCompletedDate) return;

					// Parse the probation completion date and add 2 years
					const probationEndDate = new Date(this.probationCompletedDate);
					probationEndDate.setFullYear(probationEndDate.getFullYear() + 2);  // Add 2 years to probation date
					console.log('Probation End Date:', probationEndDate.toISOString());

					const startYear = probationEndDate.getFullYear();
				
					let secondSaturdays = [];
					let fourthSaturdays = [];

					// Iterate through each month starting from the probation end date's month
					for (let month = probationEndDate.getMonth(); month < 12; month++) {
						let saturdayCount = 0;  // Reset the count for each month
						console.log(`Processing month: ${month + 1}`);  // Log current month being processed

						// Iterate through the days of the month
						for (let day = 1; day <= this.days_of_month()[month]; day++) {
							let date = new Date(startYear, month, day);

							// Check if the day is a Saturday
							if (date.getUTCDay() === 6) { // Use getUTCDay to avoid time zone issues
								saturdayCount++;
								console.log(`Saturday found: ${date.toISOString()}, Saturday Count: ${saturdayCount}`);

								// Only consider Saturdays after the probation end date
								if (date > probationEndDate) {
									if (saturdayCount === 2) {
										console.log(`Second Saturday after probation: ${date.toISOString()}`);
										secondSaturdays.push(date.toISOString().split('T')[0]);
									} else if (saturdayCount === 4) {
										console.log(`Fourth Saturday after probation: ${date.toISOString()}`);
										fourthSaturdays.push(date.toISOString().split('T')[0]);
									}
								}
							}
						}
					}

					// Store the calculated second and fourth Saturdays
					this.secondSaturdaysAfterProbation = secondSaturdays;
					this.fourthSaturdaysAfterProbation = fourthSaturdays;

					// Log the final result
					console.log('Second Saturdays:', secondSaturdays);
					console.log('Fourth Saturdays:', fourthSaturdays);
				},*/
				calculateSaturdays() {
				    console.log("Function calculateSaturdays called.");

				    if (!this.probationCompletedDate) {
				        console.log("Probation completed date is not set. Exiting function.");
				        return;
				    }

				    const probationEndDate = new Date(this.probationCompletedDate);
				  //  probationEndDate.setFullYear(probationEndDate.getFullYear() + 2); // +2 years from probation date
				    console.log("Probation End Date calculated:", probationEndDate.toISOString());

				    const currentDate = new Date();
				    const startYear = probationEndDate.getFullYear();
				    const endYear = currentDate.getFullYear();

				    let secondSaturdays = [];
				    let fourthSaturdays = [];
				    console.log("Initialized arrays for second and fourth Saturdays.");

				    // Iterate through each year from the start year to the current year
				    for (let year = startYear; year <= endYear; year++) {
				        for (let month = 0; month < 12; month++) {
				            console.log(`Processing month: ${month + 1} (${year})`);

				            const saturdays = []; // Array to store Saturdays for this month
				            console.log("Initialized array for Saturdays in the current month.");

				            // Get the last day of the current month
				            const lastDayOfMonth = new Date(year, month + 1, 0).getDate(); // 0 returns the last day of the month
				            console.log(`Last day of month ${month + 1}: ${lastDayOfMonth}`);

				            // Start the iteration from 1 to the last day of the current month
				            for (let day = 1; day <= lastDayOfMonth; day++) {
				                const date = new Date(Date.UTC(year, month, day));

				                // Check if the day is a Saturday
				                if (date.getUTCDay() === 6) {
				                    saturdays.push(date);
				                    console.log(`Saturday found and added to array: ${date.toISOString()}`);
				                }
				            }

				            // Add the 2nd Saturday if it exists and is after probation end date
				            if (saturdays.length >= 2 && saturdays[1] >= probationEndDate) {
				                console.log(`Second Saturday of the month: ${saturdays[1].toISOString()}`);
				                secondSaturdays.push(saturdays[1].toISOString().split('T')[0]);
				            } else {
				                console.log("No valid second Saturday found for the month.");
				            }

				            // Add the 4th Saturday if it exists and is after probation end date
				            if (saturdays.length >= 4 && saturdays[3] >= probationEndDate) {
				                console.log(`Fourth Saturday of the month: ${saturdays[3].toISOString()}`);
				                fourthSaturdays.push(saturdays[3].toISOString().split('T')[0]);
				            } else {
				                console.log("No valid fourth Saturday found for the month.");
				            }
				        }
				    }

				    this.secondSaturdaysAfterProbation = secondSaturdays;
				    console.log("Second Saturdays after probation set:", secondSaturdays);

				    this.fourthSaturdaysAfterProbation = fourthSaturdays;
				    console.log("Fourth Saturdays after probation set:", fourthSaturdays);

				    // Log final results
				    console.log('Final list of Second Saturdays:', secondSaturdays);
				    console.log('Final list of Fourth Saturdays:', fourthSaturdays);
				}





				,










				/*	fetchAttendance() {
						fetch(`/attendanceCalendar`)
							.then(response => response.json())
							.then(data => {
								console.log("Attendance data$$:", data); // Add this line for debugging
								this.attendanceData = data;
	
							})
							.catch(error => console.error('Error fetching attendance:', error)); // Add error handling
	
					},*/
					fetchHolidays() {
						fetch(`/holidayCalendar`)
							.then(response => response.json())
							.then(data => {
								//console.log("holidayyyyyyyy = "+JSON.stringify(data));
								this.holidayData = data;
							})
							.catch(error => console.error('Error fetching holidays:', error));
					}

			}
		}

		/*	document.addEventListener('DOMContentLoaded', function () {
				const toggleButton = document.getElementById('toggleViewButton');
				const calendarView = document.getElementById('calendarView');
				const tableView = document.getElementById('tableView');
			    
				toggleButton.addEventListener('click', function () {
					if (calendarView.classList.contains('show', 'active')) {
						calendarView.classList.remove('show', 'active');
						tableView.classList.add('show', 'active');
						toggleButton.textContent = ' Calendar View';
					} else {
						tableView.classList.remove('show', 'active');
						calendarView.classList.add('show', 'active');
						toggleButton.textContent = ' Table View';
					}
				});
			});*/

	</script>


	<!--LEAVES IMPLEMENTATION-->
	<!-- Add this in your HTML file -->
	<script>


	document.addEventListener("DOMContentLoaded", function () {
			const activeTabId = localStorage.getItem('activeTab');
		    
			if (activeTabId) {
		    	// Activate the tab
		        const activeTab = document.getElementById(activeTabId);
		        if (activeTab) {
		        	setTimeout(()=>{
		        		const tab = new bootstrap.Tab(activeTab);
			            tab.show();
		        	},1000);
		            // Clear the stored tab ID
		            localStorage.removeItem('activeTab');
		        }
		    }
	
			// Tab click event to fetch leave data when the profile tab is shown
			document.getElementById('profile-tab').addEventListener('shown.bs.tab', function (event) {
				fetchLeavesData();
			});

			// Modal event to fetch team lead and coordinator when the leave request modal is shown
			$('#requestLeaveModal').on('show.bs.modal', function () {
				// Use Promise.all to handle both AJAX requests simultaneously
				Promise.all([
					fetchTeamLeadAndCoordinator(),
					fetchApprovingAuthorities()
				]).then(([teamLeadAndCoordinator, approvingAuthorities]) => {
					const approvingAuthorityDropdown = document.getElementById('approvingAuthority');

					// Empty the dropdown before populating
					approvingAuthorityDropdown.innerHTML = '';

					// Append team lead and coordinator to the dropdown
					if (teamLeadAndCoordinator) {
						const [teamLead, coordinator] = teamLeadAndCoordinator;

						if (teamLead) {
							const teamLeadOption = document.createElement('option');
							teamLeadOption.value = teamLead;
							teamLeadOption.text = teamLead;
							approvingAuthorityDropdown.appendChild(teamLeadOption);
						}

						if (coordinator) {
							const coordinatorOption = document.createElement('option');
							coordinatorOption.value = coordinator;
							coordinatorOption.text = coordinator;
							approvingAuthorityDropdown.appendChild(coordinatorOption);
						}
					}

					// Append approving authorities (e.g., HR employees) to the dropdown
					console.log(approvingAuthorities);
					if (approvingAuthorities) {
						approvingAuthorities.forEach(authority => {
							const option = document.createElement('option');
							option.value = authority;
							option.text = authority;
							approvingAuthorityDropdown.appendChild(option);
						});
					}
					// Automatically select all options
					Array.from(approvingAuthorityDropdown.options).forEach(option => {
						option.selected = true;
						option.classList.add('custom-selected');
					});
				}).catch(error => console.error('Error fetching data:', error));
			});
		});

		const existingLeaves = [];

		document.getElementById('requestLeaveModal').addEventListener('show.bs.modal', () => {
			var email=document.getElementById('employeeEmail1').value;

			fetch(`/employee-leaves/${email}`, {
				method: 'GET'
			})
				.then(response => response.json())
				.then(data => {
					console.log("data--ffff"+JSON.stringify(data));
					// Store existing leaves in a variable
					existingLeaves.length = 0; // Clear previous data
					data.leaveApplications.forEach(application => {
						existingLeaves.push({
							fromDate: new Date(application.from_date),
							toDate: new Date(application.to_date),
							approvedstatus: application.approvedstatus
						});
					});					
				})
				.catch(error => {
					console.error('Error fetching leave data:', error);
				});
		});


		/*	function isDateRangeValid(fromDate, toDate) {
				console.log(`Checking validity for range: ${fromDate} to ${toDate}`);
			    
				for (const leave of existingLeaves) {
					console.log(`Comparing with existing leave: ${leave.fromDate} to ${leave.toDate}`);
				    
					if ((fromDate >= leave.fromDate && fromDate <= leave.toDate) || 
						(toDate >= leave.fromDate && toDate <= leave.toDate) || 
						(fromDate <= leave.fromDate && toDate >= leave.toDate)) {
						console.log('Dates overlap found.AA');
						return false; // Dates overlap
					}
				}
			    
				console.log('No overlap found.');
				return true; // No overlap
			}*/

		function isDateRangeValid(fromDate, toDate) {
			
			
			console.log(`Checking validity for range: ${fromDate} to ${toDate}`);
			console.log("Existing Leaves:", existingLeaves);
			for (const leave of existingLeaves) {
				console.log(`Leave Object:`, leave);
				console.log(`Leave Approved Status: ${leave.approvedstatus}`); // Log the approved status

				// Check if the leave is rejected
				if (leave.approvedstatus === 'Rejected') {
					console.log(`Ignoring rejected leave: ${leave.fromDate} to ${leave.toDate}`);
					continue; // Skip to the next iteration
				}
				
				console.log(`Comparing with existing leave: ${leave.fromDate} to ${leave.toDate}`);

				// Convert dates to timestamps for comparison
				const leaveFromDate = new Date(leave.fromDate).getTime();
				const leaveToDate = new Date(leave.toDate).getTime();
				const startDate = new Date(fromDate).getTime();
				const endDate = new Date(toDate).getTime();

				// Check for overlap
				if ((startDate >= leaveFromDate && startDate <= leaveToDate) ||
					(endDate >= leaveFromDate && endDate <= leaveToDate) ||
					(startDate <= leaveFromDate && endDate >= leaveToDate)) {
					console.log('Dates overlap found with an approved leave.');
					return false; // Dates overlap
				}
			}

			console.log('No overlap found.');
			return true; // No overlap
		}

		function fetchLeavesData() {
			
				var email=document.getElementById('employeeEmail1').value;
				fetch(`/employee-leaves/${email}`, {
					method: 'GET'
				})
				.then(response => response.json())
				.then(data => {				 	
					// Populate the leaves table with the JSON data
					updateLeavesTable(data.leaveApplications);
				})
				.catch(error => {
					console.error('Error fetching leave data:', error);
				});
				
		}
		
		




		/*	function updateLeavesTable(leaveApplications) {
				const tableBody = document.querySelector('#leaveApplicationsTable tbody');
				tableBody.innerHTML = ''; // Clear the table before populating new data
	
				if (leaveApplications.length === 0) {
					// If no data, show a message
					tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data available</td></tr>';
				} else {
					// Populate the table with leave applications
					leaveApplications.forEach(application => {
						const fromDate = new Date(application.fromDate);
						const toDate = new Date(application.toDate);
						const requestedDate = new Date(application.requestedDate);
	
						const formattedFromDate = `${fromDate.getDate()}-${fromDate.getMonth() + 1}-${fromDate.getFullYear()}`;
						const formattedToDate = `${toDate.getDate()}-${toDate.getMonth() + 1}-${toDate.getFullYear()}`;
						const formattedRequestedDate = `${requestedDate.getDate()}-${requestedDate.getMonth() + 1}-${requestedDate.getFullYear()}`;
	
						// Calculate the number of days between fromDate and toDate
						const timeDifference = toDate - fromDate;
						const daysDifference = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1; // +1 to include both start and end dates
	
						const row = document.createElement('tr');
						row.innerHTML = `
								<td>${formattedFromDate} to ${formattedToDate}<br><small>${daysDifference} day(s)</small></td>
								<td>${application.leaveType}</td>
								<td>${application.reason}</td>
								<td class="${application.approvedstatus == 'Pending' ? 'pending' : (application.approvedstatus == 'Approved' ? 'approved' : 'rejected')}">${application.approvedstatus}</td>
								<td>${formattedRequestedDate}</td>
								<td>${application.approvedstatus !== 'Pending' ? application.approved_by : '-'}</td>
								<td>${application.rejection_reason || '-'}</td>
							`;
						tableBody.appendChild(row);
					});
				}
			}*/
			
/* 			function updateLeavesTable(leaveApplications) {
				
				const tableBody = document.querySelector('#leaveApplicationsTable tbody');
				tableBody.innerHTML = ''; // Clear the table before populating new data

				if (leaveApplications.length === 0) {
					// If no data, show a message
					tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data available</td></tr>';
				} else {
					console.log("leaveApplications----"+JSON.stringify(leaveApplications));
					// Populate the table with leave applications
					leaveApplications.forEach(application => {
						const fromDate = new Date(application.from_date);
						const toDate = new Date(application.to_date);
						
						console.log("application.requested_date"+application.requested_date);
						const requestedDate = new Date(application.requested_date);
						
						console.log("fromDate---"+fromDate);
						console.log("toDate---"+toDate);
						console.log("requestedDate---"+requestedDate);
						
						const formattedFromDate = `${fromDate.getDate()}-${fromDate.getMonth() + 1}-${fromDate.getFullYear()}`;
						const formattedToDate = `${toDate.getDate()}-${toDate.getMonth() + 1}-${toDate.getFullYear()}`;
						const formattedRequestedDate = `${requestedDate.getDate()}-${requestedDate.getMonth() + 1}-${requestedDate.getFullYear()} ${requestedDate.getHours()}:${requestedDate.getMinutes()}:${requestedDate.getSeconds()}`;

						console.log("formattedFromDate---"+formattedFromDate);
						console.log("formattedToDate---"+formattedToDate);
						console.log("formattedRequestedDate---"+formattedRequestedDate);
						// Calculate the number of days between fromDate and toDate
						const timeDifference = toDate - fromDate;
						const daysDifference = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1; // +1 to include both start and end dates

						// Apply red color for leave type LOP
						const leaveTypeStyle = application.leaveType === 'LOP' ? 'style="color:red;"' : '';

						const row = document.createElement('tr');
						row.innerHTML = `
			                <td>${formattedFromDate} to ${formattedToDate}<br><small>${daysDifference} day(s)</small></td>
			                <td ${leaveTypeStyle}>${application.leaveType}</td>
			                <td>${application.reason}</td>
			                <td>${formattedRequestedDate}</td>
			                <td style="color: ${application.approvedstatus === 'Pending' ? 'red' : 'inherit'};">${application.approvedstatus}</td>
			                
			                <td>${application.approvedstatus !== 'Pending' ? application.approved_by : '-'}</td>
			                <td>${application.rejection_reason || '-'}</td>
			                <td>${application.remarks || '-'}</td>
			            `;
						tableBody.appendChild(row);
					});
				}
			} */
			
			function updateLeavesTable(leaveApplications) {
				const tableBody = document.querySelector('#leaveApplicationsTable tbody');
				tableBody.innerHTML = ''; // Clear the table before populating new data

				if (leaveApplications.length === 0) {
					// If no data, show a message
					tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data available</td></tr>';
				} else {
					// Populate the table with leave applications
					leaveApplications.forEach(application => {
						const fromDate = new Date(application.from_date);
						const toDate = new Date(application.to_date);
						const requestedDate = new Date(application.requested_date);

						//const formattedFromDate = `${fromDate.getDate()}-${fromDate.getMonth() + 1}-${fromDate.getFullYear()}`;
						//const formattedToDate = `${toDate.getDate()}-${toDate.getMonth() + 1}-${toDate.getFullYear()}`;
						//const formattedRequestedDate = `${requestedDate.getDate()}-${requestedDate.getMonth() + 1}-${requestedDate.getFullYear()}`;
						//const formattedRequestedDate = `${requestedDate.getDate()}-${requestedDate.getMonth() + 1}-${requestedDate.getFullYear()} ${requestedDate.getHours().toString().padStart(2, '0')}:${requestedDate.getMinutes().toString().padStart(2, '0')}:${requestedDate.getSeconds().toString().padStart(2, '0')}`;
						// Format dates with leading zeroes for day and month
									const formattedFromDate = `${fromDate.getDate().toString().padStart(2, '0')}-${(fromDate.getMonth() + 1).toString().padStart(2, '0')}-${fromDate.getFullYear()}`;
									const formattedToDate = `${toDate.getDate().toString().padStart(2, '0')}-${(toDate.getMonth() + 1).toString().padStart(2, '0')}-${toDate.getFullYear()}`;
									const formattedRequestedDate = `${requestedDate.getDate().toString().padStart(2, '0')}-${(requestedDate.getMonth() + 1).toString().padStart(2, '0')}-${requestedDate.getFullYear()} ${requestedDate.getHours().toString().padStart(2, '0')}:${requestedDate.getMinutes().toString().padStart(2, '0')}:${requestedDate.getSeconds().toString().padStart(2, '0')}`;

						// Calculate the number of days between fromDate and toDate
						const timeDifference = toDate - fromDate;
						const daysDifference = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1; // +1 to include both start and end dates

						// Determine the leave duration text
						           let leaveDurationText = `${daysDifference} day(s)`;
						           if (application.leaveDuration === 'Half Day') {
						               leaveDurationText = 'Half Day';
						           } else if (application.leaveDuration === 'One and a Half Days') {
						               const adjustedDays = daysDifference - 1; // Remove 1 full day
						               leaveDurationText = `${adjustedDays} and a Half Day(s)`;
						           }
						// Apply red color for leave type LOP
						const leaveTypeStyle = application.leaveType === 'LOP' ? 'style="color:red;"' : '';

						const row = document.createElement('tr');
						row.innerHTML = `
						<td>${formattedFromDate} to ${formattedToDate}<br><small>${leaveDurationText}</small></td>
			                <td ${leaveTypeStyle}>${application.leaveType}</td>
			                <td>${application.reason}</td>
			                <td>${formattedRequestedDate}</td>
			                <td class="${application.approvedstatus == 'Pending' ? 'pending' : (application.approvedstatus == 'Approved' ? 'approved' : 'rejected')}">${application.approvedstatus}</td>
			                
			                <td>${application.approvedstatus !== 'Pending' ? application.approved_by : '-'}</td>
			                <td>${application.rejection_reason || '-'}</td>
							<td>${application.remarks || '-'}</td> <!-- Remarks column with default '-' if no remarks -->
			            `;
						tableBody.appendChild(row);
					});
				}
			}

			function fetchTeamLeadAndCoordinator() {
				var email = document.getElementById('employeeEmail1').value;
				//console.log("aaaa=="+email);
				return fetch(`/employee-leaves/${email}`)
					.then(response => response.json())
					.then(data => {
						console.log('Team Lead and Coordinator:', data.teamLeadAndCoordinator[0]); // Log the data
						return data.teamLeadAndCoordinator[0]; // Return the data
					})
					.catch(error => {
						console.error('Error fetching team lead and coordinator:', error);
						return null; // Return null in case of error
					});
			}

			function fetchApprovingAuthorities() {
				return fetch('/approving-authorities')
					.then(response => response.json())
					.then(data => {
						
						return data.approvingAuthorities;
					})
					.catch(error => {
						console.error('Error fetching approving authorities:', error);
						return []; // Return empty array in case of error
					});
			}


	</script>
	
	
	
	
	
	<script>
		/* SUBMITTING THE LEAVE FORM */
		/*   document.getElementById('leaveForm').addEventListener('submit', function(event) {
			     
				 event.preventDefault();
			   
			     const fromDate = new Date(document.getElementById('fromDate').value);
				 const toDate = new Date(document.getElementById('toDate').value);
				 const leaveType = document.getElementById('leaveType').value;
				 
				 // Calculate the total leave days
					 const totalLeaveDays = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
   
				 //THIS IS CHECKING IF THE SAME DATE IS SUBMITTING TWICE
				 // Validate the date range
				 if (!isDateRangeValid(fromDate, toDate)) {
					 document.getElementById('dateOverlap').style.display = 'block'; // Show error message
					 return; // Stop form submission
				 } else {
					 document.getElementById('dateOverlap').style.display = 'none'; // Hide error message
				 }
				 
				 
			   // Collect form data
			   const formData = new FormData(this);
			   const data = {};
			   formData.forEach((value, key) => {
				   if (key === 'approvingAuthority') {
					   // Convert selected options to a comma-separated string
					   const selectedOptions = Array.from(document.getElementById('approvingAuthority').selectedOptions)
													.map(option => option.value)
													.filter(value => value.trim() !== '') // Filter out any empty values
													.join(',');
					   data[key] = selectedOptions;
					   } else if (key === 'leaveDuration') {
								// Add leave duration to the data object
								data[key] = value;
				   } else {
					   data[key] = value;
				   }
			   });
   	
		   	
			   // Debugging
			   console.log(data);
		   	
		   	
   	
			   // Send data via AJAX
			   fetch('/applyLeave', {
				   method: 'POST',
				   headers: {
					   'Content-Type': 'application/json',
				   },
				   body: JSON.stringify(data),
			   })
			   .then(response => response.json())
			   .then(result => {
				   console.log("Server response:", result); 
				   if (result.message === "Leave request saved successfully") {  // Check the message field
							 Swal.fire({
						   title: 'Success!',
						   text: 'Request sent successfully',
						   icon: 'success',
						   confirmButtonText: 'Ok'
					   }).then(() => {
						   // Optionally reset the form or hide the modal
						   document.getElementById('leaveForm').reset();
						   // Hide the modal
						   const modal = bootstrap.Modal.getInstance(document.getElementById('requestLeaveModal'));
						   modal.hide();
					   });
				   } else {
					   Swal.fire({
						   title: 'Error!',
						   text: 'There was an error saving the request',
						   icon: 'error',
						   confirmButtonText: 'Ok'
					   });
				   }
			   })
			   .catch(error => {
				   Swal.fire({
					   title: 'Error!',
					   text: 'There was an error saving the request',
					   icon: 'error',
					   confirmButtonText: 'Ok'
				   });
			   });
		   });*/

		/*	document.getElementById('leaveForm').addEventListener('submit', function (event) {
				event.preventDefault();
	
				const fromDate = new Date(document.getElementById('fromDate').value);
				const toDate = new Date(document.getElementById('toDate').value);
				const leaveType = document.getElementById('leaveType').value;
	
				const totalLeaveDays = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
	
	
				// Hide the maternity leave error message initially
				document.getElementById('maternityLeaveError').style.display = 'none';
	
				// Validation for Maternity Leave
				const diffMonths = (toDate.getFullYear() - fromDate.getFullYear()) * 12 + (toDate.getMonth() - fromDate.getMonth());
				if ((leaveType === 'ML' || leaveType === 'maternity') && diffMonths !== 6) {
					document.getElementById('maternityLeaveError').style.display = 'block';
					return;
				}
	
				if (!isDateRangeValid(fromDate, toDate)) {
					document.getElementById('dateOverlap').style.display = 'block';
					return;
				} else {
					document.getElementById('dateOverlap').style.display = 'none';
				}
	
				const formData = new FormData(this);
				const data = {};
				formData.forEach((value, key) => {
					if (key === 'approvingAuthority') {
						const selectedOptions = Array.from(document.getElementById('approvingAuthority').selectedOptions)
							.map(option => option.value)
							.filter(value => value.trim() !== '')
							.join(',');
						data[key] = selectedOptions;
					} else {
						data[key] = value;
					}
				});
	
				// Submit to the regular leave endpoint
				fetch('/applyLeave', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data),
				})
					.then(response => response.json())
					.then(result => {
						if (result.message === "Leave request saved successfully") {
							if (leaveType === 'ML' || leaveType === 'maternity') {
								// If leave type is maternity, submit to the maternity leave endpoint as well
								fetch('/applyMaternityLeave', {
									method: 'POST',
									headers: {
										'Content-Type': 'application/json',
									},
									body: JSON.stringify(data),
								})
									.then(response => response.json())
									.then(result => {
										Swal.fire({
											title: 'Success!',
											text: 'Maternity leave request sent successfully',
											icon: 'success',
											confirmButtonText: 'Ok'
										}).then(() => {
											document.getElementById('leaveForm').reset();
											const modal = bootstrap.Modal.getInstance(document.getElementById('requestLeaveModal'));
											modal.hide();
										});
									})
									.catch(error => {
										Swal.fire({
											title: 'Error!',
											text: 'There was an error saving the maternity leave request',
											icon: 'error',
											confirmButtonText: 'Ok'
										});
									});
							} else {
								Swal.fire({
									title: 'Success!',
									text: 'Request sent successfully',
									icon: 'success',
									confirmButtonText: 'Ok'
								}).then(() => {
									document.getElementById('leaveForm').reset();
									const modal = bootstrap.Modal.getInstance(document.getElementById('requestLeaveModal'));
									modal.hide();
								});
							}
						} else {
							Swal.fire({
								title: 'Error!',
								text: 'There was an error saving the request',
								icon: 'error',
								confirmButtonText: 'Ok'
							});
						}
					})
					.catch(error => {
						Swal.fire({
							title: 'Error!',
							text: 'There was an error saving the request',
							icon: 'error',
							confirmButtonText: 'Ok'
						});
					});
	
	
			});*/


		document.getElementById('leaveForm').addEventListener('submit', function (event) {
			
			event.preventDefault();
			//alert("hi");
			const fromDate = new Date(document.getElementById('fromDate').value);
			const toDate = new Date(document.getElementById('toDate').value);
			 
			const leaveType = document.getElementById('leaveType').value;

			const totalLeaveDays = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;

			// Hide error messages initially
			document.getElementById('maternityLeaveError').style.display = 'none';
			document.getElementById('dateOverlap').style.display = 'none';

			// Maternity leave validation
			const diffMonths = (toDate.getFullYear() - fromDate.getFullYear()) * 12 + (toDate.getMonth() - fromDate.getMonth());
			
			if ((leaveType === 'ML' || leaveType === 'maternity') && diffMonths !== 6) {
				document.getElementById('maternityLeaveError').style.display = 'block';
				return;
			}
			
			if (!isDateRangeValid(fromDate, toDate)) {
				//alert("isDateRangeValid");
				document.getElementById('dateOverlap').style.display = 'block';
				return;
			}

			// Collect form data
			const formData = new FormData(this);
			const data = {};
			console.log(document.getElementById('fromDate').value);
			console.log("fromdate"+data.fromDate); 
			formData.forEach((value, key) => {
				if (key === 'approvingAuthority') {
					const selectedOptions = Array.from(document.getElementById('approvingAuthority').selectedOptions)
						.map(option => option.value)
						.filter(value => value.trim() !== '')
						.join(',');
					data[key] = selectedOptions;
				} else {
					data[key] = value;
				}
			});

			// Function to continue with leave submission
			const submitLeaveRequest = () => {
				// Show the loading modal
			    document.getElementById('loadingPopup').style.display = 'flex';
			
				console.log("leave data=="+data);
				console.log("leave data=="+JSON.stringify(data));
				var email=document.getElementById('employeeEmail1').value;
				
				console.log("d,d,d,d,d,"+JSON.stringify(data));
				
				fetch(`/applyLeave/${email}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data),
				})
					.then(response => response.json())
					.then(result => {
						if(result.message === "Leave request saved successfully") {
							
							// Additional action for Maternity or LOP leave
							if (leaveType === 'ML' || leaveType === 'maternity') {
								// Submit to maternity leave endpoint
								return submitMaternityLeave(data);
							} else if (leaveType === 'LOP') {
								// Save LOP in the designated table
								return saveLOPLeave(data);
							}
							loadingPopup.style.display = 'none'; // Ensure the popup is hidden
							showSuccessMessage();
						} else {
							showError();
						}
					})
					.catch(showError);
			};

			// LOP Confirmation
			if (leaveType === 'LOP') {
				
				Swal.fire({
					title: 'Are you sure?',
					text: 'You are applying for Loss of Pay leave. Do you want to continue?',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Yes',
					cancelButtonText: 'No',
				}).then((result) => {
					if (result.isConfirmed) {
						submitLeaveRequest();
					}
				});
			} else {
				submitLeaveRequest();
			}

			function showSuccessMessage() {
				loadingPopup.style.display = 'none'; // Ensure the popup is hidden
				Swal.fire({
					title: 'Success!',
					text: 'Request sent successfully',
					icon: 'success',
					confirmButtonText: 'Ok'
				}).then(() => {
					document.getElementById('leaveForm').reset();
					const modal = bootstrap.Modal.getInstance(document.getElementById('requestLeaveModal'));
					modal.hide();
					
					fetchLeavesData();
					 // Save the active tab ID in localStorage
			        //localStorage.setItem('activeTab', 'profile-tab');

			        // Reload the page after closing the modal
			        //location.reload();
				});
			}

			function showError() {
				Swal.fire({
					title: 'Error!',
					text: 'There was an error saving the request',
					icon: 'error',
					confirmButtonText: 'Ok'
				});
			}

			function submitMaternityLeave(data) {
				
				var email=document.getElementById('employeeEmail1').value;
			
				fetch(`/applyMaternityLeave/${email}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data),
				})
					.then(response => response.json())
					.then(() => showSuccessMessage())
					.catch(showError);
			}

			function saveLOPLeave(data) {
				
				var email=document.getElementById('employeeEmail1').value;
				fetch(`/applyLOPLeave/${email}`, { // Assuming the endpoint for LOP leave
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data),
				})
					.then(response => response.json())
					.then(() => showSuccessMessage())
					.catch(showError);
			}
		});

	</script>
	
	<script>
		/*VALIDATING THE FROMDATE AND TO DATE  i.e this function is check that to date should not be less than  from date */
		// Function to validate the date fields
		function validateDate() {
			
			const fromDate = document.getElementById('fromDate').value;
			const toDate = document.getElementById('toDate').value;
			const dateError = document.getElementById('dateError');
			const submitBtn = document.getElementById('submitBtn');

			if (fromDate && toDate) {
				// Compare the dates
				if (new Date(toDate) < new Date(fromDate)) {
					// Show error if To Date is earlier than From Date
					dateError.style.display = 'block';
					submitBtn.disabled = true;
				} else {
					// Hide error and enable submit button if dates are valid
					dateError.style.display = 'none';
					submitBtn.disabled = false;
				}
			}
		}

		// Add event listeners to the date fields
		document.getElementById('fromDate').addEventListener('input', validateDate);
		document.getElementById('toDate').addEventListener('input', validateDate);

		// Optional: Prevent form submission if dates are invalid
		document.getElementById('leaveForm').addEventListener('submit', function (event) {
			if (document.getElementById('submitBtn').disabled) {
				event.preventDefault();
			}
		});

		/*TO REMOVE THE ERROR MESSAGE OF DATE ERROR WHEN CLOSING THE MODAL*/
		// Event listener for when the modal is hidden (closed)
		const leaveModal = document.getElementById('requestLeaveModal');
		leaveModal.addEventListener('hidden.bs.modal', function (event) {
			
			// Hide the error message when the modal is closed
			const dateError = document.getElementById('dateError');
			dateError.style.display = 'none'; // Hide the error message
			document.getElementById('maternityLeaveError').style.display = 'none'; // Hide maternity leave error

			// Optionally, reset the form if you want to clear all input fields
			document.getElementById('leaveForm').reset();

		});

		/*TO CLEAR THE ERROR MESSAGE OF DATEOVERLAP*/
		// Clear the error message when the modal is closed
		document.getElementById('requestLeaveModal').addEventListener('hidden.bs.modal', () => {
			document.getElementById('dateOverlap').style.display = 'none';
		});

		// Hide the error message when the date fields change
		document.getElementById('fromDate').addEventListener('change', hideErrorMessage);
		document.getElementById('toDate').addEventListener('change', hideErrorMessage);

		function hideErrorMessage() {
			document.getElementById('dateOverlap').style.display = 'none'; // Hide error message
			document.getElementById('maternityLeaveError').style.display = 'none';
		}

		// Function to disable past dates for date inputs
		/*document.addEventListener('DOMContentLoaded', function () {
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('fromDate').setAttribute('min', today);
			document.getElementById('toDate').setAttribute('min', today);

			// Optional: Ensure "To" date cannot be earlier than "From" date
			//  document.getElementById('fromDate').addEventListener('change', function() {
			//	  const fromDateValue = this.value;
			//	  document.getElementById('toDate').setAttribute('min', fromDateValue);
			//  });
		});*/

	</script>

	
	<!-- script to notification -->
<script>
document.addEventListener("DOMContentLoaded", () => {
		    console.log("DOMContentLoaded event fired!");
		    const leaveDetailsLink = document.getElementById("leaveDetailsLink");
		    const loadingSpinner = document.getElementById("loadingSpinner");

		    if (leaveDetailsLink) {
		        console.log("leaveDetailsLink found and ready to use.");
		        var email=document.getElementById('employeeEmail1').value;
		        
		        leaveDetailsLink.addEventListener("click", function (event) {
		            event.preventDefault();
		            console.log("leaveDetailsLink clicked!");

		            // Show the spinner
		            loadingSpinner.style.display = "block";

		            var email=document.getElementById('employeeEmail1').value;
			            // First fetch: Fetch leave records from the backend
		            fetch(`/leaveRecords/${email}`, { method: 'GET' })
		                .then(response => {
		                    console.log("Fetch request sent for leave records");

		                    if (!response.ok) {
		                        throw new Error('Network response was not ok for leave records');
		                    }
		                    return response.json();
		                })
		                .then(data => {
		                    console.log("Leave records data received from backend:", data);

		                    const tbody = document.querySelector('#leaveRecordsTable');
		                    tbody.innerHTML = ''; // Clear existing rows

		                    if (!data || data.length === 0) {
		                        const sickLeaveRow = document.createElement('tr');
		                        sickLeaveRow.innerHTML = `
		                            <td>Sick Leave</td>
		                            <td>0</td>
		                            <td>0</td>
		                            <td>0</td>
		                        `;
		                        tbody.appendChild(sickLeaveRow);

		                        const casualLeaveRow = document.createElement('tr');
		                        casualLeaveRow.innerHTML = `
		                            <td>Casual Leave</td>
		                            <td>0</td>
		                            <td>0</td>
		                            <td>0</td>
		                        `;
		                        tbody.appendChild(casualLeaveRow);
		                    } else {
		                        data.forEach(record => {
		                            const row = document.createElement('tr');
		                            row.innerHTML = `
		                                <td>${record.leaveType}</td>
		                                <td>${record.totalAdded || '0'}</td>
		                                <td>${record.totalUsed || '0'}</td>
		                                <td>${record.remaining || '0'}</td>
		                            `;
		                            tbody.appendChild(row);
		                        });
		                    }

		                    return fetch('/fetchMaternityLeave/${email}', { method: 'GET' });
		                })
		                .then(response => {
		                    if (response.status === 204) {
		                        console.log("No maternity leave records found, proceeding to the next fetch.");
		                        return;
		                    }

		                    if (!response.ok) {
		                        throw new Error('Network response was not ok for maternity leave');
		                    }
		                    return response.json();
		                })
		                .then(maternityLeaves => {
		                    if (maternityLeaves) {
		                        console.log("Maternity leave data received:", maternityLeaves);
		                        const tbody = document.querySelector('#leaveRecordsTable');

		                        maternityLeaves.forEach(leave => {
		                            if (leave.approvedstatus === 'Rejected') return;

		                            let leaveUsed = leave.leaveUsed || '0';
		                            let leaveRemaining = leave.leaveRemaining || '0';

		                            if (leave.approvedstatus === 'Pending') {
		                                leaveUsed = '-';
		                                leaveRemaining = leave.totalLeaveDays;
		                            } else if (leave.approvedstatus === 'Approved') {
		                                leaveUsed = leave.totalLeaveDays;
		                                leaveRemaining = '-';
		                            }

		                            const row = document.createElement('tr');
		                            row.innerHTML = `
		                                <td>Maternity Leave</td>
		                                <td>${leave.totalLeaveDays}</td>
		                                <td>${leaveUsed}</td>
		                                <td>${leaveRemaining}</td>
		                            `;
		                            tbody.appendChild(row);
		                        });
		                    }

		                    const currentYear = new Date().getFullYear();
		                    var email=document.getElementById('employeeEmail1').value;
		                    return fetch(`/fetch-earned-leave?year=${currentYear}&email=${email}`, { method: 'GET' });
		                })
		                .then(response => {
		                    console.log("Fetch request sent for static earned leave");
		                    console.log("Fetch request sent for static earned leave");
		                    console.log("Static Earnedss Leave Response Status:", response.status);

		                    if (!response.ok) {
		                        throw new Error('Network response was not ok for static earned leave');
		                    }
		                    return response.json();
		                })
		                .then(() => fetch(`/calculate-earned-leave?year=${new Date().getFullYear()}&email=${email}`, { method: 'GET' }))
		                .then(response => {
		                    console.log("Fetch request sent for calculated earned leave");
		                    console.log("Fetch request sent for calculated earned leave");
		                    console.log("Calculated Earned Leave Response Status:", response.status);

		                    if (!response.ok) {
		                        throw new Error('Network response was not ok for calculated earned leave');
		                    }
		                    return response.json();
		                })
		                .then(earnedLeave => {
		                    console.log("Calculated leave data received from backend:", earnedLeave);

		                    const row = document.createElement('tr');
		                    row.innerHTML = `
		                        <td>Earned Leave</td>
		                        <td>${earnedLeave.earnedLeave || '0'}</td>
		                        <td>${earnedLeave.elUsed || '0'}</td>
		                        <td>${earnedLeave.elRemaining || '0'}</td>
		                    `;
		                    const tbody = document.querySelector('#leaveRecordsTable');
		                    tbody.appendChild(row);

		                    // Hide the spinner and show the modal
		                    loadingSpinner.style.display = "none";

		                    const modal = new bootstrap.Modal(document.getElementById('leaveDetailsModal'));
		                    modal.show();
		                })
		                .catch(error => {
		                    console.error('Error fetching data:', error);

		                    // Hide the spinner on error
		                    loadingSpinner.style.display = "none";
		                });
		        });
		    } else {
		        console.error("Element with ID 'leaveDetailsLink' not found.");
		    }
		});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
	console.log("DOMContentLoaded event fired!");

	// Initialize leave balances
	let leaveBalances = {
		sl: 0,
		cl: 0,
		el: 0
	};

	// Fetch leave balances when the modal opens
	const requestLeaveBtn = document.getElementById("requestLeaveBtn");
	requestLeaveBtn.addEventListener("click", () => {
		console.log("Request Leave button clicked. Fetching leave balances...");

		var email = document.getElementById('employeeEmail1').value;
		fetch(`/leaveRecords/${email}`) 
			.then(response => response.json())
			.then(data => {
				data.forEach(record => {
					if (record.leaveType === "Sick Leave") {
						leaveBalances.sl = record.remaining;
					} else if (record.leaveType === "Casual Leave") {
						leaveBalances.cl = record.remaining;
					}
				});
				console.log("Leave balances fetched:", leaveBalances);
			})
			.then(() => {
				return fetch(`/calculate-earned-leave?year=${new Date().getFullYear()}&email=${email}`);
			})
			.then(response => response.json())
			.then(data => {
				if (data && data.elRemaining !== undefined) {
					leaveBalances.el = data.elRemaining;
				}
				console.log("Earned Leave fetched:", leaveBalances.el);
			})
			.then(() => {
				    								var email = document.getElementById('employeeEmail1').value;
                                                        // Fetch future leave applications
                                                        return fetch(`/getFutureLeaveApplications/${email}`);
                                                    })
                                                    .then(response => response.json())
                                                    .then(futureLeaves => {
                                                        console.log("Fetched future leave applications:", futureLeaves);

                                                        // Adjust leave balances based on future leaves
                                                        futureLeaves.forEach(leave => {
                                                            if (leave.approvedstatus !== "Rejected") { // Ignore rejected leave requests
	                                                            
                                                            	const leaveFromDate = new Date(leave.from_date);
	                                                            const leaveToDate = new Date(leave.to_date);
	                                                            
	                                                            const leaveDaysRequested = calculateLeaveDuration(leaveFromDate, leaveToDate);
															    
	                                                            console.log("leaveDaysRequested="+leaveDaysRequested);
	                                                            console.log("leaveBalances[leave.leaveType.toLowerCase()]="+leaveBalances[leave.leaveType.toLowerCase()]);
															    
	                                                            leaveBalances[leave.leaveType.toLowerCase()] -= leaveDaysRequested;
                                                            }
                                                        });
                                                        console.log("Adjusted leave balances after considering future leaves:", leaveBalances);
                                                    })
			.catch(error => {
				console.error('Error fetching data:', error);
			});
	});

	// Real-time validation elements
	const fromDateInput = document.getElementById("fromDate");
	const toDateInput = document.getElementById("toDate");
	const leaveTypeInput = document.getElementById("leaveType");
	const errorMessageDiv = document.getElementById("error-message");
	const submitButton = document.getElementById("submitBtn");

	
	 // Function to calculate the duration of leave
    function calculateLeaveDuration(fromDate, toDate) {
        return Math.round((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1; // Include end date
    }
	 
	// Function to check if two dates are in the same financial year
	function isSameFinancialYear(fromDate, toDate) {
		// Financial year starts on 26 March and ends on 25 March the next year
		const fromYear = fromDate.getFullYear();
		const toYear = toDate.getFullYear();

		const financialYearStart = new Date(fromYear, 2, 26); // 26 March
		const financialYearEnd = new Date(fromYear + 1, 2, 25); // 25 March next year

		// If the "From Date" is before 26 March of the financial year and "To Date" is after, it's invalid
		if (fromDate < financialYearStart && toDate > financialYearStart) {
			return false; // Crosses the financial year boundary
		}

		// Adjust the next financial year if needed
		const nextFinancialYearStart = new Date(toYear, 2, 26);
		const nextFinancialYearEnd = new Date(toYear + 1, 2, 25);

		if (fromDate < nextFinancialYearStart && toDate > nextFinancialYearStart) {
			return false; // Crosses to the next financial year
		}

		return true;
	}

	// Function to validate leave including financial year check
	function validateLeave() {
		const fromDate = new Date(fromDateInput.value);
		const toDate = new Date(toDateInput.value);
		const selectedLeaveType = leaveTypeInput.value;

		// Only validate if all fields are selected/filled
		if (!fromDateInput.value || !toDateInput.value || !selectedLeaveType) {
			errorMessageDiv.style.display = "none"; // Hide error message until all fields are filled
			submitButton.disabled = true;
			return;
		}

		// If the selected leave type is LOP, bypass validation
		if (selectedLeaveType === "LOP") {
			errorMessageDiv.style.display = "none";
			submitButton.disabled = false;
			return;
		}

		const leaveDaysRequested = Math.round((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1; // Include the end date
		let availableLeaveDays = 0;

		// Calculate available leave days based on the selected leave type
		if (selectedLeaveType === "SL") {
			availableLeaveDays = leaveBalances.sl;
		} else if (selectedLeaveType === "CL") {
			availableLeaveDays = leaveBalances.cl;
		} else if (selectedLeaveType === "EL") {
			availableLeaveDays = leaveBalances.el;
		}

		// Validate financial year boundaries
		if ((selectedLeaveType !== "ML" && selectedLeaveType !== "EL") && !isSameFinancialYear(fromDate, toDate)) {
			errorMessageDiv.textContent = "You cannot request leave that crosses into the next financial year. Please select dates within the same financial year.";
			errorMessageDiv.style.display = "block";
			submitButton.disabled = true;
			return;
		}

		// Validation logic for leave days and available balance
		if (fromDate > toDate) {
			// Display error if "From Date" is later than "To Date"
			errorMessageDiv.textContent = "Invalid Date Range: 'From Date' should not be later than 'To Date'.";
			errorMessageDiv.style.display = "block";
			submitButton.disabled = true;
		} else if (selectedLeaveType !== "ML" && leaveDaysRequested > availableLeaveDays) {
			// Display error if requested leave days exceed available leave days
			errorMessageDiv.textContent = `You do not have enough leave balance for ${selectedLeaveType}. Available: ${availableLeaveDays}, Requested: ${leaveDaysRequested}`;
			errorMessageDiv.style.display = "block";
			submitButton.disabled = true;
		} else {
			// Hide error message and enable submit button if validation passes
			errorMessageDiv.style.display = "none";
			submitButton.disabled = false;
		}
	}

	// Add event listeners for real-time validation on date and leave type changes
	fromDateInput.addEventListener("change", validateLeave);
	toDateInput.addEventListener("change", validateLeave);
	leaveTypeInput.addEventListener("change", validateLeave);

	// Reset form validation on modal close/reset
	const leaveForm = document.getElementById("leaveForm");
	leaveForm.addEventListener("reset", function () {
		errorMessageDiv.style.display = "none"; // Hide error message
		submitButton.disabled = false; // Enable submit button
	});
});
</script>
	
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const params = new URLSearchParams(window.location.search);
			const tab = params.get('tab'); // Get the 'tab' parameter

			if (tab === 'leaves') {
				// Activate the Leaves tab
				const leavesTab = new bootstrap.Tab(document.getElementById('profile-tab'));
				setTimeout(function(){ 
					leavesTab.show();
				},1000);
			}
		});
	</script>
	
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script>	
	$(document).ready(function() {
			 
				document.getElementById('contact-tab').addEventListener('shown.bs.tab', function() {
				      // Call the function for contact tab
					  console.log("Fetching project names for grid aaaa count...");
				      getProjectNameForGridCount();
				  });
				  document.getElementById('performance-sub-tab1').addEventListener('shown.bs.tab', function() {
				        // Call the function for Projectwise tab
						console.log("Fetching project names for grid bbbb count...");
				        getProjectNameForGridCount();
				    });
			    // Event listener for Quarterly Performance Tab
			    document.getElementById('performance-sub-tab2').addEventListener('click', function () {
			        console.log("Loading performance chart...");
			        loadPerformanceChart();  // Call this function for Quarterly Performance
			    });
			});

			function openCompletedProjectsModal() {
			    const completedProjectsContent = document.getElementById('completedProjectsContent');
			    completedProjectsContent.innerHTML = ''; // Clear any previous content
			    
			    var email=document.getElementById('employeeEmail1').value;

			    // Fetch data and populate modal with projects and performance details by quarter
			    fetch(`/getEmployeePerformance?email=${encodeURIComponent(email)}`)
			        .then(response => response.json())
			        .then(data => {
			            // Filter and group project details by quarter, only if 'quarter' is defined
			            const quarters = { Q1: [], Q2: [], Q3: [], Q4: [] };
			            const overallPerformance = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
			            const count = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };

			            data.forEach(item => {
			                if (item.quarter && Math.round(item.performance) > 0) {
			                    quarters[item.quarter].push(item);
			                    overallPerformance[item.quarter] += item.performance;
			                    count[item.quarter]++;
			                }
			            });

			            // Calculate the overall performance by quarter
			            const quarterNames = {
			                Q1: "Q1 (Apr-Jun)",
			                Q2: "Q2 (Jul-Sep)",
			                Q3: "Q3 (Oct-Dec)",
			                Q4: "Q4 (Jan-Mar)"
			            };

			            // Create the tab headers and content for each quarter
			            let tabs = `
			                <ul class="nav nav-tabs nav-tabs-bordered" id="quarterTabs" role="tablist" style="display: flex; justify-content: space-between; width: 100%; padding: 0;">
			                    <li class="nav-item" style="flex-grow: 1;">
			                        <a class="nav-link active" id="q1-tab" data-bs-toggle="tab" href="#q1" role="tab" aria-controls="q1" aria-selected="true" style="font-size: 14px; text-align: center;">${quarterNames.Q1}</a>
			                    </li>
			                    <li class="nav-item" style="flex-grow: 1;">
			                        <a class="nav-link" id="q2-tab" data-bs-toggle="tab" href="#q2" role="tab" aria-controls="q2" aria-selected="false" style="font-size: 14px; text-align: center;">${quarterNames.Q2}</a>
			                    </li>
			                    <li class="nav-item" style="flex-grow: 1;">
			                        <a class="nav-link" id="q3-tab" data-bs-toggle="tab" href="#q3" role="tab" aria-controls="q3" aria-selected="false" style="font-size: 14px; text-align: center;">${quarterNames.Q3}</a>
			                    </li>
			                    <li class="nav-item" style="flex-grow: 1;">
			                        <a class="nav-link" id="q4-tab" data-bs-toggle="tab" href="#q4" role="tab" aria-controls="q4" aria-selected="false" style="font-size: 14px; text-align: center;">${quarterNames.Q4}</a>
			                    </li>
			                </ul>
			                <div class="tab-content" id="quarterTabContent">
			            `;

			            // Function to generate table content for a specific quarter
			            function generateTableContent(quarterData) {
			                if (quarterData.length === 0) {
			                    return "<p style='margin-top: 20px; text-align: center;'>No Available Data.</p>";
			                } else {
			                    let tableContent = `
			                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
			                            <thead>
			                                <tr style="background-color: #f9f9f9; padding-top: 10px;">
			                                    <th style="padding: 10px; border-bottom: 1px solid #ddd;">Project</th>
			                                    <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">Subtask</th>
			                                    <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">Performance (%)</th>
			                                </tr>
			                            </thead>
			                            <tbody>`;
			                    quarterData.forEach(item => {
			                        const roundedPerformance = Math.round(item.performance);
			                        tableContent += `
			                            <tr>
			                                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.projectName}</td>
			                                <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${item.subtaskName}</td>
			                                <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center; padding-right: 15px;">${roundedPerformance}%</td>
			                            </tr>`;
			                    });
			                    tableContent += `</tbody></table>`;
			                    return tableContent;
			                }
			            }

			            // Generate tab content for each quarter
			            tabs += `
			                <div class="tab-pane fade show active" id="q1" role="tabpanel" aria-labelledby="q1-tab">
			                    ${generateTableContent(quarters.Q1)}
			                    <div style="text-align: right; margin-top: 15px; font-weight: bold;">
			                        <span>Quarterly Performance (Q1): ${count.Q1 > 0 ? Math.round(overallPerformance.Q1 / count.Q1) : 0}%</span>
			                    </div>
			                </div>
			                <div class="tab-pane fade" id="q2" role="tabpanel" aria-labelledby="q2-tab">
			                    ${generateTableContent(quarters.Q2)}
			                    <div style="text-align: right; margin-top: 15px; font-weight: bold;">
			                        <span>Quarterly Performance (Q2): ${count.Q2 > 0 ? Math.round(overallPerformance.Q2 / count.Q2) : 0}%</span>
			                    </div>
			                </div>
			                <div class="tab-pane fade" id="q3" role="tabpanel" aria-labelledby="q3-tab">
			                    ${generateTableContent(quarters.Q3)}
			                    <div style="text-align: right; margin-top: 15px; font-weight: bold;">
			                        <span>Quarterly Performance (Q3): ${count.Q3 > 0 ? Math.round(overallPerformance.Q3 / count.Q3) : 0}%</span>
			                    </div>
			                </div>
			                <div class="tab-pane fade" id="q4" role="tabpanel" aria-labelledby="q4-tab">
			                    ${generateTableContent(quarters.Q4)}
			                    <div style="text-align: right; margin-top: 15px; font-weight: bold;">
			                        <span>Quarterly Performance (Q4): ${count.Q4 > 0 ? Math.round(overallPerformance.Q4 / count.Q4) : 0}%</span>
			                    </div>
			                </div>
			            `;

			            tabs += `</div>`; // Close tab-content

			            // Insert the tabs into the modal content
			            completedProjectsContent.innerHTML = `
			              
			                ${tabs}`;
			            
			            // Open the modal using Bootstrap’s JavaScript API
			            const completedProjectsModal = new bootstrap.Modal(document.getElementById('completedProjectsModal'));
			            completedProjectsModal.show();
			        })
			        .catch(error => console.error('Error fetching performance data:', error));
			}



		/*n	function loadPerformanceChart() {
			    const performanceChartContainer = document.getElementById('performanceChartContainer');
				

			    fetch(`/getEmployeePerformance`)
			        .then(response => response.json())
			        .then(data => {
			            const categories = [];
			            const performanceData = [];
			            const quarterlyData = {
			                "Q1 (Apr - Jun)": 0,
			                "Q2 (Jul - Sep)": 0,
			                "Q3 (Oct - Dec)": 0,
			                "Q4 (Jan - Mar)": 0
			            };
			            const quarterlyLabels = ["Q1 (Apr - Jun)", "Q2 (Jul - Sep)", "Q3 (Oct - Dec)", "Q4 (Jan - Mar)"];

			            data.forEach(item => {
			                const roundedPerformance = Math.round(item.performance);

			                if (item.projectName === "Quarterly Performance") {
			                    const quarterLabel = item.subtaskName + ` (${getQuarterMonths(item.subtaskName)})`;
			                    if (quarterlyData.hasOwnProperty(quarterLabel)) {
			                        quarterlyData[quarterLabel] = roundedPerformance;
			                    }
			                } else {
			                    categories.push(item.projectName + ' - ' + item.subtaskName);
			                    performanceData.push(roundedPerformance);
			                }
			            });

			            // Render individual project performance chart
			            Highcharts.chart(performanceChartContainer, {
			                chart: { type: 'bar' },
			                title: { text: 'Project Performance Metrics' },
			                xAxis: {
			                    categories: categories,
			                    title: { text: 'Projects and Tasks' },
			                    labels: { style: { fontSize: '12px' } }
			                },
			                yAxis: {
			                    title: { text: 'Performance (%)' },
			                    plotLines: [{
			                        color: 'red',
			                        value: 0,
			                        width: 2,
			                        label: { text: 'Overdue' }
			                    }]
			                },
			                series: [{
			                    name: 'Performance',
			                    data: performanceData,
			                    color: '#3498db'
			                }],
			                tooltip: {
			                    formatter: function() {
			                        return `<b>${this.x}</b><br>Performance: ${this.y}%`;
			                    }
			                },
			                plotOptions: {
			                    bar: { colorByPoint: true, colors: ['#2ecc71', '#e74c3c'] }
			                }
			            });

			            // Render quarterly performance chart with months in labels
			            const quarterlyChartContainer = document.createElement('div');
			            quarterlyChartContainer.style.height = '400px';
			            quarterlyChartContainer.style.width = '100%';
			            document.getElementById('bordered-justified-contact').appendChild(quarterlyChartContainer);

			            Highcharts.chart(quarterlyChartContainer, {
			                chart: { type: 'column' },
			                title: { text: 'Quarterly Project Performance' },
			                xAxis: { categories: quarterlyLabels },
			                yAxis: {
			                    title: { text: 'Performance (%)' },
			                    max: 100
			                },
			                series: [{
			                    name: 'Quarterly Performance',
			                    data: quarterlyLabels.map(label => quarterlyData[label]),
			                    color: '#8e44ad'
			                }],
			                tooltip: {
			                    formatter: function() {
			                        return `<b>${this.x}</b><br>Quarterly Performance: ${this.y}%`;
			                    }
			                }
			            });
			        })
			        .catch(error => console.error('Error fetching performance data:', error));
			}

			function getQuarterMonths(quarter) {
			    switch (quarter) {
			        case "Q1": return "Apr - Jun";
			        case "Q2": return "Jul - Sep";
			        case "Q3": return "Oct - Dec";
			        case "Q4": return "Jan - Mar";
			        default: return "";
			    }
			}*/
			
			function loadPerformanceChart() {
				console.log("Loading performance as asas  chart...");
			    const performanceChartContainer = document.getElementById('performanceChartContainer');
			    
			    // Check if the chart already exists in the container, if so, do not reload it
			    if (performanceChartContainer.querySelector('.highcharts-container')) {
			        console.log("Chart already exists, skipping reloading.");
			        return; // Skip chart reloading if it already exists
			    }
			    
			    var email=document.getElementById('employeeEmail1').value;

			    fetch(`/getEmployeePerformance?email=${encodeURIComponent(email)}`)
			        .then(response => response.json())
			        .then(data => {
			            const categories = [];
			            const performanceData = [];
			            const quarterlyData = {
			                "Q1 (Apr - Jun)": 0,
			                "Q2 (Jul - Sep)": 0,
			                "Q3 (Oct - Dec)": 0,
			                "Q4 (Jan - Mar)": 0
			            };
			            const quarterlyLabels = ["Q1 (Apr - Jun)", "Q2 (Jul - Sep)", "Q3 (Oct - Dec)", "Q4 (Jan - Mar)"];

			            data.forEach(item => {
			                const roundedPerformance = Math.round(item.performance);

			                if (item.projectName === "Quarterly Performance") {
			                    const quarterLabel = item.subtaskName + ` (${getQuarterMonths(item.subtaskName)})`;
			                    if (quarterlyData.hasOwnProperty(quarterLabel)) {
			                        quarterlyData[quarterLabel] = roundedPerformance;
			                    }
			                } else {
			                    categories.push(item.projectName + ' - ' + item.subtaskName);
			                    performanceData.push(roundedPerformance);
			                }
			            });

						console.log("Categories for sania individual performance:");
						          console.log("Performance  nia sa data:");

			            // Render individual project performance chart
			            Highcharts.chart(performanceChartContainer, {
			                chart: { type: 'bar' },
			                title: { text: 'Project Performance Metrics' },
			                xAxis: {
			                    categories: categories,
			                    title: { text: 'Projects and Tasks' },
			                    labels: { style: { fontSize: '12px' } }
			                },
			                yAxis: {
			                    title: { text: 'Performance (%)' },
			                    plotLines: [{
			                        color: 'red',
			                        value: 0,
			                        width: 2,
			                        label: { text: 'Overdue' }
			                    }]
			                },
			                series: [{
			                    name: 'Performance',
			                    data: performanceData,
			                    color: '#3498db'
			                }],
			                tooltip: {
			                    formatter: function() {
			                        return `<b>${this.x}</b><br>Performance: ${this.y}%`;
			                    }
			                },
			                plotOptions: {
			                    bar: { colorByPoint: true, colors: ['#2ecc71', '#e74c3c'] }
			                }
			            });

			            // Render quarterly performance chart with months in labels
			            const quarterlyChartContainer = document.createElement('div');
			            quarterlyChartContainer.style.height = '400px';
			            quarterlyChartContainer.style.width = '100%';
			            document.getElementById('performance-tab2').appendChild(quarterlyChartContainer);

			            Highcharts.chart(quarterlyChartContainer, {
			                chart: { type: 'column' },
			                title: { text: 'Quarterly Project Performance' },
			                xAxis: { categories: quarterlyLabels },
			                yAxis: {
			                    title: { text: 'Performance (%)' },
			                    max: 100
			                },
			                series: [{
			                    name: 'Quarterly Performance',
			                    data: quarterlyLabels.map(label => quarterlyData[label]),
			                    color: '#8e44ad'
			                }],
			                tooltip: {
			                    formatter: function() {
			                        return `<b>${this.x}</b><br>Quarterly Performance: ${this.y}%`;
			                    }
			                }
			            });
			        })
			        .catch(error => console.error('Error fetching performance data:', error));
			}

			function getQuarterMonths(quarter) {
			    switch (quarter) {
			        case "Q1": return "Apr - Jun";
			        case "Q2": return "Jul - Sep";
			        case "Q3": return "Oct - Dec";
			        case "Q4": return "Jan - Mar";
			        default: return "";
			    }
			}
			
			



			/*function getProjectNameForGridCount() {
				  $.ajax({
				        type: 'GET',
				        url: '/getProjectsForGraph',
				        success: function (projectInfoList) {
				            const gridContainer = document.getElementById('projectPerformanceGrid');
				            gridContainer.innerHTML = ''; // Clear any existing items in the grid

				            if (projectInfoList.length > 0) {
								console.log("Projects found:", projectInfoList);
				                projectInfoList.forEach(function (projectInfo, index) {
				                   createProjectListItem(index, projectInfo.id,projectInfo.projectId, projectInfo.projectName);
				                });
				            } else {
				                console.error('No project names found for the given user.');
				                $('#notification_list_message').text('No projects found for your email.');
				                $('#defaultBox').show();
				            }
				        },
				        error: function (xhr, status, error) {
				            console.error('Error fetching project names:', error);
				            $('#notification_list_message').text('Error fetching project names. Please try again later.');
				            $('#defaultBox').show();
				        }
				    });
				
			}*/
			
		/*used	function getProjectNameForGridCount() {
			    $.ajax({
			        type: 'GET',
			        url: '/getProjectsForGraph',
			        success: function (projectInfoList) {
			            const gridContainer = document.getElementById('projectPerformanceGrid');
			            gridContainer.innerHTML = ''; // Clear any existing items in the grid

			            if (projectInfoList.length > 0) {
			                console.log("Projects found:", projectInfoList);
			                
			                // Create a Set to track unique project IDs
			                const uniqueProjectIds = new Set();

			                projectInfoList.forEach(function (projectInfo, index) {
			                    // Only create a list item if the projectId is unique
			                    if (!uniqueProjectIds.has(projectInfo.projectId)) {
			                        uniqueProjectIds.add(projectInfo.projectId);
			                        createProjectListItem(index, projectInfo.id, projectInfo.projectId, projectInfo.projectName);
			                    }
			                });
			            } else {
			                console.error('No project names found for the given user.');
			                $('#notification_list_message').text('No projects found for your email.');
			                $('#defaultBox').show();
			            }
			        },
			        error: function (xhr, status, error) {
			            console.error('Error fetching project names:', error);
			            $('#notification_list_message').text('Error fetching project names. Please try again later.');
			            $('#defaultBox').show();
			        }
			    });
			}*/
			
			// Updated function with parameter for different tabs
			/*usedfunction getProjectNameForGridCount(tabId) {
			    $.ajax({
			        type: 'GET',
			        url: '/getProjectsForGraph',
			        success: function (projectInfoList) {
			            const gridContainer = document.getElementById('projectPerformanceGrid');
			            gridContainer.innerHTML = ''; // Clear any existing items in the grid

			            if (projectInfoList.length > 0) {
			                console.log("Projects found:", projectInfoList);

			                // Create a Set to track unique project IDs
			                const uniqueProjectIds = new Set();

			                projectInfoList.forEach(function (projectInfo, index) {
			                    // Only create a list item if the projectId is unique
			                    if (!uniqueProjectIds.has(projectInfo.projectId)) {
			                        uniqueProjectIds.add(projectInfo.projectId);
			                        createProjectListItem(index, projectInfo.id, projectInfo.projectId, projectInfo.projectName);
			                    }
			                });
			            } else {
			                console.error('No project names found for the given user.');

			                // Show a message when there are no projects
			                $('#notification_list_message').text('No projects available for your email.');
			                $('#defaultBox').show();

			                // Display "No data available" message in the grid container
			                const noDataMessage = document.createElement('div');
			                noDataMessage.classList.add('no-data-message');
			                noDataMessage.innerHTML = 'No projects available at this time.';

			                // Handle displaying the message based on which tab is active
			                if (tabId === 'performance-sub-tab1') {
			                    // You can customize this for different tabs if needed
			                    noDataMessage.innerHTML = 'No projects available for Projectwise performance.';
			                } else if (tabId === 'contact-tab') {
			                    noDataMessage.innerHTML = 'No projects available in the Contact tab.';
			                }

			                gridContainer.appendChild(noDataMessage);
			            }
			        },
			        error: function (xhr, status, error) {
			            console.error('Error fetching project names:', error);
			            $('#notification_list_message').text('Error fetching project names. Please try again later.');
			            $('#defaultBox').show();
			        }
			    });
			}*/
			
			function getProjectNameForGridCount(tabId) {
				var email=document.getElementById('employeeEmail1').value;
				
			    $.ajax({
			        type: 'GET',
			        url: '/getProjectsForGraph',
			        data:{email: email},
			        success: function (projectInfoList) {
			            const gridContainer = document.getElementById('projectPerformanceGrid');
			            gridContainer.innerHTML = ''; // Clear any existing items in the grid

			            if (projectInfoList.length > 0) {
			                console.log("Projects found:", projectInfoList);

			                // Create a Set to track unique project IDs
			                const uniqueProjectIds = new Set();
			                let displayIndex = 0; // Keep track of the display index for unique projects

			                projectInfoList.forEach(function (projectInfo) {
			                    // Only create a list item if the projectId is unique
			                    if (!uniqueProjectIds.has(projectInfo.projectId)) {
			                        uniqueProjectIds.add(projectInfo.projectId);
			                        createProjectListItem(displayIndex, projectInfo.id, projectInfo.projectId, projectInfo.projectName);
			                        displayIndex++; // Increment the display index only when a unique project is added
			                    }
			                });
			            } else {
			                console.error('No project names found for the given user.');

			                // Show a message when there are no projects
			                $('#notification_list_message').text('No projects available for your email.');
			                $('#defaultBox').show();

			                // Display "No data available" message in the grid container
			                const noDataMessage = document.createElement('div');
			                noDataMessage.classList.add('no-data-message');
			                noDataMessage.innerHTML = 'No projects available at this time.';

			                // Handle displaying the message based on which tab is active
			                if (tabId === 'performance-sub-tab1') {
			                    noDataMessage.innerHTML = 'No projects available .';
			                } else if (tabId === 'contact-tab') {
			                    noDataMessage.innerHTML = 'No projects available.';
			                }

			                gridContainer.appendChild(noDataMessage);
			            }
			        },
			        error: function (xhr, status, error) {
			            console.error('Error fetching project names:', error);
			            $('#notification_list_message').text('Error fetching project names. Please try again later.');
			            $('#defaultBox').show();
			        }
			    });
			}


			
			
		/*	function createProjectListItem(index, id, projectId, projectName) {
			    const gridContainer = document.getElementById('projectPerformanceGrid');

			    // Create a list item for each project
			    const listItem = document.createElement('div');
			    listItem.classList.add('list-group-item', 'project-list-item'); // Use Bootstrap list group item

			    // Add a card-like structure within each list item
			    const card = document.createElement('div');
			    card.classList.add('card', 'shadow-sm', 'project-card'); // Custom class for additional styling

			    // Add card header for visual separation
			    const cardHeader = document.createElement('div');
			    cardHeader.classList.add('card-header', 'bg-primary', 'text-white');
			    cardHeader.innerHTML = `Project ${index + 1}`;

			    // Card body with project details
			    const cardBody = document.createElement('div');
			    cardBody.classList.add('card-body');
			    cardBody.innerHTML = `
			        <h5 class="card-title">${projectName}</h5>
			        <p class="card-text text-muted">ID: ${projectId}</p>
			    `;

			    // Add onclick event for the entire card
			    card.onclick = function () {
			        console.log("Opening chart modal for project:", projectName, "with ID:", projectId);

			        $('#projectChartModal .modal-body').html(`<div id="teamPrjDetails1-${projectId}" style="height: 400px;"></div>
			                                                <div id="performanceModal" style="height: 400px; width: 100%; margin-top: 40px;"></div>`);

			        $('#projectChartModal').off('shown.bs.modal').on('shown.bs.modal', function () {
			            console.log('Modal shown. Loading project chart for:', projectName, "with Project ID:", projectId);

			            setTimeout(function () {
			                loadProjectChart(id, projectId, projectName);
			                loadPerformanceChartModal(projectId, projectName);
			            }, 100);
			        });

			        $('#projectChartModal').modal('show');
			    };

			    // Append header, body, and footer to the card
			    card.appendChild(cardHeader);
			    card.appendChild(cardBody);
			    listItem.appendChild(card);
			    gridContainer.appendChild(listItem);
			}*/

			function createProjectListItem(index, id, projectId, projectName) {
			    const gridContainer = document.getElementById('projectPerformanceGrid');

			    // Create a list item for each project
			    const listItem = document.createElement('div');
			    listItem.classList.add('list-group-item', 'project-list-item'); // Use Bootstrap list group item

			    // Add content to each list item (project name and ID)
			    listItem.innerHTML = `
			        <div class="project-item-content">
			            <h5 class="project-title">Project ${index + 1}: ${projectName}</h5>
			            <p class="project-id">Project ID: ${projectId}</p>
			        </div>
			    `;

			    // Add onclick event for the entire list item
			    listItem.onclick = function () {
			        console.log("Opening chart modal for project:", projectName, "with ID:", projectId);

			        $('#projectChartModal .modal-body').html(`<div id="teamPrjDetails1-${projectId}" style="height: 400px;"></div> <div id="performanceIntro"></div>
			                                                <div id="performanceModal" style="height: 400px; width: 100%; margin-top: 40px;"></div>`);

			        $('#projectChartModal').off('shown.bs.modal').on('shown.bs.modal', function () {
			            console.log('Modal shown. Loading project chart for:', projectName, "with Project ID:", projectId);

			            setTimeout(function () {
			                loadProjectChart(id, projectId, projectName);
			                loadPerformanceChartModal(projectId, projectName);
			            }, 100);
			        });

			        $('#projectChartModal').modal('show');
			    };

			    // Append the list item to the grid container
			    gridContainer.appendChild(listItem);
			}

			
		
				
				function loadPerformanceChartModal(projectId, projectName) {
				    const performanceChartContainerModal = document.getElementById('performanceModal');
				    if (!performanceChartContainerModal) {
				        console.error('Chart container not found!');
				        return;
				    }
					
					

				    var email=document.getElementById('employeeEmail1').value;
				    fetch(`/getEmployeePerformanceForProject?projectId=${projectId}&projectName=${projectName}&email=${email}`)
				        .then(response => response.json())
				        .then(data => {
				            // Initialize totalCompletion and taskCount for overall completion calculation
				            let totalCompletion = 0;
				            let taskCount = 0;

				            const chartData = data.map(item => {
				                const completion = Math.round(item.completionPercentage);
				                const remaining = 100 - completion;

				                // Only consider tasks for overall completion calculation (completed tasks)
				                if (completion > 0) {
				                    totalCompletion += completion;
				                    taskCount++;
				                }

				                // Log each task's completion and remaining values for debugging
				                console.log(`Task: ${item.taskName}, Subtask: ${item.subtaskName}, Completion: ${completion}, Remaining: ${remaining}`);

				                // Use subtask name or fallback to 'Overall' for tasks
				                const isOverall = !item.subtaskName; // Check if it's an overall task
				                const overallColor = 'rgb(255, 205, 86)'; // Yellow color for Overall

				                // Return data in the format ECharts expects
				                return completion > 0
				                    ? {
				                        name: `${item.subtaskName || 'Overall'} (Completed)`,
				                        value: completion,
				                        itemStyle: {
				                            color: isOverall ? overallColor : 'rgb(54, 162, 235)', // Blue for subtasks
				                            borderWidth: 5, // Adds space by creating a border
				                            borderColor: '#fff', // White border for space between segments
				                        }
				                    }
				                    : {
				                        name: `${item.subtaskName || 'Overall'} (Pending)`,
				                        value: remaining,
				                        itemStyle: {
				                            color: isOverall ? overallColor : 'rgb(255, 99, 132)', // Red for remaining
				                            borderWidth: 5, // Adds space by creating a border
				                            borderColor: '#fff', // White border for space between segments
				                        }
				                    };
				            });

				            // Calculate overall completion percentage for "Overall Performance"
				            let overallCompletionPercentage = taskCount > 0 ? totalCompletion / taskCount : 0;

				            // Round the overall completion percentage to the next whole number if >= 0.5
				            overallCompletionPercentage = overallCompletionPercentage >= 0.5 ? Math.ceil(overallCompletionPercentage) : Math.floor(overallCompletionPercentage);

				            console.log('Total Completion:', totalCompletion);
				            console.log('Task Count:', taskCount);
				            console.log('Calculated Overall Completion Percentage:', overallCompletionPercentage);

				            // Check if the "Overall Performance" entry exists in the chartData, and update it if necessary
				            const overallIndex = chartData.findIndex(item => item.name.includes('Overall'));
				            if (overallIndex !== -1) {
				                chartData[overallIndex].value = overallCompletionPercentage;
				                chartData[overallIndex].name = 'Overall Performance';
				            } else {
				                // If "Overall Performance" entry doesn't exist, add it with the calculated value
				                chartData.push({
				                    name: 'Overall Performance',
				                    value: overallCompletionPercentage,
				                    itemStyle: {
				                        color: 'rgb(255, 205, 86)', // Yellow color for Overall
				                        borderWidth: 5,
				                        borderColor: '#fff',
				                    }
				                });
				            }

				            // Log chart data before passing it to ECharts
				            console.log('Chart Data:', chartData);

				            // Initialize ECharts instance
				            const echartInstance = echarts.init(performanceChartContainerModal);

				            // Set the options for the pie chart using ECharts
				            echartInstance.setOption({
				                tooltip: {
				                    trigger: 'item',
				                    formatter: function (params) {
				                        // Customize tooltip for overall performance
				                        if (params.name === 'Overall Performance') {
				                            return `${params.name}: ${params.value}%`;
				                        }
				                        // Only show percentage for "Completed" tasks
				                        if (params.name.includes("(Completed)")) {
				                            return `${params.name}: ${params.value}%`;
				                        }
				                        return `${params.name}`; // No percentage for "Pending" tasks
				                    },
				                },
				                legend: {
				                    orient: 'vertical',
				                    right: 'right',
				                    top: 'center',
				                },
				                series: [{
				                    name: 'Completion',
				                    type: 'pie',
				                    radius: ['50%', '70%'], // Inner and outer radius for the pie chart
				                    avoidLabelOverlap: false,
				                    center: ['40%', '50%'], // Centering pie chart
				                    label: {
				                        show: false,
				                        position: 'center',
				                    },
				                    emphasis: {
				                        label: {
				                            show: true,
				                            fontSize: '14',
				                            fontWeight: 'bold',
				                        },
				                    },
				                    labelLine: {
				                        show: false,
				                    },
				                    data: chartData, // Data for the pie chart
				                }],
				            });
				        })
				        .catch(error => console.error('Error fetching data:', error));
				}
			
			function loadProjectChart(id,projectId, projectName) {
			    console.log("Fetching project chart data for Project ID:", projectId, "Project Name:", projectName);
				console.log('loadProjectChart called with Project ID:', projectId, 'and Project Name:', projectName);
				   console.log('Looking for container with ID:', 'teamPrjDetails1-' + projectId);

				   const chartContainerId = 'teamPrjDetails1-' + projectId;
				      const chartContainer = document.getElementById(chartContainerId);
				      console.log('Chart container element:', chartContainer);

				      if (!chartContainer) {
				          console.error('Chart container not found for project ID:', projectId);
				          return;
				      }
				      
				      var email=document.getElementById('employeeEmail1').value;
			    // Make the fetch request using projectId and projectName
			    fetch('/getEmployeProjectStatus1?projectId=' + projectId + '&projectName=' + encodeURIComponent(projectName)+ '&email=' + encodeURIComponent(email))
			        .then(response => response.json())
			        .then(data => {
			            console.log(JSON.stringify(data));

			            // Process data for each task separately
			            const categories = [];
			            const totalTasks = [];
			            const completedTasks = [];
			            const pendingTasks = [];
						const overdueTasks = [];

			            // Loop through each task entry and assign data to the respective arrays
			            data.forEach(item => {
			                console.log('Processing item:', item); 
			                const employeeName = item[0];  // Assuming this is the employee's name
			                const taskName = item[2];      // Assuming this is the task name
			                const totalTaskCount = parseInt(item[3], 10);  // Total number of tasks
			                const completedTaskCount = parseInt(item[4], 10);  // Completed task count
							const overdueTaskCount = parseInt(item[5], 10);  // Overdue task count

			                // Calculate pending tasks based on total tasks and completed tasks
			                const pendingTaskCount = totalTaskCount - completedTaskCount;
						   //const pendingTaskCount = totalTaskCount - completedTaskCount - overdueTaskCount;

			                // Add a category with a line break between the employee name and task name
			               // categories.push(`${employeeName}<br>(${taskName})`);
							// Add a category with a line break between the employee name and task name
							categories.push(`<span style="font-weight: bold; display: block; text-align: center;">${employeeName}</span><br><span style="font-weight: normal; text-align: center;">(${taskName})</span>`);

			                // Push the task data for the corresponding series
			                totalTasks.push(totalTaskCount);
			                completedTasks.push(completedTaskCount);
			                pendingTasks.push(pendingTaskCount); // Ensure pending tasks are populated
							overdueTasks.push(overdueTaskCount); 
			            });

			            console.log('Categories:', categories);
			            console.log('Total Tasks:', totalTasks);
			            console.log('Completed Tasks:', completedTasks);
			            console.log('Pending Tasks:', pendingTasks);

			            // Ensure the modal is shown before rendering the chart
						//$('#projectChartModal').on('shown.bs.modal', function () {
						            // Set the dynamic ID for the chart container
						           // document.getElementById("teamPrjDetails1").id = "teamPrjDetails1-" + projectId;

			                // Initialize Highcharts with separate columns for each task
							//console.log('Chart container ID:', 'teamPrjDetails1-' + projectId);

			              Highcharts.chart(chartContainerId, { // Use projectId for dynamic chart rendering
								
			                    chart: {
			                        type: 'column',
									options3d: {
									           enabled: true,
									           alpha: 15,
									           beta: 15,
									           depth: 25
									       }
			                    },
			                    title: {
			                        text: 'Employee Task Status'
			                    },
			                    xAxis: {
			                        categories: categories, // Use the combined employee-task categories with line breaks
			                        title: {
			                            text: 'Employee and Tasks'
			                        },
			                        labels: {
			                            useHTML: true, // Enable HTML rendering for labels
			                            rotation: 0,   // No rotation needed with line breaks
			                            style: {
			                                fontSize: '12px'
			                            }
			                        }
			                    },
			                    yAxis: {
			                        min: 0,
			                        title: {
			                            text: 'Number of Tasks'
			                        }
			                    },
			                    tooltip: {
			                        shared: true,
			                        formatter: function() {
			                            const taskIndex = this.point.index; // Get index of the task
			                            const category = categories[taskIndex]; // Get the corresponding category

			                            return `<b>${category}</b><br/>` +
			                                `Total Subtasks: ${totalTasks[taskIndex]}<br/>` +
			                                `Completed Subtasks: ${completedTasks[taskIndex]}<br/>` +
			                                `Pending Tasks: ${pendingTasks[taskIndex]}<br/>` +
											 `Overdue Tasks: ${overdueTasks[taskIndex]}`; // Display pending tasks correctly
											 
			                        }
			                    },
			                    series: [{
			                        name: 'Total Assigned',
			                        data: totalTasks,
			                        color: '#3498db'
			                    }, {
			                        name: 'Completed Tasks',
			                        data: completedTasks,
			                        color: '#2ecc71'
			                    }, {
			                        name: 'Pending Tasks',
			                        data: pendingTasks,
			                        color: '#e74c3c'
			                    }, {
								        name: 'Overdue Tasks',
								        data: overdueTasks,
								        color: '#f39c12'  // Set color for overdue tasks
								    }],
			                    plotOptions: {
			                        column: {										
										grouping: true, // Grouping the columns for each category
										            shadow: false,
										            borderWidth: 0, // No border width, making the lines thinner
										            pointPadding: 0.05, // Decrease padding for smaller columns
										            borderRadius: 5,
													pointWidth: 40
			                        }
			                    }
			                });
			        })
			        .catch(error => console.error('Error fetching data:', error));
			}
		</script>
	
	

	<script>
		document.getElementById('requestLeaveBtn').addEventListener('click', function () {
			var myModal = new bootstrap.Modal(document.getElementById('requestLeaveModal'));

			// Get employee gender from hidden field
			var gender = document.getElementById('employeeGender').value;

			var leaveTypeSelect = document.getElementById('leaveType');

			// Clear existing options
			leaveTypeSelect.innerHTML = '';

			// Always add common leave types
			leaveTypeSelect.add(new Option('Select Leave Type', ''));
			leaveTypeSelect.add(new Option('Earned Leave (EL)', 'EL'));
			leaveTypeSelect.add(new Option('Sick Leave (SL)', 'SL'));
			leaveTypeSelect.add(new Option('Casual Leave (CL)', 'CL'));
			leaveTypeSelect.add(new Option('Loss of Pay (LOP)', 'LOP'));

			// Add Maternity Leave only if the employee is female
			if (gender === 'Female') {
				leaveTypeSelect.add(new Option('Maternity Leave (ML)', 'ML'));
			}
			myModal.show();
		});
	</script>
	
	<script>
		/* SUBMITTING THE LEAVE FORM  */
	    document.getElementById('leaveForm').addEventListener('submit', function(event) {
	          event.preventDefault();
	        
			  const fromDate = new Date(document.getElementById('fromDate').value);
			  const toDate = new Date(document.getElementById('toDate').value);    
			
			  /*THIS IS CHECKING IF THE SAME DATE IS SUBMITTING TWICE*/
			  // Validate the date range
			  if (!isDateRangeValid(fromDate, toDate)) {
			      document.getElementById('dateOverlap').style.display = 'block'; // Show error message
			      return; // Stop form submission
			  } else {
			      document.getElementById('dateOverlap').style.display = 'none'; // Hide error message
			  }
			  
	        // Collect form data
	        const formData = new FormData(this);
	        const data = {};
	        formData.forEach((value, key) => {
	            if (key === 'approvingAuthority') {
	                // Convert selected options to a comma-separated string
	                const selectedOptions = Array.from(document.getElementById('approvingAuthority').selectedOptions)
	                                             .map(option => option.value)
	                                             .filter(value => value.trim() !== '') // Filter out any empty values
	                                             .join(',');
	                data[key] = selectedOptions;
					} else if (key === 'leaveDuration') {
					         // Add leave duration to the data object
					         data[key] = value;
	            } else {
	                data[key] = value;
	            }
	        });
	    });
	</script>
	
	<!-- script to notification -->
<!-- script to notification -->
<!-- <script>
//Function to fetch flag value from the backend
function fetchFlag() {
    $.get("/flag", function(response) {
        var leaveRequestCountValue = response; 
        // console.log(leaveRequestCountValue);
        // If total notification count is greater than 0, show the bell icon and notifications
        if (leaveRequestCountValue.leaveRequestFlagCount > 0) {
            $("#notificationBellIcon").show();  // Show bell icon
            $("#leaveRequestNotification").show();  // Show specific notification
            
            $("#leaveRequestMessage").text(leaveRequestCountValue.leaveRequestFlagCount + " leave request(s)");
            $(".badge-number").text(leaveRequestCountValue.leaveRequestFlagCount);
            $("#leaveRequestFlagCount").text(leaveRequestCountValue.leaveRequestFlagCount);
        }  
        
        //display the asset notifu=ication based on asset count value
        if(leaveRequestCountValue.asseteRequestFlagCount>0){
        	 
        	 $("#notificationBellIcon").show();  // Show bell icon
             $("#assetRequestNotification").show();  // Show specific notification
             
             $("#assetRequestMessage").text(leaveRequestCountValue.asseteRequestFlagCount + " asset request(s)");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);
             $("#asseteRequestFlagCount").text(leaveRequestCountValue.asseteRequestFlagCount);
        	 	
        }      
        	
        //display the new project notification based on asset count value
        if(leaveRequestCountValue.newPrjectValueCount>0){
        	
        	 $("#notificationBellIcon").show();     // Show bell icon
             $("#newProjectNotification").show();  // Show specific notification
             
             $("#newProjectMessage").text(leaveRequestCountValue.newPrjectValueCount + " project request(s)");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);
             $("#newPrjectValueCount").text(leaveRequestCountValue.asseteRequestFlagCount); 
             
        }
        
        //display the appraisal from HR notification
        if(leaveRequestCountValue.appraisalCount>0){
        	 $("#notificationBellIcon").show();  // Show bell icon
             $("#hrAppraisal").show();  // Show specific notification
             
             $("#apprisalHrNotification").text(" Appraisal Form");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);
             $("#appraisalCount").text(leaveRequestCountValue.asseteRequestFlagCount);
        }
        
        //display the appraisal from employee notification 
        if(leaveRequestCountValue.empAppraisalflag>0){
        	 $("#notificationBellIcon").show();  // Show bell icon
             $("#empAppraisal").show();  // Show specific notification
             
             $("#apprisalempNotification").text(leaveRequestCountValue.empAppraisalflag + " employees sent appraisal");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);
             $("#empAppraisalflag").text(leaveRequestCountValue.asseteRequestFlagCount);
        }
        
        //display the appraisal Due date notification 
        if(leaveRequestCountValue.adminAppraisalDuedate>0){
        	 $("#dueAppraisal").show();  // Show bell icon
             $("#empAppraisal").show();  // Show specific notification
             
             $("#apprisalDueNotification").text("Tomorrow is the due date for submit appraisal");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);
             $("#adminAppraisalDuedate").text(leaveRequestCountValue.asseteRequestFlagCount);
        }
        
        //display the asset notifu=ication based on asset count value
        if(leaveRequestCountValue.announcementNotification>0){
        	 $("#notificationBellIcon").show();  // Show bell icon
             $("#newAnnouncementNotification").show();  // Show specific notification
             
             $("#newannouncement").text(leaveRequestCountValue.announcementNotification + " announcement(s)");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);             
        }  
        
        //display the leave request status change notification
        if(leaveRequestCountValue.leaveRequestStatusChangeValue > 0){
        	 	
        	 $("#notificationBellIcon").show();  // Show bell icon
             $("#leaveRequestSatusChangeNotification").show();  // Show specific notification
             	
             $("#leaveRequestSatusChangeMessage").text("Your leave request status has been");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);             
        	 	
        } 
        
        //display the new feature notification
        if(leaveRequestCountValue.newFeatureNotification > 0){
        	 
        	 $("#notificationBellIcon").show();  // Show bell icon
             $("#new-feature").show();  // Show specific notification
             
             $("#new-featuretext").text("Latest Update, There is " + leaveRequestCountValue.newFeatureNotification + " new feature(s) update is now available.");
             $(".badge-number").text(leaveRequestCountValue.totalNotificationCount);             
        	 
        } 
    });
}

//Function to fetch flag value from the backend
function fetchsuperAdminFlag() {
    $.get("/flag", function(response) {
    	console.log("Super admin");
        var requestCount = response;
         
        // If total notification count is greater than 0, show the bell icon and notifications
        if (requestCount.totalNotificationCount > 0) {
            $("#notificationBellIcon").show();  // Show bell icon
            $("#leaveRequestNotification").show();  // Show specific notification
            
            $("#leaveRequestMessage").text(requestCount.leaveRequestFlagCount + " leave request(s)");
            $(".badge-number").text(requestCount.totalNotificationCount);
            $("#leaveRequestFlagCount").text(requestCount.leaveRequestFlagCount);
        } else {
            // If total notification count is 0, hide the bell icon and notification
            $("#notificationBellIcon").hide();
        }
        //display the asset notifu=ication based on asset count value
        if(requestCount.asseteRequestFlagCount>0){
        	 $("#notificationBellIcon").show();  // Show bell icon
             $("#assetRequestNotification").show();  // Show specific notification
             
             $("#assetRequestMessage").text(requestCount.asseteRequestFlagCount + " asset request(s)");
             $(".badge-number").text(requestCount.totalNotificationCount);
             $("#asseteRequestFlagCount").text(requestCount.asseteRequestFlagCount);
        		
        }
        else {
            // If total notification count is 0, hide the bell icon and notification
            $("#assetRequestNotification").hide();
        }
    });
}

// Periodically fetch flag value every second (adjust as needed)
const employeeId = document.getElementById('employee-id').value; // This is a string
console.log(employeeId);

if(employeeId === "0") {
	//alert("hii");
	setInterval(fetchsuperAdminFlag, 1000);
}
else{
	setInterval(fetchFlag, 1000);
}


</script>
 -->

	<script th:inline="javascript">
	    /*<![CDATA[*/
	    var holidays = /*[[${holidays}]]*/ [];
	    console.log("lllkk"+holidays);  // To see the array in the console
	    /*]]>*/
	</script>

								
	<script>
	    // Convert holiday dates to a simple list of strings (e.g., 'YYYY-MM-DD')
		// Convert holiday dates to a simple list of strings (e.g., 'YYYY-MM-DD')
		   const holidayDates = holidays.map(holiday => {
		       // Assuming each holiday has a 'date' field in 'YYYY-MM-DD' format
		       return holiday.date ? new Date(holiday.date).toISOString().split('T')[0] : null;
		   }).filter(date => date !== null); // Filter out any invalid dates

		   console.log("Holiday Datesvvv:", holidayDates);  // To check if the dates are correct

	    // Shared error message div
	    const dateError = document.getElementById("dateErrorfromto");

	    // Function to check if a date is a Sunday
	    function isSunday(dateString) {
	        const date = new Date(dateString);
	        return date.getDay() === 0; // Sunday is day 0 in JavaScript
	    }

	    // Function to check if a date is a holiday
	    function isHoliday(dateString) {
	        return holidayDates.includes(dateString);
	    }

	    // Handle "From Date" and "To Date" fields
	    const fromDateField = document.getElementById("fromDate");
	    const toDateField = document.getElementById("toDate");

	    // Validate the selected date field for both Sundays and holidays
	    function validateDateField(field) {
	        if (isSunday(field.value) || isHoliday(field.value)) {
	            dateError.style.display = "block"; // Show error
	            field.value = ""; // Clear the invalid date
	        } else {
	            dateError.style.display = "none"; // Hide error
	        }
	    }

	    // Add event listeners to both date fields
	    fromDateField.addEventListener("input", function () {
	        validateDateField(this);
	    });

	    toDateField.addEventListener("input", function () {
	        validateDateField(this);
	    });

	    // Clear error message when modal is closed
	    const modal = document.getElementById("requestLeaveModal");
	    modal.addEventListener("hidden.bs.modal", function () {
	        // Reset error message and field values
	        dateError.style.display = "none";
	        fromDateField.value = "";
	        toDateField.value = "";
	    });
	</script>

	<script>
	  // Reset Half Day and Full Day options when the modal is opened
	  document.getElementById("requestLeaveModal").addEventListener("show.bs.modal", function () {
	    const halfDayOption = document.getElementById("halfDay");
	    const fullDayOption = document.getElementById("fullDay");

	    // Enable Half Day and set Full Day as default
	    halfDayOption.disabled = false;
	    fullDayOption.checked = true;
	  });

	  // Function to check the date range and disable/enable Half Day
	  document.getElementById("fromDate").addEventListener("change", checkDateRange);
	  document.getElementById("toDate").addEventListener("change", checkDateRange);

	  function checkDateRange() {
	    const fromDate = new Date(document.getElementById("fromDate").value);
	    const toDate = new Date(document.getElementById("toDate").value);

	    // Calculate the difference in days
	    const timeDifference = toDate - fromDate;
	    const dayDifference = timeDifference / (1000 * 3600 * 24);

	    // Get the Half Day and Full Day radio buttons
	    const halfDayOption = document.getElementById("halfDay");
	    const fullDayOption = document.getElementById("fullDay");

	    // Disable Half Day if the date range is more than 1 day
	    if (dayDifference > 0) {
	      halfDayOption.disabled = true;
	      // Automatically shift to Full Day if Half Day was selected
	      if (halfDayOption.checked) {
	        fullDayOption.checked = true;
	      }
	    } else {
	      halfDayOption.disabled = false;
	    }
	  }
	</script>


<!-- script to notification link redirect -->
<!-- <script th:inline="javascript">
    function redirectToLeaveRequest() {
        var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
        window.location.href = '/viewAdminLeaves?empid=' + empid;
    }
    function redirectToAsset() {
        //var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
        window.location.href = '/asset';
    }
    function redirectToProject() {
        //var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
        window.location.href = '/ongoingProject';
    }    
    function redirectToAppraisal() {
    	var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
    	window.location.href = '/apprisal?empid=' + empid;
    }    
    function redirectToemployeeAppraisal() {
    	var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
    	window.location.href = '/employeeApprisal?empid=' + empid;
    }    
    function redirectToAnnouncement() {
    	var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
    	window.location.href = '/events';
    }
    function redirectToAttendence() {
    	var email = /*[[${empDetailsByEmpId.email}]]*/ 'defaultEmpId';
    	window.location.href = '/attendanceLive?email=' +email;
    }
</script>



 script to notification link redirect
<script th:inline="javascript">
    function redirectToLeaveRequest() {
        var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
        window.location.href = '/viewAdminLeaves?empid=' + empid;
    }
    function redirectToAsset() {
        //var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
        window.location.href = '/asset';
    }
    function redirectToProject() {
        //var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
        window.location.href = '/ongoingProject';
    }
    function redirectToAppraisal() {
    	var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
    	window.location.href = '/apprisal?empid=' + empid;
    }
    function redirectToemployeeAppraisal() {
		var empid = /*[[${empDetailsByEmpId.empid}]]*/ 'defaultEmpId';
		window.location.href = '/employeeApprisal?empid=' + empid;
	}
</script> -->
<!-- script for spinner -->
<script>

document.addEventListener('DOMContentLoaded', function () {
    const loadingPopup = document.getElementById('loadingPopup');
    const mainContent = document.getElementById('main');

    // Timer to display the loading popup
    const delayTimeout = setTimeout(() => {
        loadingPopup.style.display = 'flex'; // Show the popup
    }, 1000); // Delay of 1 second (adjust as needed)

    // Event listener for page load
    window.addEventListener('load', function () {
        clearTimeout(delayTimeout); // Cancel the timer if the page loads quickly
        loadingPopup.style.display = 'none'; // Ensure the popup is hidden
        mainContent.style.display = 'block'; // Show the main content
    });
});

</script>

<!-- script for profile pic -->
<script>
$.ajax({
    type: "GET",
    url: "fetchEmployeeDocumentDetailsOnlyByEmpId",
    data: {
        "emp_id": $('#emp_idSessionValue').val()
    },
    success: function(data) {
    	console.log("++++data"+JSON.stringify(data));
        $('#dynamicProfilePic').attr('src', `${data.profilePicPath}`);
    },
    error: function(xhr, status, error) {
        console.error("Error invoking data:", error);
    }
});
</script>


<!-- script to close the modal leave request modal and reset the overflow-->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modalElement = document.getElementById('requestLeaveModal');

    modalElement.addEventListener('hidden.bs.modal', () => {
        // Reset the body's overflow style
        document.body.style.overflow = 'auto';
    });
    
});
</script>

<!-- script to download attendence -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
<script>
//Open the modal for selecting the date range
function openDateRangeModal(empId) {
    const modal = new bootstrap.Modal(document.getElementById('dateRangeModal'));
    modal.show();
}

// Get the date range and call downloadAttendence()
function submitDateRange(empId) {
    const fromDate = document.getElementById('fromDate1').value;
    const toDate = document.getElementById('toDate1').value;

    // Validate the date range
    if (!fromDate || !toDate || new Date(fromDate) > new Date(toDate)) {
        alert("Please select a valid date range.");
        return;
    }

    // Close the modal
    const modalElement = document.getElementById('dateRangeModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    modal.hide();

    // Call the downloadAttendence function with the selected dates
    downloadAttendence(empId, fromDate, toDate);
}


function downloadAttendence(empId, fromDate, toDate) {
    console.log("Downloading attendance for Employee ID:", empId);

    const year = new Date().getFullYear();

    fetch(`/attendanceExcelData?year=${year}&empId=${empId}&fromDate=${fromDate}&toDate=${toDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error("Error fetching attendance data.");
            }
            return response.json();
        })
        .then(attendanceData => {
            console.log(JSON.stringify(attendanceData));

            // Prepare data structure for Excel export
            const data = [];

            // Get the employeeName from the first record in the attendance data
            const employeeName = attendanceData.length > 0 ? attendanceData[0].employeeName : "Employee Name"; 
            //alert(employeeName); // Show the employee name in an alert
            
            data.push([`Employee Name: ${employeeName}`]);
            data.push([]); // Add a blank row for separation

            // Add header row
            const headerRow = ["Month"];
            for (let day = 1; day <= 31; day++) {
                headerRow.push(`${day}`);
            }
            data.push(headerRow);

            // Convert fromDate and toDate to JavaScript Date objects
            const startDate = new Date(fromDate);
            const endDate = new Date(toDate);

            // Loop through months in the selected range
            for (let month = startDate.getMonth(); month <= endDate.getMonth(); month++) {
                const date = new Date(year, month, 1);
                const row = [date.toLocaleString("default", { month: "long" })]; // Month name

                // Add attendance data for days in the month
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= 31; day++) {
                    if (day <= daysInMonth) {
                        const attendanceForDay = attendanceData.find(att => {
                            const attDate = new Date(att.date);
                            return attDate.getDate() === day && attDate.getMonth() === month;
                        });

                        if (attendanceForDay && attendanceForDay.totalHours) {
                            const totalHours = parseFloat(attendanceForDay.totalHours);
                            if (totalHours > 6) {
                                row.push("P"); // Present
                            } else if (totalHours > 2 && totalHours <= 6) {
                                row.push("HD"); // Half Day
                            } else {
                                row.push("A"); // Absent
                            }
                        } else {
                            row.push("A"); // Default to Absent
                        }
                    } else {
                        row.push(""); // Empty for non-existent days
                    }
                }
                data.push(row);
            }

            // Create a worksheet and a workbook
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Attendance");

            // Write and download the Excel file
            const fileName = `Attendance_${empId}_${year}_${fromDate}_${toDate}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        })
        .catch(error => {
            console.error("Error during attendance download:", error);
            alert("There was an error while downloading the attendance data.");
        });
}

</script>
	<script>
	    // Define the currentDate function explicitly
	    function currentDate() {
	        // Get the current month (0-indexed: 0 = January, 11 = December)
	        var currentMonth = new Date().getMonth();
	        console.log('Current Month:', currentMonth); // Check the current month (0 = Jan, 11 = Dec)

	        // Select the div with the id 'month-{currentMonth + 1}' (1-indexed month)
	        var currentMonthElement = document.getElementById('month-' + (currentMonth + 1));
	        console.log('Current Month Element:', currentMonthElement); // Check if the element is selected

	        // If the element is found, scroll it into view
	        if (currentMonthElement) {
	            console.log('Scrolling to the current month element.');
	            currentMonthElement.scrollIntoView({
	                behavior: 'smooth', // smooth scrolling
	                block: 'center' // scroll the element to the center of the viewport
	            });
	        } else {
	            console.log('No element found for the current month.');
	        }
	    }

	    // Ensure the function is called after the page has loaded
	    window.onload = currentDate; // This explicitly calls the function when the page loads
	</script>


<script>
		document.getElementById("yearSelect").addEventListener("change", function() {
		    const selectedYear = this.value;
		    
		    var email=document.getElementById('employeeEmail1').value;

			 // fetch(`/attendance-details?date=${encodeURIComponent(formattedDate)}&email=${encodeURIComponent(email)}`)
	    	 
	     
	         //fetch(`/EmployeeAttendanceLiveSecond?month=${encodeURIComponent(monthName)}&year=${year}&email=${email}`, {
		    
		    // Make an AJAX request to fetch attendance data
		    fetch(`/attendanceData?year=${selectedYear}&email=${email}`)
		        .then(response => response.json())
		        .then(data => {
		            // Update the months section
		            const monthsContainer = document.querySelector(".card-container .row");
		            monthsContainer.innerHTML = ""; // Clear existing cards
		            var email=document.getElementById('employeeEmail1').value;
		            //alert(email);
		            data.months.forEach(month => {
		                const cardHtml = `
		                    <div class="col-md-4">
		                        <div class="card">
		                            <div class="card-body">
		                                <h5 class="card-title">${month}</h5>
		                                <a href="#" class="btn btn-light btn-border-custom-sm btn-view-weekly-data"
		                                   data-month="${month}" 
		                                   data-year="${selectedYear}" 
		                                   data-bs-toggle="modal" data-bs-target="#weeklyModal">Week</a>
										   <a th:href="@{/attendanceLive/{month}(month=${month})}/${email}" class="btn btn-light btn-border-custom-sm btn-view-data-new"
										                                         data-month="${month}" 
										                                         data-year="${selectedYear}">View Data</a>
		                            </div>
		                        </div>
		                    </div>`;
		                monthsContainer.insertAdjacentHTML("beforeend", cardHtml);
		            });

		            // Re-attach event listeners for the "Week" buttons
		            attachWeeklyButtonListeners();
					attachMonthlyButtonListeners();
					
		        })
		        .catch(error => console.error("Error fetching attendance data:", error));
		});
		
		// Function to attach event listeners to "Week" buttons
		function attachWeeklyButtonListeners() {
		const weeklyButtons = document.querySelectorAll('.btn-view-weekly-data');
					let openDetailsRow = null;

					const today = new Date(); // Current date
					const currentYear = today.getFullYear(); // Get the current year
					const currentWeekNumber = getWeekNumber(today); // Get the current week number
					const currentMonth = today.getMonth(); // Current month (0-based, January = 0)

					weeklyButtons.forEach(button => {
						button.addEventListener('click', function () {
							const month = this.getAttribute('data-month');
							const year = this.getAttribute('data-year');
							const modalLabel = document.getElementById('weeklyModalLabel');
							modalLabel.textContent = `Weekly Data for ${month} ${year}`;

							var email=document.getElementById('employeeEmail1').value;

							// Fetch the data for the selected month in the current year
							fetch(`/weeks?month=${encodeURIComponent(month)}&year=${year}&email=${encodeURIComponent(email)}`)
								.then(response => response.json())
								.then(data => {
									const weekTabs = document.getElementById('weekTabs');
									const weekTabContent = document.getElementById('weekTabContent');

									weekTabs.innerHTML = ''; // Clear previous tabs
									weekTabContent.innerHTML = ''; // Clear previous tab content

									const selectedMonthIndex = getMonthIndex(month); // Helper to get month index (0-based)

									data.forEach((weekData, index) => {
										const selectedMonthIndex = getMonthIndex(month); // Helper to get month index (0-based)
										   const isPastMonth = year < currentYear || (year == currentYear && selectedMonthIndex < currentMonth);
										   let isActive;

										// For past months, default to Week 1 as active
										if (isPastMonth && index === 0) {
											isActive = true;
										}
										// For the current year and month, determine active week based on the current date
										    else if (!isPastMonth && isCurrentWeek(weekData.dates)) {
										        isActive = true;
										    }
										    // Fallback to false for all other weeks
										    else {
										        isActive = false;
										    }


										// Filter out dates from the previous month
										const filteredDates = weekData.dates.filter(dateStr => {
											const dateObj = new Date(dateStr);
											return dateObj.getMonth() === selectedMonthIndex; // Only keep dates from the selected month
										});

										if (filteredDates.length === 0) {
											return; // Skip rendering this week if no valid dates remain
										}

										const tabItem = document.createElement('li');
										tabItem.classList.add('nav-item');
										tabItem.innerHTML = `
				                            <a class="nav-link${isActive ? ' active' : ''}" 
				                               id="week${index + 1}-tab" 
				                               data-bs-toggle="tab" 
				                               href="#week${index + 1}" 
				                               role="tab" 
				                               aria-controls="week${index + 1}" 
				                               aria-selected="${isActive}">
				                                ${weekData.weekLabel}
				                            </a>
				                        `;
										weekTabs.appendChild(tabItem);

										const tabPane = document.createElement('div');
										tabPane.classList.add('tab-pane', 'fade');
										if (isActive) {
											tabPane.classList.add('show', 'active');
										}
										tabPane.id = `week${index + 1}`;
										tabPane.role = 'tabpanel';
										tabPane.innerHTML = `
				                            <table class="table details-table">
				                                <thead>
				                                    <tr>
				                                        <th>Day</th>
				                                        <th>Date</th>
				                                        <th>In Time</th>
				                                        <th>Out Time</th>
				                                        <th>Total Hours</th>
				                                    </tr>
				                                </thead>
				                                <tbody>
				                                    ${filteredDates.map(dateStr => {
											const dateObj = new Date(dateStr);
											const dayName = dateObj.toLocaleDateString('default', {weekday: 'long'});
											const formattedDate = getFormattedDate(dateObj);
											return `
				                                            <tr class="date-row" data-date="${formattedDate}">
				                                                <td>${dayName}</td>
				                                                <td>${formattedDate}</td>
				                                                <td id="inTime-${formattedDate}">-</td>
				                                                <td id="outTime-${formattedDate}">-</td>
				                                                <td id="totalHours-${formattedDate}">-</td>
				                                            </tr>
				                                        `;
										}).join('')}
				                                </tbody>
				                            </table>
				                        `;
										weekTabContent.appendChild(tabPane);

										// Fetch and display details for each row
										filteredDates.forEach(dateStr => {
											const formattedDate = getFormattedDate(new Date(dateStr));
											var email=document.getElementById('employeeEmail1').value;
											
											console.log("vvvvvv"+formattedDate);
											
											fetch(`/attendance-details?date=${encodeURIComponent(formattedDate)}&email=${email}`)
												.then(response => response.json())
												.then(details => {
													const inTimeElement = document.getElementById(`inTime-${formattedDate}`);
													const outTimeElement = document.getElementById(`outTime-${formattedDate}`);
													const totalHoursElement = document.getElementById(`totalHours-${formattedDate}`);

													if (inTimeElement) inTimeElement.textContent = details.inTime || '-';
													if (outTimeElement) outTimeElement.textContent = details.outTime || '-';
													if (totalHoursElement) totalHoursElement.textContent = details.totalHours || '-';

													// Highlight today's date row
													if (formattedDate === getFormattedDate(today)) {
														console.log('Highlighting:', formattedDate); // Debug line
														const row = document.querySelector(`tr[data-date="${formattedDate}"]`);
														if (row) {
															row.classList.add('highlight-today');
															console.log('Row found and highlighted:', row);
														} else {
															console.warn(`No row found for date: ${formattedDate}`);
														}
													}
												})
												.catch(error => console.error('Error fetching details:', error));
										});
									});
								})
								.catch(error => console.error('Error fetching data:', error));
						});
					});

					// Helper function to get the week number of a given date
					function getWeekNumber(date) {
						const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
						const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
						return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
					}

					// Helper function to check if the week is the current week
					function isCurrentWeek(dates) {
						const today = new Date();
						const startDate = new Date(dates[0]);
						const endDate = new Date(dates[dates.length - 1]);

						// Normalize start and end dates to compare only the date part (ignoring time)
						startDate.setHours(0, 0, 0, 0);
						endDate.setHours(23, 59, 59, 999); // End of the day for the last date

						// Ensure that today falls within the start and end date range of the week
						return today >= startDate && today <= endDate;
					}

					// Helper function to get 0-based month index from month name (like "September")
					function getMonthIndex(monthName) {
						const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
						return monthNames.indexOf(monthName);
					}

					// Helper function to get the formatted date string in dd-MM-yyyy
					function getFormattedDate(date) {
						return `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`;
					}
					
					
					}
					
					// Function to attach event listeners to "View Data" buttons
					  function attachMonthlyButtonListeners() {
					      const monthlyButtons = document.querySelectorAll('.btn-view-data-new');
					      monthlyButtons.forEach(button => {
					          button.addEventListener('click', function (event) {
					              event.preventDefault();
					              const month = this.getAttribute('data-month');
					              const year = this.getAttribute('data-year');
					              
					              fetchAttendanceDataForModalnew(month,year);
					              fetchAndPopulateMonthlyDatanew(month,year);
					          });
					      });
					  }
					  
					  // Function to fetch and populate individual attendance data
					     function fetchAttendanceDataForModalnew(monthName,year) {
						     const employeeMonthElement = document.getElementById('employeeMonth'); 
					         console.log(`Fetching data for the month: ${monthName}`);
					         
					         employeeMonthElement.textContent = monthName; 
					         
					         var email=document.getElementById('employeeEmail1').value;
					     
					         //fetch(`/EmployeeAttendanceLiveSecond?month=${encodeURIComponent(monthName)}&year=${year}&email=${email}`, {
						         fetch(`/attendanceLiveSecond/${monthName}?year=${year}&email=${email}`, {
						             method: 'GET',
						             headers: {
						                 'Content-Type': 'application/json'
						             }
						         })
					             .then(response => response.json())
					             .then(data => {
					                 const modalAttendanceTableBody = document.querySelector('#modalAttendanceTable tbody');
					                 modalAttendanceTableBody.innerHTML = ''; // Clear existing data

					                 if (data.length > 0) {
					                     const employeeNameElement = document.getElementById('employeeName');
					                     const employeeIdElement = document.getElementById('employeeId');
										
					                     employeeNameElement.textContent = data[0].employeeName;
					                     employeeIdElement.textContent = data[0].eid;

					                     data.forEach(entry => {
					                         const date = new Date(entry.date);
					                         const formattedDate = `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
											 
											 // Check if the day is Sunday (0 in JavaScript)
											                    const isSunday = date.getDay() === 0;
											                    const undertimeValue = isSunday ? '-' : entry.undertime; // Show empty value for undertime on Sundays
																const overtimeValue = isSunday ? entry.totalHours : entry.overtime; // Set overtime as total hours for Sundays

					                         const row = `
					                             <tr>
					                                 <td>${formattedDate}</td>
					                                 <td>${entry.inTime}</td>
					                                 <td>${entry.outTime}</td>
					                                 <td>${overtimeValue}</td>
					                                 <td>${undertimeValue}</td>
					                                 <td>${entry.totalHours}</td>
					                             </tr>`;
					                         modalAttendanceTableBody.insertAdjacentHTML('beforeend', row);
					                     });
					                 } else {
					                     document.querySelector('#modalNoDataRow').style.display = 'block'; // Show "no data" message
					                 }
					             })
					             .catch(error => console.error('Error fetching attendance data:', error));
					     }

					     // Function to fetch and populate monthly attendance data
					     function fetchAndPopulateMonthlyDatanew(monthName,year) {
					    	 
					    	 var email=document.getElementById('employeeEmail1').value;

							 // fetch(`/attendance-details?date=${encodeURIComponent(formattedDate)}&email=${encodeURIComponent(email)}`)
					    	 
					     
					         fetch(`/EmployeeAttendanceLiveSecond?month=${encodeURIComponent(monthName)}&year=${year}&email=${email}`, {
					             method: 'GET',
					             headers: {
					                 'Content-Type': 'application/json'
					             }
					         })
					             .then(response => response.json())
					             .then(data => {
					                 if (data) {
					                     populateMonthlyData(data, monthName,year);
					                     var bootstrapModal = new bootstrap.Modal(document.getElementById('attendanceModal'));
					                     bootstrapModal.show();
					                 } else {
					                     console.error('No data returned from server');
					                 }
					             })
					             .catch(error => console.error('Error:', error));
					     }

						 function populateMonthlyData(data, monthName, year) {
						     const modalMonthlyAttendanceTableBody = document.querySelector('#modalMonthlyAttendanceTable tbody');
						     modalMonthlyAttendanceTableBody.innerHTML = ''; // Clear the table body

						     // Get the current month name dynamically
						     const currentMonth = new Date().toLocaleString('default', { month: 'long' });

						     // Check if the selected month is the current month
						     const isCurrentMonth = monthName === currentMonth;

						     // Adjust visibility of the "Remaining Working Days" and "Expected Hours Till Date" headers
						     const remainingWorkingDaysHeader = document.querySelector('#remainingWorkingDaysHeader'); // Add ID to header
						     const expectedHoursTillDateHeader = document.querySelector('#expectedHoursTillDateHeader'); // Add ID to header

						     if (isCurrentMonth) {
						         remainingWorkingDaysHeader.style.display = 'table-cell'; // Show the header
						         expectedHoursTillDateHeader.style.display = 'table-cell';
						         document.querySelectorAll('#modalMonthlyAttendanceTable th').forEach(th => {
						             th.style.display = 'table-cell';
						         });
						     } else {
						         remainingWorkingDaysHeader.style.display = 'none'; // Hide the header
						         expectedHoursTillDateHeader.style.display = 'none';
						         document.querySelectorAll('#modalMonthlyAttendanceTable th').forEach(th => {
						             if (th.textContent.trim() === 'Remaining Working Days' || th.textContent.trim() === 'Expected Hours Till Date') {
						                 th.style.display = 'none';
						             }
						         });
						     }

						     // Populate table rows dynamically to match header visibility
						     if (data.hoursWorkedByEmployee && Object.keys(data.hoursWorkedByEmployee).length > 0) {
						         for (const key in data.hoursWorkedByEmployee) {
						             const row = `
						                 <tr>
						                     <td>${data.totalWorkingDaysExcludingHolidays}</td>
						                     <td>${data.totalWorkingHoursInMonthDisplay}</td>
						                     ${isCurrentMonth ? `<td>${data.expectedHoursTillDate}</td>` : ''}
						                     <td>${data.hoursWorkedByEmployee[key]}</td>
						                     <td>${data.presentDays[key]}</td>
						                     <td>${data.absentDays[key]}</td>
						                     ${isCurrentMonth ? `<td>${data.remainingWorkingDays}</td>` : ''}
						                     <td>${data.overtime[key] || 0}</td>
						                     <td>${data.undertime[key] || 0}</td>
						                 </tr>`;
						             modalMonthlyAttendanceTableBody.insertAdjacentHTML('beforeend', row);
						         }
						     } else {
						         document.querySelector('#modalNoDataRow').style.display = 'block'; // Show "No Data" message
						     }
						 }

	</script>

<!-- script to notification on bottom of the page-->
<!--CHAT BOOT-->

		<!-- Include SockJS and Stomp.js libraries -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!-- script to notification on bottom of the page-->
<script>
		//CODE FOR CHATBOOT NOTIFICATION 
		var stompClient = null;
		var employeeMap = {}; // To store the mapping of employee names to emails
		let employeePhotoMap = {};
		let emailToNameMap = {}; // New map for email -> name lookup
		var email = null;
		var visibilityState = document.visibilityState; // Track tab visibility
		var heartbeatInterval = null; // Track heartbeat interval

		function connectWebSocket() {
			var socket = new SockJS('/chat-websocket');
			  stompClient = Stomp.over(socket);

			  var email = document.getElementById('loggedInMail').value;
			  console.log(`Connecting WebSocket as: ${email}`);

			  stompClient.connect({ 'email': email }, function (frame) {
			      console.log('Connected to WebSocket:', frame);

			      // Mark user as active
			      stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));

			      // Subscribe to active users list
			      stompClient.subscribe('/topic/activeUsers', function (message) {
			          var activeUsers = JSON.parse(message.body);
			          updateActiveUserUI(activeUsers);
			      });

			      // Start heartbeat initially
			      heartbeatInterval = setInterval(() => {
			          if (stompClient && stompClient.connected) {
			              stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
			              console.log("Heartbeat sent for user: " + email);
			          }
			      }, 20000); // 30 seconds

			      // Detect tab visibility change
			      document.addEventListener("visibilitychange", function () {
			          if (document.hidden) {
			              console.log("User switched to another tab. Marking as inactive.");
			              stompClient.send("/app/userInactive", {}, JSON.stringify({ email }));
			              clearInterval(heartbeatInterval); // Stop heartbeat
			              heartbeatInterval = null;
			          } else {
			              console.log("User returned to the application tab. Marking as active.");
			              stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));
			              if (!heartbeatInterval) {
			                  heartbeatInterval = setInterval(() => {
			                      if (stompClient && stompClient.connected) {
			                          stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
			                          console.log("Heartbeat sent for user: " + email);
			                      }
			                  }, 30000);
			              }
			          }
			      });

			      // Detect tab close or WebSocket disconnect
			      socket.onclose = function () {
			          console.log("WebSocket disconnected. Updating user status.");
			          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
			      };

			      window.addEventListener('beforeunload', function () {
			          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
			      });

			  });
		}

		function updateActiveUserUI(activeUsers) {
		//	alert("1");
		    const employeeItems = document.getElementById('employeeNames').getElementsByTagName('li');

		    Array.from(employeeItems).forEach(item => {
		        const employeeName = item.querySelector('span').textContent;
		        const email = employeeMap[employeeName]; 
		        const statusIndicator = item.querySelector('.status-indicator'); // Get the status dot

		        if (activeUsers.includes(email)) {
		            item.classList.add('active-user');
		            statusIndicator.style.backgroundColor = '#66cc66'; // Green for active users
		        } else {
		            item.classList.remove('active-user');
		            statusIndicator.style.backgroundColor = '#ff6666'; // Red for inactive users
		        }

		        // If this employee is currently selected, update chat header status
				if (selectedEmployee === email) {
				           const chatStatusIndicator = document.getElementById('chatStatusIndicator');
				           if (activeUsers.includes(email)) {
				               chatStatusIndicator.style.backgroundColor = '#66cc66'; // Green (Online)
				           } else {
				               chatStatusIndicator.style.backgroundColor = '#ff6666'; // Red (Offline)
				           }
				       }
		    });
		}


		// Select an employee to chat with
		function selectEmployee(employeeName) {
			selectedEmployee = employeeMap[employeeName]; // Get the email from the map
			console.log(`Employee selected: ${selectedEmployee}`);

			// Highlight the selected employee
			var employeeItems = document.querySelectorAll('#employeeNames li');
			employeeItems.forEach(function (item) {
				item.classList.remove('active');
			});
			
			var selectedItem = Array.from(employeeItems).find(item => item.innerHTML === employeeName);
			if (selectedItem) {
				selectedItem.classList.add('active');
			}

			// Update chat header with employee name and photo
			document.querySelector('.chat-about h6').innerText = employeeName;
			document.querySelector('#employeePhoto').src = employeePhotoMap[selectedEmployee] || 'default-profile.jpg';

			// Hide the message icon and dots when an employee is selected
			document.getElementById('message-icon-container').style.display = 'none';
			// Hide the paragraph when an employee is selected
			document.getElementById('logo-text').style.display = 'none';

			// Load messages for the selected employee
			loadMessages();
		}

		function loadEmployees() {
			console.log("Loading employee names...");

			// Fetch employee names from the endpoint
			fetch('/employees/names')
				.then(response => {
					console.log("Response received:", response);
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then(data => {
					console.log("Employee data fetched:", data); // Log the raw data

					const employeeList = document.getElementById('employeeNames');
					if (!employeeList) {
						console.error("Element with ID 'employeeNames' not found.");
						return;
					}

					employeeList.innerHTML = ''; // Clear the list before adding new items

					// Iterate through employee data
					data.forEach(employee => {
						console.log("Processing employee:", employee);

						// Create a list item for each employee
						const li = document.createElement('li');
						li.classList.add('d-flex', 'align-items-center', 'employee-item');

						// Handle missing or empty profile photo paths
						const profilePic = employeePhotoMap[employee.email] || '/static/default-profile.jpg';
						console.log(`Profile picture for ${employee.name}: ${profilePic}`);

						li.innerHTML = `
			                    <img src="${profilePic}" 
			                         alt="Employee Photo" 
			                         class="employee-photo mr-2" />
			                    <span>${employee.name}</span>
			                `;

						// Map employee name to email
						employeeMap[employee.name] = employee.email;
						console.log("Mapped employee:", employee.name, "->", employee.email);
						// Add new reverse mapping (email -> name)
						emailToNameMap[employee.email] = employee.name;
						// Add click event to list item
						li.onclick = () => {
							console.log(`Selected employee: ${employee.name}`);
							selectEmployee(employee.name);
						};

						// Append the list item to the employee list
						employeeList.appendChild(li);

					});

					console.log("Employee names loaded successfully. Employee map:", employeeMap);
					// Call the unread messages function after loading employee data
					fetchUnreadMessages();

					// Set interval to check for new messages every 10 seconds
						setInterval(fetchUnreadMessages, 10000);
				})
				.catch(error => {
					console.error("Error loading employees:", error);
				});
		}


		function loadMessages() {
			// alert("Loading messages...");
			// Get the logged-in user's email and selected employee's email
			var loggedInEmail = document.getElementById('loggedInMail').value;
			var selectedEmployeeEmail = selectedEmployee; // Email is already stored in selectedEmployee

			console.log(`Loading messages between: ${loggedInEmail} and ${selectedEmployeeEmail}`);

			fetch(`/messages?loggedInEmail=${encodeURIComponent(loggedInEmail)}&selectedEmployeeEmail=${encodeURIComponent(selectedEmployeeEmail)}`)
				.then(response => response.json())
				.then(data => {
					console.log("Chat messages loaded:", data);
					// Clear the chat window before displaying messages
					var chatWindow = document.getElementById('chat-window').querySelector('ul');
					chatWindow.innerHTML = '';

					// Display messages
					data.forEach(function (msg) {
						// showMessage(msg.senderEmail, msg.content, msg.recipientEmail, loggedInEmail);
						showMessage(msg.id, msg.senderEmail, msg.content, msg.recipientEmail, msg.timestamp, loggedInEmail);
					});
				})
				.catch(error => console.error("Error loading chat messages:", error));
		}
		let activeDeleteDropdown = null;
		function showMessage(id, senderEmail, message, recipientEmail, timestamp, loggedInEmail) {
			console.log("Message ID:", id);
			console.log(`LoggedInEmailrrr: ${loggedInEmail}, SenderEmail: ${senderEmail}`);

			const isSender = senderEmail === loggedInEmail;
			const senderName = isSender ? "Me" : Object.keys(employeeMap).find(name => employeeMap[name] === senderEmail) || senderEmail;
			const senderPhoto = employeePhotoMap[senderEmail] || 'default-avatar.png';
			const formattedTime = new Date(timestamp).toLocaleString(); // Format timestamp

			console.log(`Message ID: ${id}, Time: ${formattedTime}, From: ${senderEmail}, To: ${recipientEmail}, Content: "${message}"`);

			var chatWindow = document.getElementById('chat-window').querySelector('ul');
			var li = document.createElement('li');
			li.className = isSender ? 'clearfix right' : 'clearfix left';

			li.innerHTML = `
					    <div class="message-container" data-message-id="${id}" onclick="toggleDeleteOption(this)">
					        <img class="sender-photo" src="${senderPhoto}" alt="Sender Photo" />
					        <div class="message ${isSender ? 'my-message' : 'other-message'}">
					            <strong>${senderName}:</strong> ${message}
					        </div>
					    </div>
					    <div class="timestamp" style="text-align: ${isSender ? 'right' : 'left'};">
					        ${formattedTime}
					    </div>
					    ${isSender ? `
					        <div class="message-action-dropdown" >
					            <a class="dropdown-item" href="#" onclick="deleteMessage(this, ${id})">Delete Message</a>
					        </div>
					    ` : ''}`;

			chatWindow.appendChild(li);
			chatWindow.scrollTop = chatWindow.scrollHeight;
		}
		
		/*function fetchUnreadMessages() {
			console.log("Fetching unread messages...");
			var loggedInEmail = document.getElementById('loggedInMail').value;

			fetch(`/unread?email=${loggedInEmail}`)
				.then(response => response.json())
				.then(messages => {
					messages.forEach(message => {
						let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;

						// Show notification with sender's email as a parameter
						showToastNotification(`New message from ${senderName}: ${message.content}`, message.senderEmail);
					});
				})
				.catch(error => console.error("Error fetching unread messages:", error));
		}*/

		let displayedMessageIds = new Set(); // Track displayed messages
		let closedMessageIds = new Set(); // Track closed messages

		function fetchUnreadMessages() {
		    console.log("Fetching unread messages...");
		    var loggedInEmail = document.getElementById('loggedInMail').value;

		    fetch(`/unread?email=${loggedInEmail}`)
		        .then(response => response.json())
		        .then(messages => {
		            messages.forEach(message => {
		                console.log("Processing message ID:", message.id); // Print message ID to console
		                
		                // Ignore messages that were previously closed
		                if (!displayedMessageIds.has(message.id) && !closedMessageIds.has(message.id)) {
							//alert(1);
		                    let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;
		                    showToastNotification(`New message from ${senderName}: ${message.content}`, message.id, message.senderEmail);
		                    displayedMessageIds.add(message.id); // Mark message as displayed
		                }
						//alert(2);
		            });
		        })
		        .catch(error => console.error("Error fetching unread messages:", error));
		}
		// Global flag to track if the user manually dismissed notifications
		
		/*function showToastNotification(message, senderEmail) {
			
			var toastContainer = document.createElement('div');
			toastContainer.className = 'toast-notification';

			// Add message and close button
			toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close">✖</span>`;

			document.body.appendChild(toastContainer);

			// Animate in
			setTimeout(() => {
				toastContainer.classList.add('show');
			}, 100);

			// Auto-hide after 8 seconds
			let autoHideTimeout = setTimeout(() => closeToast(toastContainer), 10000);

			// Prevent opening chat when clicking the close button
			toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
				event.stopPropagation(); // Prevent click from bubbling to toastContainer
				clearTimeout(autoHideTimeout);
				
				closeToast(toastContainer);
			});

			// Open chat when clicking on the notification
			toastContainer.addEventListener('click', () => {
				openChatWithSender(senderEmail);
				closeToast(toastContainer); // Remove notification when chat opens
			});
		}*/
		function showToastNotification(message, messageId, senderEmail) {
			//alert(1);
		    var toastContainer = document.createElement('div');
		    toastContainer.className = 'toast-notification';
		    toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close">✖</span>`;

		    document.body.appendChild(toastContainer);

		    // Animate in
		    setTimeout(() => {
		        toastContainer.classList.add('show');
		    }, 100);

		    // Auto-hide after 8 seconds
		    let autoHideTimeout = setTimeout(() => closeToast(toastContainer, messageId), 8000);

		    // Prevent opening chat when clicking the close button
		    toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
		        event.stopPropagation(); // Prevent click from bubbling to toastContainer
		        clearTimeout(autoHideTimeout);
		        closedMessageIds.add(messageId); // Mark as closed so it won't be shown again
		        closeToast(toastContainer, messageId);
		    });

		    // Open chat when clicking on the notification
		    toastContainer.addEventListener('click', () => {
		        openChatWithSender(senderEmail);
		        closeToast(toastContainer, messageId); // Remove notification when chat opens
		    });
		}

		// Function to handle toast closing
		/*function closeToast(toast) {
			toast.classList.remove('show');
			setTimeout(() => toast.remove(), 300); // Faster fade-out
		}*/
		// Function to handle toast closing and mark as dismissed
		// Function to handle toast closing
		function closeToast(toast, messageId) {
		    toast.classList.remove('show');
		    setTimeout(() => toast.remove(), 300); // Faster fade-out
		}
		/*	function openChatWithSender(senderEmail) {
				console.log("Opening chat with:", senderEmail);
			    
				// Construct the URL for the UserFavorite page with the senderEmail as a query parameter
				const url = `/my-favorites?email=${encodeURIComponent(senderEmail)}`;
			    
				// Redirect to the UserFavorite page
				window.location.href = url;
			}*/

		function openChatWithSender(senderEmail) {
			console.log("Opening chat with:", senderEmail);

			// Store sender email in sessionStorage
			sessionStorage.setItem("chatSenderEmail", senderEmail);

			// Redirect to the UserFavorite page
			window.location.href = `/my-favorites`;
		}

		// Connect to the WebSocket server and load employees when the page is loaded
		document.addEventListener('DOMContentLoaded', function () {
			//fetchUnreadMessages();
			loadEmployees();
			connectWebSocket();
		});

	</script>
<script>
		document.addEventListener('DOMContentLoaded', () => {
			// Call fetch-earned-leave endpoint
			fetch(`/fetch-earned-leave?year=${new Date().getFullYear()}`, {method: 'GET'})
				.then(response => {
					console.log("Fetch request sent for static earned leave");

					if (!response.ok) {
						throw new Error('Network response was not ok for static earned leave');
					}
					return response.json();
				})
				.then(data => {
					console.log("Data from fetch-earned-leave endpoint:", data);
				})
				.catch(error => {
					console.error('Error fetching data from fetch-earned-leave:', error);
				});

			// Call calculate-earned-leave endpoint
			fetch(`/calculate-earned-leave?year=${new Date().getFullYear()}`, {method: 'GET'})
				.then(response => {
					console.log("Fetch request sent for calculated earned leave");

					if (!response.ok) {
						throw new Error('Network response was not ok for calculated earned leave');
					}
					return response.json();
				})
				.then(data => {
					console.log("Data from calculate-earned-leave endpoint:", data);
				})
				.catch(error => {
					console.error('Error fetching data from calculate-earned-leave:', error);
				});
		});
	</script>
</body>

</html>