<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quotation List</title>
    <!-- <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" 
     href="https://cdn.jsdelivr.net/npm/datatables.net-bs5/css/dataTables.bootstrap5.min.css">
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->
	<link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
  
    <!-- <link href="https://fonts.gstatic.com" rel="preconnect">
    	 <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
    -->
   <link rel="stylesheet" href="/assets/font/fonts.css"> 
  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
   
  <!--   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">
  <!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
  <script src="assets/js/jquery-3.6.4.min.js"></script> 
	
  <!-- Add this to your <head> or before the closing </body> tag -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> -->
  <link rel="stylesheet" href="/assets/css/all.min.css"> 
	
  <script src="DejaVuSans-normal.js"></script>
 <!--  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script> -->
  <script src="/assets/js/qrcode.min.js"></script>
  

</head>

<style>
	
/* 	table {
	width: 100%;
	min-width: 100%;
	table-layout: auto;
	white-space: nowrap;
}

table th, table td {
    width: auto; 
    white-space: nowrap; 
    padding: 10px;
}

th:nth-child(1), td:nth-child(1) { width: 20%; } 
th:nth-child(2), td:nth-child(2) { width: 15%; } 
th:nth-child(3), td:nth-child(3) { width: 25%; } 
th:nth-child(4), td:nth-child(4) { width: 40%; }  */

/* Set table layout */

        /* Style for pagination buttons */
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            border: 1px solid #007bff;
            color: #007bff;
            background: white;
            transition: 0.3s;
             cursor:default;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #007bff !important;
            color: white !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #0056b3 !important;
            color: white !important;
             cursor:default;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            color: #999 !important;
            border-color: #ddd;
        }

        /* Custom ellipsis style */
        .paginate_button.ellipsis {
            cursor:default;
            border: none;
            background: none;
            color: #999;
            padding: 5px 10px;
        }
        
        
  .sendEmailForCustomerOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 100;
   	display: none;
   	pointer-events: auto;
   }
   
   .viewQuotationOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 99;
   	display: none;
   	pointer-events: auto;
   }
   
   .revise_QuotationOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 103;
   	display: none;
   	pointer-events: auto;
   }
   
   .viewQuotationInnerBox{
   	width: 98%;
   	height: 96%;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
   }
   
   .revise_QuotationInnerBox{
   	width: 98%;
   	height: 96%;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
   }
   
   .emailPasswordOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 101;
   	display: none;
   	pointer-events: auto;
   }
   
   .sendEmailForCustomerInnerBox{
	width: 60%;
   	height: 96%;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
}

.emailPasswordInnerBox{
	width: 40%;
   	height: auto;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
}

.candidatePrfoilesHeading{
	font-family: 'Montserrat'; 
	font-size: 15px; 
	font-weight: bold; 
	text-transform: uppercase;
}

  .emailFormInnerBoxCloser{
   	/* background: red; */
   	padding-right: 10px;
   	text-align: right;
   }
   
   .emailFormInnerBoxCloser span{
   	font-size: 25px;
   	font-weight: bold;
   	cursor: pointer;
   }
   
   .sendEmailForCustomerBodyBox{
   	width: 100%;
   	height: 90%;
   	background: #fff;
   	overflow: auto;
   }
   
   .modal-backdrop {
    z-index: 1049 !important; /* Ensure Bootstrap's backdrop is below the custom modal */
  }
		 	/* Fullscreen overlay with dim background */
		#loadingPopup {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    background: rgba(0, 0, 0, 0.5); /* Dim background */
		    display: flex;
		    flex-direction: column;
		    justify-content: center;
		    align-items: center;
		    z-index: 9999;
		    font-family: Arial, sans-serif;
		    color: white; /* Text color for better contrast */
		}
		
		/* Spinner animation */
		.spinner {
		    width: 50px;
		    height: 50px;
		    border: 6px solid rgba(255, 255, 255, 0.3); /* Semi-transparent border */
		    border-top-color: white; /* Bright top border */
		    border-radius: 50%;
		    animation: spin 1s linear infinite;
		}
		
		/* Loading text */
		#loadingPopup p {
		    margin-top: 20px;
		    font-size: 18px;
		    font-weight: bold;
		    color: white;
		}
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

	.revise_suggestions {
          position: absolute;
          background: white;
          border: 1px solid #ccc;
          border-top: none;
          max-height: 150px;
          overflow-y: auto;
          width: 22.5%;
          z-index: 1000;
          display: none;
          font-size:14px;
      }
      .revise_suggestions div {
          padding: 8px;
          cursor: pointer;
      }
      .revise_suggestions div:hover {
          background: #f1f1f1;
      }
      
      .custom-modal-width {
	    max-width: 97%; /* or whatever width you prefer */
	  }
	  #invoiceForm input,
	  #invoiceForm select,
	  #invoiceForm textarea {
	    font-size: 12px;
	  }
	  
	   #performainvoiceForm input,
	  #performainvoiceForm select,
	  #performainvoiceForm textarea {
	    font-size: 12px;
	  }
    </style>
<body>

<div id="loadingPopup" style="display:none">
	<div class="spinnerAndParaMerger">
	    <div class="spinner"></div>
	    <p id="loadingPopupPara"></p>
    </div>
</div>


<div class="sendEmailForCustomerOuterDiv" id="sendEmailForCustomerOuterDiv">
	 <div class="sendEmailForCustomerInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">Send Mail</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeSendEmailForCustomerOuterDiv();">&times;</span></p>		               	  
			</div>
			<div class="card-body sendEmailForCustomerBodyBox mt-1">
			
				<div style="width: 96%; margin-left: auto; margin-right: auto;">
					<input class="form-check-input border border-primary" type="checkbox" id="emailManuallySentCheckBox">
					<label style="font-size: 14px;">Update status as email has been sent manually to the customer</label>
				</div>
			
				<div class="table-responsive" style="width: 96%; margin-left: auto; margin-right: auto;">
					<table style="width: 100%; font-size: 14px;">
						<tr>
							<th style="text-align: left; margin-bottom: 10px; margin-top: 10px;">From</th>
							<td><input type="text" th:value="${session.email}" readonly style="font-size: 14px; margin-bottom: 10px; margin-top: 10px;" class="form-control" id="emailFromAddress"></td>
						</tr>
						<tr>
							<th style="text-align: left; margin-bottom: 10px;">To</th>
							<td><input type="text" style="font-size: 14px; margin-bottom: 10px;" class="form-control" id="emailToAddress"></td>
						</tr>
						<tr>
							<th style="text-align: left; margin-bottom: 10px;">CC</th>
							<td><input type="text" style="font-size: 14px; margin-bottom: 10px;" class="form-control" id="emailCCAddress"></td>
						</tr>
						<tr>
							<th style="text-align: left; margin-bottom: 10px;">Subject</th>
							<td><input type="text" style="font-size: 14px; margin-bottom: 20px;" class="form-control" id="emailSubject"></td>
						</tr>
						<tr>
							<td style="padding-left: 3px; padding-right: 3px;" colspan="2">
								<textarea class="form-control" placeholder="Body" style="font-size: 14px; margin-bottom: 10px;" id="emailBody" rows="4"></textarea>
							</td>
						</tr>
					</table>
				</div>
				
				<div style="width: 96%; margin-left: auto; margin-right: auto;">
					<div class="col-sm-12 form-group mt-4 modal-footer table-responsive p-2">
						<button type="button" id="downloadPdfManuallyBtn" class="btn btn-danger mx-1" style="font-size: 14px; display: none;" onclick="downloadPDF()"> <i class="fas fa-file-pdf"></i>Download PDF</button>
						<button type="button" id="email_send_button" class="btn btn-primary" onclick="openEmailPasswordOuterDiv()" style="font-size: 14px; float: right;">Send</button>
					</div>
				</div>
			
			</div>
		</div>
	</div>

<div class="emailPasswordOuterDiv" id="emailPasswordOuterDiv">
	 <div class="emailPasswordInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">Please Enter Email Password</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeEmailPasswordOuterDiv();">&times;</span></p>		               	  
			</div>
			<div class="card-body mt-1" style="padding-bottom: 10px;">
			
				<div class="table-responsive" style="width: 96%; margin-left: auto; margin-right: auto;">
					<div class="col-sm-12 form-group mb-2" style="padding-left: 3px; padding-right: 3px;">
						<input type="text" class="form-control mt-2" id="ionos_password">
					</div>
				</div>
				
				<div class="table-responsive" style="width: 96%; margin-left: auto; margin-right: auto;">
					<div class="col-sm-12 form-group p-2">
						<button type="button" class="btn btn-primary" id="emailSendBtn" onclick="sendDataToEmailToTheParticularCustomer();" style="font-size: 14px; float: right;">Submit</button>
					</div>
				</div>
				
			</div>
		</div>
	</div>



<!-- <div class="modal fade" id="quotationModal" tabindex="-1" aria-labelledby="quotationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl" style="max-width: 100vw;">
		<div class="modal-content">
          <div class="modal-header">
                <h5 class="modal-title" id="quotationModalLabel">View Quotation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"> -->
            
            
<div class="viewQuotationOuterDiv" id="viewQuotationOuterDiv">
	 <div class="viewQuotationInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">View Quotation</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeViewQuotationOuterDiv();">&times;</span></p>		               	  
			</div>
            
            
                <!-- Quotation Form -->
                <form id="quotationForm" style="padding: 20px;">
                  <input type="hidden" id="editRowIndex"> 
                
                <div class="row mb-3 justify-content-between">
						<div class="col-md-3">
							<input type="text" class="form-control" id="qid" placeholder="Quotation ID" disabled />
						</div>
						<div class="col-md-3">
							<input type="datetime-local" class="form-control text-center" id="qdateTime" disabled />
						</div>
					</div>
                
                
                    <div class="row">      
                    	<div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="company_honorifics" class="form-control" readonly>
                        </div>              
                        <div class="col-md-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="vendorName" class="form-control"  list="customerList" autocomplete="off" required>
                            <div id="suggestionsBox" class="suggestions"></div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Customer Legal Name</label>
                            <input type="text" id="vendorlegalNamee" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST Number</label>
                            <input type="text" id="gstnumberr" class="form-control" required>
                        </div>
                         <div class="col-md-2">
                            <label class="form-label">Order Method</label>
                             <input type="text" id="orderMethod" class="form-control" required>                           
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="contact_person_honorifics" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contact Person Name</label>
                             <input type="text" id="personName" class="form-control" required>  
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Designation</label>
                            <input type="text" id="designation" class="form-control" >
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mobile Number</label>
                            <input type="text" id="contactDetails" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Email ID</label>
                            <input type="email" id="emailId" class="form-control">
                        </div>
                         <div class="col-md-6">
                         
                            <label class="form-label">Billing Address</label>
                            <textarea id="shipmentAddress" class="form-control"></textarea>                     
   						</div>
                        <div class="col-md-6"> 
                            <label class="form-label">Delivery Address</label>
                            <textarea id="deliveryAddress" class="form-control"></textarea>
                        </div>
                   </div>    
                   
                   <hr>
                    <!-- GST Selection -->
                    <h5>Tax Type</h5>
                    
                     <hr>
                    <div class="d-flex align-items-center mb-3">
                        <input type="checkbox" id="interState" class="form-check-input me-1" onclick="toggleGST('interState')"> 
                        <label class="form-check-label me-3">Interstate</label>

                        <input type="checkbox" id="outerState" class="form-check-input me-1" onclick="toggleGST('outerState')"> 
                        <label class="form-check-label me-3">Outerstate</label>

                       <!--  <input type="number" id="gstPercentage" class="form-control ms-3" style="width: 100px;" placeholder="GST %" oninput="updateTableHeaders()">
                   -->  
                   </div>

                   <!-- Product Table -->
                    <hr>
                                 
                  
                  <div class="table-responsive">
					<table class="table table-bordered mt-3">
					    <thead class="table bg-secondary">
					        <tr>         
					            <th style="display: none;">Product Name</th>
					            <th>HSN Code</th>
					            <th>Part Number</th>
					            <th>Description</th>
					            <th>Quantity</th>
					            <th>Price</th>
					            <th>Taxable Value</th>
					            <th class="cgst-header d-none">CGST (9%)</th>
					            <th class="sgst-header d-none">SGST (9%)</th>
					            <th class="igst-header d-none">IGST (18%)</th>            
					            <th>Total Value</th>
					            
					        </tr>
					    </thead>
					    <tbody id="productTableBody">
					        <!-- Rows will be dynamically added here -->
					    </tbody>
					</table>
				</div>


		<table style="display: none;" class="table-bordered hiddenProductDetailsTableBoxData">
		    <tbody id="hiddenProductTableBody">
		        <!-- Rows will be dynamically added here -->
		    </tbody>
		</table>
		
			<div class="col-md-12 mt-2">
				<label>Terms And Condition</label>
				<textarea class="form-control" style="font-size: 14px;" readonly id="terms_and_condition" rows="3"></textarea>
			</div>

                </form>
                
                <div class="modal-footer table-responsive p-2">
	                <button type="button" class="btn btn-secondary mx-1" style="font-size: 14px;" onclick="closeViewQuotationOuterDiv();">Close</button>
	                <button type="button" class="btn btn-danger mx-1" style="font-size: 14px;" id="terminateQuotationBtn" onclick="forwardQuotationForReview($('#qid').val(), 4)">Terminate</button>
	                <button type="button" class="btn btn-success mx-1" style="font-size: 14px; display: none;" id="quotationReviewApproveBtn" onclick="updateQuotationStatusAfterReview($('#qid').val(), $('#emailId').val(), 2)">Approve</button>
	                <button type="button" class="btn btn-primary mx-1" style="font-size: 14px; display: none;" id="reviseQuotationBtn" onclick="openReviseQuotationOuterDiv();">Revise</button>
	                <button type="button" class="btn btn-primary mx-1" style="font-size: 14px;" id="quotationSubmitBtnForReview" onclick="forwardQuotationForReview($('#qid').val(), 1)">Submit</button>
	                <button type="button" class="btn btn-success mx-1" style="font-size: 14px;" id="wonQuotationBtn" onclick="forwardQuotationForReview($('#qid').val(), 3)">Won</button>
	                <!-- <button type="button" class="btn btn-danger mx-1" style="font-size: 14px;" onclick="downloadPDF()"> <i class="fas fa-file-pdf"></i>Download PDF</button> -->
	            </div>
                
            </div>
       
    </div>
<!-- </div>
</div> -->


<div class="revise_QuotationOuterDiv" id="revise_QuotationOuterDiv">
	 <div class="revise_QuotationInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">Revise Quotation</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeReviseQuotationOuterDiv();">&times;</span></p>		               	  
			</div>
            
                <!-- Quotation Form -->
                <form id="revise_quotationForm" style="padding: 20px;">
                  <input type="hidden" id="revise_editRowIndex"> 
                
                <div class="row mb-3 justify-content-between">
						<div class="col-md-3">
							<input type="text" class="form-control" id="revise_qid" placeholder="Quotation ID" disabled />
						</div>
						<div class="col-md-3">
							<input type="datetime-local" class="form-control text-center" id="revise_qdateTime" disabled />
						</div>
					</div>
                
                    <div class="row"> 
                   		 <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="revise_company_honorifics" class="form-control" readonly>
                        </div>                   
                        <div class="col-md-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="revise_vendorName" class="form-control"  list="customerList" autocomplete="off" required>
                            <div id="revise_suggestionsBox" class="revise_suggestions"></div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Customer Legal Name</label>
                            <input type="text" id="revise_vendorlegalNamee" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST Number</label>
                            <input type="text" id="revise_gstnumberr" class="form-control" required>
                        </div>
                         <div class="col-md-2">
                            <label class="form-label">Order Method</label>
                             <!-- <input type="text" id="revise_orderMethod" class="form-control" required> --> 
                             <select id="revise_orderMethod" class="form-select">
                                <option value="Online">Online</option>
                                <option value="Phone">Phone</option>
                                <option value="In-Person">In-Person</option>
                            </select>                          
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="revise_contact_person_honorifics" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contact Person Name</label>
                             <!-- <input type="text" id="revise_personName" class="form-control" required> -->  
                        	<select id="revise_personName" class="form-control form-select" required>
                        	 <option id="revise_personNameOptionForPopupFistTime"></option>
       						 <!-- <option value="">Select Contact Person</option> -->
    						</select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Designation</label>
                            <input type="text" id="revise_designation" class="form-control" >
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mobile Number</label>
                            <input type="text" id="revise_contactDetails" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Email ID</label>
                            <input type="email" id="revise_emailId" class="form-control">
                        </div>
                         <div class="col-md-6">
                            <label class="form-label">Billing Address</label>
                            <!-- <input type="checkbox" id="revise_sameAddress" onchange="copyAddress()" style="margin-left:10px;"> Same as Billing Address -->
                            <textarea id="revise_shipmentAddress" class="form-control"></textarea>                     
   						</div>
                        <!-- <div class="col-md-6"> 
                            <label class="form-label">Delivery Address</label>
                            <textarea id="revise_deliveryAddress" class="form-control"></textarea>
                        </div> -->
                        <div class="col-md-6 mt-2"> 
                            <label class="form-label">Delivery Address</label>
                            <!-- <textarea id="deliveryAddress" class="form-control"></textarea> -->
                            <select id="revise_deliveryAddress" class="form-control form-select">
       						 <option id="revise_deliveryAddressOptionForPopupFistTime"></option>
    						</select>
                        </div>
                   </div>    
                   
                   <hr>
                    <!-- GST Selection -->
                    <h5>Tax Type</h5>
                    
                     <hr>
                    <div class="d-flex align-items-center mb-3">
                        <input type="checkbox" id="revise_interState" name="interState" class="form-check-input me-1 revisetaxTypeCheckBox" onchange="toggleGST('interState')"> 
                        <label class="form-check-label me-3">Interstate</label>

                        <input type="checkbox" id="revise_outerState" name="outerState" class="form-check-input me-1 revisetaxTypeCheckBox" onchange="toggleGST('outerState')"> 
                        <label class="form-check-label me-3">Outerstate</label>

                       <!--  <input type="number" id="gstPercentage" class="form-control ms-3" style="width: 100px;" placeholder="GST %" oninput="updateTableHeaders()">
                   -->  
                   </div>

                   <!-- Product Table -->
                    <hr>
                    <h5>Product Details</h5>
                     <hr>
<div class="d-flex justify-content-between align-items-center" style="gap: 10px;">
   
     <div class="col-md-3">
        <select class="form-control form-select" id="productName">
        	<!-- <option id="revise_productNameOptionForPopupFistTime"></option> -->
            <option value="">Select Product</option>
          
        </select>
    </div>
    <div class="col-md-3">
        <input type="text"  class="form-control" id="hsnCode" readonly>
            <!-- <option value="">Select HSN Code</option> -->
          
       
    </div>
    <div class="col-md-3">
        <input type="text"  class="form-control" id="partNumber" readonly>
          <!--   <option value="">Select Part Number</option> -->
            
      
    </div>
    <div class="col-md-3" style="display: none;">
        <input type="text"  class="form-control" id="productDescription" readonly>
            <!-- <option value="">Select Description</option> -->
          
        
    </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-secondary w-100" onclick="addProduct()">Add Product</button>
        </div>

</div>

	<div class="table-responsive">
		<table class="table table-bordered mt-3" style="font-size: 12px;">
		    <thead class="table bg-secondary">
		        <tr>
		            <th>Sl No</th>
		            <!-- <th>Product Name</th> -->
		            <th>HSN Code</th>
		            <th>Part Number</th>
		            <th>Description</th>
		            <th>Quantity</th>
		            <th>Price</th>
		            <th>Taxable Value</th>
		            <th class="revise_cgst-header d-none">CGST (9%)</th>
		            <th class="revise_sgst-header d-none">SGST (9%)</th>
		            <th class="revise_igst-header d-none">IGST (18%)</th>            
		            <th>Total Value</th>
		            <th>Actions</th>
		        </tr>
		    </thead>
		    <tbody id="revise_productTableBody">
		        <!-- Rows will be dynamically added here -->
		    </tbody>
		</table>
	</div>
                                 
                  
<!-- <table class="table table-bordered mt-3">
    <thead class="table bg-secondary">
        <tr>         
            <th>Product Name</th>
            <th>HSN Code</th>
            <th>Part Number</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Taxable Value</th>
            <th class="revise_cgst-header">CGST (9%)</th>
            <th class="revise_sgst-header">SGST (9%)</th>
            <th class="revise_igst-header">IGST (18%)</th>            
            <th>Total Value</th>
            
        </tr>
    </thead>
    <tbody id="revise_productTableBody">
        Rows will be dynamically added here
    </tbody>
</table> -->


			<div class="col-md-12 mt-2">
				<label>Terms And Condition</label>
				<textarea class="form-control" style="font-size: 14px;" id="revise_terms_and_condition" rows="3"></textarea>
			</div>
		
                </form>
                <div class="modal-footer table-responsive p-2">
                <button type="button" class="btn btn-primary" style="font-size: 14px;" onclick="reviseQuotation();" id="reviseQuotationSubmitBtn">Submit</button>
            </div>
          </div>
    </div>

	<!--<div class="table-responsive mt-3">
	    <table class="table table-bordered" style="font-size: 12px;">
	        <thead class="table bg-secondary">
	            <tr>
	                <th>Purchase ID</th> 
	                <th>Created By</th> 
	                <th>PO Number</th>
	                <th>PO Date</th>
	                <th>Created Date and Time</th> 
	                <th>Customer Legal Name</th> 
	                <th>Supplier</th>
	            </tr>
	        </thead>
	        <tbody id="purchaseOrderTableBody">
	            <tr th:each="order, orderStat : ${orders}">
	                <td th:text="${order.purchaseId}"></td> 
	                <td th:text="${order.createdByEmpId}"></td> 
	                <td th:rowspan="${#lists.size(order.items)}" th:text="${order.poNumber}"></td>
	                <td th:rowspan="${#lists.size(order.items)}" th:text="${order.poDate}"></td>
	                <td th:rowspan="${#lists.size(order.items)}" th:text="${order.createdDateTime}"></td>
	                <td th:rowspan="${#lists.size(order.items)}" th:text="${order.cus_leagal_name}"></td> 
	                <td th:rowspan="${#lists.size(order.items)}" th:text="${order.supplierName}"></td>
	            </tr>
	        </tbody>
	    </table>
	</div>-->

	<div class="modal fade" id="purchaseOrderModal" tabindex="-1" aria-labelledby="purchaseOrderModalLabel" aria-hidden="true" data-bs-backdrop="static">
	  <div class="modal-dialog modal-xl custom-modal-width">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="purchaseOrderModalLabel">Preview Sales Order</h5>
	        <button type="button" class="btn btn-outline-primary" onclick="openInvoiceModal()" >create invoice</button>
	        <button type="button" class="btn btn-outline-primary" onclick="openPerformaInvoiceModal()" style="margin-left:10px">create PI</button>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	        <!-- Purchase Order Form -->
	        <form id="purchaseOrderForm" enctype="multipart/form-data">
				<div class="row mb-3 justify-content-between">
				  <div class="col-md-3">
				    <label class="form-label">Sales Order ID</label>
				    <input type="text" class="form-control" id="poid" placeholder="Purchase Order ID" disabled />
				  </div>
				 
				  <div class="col-md-3">
				    <label class="form-label">Date & Time</label>
					<input type="text" class="form-control text-center" id="podateTime" readonly />
				  </div>
				</div>
	 			
	          <!-- Row 1 -->
	          <div class="row mb-3">
	            <div class="col-md-4">
	              <label class="form-label">PO Number</label>
	              <input type="text" class="form-control" id="po_number" required readonly>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">PO Date</label>
	              <input type="date" class="form-control" id="po_date" required readonly>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">Vendor Code</label>
	              <input type="text" class="form-control" id="vendor_code" required readonly>
	            </div>
	            <div class="row mb-2">
			    <div class="col-md-4">
			      <label class="form-label">Mode of Payment</label>
			      <input type="text" class="form-control" id="mode_of_payment" placeholder="Enter payment mode (e.g., NEFT, UPI)" required>
			    </div>
			  </div>
	             
	          </div>
	          <hr>
			  <div class="col-md-3">
				    <label class="form-label">Quotation ID</label> 			     
				    <!--  <select class="form-select" id="quotationId" name="quotationId">
				    	<option value="" selected disabled>Select a Quotation ID</option>
				    	        <th:block th:each="qid : ${quotationIds}">
						            <option th:value="${qid}" th:text="${qid}"></option>
						        </th:block>
				    </select>  -->
				    <input type="text" id="quotationId" class="form-control" readonly>
				    <!-- <input id="quotationId" name="quotationId"> -->
				</div>
				   <hr>
				        <div class="row">      	
	                    	<div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="company_honorifics1" class="form-control" readonly>
	                        </div>              
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Name</label>
	                            <input type="text" id="vendorName1" class="form-control"  list="customerList" autocomplete="off" readonly required>
	                            <div id="suggestionsBox1" class="suggestions"></div>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Legal Name</label>
	                            <input type="text" id="vendorlegalNamee1" class="form-control" readonly required>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">GST Number</label>
	                            <input type="text" id="gstnumberr1" class="form-control" readonly required>
	                        </div>
	                         <div class="col-md-2">
	                            <label class="form-label">Order Method</label>
	                             <input type="text" id="orderMethod1" class="form-control" required>                           
	                        </div>
	                        <div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="contact_person_honorifics1" class="form-control" readonly>
	                        </div>
	                        
	                        <div class="col-md-3">
	                            <label class="form-label">Contact Person Name</label>
	                           	 <select id="personName1" class="form-control form-select" >
	       						 <option value="">Select Contact Person</option>
	    						</select>
	                        </div>
	                        
	                        <div class="col-md-2">
	                            <label class="form-label">Designation</label>
	                            <input type="text" id="designation1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Mobile Number</label>
	                            <input type="text" id="contactDetails1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Email ID</label>
	                            <input type="email" id="emailId1" class="form-control" readonly>
	                        </div>
	                   </div>   
			          <!-- Row 2 -->
			          <div class="row mb-3">
			            <div class="col-md-6">
			              <label class="form-label">Customer Billing Address</label>
			              <textarea class="form-control" id="billing_address" rows="2" required readonly></textarea>
			            </div>
			            <!-- <div class="col-md-6">
			              <label class="form-label">Shipping Address</label>
			              <textarea class="form-control" id="shipping_address" rows="2" required></textarea>
			            </div> -->
			            <div class="col-md-6 mt-2"> 
	                            <label class="form-label">Delivery Address</label>
	                            <!-- <textarea id="deliveryAddress" class="form-control"></textarea> -->
	                            <!-- <select id="shipping_address" class="form-control form-select">
	       						 <option value="">Select Delivery Address</option>
	    						</select> -->
	    						<textarea class="form-control" id="shipping_address" rows="2" required readonly></textarea>
	                        </div>
			            </div>
				
					 <hr>
	            <!-- Row 3 -->
	 			<h5>Tax Type</h5>
	                    
	                     <hr>
	                    <div class="d-flex align-items-center mb-3">
	                        <input type="checkbox" id="interState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('interState')"> 
	                        <label class="form-check-label me-3" style="font-size: 14px;">Intrastate(CGST 9% + SGST 9%)</label>

	                        <input type="checkbox" id="outerState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('outerState')"> 
	                        <label class="form-check-label me-3" style="font-size: 14px;">Interstate(IGST 18%)</label>
	 
	                   </div>        

		          <!-- Table for Items -->
		          <div class="table-responsive mb-3">
		            <table class="table table-bordered" id="po_items_table">
		              <thead class="table-light">
		                <tr>
		                  <th>Sl No</th> 
						  <th>Part No</th>
						  <th>HSN Code</th>
		                  <th>Description</th>
		                  <th>Quantity</th>
		                  <th>Price</th>
		                  <th>Total</th>
						  
						  <th class="action-col" style="display: none;">Action</th> <!-- initially hidden -->
		                </tr>
		              </thead>
		              <tbody>
		                <tr>
		                  <td><input type="number" class="form-control" name="slno[]" value="1" readonly></td>
		                  <td><input type="text" class="form-control" name="modules[]"></td>
						  <td><input type="text" class="form-control" name="part_no[]"></td>
						  <td><input type="text" class="form-control" name="hsn_code[]"></td>
		                  <td><input type="text" class="form-control" name="description[]"></td>
		                  <td><input type="number" class="form-control" name="quantity[]" min="1" oninput="calculateTotal(this)"></td>
		                  <td><input type="number" class="form-control" name="price[]" min="0" step="0.01" oninput="calculateTotal(this)"></td>
		                  <td><input type="number" class="form-control" name="line_total[]" ></td>
						  <td class="action-col" style="display: none;">
						      <button type="button" class="btn btn-danger removeRowBtn" onclick="removeRow(this)">Remove</button>
						  </td>
						</tr>
		              </tbody>
		            </table> 
		          </div>
				  
				  <!-- File Input for PDF Attachment -->
				  <!-- <div class="row mb-3">
				      <div class="col-md-6">
				          <label class="form-label">Attach PDF</label>
				          <input type="file" class="form-control" id="po_attachment" name="po_attachment" accept="application/pdf" onchange="showPreviewButton()">
				          <small class="form-text text-muted">Only PDF files are allowed.</small>
				      </div>
				  </div> -->

				  <!-- Preview Button (Initially Hidden) -->
				  <div id="previewButtonDiv" style="display:none;">
				      <button type="button" class="btn btn-primary" id="previewButton" onclick="previewPDF()">Preview PDF</button>
				  </div>
				  
				  <!-- Terms and Conditions Section -->
				            <div class="col-md-12 mt-3">
				              <label class="form-label">Terms And Conditions</label>
				              <textarea class="form-control" id="terms_and_conditionnew" rows="3"  style="font-size: 14px;">
				               
				              </textarea>
				            </div>
				            
				            <!-- New Row for Terms of Delivery -->
							<div class="row mb-3">
							  <div class="col-md-12">
							    <label class="form-label">Terms of Delivery</label>
							    <textarea class="form-control" id="terms_of_delivery" rows="3" style="font-size: 14px;" readonly></textarea>
							  </div>
							</div>
				             
				  <input type="text" id="orderDetailsId" style="display:none">
				  
		          <!-- Submit Button -->
		          <div class="text-end">
		          	 <div>
					   <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#dcModal">
						  Add DC
						</button>

					   <!-- <button type="button" class="btn btn-outline-primary" onclick="openPerformaInvoiceModal()" >Add Performer Invoice</button> -->
					   <button type="button" class="btn btn-outline-primary">Invoice</button>
					 </div>
		            <!-- <button type="submit" class="btn btn-success">Submit Purchase Order</button> -->
		          </div>
		        </form>
		      </div>
		    </div>
		  </div>
		</div>

<!-- invoice modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="performaInvoiceModalLabel" aria-hidden="true" data-bs-backdrop="static">
	  <div class="modal-dialog modal-xl custom-modal-width">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="invoiceModalLabel">Invoice</h5>
	        <!--  <button type="button" class="btn btn-outline-success" onclick="viewPI()">View PI</button>  -->
	       <!--  <button type="button" class="btn btn-outline-success m-2" onclick="approvePI()" th:if="${loggedAdminDept == 84}">Approve PI</button>  -->
	        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
	      </div> 
	      <div class="modal-body" style="font-size:12px;">
	        <!-- Purchase Order Form -->
	        <form id="invoiceForm"  method="post" enctype="multipart/form-data" >
	            
				<div class="row mb-3 justify-content-between">
				
				  <div class="col-md-3">
				    <label class="form-label">Invoice ID</label>
				    <input type="text" class="form-control" id="pi_id" placeholder="Performa Invoice ID" disabled />
				   </div>
				   <div  class="col-md-3">
				     <label class="form-label">Sales Order ID</label>
				     <input type="text" class="form-control" id="pi_po_id" placeholder="Performa Invoice ID" disabled />
				   </div>
				   <input type="hidden" class="form-control" id="salesId">
				   <div class="col-md-3">
				    <label class="form-label">Date of Supply</label>
					<input type="date" class="form-control" id="pidateTime" required/>
				   </div>
				</div>
	 			
	          <!-- Row 1 -->
	          <div class="row mb-3">
	          
	            <div class="col-md-4">
	              <label class="form-label">PO Number</label>
	              <input type="text" class="form-control" id="pi_number" required readonly>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">PO Date</label>
	              <input type="date" class="form-control" id="pi_date" required readonly>
	            </div>
	             <div class="col-md-4">
	              <label class="form-label">PI No</label>
	              <input type="text" class="form-control" id="pi_no">
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">Vendor Code</label>
	              <input type="text" class="form-control" id="pi_vendor_code" required readonly>
	            </div>
	            <div class="col-md-4">
			      <label class="form-label">Mode of Payment</label>
			      <input type="text" class="form-control" id="pi_mode_of_payment" placeholder="Enter payment mode (e.g., NEFT, UPI)" required>
			    </div>
	            
	            <div class="col-md-4">
	              <label class="form-label">Place of supply</label>
	              <input type="text" class="form-control" id="pi_supply_place" required>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">vehicle No</label>
	              <input type="text" class="form-control" id="pi_vehicle_No">
	            </div>
	            
	            <div class="col-md-4">
				  <label class="form-label">State</label>
				  <select class="form-select" id="pi_state" onchange="setStateCode()" required>
				    <option value="">Select State</option>
				    <option value="1">JAMMU AND KASHMIR</option>
				    <option value="2">HIMACHAL PRADESH</option>
				    <option value="3">PUNJAB</option>
				    <option value="4">CHANDIGARH</option>
				    <option value="5">UTTARAKHAND</option>
				    <option value="6">HARYANA</option>
				    <option value="7">DELHI</option>
				    <option value="8">RAJASTHAN</option>
				    <option value="9">UTTAR PRADESH</option>
				    <option value="10">BIHAR</option>
				    <option value="11">SIKKIM</option>
				    <option value="12">ARUNACHAL PRADESH</option>
				    <option value="13">NAGALAND</option>
				    <option value="14">MANIPUR</option>
				    <option value="15">MIZORAM</option>
				    <option value="16">TRIPURA</option>
				    <option value="17">MEGHALAYA</option>
				    <option value="18">ASSAM</option>
				    <option value="19">WEST BENGAL</option>
				    <option value="20">JHARKHAND</option>
				    <option value="21">ORISSA</option>
				    <option value="22">CHHATTISGARH</option>
				    <option value="23">MADHYA PRADESH</option>
				    <option value="24">GUJARAT</option>
				    <option value="25">DAMAN AND DIU</option>
				    <option value="26">DADAR AND NAGAR HAVELI</option>
				    <option value="27">MAHARASTRA</option>
				    <option value="29">KARNATAKA</option>
				    <option value="30">GOA</option>
				    <option value="31">LAKSHADWEEP</option>
				    <option value="32">KERALA</option>
				    <option value="33">TAMIL NADU</option>
				    <option value="34">PUDUCHERRY</option>
				    <option value="35">ANDAMAN AND NICOBAR</option>
				    <option value="36">TELANGANA</option>
				    <option value="37">ANDHRA PRADESH</option>
				    <option value="97">OTHER TERRITORY</option>
				    <option value="96">OTHER COUNTRY</option>
				  </select>
				</div>
				
				<div class="col-md-4">
				  <label class="form-label">State Code</label>
				  <input type="text" class="form-control" id="pi_state_code" readonly required>
				</div>
				
				<div class="col-md-4">
					<label class="form-label">Transportation Mode</label>
					<input type="text" class="form-control" id="pi_transportMode">
				</div>
	            <!-- <div class="col-md-4">
	              <label class="form-label">State Code</label>
	              <input type="text" class="form-control" id="pi_state_code" required>
	            </div> -->
	             
	          </div>
	          <hr>
	          <div class="row mb-3">
	          </div>
			    <div class="col-md-3">
				    <label class="form-label">Quotation ID</label> 			     
				    <input type="text" id="pi_quotationId" class="form-control" readonly>
				</div>
				<hr> 
				        <div class="row">      
	                    	<div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="pi_company_honorifics1" class="form-control" readonly>
	                        </div>              
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Name</label>
	                            <input type="text" id="pi_cust_name" class="form-control"  list="customerList" autocomplete="off" readonly required>
	                            <div id="pi_suggestionsBox1" class="suggestions"></div>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Legal Name</label>
	                            <input type="text" id="pi_cust_legan_name" class="form-control" readonly required>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">GST Number</label>
	                            <input type="text" id="pi_gstnumberr1" class="form-control" readonly required>
	                        </div> 
	                        <div class="col-md-2">
	                            <label class="form-label">Order Method</label>
	                             <input type="text" id="pi_orderMethod1" class="form-control" required>                           
	                        </div>	                        
	                        <div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="pi_contact_person_honorifics1" class="form-control" readonly>
	                        </div>
	                        
	                        <div class="col-md-3">
	                            <label class="form-label">Contact Person Name</label>
	                           	<!-- <select id="pi_personName1" class="form-control form-select" >
	       						 	<option value="">Select Contact Person</option>
	    						</select>  -->
	    						<input type="text" id="pi_personName1" class="form-control" readonly>
	                        </div> 	      
	                                          
	                        <div class="col-md-2">
	                            <label class="form-label">Designation</label>
	                            <input type="text" id="pi_designation1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Mobile Number</label>
	                            <input type="text" id="pi_contactDetails1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Email ID</label>
	                            <input type="email" id="pi_emailId1" class="form-control" readonly>
	                        </div>
	                   </div>   
			          <!-- Row 2 -->
			          <div class="row mb-3">
			            <div class="col-md-6">
			              <label class="form-label">Customer Billing Address</label>
			              <textarea class="form-control" id="pi_billing_address" rows="2" required readonly></textarea>
			            </div>
			            <div class="col-md-6 mt-2"> 
	                            <label class="form-label">Delivery Address</label>
	                            
	    						<textarea class="form-control" id="pi_shipping_address" rows="2" required readonly></textarea>
	                    </div>
			          </div>
				
					 <hr>
	            <!-- Row 3 -->
	 			<h5>Tax Type</h5>
	                    
	                     <hr>
	                    <div class="d-flex align-items-center mb-3">
	                        <input type="checkbox" id="pi_interState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('interState')"> 
	                        <label class="form-check-label me-3" style="font-size: 12px;">Intrastate(CGST 9% + SGST 9%)</label>

	                        <input type="checkbox" id="pi_outerState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('outerState')"> 
	                        <label class="form-check-label me-3" style="font-size: 12px;">Interstate(IGST 18%)</label>
	                    </div>        

		          <!-- Table for Items -->
		          <div class="table-responsive mb-3">
		            <table class="table table-bordered" id="pi_items_table" style="font-size:12px;">
		              <thead class="table-light">
		                <tr>
		                  <th>Sl No</th>		                  
						  <th>Part No</th>
						  <th>HSN Code</th>
		                  <th>Description</th>
		                  <th>Quantity</th>
		                  <th>Dispatched Quantity</th>
		                  <th>Price</th>
		                  <th>Taxable Value</th>
		                  <th class="cgst-saleheader">CGST (9%)</th>
						  <th class="sgst-saleheader">SGST (9%)</th>
						  <th class="igst-saleheader">IGST (18%)</th>
		                  <th>Total</th>
		                  <th>Action</th>
						  <th class="action-col" style="display: none;">Action</th> <!-- initially hidden -->
		                </tr>
		              </thead>
		              <tbody>
		                <tr>
		                  <td><input type="number" class="form-control" name="slno[]" value="1" readonly></td>
		          
						  <td><input type="text" class="form-control" name="part_no[]"></td>
						  <td><input type="text" class="form-control" name="hsn_code[]"></td>
		                  <td><input type="text" class="form-control" name="description[]"></td>
		                  <td><input type="number" class="form-control" name="quantity[]" min="1" oninput="validateAndCalculate(this)"></td>
		                  <td><input type="number" class="form-control" name="price[]" min="0" step="0.01" oninput="calculateTotal(this)"></td>
		                  <td><input type="number" class="form-control saletotal-without-gst" name="line_total[]" readonly></td>
		                  <td class="cgst-value">
				             <input type="number" class="form-control salecgst" name="cgst[]" value="${product.cgst}" readonly/>
				          </td>
				          <td class="sgst-value">
				              <input type="number" class="form-control salesgst" name="sgst[]"  value="${product.sgst}" readonly/>
				          </td>
				          <td class="igst-value">
				             <input type="number" class="form-control saleigst" name="igst[]"  value="${product.igst}" readonly />
				          </td>		                  
		                  <td><input type="number" class="form-control saletotal-with-gst" name="total_line_total[]" readonly></td>
						  <td class="action-col" style="display: none;">
						     <button type="button" class="btn btn-danger removeRowBtn" onclick="removeRow(this)">Remove</button>
						  </td>
						  <td><input type="text" class="form-control" name="product_id[]"></td>
					  </tr>
		              </tbody>
		            </table>
		            <!--  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItemRow()">Add Item</button> -->
		            <div class="d-flex justify-content-end mt-3" id="summary-section">
					  <table class="table table-sm table-bordered" style="width: 400px; font-size: 12px;">
					    <tbody>
					      <tr><td>Total Amount:</td><td class="text-end" id="summary-total">0.00</td></tr>
					      <tr><td>CGST(9%):</td><td class="text-end" id="summary-cgst">0.00</td></tr>
					      <tr><td>SGST(9%):</td><td class="text-end" id="summary-sgst">0.00</td></tr>
					      <tr><td>IGST(18%):</td><td class="text-end" id="summary-igst">0.00</td></tr>
					      <tr>
							  <td>Tax Amount (GST):</td>
							  <td class="text-end" id="summary-gst-tax">0.00</td>
						  </tr>
						   <tr>
							  <td>Total Amount after GST and before TCS:</td>
							  <td class="text-end" id="total-amount-after-GST-before-TCS">0.00</td>
						  </tr>
							<tr>
							  <td>
							    TCS (0.1%):
							    <select id="apply-tcs" class="form-select form-select-sm d-inline w-auto ms-2">
							      <option value="no">Not Apply</option>
							      <option value="yes">Apply</option>
							    </select>
							  </td>
							  <td class="text-end" id="summary-tcs">0.00</td>
							</tr>

					      <tr><td>Total Tax:</td><td class="text-end" id="summary-tax">0.00</td></tr>
					      <tr><td>Total Amount after Tax:</td><td class="text-end" id="summary-with-tax">0.00</td></tr>
					      <tr><td>GST Payable on Reverse Charges: </td><td class="text-end"><input type="number" id="gst-reverse-charge" placeholder="0.00" step="any"></td></tr>
					      <tr><td>Total Amount after Reverse Charges:</td><td class="text-end" id="total-amount-after-revese-charge">0.00</td></tr>
					      <tr>
							  <td>
							    Round Off (Decimal): 
							    <select id="round-type" class="form-select form-select-sm d-inline w-auto ms-2">
								  <option value="even">even</option>
								  <option value="odd">odd</option>
								</select>
							  </td>
							  
							  <td class="text-end" id="summary-roundoff">0.00</td>
							  
						  </tr> 
					      <!--  <tr><td>Round Off (Decimal):</td></tr> -->
					     <tr><td><strong>Net Amount:</strong></td><td class="text-end" id="summary-final">0.00</td></tr>
					    </tbody>
					  </table>
					</div>
		          </div>
		
				  
				  
				  <!-- File Input for PDF Attachment -->
				  <div class="row mb-3">
				      <div class="col-md-6">
				          <label class="form-label">Attach PDF</label>
				          <input type="file" class="form-control" id="pi_attachment" name="pi_attachment" accept="application/pdf" onchange="showPreviewButton()">
				          <small class="form-text text-muted">Only PDF files are allowed.</small>
				      </div>
				  </div>

				  <!-- Preview Button (Initially Hidden) -->
				  <div id="pi_previewButtonDiv" style="display:none;">
				      <button type="button" class="btn btn-primary" id="previewButton" onclick="previewPDF()">Preview PDF</button>
				  </div>
				  
				  <!-- Terms and Conditions Section -->
				            <div class="col-md-12 mt-3">
				              <label class="form-label">Terms And Conditions</label>
				              <textarea class="form-control" id="pi_terms_and_conditionnew" rows="3"  style="font-size: 14px;">
				               	
				              </textarea>
				            </div>
		          <!-- Submit Button -->
		          <div class="text-end">
					 <div class="text-end mt-3">
					  <button type="submit" class="btn btn-outline-primary">submit</button>
					  <!-- <button type="button" class="btn btn-outline-success" onclick="viewPI()">View PI</button>  -->
					 </div>
		          </div>
		        </form>
		      </div>
		    </div>
		  </div>
		</div>
		
<!-- performa invoice modal -->
<div class="modal fade" id="performainvoiceModal" tabindex="-1" aria-labelledby="performaInvoiceModalLabel" aria-hidden="true" data-bs-backdrop="static">
	  <div class="modal-dialog modal-xl custom-modal-width">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="performaInvoiceModalLabel">Performa Invoice</h5>
	        <!--  <button type="button" class="btn btn-outline-success" onclick="viewPI()">View PI</button>  -->
	       <!--  <button type="button" class="btn btn-outline-success m-2" onclick="approvePI()" th:if="${loggedAdminDept == 84}">Approve PI</button>  -->
	        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
	      </div> 
	      <div class="modal-body" style="font-size:12px;">
	        <!-- Purchase Order Form -->
	        <form id="performainvoiceForm"  method="post" enctype="multipart/form-data" >
	            
				<div class="row mb-3 justify-content-between">
				
				  <div class="col-md-3">
				    <label class="form-label">Performa Invoice ID</label>
				    <input type="text" class="form-control" id="performa_id" placeholder="Performa Invoice ID" disabled />
				   </div>
				   <div  class="col-md-3">
				     <label class="form-label">Sales Order ID</label>
				     <input type="text" class="form-control" id="performa_po_id" placeholder="Performa Invoice ID" disabled />
				   </div>
				   <input type="hidden" class="form-control" id="performa_salesId">
				   <div class="col-md-3">
				    <label class="form-label">Date of Supply</label>
					<input type="date" class="form-control" id="performa_dateTime" required/>
				   </div>
				</div>
	 			
	          <!-- Row 1 -->
	          <div class="row mb-3">
	          
	            <div class="col-md-4">
	              <label class="form-label">PO Number</label>
	              <input type="text" class="form-control" id="performa_number" required readonly>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">PO Date</label>
	              <input type="date" class="form-control" id="performa_date" required readonly>
	            </div>
	             <div class="col-md-4">
	              <label class="form-label">PI No</label>
	              <input type="text" class="form-control" id="performa_no">
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">Vendor Code</label>
	              <input type="text" class="form-control" id="performa_vendor_code" required readonly>
	            </div>
	            <div class="col-md-4">
			      <label class="form-label">Mode of Payment</label>
			      <input type="text" class="form-control" id="performa_mode_of_payment" placeholder="Enter payment mode (e.g., NEFT, UPI)" required>
			    </div>
	            
	            <div class="col-md-4">
	              <label class="form-label">Place of supply</label>
	              <input type="text" class="form-control" id="performa_supply_place" required>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">vehicle No</label>
	              <input type="text" class="form-control" id="performa_vehicle_No">
	            </div>
	            
	            <div class="col-md-4">
				  <label class="form-label">State</label>
				  <select class="form-select" id="performa_state" onchange="setStateCodeInPerformaInvoiceModal()" required>
				    <option value="">Select State</option>
				    <option value="1">JAMMU AND KASHMIR</option>
				    <option value="2">HIMACHAL PRADESH</option>
				    <option value="3">PUNJAB</option>
				    <option value="4">CHANDIGARH</option>
				    <option value="5">UTTARAKHAND</option>
				    <option value="6">HARYANA</option>
				    <option value="7">DELHI</option>
				    <option value="8">RAJASTHAN</option>
				    <option value="9">UTTAR PRADESH</option>
				    <option value="10">BIHAR</option>
				    <option value="11">SIKKIM</option>
				    <option value="12">ARUNACHAL PRADESH</option>
				    <option value="13">NAGALAND</option>
				    <option value="14">MANIPUR</option>
				    <option value="15">MIZORAM</option>
				    <option value="16">TRIPURA</option>
				    <option value="17">MEGHALAYA</option>
				    <option value="18">ASSAM</option>
				    <option value="19">WEST BENGAL</option>
				    <option value="20">JHARKHAND</option>
				    <option value="21">ORISSA</option>
				    <option value="22">CHHATTISGARH</option>
				    <option value="23">MADHYA PRADESH</option>
				    <option value="24">GUJARAT</option>
				    <option value="25">DAMAN AND DIU</option>
				    <option value="26">DADAR AND NAGAR HAVELI</option>
				    <option value="27">MAHARASTRA</option>
				    <option value="29">KARNATAKA</option>
				    <option value="30">GOA</option>
				    <option value="31">LAKSHADWEEP</option>
				    <option value="32">KERALA</option>
				    <option value="33">TAMIL NADU</option>
				    <option value="34">PUDUCHERRY</option>
				    <option value="35">ANDAMAN AND NICOBAR</option>
				    <option value="36">TELANGANA</option>
				    <option value="37">ANDHRA PRADESH</option>
				    <option value="97">OTHER TERRITORY</option>
				    <option value="96">OTHER COUNTRY</option>
				  </select>
				</div>
				
				<div class="col-md-4">
				  <label class="form-label">State Code</label>
				  <input type="text" class="form-control" id="performa_state_code" readonly required>
				</div>
				
				<div class="col-md-4">
					<label class="form-label">Transportation Mode</label>
					<input type="text" class="form-control" id="performa_transportMode">
				</div>
	            <!-- <div class="col-md-4">
	              <label class="form-label">State Code</label>
	              <input type="text" class="form-control" id="pi_state_code" required>
	            </div> -->
	             
	          </div>
	          <hr>
	          <div class="row mb-3">
	          </div>
			    <div class="col-md-3">
				    <label class="form-label">Quotation ID</label> 			     
				    <input type="text" id="performa_quotationId" class="form-control" readonly>
				</div>
				<hr> 
				        <div class="row">      
	                    	<div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="performa_company_honorifics1" class="form-control" readonly>
	                        </div>              
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Name</label>
	                            <input type="text" id="performa_cust_name" class="form-control"  list="customerList" autocomplete="off" readonly required>
	                            <div id="pi_suggestionsBox1" class="suggestions"></div>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Legal Name</label>
	                            <input type="text" id="performa_cust_legan_name" class="form-control" readonly required>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">GST Number</label>
	                            <input type="text" id="performa_gstnumberr1" class="form-control" readonly required>
	                        </div> 
	                        <div class="col-md-2">
	                            <label class="form-label">Order Method</label>
	                             <input type="text" id="performa_orderMethod1" class="form-control" required>                           
	                        </div>	                        
	                        <div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="performa_contact_person_honorifics1" class="form-control" readonly>
	                        </div>
	                        
	                        <div class="col-md-3">
	                            <label class="form-label">Contact Person Name</label>
	                           	<!-- <select id="pi_personName1" class="form-control form-select" >
	       						 	<option value="">Select Contact Person</option>
	    						</select>  -->
	    						<input type="text" id="performa_personName1" class="form-control" readonly>
	                        </div> 	      
	                                          
	                        <div class="col-md-2">
	                            <label class="form-label">Designation</label>
	                            <input type="text" id="performa_designation1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Mobile Number</label>
	                            <input type="text" id="performa_contactDetails1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Email ID</label>
	                            <input type="email" id="performa_emailId1" class="form-control" readonly>
	                        </div>
	                   </div>   
			          <!-- Row 2 -->
			          <div class="row mb-3">
			            <div class="col-md-6">
			              <label class="form-label">Customer Billing Address</label>
			              <textarea class="form-control" id="performa_billing_address" rows="2" required readonly></textarea>
			            </div>
			            <div class="col-md-6 mt-2"> 
	                            <label class="form-label">Delivery Address</label>
	                            
	    						<textarea class="form-control" id="performa_shipping_address" rows="2" required readonly></textarea>
	                    </div>
			          </div>
				
					 <hr>
	            <!-- Row 3 -->
	 			<h5>Tax Type</h5>
	                    
	                     <hr>
	                    <div class="d-flex align-items-center mb-3">
	                        <input type="checkbox" id="performa_interState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('interState')"> 
	                        <label class="form-check-label me-3" style="font-size: 12px;">Intrastate(CGST 9% + SGST 9%)</label>

	                        <input type="checkbox" id="performa_outerState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('outerState')"> 
	                        <label class="form-check-label me-3" style="font-size: 12px;">Interstate(IGST 18%)</label>
	                    </div>        

		          <!-- Table for Items -->
		          <div class="table-responsive mb-3">
		            <table class="table table-bordered" id="performa_items_table" style="font-size:12px;">
		              <thead class="table-light">
		                <tr>
		                  <th>Sl No</th>		                  
						  <th>Part No</th>
						  <th>HSN Code</th>
		                  <th>Description</th>
		                  <th>Quantity</th>
		                  <th>Dispatched Quantity</th>
		                  <th>Price</th>
		                  <th>Taxable Value</th>
		                  <th class="cgst-saleheader">CGST (9%)</th>
						  <th class="sgst-saleheader">SGST (9%)</th>
						  <th class="igst-saleheader">IGST (18%)</th>
		                  <th>Total</th>
		                  <th>Action</th>
						  <th class="action-col" style="display: none;">Action</th> <!-- initially hidden -->
		                </tr>
		              </thead>
		              <tbody>
		                <tr>
		                  <td><input type="number" class="form-control" name="slno[]" value="1" readonly></td>
		          
						  <td><input type="text" class="form-control" name="part_no[]"></td>
						  <td><input type="text" class="form-control" name="hsn_code[]"></td>
		                  <td><input type="text" class="form-control" name="description[]"></td>
		                  <td><input type="number" class="form-control" name="quantity[]" min="1" oninput="validateAndCalculate(this)"></td>
		                  <td><input type="number" class="form-control" name="price[]" min="0" step="0.01" oninput="calculateTotal(this)"></td>
		                  <td><input type="number" class="form-control performa-saletotal-without-gst" name="line_total[]" readonly></td>
		                  <td class="cgst-value">
				             <input type="number" class="form-control performa-salecgst" name="cgst[]" value="${product.cgst}" readonly/>
				          </td>
				          <td class="sgst-value">
				              <input type="number" class="form-control performa-salesgst" name="sgst[]"  value="${product.sgst}" readonly/>
				          </td>
				          <td class="igst-value">
				             <input type="number" class="form-control performa-saleigst" name="igst[]"  value="${product.igst}" readonly />
				          </td>		                  
		                  <td><input type="number" class="form-control saletotal-with-gst" name="total_line_total[]" readonly></td>
						  <td class="action-col" style="display: none;">
						     <button type="button" class="btn btn-danger removeRowBtn" onclick="removeRow(this)">Remove</button>
						  </td>
						  <td><input type="text" class="form-control" name="product_id[]"></td>
					  </tr>
		              </tbody>
		            </table>
		            <!--  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItemRow()">Add Item</button> -->
		            <div class="d-flex justify-content-end mt-3" id="summary-section">
					  <table class="table table-sm table-bordered" style="width: 400px; font-size: 12px;">
					    <tbody>
					      <tr><td>Total Amount:</td><td class="text-end" id="performa_summary-total">0.00</td></tr>
					      <tr><td>CGST(9%):</td><td class="text-end" id="performa_summary-cgst">0.00</td></tr>
					      <tr><td>SGST(9%):</td><td class="text-end" id="performa_summary-sgst">0.00</td></tr>
					      <tr><td>IGST(18%):</td><td class="text-end" id="performa_summary-igst">0.00</td></tr>
					      <tr>
							  <td>Tax Amount (GST):</td>
							  <td class="text-end" id="performa_summary-gst-tax">0.00</td>
						  </tr>
						   <tr>
							  <td>Total Amount after GST and before TCS:</td>
							  <td class="text-end" id="performa_total-amount-after-GST-before-TCS">0.00</td>
						  </tr>
							<tr>
							  <td>
							    TCS (0.1%):
							    <select id="performa_apply-tcs" class="form-select form-select-sm d-inline w-auto ms-2">
							      <option value="no">Not Apply</option>
							      <option value="yes">Apply</option>
							    </select>
							  </td>
							  <td class="text-end" id="performa_summary-tcs">0.00</td>
							</tr>

					      <tr><td>Total Tax:</td><td class="text-end" id="performa_summary-tax">0.00</td></tr>
					      <tr><td>Total Amount after Tax:</td><td class="text-end" id="performa_summary-with-tax">0.00</td></tr>
					      <tr><td>GST Payable on Reverse Charges: </td><td class="text-end"><input type="number" id="performa_gst-reverse-charge" placeholder="0.00" step="any"></td></tr>
					      <tr><td>Total Amount after Reverse Charges:</td><td class="text-end" id="performa_total-amount-after-revese-charge">0.00</td></tr>
					      <tr>
							  <td>
							    Round Off (Decimal): 
							    <select id="performa_round-type" class="form-select form-select-sm d-inline w-auto ms-2">
								  <option value="even">even</option>
								  <option value="odd">odd</option>
								</select>
							  </td>
							  
							  <td class="text-end" id="performa_summary-roundoff">0.00</td>
							  
						  </tr> 
					      <!--  <tr><td>Round Off (Decimal):</td></tr> -->
					     <tr><td><strong>Net Amount:</strong></td><td class="text-end" id="performa_summary-final">0.00</td></tr>
					    </tbody>
					  </table>
					</div>
		          </div>
		
				  
				  
				  <!-- File Input for PDF Attachment -->
				  <div class="row mb-3">
				      <div class="col-md-6">
				          <label class="form-label">Attach PDF</label>
				          <input type="file" class="form-control" id="performa_attachment" name="performa_attachment" accept="application/pdf" onchange="showPreviewButton()">
				          <small class="form-text text-muted">Only PDF files are allowed.</small>
				      </div>
				  </div>

				  <!-- Preview Button (Initially Hidden) -->
				  <div id="performa_previewButtonDiv" style="display:none;">
				      <button type="button" class="btn btn-primary" id="performa_previewButton" onclick="previewPDF()">Preview PDF</button>
				  </div>
				  
				  <!-- Terms and Conditions Section -->
				            <div class="col-md-12 mt-3">
				              <label class="form-label">Terms And Conditions</label>
				              <textarea class="form-control" id="performa_terms_and_conditionnew" rows="3"  style="font-size: 14px;">
				               	
				              </textarea>
				            </div>
		          <!-- Submit Button -->
		          <div class="text-end">
					 <div class="text-end mt-3">
					  <button type="submit" class="btn btn-outline-primary">submit</button>
					  <!-- <button type="button" class="btn btn-outline-success" onclick="viewPI()">View PI</button>  -->
					 </div>
		          </div>
		        </form>
		      </div>
		    </div>
		  </div>
		</div>
 
<!-- modal fo rDC -->

		<div class="modal fade" id="dcModal" tabindex="-1" aria-labelledby="dcModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-lg">
	    <div class="modal-content shadow-lg border-0 rounded-4">
	      <div class="modal-header bg-primary text-white rounded-top-4">
	        <h5 class="modal-title" id="dcModalLabel">Delivery Challan</h5>
	        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>

	      <div class="modal-body px-4 py-3">
			
			<input type="hidden" id="dcPurchaseOrderId" name="purchaseOrderId">
			<input type="hidden" id="dcQuotationId" name="quotationId">

	        <!-- Supplier Address -->
	        <div class="mb-4">
	          <label class="form-label fw-bold">Supplier Address:</label>
	          <div class="bg-light p-3 rounded border">
	           <strong> Melange Systems Pvt Ltd.</strong><br>
	            4/1, 7th Cross Railway Parallel Road<br>
	            Kumara Park West<br>
	            Bangalore - 560020
	          </div>
	        </div>

	        <div class="row g-3">
				<!-- Buyer (Bill to) with Address Textarea, full width -->
				 <div class="col-12">
				   <label for="buyer" class="form-label">Buyer (Bill to)</label>
				   <div id="buyer" class="form-control bg-white" contenteditable="false" style="min-height: 100px;"></div>

				 </div>
				 <!-- Delivery Address, full width -->
				     <div class="col-12">
				         <label for="deliveryAddressdcc" class="form-label">Delivery Address</label>
				         <div id="deliveryAddressdcc" class="form-control bg-white" contenteditable="false" style="min-height: 100px;"></div>
				     </div>
					 
				 <!-- Delivery Note No. -->
				 <div class="col-md-6">
				   <label for="deliveryNoteNo" class="form-label">Delivery Note No.</label>
				   <input type="text" class="form-control" id="deliveryNoteNo" readonly>
				 </div>

				 <!-- Dated -->
				 <div class="col-md-6">
				   <label for="dated" class="form-label">Dated</label>
				   <input type="date" class="form-control" id="dated">
				 </div>
	          <!-- Reference No. & Date -->
	          <div class="col-md-6">
	            <label for="referenceNoDate" class="form-label">PO No. & Date</label>
	            <input type="text" class="form-control" id="referenceNoDate">
	          </div>

	          <!-- Other References -->
	          <div class="col-md-6">
	            <label for="otherReferences" class="form-label">Other References</label>
	            <input type="text" class="form-control" id="otherReferences">
	          </div>

	          


	          <!-- Terms of Delivery -->
	          <div class="col-md-6">
	            <label for="termsOfDelivery" class="form-label">Terms of Delivery</label>
	            <input type="text" class="form-control" id="termsOfDelivery">
	          </div>
			  <!-- Buyer's Order No. -->
			  <div class="col-md-6">
			    <label for="buyersOrderNo" class="form-label">Buyer’s Order No.</label>
			    <input type="text" class="form-control" id="buyersOrderNo">
			  </div>

			

			  <!-- Mode/Terms of Payment -->
			  <div class="col-md-6">
			    <label for="paymentTerms" class="form-label">Mode/Terms of Payment</label>
			    <input type="text" class="form-control" id="paymentTerms">
			  </div>
			  <!-- Dated (for Buyer's Order No.) -->
			  		  <div class="col-md-6">
			  		    <label for="buyersOrderDate" class="form-label">Dated</label>
			  		    <input type="date" class="form-control" id="buyersOrderDate">
			  		  </div>
	        
	        </div>

	        <!-- Table for Goods -->
	        <div class="mt-4">
	          <table class="table table-bordered">
	            <thead class="table-light">
	              <tr>
	                <th>Sl</th>
	                <th>Description of Goods</th>
	                <th>HSN/SAC</th>
	                <th>Quantity</th>
	                <th>Rate</th>
	                <th>Per</th>
	                <th>Amount</th>
	              </tr>
	            </thead>
	            <tbody id="goodsTableBody">
	              <!-- Dynamically added rows will go here -->
	              <tr>
	                <td>1</td>
	                <td><input type="text" class="form-control"  placeholder="Enter description"></td>
	                <td><input type="text" class="form-control"  placeholder="Enter HSN/SAC"></td>
	                <td><input type="number" class="form-control"  placeholder="Enter quantity"></td>
	                <td><input type="number" class="form-control"  placeholder="Enter rate"></td>
	                <td><input type="text" class="form-control"  placeholder="Enter unit"></td>
	                <td><input type="number" class="form-control"  placeholder="Enter amount" readonly></td>
	              </tr>
	            </tbody>
	          </table>
			  <!-- Tax Summary Display -->
			 
			   <div id="taxSummaryDiv" class="mt-3"></div>
			   <!-- Rounding Options -->
			   <div>
			       <label>
			           <input type="radio" name="roundingOption" value="odd"> Round to Odd
			       </label>
			       <label>
			           <input type="radio" name="roundingOption" value="even"> Round to Even
			       </label>
			   </div>



			   <div id="amountInWordsDiv" class="mt-3 fw-bold text-start"></div>

			   <h6 class="fw-bold mt-4">Tax Summary</h6>
			   <table class="table table-bordered">
			     <thead class="table-light" id="taxTableHeader">
			       <tr>
			         <th rowspan="2">HSN/SAC</th>
			         <th rowspan="2">Taxable Value</th>
			         <th colspan="2" class="text-center  cgst-header">CGST</th>
			         <th colspan="2" class="text-center sgst-header">SGST</th>
			         <th colspan="2" class="text-center igst-header">IGST</th>
			         <th rowspan="2">Total Tax Amount</th>
			       </tr>
			       <tr>
			         <th  class="cgst-header">Rate (%)</th>
			         <th  class="cgst-header">Amount</th>
			         <th class="sgst-header">Rate (%)</th>
			         <th class="sgst-header">Amount</th>
			         <th class="igst-header">Rate (%)</th>
			         <th class="igst-header">Amount</th>
			       </tr>
			     </thead>
			     <tbody id="taxBreakdownBody">
			       <!-- JS will insert rows here -->
			     </tbody>
			   </table>
			   <div id="taxAmountInWordsDiv" class="fw-bold text-start mt-3"></div>
			   <div class="row mt-4">
			     <div class="col-md-8">
			       <label for="remarks" class="form-label fw-bold">Remarks</label>
			       <textarea id="remarks" class="form-control" rows="2" placeholder="Enter any remarks here"></textarea>
			     </div>
			     <div class="col-md-4">
			       <label for="companyPan" class="form-label fw-bold">Company PAN</label>
			       <input type="text" id="companyPan" class="form-control" placeholder="Enter Company PAN">
			     </div>
			   </div>

	        </div>
	      </div>

	      <div class="modal-footer bg-light border-top-0 rounded-bottom-4">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	        <button type="button" class="btn btn-success" id="saveDCBtn" >Save DC</button>
	      </div>
	    </div>
	  </div>
	</div>
		
		
    <script>
	document.querySelector('[data-bs-target="#dcModal"]').addEventListener('click', function () {
	    // Get values from main form
	    const poid = document.getElementById('poid').value;
	    const quotationId = document.getElementById('quotationId').value;

	    // Set values inside modal
	    document.getElementById('dcPurchaseOrderId').value = poid;
	    document.getElementById('dcQuotationId').value = quotationId;
	});
	</script>
	
	<script>
	  $(document).ready(function() {
	    $('#saveDCBtn').click(function() {
	      saveDeliveryChallan();
	    });
	  });
	</script>
	
	<script>
		
		document.getElementById('dcModal').addEventListener('show.bs.modal', function () {
		  fetch('/dc/next-number')
		    .then(response => response.json())
		    .then(data => {
		      document.getElementById('deliveryNoteNo').value = data;
		    })
		    .catch(error => {
		      console.error('Error fetching DC Number:', error);
		    });
		});
		
		function numberToWordsIndianWithPaise(amount) {
		    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven',
		        'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen',
		        'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
		    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

		    function getWords(num) {
		        if ((num = num.toString()).length > 9) return 'Overflow';
		        let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
		        if (!n) return '';

		        let str = '';
		        str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + ' Crore ' : '';
		        str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + ' Lakh ' : '';
		        str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + ' Thousand ' : '';
		        str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + ' Hundred ' : '';
		        str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + ' ' : '';
		        return str.trim();
		    }

		    let rupees = Math.floor(amount);
		    let paise = Math.round((amount - rupees) * 100);

		    let rupeeWords = getWords(rupees);
		    let paiseWords = paise > 0 ? getWords(paise) : '';

		    let final = '';
		    if (rupeeWords) final += rupeeWords + ' Rupees';
		    if (rupeeWords && paiseWords) final += ' and ';
		    if (paiseWords) final += paiseWords + ' Paise';

		    return final.trim() + ' Only';
		}

		document.addEventListener('DOMContentLoaded', function () {
		// Add an event listener to the View buttons
		document.querySelectorAll('.btn-outline-info').forEach(button => {
		    button.addEventListener('click', function(event) {
		    	
		        event.preventDefault(); // Prevent the default action
		        const purchaseId = this.getAttribute('href').split('/').pop(); // Extract purchaseId from the href

		        // Fetch the data based on the purchaseId
		        fetch(`/getPurchaseOrderDetailsnew/${purchaseId}`)  // Assuming you have this endpoint in your controller
		            .then(response => response.json())
		            .then(data => {
						const goodsTableBody = document.querySelector('#goodsTableBody');
						               const taxSummaryDiv = document.querySelector('#taxSummaryDiv');
						               const amountInWordsDiv = document.querySelector('#amountInWordsDiv');

						               goodsTableBody.innerHTML = '';
						               taxSummaryDiv.innerHTML = '';
						               amountInWordsDiv.innerHTML = '';

									   const taxBreakdownBody = document.getElementById('taxBreakdownBody');
									   const taxTableHeader = document.getElementById('taxTableHeader');
									   const taxSummarySection = document.getElementById('taxSummarySection');

									   let hasCGSTorSGST = false;
									   let hasIGST = false;
									   let grandTotal = 0;
									   let totalTaxAmountSum = 0;
									   
									   taxBreakdownBody.innerHTML = '';
									   console.log('Initial hasCGSTorSGST:', hasCGSTorSGST);
									   console.log('Initial hasIGST:', hasIGST);
		                // Assuming data contains an array of items in the 'items' property
		             //   const goodsTableBody = document.querySelector('#goodsTableBody');
		             //   goodsTableBody.innerHTML = ''; // Clear existing rows

		                data.items.forEach((item, index) => {
							const row = document.createElement('tr');
							const taxTotal = item.igst === 0 ? (item.cgst + item.sgst) : item.igst;
							const taxLabel = item.igst === 0 ? "CGST + SGST" : "IGST";
							const totalWithTax = item.lineTotal + taxTotal;


							row.innerHTML = `
							    <td>${index + 1}</td>
							    <td><input type="text" class="form-control"  name="description" value="${item.description}" placeholder="Enter description"></td>
							    <td><input type="text" class="form-control" name="hsnSac" value="${item.hsnCode}" placeholder="Enter HSN/SAC"></td>
							    <td><input type="number" class="form-control" name="quantity" value="${item.quantity}" placeholder="Enter quantity"></td>
							    <td><input type="number" class="form-control" name="rate" value="${item.price}" placeholder="Enter rate"></td>
							    <td><input type="text" class="form-control" name="perUnit" value="${item.unit}" placeholder="Enter unit"></td>
							    <td><input type="number" class="form-control" name="amount" value="${item.lineTotal}" readonly></td>
							`;

							goodsTableBody.appendChild(row);

							// Now add the tax total row below it
							const taxRow = document.createElement('tr');
							taxRow.innerHTML = `
							    <td></td>
							    <td colspan="5" class="text-start fw-bold">${taxLabel} :</td>
							    <td><input type="number" class="form-control" value="${taxTotal}" readonly></td>
							`;
							goodsTableBody.appendChild(taxRow);
							// Total with tax row
							                  const totalRow = document.createElement('tr');
							                  totalRow.innerHTML = `
							                      <td></td>
							                      <td colspan="5" class="text-start fw-bold">Total :</td>
							                      <td><input type="number" class="form-control" name="totalWithTax" value="${totalWithTax.toFixed(2)}" readonly></td>
							                  `;
							                  goodsTableBody.appendChild(totalRow);
											  // Accumulate grand total
											                    grandTotal += totalWithTax;
							// Also add to tax summary div
							//const taxEntry = document.createElement('p');
							//taxEntry.textContent = `Item ${index + 1}: ${taxLabel} = ${taxTotal}`;
							//document.querySelector('#taxSummaryDiv').appendChild(taxEntry);
							
		                });
						// Display grand total below
						               taxSummaryDiv.innerHTML = `Total with Tax: ₹ ${grandTotal.toFixed(2)}`;
									   // Call this function after setting the grand total
									   // Call the rounding function with the calculated grand total
									   roundGrandTotal(grandTotal);
									   // Call this function after calculating the grand total
									   // Call this function after calculating the grand total
									   // Function to round the grand total
									   function roundGrandTotal(grandTotal) {
									       const taxSummaryDiv = document.getElementById("taxSummaryDiv");
									       const amountInWordsDiv = document.getElementById("amountInWordsDiv");
									       
									       // Get the rounding preference
									       const roundingPreference = document.querySelector('input[name="roundingOption"]:checked')?.value || 'none';

									       // Apply the rounding logic
									       if (roundingPreference === 'odd') {
									           grandTotal = Math.floor(grandTotal) % 2 === 0 ? Math.floor(grandTotal) - 1 : Math.floor(grandTotal);
									       } else if (roundingPreference === 'even') {
									           grandTotal = Math.ceil(grandTotal) % 2 === 0 ? Math.ceil(grandTotal) : Math.ceil(grandTotal) + 1;
									       }

									       // Update the UI
									       taxSummaryDiv.innerHTML = `Total with Tax: ₹ ${grandTotal.toFixed(2)}`;
									       
									       // Convert to words (replace with your actual conversion function)
									       amountInWordsDiv.innerHTML = `Amount Chargeable (in words): INR ${numberToWordsIndianWithPaise(grandTotal)}`;
									   }

									   // Sample function to convert numbers to words
									   function convertToWords(amount) {
									       return amount.toFixed(2);  // Replace with a proper conversion function
									   }

									   // Attach event listeners to radio buttons
									   document.querySelectorAll('input[name="roundingOption"]').forEach((radio) => {
									       radio.addEventListener('change', () => {
									           // Extract the current grand total from the tax summary div
									           const taxSummaryDiv = document.getElementById("taxSummaryDiv");
									           const match = taxSummaryDiv.textContent.match(/₹\s*([\d.,]+)/);
									           
									           if (match) {
									               const grandTotal = parseFloat(match[1].replace(/,/g, ''));
									               roundGrandTotal(grandTotal);
									           }
									       });
									   });

						               // Display amount in words
									   const inWords = numberToWordsIndianWithPaise(grandTotal);

						               amountInWordsDiv.innerHTML = `Amount Chargeable (in words): INR ${inWords}`;
									   
									   data.items.forEach(item => {
									     const hsn = item.hsnCode || '';
									     const taxableValue = item.lineTotal || 0;
									    // const cgstRate = item.cgstRate || 0;
										const cgstRate = item.cgstRate || (item.cgst > 0 ? 9 : 0);
									     const cgstAmount = item.cgst || 0;
									   //  const sgstRate = item.sgstRate || 0;
									   const sgstRate = item.sgstRate || (item.sgst > 0 ? 9 : 0);
									     const sgstAmount = item.sgst || 0;
									     //const igstRate = item.igstRate || 0;
										 const igstRate = item.igstRate || (item.igst > 0 ? 18 : 0);
									     const igstAmount = item.igst || 0;
									     const totalTaxAmount = cgstAmount + sgstAmount + igstAmount;

										 totalTaxAmountSum += totalTaxAmount;
										 
										 const taxAmountWords = numberToWordsIndianWithPaise(totalTaxAmountSum);
										 								    
										 								   document.getElementById('taxAmountInWordsDiv').innerHTML = `Tax Amount (in words): INR ${taxAmountWords}`;

										 // ✅ Set the flags correctly
										 if (cgstAmount > 0 || sgstAmount > 0) {
										   hasCGSTorSGST = true;
										 }
										 if (igstAmount > 0) {
										   hasIGST = true;
										 }
										 					   
										 const taxRow = document.createElement('tr');
										   let taxColumns = `
										     <td>${hsn}</td>
										     <td>${taxableValue.toFixed(2)}</td>
										   `;

										   if (cgstAmount > 0 || sgstAmount > 0) {
										     taxColumns += `
											 <td><input type="number" name="cgstRate" value="${cgstRate}" class="form-control" /></td>
											       <td><input type="number" name="cgstAmount" value="${cgstAmount.toFixed(2)}" class="form-control" /></td>
											       <td><input type="number" name="sgstRate" value="${sgstRate}" class="form-control" /></td>
											       <td><input type="number" name="sgstAmount" value="${sgstAmount.toFixed(2)}" class="form-control" /></td>
										     `;
										   }

										   if (igstAmount > 0) {
										     taxColumns += `
											 <td><input type="number" name="igstRate" value="${igstRate}" class="form-control" /></td>
											     <td><input type="number" name="igstAmount" value="${igstAmount.toFixed(2)}" class="form-control" /></td>
											   
										     `;
										   }

										   taxColumns += `<td>${totalTaxAmount.toFixed(2)}</td>`;
										   taxRow.innerHTML = taxColumns;
										   taxBreakdownBody.appendChild(taxRow);
										 });

									   // Update headers visibility
									   if (!hasCGSTorSGST) {
										 
									     taxTableHeader.querySelectorAll('.cgst-header, .sgst-header').forEach(el => el.style.display = 'none');
									   }
									   if (!hasIGST) {
										 
									     taxTableHeader.querySelectorAll('.igst-header').forEach(el => el.style.display = 'none');
									   }

									   // Show entire tax summary section only if needed
									   if (hasCGSTorSGST || hasIGST) {
									     taxSummarySection.style.display = 'block';
									   } else {
									     taxSummarySection.style.display = 'none';
									   }

									 
		                // Optionally, you can calculate and update any other fields if needed
		            })
		            .catch(error => {
		                console.error('Error fetching purchase order details:', error);
		            });
		    });
		});
		});
		
		function saveDeliveryChallan() {
		    const goodsDetails = [];

		    // Step 1: Collect goods data from #goodsTableBody
		    $('#goodsTableBody tr').each(function () {
		        const row = $(this);

		        const description = row.find('input[name="description"]').val()?.trim();
		        const hsnSac = row.find('input[name="hsnSac"]').val()?.trim();
		        const quantity = row.find('input[name="quantity"]').val();
		        const rate = row.find('input[name="rate"]').val();
		        const perUnit = row.find('input[name="perUnit"]').val()?.trim();
		        const amount = row.find('input[name="amount"]').val();
				//const totalWithTax = row.find('input[name="totalWithTax"]').val();
				const totalWithTax = row.nextUntil('tr:has(input[name="description"])').find('input[name="totalWithTax"]').val();

		        // Skip if essential fields are missing
		        if (!description || !hsnSac || !quantity || !rate) return;

		        // Basic goods details (tax will be joined later)
		        goodsDetails.push({
		            description,
		            hsnSac,
		            quantity,
		            rate,
		            perUnit,
		            amount,
					totalWithTax
		        });
		    });

		    // Step 2: Collect tax data from #taxBreakdownBody
		    const taxDetailsMap = {}; // key: hsnSac, value: tax detail
		    $('#taxBreakdownBody tr').each(function () {
		        const row = $(this);
		        const hsn = row.find('td').eq(0).text()?.trim();
		        const taxableValue = row.find('td').eq(1).text()?.trim();

		        const cgstRate = row.find('input[name="cgstRate"]').val();
		        const cgstAmount = row.find('input[name="cgstAmount"]').val();
		        const sgstRate = row.find('input[name="sgstRate"]').val();
		        const sgstAmount = row.find('input[name="sgstAmount"]').val();
		        const igstRate = row.find('input[name="igstRate"]').val();
		        const igstAmount = row.find('input[name="igstAmount"]').val();
		        const totalTaxAmount = row.find('td').last().text()?.trim();

		        if (hsn) {
		            taxDetailsMap[hsn] = {
		                taxableValue,
		                cgstRate,
		                cgstAmount,
		                sgstRate,
		                sgstAmount,
		                igstRate,
		                igstAmount,
		                totalTaxAmount
		            };
		        }
		    });

		    // Step 3: Merge tax info into goodsDetails based on hsnSac
		    goodsDetails.forEach(item => {
		        const tax = taxDetailsMap[item.hsnSac];
		        if (tax) {
		            item.cgstRate = tax.cgstRate;
		            item.cgstAmount = tax.cgstAmount;
		            item.sgstRate = tax.sgstRate;
		            item.sgstAmount = tax.sgstAmount;
		            item.igstRate = tax.igstRate;
		            item.igstAmount = tax.igstAmount;
		            item.totalTaxAmount = tax.totalTaxAmount;
		        }
		    });
			// Extract the grand total from the tax summary div
			   const taxSummaryText = document.getElementById('taxSummaryDiv').textContent;
			   const grandTotalMatch = taxSummaryText.match(/₹\s*([\d.,]+)/);
			   const roundedGrandTotal = grandTotalMatch ? parseFloat(grandTotalMatch[1].replace(/,/g, '')) : 0;

			// Step 4: Create payload and send AJAX
			const fullBuyerText = $('#buyer').text().trim();
			const buyerLines = fullBuyerText.split('\n');
			const billingCompanyName = buyerLines[0].trim();  // Extract the first line as company name
			const billingAddress = buyerLines.slice(1).join('\n').trim();  // Remaining lines as address
			// Extract the delivery address
			const deliveryAddress = $('#deliveryAddressdcc').text().trim();
			// Show the extracted values
			alert("Billing Company Name: " + deliveryAddress + "\n\nBilling Address:\n" + billingAddress);
		    // Step 4: Create payload and send AJAX
		    const deliveryChallanData = {
				purchaseOrderId: document.getElementById('dcPurchaseOrderId').value,  // Add purchaseOrderId
				quotationId: document.getElementById('dcQuotationId').value,
		        supplierAddress: 'Melange Systems Pvt Ltd.',
		        buyer: $('#buyer').text(),
				
				billingCompanyName: billingCompanyName,
		        deliveryNoteNo: $('#deliveryNoteNo').val(),
		        dated: $('#dated').val(),
		        referenceNoDate: $('#referenceNoDate').val(),
		        referenceNo: $('#referenceNo').val(),
		        otherReferences: $('#otherReferences').val(),
		        termsOfDelivery: $('#termsOfDelivery').val(),
		        paymentTerms: $('#paymentTerms').val(),
		        buyersOrderNo: $('#buyersOrderNo').val(),
		        buyersOrderDate: $('#buyersOrderDate').val(),
		        remarks: $('#remarks').val(),
		        companyPan: $('#companyPan').val(),
		        goodsDetails,
				roundedGrandTotal,
				deliveryAddress: deliveryAddress 
		    };

		    console.log("Final Delivery Challan Payload:", deliveryChallanData);

		    // AJAX request to save
		    $.ajax({
		        url: '/delivery-challan/save',
		        type: 'POST',
		        contentType: 'application/json',
		        data: JSON.stringify(deliveryChallanData),
		        success: function (response) {
		            alert('Delivery Challan saved successfully');
					$('#dcModal').modal('hide'); 
		        },
		        error: function (error) {
		            alert('Error saving Delivery Challan');
		            console.error(error);
		        }
		    });
		}
 </script>
 
 
 
 <script>
	document.addEventListener('DOMContentLoaded', function() {
	    const dateCells = document.querySelectorAll('#purchaseOrderTableBody td:nth-child(5)'); 

	    dateCells.forEach(function(cell) {
	        const originalDateTime = cell.textContent.trim();

	        if (originalDateTime) {
	            const date = new Date(originalDateTime);

	            if (!isNaN(date.getTime())) { // Valid date
	                const day = String(date.getDate()).padStart(2, '0');
	                const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
	                const year = date.getFullYear();

	                const hours = String(date.getHours()).padStart(2, '0');
	                const minutes = String(date.getMinutes()).padStart(2, '0');
	                const seconds = String(date.getSeconds()).padStart(2, '0');

	                // Final format: dd-MM-yyyy HH:mm:ss
	                cell.textContent = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
	            }
	        }
	    });
	});
	/*window.onload = function() {
	    const rows = document.querySelectorAll('#purchaseOrderTableBody tr');
	    
	    rows.forEach(row => {
	        const poDateCell = row.cells[4];  // The 4th cell, assuming it's the 'PO Date' column
	        
	        if (poDateCell) {
	            const poDate = poDateCell.innerText.trim();
	            if (poDate) {
	                const formattedDate = formatDate(poDate);
	                poDateCell.innerText = formattedDate;
	            }
	        }
	    });
	};

	function formatDate(dateStr) {
	    const [year, month, day] = dateStr.split('-');
	    return `${day}-${month}-${year}`;
	}*/
	
	</script>
		<div class="table-responsive mt-3">
		    <table class="table table-bordered" style="font-size: 12px;">
		        <thead class="table bg-secondary">
		            <tr>
		            	<th>Sl No</th>
		                <th>Sales ID</th>
		                <th>Created By</th>
		                <th>SO Number</th>
		                <th>SO Date</th>
		                <th>Created Date and Time</th>
		                <th>Customer Legal Name</th>
		                <th>View</th> <!-- 👁️ View Column -->	                
		            </tr>
		        </thead>
		        <tbody id="purchaseOrderTableBody">
		            <tr th:each="order, orderStat : ${orders}">
		            	<td th:text="${orderStat.index+1}"></td>
		                <td th:text="${order.purchaseId}"></td>
		                <td th:text="${order.createdByEmpId}"></td>
		                <td th:text="${order.poNumber}"></td>
		                <td th:text="${order.poDate}"></td>
						<td class="createdDateTime" th:text="${order.createdDateTime}">2025-06-24T06:04:24.946Z</td>
		                <td th:text="${order.cus_leagal_name}"></td>
						<td><a th:href="@{'/viewPurchaseOrder/' + ${order.Id}}" class="btn btn-outline-info btn-sm dcbutton" title="View">
						        <i class="fas fa-eye"></i>
						    </a>
						</td>
		            </tr> 
		        </tbody>
		    </table>
		</div>
	
		<script>
		document.addEventListener("DOMContentLoaded", function () {
		  // Format all createdDateTime cells
		  document.querySelectorAll(".createdDateTime").forEach(td => {
		    let raw = td.textContent.trim();

		    if (raw) {
		      let date = new Date(raw);
		      if (!isNaN(date)) {
		        let day = String(date.getDate()).padStart(2, "0");
		        let month = String(date.getMonth() + 1).padStart(2, "0");
		        let year = date.getFullYear();

		        let hours = String(date.getHours()).padStart(2, "0");
		        let minutes = String(date.getMinutes()).padStart(2, "0");
		        let seconds = String(date.getSeconds()).padStart(2, "0");

		        td.textContent = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
		        td.setAttribute("data-raw", date.toISOString()); // keep raw date for sorting
		      }
		    }
		  });

		  // Now sort rows by createdDateTime (newest first)
		  let tbody = document.getElementById("purchaseOrderTableBody");
		  let rows = Array.from(tbody.querySelectorAll("tr"));

		  rows.sort((a, b) => {
		    let dateA = new Date(a.querySelector(".createdDateTime").getAttribute("data-raw"));
		    let dateB = new Date(b.querySelector(".createdDateTime").getAttribute("data-raw"));
		    return dateB - dateA; // newest first
		  });

		  // ✅ Re-append sorted rows and fix Sl No
		  rows.forEach((row, index) => {
		    row.cells[0].innerText = index + 1; // renumber SL No column
		    tbody.appendChild(row);
		  });
		});
		</script>
						
<script>
	
	
	// Add an event listener to the View buttons
	  document.querySelectorAll('.btn-outline-info').forEach(button => {
	      button.addEventListener('click', function(event) {
	          event.preventDefault(); // Prevent the default action
	          const purchaseId = this.getAttribute('href').split('/').pop(); // Extract purchaseId from the href
	          
	          // Fetch the data based on the purchaseId
	          fetch(`/getPurchaseOrderDetails/${purchaseId}`)  // Assuming you have this endpoint in your controller
	              .then(response => response.json())
	              .then(data => {
	            	  
	            	  document.getElementById('orderDetailsId').value = purchaseId;
	                  // Populate modal fields with the fetched data
	                  document.getElementById('poid').value = data.purchaseId;
	                  document.getElementById('podateTime').value = data.createdDateTime;
	                  document.getElementById('po_number').value = data.poNumber;
	                  document.getElementById('po_date').value = data.poDate;
	                  
	                  // ✅ Set po_date to the Dated field in the DC modal
				      document.getElementById('dated').value = data.poDate;//for dc date 
					  document.getElementById('referenceNoDate').value = data.poNumber + ' dt. ' + data.poDate;
	                   
	                  document.getElementById('vendor_code').value = data.vendorCode;
	                  document.getElementById('quotationId').value = data.quotationId;
	                  document.getElementById('company_honorifics1').value = data.cust_honorifics;
	                  document.getElementById('vendorName1').value = data.cust_name;
	                  document.getElementById('vendorlegalNamee1').value = data.cus_leagal_name;
	                  document.getElementById('gstnumberr1').value = data.gst_no;
	                  document.getElementById('orderMethod1').value = data.order_mehtod;
	                  document.getElementById('contact_person_honorifics1').value = data.contact_honorifics;
	                  document.getElementById('designation1').value = data.designation;
	                  document.getElementById('contactDetails1').value = data.mobile_no;
	                  document.getElementById('emailId1').value = data.email;
	                  document.getElementById('billing_address').value = data.billingAddress;
	                  
	                  document.getElementById('buyer').innerHTML = 
						    `<strong>${data.cus_leagal_name}</strong><br>${data.billingAddress}<br>GSTIN/UIN: ${data.gst_no}`;
						    
	                  document.getElementById('shipping_address').value = data.shippingAddress;
	                  document.getElementById('deliveryAddressdcc').innerHTML = data.shippingAddress;
					  document.getElementById('terms_and_conditionnew').value = data.termsAndConditions;
					  /* document.getElementById('personName1').value = data.cont_person_name; */
					  
					  const select = document.getElementById('personName1');
						const valueToSet = data.cont_person_name;
						
						let optionExists = Array.from(select.options).some(opt => opt.value === valueToSet);
						
						if (!optionExists && valueToSet) {
						    const newOption = new Option(valueToSet, valueToSet, true, true); // text, value, defaultSelected, selected
						    select.add(newOption);
						} else {
						    select.value = valueToSet;
						}

					  
					  document.getElementById('mode_of_payment').value = data.modeOfPayment;
					  document.getElementById('terms_of_delivery').value = data.termsOfDelivery;
					  
					  // ✅ Auto-check tax type based on GST values
					     if (data.items && data.items.length > 0) {
					         const item = data.items[0];

					         if (item.cgst > 0 || item.sgst > 0) {
					             document.getElementById('interState1').checked = true;
					             document.getElementById('outerState1').checked = false;
					         } else if (item.igst > 0) {
					             document.getElementById('outerState1').checked = true;
					             document.getElementById('interState1').checked = false;
					         } else {
					             document.getElementById('interState1').checked = false;
					             document.getElementById('outerState1').checked = false;
					         }
					     }
					  
	                  // Populate items table dynamically if any items exist
	                  const itemsTableBody = document.querySelector('#po_items_table tbody');
	                  itemsTableBody.innerHTML = ''; // Clear existing rows
	                  data.items.forEach((item, index) => {
	                      const row = document.createElement('tr');
	                      row.innerHTML = `
	                          <td><input type="number" class="form-control" name="slno[]" value="${index + 1}" readonly></td> 
	                          <td><input type="text" class="form-control" name="part_no[]" value="${item.partNo}"></td>
	                          <td><input type="text" class="form-control" name="hsn_code[]" value="${item.hsnCode}"></td>
	                          <td><input type="text" class="form-control" name="description[]" value="${item.description}"></td>
	                          <td><input type="number" class="form-control" name="quantity[]" value="${item.quantity}" min="1"></td>
	                          <td><input type="number" class="form-control" name="price[]" value="${item.price}" min="0" step="0.01"></td>
	                          <td><input type="number" class="form-control" name="line_total[]" value="${item.total}"></td>
	                      `;
	                      itemsTableBody.appendChild(row);
	                  });
	                  // Show the modal
	                  $('#purchaseOrderModal').modal('show');
	              })
	              .catch(error => {
	                  console.error('Error fetching data:', error);
	              });
	      });
	  });



    $(document).ready(function() {
        var table = $('#productTable').DataTable({
            "paging": true, 
            "searching": true,
             "lengthMenu": [8, 10, 25, 50, 75, 100, 200, 500, 800, 1000],
             "pageLength": 8,
             "pagingType": "full_numbers",
            "info": true,
            "dom": '<"d-flex justify-content-between mb-2"l f>t<"d-flex justify-content-between mt-2"i p>',
            
        });
    });
    
    
    function convertQuotationAs(qid, clickedAs){
    	//alert(qid+" "+clickedAs);
    	$.ajax({
            type: 'POST',
            url: '/dc/save',
            data: {
                "qid": qid,
                "clickedFor": clickedAs
            },
            success: function (response) {
                if (response === 'Delivery Challan saved successfully!') {
                	alert(response);
                }
            },
            error: function (xhr, status, error) {
            	alert('Error inserting data as '+clickedAs);
                console.error('Error inserting data as '+clickedAs);
                console.log('XHR object:', xhr);
                console.log('Status:', status);
                console.log('Error:', error);
            }
        });    	
    }
    
</script>

<!-- script to display perfoma invoice modal -->

<script>

document.getElementById('pi_interState1').addEventListener('click', function(e) {
    e.preventDefault();
});
document.getElementById('pi_outerState1').addEventListener('click', function(e) {
    e.preventDefault();
});


function openInvoiceModal(){
	/* alert(document.getElementById('orderDetailsId').value);
	alert("hi"); */
	const orderDetailsId = document.getElementById('orderDetailsId').value;
	 
	// Hide purchaseOrderModal
    var purchaseOrderModal = bootstrap.Modal.getInstance(document.getElementById('purchaseOrderModal'));
    if (!purchaseOrderModal) {
        purchaseOrderModal = new bootstrap.Modal(document.getElementById('purchaseOrderModal'));
    }
    purchaseOrderModal.hide();
    
    // Fetch the data based on the purchaseId
    fetch(`/getPurchaseOrderDetails/${orderDetailsId}`)  // Assuming you have this endpoint in your controller
        .then(response => response.json())
        .then(data => {
        	
            // Populate modal fields with the fetched data pi_po_id
            generateInvoiceNumber();
            
            // alert(data.id);
			document.getElementById('salesId').value = data.id;            
            document.getElementById('pi_po_id').value = data.purchaseId;
            //document.getElementById('pi_id').value = data.purchaseId;
            //document.getElementById('pidateTime').value = data.createdDateTime;
            document.getElementById('pi_number').value = data.poNumber;
            document.getElementById('pi_date').value = data.poDate;
             
            document.getElementById('pi_vendor_code').value = data.vendorCode;
            document.getElementById('pi_quotationId').value = data.quotationId;
            document.getElementById('pi_company_honorifics1').value = data.cust_honorifics;
            document.getElementById('pi_cust_name').value = data.cust_name;
            document.getElementById('pi_cust_legan_name').value = data.cus_leagal_name;
            document.getElementById('pi_gstnumberr1').value = data.gst_no;
            document.getElementById('pi_orderMethod1').value = data.order_mehtod;
            
            document.getElementById('pi_contact_person_honorifics1').value = data.contact_honorifics;            
            document.getElementById('pi_personName1').value = data.cont_person_name;            
            document.getElementById('pi_designation1').value = data.designation;
            document.getElementById('pi_contactDetails1').value = data.mobile_no;
            document.getElementById('pi_emailId1').value = data.email;
            document.getElementById('pi_billing_address').value = data.billingAddress;
            document.getElementById('pi_shipping_address').value = data.shippingAddress;
			document.getElementById('pi_terms_and_conditionnew').value = data.termsAndConditions;
			 
			document.getElementById('pi_mode_of_payment').value = data.modeOfPayment;  
			
 			// Check the appropriate Tax Type checkbox based on tax_type value
			if (data.tax_type === "intrastate") {
			    document.getElementById('pi_interState1').checked = true;
			    document.getElementById('pi_outerState1').checked = false;
			} else if (data.tax_type === "interstate") {
			    document.getElementById('pi_outerState1').checked = true;
			    document.getElementById('pi_interState1').checked = false;
			}

            // Populate items table dynamically if any items exist
            const itemsTableBody = document.querySelector('#pi_items_table tbody');
            itemsTableBody.innerHTML = ''; // Clear existing rows
            data.items.forEach((item, index) => {
            const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><input type="number" class="form-control" name="slno[]" value="${index + 1}" readonly></td>
                    
                    <td><input type="text" class="form-control" name="part_no[]" value="${item.partNo}"></td>
                    <td><input type="text" class="form-control" name="hsn_code[]" value="${item.hsnCode}"></td>
                    <td><input type="text" class="form-control" name="description[]" value="${item.description}"></td>
                    <td><input type="number" class="form-control" name="quantity[]" oninput="checkQuantityLimit(this); validateAndCalculate(this);" ></td>
                    
                    <td><input type="text" class="form-control dispatched-qty" name="dispatched_quantity[]" readonly></td>
					
                    <td><input type="number" class="form-control" name="price[]" value="${item.price}" min="0" step="0.01" oninput="calculateTotal(this)" readonly></td>
                    <td><input type="number" class="form-control saletotal-without-gst" name="line_total[]" value="${item.lineTotal}" readonly></td>
                    <td class="cgst-value">
	                    <input type="number" class="form-control salecgst" name="cgst[]" value="${item.cgst}" readonly>
	                </td>	                
	                <td class="sgst-value">
	                    <input type="number" class="form-control salesgst" name="sgst[]" value="${item.sgst}" readonly>
	                </td>
	                <td class="igst-value">
	                    <input type="number" class="form-control saleigst" name="igst[]" value="${item.igst}" readonly>
	                </td>
                    <td><input type="number" class="form-control" name="total_line_total[]" value="${item.totalValue}" readonly></td>
                    <td>
	                    <button type="button" class="btn btn-danger removeRowBtn" onclick="removeRow(this)">Remove</button>
	                </td>
                    <td style="display:none"><input type="text" class="form-control" name="product_id[]" value="${item.p_id}" readonly></td>
                `;
                itemsTableBody.appendChild(row);
                
                // After appending, validate the quantity and fetch remaining quantity
                const quantityInput = row.querySelector('input[name="quantity[]"]');
                if (quantityInput) {
                    validateAndCalculate(quantityInput);
                }
                
            }); 
            // Determine tax type based on the item (you can also use a separate flag from backend if you have)
            if (data.items?.[0]?.igst > 0) {
                toggleGSTColumns('interstate');
            } else {
                toggleGSTColumns('intrastate');
            }
            updateSummary();
            // Show the modal
            $('#purchaseOrderModal').modal('show');
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
    
	    // Show performaInvoiceOrderModal
	    var performaInvoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
	    performaInvoiceModal.show();	
}

//performaInvoice modal
function openPerformaInvoiceModal(){
	 
	const orderDetailsId = document.getElementById('orderDetailsId').value;
	 
	// Hide purchaseOrderModal
    var purchaseOrderModal = bootstrap.Modal.getInstance(document.getElementById('purchaseOrderModal'));
    if (!purchaseOrderModal) {
        purchaseOrderModal = new bootstrap.Modal(document.getElementById('purchaseOrderModal'));
    }
    purchaseOrderModal.hide();
    
    // Fetch the data based on the purchaseId
    fetch(`/getPurchaseOrderDetails/${orderDetailsId}`)  // Assuming you have this endpoint in your controller
        .then(response => response.json())
        .then(data => {
        	
            // Populate modal fields with the fetched data pi_po_id
            generatePerformaInvoiceNumber();
            
            // alert(data.id);
			document.getElementById('performa_salesId').value = data.id;            
            document.getElementById('performa_po_id').value = data.purchaseId;
            //document.getElementById('pi_id').value = data.purchaseId;
            //document.getElementById('pidateTime').value = data.createdDateTime;
            document.getElementById('performa_number').value = data.poNumber;
            document.getElementById('performa_date').value = data.poDate;
             
            document.getElementById('performa_vendor_code').value = data.vendorCode;
            document.getElementById('performa_quotationId').value = data.quotationId;
            document.getElementById('performa_company_honorifics1').value = data.cust_honorifics;
            document.getElementById('performa_cust_name').value = data.cust_name;
            document.getElementById('performa_cust_legan_name').value = data.cus_leagal_name;
            document.getElementById('performa_gstnumberr1').value = data.gst_no;
            document.getElementById('performa_orderMethod1').value = data.order_mehtod;
            
            document.getElementById('performa_contact_person_honorifics1').value = data.contact_honorifics;            
            document.getElementById('performa_personName1').value = data.cont_person_name;            
            document.getElementById('performa_designation1').value = data.designation;
            document.getElementById('performa_contactDetails1').value = data.mobile_no;
            document.getElementById('performa_emailId1').value = data.email;
            document.getElementById('performa_billing_address').value = data.billingAddress;
            document.getElementById('performa_shipping_address').value = data.shippingAddress;
			document.getElementById('performa_terms_and_conditionnew').value = data.termsAndConditions;
			 
			document.getElementById('performa_mode_of_payment').value = data.modeOfPayment;  
			
 			// Check the appropriate Tax Type checkbox based on tax_type value
			if (data.tax_type === "intrastate") {
			    document.getElementById('performa_interState1').checked = true;
			    document.getElementById('performa_outerState1').checked = false;
			} else if (data.tax_type === "interstate") {
			    document.getElementById('performa_outerState1').checked = true;
			    document.getElementById('performa_interState1').checked = false;
			}
			
            // Populate items table dynamically if any items exist
            const itemsTableBody = document.querySelector('#performa_items_table tbody');
            itemsTableBody.innerHTML = ''; // Clear existing rows
            data.items.forEach((item, index) => {
            const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><input type="number" class="form-control" name="slno[]" value="${index + 1}" readonly></td>
                    
                    <td><input type="text" class="form-control" name="part_no[]" value="${item.partNo}"></td>
                    <td><input type="text" class="form-control" name="hsn_code[]" value="${item.hsnCode}"></td>
                    <td><input type="text" class="form-control" name="description[]" value="${item.description}"></td>
                    <td><input type="number" class="form-control" name="quantity[]" oninput="checkQuantityLimit(this); validateAndCalculatePerformaInvoice(this);" ></td>
                    
                    <td><input type="text" class="form-control dispatched-qty" name="dispatched_quantity[]" readonly></td>
					
                    <td><input type="number" class="form-control" name="price[]" value="${item.price}" min="0" step="0.01" oninput="calculateTotal(this)" readonly></td>
                    <td><input type="number" class="form-control performa-saletotal-without-gst" name="line_total[]" value="${item.lineTotal}" readonly></td>
                    <td class="cgst-value">
	                    <input type="number" class="form-control performa-salecgst" name="cgst[]" value="${item.cgst}" readonly>
	                </td>	                
	                <td class="sgst-value">
	                    <input type="number" class="form-control performa-salesgst" name="sgst[]" value="${item.sgst}" readonly>
	                </td>
	                <td class="igst-value">
	                    <input type="number" class="form-control performa-saleigst" name="igst[]" value="${item.igst}" readonly>
	                </td>
                    <td><input type="number" class="form-control" name="total_line_total[]" value="${item.totalValue}" readonly></td>
                    <td>
	                    <button type="button" class="btn btn-danger removeRowBtn" onclick="removePerformaInvoiceRow(this)">Remove</button>
	                </td>
                    <td style="display:none"><input type="text" class="form-control" name="product_id[]" value="${item.p_id}" readonly></td>
                `;
                itemsTableBody.appendChild(row);
                
                // After appending, validate the quantity and fetch remaining quantity
                const quantityInput = row.querySelector('input[name="quantity[]"]');
                if (quantityInput) {
                	validateAndCalculatePerformaInvoice(quantityInput);
                }
                
            }); 
            // Determine tax type based on the item (you can also use a separate flag from backend if you have)
            if (data.items?.[0]?.igst > 0) {
                toggleGSTColumns('interstate');
            } else {
                toggleGSTColumns('intrastate');
            }
            updateSummaryPerformaInvoice();
            // Show the modal
            $('#purchaseOrderModal').modal('show');
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
    
	    // Show performaInvoiceOrderModal
	    var invoiceModal = new bootstrap.Modal(document.getElementById('performainvoiceModal'));
	    invoiceModal.show();	
}

// function to remove row 
function removeRow(button) {
    const row = button.closest('tr');
    row.remove();
    updateSerialNumbers();
    updateSummary();
}
function removePerformaInvoiceRow(button) {
	 
    const row = button.closest('tr');
    row.remove();
    updatePerformaInvoiceSerialNumbers();
    updateSummaryPerformaInvoice();
}
function updateSerialNumbers() {
    const rows = document.querySelectorAll('#pi_items_table tbody tr');
    rows.forEach((row, index) => {
        const slnoInput = row.querySelector('input[name="slno[]"]');
        if (slnoInput) {
            slnoInput.value = index + 1;
        }
    });
}
function updatePerformaInvoiceSerialNumbers() {
    const rows = document.querySelectorAll('#performa_items_table tbody tr');
    rows.forEach((row, index) => {
        const slnoInput = row.querySelector('input[name="slno[]"]');
        if (slnoInput) {
            slnoInput.value = index + 1;
        }
    });
}

//generate Invoice Number
function generateInvoiceNumber() {
    fetch('/purchase-invoice/next-invoice-id')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch invoice number');
            }
            return response.text();
        })
        .then(invoiceNumber => {
            document.getElementById('pi_id').value = invoiceNumber;
        })
        .catch(error => {
            console.error('Error fetching invoice number:', error);
        });
}

//generate Performa Invoice Number
function generatePerformaInvoiceNumber() {
    fetch('/purchase-invoice/next-performainvoice-id')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch invoice number');
            }
            return response.text();
        })
        .then(invoiceNumber => {
            document.getElementById('performa_id').value = invoiceNumber;
        })
        .catch(error => {
            console.error('Error fetching invoice number:', error);
        });
}
</script>

<!-- <script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".generate-pdf").forEach((button) => {
        button.addEventListener("click", function () {
            let row = button.closest("tr"); // Get the row
            let doc = new window.jspdf.jsPDF();
            
            // Draw Page Border
            doc.setDrawColor(0); // Black Border
            doc.rect(5, 5, 200, 287); // (x, y, width, height)

            // Load and add logo
            let logo = new Image();
            logo.src = "/assets/img/logo.png";
            logo.onload = function () {
                doc.addImage(logo, "PNG", 20, 10, 40, 20);

                // Define starting y position
                let yStart = 28; 

                // Company Address (Right-Aligned)
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("Melange Systems Private Limited", 200, 15, { align: "right" });
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text("4/1, 7th cross, Kumara Park West,", 200, 22, { align: "right" });
                doc.text("Bangalore, Karnataka - 560020", 200, 28, { align: "right" });
                doc.text("Phone: +91 8023561023", 200, 34, { align: "right" });

                let yPos = yStart + 10; // Adjust for spacing

                // Line before heading
                doc.setDrawColor(0.5);
                doc.line(5, yPos, 205, yPos); // Horizontal Line

                // Quotation Details Heading
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                yPos += 7; // Space before heading
                doc.text("Sales Quotation", 105, yPos, { align: "center" });

                // Line after heading
                doc.setDrawColor(0);
                yPos += 3;
                 doc.line(5, yPos, 205, yPos); // Horizontal Line

                // Extract row data
                let dateTime = row.cells[0].innerText;
                let qid = row.cells[1].innerText;
                let customerName = row.cells[2].innerText;
                let contactPerson = row.cells[3].innerText;
                let mobileNumber = row.cells[5].innerText;
                let emailId = row.cells[6].innerText;
                let orderPlatform = row.cells[7].innerText;
                let deliveryAddress = row.cells[8].innerText;
                let shipmentAddress = row.cells[9].innerText;

                // Customer Details
                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);
                yPos += 10;
                doc.text(`Date: ${dateTime}`, 130, yPos);
                doc.text(`Quotation ID: ${qid}`, 130, yPos+7);
                

               yPos += 0;

// Customer Details Heading (Bold & Underlined)
doc.setFont("helvetica", "bold");
doc.text("Customer Details", 20, yPos);
doc.setLineWidth(0.5);
doc.line(20, yPos + 2, 55, yPos + 2); // Underline
doc.setFont("helvetica", "normal");

// Customer Name & Address
yPos += 10;
doc.text(`Customer: ${customerName}`, 20, yPos);
doc.text(`Address: ${shipmentAddress}`, 20, yPos + 10);

// Contact Details Heading (Bold & Underlined)
yPos += 20;
doc.setFont("helvetica", "bold");
doc.text("Contact Details", 20, yPos);
doc.line(20, yPos + 2, 51, yPos + 2); // Underline
doc.setFont("helvetica", "normal");

// Contact Information
yPos += 10;
doc.text(`Contact Person: ${contactPerson}`, 20, yPos);
doc.text(`Mobile Number: ${mobileNumber}`, 20, yPos + 10);
doc.text(`Email Id: ${emailId}`, 20, yPos + 20);

yPos += 30;
doc.setFont("helvetica", "bold");
doc.text("Delivery Address", 20, yPos);
doc.line(20, yPos + 2, 54, yPos + 2); // Underline
doc.setFont("helvetica", "normal");

// Contact Information
yPos += 10;
doc.text(`${deliveryAddress}`, 20, yPos + 0);
                
                
yPos += 10;
doc.setFont("helvetica", "bold");
doc.text("Product Details", 20, yPos);
doc.setLineWidth(0.5);
doc.line(20, yPos + 2, 51, yPos + 2); // Underline


                // Table Headers
                yPos += 10;
                let xPos = 20;
                let colWidths = [45, 25, 25, 25, 35]; // Adjusted column widths

                doc.setFont("helvetica", "bold");
                doc.setFillColor(200, 200, 200);
                doc.rect(xPos, yPos - 5, 155, 10, "F"); // Header background

                let headers = ["Product Name", "Quantity", "Price", "Discount", "Amount"];
                headers.forEach((header, i) => {
                    doc.text(header, xPos + 2, yPos);
                    xPos += colWidths[i];
                });

                // Table Borders and Data
                doc.setFont("helvetica", "normal");
                yPos += 5;
                let products = [];

                row.cells[10].querySelector("tbody").querySelectorAll("tr").forEach((tr) => {
                    let productName = tr.cells[0].innerText;
                    let quantity = tr.cells[1].innerText;
                    let price = tr.cells[2].innerText;
                    let discount = tr.cells[3].innerText;
                    let cgst = tr.cells[5]?.innerText || "0";
                    let sgst = tr.cells[6]?.innerText || "0";
                    let total = tr.cells[4].innerText;
                    products.push({ productName, quantity, price, discount, cgst, sgst,  total });
                });

                products.forEach((prod) => {
                    xPos = 20;
                    yPos += 10;
                    
                    let rowData = [
                        prod.productName,
                        prod.quantity,
                        prod.price,
                        prod.discount,                        
                        prod.total
                    ];

                    // Draw table cells with borders
                    for (let i = 0; i < rowData.length; i++) {
                        doc.text(rowData[i], xPos + 2, yPos);
                        doc.rect(xPos, yPos - 7, colWidths[i], 10); // Border for each cell
                        xPos += colWidths[i];
                    }
                });
                
               // Calculate total CGST and SGST before using them
// Calculate total CGST, SGST, and Amount
let totalCgst = 0;
let totalSgst = 0;
let totalAmount = 0;

products.forEach((prod) => {
    totalCgst += parseFloat(prod.cgst) || 0; // Convert to float, default to 0 if NaN
    totalSgst += parseFloat(prod.sgst) || 0;
    totalAmount += parseFloat(prod.total) || 0;
});

let finalTotal = totalAmount + totalCgst + totalSgst; // Final Total including GST

// GST Summary (Right Side)
yPos += 10;
let xRightAlign = 115; // Adjust position

//doc.setFont("helvetica", "bold");
//doc.text("GST Summary", xRightAlign, yPos);
//yPos += 10;

doc.setFont("helvetica", "normal");
doc.text(`SGST (9%):      ${totalSgst.toFixed(2)}`, xRightAlign, yPos);
yPos += 5;
doc.text(`CGST (9%):      ${totalCgst.toFixed(2)}`, xRightAlign, yPos);
yPos += 5;
// Underline Above "Total"
let lineStartX = xRightAlign - 0; // Adjust as needed
let lineEndX = xRightAlign + 43;  // Adjust width as needed
let lineY = yPos - 3; // Position slightly above text
doc.line(lineStartX, lineY, lineEndX, lineY); // Draw line
yPos += 3;
// Bold "Total"
doc.setFont("helvetica", "bold");
doc.text(`          Total:    ${finalTotal.toFixed(2)}`, xRightAlign, yPos);
yPos += 3;

// Underline Below "Total"
lineY = yPos + 0; // Position slightly below text
doc.line(lineStartX, lineY, lineEndX, lineY); // Draw line

yPos += 10;

// Convert Number to Words Function
function numberToWords(num) {
    const a = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const b = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

    function convert(n) {
        if (n < 20) return a[n];
        if (n < 100) return b[Math.floor(n / 10)] + (n % 10 !== 0 ? " " + a[n % 10] : "");
        if (n < 1000) return a[Math.floor(n / 100)] + " Hundred" + (n % 100 !== 0 ? " and " + convert(n % 100) : "");
        if (n < 100000) return convert(Math.floor(n / 1000)) + " Thousand" + (n % 1000 !== 0 ? " " + convert(n % 1000) : "");
        return num; // Extend logic if needed
    }

    return num === 0 ? "Zero" : convert(num);
}

// Convert total price to words
let totalInWords = numberToWords(Math.floor(finalTotal));

// Display Total in Words
doc.setFont("helvetica", "bold");
doc.text(`Total Amount in Words: `, 20, yPos);
yPos += 5;
doc.setFont("helvetica", "normal");
doc.text(`${totalInWords} Only`, 20, yPos);


//doc.setFont("helvetica", "bold");
//doc.text(`Total Central GST: ${totalCgst.toFixed(2)}`, xRightAlign, yPos);
//yPos += 5;
//doc.text(`Total State GST: ${totalSgst.toFixed(2)}`, xRightAlign, yPos);


                // Terms & Conditions
yPos += 10;
doc.setFont("helvetica", "bold");
doc.text("Terms & Conditions:", 20, yPos);
doc.setFont("helvetica", "normal");
doc.setFontSize(10);

let terms = [
    "1. Payment Terms:\nThe Buyer agrees to pay 100% of the total amount in advance prior to the release of the goods or services.",
    "2. Validity:\nThis Quote is valid for a period of 30 days from the date of issue. After this period, the prices and terms may be subject to change at the Seller's discretion.",
    "3. Stock Availability:\nThe Buyer must confirm the availability of stock before proceeding with the issuance of a Purchase Order (PO) or making any payment. The Seller does not guarantee the availability of goods until confirmation is provided.",
    "4. Pricing:\nAll prices stated in this Quote are valid for a period of 30 days from the date of issue. After this period, the Seller reserves the right to amend or adjust the pricing. Any change in pricing will be communicated to the Buyer before proceeding with the order."
];

yPos += 5;
terms.forEach((term) => {
    let wrappedText = doc.splitTextToSize(term, 170); // Wrap text within page width
    doc.text(wrappedText, 22, yPos);
    yPos += wrappedText.length * 5; // Adjust spacing dynamically
});


                // Save PDF
                doc.save(`Quotation_${qid}.pdf`);
            };
        });
    });
});
</script> -->


<script>
function openDetails(button) {
	//alert(JSON.stringify(productData))
	 var row = button.closest('tr');
	    var rowIndex = row.rowIndex - 1; // Adjusting for header row
	    //alert(rowIndex);
	    var qId = row.cells[3]?.innerText;
	    var dateTime = row.cells[7]?.innerText;
	    document.getElementById("qid").value = qId;
	    document.getElementById("qdateTime").value = dateTime;
	   //alert(qId);
	   
	   $.ajax({
        url: '/retrieveEmailSentFlagStatusValue',
        type: 'GET',
        data: {
        	quotationId: qId
        },
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	if(data === "2"){
        		$('#quotationReviewApproveBtn').text("Manually Sent");
        	}else if(data === "1"){
        		$('#quotationReviewApproveBtn').text("Email Sent to Customer");
        	}else{
        		$('#quotationReviewApproveBtn').text("Approve");
        	}
        },
        error: function(xhr, status, error) {
            console.error('Failed to get email sent status flag:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
	    
	    fetch(`/getQuotationDetails?id=${qId}`) // API call to fetch data
        .then(response => response.json())
        .then(data => {
        	console.log(JSON.stringify(data));
            // Populate Modal Fields
            document.getElementById("qid").value = data.qid;
            document.getElementById("qdateTime").value = data.dateTime;
            document.getElementById("vendorName").value = data.customerName;
            document.getElementById("vendorlegalNamee").value = data.customerLegalName;
            document.getElementById("gstnumberr").value = data.gstNumber;
            document.getElementById("orderMethod").value = data.orderMethod;
            document.getElementById("personName").value = data.contactPersonName; 
            document.getElementById("designation").value = data.designation;
            document.getElementById("contactDetails").value = data.contactDetails;
            document.getElementById("emailId").value = data.emailId;
            document.getElementById("shipmentAddress").value = data.shipmentAddress;
            document.getElementById("deliveryAddress").value = data.deliveryAddress;
            document.getElementById("company_honorifics").value = data.honorifics1;
            document.getElementById("contact_person_honorifics").value = data.honorifics2;
            
            document.getElementById("revise_qid").value = data.qid;
            //document.getElementById("revise_qdateTime").value = data.dateTime;
            document.getElementById("revise_vendorName").value = data.customerName;
            document.getElementById("revise_vendorlegalNamee").value = data.customerLegalName;
            document.getElementById("revise_gstnumberr").value = data.gstNumber;
            //document.getElementById("revise_orderMethod").value = data.orderMethod;
            document.getElementById("revise_personNameOptionForPopupFistTime").value = data.contactPersonName; 
            document.getElementById("revise_personNameOptionForPopupFistTime").innerHTML = data.contactPersonName;
            document.getElementById("revise_designation").value = data.designation;
            document.getElementById("revise_contactDetails").value = data.contactDetails;
            document.getElementById("revise_emailId").value = data.emailId;
            document.getElementById("revise_shipmentAddress").value = data.shipmentAddress;
            document.getElementById("revise_company_honorifics").value = data.honorifics1;
            document.getElementById("revise_contact_person_honorifics").value = data.honorifics2;
            //document.getElementById("revise_deliveryAddress").value = data.deliveryAddress;
            
            document.getElementById("revise_deliveryAddressOptionForPopupFistTime").value = data.deliveryAddress; 
            document.getElementById("revise_deliveryAddressOptionForPopupFistTime").innerHTML = data.deliveryAddress;
            
            let orderMethodDropDown = document.getElementById("revise_orderMethod");
            let options = orderMethodDropDown.options;
            
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === data.orderMethod) {
                    options[i].selected = true;  // Match found, set as selected
                    break;
                }
            }
            
            //alert(data.review);
            
            if(data.review != 0){
            	$('#quotationSubmitBtnForReview').text("Submitted");
            	$('#quotationSubmitBtnForReview').prop("disabled", true);
            	$('#reviseQuotationBtn').css("display", "block");
            	$('#quotationReviewApproveBtn').css("display", "block");
            	$('#quotationSubmitBtnForReview').css("display", "none");
            }else{
            	$('#quotationSubmitBtnForReview').text("Submit");
            	$('#quotationSubmitBtnForReview').prop("disabled", false);
            	$('#reviseQuotationBtn').css("display", "none");
            	$('#quotationReviewApproveBtn').css("display", "none");
            	$('#quotationSubmitBtnForReview').css("display", "block");
            }
            
            if(data.review === 3){
        		$('#wonQuotationBtn').prop("disabled", true);
        		$('#terminateQuotationBtn').prop("disabled", false);
        		$('#quotationReviewApproveBtn').css("display", "none");
        		$('#reviseQuotationBtn').css("display", "none");
        		$('#quotationSubmitBtnForReview').css("display", "none");
        		$('#terminateQuotationBtn').css("display", "none");
        	}else if(data.review === 4){
        		$('#terminateQuotationBtn').prop("disabled", true);
        		$('#wonQuotationBtn').prop("disabled", false);
        		$('#quotationReviewApproveBtn').css("display", "none");
        		$('#reviseQuotationBtn').css("display", "none");
        		$('#quotationSubmitBtnForReview').css("display", "none");
        		$('#wonQuotationBtn').css("display", "none");
        	}
            
           // alert(data.contactPersonName);
           // Apply tax type logic
            applyTaxType(data.tax_type);
            if(data.tax_type === "interstate"){
            	 document.getElementById("interState").checked = true;
            	 document.getElementById("outerState").checked = false;
            }
            else if(data.tax_type === "outerstate"){
            	 document.getElementById("outerState").checked = true;
            	 document.getElementById("interState").checked = false;
            }
            
         	// Populate product details
            let productTable = document.getElementById("productTableBody");
            productTable.innerHTML = ""; // Clear old data
            
            let productDropdown = document.getElementById("productName");
            
            data.products.forEach((product, index) => {
            	let options = productDropdown.options;
                
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === product.partNumber) {
                    	//alert(product.partNumber);
                        options[i].selected = true;  // Match found, set as selected
                        break;
                    }
                }
                
                populateProductDetailsDataBasedOnSelectedProductNameInRevise(product.partNumber);
                addProduct();
                
                /* let quantityFields = document.querySelectorAll(".quantity");
                let priceFields = document.querySelectorAll(".price");

                if (quantityFields[index]) {
                    quantityFields[index].value = product.quantity;
                }

                if (priceFields[index]) {
                    priceFields[index].value = product.price;
                } */
                
                let quantityFields = document.querySelectorAll("#revise_productTableBody .quantity");
                let priceFields = document.querySelectorAll("#revise_productTableBody .price");

                let lastIndex = quantityFields.length - 1; // Get last added row

                if (quantityFields[lastIndex]) {
                    quantityFields[lastIndex].value = product.quantity;
                    quantityFields[lastIndex].dispatchEvent(new Event('input')); // Trigger calculation
                }

                if (priceFields[lastIndex]) {
                    priceFields[lastIndex].value = product.price;
                    priceFields[lastIndex].dispatchEvent(new Event('input')); // Trigger calculation
                }
                
              //calculateTotalPriceValueAndTaxCalculationForRevisedPopup(product.quantity, product.price);

              //alert(product.hsnCode);
              
              var formatTotal = formatPrice(product.total);
              var formatTotalValue = formatPrice(product.total_value);
              var formatPriceValue = formatPrice(product.price);
            
            //data.products.forEach((product, index) => {
                let row = `<tr>                
                    <td style="display: none;">${product.productName}</td>
                    <td>${product.hsnCode}</td>
                    <td>${product.partNumber}</td>
                    <td>${product.description}</td>
                    <td>${product.quantity}</td>
                    <td>${formatPriceValue}</td>
                    <td>${formatTotal}</td>
                    <td class="cgst-header ${data.tax_type === 'interstate' ? '' : 'd-none'}">${product.cgst || "-"}</td>
                    <td class="sgst-header ${data.tax_type === 'interstate' ? '' : 'd-none'}">${product.sgst || "-"}</td>
                    <td class="igst-header ${data.tax_type === 'outerstate' ? '' : 'd-none'}">${product.igst || "-"}</td>
                    <td>${formatTotalValue}</td>                   
                </tr>`;
                productTable.innerHTML += row;
            });
            
         // Populate product details
            let productHiddenTable = document.getElementById("hiddenProductTableBody");
            productHiddenTable.innerHTML = ""; // Clear old data
            
            data.products.forEach((product, index) => {
                let row = `<tr>     
                	<td>${product.productName}</td>
                    <td>${product.quantity}</td>
                    <td>${product.price}</td>
                    <td>${product.discount}</td>
                    <td>${product.total}</td>                        
                    <td>${product.cgst}</td>
                    <td>${product.sgst}</td>
                    <td>${product.igst}</td>
                </tr>`;
                productHiddenTable.innerHTML += row;
            });

            // Show modal
            //document.getElementById("myModal").style.display = "block";
        })
        .catch(error => console.error("Error fetching quotation:", error));
            
	    // Show the modal
	    document.getElementById("editRowIndex").value = rowIndex;
	    openViewQuotationOuterDiv();
	    
	    /* var quotationModal = new bootstrap.Modal(document.getElementById('quotationModal'));
	    quotationModal.show(); */
	};
	
	function formatPrice(value) {
	    value = parseFloat(value); // Convert string to number
	    if (isNaN(value)) {
	        return "Invalid Number"; // Handle invalid cases
	    }
	    return value % 1 === 0 ? value.toFixed(2) : value;
	}

	/* function toggleGST(selectedType) {
	    let isInterState = selectedType === "interState";
	
	    // Set checkbox values based on selection
	    document.getElementById("interState").checked = isInterState;
	    document.getElementById("outerState").checked = !isInterState;
	
	    // Show/hide table headers based on tax type
	    document.querySelectorAll(".cgst-header, .sgst-header").forEach(header => {
	        header.classList.toggle("d-none", !isInterState);
	    });
	
	    document.querySelectorAll(".igst-header").forEach(header => {
	        header.classList.toggle("d-none", isInterState);
	    });
	} */
	
	function toggleGST(type) {
		//alert(type);
	    if (type === "interState") {
	        document.getElementById("revise_outerState").checked = false;
	    } else {
	        document.getElementById("revise_interState").checked = false;
	    }

	    applyGSTSelection();
	}

// Function to apply settings when fetching data
/* function applyTaxType(taxType) {
    if (taxType === "interstate") {
        document.getElementById("interState").checked = true;
        document.getElementById("outerState").checked = false;
        toggleGST("interState");
    } else if (taxType === "outerstate") {
        document.getElementById("outerState").checked = true;
        document.getElementById("interState").checked = false;
        toggleGST("outerState");
    }
} */


//Function to apply settings when fetching data
function applyTaxType(taxType) {
    if (taxType === "interState") {
        document.getElementById("revise_interState").checked = true;
        document.getElementById("revise_outerState").checked = false;
        toggleGST("interState");
    } else if (taxType === "outerState") {
        document.getElementById("revise_outerState").checked = true;
        document.getElementById("revise_interState").checked = false;
        toggleGST("outerState");
    }
}

$.ajax({
    url: '/returnRecentlyInsertedTermsAndConditionDetail',
    type: 'GET',
    contentType: 'application/json', // Specify content type
    success: function(data) {
    	$('#terms_and_condition').val(data.terms_and_condition_data);
    	$('#revise_terms_and_condition').val(data.terms_and_condition_data);
    },
    error: function(xhr, status, error) {
        console.error('Failed to get terms and condition details:', error);
        console.error('Response text:', xhr.responseText);
    }
});

function updateQuotationStatusAfterReview(quotationId, customerEmail, clickedStatusBtnValue){
	//alert(quotationId+" "+clickedStatusBtnValue);
	$.ajax({
        type: 'POST',
        url: '/updateReviewStatusForQuotationReview',
        data: {
            "reviewStatus": clickedStatusBtnValue,
            "quotationId": quotationId
        },
        success: function (response) {
            if (response === 'success') {
            	if(clickedStatusBtnValue === 2){
            		/* $('#quotationReviewRejectBtn').text("Reject");
                	$('#quotationReviewRejectBtn').prop("disabled", false);
            		$('#quotationReviewApproveBtn').text("Approved");
                	$('#quotationReviewApproveBtn').prop("disabled", true); */
                	//$('#quotationModal').modal('hide');
                	openSendEmailForCustomerOuterDiv(quotationId, customerEmail);
            	}else if(clickedStatusBtnValue === 3){
            		/* $('#quotationReviewApproveBtn').text("Approve");
                	$('#quotationReviewApproveBtn').prop("disabled", false);
            		$('#quotationReviewRejectBtn').text("Rejected");
                	$('#quotationReviewRejectBtn').prop("disabled", true); */
            	}
            }
        },
        error: function (xhr, status, error) {
        	hideLoadingPopup();
            console.error('Error updating quotation after review status record:');
            console.log('XHR object:', xhr);
            console.log('Status:', status);
            console.log('Error:', error);
        }
    });   	
}

function closeSendEmailForCustomerOuterDiv(){
	$('#sendEmailForCustomerOuterDiv').hide();
}

function closeEmailPasswordOuterDiv(){
	$('#emailPasswordOuterDiv').hide();
}

function openEmailPasswordOuterDiv(){
	$('#emailPasswordOuterDiv').show();
}

function closeViewQuotationOuterDiv(){
	document.body.style.overflow="auto";
	$('#viewQuotationOuterDiv').hide();
	location.reload();
}

function openViewQuotationOuterDiv(){
	document.body.style.overflow="hidden";
	$('#viewQuotationOuterDiv').show();
}

function closeReviseQuotationOuterDiv(){
	location.reload();
	$('#revise_QuotationOuterDiv').hide();
}

function openReviseQuotationOuterDiv(){
	$('#revise_QuotationOuterDiv').show();
}

function openSendEmailForCustomerOuterDiv(quotationId, customerEmail){
	
	$('#emailToAddress').val(customerEmail);
	$('#emailSubject').val("Melange sales proposal estimation: "+quotationId);
	
	$.ajax({
        type: 'GET',
        url: '/fetchReportingManagersEmailBasedOnEmpEmail',
        data: {
        	employee_email: $('#emailFromAddress').val()
        	//employee_email: "sanjay.raj@melangesystems.com"
        },
        success: function (response) {
        	let firstEmail = response.first_reporting_manager_email;
            let secondEmail = response.second_reporting_manager_email;
            let emailCCField = $('#emailCCAddress');

            // Ensure both values are not null and compare them
            if (firstEmail && secondEmail) {
                if (firstEmail !== secondEmail) {
                    emailCCField.val(firstEmail + ', ' + secondEmail);
                } else {
                    emailCCField.val(firstEmail); // If both are the same, add only once
                }
            } else if (firstEmail) {
                emailCCField.val(firstEmail);
            } else if (secondEmail) {
                emailCCField.val(secondEmail);
            }
        },
        error: function (xhr, status, error) {
            console.error('Error fetching reporting managers email:');
            console.log('XHR object:', xhr);
            console.log('Status:', status);
            console.log('Error:', error);
        }
    });
	
	$.ajax({
        url: '/returnRecentlyInsertedEmailDraftMessageDetail',
        type: 'GET',
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	$('#emailBody').val(data.email_draft);
        },
        error: function(xhr, status, error) {
            console.error('Failed to get email draft details:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
	
	$.ajax({
        url: '/retrieveEmailSentFlagStatusValue',
        type: 'GET',
        data: {
        	quotationId: quotationId
        },
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	if(data === "2"){
        		$('#emailManuallySentCheckBox').prop("checked", true);
        		$('#downloadPdfManuallyBtn').css("display", "block");
        		$('#email_send_button').text("Manually Sent");
        		$('#quotationReviewApproveBtn').text("Manually Sent");
        		$('#email_send_button').prop("disabled", true);
        	}else if(data === "1"){
        		$('#email_send_button').prop("disabled", false);
        		$('#downloadPdfManuallyBtn').css("display", "none");
        		$('#email_send_button').text("Email Sent to Customer");
        		$('#quotationReviewApproveBtn').text("Email Sent to Customer");
        		$('#emailManuallySentCheckBox').prop("checked", false);
        	}else{
        		$('#email_send_button').text("Send");
        		$('#email_send_button').prop("disabled", false);
        		$('#downloadPdfManuallyBtn').css("display", "none");
        		$('#quotationReviewApproveBtn').text("Approve");
        		$('#emailManuallySentCheckBox').prop("checked", false);
        	}
        },
        error: function(xhr, status, error) {
            console.error('Failed to get email sent status flag:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
	
	//document.getElementById('sendEmailForCustomerOuterDiv').style.display = "block";
	$('#sendEmailForCustomerOuterDiv').show();
}

function sendDataToEmailToTheParticularCustomer(){
	//let fromAddress = $('#emailFromAddress').val().trim();
	let fromAddress = "premchand.s@melangesystems.com";
	let toAddress = $('#emailToAddress').val().trim();
	//let toAddress = "premsgowda25@gmail.com";
	let ccAddress = $('#emailCCAddress').val().trim();
	let subjectName = $('#emailSubject').val().trim();
	let bodyContent = $('#emailBody').val().trim();
	let enteredPaswword = $('#ionos_password').val().trim();
	
	const submitButton = document.getElementById('emailSendBtn');
	
	 if (!enteredPaswword) {
         Swal.fire({ icon: 'warning', title: "Password is required" });
         return;
     }
	
	// Store original button text before changing it
     const originalButtonText = submitButton.innerHTML;
     
     // Disable button and show loading state
     submitButton.disabled = true;
     submitButton.innerHTML = `Validating...`;
	
  	// Validate sender email & password
     fetch('/api/validateSenderCredentials', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ email: fromAddress, password: enteredPaswword })
     })
     .then(response => {
         if (!response.ok) {
             return response.text().then(text => { throw new Error(text); });
         }
         return response.text();
     })
     .then(() => {
         // Close password popup
         closeEmailPasswordOuterDiv();
         
         $.ajax({
             url: '/returnRecentlyInsertedEmailDraftMessageDetail',
             type: 'GET',
             contentType: 'application/json', // Specify content type
             success: function(data) {
             	
             	if(data.email_draft !== bodyContent){

             		let emailDraftData = {
             				email_draft: bodyContent
             		    };
             		
             		$.ajax({
             	        type: "POST",
             	        url: "/insertEmailDraft",
             	        contentType: "application/json",
             	        data: JSON.stringify(emailDraftData),
             	        success: function(response) {
             	        	console.log(response);
             	        },
             	        error: function(xhr) {
             	            alert("Error: " + xhr.responseText);
             	        }
             	    });
             	}
             	
             },
             error: function(xhr, status, error) {
                 console.error('Failed to get email draft details:', error);
                 console.error('Response text:', xhr.responseText);
             }
         });
         
      	  // Proceed with sending email sending...
          sendEmailToTheCustomerAfterValidation(fromAddress, toAddress, ccAddress, subjectName, bodyContent, enteredPaswword);
     })
     .catch(error => {
         Swal.fire({ icon: 'error', title: "Invalid Credentials", text: error.message });
         //alert("Invalid Credentials");
         submitButton.disabled = false;
         submitButton.innerHTML = originalButtonText;
     })
     .finally(() => {
     	// Re-enable button and restore original text
         submitButton.disabled = false;
         submitButton.innerHTML = originalButtonText;
     });
}

function sendEmailToTheCustomerAfterValidation(fromAddress, toAddress, ccAddress, subjectName, bodyContent, enteredPaswword){
	let quotationId = $('#qid').val();
	
	displayOnLoadingPopup();
	
	const { jsPDF } = window.jspdf;
	const doc = new jsPDF();
    
    var rawDateTime = document.getElementById("qdateTime").value;
    
    // Draw Page Border
    doc.setDrawColor(0); // Black Border
    //doc.rect(3, 3, 203.5, 330); // (x, y, width, height)
    doc.rect(3, 3, 203.5, 291); // 297 - 6 for padding

    let mainY = 33;
 	// ✅ HEADER BAR
   	doc.setDrawColor(0); // Black border
    doc.rect(3, 3, 203.5, mainY); // Header box

    // ✅ Add Company Address (Left Side)
    doc.setTextColor(0); // Black text
    doc.setFont("helvictica","bold");
    doc.setFontSize(12);
    doc.text("Melange Systems Private Limited", 7, 10);
    doc.setFontSize(10);
    
    doc.setFont("helvictica","normal");

    doc.setFontSize(10);
    doc.text("(ISO 9001:2015 Certified Company)", 7, 15);
    
    doc.text("4/1, 7th cross, Kumara Park West, Bangalore, Karnataka - 560020", 7, 20);
    //doc.text("Bangalore, Karnataka - 560020", 10,18.5);
    doc.text("Phone: +91 8023561023", 7, 25);
    
    doc.setFont("helvetica", "bold");
    doc.text("GSTIN: 29AACCM4737H1ZA", 7,30, );
    
    doc.text("Udyan Ref No: UDYAM-KR-03-0101576", 7, 35, );
    doc.setFont("helvetica", "normal");
    // ✅ Add Company Logo (Right Side)
   	let logo = new Image();
    logo.src = "/assets/img/logo.png";
    
    //logo.onload = function () {
    doc.addImage(logo, "PNG", 150, 10, 50, 18); // (image, type, x, y, width, height)        

    // Title
    doc.setFontSize(16);

     // Draw the centered text
     let title = "QUOTE";
     let centerX = 105;
     let textY1 = mainY + 10;
     doc.setFont("helvetica", "bold"); 
     doc.text(title, centerX, textY1, { align: "center" });

     // Measure the width of the text
     let textWidth2 = doc.getTextWidth(title);

     // Draw underline manually (a horizontal line below the text)
     let underlineY = textY1 + 1; // slightly below the text
     doc.line(centerX - textWidth2 / 2, underlineY, centerX + textWidth2 / 2, underlineY);

    
    
    
    // doc.setFont("helvetica", "normal");
    //doc.rect(3, 28, 203.5, 10); // Horizontal Line
    
    
    
    // quotation Id dddaaaattteee 
    doc.setFontSize(12);
    //doc.rect(3, 38, 203.5, 10);
    
    doc.text("To,", 7, mainY + 15);
    mainY += 10
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal"); 
    doc.text(document.getElementById("qid").value, 160, mainY + 7);
    
    
    if (rawDateTime) {
        var date = new Date(rawDateTime);
        var day = String(date.getDate()).padStart(2, '0');
        var month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based
        var year = date.getFullYear();
        var formattedDate = `${day}-${month}-${year}`;

        doc.text(formattedDate, 160, mainY + 12);
    }  
    
    //doc.rect(3, 38, 203.5, 60); // Horizontal Line
    //doc.line(105, 48, 105, 98); 
    
    doc.setFont("helvetica", "bold");
    //doc.text("Billing Address", 10, 54  ); 
    //doc.text("Shipping Address", 129, 54  );  
    //doc.rect(3, 48, 102, 10);  // Left Header Box
    //doc.rect(105, 48, 101.5, 10); // Right Header Box
    
    doc.setFont("helvetica", "bold"); 
    doc.setFontSize(10);
	
    let billingAndShippengAddY = mainY + 12;
    
    // Billing Address Section
    // ✅ M/S (Bold) + Vendor Name (Normal) on the Same Line
    let msLabel = document.getElementById("company_honorifics").value;
    
    doc.setFont("helvetica", "bold");
    doc.text(msLabel, 12, billingAndShippengAddY);
    let msLabelWidth = doc.getTextWidth(msLabel);
    doc.setFont("helvetica", "bold");
    doc.text(document.getElementById("vendorlegalNamee").value, msLabelWidth + 12, billingAndShippengAddY); 
	
    
    
    // ✅ Address (Bold) + Address Text (Normal, Wrapped Properly)
    doc.setFont("helvetica", "bold");
    let addressLabel = "Address ";
    //doc.text(addressLabel, 10, billingAndShippengAddY + 6);
    let addressLabelWidth = doc.getTextWidth(addressLabel);
    doc.setFont("helvetica", "normal");

    let addressText = document.getElementById("shipmentAddress").value;
    let maxWidth = 65;
    let addressLines = doc.splitTextToSize(addressText, maxWidth);
    let addressX = addressLabelWidth;
    let addressY = billingAndShippengAddY + 6;

    // Print wrapped address lines
    let lineHeight = 5; // Adjust if your font size changes
    for (let i = 0; i < addressLines.length; i++) {
        doc.text(addressLines[i], addressX - 3, addressY + (i * lineHeight));
    }  

    // ✅ Dynamically Position GSTIN After Address
    let gstY = addressY + (addressLines.length * lineHeight) + 1; // Extra 5px padding after address
    doc.setFont("helvetica"); 
    let gstLabel = "GSTIN";
    //doc.text(gstLabel, 15, gstY);
    
    doc.text(`GSTIN ${document.getElementById("gstnumberr").value}`, 12, gstY);
    
    let gstLabelWidth = doc.getTextWidth(gstLabel);
    doc.setFont("helvetica", "normal");
    //doc.text(document.getElementById("gstnumberr").value, 10 + gstLabelWidth + 9.5, gstY);
    
    let lineHeight1 = 5;
    
    // ------------------ Contact Person ------------------ 
	let contactY = gstY + 2;
	let msLabell = "Contact Person ";
	let contactName = document.getElementById("personName").value;
	let contactDetailsX = 7;
	
	doc.setFont("helvetica","bold");
	doc.text(`Contact Details:`, contactDetailsX, contactY + 5);
	
	
	//contact name
	let contactDetailsTextWidth = doc.getTextWidth("Contact Details");
	let honorificForContactPerson = document.getElementById("contact_person_honorifics").value;
	//contactDetailsX += contactDetailsTextWidth;
	doc.setFont("helvetica", "normal");
	doc.text(honorificForContactPerson + " " +contactName,contactDetailsX + contactDetailsTextWidth + 2,contactY + 5);
	
	// Get the width of the contactName text
	let contactNameAndHonor = honorificForContactPerson + " " +contactName;
	let contactPersonTextWidth = doc.getTextWidth(contactNameAndHonor);		
	doc.setFont("helvetica", "bold");
	doc.text("|",  contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 3,contactY + 5);
	
	// contact person mobile no
	doc.setFont("helvetica", "normal");
	let mobilNo = document.getElementById("contactDetails").value;
	doc.text(mobilNo,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 6,contactY + 5);
	
	let ContactPersonmobilNoTextWidth = doc.getTextWidth(mobilNo); 
	doc.setFont("helvetica", "bold");
	doc.text("|", contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 9,contactY + 5);
	
	//email Id
	let email = document.getElementById("emailId").value;
	doc.setFont("helvetica", "normal");
	doc.text(email ,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 12,contactY + 5);
	
	let msLabelWidthh = doc.getTextWidth(msLabell);
	doc.setFont("helvetica", "normal");
	// doc.text(document.getElementById("personName").value, 15 + msLabelWidthh + 5, contactY);
	
	// ------------------ Mobile Number ------------------
	let mobileY = contactY + lineHeight1;
	doc.setFont("helvetica");
	let gstLabell = "Mobile Number ";
	//doc.text(`Mobile Number :${document.getElementById("contactDetails").value}`, 7, mobileY + 5);
	let gstLabelWidthh = doc.getTextWidth(gstLabell);
	doc.setFont("helvetica", "normal");
	//doc.text(document.getElementById("contactDetails").value, 15 + gstLabelWidthh + 5, mobileY);
	
	// ------------------ Email ID ------------------
	
	doc.setFont("helvetica");
	let gstLabelll = "Email ID ";
	//doc.text(`Email ID            :${document.getElementById("emailId").value}`, 7, emailY + 5);
	let gstLabelWidthhh = doc.getTextWidth(gstLabelll);
	doc.setFont("helvetica", "normal");
	//doc.text(document.getElementById("emailId").value, 15 + gstLabelWidthhh + 17, emailY);
    
	
	// dear sir / madam
	//let Y = contactY + 10;
	let YAfterContactPerson = contactY + 13;
	doc.setFont("helvetica","bold");
	doc.text("Dear Sir / Madam", 7,YAfterContactPerson);
	doc.setFont("helvetica","normal");
	doc.text("We thank for your enquiry and have pleasure in submitting our quotation as below  for you kind consideration.", 9, YAfterContactPerson + 5);
				        
	// shipping address box position
	const boxX = 105;
	const boxY = 48;
	const boxWidth = 101.5;
	
	// Font settings
	doc.setFont("helvetica", "bold");
	doc.setFontSize(10);
	
	// ------------------ Address ------------------
	let addressLabell = "Address ";
	//doc.text(addressLabell, 110, 65);
	let addressLabelWidthh = doc.getTextWidth(addressLabell);
	doc.setFont("helvetica", "normal");
	
	let addressTextt = document.getElementById("deliveryAddress").value;
	let maxWidthh = 60;
	let addressLiness = doc.splitTextToSize(addressTextt, maxWidthh);
	let addressXx = 110 + addressLabelWidthh + 16;
	let addressYy = 65;
	
	//let lineHeight1 = 5;
	/* for (let i = 0; i < addressLiness.length; i++) {
	    //doc.text(addressLiness[i], addressXx, addressYy);
	    addressYy += lineHeight1;
	} */
	
	 
	// ------------------ Dynamically draw the box ------------------
	// The height is from boxY to the final Y position used + padding
	const dynamicBoxHeight = (YAfterContactPerson + lineHeight1) - boxY;
	
	
	
	// doc.rect(boxX, boxY, boxWidth, dynamicBoxHeight); // 🟦 dynamic height box
		        
    //doc.setFontSize(14);
    //doc.rect(3, emailY + 25, 203.5, 10);        
   // doc.text("Product Details", 107, emailY + 30, { align: "center" }  );
    
    const headers = [
        "S.No", "Part Number", "HSN Code", "Description",
        "Quantity", "Price", "Total"
    ];

 // Fetch table data and fix row count to 5
    let tableData = [];
    let rowIndex = 1;

    document.querySelectorAll("#productTableBody tr").forEach((row, idx) => {
        if (idx < 4) { // Limit to 5 rows max
            let cells = row.querySelectorAll("td");
            tableData.push([
                rowIndex.toString(),
                cells[2]?.textContent || "-", //part no
                cells[1]?.textContent || "-", //HSN No
                cells[3]?.textContent || "-",
                cells[4]?.textContent || "-",
                cells[5]?.textContent || "-" ,
                cells[6]?.textContent || "-" 
            ]);
            rowIndex++;
        }
    });
    
   // ✅ Move this before drawing the rows
    while (tableData.length < 4) {
        tableData.push([
            rowIndex.toString(), "", "", "", "", "", ""
        ]);
        rowIndex++;
    }
   
    // Define table starting position
    let startX = 3, startY = YAfterContactPerson + 10;  
    let colWidths = [10, 25, 22, 78.5, 20, 25, 23]; // Column widths
    let rowHeight = 8; // Row height
    doc.setFillColor(211, 211, 211); // Light grey background
    doc.setFont("helvetica", "bold"); // Bold text
    doc.setFontSize(11);

    // Draw table headers
    let currentX = startX;
    headers.forEach((header, index) => {
        doc.rect(currentX, startY, colWidths[index], rowHeight); // Draw cell border
        doc.text(header, currentX + colWidths[index] / 2, startY + 5, { align: 'center' });
        currentX += colWidths[index];
    });
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    
    let { total, tax, finalAmount, aggregateCgst, aggregateSgst, aggregateIgst } = calculateTotalFromTable();
    let amountInWords = numberToWords(total);
    
    	
        // Draw table rows
		let currentY = startY + rowHeight;
		let cellPadding = 2; // Padding inside the cell

		// MSPL_CONNECT(2301-1529-Admin)/src/main/resources/static/assets/font/NotoSans-Regular.ttf
		// assets/img/eye_icons.png
		doc.addFont("assets/font/NotoSans-Regular.ttf", "NotoSans", "normal");
		doc.setFont("NotoSans");
		
		tableData.forEach(row => {
		    let currentX = startX;
		    let maxRowHeight = rowHeight;

		    // Calculate row height based on content
		    let cellHeights = row.map((cell, index) => {
		        let textWithSymbol = (index === 5 || index === 6) && cell ?  "₹ " + formatNumber(cell) : cell;
		        
		        let textLines = doc.splitTextToSize(textWithSymbol, colWidths[index] - (cellPadding * 2));
		        return textLines.length * 5 + (cellPadding * 2);
		    });

		    maxRowHeight = Math.max(...cellHeights);

		    row.forEach((cell, index) => {
		    	
		        let formattedCell = (index === 5 || index === 6) && cell ? "₹ " + formatNumber(cell) : cell;

				let textLines = doc.splitTextToSize(formattedCell, colWidths[index] - (cellPadding * 2));
		        doc.rect(currentX, currentY, colWidths[index], maxRowHeight);

		        let textX = currentX + cellPadding;
		        let alignOption = "left";

		        if (index === 4) {  
		            textX = currentX + colWidths[index] / 2; // Center of the column
		            alignOption = "center";
		        }

		        if (index === 5 || index === 6) {  
		            textX = currentX + colWidths[index] - cellPadding;
		            alignOption = "right";
		        }

		        let textY = currentY + cellPadding + 3;

		        textLines.forEach((line, lineIndex) => {
		            doc.text(line, textX, textY + (lineIndex * 5), { align: alignOption });
		        });

		        currentX += colWidths[index];
		    });

		    currentY += maxRowHeight;
		});

		
		// Draw cells
		let totalColSpan = colWidths.length - 1;
		let totalLabelWidth = 0;
		for (let i = 0; i < totalColSpan; i++) {
		    totalLabelWidth += colWidths[i];
		}
		
		// ✅ Add totals row
		let totalRowY = currentY;
		let totalLabel = "Taxable Amount:";
		let totalValue = `${total}`;
		
		// Set Y position below the table
        let leftY = currentY + 5; // Add padding after the table
        let rightY = currentY; // Add padding after the table
        let bankDetailsYval = leftY - 5; // this is to start amount in worlds after bank details rec ends,
        //doc.rect(3, leftY - 5, 102, 23);     
     
        let bankText = "Bank Details";
        let bankX = 5;
        let bankY = leftY;

        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text(bankText, bankX, bankY);
        
        // Underline by drawing a line under the text
        let textWidth1 = doc.getTextWidth(bankText);
        doc.setLineWidth(0.5); // optional: set thickness of underline
        doc.line(bankX, bankY + 1, bankX + textWidth1, bankY + 1);
        
        leftY += 5
        doc.setFont("helvetica", "normal");
        doc.text("Bank Name: HDFC Bank", 5, leftY);
        leftY += 5
        doc.text("Branch Name:BANGALORE - SESHADRIPURAM", 5, leftY);
        leftY += 5
        doc.text("Bank Account Number: 03677630001106", 5, leftY);
        leftY += 5
        doc.text("Bank IFSC Code: HDFC0000367", 5, leftY);
        
		// Label cell (spans multiple columns)
		//doc.rect(startX, totalRowY, totalLabelWidth, rowHeight);
		doc.text(totalLabel, startX + totalLabelWidth , totalRowY + 5, { align: 'right' });
		
		// Value cell
		//doc.rect(startX + totalLabelWidth, totalRowY, colWidths[colWidths.length - 1], rowHeight);
		// Value cell - RIGHT aligned
		let totalColWidth = colWidths[colWidths.length - 2];
		let totalColRightX = startX + totalLabelWidth + totalColWidth - 5;
		//let totalamouttextWidth = doc.textWidth(totalValue);
		
		doc.setFont("NotoSans");			
		doc.text(`₹ ${totalValue}`, totalColRightX, totalRowY + 5, { align: 'right' });
		
		
		doc.setFont("helvetica", "normal");
		doc.setLineWidth(0.2);
		// doc.rect(105, rightY, 101.5, 23);   
		
		/* 
		if(`${aggregateCgst}` > 0){		
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let aggregateCgsttLabel = "Added CGST:";
			let aggregateCgsttValue = `${aggregateCgst}`;
			
			// Extra row - Label cell (merged columns)
			doc.text(aggregateCgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
	  		
			// Extra row - Value cell (last column)
			// Adjust the X position accordingly
			doc.text(aggregateCgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
        }
		if(`${aggregateSgst}` > 0){	
			
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let aggregateSgsttLabel = "Added SGST:";
			let aggregateSgsttValue = `${aggregateSgst}`;
			
			// Extra row - Label cell (merged columns)
			doc.text(aggregateSgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
	  		
			// Adjust the X position accordingly
			doc.text(aggregateSgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
			
        }
	
		if(`${aggregateIgst}` > 0){
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let aggregateIgstLabel = "Added IGST:";
			let aggregateIgstValue = `${aggregateIgst}`;
			
			// Extra row - Label cell (merged columns)
			doc.text(aggregateIgstLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
	  		
			// Extra row - Value cell (last column)
			// Adjust the X position accordingly
			doc.text(aggregateIgstValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
			
		}
		 */
		// Move Y for next content
		currentY += 5;
		// Define labels and values for the new row
		let totalAmountAfterTaxtLabel = "Total Amount After Tax:";
		let totalAmountAfterTaxValue = `${total}`;
		
		// Extra row - Label cell (merged columns)
		doc.setFont("helvetica", "bold");
		//doc.text(totalAmountAfterTaxtLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		
		// Adjust the X position accordingly
		// doc.text(totalAmountAfterTaxValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
		// Move Y for next content
		currentY += 5;
		// Move Y for next content
		currentY += 5;
		
		
		// Move Y for next content
		currentY += 5;
		// Track the Y position for the "Total in Words" section
		//let totalInWordsYStart = currentY;  
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		doc.setLineWidth(0.2); // Reset to default line thickness before drawing the final box
		
		// Draw the rectangle for total in words
		const totalInWordsHeight = 8;
		doc.rect(3, 27 + bankDetailsYval, 203.5, totalInWordsHeight); // rec start from banckdedetailsYstartFrom + height of the rect
		
		// Draw the text inside the box (vertically center text)
		const textY = 27 + bankDetailsYval + totalInWordsHeight / 2 + 1.5; // +2 for visual alignment
		doc.text(`Total in Words: ${amountInWords}`, 105, textY, { align: "center" });
    
    let termsAndConYAxis = 23 + bankDetailsYval + 17; // height of bank details rec + bankDetails rec Y axis start position + gap between ampunt in words and terms and condistions

    //doc.setFont("helvetica", "bold");
    //doc.setFontSize(10);
    //doc.setMarginTop(20);
    //doc.text(`Terms And Condition:`, 5, termsAndConYAxis);
    
    // Set bold font
	doc.setFont("helvetica", "bold");
	doc.setFontSize(10);
	 

	// Get text from textarea
	let termsTextRaw = $('#terms_and_condition').val().trim();
	
	let currentLine = "";
	let indentX = 5; // Default indentation
	let paragraphSpacing = 4; // Line spacing

	let maxWidth1 = 195; // Reduce max width for wrapping text (adjusted from 170 to 150)

	// Split by new lines and wrap the text
	let termsLines = doc.splitTextToSize(termsTextRaw, maxWidth1);
	
	// Set font for title
	doc.setFont("helvetica", "bold");
	doc.setFontSize(10);
	doc.text("Terms And Condition:", 5, termsAndConYAxis);

	// Underline the title
	const titleWidth = doc.getTextWidth("Terms And Condition:");
	doc.setLineWidth(0.3);
	doc.line(5, termsAndConYAxis + 1, 5 + titleWidth, termsAndConYAxis + 1);

	termsAndConYAxis += 6; // Move to next line after title

	// Set normal font for content
	doc.setFont("helvetica", "normal");
	

	termsLines.forEach((line, index) => {
	    let trimmedLine = line.trim();
	    let wrappedText = doc.splitTextToSize(trimmedLine, maxWidth1);

	    // Check if the line starts with a number (new main point)
	    if (/^\d+\./.test(trimmedLine)) {
	        if (currentLine !== "") {
	            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
	            wrappedCurrent.forEach((text, i) => {
	                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
	                termsAndConYAxis += paragraphSpacing;
	            });
	        }
	        currentLine = trimmedLine;
	        indentX = 5; // Reset indentation for main points
	    } 
	    // Check if line starts with a sub-point (e.g., "i)", "ii)")
	    else if (/^\s*[a-z]+\)/.test(trimmedLine)) {
	        if (currentLine !== "") {
	            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
	            wrappedCurrent.forEach((text, i) => {
	                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
	                termsAndConYAxis += paragraphSpacing;
	            });
	        }
	        indentX = 10; // Set indentation for sub-points
	        currentLine = trimmedLine;
	    } 
	    // Otherwise, it's a continuation of the same point
	    else {
	        currentLine += " " + trimmedLine;
	    }

	    // If it's the last line, print it
	    if (index === termsLines.length - 1) {
	        let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
	        wrappedCurrent.forEach((text, i) => {
	            doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis);
	            termsAndConYAxis += paragraphSpacing;
	        });
	    }
	});


	// Save the document
	//doc.save("TermsAndConditions.pdf");

	
	
	
	 
    doc.setFontSize(8);
    //doc.setTextColor(100); // Optional: subtle gray
    doc.text("*This is a computer-generated quotation, no seal and signature required", 105, 292, { align: "center" });
    
    //};

    // Convert PDF to Blob
    const pdfBlob = new Blob([doc.output("arraybuffer")], { type: "application/pdf" });

    const formData = new FormData();
    formData.append("from", fromAddress);
    formData.append("to", toAddress);
    formData.append("cc", ccAddress);
    formData.append("subject", subjectName);
    formData.append("message", bodyContent);
    formData.append("password", enteredPaswword);
    formData.append("file", pdfBlob, "Quotation.pdf"); // Append blob with filename
    formData.append("quotationId", quotationId);

    $.ajax({
        type: "POST",
        url: "/sendEmailToTheCustomerWithAttachment",
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            //alert(response);
            hideLoadingPopup();
            closeSendEmailForCustomerOuterDiv();
            $('#email_send_button').text("Email Sent to Customer");
            $('#quotationReviewApproveBtn').text("Email Sent to Customer");
            Swal.fire({ icon: 'success', title: "Delivered", text: response });
        },
        error: function(xhr) {
            alert("Error: " + xhr.responseText);
            hideLoadingPopup();
        }
    });
}

document.getElementById("emailManuallySentCheckBox").addEventListener("change", function () {
    let quotationId = $('#qid').val();
    let isChecked = this.checked; // Store the checked state before the AJAX call

    $.ajax({
        url: '/retrieveEmailSentFlagStatusValue',
        type: 'GET',
        data: { quotationId: quotationId },
        contentType: 'application/json', // Specify content type
        success: function (data) {
            if (data !== "1") {
                let emailStatusFlag = isChecked ? "2" : "0"; // Determine flag based on checkbox state

                $.ajax({
                    type: "POST",
                    url: "/updateEmailSentMailStatusForManuallySentByTheAdmin",
                    data: {
                        emailStatusFlag: emailStatusFlag,
                        quotationId: quotationId
                    },
                    success: function (response) {
                        console.log(response);
                    },
                    error: function (xhr) {
                        alert("Error: " + xhr.responseText);
                    }
                });
                
                if(emailStatusFlag === "0"){
                	$('#email_send_button').text("Send");
                    $('#email_send_button').prop("disabled", false);
                    $('#email_send_button').text("Send");
                    $('#downloadPdfManuallyBtn').css("display", "none");
                    $('#quotationReviewApproveBtn').text("Approve");
                }else{
                	$('#email_send_button').text("Sent");
                    $('#email_send_button').prop("disabled", true);
                    $('#email_send_button').text("Manually Sent");
                    $('#downloadPdfManuallyBtn').css("display", "block");
                    $('#quotationReviewApproveBtn').text("Manually Sent");
                }                	
            } else {
                $('#emailManuallySentCheckBox').prop("checked", false);
                $('#email_send_button').text("Send");
                $('#email_send_button').prop("disabled", false);
                alert("The email has already been sent to the customer using the send button!");
            }
        },
        error: function (xhr, status, error) {
            console.error('Failed to get email sent status flag:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
});
</script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        var rawDateTime = document.getElementById("qdateTime").value;
        
        // Draw Page Border
        doc.setDrawColor(0); // Black Border
        //doc.rect(3, 3, 203.5, 330); // (x, y, width, height)
        doc.rect(3, 3, 203.5, 291); // 297 - 6 for padding

        let mainY = 33;
     	// ✅ HEADER BAR
       	doc.setDrawColor(0); // Black border
        doc.rect(3, 3, 203.5, mainY); // Header box

        // ✅ Add Company Address (Left Side)
        doc.setTextColor(0); // Black text
        doc.setFont("helvictica","bold");
        doc.setFontSize(12);
        doc.text("Melange Systems Private Limited", 7, 10);
        doc.setFontSize(10);
        
        doc.setFont("helvictica","normal");

        doc.setFontSize(10);
        doc.text("(ISO 9001:2015 Certified Company)", 7, 15);
        
        doc.text("4/1, 7th cross, Kumara Park West, Bangalore, Karnataka - 560020", 7, 20);
        //doc.text("Bangalore, Karnataka - 560020", 10,18.5);
        doc.text("Phone: +91 8023561023", 7, 25);
        
        doc.setFont("helvetica", "bold");
        doc.text("GSTIN: 29AACCM4737H1ZA", 7,30, );
        
        doc.text("Udyan Ref No: UDYAM-KR-03-0101576", 7, 35, );
        doc.setFont("helvetica", "normal");
        // ✅ Add Company Logo (Right Side)
       	let logo = new Image();
        logo.src = "/assets/img/logo.png";
        
        logo.onload = function () {
        doc.addImage(logo, "PNG", 150, 10, 50, 18); // (image, type, x, y, width, height)        

        // Title
        doc.setFontSize(16);

	     // Draw the centered text
	     let title = "QUOTE";
	     let centerX = 105;
	     let textY1 = mainY + 10;
	     doc.setFont("helvetica", "bold"); 
	     doc.text(title, centerX, textY1, { align: "center" });
	
	     // Measure the width of the text
	     let textWidth2 = doc.getTextWidth(title);
	
	     // Draw underline manually (a horizontal line below the text)
	     let underlineY = textY1 + 1; // slightly below the text
	     doc.line(centerX - textWidth2 / 2, underlineY, centerX + textWidth2 / 2, underlineY);

        
        
        
        // doc.setFont("helvetica", "normal");
        //doc.rect(3, 28, 203.5, 10); // Horizontal Line
        
        
        
        // quotation Id dddaaaattteee 
        doc.setFontSize(12);
        //doc.rect(3, 38, 203.5, 10);
        
        doc.text("To,", 7, mainY + 15);
        mainY += 10
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal"); 
        doc.text(document.getElementById("qid").value, 160, mainY + 7);
        
        
        if (rawDateTime) {
            var date = new Date(rawDateTime);
            var day = String(date.getDate()).padStart(2, '0');
            var month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based
            var year = date.getFullYear();
            var formattedDate = `${day}-${month}-${year}`;

            doc.text(formattedDate, 160, mainY + 12);
        }  
        
        //doc.rect(3, 38, 203.5, 60); // Horizontal Line
        //doc.line(105, 48, 105, 98); 
        
        doc.setFont("helvetica", "bold");
        //doc.text("Billing Address", 10, 54  ); 
        //doc.text("Shipping Address", 129, 54  );  
        //doc.rect(3, 48, 102, 10);  // Left Header Box
        //doc.rect(105, 48, 101.5, 10); // Right Header Box
        
        doc.setFont("helvetica", "bold"); 
        doc.setFontSize(10);
		
        let billingAndShippengAddY = mainY + 12;
        
        // Billing Address Section
        // ✅ M/S (Bold) + Vendor Name (Normal) on the Same Line
        let msLabel = document.getElementById("company_honorifics").value;
        
        doc.setFont("helvetica", "bold");
        doc.text(msLabel, 12, billingAndShippengAddY);
        let msLabelWidth = doc.getTextWidth(msLabel);
        doc.setFont("helvetica", "bold");
        doc.text(document.getElementById("vendorlegalNamee").value, msLabelWidth + 12, billingAndShippengAddY); 
		
        
        
        // ✅ Address (Bold) + Address Text (Normal, Wrapped Properly)
        doc.setFont("helvetica", "bold");
        let addressLabel = "Address ";
        //doc.text(addressLabel, 10, billingAndShippengAddY + 6);
        let addressLabelWidth = doc.getTextWidth(addressLabel);
        doc.setFont("helvetica", "normal");

        let addressText = document.getElementById("shipmentAddress").value;
        let maxWidth = 65;
        let addressLines = doc.splitTextToSize(addressText, maxWidth);
        let addressX = addressLabelWidth;
        let addressY = billingAndShippengAddY + 6;

        // Print wrapped address lines
        let lineHeight = 5; // Adjust if your font size changes
        for (let i = 0; i < addressLines.length; i++) {
            doc.text(addressLines[i], addressX - 3, addressY + (i * lineHeight));
        }  

        // ✅ Dynamically Position GSTIN After Address
        let gstY = addressY + (addressLines.length * lineHeight) + 1; // Extra 5px padding after address
        doc.setFont("helvetica"); 
        let gstLabel = "GSTIN";
        //doc.text(gstLabel, 15, gstY);
        
        doc.text(`GSTIN ${document.getElementById("gstnumberr").value}`, 12, gstY);
        
        let gstLabelWidth = doc.getTextWidth(gstLabel);
        doc.setFont("helvetica", "normal");
        //doc.text(document.getElementById("gstnumberr").value, 10 + gstLabelWidth + 9.5, gstY);
        
        let lineHeight1 = 5;
        
        // ------------------ Contact Person ------------------ 
		let contactY = gstY + 2;
		let msLabell = "Contact Person ";
		let contactName = document.getElementById("personName").value;
		let contactDetailsX = 7;
		
		doc.setFont("helvetica","bold");
		doc.text(`Contact Details:`, contactDetailsX, contactY + 5);
		
		
		//contact name
		let contactDetailsTextWidth = doc.getTextWidth("Contact Details");
		let honorificForContactPerson = document.getElementById("contact_person_honorifics").value;
		//contactDetailsX += contactDetailsTextWidth;
		doc.setFont("helvetica", "normal");
		doc.text(honorificForContactPerson + " " +contactName,contactDetailsX + contactDetailsTextWidth + 2,contactY + 5);
		
		// Get the width of the contactName text
		let contactNameAndHonor = honorificForContactPerson + " " +contactName;
		let contactPersonTextWidth = doc.getTextWidth(contactNameAndHonor);		
		doc.setFont("helvetica", "bold");
		doc.text("|",  contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 3,contactY + 5);
		
		// contact person mobile no
		doc.setFont("helvetica", "normal");
		let mobilNo = document.getElementById("contactDetails").value;
		doc.text(mobilNo,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 6,contactY + 5);
		
		let ContactPersonmobilNoTextWidth = doc.getTextWidth(mobilNo); 
		doc.setFont("helvetica", "bold");
		doc.text("|", contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 9,contactY + 5);
		
		//email Id
		let email = document.getElementById("emailId").value;
		doc.setFont("helvetica", "normal");
		doc.text(email ,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 12,contactY + 5);
		
		let msLabelWidthh = doc.getTextWidth(msLabell);
		doc.setFont("helvetica", "normal");
		// doc.text(document.getElementById("personName").value, 15 + msLabelWidthh + 5, contactY);
		
		// ------------------ Mobile Number ------------------
		let mobileY = contactY + lineHeight1;
		doc.setFont("helvetica");
		let gstLabell = "Mobile Number ";
		//doc.text(`Mobile Number :${document.getElementById("contactDetails").value}`, 7, mobileY + 5);
		let gstLabelWidthh = doc.getTextWidth(gstLabell);
		doc.setFont("helvetica", "normal");
		//doc.text(document.getElementById("contactDetails").value, 15 + gstLabelWidthh + 5, mobileY);
		
		// ------------------ Email ID ------------------
		
		doc.setFont("helvetica");
		let gstLabelll = "Email ID ";
		//doc.text(`Email ID            :${document.getElementById("emailId").value}`, 7, emailY + 5);
		let gstLabelWidthhh = doc.getTextWidth(gstLabelll);
		doc.setFont("helvetica", "normal");
		//doc.text(document.getElementById("emailId").value, 15 + gstLabelWidthhh + 17, emailY);
        
		
		// dear sir / madam
		//let Y = contactY + 10;
		let YAfterContactPerson = contactY + 13;
		doc.setFont("helvetica","bold");
		doc.text("Dear Sir / Madam", 7,YAfterContactPerson);
		doc.setFont("helvetica","normal");
		doc.text("We thank for your enquiry and have pleasure in submitting our quotation as below  for you kind consideration.", 9, YAfterContactPerson + 5);
					        
		// shipping address box position
		const boxX = 105;
		const boxY = 48;
		const boxWidth = 101.5;
		
		// Font settings
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		
		// ------------------ Address ------------------
		let addressLabell = "Address ";
		//doc.text(addressLabell, 110, 65);
		let addressLabelWidthh = doc.getTextWidth(addressLabell);
		doc.setFont("helvetica", "normal");
		
		let addressTextt = document.getElementById("deliveryAddress").value;
		let maxWidthh = 60;
		let addressLiness = doc.splitTextToSize(addressTextt, maxWidthh);
		let addressXx = 110 + addressLabelWidthh + 16;
		let addressYy = 65;
		
		//let lineHeight1 = 5;
		/* for (let i = 0; i < addressLiness.length; i++) {
		    //doc.text(addressLiness[i], addressXx, addressYy);
		    addressYy += lineHeight1;
		} */
		
		 
		// ------------------ Dynamically draw the box ------------------
		// The height is from boxY to the final Y position used + padding
		const dynamicBoxHeight = (YAfterContactPerson + lineHeight1) - boxY;
		
		
		
		// doc.rect(boxX, boxY, boxWidth, dynamicBoxHeight); // 🟦 dynamic height box
			        
        //doc.setFontSize(14);
        //doc.rect(3, emailY + 25, 203.5, 10);        
       // doc.text("Product Details", 107, emailY + 30, { align: "center" }  );
        
        const headers = [
            "S.No", "Part Number", "HSN Code", "Description",
            "Quantity", "Price", "Total"
        ];

     // Fetch table data and fix row count to 5
        let tableData = [];
        let rowIndex = 1;

        document.querySelectorAll("#productTableBody tr").forEach((row, idx) => {
            if (idx < 4) { // Limit to 5 rows max
                let cells = row.querySelectorAll("td");
                tableData.push([
                    rowIndex.toString(),
                    cells[2]?.textContent || "-", //part no
                    cells[1]?.textContent || "-", //HSN No
                    cells[3]?.textContent || "-",
                    cells[4]?.textContent || "-",
                    cells[5]?.textContent || "-" ,
                    cells[6]?.textContent || "-" 
                ]);
                rowIndex++;
            }
        });
        
       // ✅ Move this before drawing the rows
        while (tableData.length < 4) {
            tableData.push([
                rowIndex.toString(), "", "", "", "", "", ""
            ]);
            rowIndex++;
        }
       
        // Define table starting position
        let startX = 3, startY = YAfterContactPerson + 10;  
        let colWidths = [10, 25, 22, 78.5, 20, 25, 23]; // Column widths
        let rowHeight = 8; // Row height
        doc.setFillColor(211, 211, 211); // Light grey background
        doc.setFont("helvetica", "bold"); // Bold text
        doc.setFontSize(11);

        // Draw table headers
        let currentX = startX;
        headers.forEach((header, index) => {
            doc.rect(currentX, startY, colWidths[index], rowHeight); // Draw cell border
            doc.text(header, currentX + colWidths[index] / 2, startY + 5, { align: 'center' });
            currentX += colWidths[index];
        });
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        
        let { total, tax, finalAmount, aggregateCgst, aggregateSgst, aggregateIgst } = calculateTotalFromTable();
        let amountInWords = numberToWords(total);
        
        	
            // Draw table rows
			let currentY = startY + rowHeight;
			let cellPadding = 2; // Padding inside the cell

			// MSPL_CONNECT(2301-1529-Admin)/src/main/resources/static/assets/font/NotoSans-Regular.ttf
			// assets/img/eye_icons.png
			doc.addFont("assets/font/NotoSans-Regular.ttf", "NotoSans", "normal");
			doc.setFont("NotoSans");
			
			tableData.forEach(row => {
			    let currentX = startX;
			    let maxRowHeight = rowHeight;

			    // Calculate row height based on content
			    let cellHeights = row.map((cell, index) => {
			        let textWithSymbol = (index === 5 || index === 6) && cell ?  "₹ " + formatNumber(cell) : cell;
			        
			        let textLines = doc.splitTextToSize(textWithSymbol, colWidths[index] - (cellPadding * 2));
			        return textLines.length * 5 + (cellPadding * 2);
			    });

			    maxRowHeight = Math.max(...cellHeights);

			    row.forEach((cell, index) => {
			    	
			        let formattedCell = (index === 5 || index === 6) && cell ? "₹ " + formatNumber(cell) : cell;

					let textLines = doc.splitTextToSize(formattedCell, colWidths[index] - (cellPadding * 2));
			        doc.rect(currentX, currentY, colWidths[index], maxRowHeight);

			        let textX = currentX + cellPadding;
			        let alignOption = "left";

			        if (index === 4) {  
			            textX = currentX + colWidths[index] / 2; // Center of the column
			            alignOption = "center";
			        }

			        if (index === 5 || index === 6) {  
			            textX = currentX + colWidths[index] - cellPadding;
			            alignOption = "right";
			        }

			        let textY = currentY + cellPadding + 3;

			        textLines.forEach((line, lineIndex) => {
			            doc.text(line, textX, textY + (lineIndex * 5), { align: alignOption });
			        });

			        currentX += colWidths[index];
			    });

			    currentY += maxRowHeight;
			});

			
			// Draw cells
			let totalColSpan = colWidths.length - 1;
			let totalLabelWidth = 0;
			for (let i = 0; i < totalColSpan; i++) {
			    totalLabelWidth += colWidths[i];
			}
			
			// ✅ Add totals row
			let totalRowY = currentY;
			let totalLabel = "Taxable Amount:";
			let totalValue = `${total}`;
			
			// Set Y position below the table
	        let leftY = currentY + 5; // Add padding after the table
	        let rightY = currentY; // Add padding after the table
	        let bankDetailsYval = leftY - 5; // this is to start amount in worlds after bank details rec ends,
	        //doc.rect(3, leftY - 5, 102, 23);     
	     
	        let bankText = "Bank Details";
	        let bankX = 5;
	        let bankY = leftY;

	        doc.setFontSize(10);
	        doc.setFont("helvetica", "bold");
	        doc.text(bankText, bankX, bankY);
	        
	        // Underline by drawing a line under the text
	        let textWidth1 = doc.getTextWidth(bankText);
	        doc.setLineWidth(0.5); // optional: set thickness of underline
	        doc.line(bankX, bankY + 1, bankX + textWidth1, bankY + 1);
	        
	        leftY += 5
	        doc.setFont("helvetica", "normal");
	        doc.text("Bank Name: HDFC Bank", 5, leftY);
	        leftY += 5
	        doc.text("Branch Name:BANGALORE - SESHADRIPURAM", 5, leftY);
	        leftY += 5
	        doc.text("Bank Account Number: 03677630001106", 5, leftY);
	        leftY += 5
	        doc.text("Bank IFSC Code: HDFC0000367", 5, leftY);
	        
			// Label cell (spans multiple columns)
			//doc.rect(startX, totalRowY, totalLabelWidth, rowHeight);
			doc.text(totalLabel, startX + totalLabelWidth , totalRowY + 5, { align: 'right' });
			
			// Value cell
			//doc.rect(startX + totalLabelWidth, totalRowY, colWidths[colWidths.length - 1], rowHeight);
			// Value cell - RIGHT aligned
			let totalColWidth = colWidths[colWidths.length - 2];
			let totalColRightX = startX + totalLabelWidth + totalColWidth - 5;
			//let totalamouttextWidth = doc.textWidth(totalValue);
			
			doc.setFont("NotoSans");			
			doc.text(`₹ ${totalValue}`, totalColRightX, totalRowY + 5, { align: 'right' });
			
			
			doc.setFont("helvetica", "normal");
			doc.setLineWidth(0.2);
			// doc.rect(105, rightY, 101.5, 23);   
			
			/* 
			if(`${aggregateCgst}` > 0){		
				// Move Y for next content
				currentY += 5;
				// Define labels and values for the new row
				let aggregateCgsttLabel = "Added CGST:";
				let aggregateCgsttValue = `${aggregateCgst}`;
				
				// Extra row - Label cell (merged columns)
				doc.text(aggregateCgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		  		
				// Extra row - Value cell (last column)
				// Adjust the X position accordingly
				doc.text(aggregateCgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
	        }
			if(`${aggregateSgst}` > 0){	
				
				// Move Y for next content
				currentY += 5;
				// Define labels and values for the new row
				let aggregateSgsttLabel = "Added SGST:";
				let aggregateSgsttValue = `${aggregateSgst}`;
				
				// Extra row - Label cell (merged columns)
				doc.text(aggregateSgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		  		
				// Adjust the X position accordingly
				doc.text(aggregateSgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
				
	        }
		
			if(`${aggregateIgst}` > 0){
				// Move Y for next content
				currentY += 5;
				// Define labels and values for the new row
				let aggregateIgstLabel = "Added IGST:";
				let aggregateIgstValue = `${aggregateIgst}`;
				
				// Extra row - Label cell (merged columns)
				doc.text(aggregateIgstLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		  		
				// Extra row - Value cell (last column)
				// Adjust the X position accordingly
				doc.text(aggregateIgstValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
				
			}
			 */
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let totalAmountAfterTaxtLabel = "Total Amount After Tax:";
			let totalAmountAfterTaxValue = `${total}`;
			
			// Extra row - Label cell (merged columns)
			doc.setFont("helvetica", "bold");
			//doc.text(totalAmountAfterTaxtLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
			
			// Adjust the X position accordingly
			// doc.text(totalAmountAfterTaxValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
			// Move Y for next content
			currentY += 5;
			// Move Y for next content
			currentY += 5;
			
			
			// Move Y for next content
			currentY += 5;
			// Track the Y position for the "Total in Words" section
			//let totalInWordsYStart = currentY;  
			doc.setFont("helvetica", "bold");
			doc.setFontSize(10);
			doc.setLineWidth(0.2); // Reset to default line thickness before drawing the final box
			
			// Draw the rectangle for total in words
			const totalInWordsHeight = 8;
			doc.rect(3, 27 + bankDetailsYval, 203.5, totalInWordsHeight); // rec start from banckdedetailsYstartFrom + height of the rect
			
			// Draw the text inside the box (vertically center text)
			const textY = 27 + bankDetailsYval + totalInWordsHeight / 2 + 1.5; // +2 for visual alignment
			doc.text(`Total in Words: ${amountInWords}`, 105, textY, { align: "center" });
        
        let termsAndConYAxis = 23 + bankDetailsYval + 17; // height of bank details rec + bankDetails rec Y axis start position + gap between ampunt in words and terms and condistions

        //doc.setFont("helvetica", "bold");
        //doc.setFontSize(10);
        //doc.setMarginTop(20);
        //doc.text(`Terms And Condition:`, 5, termsAndConYAxis);
        
        // Set bold font
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		 

		// Get text from textarea
		let termsTextRaw = $('#terms_and_condition').val().trim();
		
		let currentLine = "";
		let indentX = 5; // Default indentation
		let paragraphSpacing = 4; // Line spacing

		let maxWidth1 = 195; // Reduce max width for wrapping text (adjusted from 170 to 150)

		// Split by new lines and wrap the text
		let termsLines = doc.splitTextToSize(termsTextRaw, maxWidth1);
		
		// Set font for title
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		doc.text("Terms And Condition:", 5, termsAndConYAxis);

		// Underline the title
		const titleWidth = doc.getTextWidth("Terms And Condition:");
		doc.setLineWidth(0.3);
		doc.line(5, termsAndConYAxis + 1, 5 + titleWidth, termsAndConYAxis + 1);

		termsAndConYAxis += 6; // Move to next line after title

		// Set normal font for content
		doc.setFont("helvetica", "normal");
		

		termsLines.forEach((line, index) => {
		    let trimmedLine = line.trim();
		    let wrappedText = doc.splitTextToSize(trimmedLine, maxWidth1);

		    // Check if the line starts with a number (new main point)
		    if (/^\d+\./.test(trimmedLine)) {
		        if (currentLine !== "") {
		            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
		            wrappedCurrent.forEach((text, i) => {
		                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
		                termsAndConYAxis += paragraphSpacing;
		            });
		        }
		        currentLine = trimmedLine;
		        indentX = 5; // Reset indentation for main points
		    } 
		    // Check if line starts with a sub-point (e.g., "i)", "ii)")
		    else if (/^\s*[a-z]+\)/.test(trimmedLine)) {
		        if (currentLine !== "") {
		            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
		            wrappedCurrent.forEach((text, i) => {
		                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
		                termsAndConYAxis += paragraphSpacing;
		            });
		        }
		        indentX = 10; // Set indentation for sub-points
		        currentLine = trimmedLine;
		    } 
		    // Otherwise, it's a continuation of the same point
		    else {
		        currentLine += " " + trimmedLine;
		    }

		    // If it's the last line, print it
		    if (index === termsLines.length - 1) {
		        let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
		        wrappedCurrent.forEach((text, i) => {
		            doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis);
		            termsAndConYAxis += paragraphSpacing;
		        });
		    }
		});


		// Save the document
		//doc.save("TermsAndConditions.pdf");

		
		
		
		 
        doc.setFontSize(8);
        //doc.setTextColor(100); // Optional: subtle gray
        doc.text("*This is a computer-generated quotation, no seal and signature required", 105, 292, { align: "center" });

        // Save PDF
        doc.save("Quotation.pdf");
        };
    }
    function formatNumber(num) {
        if (!isNaN(num)) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        return num;  // Return as-is if it's not a number.
    }

 	// Function to calculate total and tax from table data
    function calculateTotalFromTable() {
    let totalSum = 0;
    let aggregateCgst = 0;
    let aggregateSgst = 0;
    let aggregateIgst = 0;
    let taxSum = 0;

    document.querySelectorAll(".hiddenProductDetailsTableBoxData tbody tr").forEach(row => {
        let total = parseFloat(row.children[4].innerText) || 0;
        let cgst = parseFloat(row.children[5].innerText) || 0;
        let sgst = parseFloat(row.children[6].innerText) || 0;
        let igst = parseFloat(row.children[7].innerText) || 0;

        console.log("total == " + total.toFixed(2));
        console.log("cgst == " + cgst.toFixed(2));
        console.log("sgst == " + sgst.toFixed(2));
        console.log("igst == " + igst.toFixed(2));

        // **Ensure decimal precision using precise addition**
        totalSum = (totalSum + total);

        console.log("totalSum == " + totalSum.toFixed(2));

        if (cgst === 0 && sgst === 0) {
            aggregateIgst = (aggregateIgst + igst);
            console.log("aggregateIgst == " + aggregateIgst.toFixed(2));

            taxSum = (taxSum + igst);
            console.log("taxSum == " + taxSum.toFixed(2));
        } else if (igst === 0) {
            aggregateCgst = (aggregateCgst + cgst);
            aggregateSgst = (aggregateSgst + sgst);

            console.log("aggregateCgst == " + aggregateCgst.toFixed(2));
            console.log("aggregateSgst == " + aggregateSgst.toFixed(2));

            taxSum = (taxSum + cgst + sgst);
            console.log("taxSum == " + taxSum.toFixed(2));
        }
    });

    let finalAmount = totalSum + taxSum;

    console.log("finalAmount == " + finalAmount.toFixed(2));

    return { 
        total: totalSum.toFixed(2), 
        tax: taxSum.toFixed(2), 
        finalAmount: finalAmount.toFixed(2), 
        aggregateCgst: aggregateCgst.toFixed(2), 
        aggregateSgst: aggregateSgst.toFixed(2), 
        aggregateIgst: aggregateIgst.toFixed(2) 
    };
}
    
    function numberToWords(num) {
        const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
        const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen",
                       "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
        const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

        function twoDigits(n) {
            if (n < 10) return ones[n];
            if (n < 20) return teens[n - 10];
            return tens[Math.floor(n / 10)] + (n % 10 ? " " + ones[n % 10] : "");
        }

        function threeDigits(n) {
            if (n < 100) return twoDigits(n);
            return ones[Math.floor(n / 100)] + " Hundred" + (n % 100 ? " " + twoDigits(n % 100) : "");
        }

        if (num === 0) return "Zero Only";

        let result = "";

        const crore = Math.floor(num / 10000000);
        num %= 10000000;
        if (crore) result += threeDigits(crore) + " Crore ";

        const lakh = Math.floor(num / 100000);
        num %= 100000;
        if (lakh) result += threeDigits(lakh) + " Lakh ";

        const thousand = Math.floor(num / 1000);
        num %= 1000;
        if (thousand) result += threeDigits(thousand) + " Thousand ";

        if (num > 0) result += (result !== "" ? "and " : "") + threeDigits(num);

        
        return result.trim() + " Only";
    }
 	
    $.ajax({
        url: '/returnRecentlyInsertedTermsAndConditionDetail',
        type: 'GET',
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	$('#terms_and_condition').val(data.terms_and_condition_data);
        },
        error: function(xhr, status, error) {
            console.error('Failed to get terms and condition details:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
    
    function forwardQuotationForReview(quotationId, flagStatusValue){
    	$.ajax({
            type: 'POST',
            url: '/updateReviewStatusForQuotationReview',
            data: {
                "reviewStatus": flagStatusValue,
                "quotationId": quotationId
            },
            success: function (response) {
                if (response === 'success') {
                	$('#quotationSubmitBtnForReview').text("Submitted");
                	$('#quotationSubmitBtnForReview').prop("disabled", true);
                	$('#reviseQuotationBtn').css("display", "block");
                	$('#quotationReviewApproveBtn').css("display", "block");
                	$('#quotationSubmitBtnForReview').css("display", "none");
                }
                
                if(flagStatusValue === 3){
            		$('#wonQuotationBtn').prop("disabled", true);
            		$('#terminateQuotationBtn').prop("disabled", false);
            		$('#quotationReviewApproveBtn').css("display", "none");
            		$('#reviseQuotationBtn').css("display", "none");
            		$('#quotationSubmitBtnForReview').css("display", "none");
            		$('#terminateQuotationBtn').css("display", "none");
            	}else if(flagStatusValue === 4){
            		$('#terminateQuotationBtn').prop("disabled", true);
            		$('#wonQuotationBtn').prop("disabled", false);
            		$('#quotationReviewApproveBtn').css("display", "none");
            		$('#reviseQuotationBtn').css("display", "none");
            		$('#quotationSubmitBtnForReview').css("display", "none");
            		$('#wonQuotationBtn').css("display", "none");
            	}
            },
            error: function (xhr, status, error) {
                console.error('Error updating quotation review status record:');
                console.log('XHR object:', xhr);
                console.log('Status:', status);
                console.log('Error:', error);
            }
        });    	
    }
</script>

<script>
function displayOnLoadingPopup(){
	$('#loadingPopup').show();
	$('#loadingPopupPara').text("Loading, please wait...");
}

function hideLoadingPopup(){
	$('#loadingPopup').hide();
}
</script>

<script>
let customers = [];
let selectedContacts = {}; // Stores contacts for each customer

document.addEventListener("DOMContentLoaded", function() {
    fetchCustomers();
});

function fetchCustomers() {
    fetch('/customers')
        .then(response => response.json())
        .then(data => {
            customers = data;
        })
        .catch(error => console.error('Error fetching customers:', error));
}

// Filter customer names based on input
document.getElementById("revise_vendorName").addEventListener("input", function() {
    const input = this.value.toLowerCase();
    const suggestionsBox = document.getElementById("revise_suggestionsBox");

    if (!input) {
        suggestionsBox.style.display = "none";
        return;
    }

    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(input)
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
    }

    // Store contacts globally and show suggestions
    suggestionsBox.innerHTML = filteredCustomers.map((customer, index) => {
        selectedContacts[index] = [
            { name: customer.c1, designation: customer.c11, mobile: customer.c111, email: customer.c1111, honorifics: customer.honorifics_1 },
            { name: customer.c2, designation: customer.c22, mobile: customer.c222, email: customer.c2222, honorifics: customer.honorifics_2 },
            { name: customer.c3, designation: customer.c33, mobile: customer.c333, email: customer.c3333, honorifics: customer.honorifics_3 }
        ].filter(contact => contact.name); // Remove empty contacts

        return `<div onclick="selectCustomer('${customer.name}', '${customer.legalName}', '${customer.gst}', '${customer.billing_address}', '${customer.delivery_address_1}', '${customer.delivery_address_2}', '${customer.delivery_address_3}', '${customer.honorifics_main}', '${index}')">${customer.name}</div>`;
    }).join("");

    suggestionsBox.style.display = "block";
});

// Select customer and populate fields
function selectCustomer(name, legalName, gst, billingAddresss, deliveryAddress1, deliveryAddress2, deliveryAddress3, mainHonorifics, index) {
    document.getElementById("revise_vendorName").value = name;
    document.getElementById("revise_vendorlegalNamee").value = legalName;
    document.getElementById("revise_gstnumberr").value = gst;
    document.getElementById("revise_shipmentAddress").value = billingAddresss; // Populate billing address
    document.getElementById("revise_company_honorifics").value = mainHonorifics;
    
 	// Get the dropdown element
    let deliverySelect = document.getElementById("revise_deliveryAddress");
    
    // Clear existing options
    deliverySelect.innerHTML = "<option value=''>Select Delivery Address</option>";

    // Array of delivery addresses
    let deliveryAddresses = [deliveryAddress1, deliveryAddress2, deliveryAddress3];

    // Add only non-null and non-empty addresses to the dropdown
    deliveryAddresses.forEach(address => {
        if (address && address.trim() !== "") {
            let option = document.createElement("option");
            option.value = address;
            option.textContent = address;
            deliverySelect.appendChild(option);
        }
    });

    populateContactsDropdown(selectedContacts[index]);

    document.getElementById("revise_suggestionsBox").style.display = "none";
}

// Populate contact dropdown dynamically
function populateContactsDropdown(contacts) {
    const contactDropdown = document.getElementById("revise_personName");
    contactDropdown.innerHTML = `<option value="">Select Contact Person</option>` +
        contacts.map(contact => `<option value="${contact.name}" data-designation="${contact.designation}" data-mobile="${contact.mobile}" data-email="${contact.email}" data-honorifics="${contact.honorifics}">${contact.name}</option>`).join("");
}

// Auto-fill details when selecting a contact person
document.getElementById("revise_personName").addEventListener("change", function() {
    const selectedOption = this.options[this.selectedIndex];
    
    document.getElementById("revise_deliveryAddress").value = "";

    if (selectedOption.value) {
    	document.getElementById("revise_contact_person_honorifics").value = selectedOption.dataset.honorifics;
        document.getElementById("revise_designation").value = selectedOption.dataset.designation || "";
        document.getElementById("revise_contactDetails").value = selectedOption.dataset.mobile || "";
        document.getElementById("revise_emailId").value = selectedOption.dataset.email || "";
    } else {
        clearContactFields();
    }
});

// Hide suggestions when clicking outside
document.addEventListener("click", function(event) {
    if (!event.target.closest("#revise_vendorName") && !event.target.closest("#revise_suggestionsBox")) {
        document.getElementById("revise_suggestionsBox").style.display = "none";
    }
});

// Select first suggestion on Enter
document.getElementById("revise_vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        const suggestionsBox = document.getElementById("revise_suggestionsBox");
        if (suggestionsBox.style.display === "block") {
            const firstSuggestion = suggestionsBox.querySelector("div");
            if (firstSuggestion) {
                firstSuggestion.click(); // Simulate a click on the first suggestion
                event.preventDefault(); // Prevent form submission
            }
        }
    }
});

// Clear all related fields on backspace when empty
document.getElementById("revise_vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Backspace" && this.value === "") {
        clearCustomerFields();
    }
});

// Clear customer fields
function clearCustomerFields() {
    document.getElementById("revise_vendorlegalNamee").value = "";
    document.getElementById("revise_gstnumberr").value = "";
    document.getElementById("revise_shipmentAddress").value = "";
    document.getElementById("revise_personName").innerHTML = `<option value="">Select Contact Person</option>`;
    clearContactFields();
}

// Clear contact person fields
function clearContactFields() {
    document.getElementById("revise_designation").value = "";
    document.getElementById("revise_contactDetails").value = "";
    document.getElementById("revise_emailId").value = "";
    document.getElementById("revise_contact_person_honorifics").value = "";
}

function copyAddress() {
    const shipmentAddress = document.getElementById("revise_shipmentAddress").value;
    const deliveryAddress = document.getElementById("revise_deliveryAddress");
    const sameAddress = document.getElementById("revise_sameAddress");

    if (sameAddress.checked) {
        deliveryAddress.value = shipmentAddress;
        deliveryAddress.setAttribute("readonly", true);
    } else {
        deliveryAddress.value = "";
        deliveryAddress.removeAttribute("readonly");
    }
}

let productCount = 0;
const GST_PERCENTAGE = 18; // Fixed 18% GST

function addProduct() {
    productCount++;
    const tableBody = document.getElementById("revise_productTableBody");
    //tableBody.innerHTML = ""; // Clear old data
    
    // Get selected values from dropdowns
    /* const productName = document.getElementById("productName").value;
    const hsnCode = document.getElementById("hsnCode").value;
    const partNumber = document.getElementById("partNumber").value;
    const productDescription = document.getElementById("productDescription").value; */
    
    const productName = document.getElementById("productDescription").value;
    const hsnCode = document.getElementById("partNumber").value;
    const partNumber = document.getElementById("productName").value;
    const productDescription = document.getElementById("hsnCode").value;
    
    // Get checkbox elements correctly
    const interState = document.getElementById("revise_interState");
    const outerState = document.getElementById("revise_outerState");
    
    //alert("productName== "+productName+" hsnCode === "+hsnCode+" partNumber === "+partNumber+" productDescription === "+productDescription);

    // Ensure values are selected before adding
    if (!productName || !hsnCode || !partNumber || !productDescription) {
        alert("Please select all product details before adding.");
        return;
    }
    
    if (!(interState.checked) && !(outerState.checked)) {
        alert("Please select Tax Type Before Adding Products.");
        return;
    }

    // Create a new row
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${productCount}</td>
        <td style="display: none;">${productName}</td>
        <td>${hsnCode}</td>
        <td>${partNumber}</td>
        <td>${productDescription}</td>
        <td><input type="number" style="width: 70px" class="form-control quantity" oninput="calculateTotal(this)"></td>
        <td><input type="number" style="width: 70px" class="form-control price" oninput="calculateTotal(this)"></td>
        <td class="total-without-gst">0.00</td>
        <td class="cgst-value">0.00</td>
        <td class="sgst-value">0.00</td>
        <td class="igst-value">0.00</td>
        <td class="total-with-gst">0.00</td>
        <td><button class="btn btn-outline-danger btn-sm" onclick="removeProduct(this)">Remove</button></td>
    `;

    tableBody.appendChild(row);
    
    // Apply tax selection logic
    applyGSTSelection();

    // Hide IGST column immediately after adding if Interstate is selected
    const igstCell = row.querySelector(".igst-value");
    if (interState.checked) {
        igstCell.style.display = "none"; // Hide IGST
        igstCell.innerText = ""; // Remove text
    }

    // Reset dropdown selections
    document.getElementById("productName").selectedIndex = 0;
    document.getElementById("hsnCode").selectedIndex = 0;
    document.getElementById("partNumber").selectedIndex = 0;
    document.getElementById("productDescription").selectedIndex = 0;
}


function removeProduct(button) {
    button.closest("tr").remove();
    productCount--;
    updateSlNumbers();
}

function updateSlNumbers() {
    document.querySelectorAll("#revise_productTableBody tr").forEach((row, index) => {
        row.cells[0].innerText = index + 1;
    });
}
 
// script to validate the quantity (how many quantity are already invoice is generated )
/*async function validateAndCalculate(input) {
	
    const row = input.closest("tr");
    const quantity = parseInt(input.value) || 0;
    
    const productId = row.querySelector('input[name="product_id[]"]').value;    
    const salesOrderId = document.getElementById('pi_po_id')?.value;
    const salesId = document.getElementById('salesId').value;
    
    // Skip if not enough data
    if (!productId || !salesOrderId || quantity <= 0) {
        return;
    }
 	
    try {
        const response = await fetch(`/purchase-invoice/check-quantity-valid?salesOrderId=${salesOrderId}&productId=${productId}&quantity=${quantity}&salesIndexId=${salesId}`);
        const data = await response.json();

        if (response.ok && data.valid) {
            calculateTotal(input);
        } else {
            alert(data.message || "Invalid quantity for this product.");
            input.value = ""; // Optionally reset
        }
    } catch (err) {
        console.error("Error checking quantity:", err);
        alert("Failed to validate quantity. Please try again.");
    }  
    
}*/

async function validateAndCalculate(input) {
    const row = input.closest("tr");
	
    const productId = row.querySelector('input[name="product_id[]"]').value;
    const salesOrderId = document.getElementById('pi_po_id')?.value;
    const salesId = document.getElementById('salesId').value;
	
    const quantityEl = row.querySelector('input[name="quantity[]"]');
    const dispatchedQtyEl = row.querySelector('.dispatched-qty');
    const remainingQtyEl = row.querySelector('.remaining-qty');
    
    const part_no = row.querySelector('input[name="part_no[]"]').value;
	
    if (!productId || !salesOrderId) return;
    
    try {
        const response = await fetch(`/purchase-invoice/check-quantity-valid?salesOrderId=${salesOrderId}&productId=${productId}&quantity=0&salesIndexId=${salesId}&salesIndexId=${salesId}&partNo=${part_no}`);
        const data = await response.json();

        const generatedQty = data.generatedQty ?? 0;
        const orderQty = data.orderQty ?? 0;
        const remainingQty = orderQty - generatedQty;

        // ✅ Set max allowed quantity as a data attribute
        quantityEl.dataset.remaining = remainingQty;
        
        // Set max allowed quantity as a data attribute
     	if (!quantityEl.value || quantityEl.value === "0") {
		    quantityEl.value = remainingQty;
		}

        if (dispatchedQtyEl) {
            dispatchedQtyEl.value = `${generatedQty} / ${orderQty}`;
        }

        if (remainingQtyEl) {
            remainingQtyEl.textContent = `Remaining: ${remainingQty}`;
        }

        if (response.ok && parseInt(quantityEl.value) <= remainingQty) {
            calculateTotal(input);
            
        }

    } catch (err) {
        console.error("Error checking quantity:", err);
    }
} 

async function validateAndCalculatePerformaInvoice(input) {
    const row = input.closest("tr");
	
    const productId = row.querySelector('input[name="product_id[]"]').value;
    const salesOrderId = document.getElementById('performa_po_id')?.value;
    const salesId = document.getElementById('performa_salesId').value;
	
    const quantityEl = row.querySelector('input[name="quantity[]"]');
    const dispatchedQtyEl = row.querySelector('.dispatched-qty');
    const remainingQtyEl = row.querySelector('.remaining-qty');
    
    const part_no = row.querySelector('input[name="part_no[]"]').value;
	
    if (!productId || !salesOrderId) return;
    
    try {
        const response = await fetch(`/purchase-invoice/check-performaInvoicequantity-valid?salesOrderId=${salesOrderId}&productId=${productId}&quantity=0&salesIndexId=${salesId}&salesIndexId=${salesId}&partNo=${part_no}`);
        const data = await response.json();

        const generatedQty = data.generatedQty ?? 0;
        const orderQty = data.orderQty ?? 0;
        const remainingQty = orderQty - generatedQty;

        // ✅ Set max allowed quantity as a data attribute
        quantityEl.dataset.remaining = remainingQty;
        
        // Set max allowed quantity as a data attribute
     	if (!quantityEl.value || quantityEl.value === "0") {
		    quantityEl.value = remainingQty;
		}

        if (dispatchedQtyEl) {
            dispatchedQtyEl.value = `${generatedQty} / ${orderQty}`;
        }

        if (remainingQtyEl) {
            remainingQtyEl.textContent = `Remaining: ${remainingQty}`;
        }

        if (response.ok && parseInt(quantityEl.value) <= remainingQty) {
            calculatePerformaTotal(input);
            
        }

    } catch (err) {
        console.error("Error checking quantity:", err);
    }
} 

function checkQuantityLimit(input) {
    const remaining = parseInt(input.dataset.remaining || "0");
    const entered = parseInt(input.value || "0");

    if (entered > remaining) {
        alert(`Entered quantity exceeds the remaining quantity of ${remaining}.`);
        input.value = remaining; // Reset to max allowed
    }
}


function calculateTotal(input) {
	//alert("hi");
	
    const row = input.closest("tr");
	
    // Correct selectors based on your HTML class names
    const quantityInput = row.querySelector('input[name="quantity[]"]');
    const priceInput = row.querySelector('input[name="price[]"]');
    const lineTotalInput = row.querySelector('input[name="line_total[]"]');
    const cgstInput = row.querySelector('input[name="cgst[]"]');
    const sgstInput = row.querySelector('input[name="sgst[]"]');
    const igstInput = row.querySelector('input[name="igst[]"]');
    const totalLineTotalInput = row.querySelector('input[name="total_line_total[]"]');

    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;

    let totalWithoutGST = quantity * price;
    let cgst = 0, sgst = 0, igst = 0, totalWithGST = totalWithoutGST;

    if (document.getElementById("pi_interState1")?.checked) {
        // Intrastate
        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        totalWithGST += cgst + sgst;

        cgstInput.value = cgst.toFixed(2);
        sgstInput.value = sgst.toFixed(2);
        igstInput.value = "0.00";
    } else if (document.getElementById("pi_outerState1")?.checked) {
        // Interstate
        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
        totalWithGST += igst;

        cgstInput.value = "0.00";
        sgstInput.value = "0.00";
        igstInput.value = igst.toFixed(2);
    }

    lineTotalInput.value = totalWithoutGST.toFixed(2);
    totalLineTotalInput.value = totalWithGST.toFixed(2);
    updateSummary();
}

function calculatePerformaTotal(input) {
	//alert("hi");
	
    const row = input.closest("tr");
	
    // Correct selectors based on your HTML class names
    const quantityInput = row.querySelector('input[name="quantity[]"]');
    const priceInput = row.querySelector('input[name="price[]"]');
    const lineTotalInput = row.querySelector('input[name="line_total[]"]');
    const cgstInput = row.querySelector('input[name="cgst[]"]');
    const sgstInput = row.querySelector('input[name="sgst[]"]');
    const igstInput = row.querySelector('input[name="igst[]"]');
    const totalLineTotalInput = row.querySelector('input[name="total_line_total[]"]');

    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;

    let totalWithoutGST = quantity * price;
    let cgst = 0, sgst = 0, igst = 0, totalWithGST = totalWithoutGST;

    if (document.getElementById("performa_interState1")?.checked) {
        // Intrastate
        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        totalWithGST += cgst + sgst;

        cgstInput.value = cgst.toFixed(2);
        sgstInput.value = sgst.toFixed(2);
        igstInput.value = "0.00";
    } else if (document.getElementById("performa_outerState1")?.checked) {
        // Interstate
        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
        totalWithGST += igst;

        cgstInput.value = "0.00";
        sgstInput.value = "0.00";
        igstInput.value = igst.toFixed(2);
    }

    lineTotalInput.value = totalWithoutGST.toFixed(2);
    totalLineTotalInput.value = totalWithGST.toFixed(2);
    updateSummaryPerformaInvoice();
}

function calculateTotalPriceValueAndTaxCalculationForRevisedPopup(quantityData, priceData){
	//alert(quantity+" "+price);
    const quantity = parseFloat(quantityData) || 0;
    const price = parseFloat(priceData) || 0;
    
    let totalWithoutGST = quantity * price;
    let cgst = 0, sgst = 0, igst = 0, totalWithGST = totalWithoutGST;

    if (document.getElementById("revise_interState").checked) {
        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        totalWithGST += cgst + sgst;
        document.querySelector(".cgst-value").innerText = cgst.toFixed(2);
        document.querySelector(".sgst-value").innerText = sgst.toFixed(2);
        document.querySelector(".igst-value").innerText = "—";
    } else if (document.getElementById("revise_outerState").checked) {
        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
        totalWithGST += igst;
        document.querySelector(".cgst-value").innerText = "—";
        document.querySelector(".sgst-value").innerText = "—";
        document.querySelector(".igst-value").innerText = igst.toFixed(2);
    }

    document.querySelector(".total-without-gst").innerText = totalWithoutGST.toFixed(2);
    document.querySelector(".total-with-gst").innerText = totalWithGST.toFixed(2);
}

/* function toggleGST(type) {
    if (type === "interState") {
        document.getElementById("outerState").checked = false;
    } else {
        document.getElementById("interState").checked = false;
    }

    applyGSTSelection();
} */

function applyGSTSelection() {

    const isInterState = document.getElementById("revise_interState").checked;
    const isOuterState = document.getElementById("revise_outerState").checked;

    // Toggle visibility of header columns
    document.querySelector(".revise_cgst-header").classList.toggle("d-none", !isInterState);
    document.querySelector(".revise_sgst-header").classList.toggle("d-none", !isInterState);
    document.querySelector(".revise_igst-header").classList.toggle("d-none", !isOuterState);

    // Apply correct values and visibility to each row
    document.querySelectorAll("#revise_productTableBody tr").forEach(row => {
        const cgstCell = row.querySelector(".cgst-value");
        const sgstCell = row.querySelector(".sgst-value");
        const igstCell = row.querySelector(".igst-value");

        if (isInterState) {
            cgstCell.style.display = "";
            sgstCell.style.display = "";
            igstCell.style.display = "none"; // Hide IGST
            igstCell.innerText = ""; // Remove text
        } else if (isOuterState) {
            cgstCell.style.display = "none"; // Hide CGST
            sgstCell.style.display = "none"; // Hide SGST
            igstCell.style.display = "";
        } else {
            // If neither is selected, hide all tax columns
            cgstCell.style.display = "none";
            sgstCell.style.display = "none";
            igstCell.style.display = "none";
        }

        // Ensure tax values are recalculated
        calculateTotal(row.querySelector(".quantity"));
    });
}

let productData = []; // Store fetched data globally

document.addEventListener("DOMContentLoaded", function () {
    fetch("/product_list")
        .then(response => response.json())
        .then(data => {
            console.log("Fetched Data:", data); // Debugging
            productData = data; // Store the fetched data globally

            if (data.length > 0) {
                const productSelect = document.getElementById("productName");
                const hsnCodeSelect = document.getElementById("hsnCode");
                const partNumberSelect = document.getElementById("partNumber");
                const productDescriptionSelect = document.getElementById("productDescription");

                // Clear previous options
                productSelect.innerHTML = `<option value="">Select a Product</option>`;
                hsnCodeSelect.innerHTML = `<option value="">Select HSN Code</option>`;
                partNumberSelect.innerHTML = `<option value="">Select Part Number</option>`;
                productDescriptionSelect.innerHTML = `<option value="">Select Description</option>`;

                // Loop through data and add options for Product Name
                data.forEach(product => {
                    productSelect.innerHTML += `<option value="${product.pdescription}">${product.pdescription}</option>`;
                });

                // Add event listener to detect product selection change
              /*   productSelect.addEventListener("change", function () {
                    const selectedProduct = this.value;
                    const selectedData = productData.find(p => p.pname === selectedProduct);

                    if (selectedData) {
                        hsnCodeSelect.innerHTML = `<option value="${selectedData.hsn_code}">${selectedData.hsn_code}</option>`;
                        partNumberSelect.innerHTML = `<option value="${selectedData.part_number}">${selectedData.part_number}</option>`;
                        productDescriptionSelect.innerHTML = `<option value="${selectedData.pdescription}">${selectedData.pdescription}</option>`;
                    } else {
                        // Reset other dropdowns if no product is selected
                        hsnCodeSelect.innerHTML = `<option value="">Select HSN Code</option>`;
                        partNumberSelect.innerHTML = `<option value="">Select Part Number</option>`;
                        productDescriptionSelect.innerHTML = `<option value="">Select Description</option>`;
                    }
                }); */
                
             // Add event listener to detect product selection change
                productSelect.addEventListener("change", function () {
                    const selectedProduct = this.value;
                    const selectedData = productData.find(p => p.pdescription === selectedProduct);

                    if (selectedData) {
                        hsnCodeSelect.value = selectedData.hsn_code;
                        partNumberSelect.value = selectedData.part_number;
                        productDescriptionSelect.value = selectedData.pname;
                    } else {
                        // Reset input fields if no product is selected
                        hsnCodeSelect.value = "";
                        partNumberSelect.value = "";
                        productDescriptionSelect.value = "";
                    }
                });

            } else {
                console.log("No products found.");
            }
        })
        .catch(error => console.error("Error fetching products:", error));
});

function populateProductDetailsDataBasedOnSelectedProductNameInRevise(productName){
	const selectedProduct = productName;
    const selectedData = productData.find(p => p.pdescription === selectedProduct);
    
    const hsnCodeSelect = document.getElementById("hsnCode");
    const partNumberSelect = document.getElementById("partNumber");
    const productDescriptionSelect = document.getElementById("productDescription");

    if (selectedData) {
        hsnCodeSelect.value = selectedData.hsn_code;
        partNumberSelect.value = selectedData.part_number;
        productDescriptionSelect.value = selectedData.pname;
    } else {
        // Reset input fields if no product is selected
        hsnCodeSelect.value = "";
        partNumberSelect.value = "";
        productDescriptionSelect.value = "";
    }
}

document.addEventListener("DOMContentLoaded", function () {
    
    // Function to format date-time in dd/mm/yyyy hh:mm:ss
    function formatDisplayDateTime(date) {
        let dd = String(date.getDate()).padStart(2, '0');
        let mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        let yyyy = date.getFullYear();
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }

    // Function to format date-time for input type datetime-local
    function formatISODateTime(date) {
        let yyyy = date.getFullYear();
        let mm = String(date.getMonth() + 1).padStart(2, '0');
        let dd = String(date.getDate()).padStart(2, '0');
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    const dateTimeInput = document.getElementById("revise_qdateTime");

    function updateDateTime() {
        let now = new Date();
        if (dateTimeInput) {
            dateTimeInput.value = formatISODateTime(now); // Update datetime-local input
            dateTimeInput.setAttribute("data-display", formatDisplayDateTime(now)); // Store formatted value
        } else {
            console.error("Date-Time input field not found");
        }
    }

    updateDateTime(); // Set initial value
    setInterval(updateDateTime, 1000); // Update every second
});

function reviseQuotation() {
    let products = [];
    $("#revise_productTableBody tr").each(function() {
        let row = $(this);
        let product = {
            productName: row.find("td:eq(1)").text().trim(),
            hsnCode: row.find("td:eq(2)").text().trim(),
            partNumber: row.find("td:eq(3)").text().trim(),
            description: row.find("td:eq(4)").text().trim(),
            quantity: parseFloat(row.find(".quantity").val()) || 0,
            price: parseFloat(row.find(".price").val()) || 0,
            taxableValue: parseFloat(row.find(".total-without-gst").text().trim()) || 0,
            cgst: parseFloat(row.find(".cgst-value").text().trim()) || 0,
            sgst: parseFloat(row.find(".sgst-value").text().trim()) || 0,
            igst: parseFloat(row.find(".igst-value").text().trim()) || 0,
            total: parseFloat(row.find(".total-with-gst").text().trim()) || 0,
            qid: $("#revise_qid").val().trim(),
        };

        // Ensure no invalid values (remove "—" which is causing backend errors)
        product.cgst = isNaN(product.cgst) ? 0 : product.cgst;
        product.sgst = isNaN(product.sgst) ? 0 : product.sgst;
        product.igst = isNaN(product.igst) ? 0 : product.igst;

       // console.log("Row Data:", product);
        products.push(product);
        
    });
    
    var taxTypeValue;
    
    let checkboxes = document.querySelectorAll('.revisetaxTypeCheckBox');
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
        	taxTypeValue = checkbox.name; // Logs the ID of the checked checkbox
        }
    });
    
    let quotationData = {
        qid: $("#revise_qid").val().trim(),
        qdateTime: $("#revise_qdateTime").val(),
        vendorName: $("#revise_vendorName").val(),
        vendorlegalName: $("#revise_vendorlegalNamee").val(),
        gstnumber: $("#revise_gstnumberr").val(),
        orderMethod: $("#revise_orderMethod").val(),
        personName: $("#revise_personName").val(),
        designation: $("#revise_designation").val(),
        contactDetails: $("#revise_contactDetails").val(),
        emailId: $("#revise_emailId").val(),
        shipmentAddress: $("#revise_shipmentAddress").val(),
        deliveryAddress: $("#revise_deliveryAddress").val(),
        taxType: taxTypeValue,
        products: products,
        honorifics1: $('#revise_company_honorifics').val(),
        honorifics2: $('#revise_contact_person_honorifics').val()
    };

    //alert("Sending Data:", JSON.stringify(quotationData));
    //console.log("Sending Data: ", quotationData); // Debugging Output
    //alert($('#terms_and_condition').val());
    
    let termsAndConditionValue = $('#revise_terms_and_condition').val() || "";  // Ensure it is not null

    $.ajax({
        type: "POST",
        url: "/reviseQuotation/save?termsAndConditionValue=" + encodeURIComponent(termsAndConditionValue),
        contentType: "application/json",
        data: JSON.stringify(quotationData),
        success: function(response) {
            alert(response);
        },
        error: function(xhr) {
            alert("Error: " + xhr.responseText);
        }
    });
}
</script>

<!-- script to save Invoice -->
<script>

document.getElementById('invoiceForm').addEventListener('submit', function(e) {
	
    e.preventDefault();
     
    // ✅ Check for zero or empty quantities
   const itemsTableBody = document.querySelector('#pi_items_table tbody');
	const rows = itemsTableBody.querySelectorAll('tr');
	
	for (let i = 0; i < rows.length; i++) {
	    const quantityInput = rows[i].querySelector('input[name="quantity[]"]');
	    const qty = parseInt(quantityInput?.value?.trim(), 10);
 
	    if (isNaN(qty) || qty <= 0) {
	        alert(`Error: Quantity in row ${i + 1} must be greater than 0. or remove that product`);
	        quantityInput.focus();
	        return; // Stop form submission
	    }
	}
    
    // Prepare the form data as an object
    const formData = {
        poNumber: document.getElementById('po_number').value,
        poDate: document.getElementById('po_date').value,
        pi_no: document.getElementById('pi_no').value,
        date_of_supply: document.getElementById('pidateTime').value,
        vendorCode: document.getElementById('vendor_code').value,
		createdDateTime: new Date().toISOString(),
        quotationId: document.getElementById('pi_quotationId').value,
        billingAddress: document.getElementById('billing_address').value,
        shippingAddress: document.getElementById('pi_shipping_address').value,
        custHonorifics: document.getElementById('pi_company_honorifics1').value,
        
        custName: document.getElementById('pi_cust_name').value,
        cusLeagalName: document.getElementById('pi_cust_legan_name').value,
        gstNo: document.getElementById('pi_gstnumberr1').value,
        orderMehtod: document.getElementById('pi_orderMethod1').value,
        contactHonorifics: document.getElementById('pi_contact_person_honorifics1').value,
        contPersonName: document.getElementById('pi_personName1').value,
        designation: document.getElementById('pi_designation1').value,
        mobileNo: document.getElementById('pi_contactDetails1').value,
        email: document.getElementById('pi_emailId1').value,
        termsAndConditions: document.getElementById('pi_terms_and_conditionnew').value,
		purchaseId: document.getElementById('poid').value,
		invoice_id: document.getElementById('pi_id').value,
		
		// ✅ New fields added below:
		modeOfPayment: document.getElementById('pi_mode_of_payment').value,
		termsOfDelivery: document.getElementById('pi_terms_and_conditionnew').value,
		
		placeOfSupply:document.getElementById('pi_supply_place').value,
		vehicle:document.getElementById('pi_vehicle_No').value,
		stateName:document.getElementById('pi_state').value,
		sateCode:document.getElementById('pi_state_code').value,
		transportMode:document.getElementById('pi_transportMode').value,
		
		
		totalAmount:document.getElementById('summary-total').innerText,
		cgst:document.getElementById('summary-cgst').innerText,
		sgst:document.getElementById('summary-sgst').innerText,
		igst:document.getElementById('summary-igst').innerText,
		
		totalTaxGst:document.getElementById('summary-gst-tax').innerText,
		totalAmtAfterTaxBeforeTcs:document.getElementById('total-amount-after-GST-before-TCS').innerText,
		tcs:document.getElementById('summary-tcs').innerText,
		totalTax:document.getElementById('summary-tax').innerText,
		
		totoalTaxAfterTcs:document.getElementById('summary-with-tax').innerText,
		gstPayableRevCharge:document.getElementById('gst-reverse-charge').value,
		totalAmtAfterRevCharge:document.getElementById('total-amount-after-revese-charge').innerText,
		roundOffDecimal:document.getElementById('summary-roundoff').innerText,
		
		netAmt:document.getElementById('summary-final').innerText,
		tax_type: document.getElementById('pi_interState1').checked
	    ? 'Intrastate'
	    : document.getElementById('pi_outerState1').checked
	    ? 'Interstate'
	    : 'None',

		
        // Items (loop through the table rows to get item details)
        items: Array.from(document.querySelectorAll('#pi_items_table tbody tr')).map(row => ({ 
            partNo: row.querySelector('input[name="part_no[]"]').value,
            hsnCode: row.querySelector('input[name="hsn_code[]"]').value,
            description: row.querySelector('input[name="description[]"]').value,
            quantity: row.querySelector('input[name="quantity[]"]').value,
            price: row.querySelector('input[name="price[]"]').value,
			lineTotal: row.querySelector('input[name="line_total[]"]').value,
            cgst: row.querySelector('input[name="cgst[]"]').value,
            sgst: row.querySelector('input[name="sgst[]"]').value,
            igst: row.querySelector('input[name="igst[]"]').value,
            totalValue: row.querySelector('input[name="total_line_total[]"]').value,
            p_id: row.querySelector('input[name="product_id[]"]').value
        }))											   
    };
    
    //alert(JSON.stringify(formData, null, 2));
    //console.log("kkkkk",JSON.stringify(formData, null, 2));
	  // Alert full form data as JSON string
	   // alert('Form Data:\n' + JSON.stringify(formData, null, 2));
 
	 console.log("formData");
    // Send data to backend using fetch or AJAX
    const loadingPopup = document.getElementById('loadingPopup');
    loadingPopup.style.display = 'flex'; // Show the overlay
    
     fetch('/purchase-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
    	loadingPopup.style.display = 'none';
        // Handle success
        alert('saved successfully');
        // Close the modal
         
        // Close the modal using Bootstrap 5's modal instance
	    const modalEl = document.getElementById('invoiceModal');
	    const modal = bootstrap.Modal.getInstance(modalEl); // Get the modal instance
	    modal.hide(); // Hide/close the modal
        
    })
    .catch((error) => {
    	console.error('Error:', error);
        alert(`Error occurred:\n${error.message || error}`);
    }); 
});

</script>

<!-- script to save performa invoice -->
 <script>

document.getElementById('performainvoiceForm').addEventListener('submit', function(e) {
	 
    e.preventDefault();
     
    // ✅ Check for zero or empty quantities
   const itemsTableBody = document.querySelector('#performa_items_table tbody');
	const rows = itemsTableBody.querySelectorAll('tr');
	
	for (let i = 0; i < rows.length; i++) {
	    const quantityInput = rows[i].querySelector('input[name="quantity[]"]');
	    const qty = parseInt(quantityInput?.value?.trim(), 10);
  
	    if (isNaN(qty) || qty <= 0) {
	        alert(`Error: Quantity in row ${i + 1} must be greater than 0. or remove that product`);
	        quantityInput.focus();
	        return; // Stop form submission
	    }
	}
    
    // Prepare the form data as an object
    const formData = {
        poNumber: document.getElementById('performa_number').value,
        poDate: document.getElementById('performa_date').value,
        pi_no: document.getElementById('performa_no').value,
        date_of_supply: document.getElementById('performa_dateTime').value,
        vendorCode: document.getElementById('performa_vendor_code').value,
		createdDateTime: new Date().toISOString(),
        quotationId: document.getElementById('performa_quotationId').value,
        billingAddress: document.getElementById('performa_billing_address').value,
        shippingAddress: document.getElementById('performa_shipping_address').value,
        custHonorifics: document.getElementById('performa_company_honorifics1').value,
        
        custName: document.getElementById('performa_cust_name').value,
        cusLeagalName: document.getElementById('performa_cust_legan_name').value,
        gstNo: document.getElementById('performa_gstnumberr1').value,
        orderMehtod: document.getElementById('performa_orderMethod1').value,
        contactHonorifics: document.getElementById('performa_contact_person_honorifics1').value,
        contPersonName: document.getElementById('performa_personName1').value,
        designation: document.getElementById('performa_designation1').value,
        mobileNo: document.getElementById('performa_contactDetails1').value,
        email: document.getElementById('performa_emailId1').value,
        termsAndConditions: document.getElementById('performa_terms_and_conditionnew').value,
		purchaseId: document.getElementById('poid').value,
		invoice_id: document.getElementById('performa_id').value,
		
		// ✅ New fields added below:
		modeOfPayment: document.getElementById('performa_mode_of_payment').value,
		termsOfDelivery: document.getElementById('performa_terms_and_conditionnew').value,
		
		placeOfSupply:document.getElementById('performa_supply_place').value,
		vehicle:document.getElementById('performa_vehicle_No').value,
		stateName:document.getElementById('performa_state').value,
		sateCode:document.getElementById('performa_state_code').value,
		transportMode:document.getElementById('performa_transportMode').value,
		
		totalAmount:document.getElementById('performa_summary-total').innerText,
		cgst:document.getElementById('performa_summary-cgst').innerText,
		sgst:document.getElementById('performa_summary-sgst').innerText,
		igst:document.getElementById('performa_summary-igst').innerText,
		
		totalTaxGst:document.getElementById('performa_summary-gst-tax').innerText,
		totalAmtAfterTaxBeforeTcs:document.getElementById('performa_total-amount-after-GST-before-TCS').innerText,
		tcs:document.getElementById('performa_summary-tcs').innerText,
		totalTax:document.getElementById('performa_summary-tax').innerText,
		
		totoalTaxAfterTcs:document.getElementById('performa_summary-with-tax').innerText,
		gstPayableRevCharge:document.getElementById('performa_gst-reverse-charge').value,
		totalAmtAfterRevCharge:document.getElementById('performa_total-amount-after-revese-charge').innerText,
		roundOffDecimal:document.getElementById('performa_summary-roundoff').innerText,
		
		netAmt:document.getElementById('performa_summary-final').innerText,
		tax_type: document.getElementById('performa_interState1').checked
	    ? 'Intrastate'
	    : document.getElementById('performa_outerState1').checked
	    ? 'Interstate'
	    : 'None',

        // Items (loop through the table rows to get item details)
        items: Array.from(document.querySelectorAll('#performa_items_table tbody tr')).map(row => ({ 
            partNo: row.querySelector('input[name="part_no[]"]').value,
            hsnCode: row.querySelector('input[name="hsn_code[]"]').value,
            description: row.querySelector('input[name="description[]"]').value,
            quantity: row.querySelector('input[name="quantity[]"]').value,
            price: row.querySelector('input[name="price[]"]').value,
			lineTotal: row.querySelector('input[name="line_total[]"]').value,
            cgst: row.querySelector('input[name="cgst[]"]').value,
            sgst: row.querySelector('input[name="sgst[]"]').value,
            igst: row.querySelector('input[name="igst[]"]').value,
            totalValue: row.querySelector('input[name="total_line_total[]"]').value,
            p_id: row.querySelector('input[name="product_id[]"]').value
        }))											   
    }; 
    
    //alert(JSON.stringify(formData, null, 2));
    //console.log("kkkkk",JSON.stringify(formData, null, 2));
	// Alert full form data as JSON string
	// alert('Form Data:\n' + JSON.stringify(formData, null, 2));
 
	 console.log("formData");
    // Send data to backend using fetch or AJAX
    const loadingPopup = document.getElementById('loadingPopup');
    loadingPopup.style.display = 'flex'; // Show the overlay
    
    fetch('/purchase-invoice/performa-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
    	loadingPopup.style.display = 'none';
        // Handle success
        alert('saved successfully');
        // Close the modal
         
        // Close the modal using Bootstrap 5's modal instance
	    const modalEl = document.getElementById('performainvoiceModal');
	    const modal = bootstrap.Modal.getInstance(modalEl); // Get the modal instance
	    modal.hide(); // Hide/close the modal
        
    })
    .catch((error) => {
    	console.error('Error:', error);
        alert(`Error occurred:\n${error.message || error}`);
    });
});

</script>
<!-- script to display PI in PDF --> 
<script>
async function viewPI() {

	  const { jsPDF } = window.jspdf;
	  const doc = new jsPDF({
	    orientation: 'portrait',
	    unit: 'mm',
	    format: 'a4',
	  });

	  for (let i = 0; i < 3; i++) {
	    if (i !== 0) {
	      doc.addPage(); // Add a new page for the next copy
	    }
	    await generateInvoiceContent(doc,i); // Your invoice-generating logic goes here
	  }
	  window.open(doc.output('bloburl'), '_blank');
	}
</script>
<script> 
async function generateInvoiceContent(doc,copyIndex) {
    const { jsPDF } = window.jspdf;

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
	const pdfMainBorderPAdding = 10;
	
	const qrText = "Your invoice URL or data here";
	 // 1. Generate QR code Data URL
    const qrDataUrl = await QRCode.toDataURL(qrText);
	 // 2. Add QR code image to the PDF
    const qrX = pageWidth - 40; // Adjust position
    const qrY = pageHeight - 50; // Adjust position
    const qrSize = 30; // width & height

    doc.addImage(qrDataUrl, 'PNG', qrX, qrY, qrSize, qrSize);
    // Add full-page border
    doc.setLineWidth(0.3);
    doc.rect(pdfMainBorderPAdding, pdfMainBorderPAdding, pageWidth - 20, pageHeight - 20);

    // Data from form
    const poNumber = document.getElementById('po_number').value;
    const poDate = document.getElementById('po_date').value;
    const vendorCode = document.getElementById('vendor_code').value;

    // Header
    let yAxis = pdfMainBorderPAdding + 5;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text("Melange Systems Private Limited.", pdfMainBorderPAdding +2, yAxis);
    doc.setFontSize(9);
    yAxis += 5;
    doc.setFont("helvetica","normal");
    doc.text("No. 4/1, 7th Cross, Kumara Park West, Bangalore 560020", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.text("Tel: 080-2356 1023, Telefax: 080-2346 2175", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.setFont("helvetica", "bold");
    doc.text("GSTIN: 29AACCM4737H1ZA, CIN: U72200KA2000PTC027922", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.text("Udyam Registration Number: UDYAM-KR-03-0101576", pdfMainBorderPAdding+2 , yAxis);
    // ✅ Add Company Logo (Right Side)
   	let logo = new Image();
    logo.src = "/assets/img/compressed_logo.png";
    // logo.onload = function () {
    doc.addImage(logo, "PNG", 140,  pdfMainBorderPAdding + 5, 50, 14); // (image, type, x, y, width, height)        

    // Draw horizontal line below header
    yAxis += 2;
    doc.setLineWidth(0.1); // thinner line
    
    // Rectangle with 3 columns below the header line
    const rectTopY = yAxis; // start a bit below the line
    const rectHeight = 20; // adjust height as needed (this height gives more space for rows)
    const rectLeftX = 10;
    const rectRightX = pageWidth - 10;
    const rectWidth = rectRightX - rectLeftX;
         
    // Column widths based on percentages, making sure they add up to 100%
    const col1Width = rectWidth * 0.70; // 50% width for column 1
    const col2Width = rectWidth * 0.08; // 30% width for column 2
    const col3Width = rectWidth * 0.22; // 20% width for column 3

    doc.setFont("helvetica","normal");
    doc.setLineWidth(0.05); // thinner line

    // Draw outer rectangle
    doc.rect(rectLeftX, rectTopY, rectWidth, rectHeight);

    // Draw Place of Supply:ertical lines for columns
    doc.line(rectLeftX + col1Width - 2, rectTopY, rectLeftX + col1Width - 2, rectTopY + rectHeight); // Line between col1 and col2
    doc.line(rectLeftX + col1Width + col2Width - 2, rectTopY, rectLeftX + col1Width + col2Width - 2, rectTopY + rectHeight); // Line between col2 and col3

    // Draw horizontal lines to create 3 rows in col2 and col3
    const rowHeight = (rectHeight / 3) ; // divide rect height into 3 rows
    doc.line(rectLeftX + col1Width - 2, rectTopY + rowHeight, rectRightX , rectTopY + rowHeight); // Row 1 horizontal line
    doc.line(rectLeftX + col1Width - 2, rectTopY + 2 * rowHeight, rectRightX, rectTopY + 2 * rowHeight); // Row 2 horizontal line

 	// Invoice title
    doc.setFontSize(14);
    doc.setFont("helvetica","bold");
    doc.text("TAX INVOICE", rectLeftX + col1Width / 2, rectTopY + rectHeight - 8, { align: 'center' });
    
     // Optional: headers
     doc.setFontSize(9);
     doc.setFont("helvetica","normal");
     
	 // Text for Column 2 rows
	 /* doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 0.5, { align: 'center' });
	 doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 1.5, { align: 'center' });
	 doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 2.5, { align: 'center' });  
	 */
	 
	  const tickX = rectLeftX + col1Width + col2Width / 2;
	  const tickY = rectTopY + rowHeight * copyIndex + 0.2;
	  const tickBase64 =  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAACXBIWXMAAEuXAABLlwHuxW8gAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAHHhJREFUeJzt3VuQpGd93/H/07OrlRZxtAHjUE4ZW+TgihKzQTMjCbIBxHa3gJAQcTAHgyBJBQixU7kAh6q4kort+CqOEwyJMU4AYVtGEqI0M5IMXgeJ3cWS4yikjB2o5MIYKg6gCJ13p59caGe9kvYw3f2envf9fG6l7n6qtnd/3/ftOUQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANQitX0AAIbn0le+8ikXraxcERGXpogXppS+P+f8lIi4MFK6P3L+Vkrpf+XZ7Cuz0ejIlzY2/qjtM/eNAACgEQdf+9pnPPzII9dExI9FxBURsXeOh/9JRNwQKX3i6MbGsVoOODACAIBarb/qVX8unzjxTyKlvx8RFy/9hCl9KeX8s0c2Nz8TEXnp5xsoAQBALQ4cOLB3z3Of++6U87+MiKfW8BJ35Jzfc2xr654anrv3BAAAlbtsOn1hyvnXU8Rfq/mlTkTEB49ubv58uBswFwEAQKVWp9O/lXL+eNRz1X82Gxc+9NAbDh8+fH+Dr1k0AQBAZdbH43fmlD4SEStNv3aKuGtPxPQLm5t/2vRrl0gAAFCJtcnk70XER6LNbUnpK8e3t1929623fqO1MxRCAACwtE6M/46UvrId8Td/d2Pjm20fpcva/4MCoGidGv8dIuC8Rm0fAIBynRz/D0eXxj8iIue/uBLx2y+eTr+v7aN0Vbf+wAAoxmnj392LSXcCzkoAADC3Isb/z/zBdkovEwGPJwAAmEth479DBDxBSX94ALRsbTp9V5Q3/hERf2kl51sPvPrV39v2QbrCHQAAdmVtOn1X5PyRKG/8T3fP8T17Xn73Zz/7f9s+SNtK/kMEoCE9Gf+IiEv3bm//ljsB7gAAcB49Gv8/k9J/O76y8ooh3wkQAACcVS/Hf8fAI0AAAHBGvR7/HQOOgP7+oQKwsEGMf0REzn917/b2b1328pd/T9tHaZo7AAA8zmDG/zQ54vfzo4++4kuf+9y32j5LUwQAAKcMcfx3DC0CBAAAETHs8d8xpAgQAAAY/9MMJQIEAMDArY/H78wp/Ycw/qcMIQIEAMCAGf9z+q9pNnvFkVtv/XbbB6mDAAAYKOO/K72NAAEAMEDGfy69jAABADAwxn8hvYsAf/gAA2L8F/ajeTS6ff3QoWe1fZCquAMAMBDGvxK/l2azq/pwJ0AAAAyA8a9ULyLAGwGg54x/5V6UR6Pbr7z66me2fZBleDMA9Jjxr82LTsxmRUeAjwAAesr4N+LuPaPRVXfccst32j7IvAQAQA+tTybX5oj/GMa/CUVGgAAA6Bnj37wccSQixsc2N+9r+yy7JQAAesT4t6e0CBAAAD1h/NtXUgQIAIAeMP7dUUoEeKMAFM74d0uKWE85b65OJk9r+yzn4s0CUDDj31EpXZ5y3rziNa95attHORsfAQAUyvgXIOcvrlxwwfjOm2/+bttHeSIBAFAg41+QjkaAAAAojPEv0p0re/dOuhQBAgCgIMa/aJ2KAAEAUAjj3wudiQABAFAA498rnYgAAQDQcca/l1qPAG8mgA4z/r11xfbx4xsHDx68uK0DuAMA0FHGfxDuuPChhyaHDx++v+kX9qYC6KDV6fQdxn8Qrnz4oos227gT4A4AQMesTqfvSDn/chj/IWn8ToA3F0CHGP/BuvKR/fsb/ZoAdwAAOsL4k1L6wr4HH5w2cSdAAAB0gPFnR1MRIAAAWmb8eaImIkAAALTI+HM2OeK/PLS9Pb3nttseqOP5BQBAS4w/51NnBAgAgBYYf3arrgjwxgNomPFnHinipftXVm5cv+aai6p83pUqnwyAc1sbj9+eIj4axp/5/FA8+uiLnvv0p//GN77xjVkVT+gNCNCQtfH47ZGS8WdRk73Pec7HoqKP790BAGiA8acilz7/kkse/OOvfvXOZZ/IFwEC1Mz4U7HjkdJLjm5sHFvmSbwZAWpk/KnB3pTzRw8ePLhnmSfxhgSoifGnLjniRx7av/8fLPMcPgIAqIHxpwHfvPChh37w8OHDDy/yYG9MgIqtjcc/bvxpwPc9vH//WxZ9sDcnQIVWx+M3Gn+aknO+dtHH+ggAoCInr/x/JYw/zcmR8wuObm3973kf6E0KUAFX/rQkxWg0XuSB3qgAS1odj9+YUvpE+OFqtCHnv7HIwwQAwBKMP23LET+6yOMEAMCCjD9dkCJecODAgb3zPk4AACxgfTJ5W0rpk2H8ad/eC573vOfM+yABADCn1fH4jTnCV/vTGaMTJy6e+zF1HASgr05e+bvtT6eciNg372MEAMAunbzy/2gYfzpmJaUH5n2MAADYhdXp9K0nr/yX+g1sUIcTjz5677yPEQAA57E6Hr8x5fwr4cqfbvp/X/rc574174MEAMA5uPKn81L6w0UeJgAAzsKVPyXIOX9xkccJAIAzcOVPKUYRv7PI47yxAZ5gbTJ5Q7jypwwPPLC9ffsiD3QHAOA0q+PxWyLik+ECiRKkdOM9t90297cARniDA5yyNpm8ISI+Fq78KcRoNvvQwo+t8iAApXLlT4E+98WtrSOLPtgbHRg8V/4UaDbK+QPLPIE7AMCgufKnSCl9+ItbW7+7zFN4wwOD5cqfQv3Ryp4971/2SdwBAAbJlT+F+u5oNHrdnTff/N1ln8gbHxgcV/4U6tGU8zVfvOWWL1fxZO4AAIOyNpm8OVz5U57jkfObjmxt3VrVE6pfYDDWptPXR8THw/hTlu2c81uPbW1dX+WTpiqfDKCr1qbT10fOrvwpzXbO+S3HtrZ+reonFgBA7xl/ClXb+Ef4GgCg54w/hdpOj932r2X8I9wBAHrM+FOo7ZTzW49sbX2qzhcRAEAvGX8K1cj4RwgAoIeMP4VqbPwjBADQM8afQjU6/hECAOgR40+hGh//CAEA9ITxp1CtjH+EAAB6wPhTqNbGP0IAAIUz/hSq1fGPEABAwYw/hWp9/CMEAFAo40+hOjH+EQIAKJDxp1CdGf8Ivw4YKMz6eHxNRFwXxp+ydGr8I9wBAAqyPh5fk1My/pSmc+MfIQCAQhh/CtXJ8Y/w64CBAhh/CrWdUnpbF8c/wh0AoOOMP4V6bPw3Nq5r+yBnIwCAzjL+FKrz4x8hAICOMv4UqojxjxAAQAcZfwpVzPhHCACgY4w/hSpq/CMEANAhxp9CFTf+EQIA6AjjT6GKHP8IAQB0wOpk8ndTxKfC+FOWYsc/QgAALTP+FKro8Y8QAECLjD+FKn78IwQA0BLjT6F6Mf4RAgBogfGnUL0Z/wgBADTM+FOoXo1/hAAAGmT8KVTvxj8iYqXtAwDDYPwp1HZE/PjRzc1ejX+EOwCVO3Do0PP2rKxcnnK+LFL64ZTzD0TEs3LEhSni4RzxcIr4Zo74Wk7pf+SIO/c/+ODvHz58+ETbZ4e6rE2nr4+cPxnGn7KciJTefHRj4zfaPkgdBEAFVl/zmueOHn30bTmlayLixQs8xbdzxE2jnK87srX1+YjIFR8RWmP8KVSvxz9CACzlxVdf/YKV2eyDEfFjEbGvoqf9ck7p549ddtkn46d/elbRc0IrjD+F6v34RwiAhaxfc81F+f77/3lE/ERUN/yPkyLuyim99+jGxrE6nh/q5mf7U6gTEfGWo5ubv972QeomAOa0Oh5fOkrpuhzxIw283Ikc8S9+4OKLf+b666/fbuD1oBLGn0INZvwjBMBc1g4dekWMRjdExFMbfumbj+/Z86a7P/vZBxt+XZjbya/2vy4i9rZ9FpjDzlf7f7LtgzRFAOzS2mTy5oj41WjviuaOHHH1sc3N+1p6fTgvV/4UalBX/jsEwC6sTSZviIhPRPv/qN29ZzS66o5bbvlOy+eAJ3HlT6EGd+W/Y9T2AbpubTp9fXRj/CMiDpyYzW6/8uqrn9n2QeB0q9Pp64w/BRrs+Ee4A3BOHf4WJncC6IzV6fR1KedPhfGnLIMe/wgBcFYdHv8dIoDWGX8KNfjxjxAAZ1TA+O8QAbTG+FMo43+SAHiCAr+KWQTQOONPoYz/aQTAaQoc/x0igMYYfwq1nXN++7GtrU+0fZCuEAAnFTz+O0QAtTP+FMr4n4EAiF79nnIRQG2MP4Uy/mcx+ADo0fjvEAFUzvhTKON/DoMOgB6O/w4RQGWMP4Uy/ucx2ADo8fjvEAEszfhTKOO/C4MMgAH9zHIRwMLWxuO/Eyn9WvT/7wn9Yvx3aXC/C2BgP7Pc7w5gIcafQhn/OQzqDsCAb2e6E8CuGX8KZfznNJgAGPD47xABnJfxp1DGfwGDCAD/qJ0iAjgrf08olPFfUO8DwD9qTyICeBJ/TyiU8V9CrwPAP2pnJQI4xd8TCmX8l9TbAPCP2nmJAPw9oVTGvwK9DIDLDh26ejQafToi9rV9lo4TAQNm/CmU8a9I7wLA+M9NBAyQ8adQxr9CvQqA1fF4mlK6IYz/vETAgBh/CmX8K9abADD+SxMBA2D8KZTxr0EvAmBtMplExI1h/JclAnrMx2MUyvjXpPgAMP6VEwE9ZPwplPGvUdEBYPxrIwJ6xPhTKONfs2IDwPjXTgT0gPGnUMa/AUX+OuCT4+8L/urlVwkXzvhTqO2c0juMf/2KC4D16XQcj43/hW2fZQBEQKGMP4V6bPw3Nj7e9kGGoKiPANan03HO+cYw/k3zcUBBjD+FMv4NKyYAjH/rREABjD+FMv4tKCIAjH9niIAOM/4Uyvi3pPMBsD4eH8op3RTGvytEQAf5SZgUyvi3qNMBYPw7SwR0iPGnUMa/ZZ0NAOPfeSKgA4w/hTL+HdDJAFidTF6ZIj4Txr/rRECLjD+FMv4d0bkAMP7FEQEtMP4Uyvh3SKcCwPgXSwQ0yPhTKOPfMZ0JAONfPBHQAONPoYx/B3XiRwGvTqdXpQhf8Fc2Pza4ZsafQhn/jmr9DsDqdHpVyvkzEXFR22ehEu4E1MD4Uyjj32GtBoDx7y0RUCHjT6GMf8e19hGA8e81HwdUxPhTqO0Uca3x77ZW7gBcPp2+dJbzRkQ8pY3XpzHuBCxhbTKZRMSNYfwpy3aKuPbI5uZ/bvsgnFvjAWD8B0cELMD4UyjjX5BGA8D4D5YImIPxp1DGvzCNfQ3AyfG/JYz/EPmagF0y/hTK+BeokQC47NChl5wc/4ubeD06SQSch/GnUMa/ULV/BHDZoUMvGY1GG2H8eYyPA87A+FMo41+wWgPA+HMWIuA0xp9CGf/C1RYAxp/zEAFh/CmW8e+BWgJgdTy+MqW0Gcafcxt0BBh/CmX8e6LyADD+zGmQEWD8KZTx75FKA8D3+bOIHHEkIsbHNjfva/ssTVibTF4dEb8ZERe0fRaYg5/t3zOVBcDqeHxppPQ7KeIZVT0ngzKIOwGu/CmUK/8eqiQALp9O//ws52MR8dwqno9h6vudgPXp9FU550+HK3/KYvx7aukfBHTw4ME9s9nsujD+LClFrKeIz/fxhwWtTSaTnPP1Yfwpyyxyfqfx76elA+Dh/fs/GCldXsVhICIOHJ/NblmdTJ7W9kGqsj6dvioiboqIC9s+C8xhO0W84+jW1n9q+yDUY6mPAC6fTH5oFvHl8A8b1evF1wSc/Mz/hvB3hLLMIudrjX+/LXUHIEf8XPiHjXoUfyfg5JX/jeHvCGWZufIfhoXvAFw2nb5wlPMfRIO/UZBBKvJOwPp0Os45G39K48p/QBYe7zSbvW+Zx8MuFXcn4LJDh67OOfvMn9K48h+YhQb8wIEDe1NKb6j6MHAmJX13wPp0Oh6NRr8Zvs+fsswiZ9/qNzALBcAFz372yyLieys+C5xL5+8EuPKnUG77D9Rit/BHo4OVngJ2oct3Alz5UyjjP2CLfoZ/RaWngN3r3J0AV/4UyvgP3EIBkHP+y1UfBHarS3cCXPlTKOPP/AFw8h/d76nhLDCP1u8EuPKnUMafiFggAGaz2bPqOAjMq807Aa78KZTx55S5A2A756fUcRBYUON3AlbH46krfwpk/HmcuQNgZWVlVsdBYFFN3glYn07HKaVPhyt/ymL8eZK5A+DE8eMP1HEQWNKBE7PZ7XVGgB/vS6GMP2c0dwA8HPF/IiLXcBZYVm0fB7jtT6FmkfM7jT9nMncA3HPbbQ9ExJ/UcBZYWh0fB7jtT6F2rvx/te2D0E2L/iCgeyo9BVSrsjsBrvwplCt/zmvRALij0lNAxaq4E7A+Hh9y5U+BXPmzKwsFwCyl26o+CNRg4TsBa5PJJKf0mXDlT1lc+bNradEHrk0mfxgRL6zwLFCXu/eMRlfdccst39nN/7w+Hh/KKbntT2lyyvkfHtna+kjbB6EMi34EEBHh90ZTil3fCXDlT6FmkfO1xp95LBwAaTb7pYj4boVngdrs5msC1sfjQxFxQ/jMn7LklPO7febPvFYWfeAff+1rDz3/kkueHhFXVngeqNP3b+f80udfcsn1X//qVx85/T+sTSaTSMkP+aE0s5zSu45ubv5y2wehPMt8BBAre/f+q4j4ekVngdqd6U7AaVf+xp+S5JTzu49tbHys7YNQpoW/CHDH+mTy2hxxYxWHgabkiCMRMR6ldLkf70uBZjmldxl/lrF0AERErE0mvxgR763iuaBB/z0iLgnjT1mMP5VY6iOAHc+M+KeR829X8VzQoL8Sxp+yGH8qU8kdgIiI1cnkaSni8xFxoKrnBOAU40+lKrkDEBFxbHPzvgv37XtFirirqucEICIicqT0HuNPlSq7A7Dj4Gtf+4xHHnnk9hzx16t+boABypHSu49ubHy47YPQL5UHQIQIAKiI8ac2tQRAhAgAWJLxp1a1BUCECABYkPGndrUGQIQIAJiT8acRtQdAhAgA2CXjT2MaCYAIEQBwHsafRjUWABEiAOAsjD+NazQAIkQAwBMYf1rReABEiACAk4w/rWklACJEADB4xp9WtRYAESIAGCzjT+taDYAIEQAMjvGnE1oPgAgRAAxGjoj3HN3c/KW2DwKdCIAIEQD0nvGnUzoTABEiAOgt40/ndCoAIkQA0DvGn07qXABEiACgN4w/ndXJAIgQAUDxjD+d1tkAiBABQLGMP53X6QCIEAFAcYw/Reh8AESIAKAYxp9iFBEAESIA6DzjT1GKCYAIEQB0lvGnOEUFQIQIADrH+FOk4gIgQgQAnWH8KVaRARAhAoDWGX+KVmwARIgAoDXGn+IVHQARIgBoXM45v/fY1taH2j4ILKP4AIgQAUBjjD+90YsAiBABQO2MP73SmwCIEAFAbYw/vdOrAIgQAUDljD+91LsAiBABQGWMP73VywCIEAHA0ow/vdbbAIgQAcDCjD+91+sAiBABwNyMP4PQ+wCIEAHArhl/BmMQARAhAoDzMv4MymACIEIEAGdl/BmcQQVAhAgAnsT4M0iDC4AIEQCcYvwZrEEGQIQIAIw/wzbYAIgQATBgxp/BG3QARIgAGCDjDyEAIkIEwIAYfzhJAJwkAqD3jD+cRgCcRgRAbxl/eAIB8AQiAHrH+MMZCIAzEAHQG8YfzmLU9gG66PBNN927b9++q1LEXW2fBVhYzin9I+MPZ+YOwDm4EwDFemz8Nzb+fdsHga4SAOchAqA4xh92QQDsggiAYhh/2CUBsEsiADrP+MMcBMAcRAB0lvGHOQmAOYkA6BzjDwsQAAsQAdAZxh8WJAAWJAKgdcYfliAAliACoDXGH5YkAJYkAqBxxh8qIAAqIAKgMcYfKiIAKiICoHbGHyokACokAqA2xh8q5rcBVshvEYRa5BTxPuMP1XIHoAbuBEBlcop435HNzX/X9kGgbwRATUQALM34Q40EQI1EACzM+EPNBEDNRADMzfhDAwRAA0QA7Jrxh4YIgIaIADgv4w8NEgANEgFwVsYfGiYAGiYC4EmMP7RAALRABMApxh9aIgBaIgLA+EObBECLRAADZvyhZQKgZSKAATL+0AECoANEAANi/KEjBEBHiAAGwPhDhwiADhEB9FiOiH98dHPzF9s+CPAYAdAxIoAeMv7QQQKgg0QAPWL8oaMEQEeJAHrA+EOHCYAOEwEUzPhDxwmAjhMBFMj4QwEEQAFEAAUx/lAIAVAIEUABjD8URAAURATQYcYfCiMACiMC6CDjDwUSAAUSAXSI8YdCCYBCiQA6wPhDwQRAwUQALTL+UDgBUDgRQAuMP/SAAOgBEUCDjD/0hADoCRFAA3Lk/BNHt7b+bdsHAZYnAHpEBFAj4w89IwB6RgRQA+MPPSQAekgEUCHjDz0lAHpKBFAB4w89JgB6TASwBOMPPScAek4EsADjDwMgAAZABDAH4w8DIQAGQgSwC8YfBkQADIgI4ByMPwyMABgYEcAZGH8YIAEwQCKA0xh/GCgBMFAigDD+MGgCYMBEwKAZfxi4UdsHoD2Hb7rp3n379l2VIu5q+yw0KueUftL4w7C5A4A7AcOSc0o/eWxj4xfaPgjQLgFARIiAgTD+wCkCgFNEQK8Zf+BxBACPIwJ6yfgDTyIAeBIR0CvGHzgj3wXAk/jugF75gPEHzsQdAM7KnYDivf/o5ua/bvsQQDcJAM5JBBTL+APnJAA4LxFQHOMPnJcAYFdEQDGMP7ArAoBdEwGdZ/yBXRMAzEUEdJbxB+YiAJibCOgc4w/MTQCwEBHQGcYfWIgAYGEioF055w8c29r6ubbPAZRJALAUEdAO4w8sSwCwNBHQLOMPVEEAUAkR0AzjD1RFAFAZEVAv4w9USQBQKRFQD+MPVE0AUDkRUC3jD9RBAFALEVAN4w/URQBQGxGwHOMP1EkAUCsRsBjjD9RNAFA7ETAf4w80QQDQCBGwO8YfaIoAoDEi4NyMP9AkAUCjRMCZGX+gaaO2D8CwHL7ppnv37dt3VYq4q+2zdEVK6aeMP9A0dwBohTsBj0kp/dSRjY2fbfscwPAIAFoz9Agw/kCbBACtGmoEGH+gbQKA1g0tAow/0AUCgE4YSgQYf6ArBACd0fcIMP5AlwgAOqWvEWD8ga4RAHRO3yLA+ANdJADopL5EgPEHukoA0FmlR4DxB7pMANBppUaA8Qe6TgDQeaVFgPEHSiAAKEIpEWD8gVIIAIrR9Qgw/kBJBABF6XAE/LOjm5s/0/YhAHZLAFCcDkaA8QeKIwAoUociwPgDRRIAFGv90KFn5ZQ+Gyld3sLLb+ec33dsa+tDLbw2wNJGbR8AFnXk1lu/fXzv3qtSzp9p+KXvi4i/bfyBkrkDQB+k1en0fSnnn4+IC2p9oYi7YjZ705Fbb/1qna8DUDd3AOiDfGxj4xdWcr40RdxWywtE3BsR77/v4ouvMP5AH7gDQO+sjcevySm9P0WsL/tcOeLeFPGhvRH/5gubm39axfkAukAA0FuXj8cvzim9OUe8LiKeP8dDH8kRh1POn1q54IIb7rz55u/WdUaAtggABmH90KEfjtHo8hzxF3JKP5ginp1zfkqKeCQi7s8pfT1y/p8xGv3eaP/+o0euv/6hts8MAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQoP8Pgj4wdg103P0AAAAASUVORK5CYII=";
	  
	  doc.addImage(tickBase64, 'PNG', tickX - 5, tickY, 5, 5);

	  //doc.addImage(tickBase64, tickX, tickY, { align: 'center' });
	  
	 // Text for Column 3 rows
	doc.text("Original for Recipient", rectLeftX + col1Width + col2Width - 1, rectTopY + rowHeight * 0.5 + 1.2);
	doc.text("Duplicate Supplier/Transporter", rectLeftX + col1Width + col2Width - 1, rectTopY + rowHeight * 1.5 + 1.2);
	doc.text("Triplicate for Supplier", rectLeftX + col1Width + col2Width - 1, rectTopY + rowHeight * 2.5 + 1.2);

	let mainY = rectTopY + 22;
	let lineSpace=4;
	let verticleLine = mainY+12;
	const piNo = document.getElementById('pi_id').value;
	const invoice_date = document.getElementById('pidateTime').value;
	const formattedPIDate = formatDateToDDMMYYYY(invoice_date);
	const stateCode = "";
	
	mainY = mainY + lineSpace;
	
	doc.text(`Invoice No. :${piNo}`,rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text(`Invoice Date: ${formattedPIDate}`,rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text("State: Karnataka",rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text("State Code : 29",rectLeftX+2,mainY);
	
	mainY = rectTopY + 26; //resent the mainY to display vendorcode from begining again
	
	// verticle line
	//right rect
	const rightRectWidth = 110;
	const rightRectX = pageWidth - 5 - rightRectWidth; // 5mm margin from the right edge
	
	// Vertical line between left and right sections
	const centerX = (rectLeftX + (pageWidth - 5)) / 2;
	doc.line(centerX, mainY - 6, centerX, mainY + 18);
	
	//doc.rect(,mainY - 4);
	//doc.line(verticalLineX, mainY - 2, verticalLineX, mainY + 18); // Y range can be adjusted as needed
	const pi_vendor_code = document.getElementById("pi_vendor_code").value;
	const trasnportMode = document.getElementById('pi_transportMode').value;
	const vehicleNo = document.getElementById('pi_vehicle_No').value;
	const dateOfSypply = "";
	const placeToSupply = "";
	
	doc.text(`Vender Code: ${pi_vendor_code}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Transportation Mode : ${trasnportMode}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Vehicle Number: ${vehicleNo}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Date of Supply: ${dateOfSypply}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Place of Supply: ${placeToSupply}`,centerX +2,mainY);
	
	// Horizontal line below "Place of Supply:"
	doc.setLineWidth(0.1); // Optional: adjust line thickness
	//doc.line(pdfMainBorderPAdding, mainY+2, pageWidth - 10, mainY+2);
	mainY = mainY;
	doc.line(pdfMainBorderPAdding, mainY+2, pageWidth - 10, mainY+2 );
		
	mainY = mainY + lineSpace;
	
	let pi_billing_address = document.getElementById("pi_billing_address").value;
	
	let currentY = mainY+3;	
	// Set starting Y position
	const startY = currentY; // for vertical line
	const lineHeight = 4; // spacing between lines
    const piVendorName = document.getElementById("pi_cust_name").value;
    const billingGSTNo = document.getElementById("pi_gstnumberr1").value;
    const pi_state = document.getElementById("pi_state").value;
    
    const pi_state_element = document.getElementById("pi_state");
    let pi_state_name = pi_state_element.selectedOptions[0].text;
    if (pi_state_name === "Select State") {
        pi_state_name = "";
    }    
    
	const pi_state_code = document.getElementById("pi_state_code").value;
    
	doc.text("Details of Receiver / Billed to :", rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	doc.text("Name : ", rectLeftX + 2, currentY);
	doc.text(piVendorName, rectLeftX + 13, currentY);
	currentY += lineHeight;
	// Address: wrap to fit page width
	const maxTextWidth = (pageWidth / 2) - 10; // half the page with margin
	const wrappedAddress = doc.splitTextToSize(`Address : ${pi_billing_address}`, maxTextWidth);
	
	let shippedADdress = document.getElementById("pi_shipping_address").value;
    
	doc.text(wrappedAddress, rectLeftX + 2, currentY);
	currentY += wrappedAddress.length * lineHeight;
	
	doc.text("GSTIN :", rectLeftX + 2, currentY);
	doc.text(`${billingGSTNo}`,rectLeftX + 14,currentY)
	currentY += lineHeight;
	
	doc.text(`State : ${pi_state_name}`, rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	doc.text(`State Code: ${pi_state_code}`, rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	//centerX +2
	currentY = mainY+3;
	doc.text("Details of Consignee / Shipped to :", centerX +2, currentY);
	currentY += lineHeight;
	doc.text("Name :", centerX +2, currentY);
	doc.text(piVendorName, centerX + 14, currentY);
	currentY += lineHeight;
	
	// Wrap the address text
	const maxTextWidth1 = (pageWidth / 2) - 15; // Set max width to half page minus margins
	// alert(shippedADdress);
	const wrappedAddress1 = doc.splitTextToSize(`Address : ${shippedADdress}`, maxTextWidth1);
	
	doc.text(wrappedAddress1, centerX + 2, currentY);
	currentY += wrappedAddress1.length * lineHeight;
	
	doc.text(`GSTIN : ${billingGSTNo}`, centerX +2, currentY);
	currentY += lineHeight;
	doc.text(`State : ${pi_state_name}`, centerX +2, currentY);
	currentY += lineHeight;
	doc.text(`State Code: ${pi_state_code}`, centerX + 2, currentY);
	currentY += lineHeight;
	
	doc.line(pdfMainBorderPAdding, currentY, pageWidth - 10, currentY);
	doc.text("PO No :",35,currentY+4);
	doc.text("PI NO :",130,currentY+4);
	
	// doc.line(5, currentY+4, pageWidth - 5, currentY+3);
	// Dynamically draw vertical line using final Y value between  / Billed to : AND / Shipped to :
	doc.line(centerX , startY - 5, centerX, currentY);
    
	// Move a little below the last line
	let tableY = currentY + 5.5;
	const startX = pdfMainBorderPAdding;
	const endX = pageWidth - pdfMainBorderPAdding;
	const tableRowHeight = 8;
	
	const cellPaddingX = 2; // Left padding
	const cellPaddingY = 2.5; // Top padding
	
	// Define column headers and their widths
	const columns = [
	  { title: "Sr. No", width: 16 },
	  { title: "Name of Products /Service", width: 81.5 },
	  { title: "HSN/ACS", width: 18.5	},
	  { title: "Qty", width: 20},
	  { title: "Price", width: 25 },
	  { title: "Taxable Value", width: 29 },
	];

	// Draw table header
	doc.setFontSize(9);
	doc.setFont("helvetica", "normal");
	doc.setLineWidth(0.1); // Set thinner borders for table

	let currentX = startX;
	// Header
	columns.forEach(col => {
	
	  doc.rect(currentX, tableY, col.width, tableRowHeight + 2);
	  const lines = doc.splitTextToSize(col.title, col.width - cellPaddingX * 2);
	  lines.forEach((line, lineIndex) => {
		  const textWidth = doc.getTextWidth(line);
		  const textX = currentX + (col.width - textWidth) / 2;

		  const totalTextHeight = lines.length * lineHeight; // Approx vertical size
		  const baseY = tableY + (tableRowHeight - totalTextHeight) / 2 + (lineIndex * lineHeight) + 4;

		  doc.text(line, textX, baseY);
		});

	  currentX += col.width;
	});

	tableY += tableRowHeight + 2;
	const minRowCount = 5;
	const formatValue = (val) => val && !isNaN(val) ? parseFloat(val).toFixed(2) : "";
	const safe = (val) => val && val !== "null" ? val : "";

	const tableBody = document.querySelector("#pi_items_table tbody");
	const rows = tableBody.querySelectorAll("tr");

	rows.forEach((row, rowIndex) => {
	  const cells = row.querySelectorAll("input");
	  
	  const rowData = [
		  rowIndex + 1,                      // Sr. No
		  safe(cells[1].value),             // Module Name
		  safe(cells[3].value),             // HSN Code
		  safe(cells[5].value),             // Quantity
		  safe(cells[6].value),             // Price
		  formatValue(cells[7].value),      // Taxable Value
		];


		  // Determine how many lines max in this row
		  let maxLinesInRow = 1;
		  const cellLinesArray = rowData.map((cell, idx) => {
		    const col = columns[idx];
		    const lines = doc.splitTextToSize(cell.toString(), col.width - cellPaddingX * 2);
		    maxLinesInRow = Math.max(maxLinesInRow, lines.length);
		    return lines;
		  });

		  const tableRowHeight = maxLinesInRow * lineHeight;

		  let currentX = startX;
		  cellLinesArray.forEach((lines, idx) => {
			  const col = columns[idx];

			  // Draw cell
			  doc.rect(currentX, tableY, col.width, tableRowHeight + 4);

			  lines.forEach((line, lineIndex) => {
			    const textY = tableY + cellPaddingY + lineIndex * lineHeight + 4;

			    if ([0, 2, 3, 4, 5].includes(idx)) {
			      // Center align HSN, Qty, Price
			      doc.text(line, currentX + col.width / 2, textY, { align: 'center' });
			    } else {
			      // Default left align
			      doc.text(line, currentX + cellPaddingX, textY);
			    }
			  }); 
			  currentX += col.width;
			});

		  // Move down for next row
		  tableY += tableRowHeight + 4;
		});

		// Add blank rows if needed
		const actualRowCount = rows.length;
		const emptyRowsToAdd = Math.max(0, minRowCount - actualRowCount);

		for (let i = 0; i < emptyRowsToAdd; i++) {
		  const tableRowHeight = lineHeight; // 1 line per empty row
		  let currentX = startX;

		  columns.forEach(col => {
		    doc.rect(currentX, tableY, col.width, tableRowHeight + 6);
		    currentX += col.width;
		  });

		  tableY += tableRowHeight + 6;
		}
		
	let totalPrice = 0;
	let totalTaxable = 0;
	let totalCGST = 0;
	let totalSGST = 0;
	let totalIGST = 0;
	let grandTotal = 0;
	
	let leftX = 107.5;
	let rightX = 200;

	let totalBeforeTax = 0;
	let totalGST = 0;
	let totalAfterGST = 0;
	let tcs = parseFloat(document.getElementById("summary-tcs").innerText) || 0.00;
	let finalTotal = 0;
	
	// First pass: Accumulate totals
	rows.forEach(row => {
	  const cells = row.querySelectorAll("input");

	  totalPrice += parseFloat(cells[6].value) || 0;
	  totalTaxable += parseFloat(cells[7].value) || 0;
	  totalCGST += parseFloat(cells[8].value) || 0;
	  totalSGST += parseFloat(cells[9].value) || 0;
	  totalIGST += parseFloat(cells[10].value) || 0;
	  grandTotal += parseFloat(cells[11].value) || 0;
	});
	
	totalBeforeTax = totalTaxable;
	totalGST = totalCGST + totalSGST + totalIGST;
	totalAfterGST = totalBeforeTax + totalGST;
	//tcs = parseFloat((totalAfterGST * 0.001).toFixed(2)); // 0.1% TCS
	finalTotal = totalAfterGST + tcs;
 
	tableY += tableRowHeight;
	// Footer content
	let footerY = tableY - 3;
	doc.setFontSize(9);
	doc.setFont("helvetica", "normal");

	// Bank Details and Terms
	doc.setFont("helvetica", "normal");
	
	
	// bank details rect
	doc.rect(pdfMainBorderPAdding, footerY - 5, 97.5, 55);
	
	
	doc.setFont("helvetica", "bold");
	doc.text("Bank Details :", pdfMainBorderPAdding + 2, footerY);
	doc.setFont("helvetica", "normal");
	doc.text("Bank Name : HDFC Bank ", pdfMainBorderPAdding + 2, footerY + 4);
	doc.text("Branch Name: BANGALORE - SESHADRIPURAM ",  pdfMainBorderPAdding+2, footerY + 8);
	doc.text("Bank Account Number : 03677630001106", pdfMainBorderPAdding+2, footerY + 12);
	doc.text("Bank Branch IFSC : HDFC0000367", pdfMainBorderPAdding+2, footerY + 16);
	
	footerY += 21;
	// Total in Words
	//doc.rect(pdfMainBorderPAdding, footerY , 97.5, 12);
	//doc.text("Total Invoice Amount in Words :", pdfMainBorderPAdding + 2, footerY+4);
	//doc.setFont("helvetica", "bold");
	
	 
	const roundOffInDecimal = document.getElementById("summary-roundoff").innerText; 
	const netAmount = document.getElementById("summary-final").innerText;
	const grandTotalInWords = numberToWords(Math.round(netAmount));
	
	//const gstReverseCharge = document.getElementById("gst-reverse-charge").innerText;
	const gstReverseCharge = parseFloat(document.getElementById("gst-reverse-charge").value) || 0;
	 
	//doc.text(`Rupees ${grandTotalInWords}`, pdfMainBorderPAdding + 2, footerY + 7);
	
	footerY = footerY - 22;
	
	
	doc.line(leftX, footerY - 4 , rightX, footerY - 4 );
	// Total summary
	doc.text("Total Amount Before Tax: ", 110, footerY);
	doc.text(totalBeforeTax.toFixed(2), 195, footerY , { align: 'right' });
	doc.line(leftX, footerY + 1 , rightX, footerY + 1 );
	
	doc.text("Add CGST(9%):", 110, footerY + 5);
	doc.text(totalCGST.toFixed(2), 195, footerY + 5, { align: 'right' });
	doc.line(leftX, footerY + 6 , rightX, footerY + 6 );
	
	doc.text("Add SGST(9%):", 110, footerY + 10);
	doc.text(totalSGST.toFixed(2), 195, footerY + 10, { align: 'right' });
	doc.line(leftX, footerY + 11 , rightX, footerY + 11 );
	
	doc.text("Add IGST(18%):", 110, footerY + 15);
	doc.text(totalIGST.toFixed(2), 195, footerY + 15, { align: 'right' });
	doc.line(leftX, footerY + 16 , rightX, footerY + 16 );
	
	doc.text("Tax Amount(GST) :", 110, footerY + 20);
	doc.text(totalGST.toFixed(2), 195, footerY + 20, { align: 'right' });
	doc.line(leftX, footerY + 21 , rightX, footerY + 21 );
	
	doc.text("Total Amount after GST and before TCS:", 110, footerY + 25);
	doc.text(totalAfterGST.toFixed(2), 195, footerY + 25, { align: 'right' });
	doc.line(leftX, footerY + 26 , rightX, footerY + 26 );
	
	doc.text("TCS @0.1%:", 110, footerY + 30);
	doc.text(tcs.toFixed(2), 195, footerY + 30, { align: 'right' });
	doc.line(leftX, footerY + 31 , rightX, footerY + 31 );
	
	doc.text("Total Amount After Tax:", 110, footerY + 35);
	doc.text(finalTotal.toFixed(2), 195, footerY + 35, { align: 'right' });
	doc.line(leftX, footerY + 36 , rightX, footerY + 36 );
	
	// GST Payable
	
	doc.text("GST Payable on Reverse Charges :", 110, footerY + 40);//gstReverseCharge
	doc.text(`${gstReverseCharge}`, 195, footerY + 40, { align: 'right' });
	doc.line(leftX, footerY + 41 , rightX, footerY + 41);  
	
	doc.text("Round off (in decimal):", 110, footerY + 45);//
	doc.text(`${roundOffInDecimal}`, 195, footerY + 45, { align: 'right' });
	doc.line(leftX, footerY + 46 , rightX, footerY + 46);  
	
	doc.setFont("helvetica", "bold");
	doc.text("Net Amount :", 110, footerY + 50);
	doc.text(`${netAmount}`, 195, footerY + 50, { align: 'right' });
	doc.line(leftX, footerY + 51 , rightX, footerY + 51);  
	
	footerY += 57.5;
	//Total Invoice Amount in words bottom border
	doc.line(pdfMainBorderPAdding, footerY, rightX, footerY );
	
	//footerY += 57.5;
	const footerSectionTopY = footerY;
	const footerSectionBottomY = pageHeight-22.5;
	const col2X = 107.5;
	const col3X = 142.5;
	
	// Draw vertical separators
	//doc.line(col2X, footerSectionTopY, col2X, footerSectionBottomY);
	
	//doc.text(`Total Invoice Amount in Words : ${grandTotalInWords}`, (pageWidth-20)/2, footerSectionTopY - 2);	
	doc.text(`Total Invoice Amount in Words : ${grandTotalInWords}`, pageWidth / 2, footerSectionTopY - 2, {
		  align: 'center'
		});

	//verticle lie between terms and condition  and QR
	doc.line(col3X, footerSectionTopY  , col3X, footerSectionBottomY);
 	
	// Stamp area (center)
	doc.setFont("helvetica", "italic");
	doc.text("", 108, footerY + 15); // optional placeholder
		
	// Signature block
	footerY += 10;
	doc.setFont("helvetica", "normal");
	//doc.text("For Melange Systems Pvt. Ltd", 145, footerY + 2);
	//doc.text("__________________", 145, footerY + 6);
	//doc.text("Authorised Signatory", 145, footerY + 9);
	
	// Terms and Conditions
	doc.setFont("helvetica", "normal");
	doc.text("Terms and Conditions :", pdfMainBorderPAdding + 2, footerY);
	doc.setFont("helvetica", "italic");
	doc.text("*Payment Terms :100% RTGS in Advance*", pdfMainBorderPAdding+2, footerY + 4);

	// Define rectangle dimensions
	const rectX = pdfMainBorderPAdding;
	const rectY = pageHeight-22.5;
	const rectWidth1 = pageWidth - 20; // full width minus margins
	const rectHeight1 = 4;

	// Draw the rectangle
	doc.rect(rectX, rectY, rectWidth1, rectHeight1);

	// Set font and center the text
	doc.setFont("helvetica", "normal");
	doc.text(
	  "Declaration: Certified That the Particulars Given Above are True and Correct.",
	  rectX + rectWidth1 / 2,
	  pageHeight-19,
	  { align: 'center' }
	);
	
	// Second rectangle (E.O. & E. and Jurisdiction)
	doc.rect(rectX, pageHeight-18.5, rectWidth1, rectHeight1);

	// Left aligned: E.O. & E.
	doc.text("E.O. & E.", rectX + 1, pageHeight-15);

	// Right aligned: Jurisdiction
	doc.text(
	  "Subject to Bangalore Jurisdiction Only",
	  rectX + rectWidth1 - 1,
	  pageHeight-15,
	  { align: 'right' }
	);
	
	doc.text("*This is a computer-generated quotation, no seal and signature required",rectX + 45,pageHeight-11);
 	
	// Show PDF
    //window.open(doc.output('bloburl'), '_blank');

}

//function to convert date formate
function formatDateToDDMMYYYY(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is zero-based
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
}

</script>

<!-- script to hide gst column based on tax type -->
<script>
function toggleGSTColumns(taxType) {
    const showIntrastate = taxType === 'intrastate';
    const showInterstate = taxType === 'interstate';

    // Header columns
    document.querySelectorAll('.cgst-saleheader, .sgst-saleheader').forEach(el => {
        el.style.display = showIntrastate ? '' : 'none';
    });
    document.querySelectorAll('.igst-saleheader').forEach(el => {
        el.style.display = showInterstate ? '' : 'none';
    });

    // Table row columns
    document.querySelectorAll('.cgst-value, .sgst-value').forEach(el => {
        el.style.display = showIntrastate ? '' : 'none';
    });
    document.querySelectorAll('.igst-value').forEach(el => {
        el.style.display = showInterstate ? '' : 'none';
    });
}
</script>
<!-- script to state code -->
<script>
  function setStateCode() {
	 
    const select = document.getElementById("pi_state");
    const codeInput = document.getElementById("pi_state_code");
    codeInput.value = select.value;
    
  }

    function   setStateCodeInPerformaInvoiceModal() {
	 
    const select = document.getElementById("performa_state");
    const codeInput = document.getElementById("performa_state_code");
    codeInput.value = select.value;
    
  }
</script>

<!-- <script>
function updateSummary() {
	  let total = 0, cgst = 0, sgst = 0, igst = 0;

	  document.querySelectorAll(".saletotal-without-gst").forEach(el => total += parseFloat(el.value || 0));
	  document.querySelectorAll(".salecgst").forEach(el => cgst += parseFloat(el.value || 0));
	  document.querySelectorAll(".salesgst").forEach(el => sgst += parseFloat(el.value || 0));
	  document.querySelectorAll(".saleigst").forEach(el => igst += parseFloat(el.value || 0));
	  /* document.getElementById("apply-tcs").addEventListener("change", updateSummary); */

	  const tax = cgst + sgst + igst;
	  const totalAfterGSTBeforeTCS = total + tax;

	  // Check if TCS should be applied
	  const applyTCS = document.getElementById("apply-tcs").value === "yes";
	  const tcs = applyTCS ? (totalAfterGSTBeforeTCS * 0.001) : 0;

	  // Reverse charge input value
	  const reverseCharge = parseFloat(document.getElementById("gst-reverse-charge").value) || 0;
	
	  const totalWithTax = total + tax + tcs ;
	  const totalWithTaxWithReverseCharge = total + tax + tcs + reverseCharge;

	  // Round final value
	  const roundType = document.getElementById("round-type").value;
	  let finalAmount, roundOff = 0;

	/*   switch (roundType) {
	    case "even":
	      finalAmount = Math.round(totalWithTaxWithReverseCharge);
	      break;
	    case "down":
	      finalAmount = Math.floor(totalWithTaxWithReverseCharge);
	      break;
	    case "up":
	      finalAmount = Math.ceil(totalWithTaxWithReverseCharge);
	      break;
	  } */
	  
	  let rounded = Math.round(totalWithTaxWithReverseCharge);

	  switch (roundType) {
	    case "even":
	      if (rounded % 2 !== 0) {
	        finalAmount = (rounded > totalWithTaxWithReverseCharge) ? rounded - 1 : rounded + 1;
	      } else {
	        finalAmount = rounded;
	      }
	      break;
	    case "odd":
	      if (rounded % 2 === 0) {
	        finalAmount = (rounded > totalWithTaxWithReverseCharge) ? rounded - 1 : rounded + 1;
	      } else {
	        finalAmount = rounded;
	      }
	      break;
	    default:
	      finalAmount = rounded; // fallback if needed
	  }

	  roundOff = (finalAmount - totalWithTaxWithReverseCharge).toFixed(2);

	  // Update summary values
	  document.getElementById("summary-total").innerText = total.toFixed(2);
	  document.getElementById("summary-cgst").innerText = cgst.toFixed(2);
	  document.getElementById("summary-sgst").innerText = sgst.toFixed(2);
	  document.getElementById("summary-igst").innerText = igst.toFixed(2);
	  document.getElementById("summary-tcs").innerText = tcs.toFixed(2);
	  document.getElementById("summary-tax").innerText = (tax + tcs).toFixed(2);
	  document.getElementById("summary-with-tax").innerText = totalWithTax.toFixed(2);
	  // document.getElementById("summary-roundoff").innerText = roundOff;
	  //document.getElementById("summary-final").innerText = finalAmount.toFixed(2);
	  
	  const roundRow = document.querySelector("#summary-roundoff").closest("tr");

	// Extract decimal part as string
	  const decimalPart = totalWithTaxWithReverseCharge.toString().split(".")[1] || "00";

	  if (decimalPart === "00") {
		    roundRow.style.display = "none";
		    roundOff = 0.00;
		    finalAmount = totalWithTaxWithReverseCharge;
		} else {
		    roundRow.style.display = "table-row";
		    roundOff = (finalAmount - totalWithTaxWithReverseCharge).toFixed(2);
		}

	  document.getElementById("summary-roundoff").innerText = roundOff;
	  document.getElementById("summary-final").innerText = finalAmount.toFixed(2);
	  
	  document.getElementById("summary-gst-tax").innerText = tax.toFixed(2);
	  document.getElementById("total-amount-after-GST-before-TCS").innerText = totalAfterGSTBeforeTCS.toFixed(2);
	  document.getElementById("total-amount-after-revese-charge").innerText = totalWithTaxWithReverseCharge.toFixed(2);

	}
	
//Add this ONCE, outside of updateSummary
document.getElementById("apply-tcs").addEventListener("change", updateSummary);
document.getElementById("round-type").addEventListener("change", updateSummary);
document.getElementById("gst-reverse-charge").addEventListener("input", updateSummary);
//Optionally call once at load
updateSummary();

</script> -->

<script>
function updateSummary() { 

    let total = 0, cgst = 0, sgst = 0, igst = 0;

    document.querySelectorAll(".saletotal-without-gst").forEach(el => total += parseFloat(el.value || 0));
    document.querySelectorAll(".salecgst").forEach(el => cgst += parseFloat(el.value || 0));
    document.querySelectorAll(".salesgst").forEach(el => sgst += parseFloat(el.value || 0));
    document.querySelectorAll(".saleigst").forEach(el => igst += parseFloat(el.value || 0));
   
    const tax = cgst + sgst + igst;
    const totalAfterGSTBeforeTCS = total + tax;

    const applyTCS = document.getElementById("apply-tcs").value === "yes";
    const tcs = applyTCS ? (totalAfterGSTBeforeTCS * 0.001) : 0;

    const reverseCharge = parseFloat(document.getElementById("gst-reverse-charge").value) || 0;

    const totalWithTax = total + tax + tcs;
    const totalWithTaxWithReverseCharge = totalWithTax + reverseCharge;

    let finalAmount = 0;
    let roundOff = 0;

    const roundTypeEl = document.getElementById("round-type");
    const roundRow = document.querySelector("#summary-roundoff").closest("tr");

    const decimalPart = totalWithTaxWithReverseCharge.toFixed(2).split(".")[1];

    if (decimalPart === "00") {
        // No rounding needed
        roundRow.style.display = "none";
        roundTypeEl.disabled = true;
        roundOff = 0.00;
        finalAmount = totalWithTaxWithReverseCharge;
    } else {
        // Apply rounding
        roundRow.style.display = "table-row";
        roundTypeEl.disabled = false;

        const rounded = Math.round(totalWithTaxWithReverseCharge);
        const roundType = roundTypeEl.value;

        switch (roundType) {
            case "even":
                finalAmount = (rounded % 2 !== 0)
                    ? (rounded > totalWithTaxWithReverseCharge ? rounded - 1 : rounded + 1)
                    : rounded;
                break;
            case "odd":
                finalAmount = (rounded % 2 === 0)
                    ? (rounded > totalWithTaxWithReverseCharge ? rounded - 1 : rounded + 1)
                    : rounded;
                break;
            default:
                finalAmount = rounded;
        }

        roundOff = (finalAmount - totalWithTaxWithReverseCharge).toFixed(2);
    }

    // Update DOM
    document.getElementById("summary-total").innerText = total.toFixed(2);
    document.getElementById("summary-cgst").innerText = cgst.toFixed(2);
    document.getElementById("summary-sgst").innerText = sgst.toFixed(2);
    document.getElementById("summary-igst").innerText = igst.toFixed(2);
    document.getElementById("summary-tcs").innerText = tcs.toFixed(2);
    document.getElementById("summary-tax").innerText = (tax + tcs).toFixed(2);
    document.getElementById("summary-with-tax").innerText = totalWithTax.toFixed(2);
    document.getElementById("summary-roundoff").innerText = roundOff;
    document.getElementById("summary-final").innerText = finalAmount.toFixed(2);
    document.getElementById("summary-gst-tax").innerText = tax.toFixed(2);
    document.getElementById("total-amount-after-GST-before-TCS").innerText = totalAfterGSTBeforeTCS.toFixed(2);
    document.getElementById("total-amount-after-revese-charge").innerText = totalWithTaxWithReverseCharge.toFixed(2);
    
}
document.getElementById("apply-tcs").addEventListener("change", updateSummary);
document.getElementById("round-type").addEventListener("change", updateSummary);
document.getElementById("gst-reverse-charge").addEventListener("input", updateSummary);
updateSummary(); // Call once on load


</script>

<!-- script to update performa invoice summary table -->
<script>
function updateSummaryPerformaInvoice() {
    let total = 0, cgst = 0, sgst = 0, igst = 0;

    document.querySelectorAll(".performa-saletotal-without-gst").forEach(el => total += parseFloat(el.value || 0));
    document.querySelectorAll(".performa-salecgst").forEach(el => cgst += parseFloat(el.value || 0));
    document.querySelectorAll(".performa-salesgst").forEach(el => sgst += parseFloat(el.value || 0));
    document.querySelectorAll(".performa-saleigst").forEach(el => igst += parseFloat(el.value || 0));
     
 
    const tax = cgst + sgst + igst;
    const totalAfterGSTBeforeTCS = total + tax;

    const applyTCS = document.getElementById("performa_apply-tcs").value === "yes";
    const tcs = applyTCS ? (totalAfterGSTBeforeTCS * 0.001) : 0;

    const reverseCharge = parseFloat(document.getElementById("performa_gst-reverse-charge").value) || 0;

    const totalWithTax = total + tax + tcs;
    const totalWithTaxWithReverseCharge = totalWithTax + reverseCharge;

    let finalAmount = 0;
    let roundOff = 0;

    const roundTypeEl = document.getElementById("performa_round-type");
    const roundRow = document.querySelector("#performa_summary-roundoff").closest("tr");

    const decimalPart = totalWithTaxWithReverseCharge.toFixed(2).split(".")[1];

    if (decimalPart === "00") {
        // No rounding needed
        roundRow.style.display = "none";
        roundTypeEl.disabled = true;
        roundOff = 0.00;
        finalAmount = totalWithTaxWithReverseCharge;
    } else {
        // Apply rounding
        roundRow.style.display = "table-row";
        roundTypeEl.disabled = false;

        const rounded = Math.round(totalWithTaxWithReverseCharge);
        const roundType = roundTypeEl.value;

        switch (roundType) {
            case "even":
                finalAmount = (rounded % 2 !== 0)
                    ? (rounded > totalWithTaxWithReverseCharge ? rounded - 1 : rounded + 1)
                    : rounded;
                break;
            case "odd":
                finalAmount = (rounded % 2 === 0)
                    ? (rounded > totalWithTaxWithReverseCharge ? rounded - 1 : rounded + 1)
                    : rounded;
                break;
            default:
                finalAmount = rounded;
        }

        roundOff = (finalAmount - totalWithTaxWithReverseCharge).toFixed(2);
    }

    
    // Update DOM
    document.getElementById("performa_summary-total").innerText = total.toFixed(2);
    document.getElementById("performa_summary-cgst").innerText = cgst.toFixed(2);
    document.getElementById("performa_summary-sgst").innerText = sgst.toFixed(2);
    document.getElementById("performa_summary-igst").innerText = igst.toFixed(2);
    document.getElementById("performa_summary-tcs").innerText = tcs.toFixed(2);
    document.getElementById("performa_summary-tax").innerText = (tax + tcs).toFixed(2);
    document.getElementById("performa_summary-with-tax").innerText = totalWithTax.toFixed(2);
    document.getElementById("performa_summary-roundoff").innerText = roundOff;
    document.getElementById("performa_summary-final").innerText = finalAmount.toFixed(2);
    document.getElementById("performa_summary-gst-tax").innerText = tax.toFixed(2);
    document.getElementById("performa_total-amount-after-GST-before-TCS").innerText = totalAfterGSTBeforeTCS.toFixed(2);
    document.getElementById("performa_total-amount-after-revese-charge").innerText = totalWithTaxWithReverseCharge.toFixed(2);
    
}
document.getElementById("performa_apply-tcs").addEventListener("change", updateSummaryPerformaInvoice);
document.getElementById("performa_round-type").addEventListener("change", updateSummaryPerformaInvoice);
document.getElementById("performa_gst-reverse-charge").addEventListener("input", updateSummaryPerformaInvoice);
updateSummaryPerformaInvoice(); // Call once on load

</script>


</body>
</html>
