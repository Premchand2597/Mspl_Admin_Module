<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  
<head>
  <title>Quotation List</title>
  
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> -->
  <link rel="stylesheet" href="/assets/css/all.min.css"> 
  
 <!--  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
 -->
   <link rel="stylesheet" href="/assets/font/fonts.css"> 
   
  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!--   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">
  <!--  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
  <script src="assets/js/jquery-3.6.4.min.js"></script> 

</head>


<style>
	
/* 	table {
	width: 100%;
	min-width: 100%;
	table-layout: auto;
	white-space: nowrap;
}

table th, table td {
    width: auto; 
    white-space: nowrap; 
    padding: 10px;
}

th:nth-child(1), td:nth-child(1) { width: 20%; } 
th:nth-child(2), td:nth-child(2) { width: 15%; } 
th:nth-child(3), td:nth-child(3) { width: 25%; } 
th:nth-child(4), td:nth-child(4) { width: 40%; }  */

/* Set table layout */

        /* Style for pagination buttons */
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            border: 1px solid #007bff;
            color: #007bff;
            background: white;
            transition: 0.3s;
             cursor:default;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #007bff !important;
            color: white !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #0056b3 !important;
            color: white !important;
             cursor:default;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            color: #999 !important;
            border-color: #ddd;
        }

        /* Custom ellipsis style */
        .paginate_button.ellipsis {
            cursor:default;
            border: none;
            background: none;
            color: #999;
            padding: 5px 10px;
        }
        
        
  .sendEmailForCustomerOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 100;
   	display: none;
   	pointer-events: auto;
   }
   
   .viewQuotationOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 99;
   	display: none;
   	pointer-events: auto;
   }
   
   .revise_QuotationOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 103;
   	display: none;
   	pointer-events: auto;
   }
   
   .viewQuotationInnerBox{
   	width: 98%;
   	height: 96%;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
   }
   
   .revise_QuotationInnerBox{
   	width: 98%;
   	height: 96%;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
   }
   
   .emailPasswordOuterDiv{
   	width: 100%;
   	height: 100%;
   	position: fixed;
   	background: rgba(0,0,0,0.5);
   	top: 0;
   	left: 0;
   	z-index: 101;
   	display: none;
   	pointer-events: auto;
   }
   
   .sendEmailForCustomerInnerBox{
	width: 60%;
   	height: 96%;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
}

.emailPasswordInnerBox{
	width: 40%;
   	height: auto;
   	background: rgb(255,255,255);
   	margin: 1% auto;
   	border-radius: 5px;
   	overflow: auto;
   	pointer-events: auto;
}

.candidatePrfoilesHeading{
	font-family: 'Montserrat'; 
	font-size: 15px; 
	font-weight: bold; 
	text-transform: uppercase;
}

  .emailFormInnerBoxCloser{
   	/* background: red; */
   	padding-right: 10px;
   	text-align: right;
   }
   
   .emailFormInnerBoxCloser span{
   	font-size: 25px;
   	font-weight: bold;
   	cursor: pointer;
   }
   
   .sendEmailForCustomerBodyBox{
   	width: 100%;
   	height: 90%;
   	background: #fff;
   	overflow: auto;
   }
   
   .modal-backdrop {
    z-index: 1049 !important; /* Ensure Bootstrap's backdrop is below the custom modal */
  }
  
  #loadingPopup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5); /* Dim background */
    z-index: 9999;
    font-family: Arial, sans-serif;
    color: white; /* Text color for better contrast */
    display: none;
}

#loadingPopup p {
    margin-top: 20px;
    font-size: 18px;
    font-weight: bold;
    color: white;
}

.spinnerAndParaMerger{
	display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    /* background: red; */
    margin: 18% auto;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 6px solid rgba(255, 255, 255, 0.3); /* Semi-transparent border */
    border-top-color: white; /* Bright top border */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

	.revise_suggestions {
          position: absolute;
          background: white;
          border: 1px solid #ccc;
          border-top: none;
          max-height: 150px;
          overflow-y: auto;
          width: 22.5%;
          z-index: 1000;
          display: none;
          font-size:14px;
      }
      .revise_suggestions div {
          padding: 8px;
          cursor: pointer;
      }
      .revise_suggestions div:hover {
          background: #f1f1f1;
      }
    </style>
<body>

<div id="loadingPopup">
	<div class="spinnerAndParaMerger">
	    <div class="spinner"></div>
	    <p id="loadingPopupPara"></p>
    </div>
</div>

<div class="sendEmailForCustomerOuterDiv" id="sendEmailForCustomerOuterDiv">
	 <div class="sendEmailForCustomerInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">Send Mail</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeSendEmailForCustomerOuterDiv();">&times;</span></p>		               	  
			</div>
			<div class="card-body sendEmailForCustomerBodyBox mt-1">
			
				<div style="width: 96%; margin-left: auto; margin-right: auto;">
					<input class="form-check-input border border-primary" type="checkbox" id="emailManuallySentCheckBox">
					<label style="font-size: 14px;">Update status as email has been sent manually to the customer</label>
				</div>
			
				<div class="table-responsive" style="width: 96%; margin-left: auto; margin-right: auto;">
					<table style="width: 100%; font-size: 14px;">
						<tr>
							<th style="text-align: left; margin-bottom: 10px; margin-top: 10px;">From</th>
							<td><input type="text" th:value="${session.email}" readonly style="font-size: 14px; margin-bottom: 10px; margin-top: 10px;" class="form-control" id="emailFromAddress"></td>
						</tr>
						<tr>
							<th style="text-align: left; margin-bottom: 10px;">To</th>
							<td><input type="text" style="font-size: 14px; margin-bottom: 10px;" class="form-control" id="emailToAddress"></td>
						</tr>
						<tr>
							<th style="text-align: left; margin-bottom: 10px;">CC</th>
							<td><input type="text" style="font-size: 14px; margin-bottom: 10px;" class="form-control" id="emailCCAddress"></td>
						</tr>
						<tr>
							<th style="text-align: left; margin-bottom: 10px;">Subject</th>
							<td><input type="text" style="font-size: 14px; margin-bottom: 20px;" class="form-control" id="emailSubject"></td>
						</tr>
						<tr>
							<td style="padding-left: 3px; padding-right: 3px;" colspan="2">
								<textarea class="form-control" placeholder="Body" style="font-size: 14px; margin-bottom: 10px;" id="emailBody" rows="4"></textarea>
							</td>
						</tr>
					</table>
				</div>
				
				<div style="width: 96%; margin-left: auto; margin-right: auto;">
					<div class="col-sm-12 form-group mt-4 modal-footer table-responsive p-2">
						<button type="button" id="downloadPdfManuallyBtn" class="btn btn-danger mx-1" style="font-size: 14px; display: none;" onclick="downloadPDF()"> <i class="fas fa-file-pdf"></i>Download PDF</button>
						<button type="button" id="email_send_button" class="btn btn-primary" onclick="openEmailPasswordOuterDiv()" style="font-size: 14px; float: right;">Send</button>
					</div>
				</div>
			
			</div>
		</div>
	</div>

<div class="emailPasswordOuterDiv" id="emailPasswordOuterDiv">
	 <div class="emailPasswordInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">Please Enter Email Password</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeEmailPasswordOuterDiv();">&times;</span></p>		               	  
			</div>
			<div class="card-body mt-1" style="padding-bottom: 10px;">
			
				<div class="table-responsive" style="width: 96%; margin-left: auto; margin-right: auto;">
					<div class="col-sm-12 form-group mb-2" style="padding-left: 3px; padding-right: 3px;">
						<input type="text" class="form-control mt-2" id="ionos_password">
					</div>
				</div>
				
				<div class="table-responsive" style="width: 96%; margin-left: auto; margin-right: auto;">
					<div class="col-sm-12 form-group p-2">
						<button type="button" class="btn btn-primary" id="emailSendBtn" onclick="sendDataToEmailToTheParticularCustomer();" style="font-size: 14px; float: right;">Submit</button>
					</div>
				</div>
				
			</div>
		</div>
	</div>

	
	<div class="modal fade" id="dcModal" tabindex="-1" aria-labelledby="dcModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-lg">
		    <div class="modal-content shadow-lg border-0 rounded-4">
		      <div class="modal-header bg-primary text-white rounded-top-4">
		        <h5 class="modal-title" id="dcModalLabel">Delivery Challan</h5>
		        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
		      </div>

		      <div class="modal-body px-4 py-3">
				
				<input type="hidden" id="dcPurchaseOrderId" name="purchaseOrderId">
				<input type="hidden" id="dcQuotationId" name="quotationId">

		        <!-- Supplier Address -->
		        <div class="mb-4">
		          <label class="form-label fw-bold">Supplier Address:</label>
		          <div class="bg-light p-3 rounded border">
		           <strong> Melange Systems Pvt Ltd.</strong><br>
		            4/1, 7th Cross Railway Parallel Road<br>
		            Kumara Park West<br>
		            Bangalore - 560020
		          </div>
		        </div>

		        <div class="row g-3">
					<!-- Buyer (Bill to) with Address Textarea, full width -->
					 <div class="col-12">
					   <label for="buyer" class="form-label">Buyer (Bill to)</label>
					   <div id="buyer" class="form-control bg-white" contenteditable="false" style="min-height: 100px;"></div>
					   <!-- Delivery Address, full width -->
					   			     <div class="col-12">
					   			         <label for="deliveryAddressdcc" class="form-label">Delivery Address</label>
					   			         <div id="deliveryAddressdcc" class="form-control bg-white" contenteditable="false" style="min-height: 100px;"></div>
					   			     </div>
					   				 
					 </div>

					 <!-- Delivery Note No. -->
					 <div class="col-md-6">
					   <label for="deliveryNoteNo" class="form-label">Delivery Note No.</label>
					   <input type="text" class="form-control" id="deliveryNoteNo" readonly>
					 </div>

					 <!-- Dated -->
					 <div class="col-md-6">
					   <label for="dated" class="form-label">Dated</label>
					   <input type="date" class="form-control" id="dated">
					 </div>
		          <!-- Reference No. & Date -->
		          <div class="col-md-6">
		            <label for="referenceNoDate" class="form-label">PO No. & Date</label>
		            <input type="text" class="form-control" id="referenceNoDate">
		          </div>

		          <!-- Other References -->
		          <div class="col-md-6">
		            <label for="otherReferences" class="form-label">Other References</label>
		            <input type="text" class="form-control" id="otherReferences">
		          </div>

		          


		          <!-- Terms of Delivery -->
		          <div class="col-md-6">
		            <label for="termsOfDelivery" class="form-label">Terms of Delivery</label>
		            <input type="text" class="form-control" id="termsOfDelivery">
		          </div>
				  <!-- Buyer's Order No. -->
				  <div class="col-md-6">
				    <label for="buyersOrderNo" class="form-label">Buyer’s Order No.</label>
				    <input type="text" class="form-control" id="buyersOrderNo">
				  </div>

				

				  <!-- Mode/Terms of Payment -->
				  <div class="col-md-6">
				    <label for="paymentTerms" class="form-label">Mode/Terms of Payment</label>
				    <input type="text" class="form-control" id="paymentTerms">
				  </div>
				  <!-- Dated (for Buyer's Order No.) -->
				  		  <div class="col-md-6">
				  		    <label for="buyersOrderDate" class="form-label">Dated</label>
				  		    <input type="date" class="form-control" id="buyersOrderDate">
				  		  </div>
		        
		        </div>

		        <!-- Table for Goods -->
		        <div class="mt-4">
		          <table class="table table-bordered">
		            <thead class="table-light">
		              <tr>
		                <th>Sl</th>
		                <th>Description of Goods</th>
		                <th>HSN/SAC</th>
		                <th>Quantity</th>
		                <th>Rate</th>
		                <th>Per</th>
		                <th>Amount</th>
		              </tr>
		            </thead>
		            <tbody id="goodsTableBody">
		              <!-- Dynamically added rows will go here -->
		              <tr>
		                <td>1</td>
		                <td><input type="text" class="form-control"  placeholder="Enter description"></td>
		                <td><input type="text" class="form-control"  placeholder="Enter HSN/SAC"></td>
		                <td><input type="number" class="form-control"  placeholder="Enter quantity"></td>
		                <td><input type="number" class="form-control"  placeholder="Enter rate"></td>
		                <td><input type="text" class="form-control"  placeholder="Enter unit"></td>
		                <td><input type="number" class="form-control"  placeholder="Enter amount" readonly></td>
		              </tr>
		            </tbody>
		          </table>
				  <!-- Tax Summary Display -->
				 
				   <div id="taxSummaryDiv" class="mt-3"></div>
				   <div id="amountInWordsDiv" class="mt-3 fw-bold text-start"></div>
				   <div id="roundedTotalDiv" class="mt-3 fw-bold text-start"></div>
				   
				   
				   <h6 class="fw-bold mt-4">Tax Summary</h6>
				   <table class="table table-bordered">
				     <thead class="table-light" id="taxTableHeader">
				       <tr>
				         <th rowspan="2">HSN/SAC</th>
				         <th rowspan="2">Taxable Value</th>
				         <th colspan="2" class="text-center  cgst-header">CGST</th>
				         <th colspan="2" class="text-center sgst-header">SGST</th>
				         <th colspan="2" class="text-center igst-header">IGST</th>
				         <th rowspan="2">Total Tax Amount</th>
				       </tr>
				       <tr>
				         <th  class="cgst-header">Rate (%)</th>
				         <th  class="cgst-header">Amount</th>
				         <th class="sgst-header">Rate (%)</th>
				         <th class="sgst-header">Amount</th>
				         <th class="igst-header">Rate (%)</th>
				         <th class="igst-header">Amount</th>
				       </tr>
				     </thead>
				     <tbody id="taxBreakdownBody">
				       <!-- JS will insert rows here -->
				     </tbody>
				   </table>
				   <div id="taxAmountInWordsDiv" class="fw-bold text-start mt-3"></div>
				   <div class="row mt-4">
				     <div class="col-md-8">
				       <label for="remarks" class="form-label fw-bold">Remarks</label>
				       <textarea id="remarks" class="form-control" rows="2" placeholder="Enter any remarks here"></textarea>
				     </div>
				     <div class="col-md-4">
				       <label for="companyPan" class="form-label fw-bold">Company PAN</label>
				       <input type="text" id="companyPan" class="form-control" placeholder="Enter Company PAN">
				     </div>
				   </div>

		        </div>
		      </div>

		      <div class="modal-footer bg-light border-top-0 rounded-bottom-4">
		 <!--       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		        <button type="button" class="btn btn-success" id="saveDCBtn" >Save DC</button>-->
				<button type="button" class="btn btn-primary" id="viewPdfBtn">
				   <i class="bi bi-eye"></i> View PDF
				 </button>
				 <button type="button" class="btn btn-success" id="downloadPdfBtn">
				   <i class="bi bi-download"></i> Download PDF
				 </button>
		      </div>
		    </div>
		  </div>
		</div>


	
	
	
	<div class="container-fluid m-0 mt-1">
	    <table id="productTable" class="table table-hover text-center table-bordered">
	        <thead class="table-primary">
	            <tr>
	                <th>SL No</th>
	                <th>Quotation ID</th>
	                <th>Purchase Order ID</th>
	                <th>Created Date</th>
	                <th>Created By (Emp ID)</th>
	                <th>Delivery Note No</th> <!-- New column for Delivery Note No -->
	                <th>View</th> <!-- View column -->
	            </tr>
	        </thead>
	        <tbody>
	            <tr th:each="dc, iterStat : ${deliveryChallans}">
	                <td th:text="${iterStat.count}">1</td>
	                <td th:text="${dc.quotationId}">Quotation ID</td>
	                <td th:text="${dc.purchaseOrderId}">PO ID</td>
					<td th:text="${#temporals.format(dc.createdDate, 'dd-MM-yyyy HH:mm:ss')}">Created Date</td>
	             <td th:text="${dc.createdByName}">Created By</td>
	                <td th:text="${dc.deliveryNoteNo}">Delivery Note No</td> <!-- Display Delivery Note No -->
					<!-- Hidden input field for ID -->
					              <input type="hidden" th:value="${dc.id}" th:id="'hiddenId_' + ${dc.id}" />
	                <td>
						<!-- Eye icon button -->
						<!-- Eye icon button to open modal -->
						   <button class="btn btn-link text-info" th:onclick="'viewDetails(' + ${dc.id} + ')'" title="View Details">
						       <i class="fa fa-eye"></i> <!-- Font Awesome eye icon -->
						   </button>
	                </td>
	            </tr>
	        </tbody>
	    </table>
	</div>
	
	
	

	<script>
	  let currentDcId = null; // Global variable to hold the selected dc.id
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
		    const table = document.getElementById("productTable").getElementsByTagName("tbody")[0];

		    function parseDate(dateStr) {
		        const [datePart, timePart] = dateStr.split(" ");
		        const [day, month, year] = datePart.split("-").map(Number);
		        const [hours, minutes, seconds] = timePart.split(":").map(Number);
		        return new Date(year, month - 1, day, hours, minutes, seconds);
		    }

		    function sortTable() {
		        let rows = Array.from(table.rows);

		        rows.sort((a, b) => {
		            const dateA = parseDate(a.cells[3].innerText.trim());
		            const dateB = parseDate(b.cells[3].innerText.trim());
		            return dateB - dateA; // Newest first
		        });

		        // Re-append rows in sorted order
		        rows.forEach((row, index) => {
		            row.cells[0].innerText = index + 1; // ✅ Renumber SL No
		            table.appendChild(row);
		        });
		    }

		    // Run once on page load
		    sortTable();
		});
		</script>


	
<script>
	function viewDetails(id) {
	    // Show the modal
		
		currentDcId = id;
	    $('#dcModal').modal('show');
	    
	    // Make an AJAX call to fetch data based on the ID
	    $.ajax({
	        url: '/delivery-challan/getDeliveryChallan/' + id,  // Change this URL to match your backend endpoint
	        type: 'GET',
	        success: function(response) {
	            // Assuming response is an object containing the delivery challan details
				console.log("Response receivedgoods:\n" + JSON.stringify(response, null, 2));

	            // Populate the modal fields with the fetched data
	            $('#dcPurchaseOrderId').val(response.purchaseOrderId);
	            $('#dcQuotationId').val(response.quotationId);
	            $('#deliveryNoteNo').val(response.deliveryNoteNo);
	            $('#buyer').text(response.buyer); // Assuming the address is in response
	            $('#dated').val(response.dated);
	            $('#referenceNoDate').val(response.referenceNoDate);
	            $('#otherReferences').val(response.otherReferences);
	            $('#termsOfDelivery').val(response.termsOfDelivery);
	            $('#buyersOrderNo').val(response.buyersOrderNo);
	            $('#paymentTerms').val(response.paymentTerms);
	            $('#buyersOrderDate').val(response.buyersOrderDate);
				$('#remarks').val(response.remarks);
				$('#companyPan').val(response.companyPan);

				       // Set the delivery address
				       $('#deliveryAddressdcc').text(response.deliveryAddress || ''); // Handle null gracefully
				       
				//$('#companyPan').val(response.companyPan);

	            // Populate the Goods table
	            const goodsTableBody = $('#goodsTableBody');
	            goodsTableBody.empty();  // Clear existing rows
				// Ensure response.goods is available
				            console.log("poll "+response.goodsDetails); 
							let grandTotal = 0;
							let totalTaxAmount = 0;
	            response.goodsDetails.forEach((good, index) => {
					const taxAmount = (good.cgstAmount || 0) + (good.sgstAmount || 0) + (good.igstAmount || 0);
					   const totalWithTax = (good.amount || 0) + taxAmount;

					   let taxLabel = "";
					   if ((good.cgstAmount || 0) > 0 || (good.sgstAmount || 0) > 0) {
					       taxLabel = "CGST + SGST";
					   } else if ((good.igstAmount || 0) > 0) {
					       taxLabel = "IGST";
					   } else {
					       taxLabel = "No Tax";
					   }
	                goodsTableBody.append(`
	                    <tr>
	                        <td>${index + 1}</td>
	                        <td><input type="text" class="form-control" value="${good.description}" readonly></td>
	                        <td><input type="text" class="form-control" value="${good.hsnSac}" readonly></td>
	                        <td><input type="number" class="form-control" value="${good.quantity}" readonly></td>
	                        <td><input type="number" class="form-control" value="${good.rate}" readonly></td>
	                        <td><input type="text" class="form-control" value="${good.perUnit}" readonly></td>
	                        <td><input type="number" class="form-control" value="${good.amount}" readonly></td>
	                    </tr>
	                `);
					
					// Tax row
					  const taxRow = `
					      <tr>
					          <td></td>
					          <td colspan="5" class="text-start fw-bold">${taxLabel} :</td>
					          <td><input type="number" class="form-control" value="${taxAmount.toFixed(2)}" readonly></td>
					      </tr>
					  `;
					  goodsTableBody.append(taxRow);

					  // Total row
					  const totalRow = `
					      <tr>
					          <td></td>
					          <td colspan="5" class="text-start fw-bold">Total :</td>
					          <td><input type="number" class="form-control" value="${totalWithTax.toFixed(2)}" readonly></td>
					      </tr>
					  `;
					  goodsTableBody.append(totalRow);

					  // Accumulate for grand total
					  grandTotal += totalWithTax;
	            });
				taxSummaryDiv.innerHTML = `
				    <div><strong>Total with Tax:</strong> ₹ ${grandTotal.toFixed(2)}</div>
				    <div><strong>Amount Chargeable (in words):</strong> INR ${numberToWordsIndianWithPaise(grandTotal)}</div>
				`;
				// Set the rounded total
				// Display the rounded grand total from the response
				   const roundedGrandTotal = response.roundedGrandTotal;
				   document.getElementById('roundedTotalDiv').innerHTML = `
				       <div><strong>Rounded Total:</strong> ₹ ${roundedGrandTotal.toFixed(2)}</div>
				       <div><strong>Amount Chargeable (Rounded, in words):</strong> INR ${numberToWordsIndianWithPaise(roundedGrandTotal)}</div>
				   `;
				// Populate the Tax Summary for each good in the tax breakdown table
				       const taxBreakdownBody = $('#taxBreakdownBody');
				       const taxTableHeader = $('#taxTableHeader');
				       taxBreakdownBody.empty();  // Clear existing tax breakdown

				       let showCGST = false, showSGST = false, showIGST = false;

				       // Loop through goodsDetails and check if CGST, SGST, or IGST have non-zero values
				       response.goodsDetails.forEach(good => {
						totalTaxAmount += parseFloat(good.totalTaxAmount || 0); 
				           // Check for non-zero tax values and determine visibility for each header
				           if (good.cgstRate && good.cgstRate != 0) showCGST = true;
				           if (good.sgstRate && good.sgstRate != 0) showSGST = true;
				           if (good.igstRate && good.igstRate != 0) showIGST = true;

				           taxBreakdownBody.append(`
				               <tr>
				                   <td>${good.hsnSac}</td>
				                   <td>${good.amount}</td>
				                   ${showCGST ? `<td class="cgst-header">${good.cgstRate || 0}%</td><td class="cgst-header">${good.cgstAmount || 0}</td>` : ''}
				                   ${showSGST ? `<td class="sgst-header">${good.sgstRate || 0}%</td><td class="sgst-header">${good.sgstAmount || 0}</td>` : ''}
				                   ${showIGST ? `<td class="igst-header">${good.igstRate || 0}%</td><td class="igst-header">${good.igstAmount || 0}</td>` : ''}
				                   <td>${good.totalTaxAmount}</td>
				               </tr>
				           `);
				       });

				       // Conditionally hide the columns in the header if the respective tax type is not present
				       if (!showCGST) {
				           taxTableHeader.find('.cgst-header').hide();  // Hide CGST columns
				       }
				       if (!showSGST) {
				           taxTableHeader.find('.sgst-header').hide();  // Hide SGST columns
				       }
				       if (!showIGST) {
				           taxTableHeader.find('.igst-header').hide();  // Hide IGST columns
				       }
					   const taxAmountWords = numberToWordsIndianWithPaise(totalTaxAmount);
					   									 								//   alert(taxAmountWords);
					   									 								   document.getElementById('taxAmountInWordsDiv').innerHTML = `Tax Amount (in words): INR ${taxAmountWords}`;

	            // Populate Amount in Words (if available in the response)
	            $('#amountInWordsDiv').text(response.amountInWords);
	          //  $('#taxAmountInWordsDiv').text(response.taxAmountInWords);
	        },
	        error: function(xhr, status, error) {
	            console.error('Error fetching delivery challan details:', error);
	            alert('An error occurred while fetching the details.');
	        }
	    });
	}

	
	function numberToWordsIndianWithPaise(amount) {
			    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven',
			        'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen',
			        'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
			    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

			    function getWords(num) {
			        if ((num = num.toString()).length > 9) return 'Overflow';
			        let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
			        if (!n) return '';

			        let str = '';
			        str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + ' Crore ' : '';
			        str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + ' Lakh ' : '';
			        str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + ' Thousand ' : '';
			        str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + ' Hundred ' : '';
			        str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + ' ' : '';
			        return str.trim();
			    }

			    let rupees = Math.floor(amount);
			    let paise = Math.round((amount - rupees) * 100);

			    let rupeeWords = getWords(rupees);
			    let paiseWords = paise > 0 ? getWords(paise) : '';

			    let final = '';
			    if (rupeeWords) final += rupeeWords + ' Rupees';
			    if (rupeeWords && paiseWords) final += ' and ';
			    if (paiseWords) final += paiseWords + ' Paise';

			    return final.trim() + ' Only';
			}

			
			/*document.getElementById('viewPdfBtn').addEventListener('click', function () {
			    const dcId = getCurrentDeliveryChallanId(); // You must implement this
			    window.open(`/delivery-challan/api/delivery-challan/view-pdf?dcId=${dcId}`, '_blank');
			});*/
			
			// Event listener for the View PDF button
			document.getElementById('viewPdfBtn').addEventListener('click', function () {
			    const dcId = getCurrentDeliveryChallanId();  // Assume this function returns the current DC ID
			    fetchDeliveryChallanData(dcId).then(dcData => {
			        console.log("Fetched Delivery Challan Data:", dcData);
			        viewPDF(dcData); // Pass the data to viewPDF function
			    }).catch(error => console.error("Error fetching DC data:", error));
			});

					
					// Fetch Delivery Challan Data by ID
					function fetchDeliveryChallanData(dcId) {
					    return fetch(`/delivery-challan/getDeliveryChallannew/${dcId}`)
					        .then(response => {
					            console.log("Response Statusaaa:", response.status);
					            return response.json();
					        })
					        .then(data => {
					            console.log("Fetched Data:", data);
					            return data;
					        })
					        .catch(error => console.error("Error fetching Delivery Challan data:", error));
					}

						  
			document.getElementById('downloadPdfBtn').addEventListener('click', function () {
			    const dcId = getCurrentDeliveryChallanId();
			    const downloadUrl = `/delivery-challan/api/delivery-challan/download-pdf?dcId=${dcId}`;
			    
			    // Create a temporary link element to trigger the download
			    const a = document.createElement('a');
			    a.href = downloadUrl;
			    a.download = `Delivery_Challan_${dcId}.pdf`; // Set a default file name
			    document.body.appendChild(a);
			    a.click();
			    document.body.removeChild(a);
			});
			
			function getCurrentDeliveryChallanId() {
			    return currentDcId;
			}
			
			
			
			// Function to generate the PDF
			       function viewPDF(dcData) {
					const { jsPDF } = window.jspdf;
					const doc = new jsPDF({
					    orientation: 'portrait',
					    unit: 'mm',
					    format: 'a4'
					});

					const pageWidth = doc.internal.pageSize.getWidth();
					const pageHeight = doc.internal.pageSize.getHeight();
					const pdfMainBorderPadding = 10;

					// Add full-page border
					doc.setLineWidth(0.3);
					doc.rect(pdfMainBorderPadding, pdfMainBorderPadding, pageWidth - 20, pageHeight - 20);

					// Header
					let yAxis = pdfMainBorderPadding + 5;  // Corrected variable name
					doc.setFont("helvetica", "bold");
					doc.setFontSize(11);
					doc.text("Melange Systems Private Limited.", pdfMainBorderPadding + 2, yAxis);
					doc.setFontSize(9);
					yAxis += 5;
					doc.setFont("helvetica","normal");
					doc.text("No. 4/1, 7th Cross, Kumara Park West, Bangalore 560020", pdfMainBorderPadding + 2 , yAxis);
					yAxis += 5;
					doc.text("Tel: 080-2356 1023, Telefax: 080-2346 2175", pdfMainBorderPadding + 2 , yAxis);
					yAxis += 5;
					doc.setFont("helvetica", "bold");
					doc.text("GSTIN: 29AACCM4737H1ZA, CIN: U72200KA2000PTC027922", pdfMainBorderPadding + 2 , yAxis);
					yAxis += 5;
					doc.text("Udyam Registration Number: UDYAM-KR-03-0101576", pdfMainBorderPadding + 2 , yAxis);
					// Company Logo (Right Side)
					const logo = new Image();
					logo.src = "/assets/img/compressed_logo.png";
					      logo.onload = function () {
					          // Once the logo is loaded, add it to the document
					          doc.addImage(logo, 'PNG', pageWidth - 64, pdfMainBorderPadding + 5, 50, 18); // x, y, width, height
							  // Draw horizontal line below the header
							        yAxis += 2;
							        doc.setLineWidth(0.1);
							        doc.line(pdfMainBorderPadding, yAxis, pageWidth - pdfMainBorderPadding, yAxis);
							        yAxis += 6;

									// Add Delivery Challan Title
									   doc.setFontSize(14);
									   doc.setFont("helvetica", "bold");
									   doc.text("DELIVERY CHALLAN", pageWidth / 2, yAxis, { align: 'center' });

									 
									   // ✅ Draw horizontal line immediately after the title
									   yAxis += 3; // Increase space before drawing the line to push it lower
									   doc.setLineWidth(0.1);
									   doc.line(pdfMainBorderPadding, yAxis, pageWidth - pdfMainBorderPadding, yAxis);
									   yAxis += 5; // Add some space for the next section
									   // Set line spacing and font size
									   // Set line spacing and font size
									   // Set line spacing and font size
									   // Set line spacing and font size
									   const lineSpace = 4;
									   doc.setFontSize(9);

									   // Left section (Buyer and Delivery Address)
									   let leftX = pdfMainBorderPadding + 2;
									   let leftY = yAxis;
									   const sectionWidth = 90;

									   // Render "Buyer (Bill to)"
									   doc.setFont('helvetica', 'bold');
									   doc.text('Buyer (Bill to):', leftX, leftY);
									   leftY += lineSpace;
									   doc.setFont('helvetica', 'normal');

									   // Split buyer details based on GSTIN if present
									   let buyerDetails = dcData.buyer || "Default Buyer Address";
									   let gstIndex = buyerDetails.indexOf("GSTIN");
									   if (gstIndex !== -1) {
									       const addressPart = buyerDetails.substring(0, gstIndex).trim();
									       const gstinPart = buyerDetails.substring(gstIndex).trim();

									       // Wrap and render address
									       const addressLines = doc.splitTextToSize(addressPart, sectionWidth);
									       addressLines.forEach(line => {
									           doc.text(line, leftX, leftY);
									           leftY += lineSpace;
									       });

									       // Add GSTIN on a new line
									       doc.text(gstinPart, leftX, leftY);
									       leftY += lineSpace;
									   } else {
									       // Wrap and render entire buyer address if no GSTIN
									       const buyerLines = doc.splitTextToSize(buyerDetails, sectionWidth);
									       buyerLines.forEach(line => {
									           doc.text(line, leftX, leftY);
									           leftY += lineSpace;
									       });
									   }

									   // Add spacing before "Delivery Address"
									   leftY += 2;

									   // Render "Delivery Address"
									   doc.setFont('helvetica', 'bold');
									   doc.text('Delivery Address:', leftX, leftY);
									   leftY += lineSpace;
									   doc.setFont('helvetica', 'normal');

									   const deliveryAddress = dcData.deliveryAddress || "PLOT NO.4, SECTOR-3, IMT";
									   const deliveryAddressLines = doc.splitTextToSize(deliveryAddress, sectionWidth);
									   deliveryAddressLines.forEach(line => {
									       doc.text(line, leftX, leftY);
									       leftY += lineSpace;
									   });

									   // Calculate max height for vertical divider (Left Section Bottom Y)
									   const leftSectionBottomY = leftY;

									   // Right section (Delivery Details)
									   const dividerX = leftX + sectionWidth + 5;
									   let rightX = dividerX + 5;
									   let rightY = yAxis;
									   const rightSectionWidth = 95;
									   const labelWidth = 50; // Width for labels (e.g., "Delivery Note No:")

									 //  const rightSectionWidth = 95;

									   // Render "Delivery Details"
									   doc.setFont('helvetica', 'bold');
									   doc.text('Delivery Details:', rightX, rightY);
									   rightY += lineSpace;
									   doc.setFont('helvetica', 'normal');

									   // Prepare and render delivery details
									   const deliveryDetails = [
									       `Delivery Note No: ${dcData.deliveryNoteNo || ''}`,
									       `Dated: ${dcData.dated || ''}`,
									       `Other References: ${dcData.otherReferences || ''}`,
									       `Buyer's Order No: ${dcData.buyersOrderNo || ''}`,
									       `Buyer's Order Date: ${dcData.buyersOrderDate || ''}`
									   ];

									   deliveryDetails.forEach(detail => {
									       const [label, value] = detail.split(':'); // Split the label and value

									       // Add label
									       doc.text(label + ':', rightX, rightY);

									       // Add value with some offset to align with the label
									       const valueX = rightX + labelWidth + 0; // Adjust this value for alignment
									       const lines = doc.splitTextToSize(value.trim(), rightSectionWidth - labelWidth); // Adjusted width for value
									       lines.forEach(line => {
									           doc.text(line, valueX, rightY);
									           rightY += lineSpace;
									       });
									   });

									   // Add "Remarks" section
									   if (dcData.remarks) {
									       // Format remarks in the same inline style as other fields
									       const remarksText = `Remarks: ${dcData.remarks || ''}`;
									       const remarksLines = doc.splitTextToSize(remarksText, rightSectionWidth);

									       remarksLines.forEach(line => {
									           doc.text(line, rightX, rightY);
									           rightY += lineSpace;
									       });
									   }

									   // Calculate final bottom Y for both sections (reduced gap)
									   const finalSectionBottomY = Math.max(leftSectionBottomY, rightY) + 1;

									   // Draw vertical divider (adjusted to reach the horizontal line)
									   doc.setDrawColor(0);
									   doc.line(dividerX, yAxis - 5, dividerX, finalSectionBottomY);

									   // Draw horizontal line below the entire section (reduced gap)
									   doc.line(10, finalSectionBottomY, 200, finalSectionBottomY);

									   // Update yAxis for the next section
									   yAxis = finalSectionBottomY + 2;


						// Add padding for the line below the section
						//const linePadding = 6; // You can adjust this padding as needed

						// Draw the horizontal line below the entire section, dynamically positioned
						//doc.line(10, maxColumnHeight + 6, 200, maxColumnHeight + 6);
						 // Adjust horizontal line position if content grows or shrinks
						  // Improved Table Drawing with Vertical Lines for Headers and Rows

						  // Table Drawing
						  const pageHeight = doc.internal.pageSize.getHeight();
						  const leftMargin = 10;
						  const rightMargin = 10;
						  const bottomMargin = 20;
						  const rowHeight = 5;
						  const minTableHeight = 50;

						  // Calculate the usable width for the table
						  const tableWidth = pageWidth - leftMargin - rightMargin;
						 // const columnWidths = [15, 72, 28, 25, 25, 30, 30];  // Removed the 7th column width (Total Tax Amount)
						 const columnWidths = [15, 72, 28, 25, 25, 30];

						  const totalColumnWidth = columnWidths.reduce((sum, width) => sum + width, 0);

						  // Adjust column widths if needed
						  if (totalColumnWidth > tableWidth) {
						      const scaleFactor = tableWidth / totalColumnWidth;
						      columnWidths.forEach((width, index) => {
						          columnWidths[index] = Math.floor(width * scaleFactor);
						      });
						  }

						  // Ensure maxColumnHeight is defined before usage
						  let maxColumnHeight = Math.max(leftY, rightY);
						  const headers = ['Sl No.', 'Description of Goods', 'HSN / SAC', 'Quantity', 'Rate', 'Taxable Value'];


						  const tableX = leftMargin;
						  let tableY = maxColumnHeight + 10;

						  doc.setFont('helvetica', 'bold');

						  let xPos = tableX;
						  headers.forEach((header, index) => {
						      const headerLines = doc.splitTextToSize(header, columnWidths[index] - 2);
						      headerLines.forEach((line, lineIndex) => {
						          const textWidth = doc.getTextWidth(line);
						          const xPosition = xPos + (columnWidths[index] - textWidth) / 2; // Calculate center position for text
						          doc.text(line, xPosition, tableY + lineIndex * rowHeight);
						      });

						      // Draw vertical line for each column
						      doc.line(xPos, tableY - rowHeight - 4, xPos, finalSectionBottomY + 25);
						      xPos += columnWidths[index];
						  });

						  tableY += rowHeight * 0.5;
						  //doc.line(tableX, tableY, tableX + tableWidth, tableY);  // Bottom border for header
						  doc.line(leftMargin, tableY, pageWidth - rightMargin, tableY);  // header bottom line

						  doc.setFont('helvetica', 'normal');
						  tableY += 5;

						  const items = Array.isArray(dcData.goodsDetails) ? dcData.goodsDetails : (dcData.goodsDetails ? [dcData.goodsDetails] : []);

						  // Ensure minimum number of rows (e.g., 3) to fill the table if less than 3 items
						  const totalRows = Math.max(12, items.length);
						  // Ensure maxColumnEndY reflects the final position after the last row
						  let maxColumnEndY = tableY;
						  
						  // Set thinner line width for table borders
						  doc.setLineWidth(0); // Adjust this value as needed (e.g., 0.1 or 0.2 for thin lines)

						  // Centering function for number values
						  function centerTextInColumn(doc, text, startX, columnWidth, yPosition) {
						      const textWidth = doc.getTextWidth(text);
						      const xPosition = startX + (columnWidth - textWidth) / 2;
						      doc.text(text, xPosition, yPosition);
						  }

						  for (let i = 0; i < totalRows; i++) {
						      const item = items[i] || {};
						      const rowY = tableY;
						      const descLines = doc.splitTextToSize(item.description || '', columnWidths[1] - 2);
						      const rowHeightRequired = Math.max(rowHeight, descLines.length * rowHeight);
						      maxColumnEndY = tableY + rowHeightRequired;
						      xPos = tableX;
						      
						      // Draw vertical lines for rows
						      columnWidths.forEach(width => {
						          doc.line(xPos, tableY - rowHeight, xPos, maxColumnEndY);
						          xPos += width;
						      });

						      // Add row content (only show serial number if item exists)
						      if (item.description) {
						          doc.text(String(i + 1), tableX + 2, rowY);
						      }
						      descLines.forEach((line, lineIndex) => {
						          doc.text(line, tableX + columnWidths[0] + 2, rowY + lineIndex * rowHeight);
						      });

							  // Centering the number values without the "Total" column
							  centerTextInColumn(doc, String(item.hsnSac || ''), tableX + columnWidths[0] + columnWidths[1], columnWidths[2], rowY);
							  centerTextInColumn(doc, String(item.quantity || ''), tableX + columnWidths[0] + columnWidths[1] + columnWidths[2], columnWidths[3], rowY);
							  centerTextInColumn(doc, String(item.rate || ''), tableX + columnWidths[0] + columnWidths[1] + columnWidths[2] + columnWidths[3], columnWidths[4], rowY);
							  centerTextInColumn(doc, String(item.amount || ''), tableX + columnWidths[0] + columnWidths[1] + columnWidths[2] + columnWidths[3] + columnWidths[4], columnWidths[5], rowY);

							  // Add horizontal line after the row, but not after the last item
							  // Add horizontal line after each item row
							 //Terms and Conditions: doc.line(tableX, maxColumnEndY, tableX + tableWidth, maxColumnEndY);
						      tableY += rowHeightRequired;
						  }
						// Now, draw the final horizontal line based on the maxColumnEndY
						
						doc.line(tableX, maxColumnEndY, tableX + tableWidth, maxColumnEndY); 
						   // Define tax items separately
						   
						   
						   const taxItems = Array.isArray(dcData.goodsDetails) ? dcData.goodsDetails : (dcData.goodsDetails ? [dcData.goodsDetails] : []);


						   // Initialize sums for IGST, CGST, SGST, etc.
						   let totalIgstAmount = 0;
						   let totalCgstAmount = 0;
						   let totalSgstAmount = 0;
						   let totalAmountBeforeTax = 0;
						   let totalTaxAmount = 0;
						   let totalWithTax = 0;
						 // let  roundedGrandTotal=0;
						 // Assuming dcData is an object with roundedGrandTotal property
						 let roundedGrandTotal = dcData.roundedGrandTotal;
						 let roundedGrandTotal1 = dcData.roundedGrandTotal;
//alert("roundedGrandTotal"+ roundedGrandTotal)
						 
						   taxItems.forEach((taxItem) => {
						       if (taxItem.igstAmount && taxItem.igstAmount > 0) totalIgstAmount += taxItem.igstAmount;
						       if (taxItem.cgstAmount && taxItem.cgstAmount > 0) totalCgstAmount += taxItem.cgstAmount;
						       if (taxItem.sgstAmount && taxItem.sgstAmount > 0) totalSgstAmount += taxItem.sgstAmount;
						       if (taxItem.amount && taxItem.amount > 0) totalAmountBeforeTax += taxItem.amount;
						       if (taxItem.totalTaxAmount && taxItem.totalTaxAmount > 0) totalTaxAmount += taxItem.totalTaxAmount;
						       if (taxItem.totalWithTax && taxItem.totalWithTax > 0) totalWithTax += taxItem.totalWithTax;
						   });

						   const sectionOffset = 6;
						   const leftAlignX = tableX;
						   const rightAlignX = tableX + tableWidth - 17;
						   const middleX = tableX + (tableWidth / 2);
						   const sectionStartY = tableY + sectionOffset;
						//   let currentY = sectionStartY;
						let currentY = tableY + 0; 
											 
						   let maxSectionHeight = 0;

						   doc.setFont('helvetica', 'bold');
						   currentY += rowHeight;
						   doc.setFont('helvetica', 'normal');
						   // Set the initial Y position to the exact top of the division
						   // 1. Total Amount Before Tax
						   if (totalAmountBeforeTax > 0) {
						       doc.text('Amount (Before Tax):', rightAlignX - 40, currentY, { align: 'right' });
						       doc.text(`${totalAmountBeforeTax}`, rightAlignX, currentY, { align: 'right' });
						       currentY += rowHeight;
						       
						       const lineStartX = tableX + (tableWidth / 2);
						       const lineEndX = tableX + tableWidth;
						       const lineY = currentY - 4;
						       
						       doc.setLineWidth(0);
						       doc.setDrawColor(0);
						       doc.line(lineStartX, lineY, lineEndX, lineY);
						   }

						   // 2. Individual Tax Rows (IGST, CGST, SGST)
						   if (totalIgstAmount > 0) {
						       doc.text(`IGST (${taxItems[0].igstRate}%):`, rightAlignX - 40, currentY, { align: 'right' });
						       doc.text(`${totalIgstAmount}`, rightAlignX, currentY, { align: 'right' });
						       currentY += rowHeight;
							   
							   const lineStartX = tableX + (tableWidth / 2);
							   					   					       const lineEndX = tableX + tableWidth;
							   					   					       const lineY = currentY - 4;
							   					   					       
							   					   					       doc.setLineWidth(0);
							   					   					       doc.setDrawColor(0);
							   					   					       doc.line(lineStartX, lineY, lineEndX, lineY);
						   }

						   if (totalCgstAmount > 0) {
						       doc.text(`CGST (${taxItems[0].cgstRate}%):`, rightAlignX - 40, currentY, { align: 'right' });
						       doc.text(`${totalCgstAmount}`, rightAlignX, currentY, { align: 'right' });
						       currentY += rowHeight;
							   
							   const lineStartX = tableX + (tableWidth / 2);
							   					   					       const lineEndX = tableX + tableWidth;
							   					   					       const lineY = currentY - 4;
							   					   					       
							   					   					       doc.setLineWidth(0);
							   					   					       doc.setDrawColor(0);
							   					   					       doc.line(lineStartX, lineY, lineEndX, lineY);
						   }

						   if (totalSgstAmount > 0) {
						       doc.text(`SGST (${taxItems[0].sgstRate}%):`, rightAlignX - 40, currentY, { align: 'right' });
						       doc.text(`${totalSgstAmount}`, rightAlignX, currentY, { align: 'right' });
						       currentY += rowHeight;
							   
							   const lineStartX = tableX + (tableWidth / 2);
							   					   					       const lineEndX = tableX + tableWidth;
							   					   					       const lineY = currentY - 4;
							   					   					       
							   					   					       doc.setLineWidth(0);
							   					   					       doc.setDrawColor(0);
							   					   					       doc.line(lineStartX, lineY, lineEndX, lineY);
						   }

						   // 3. Total Tax Amount
						   if (totalTaxAmount > 0) {
						       doc.text('Total Tax Amount:', rightAlignX - 40, currentY, { align: 'right' });
						       doc.text(`${totalTaxAmount}`, rightAlignX, currentY, { align: 'right' });
						       currentY += rowHeight;
						       
						       const lineStartX = tableX + (tableWidth / 2);
						       const lineEndX = tableX + tableWidth;
						       const lineY = currentY - 4;
						       
						       doc.setLineWidth(0);
						       doc.setDrawColor(0);
						       doc.line(lineStartX, lineY, lineEndX, lineY);
						   }
						   
						   // 4. Total Amount after GST
						   if (totalWithTax > 0) {
						       doc.text('Total Amount after GST:', rightAlignX - 40, currentY, { align: 'right' });
						       doc.text(`${totalWithTax}`, rightAlignX, currentY, { align: 'right' });
						       currentY += rowHeight;
						       
						       const lineStartX = tableX + (tableWidth / 2);
						       const lineEndX = tableX + tableWidth;
						       const lineY = currentY - 4;
						       
						       doc.setLineWidth(0);
						       doc.setDrawColor(0);
						       doc.line(lineStartX, lineY, lineEndX, lineY);
						   }

						   // Render "Difference in Grand Total"
						   if (roundedGrandTotal > 0) {
						       const difference = (roundedGrandTotal - totalWithTax).toFixed(2);
						       if (difference !== "0.00") {
						           currentY += rowHeight - 5;
						           doc.setFont('helvetica', 'normal');
						           doc.text(`Difference in Grand Total:`, rightAlignX - 40, currentY, { align: 'right' });
						           doc.text(difference > 0 ? `+${difference}` : difference, rightAlignX, currentY, { align: 'right' });

						           // Draw horizontal line after Grand Total Difference
						           const lineStartX = tableX + (tableWidth / 2);
						           const lineEndX = tableX + tableWidth;
						           const lineY = currentY + 1.5; // Adjust line position based on where you want it
						           doc.setLineWidth(0);
						           doc.setDrawColor(0);
						           doc.line(lineStartX, lineY, lineEndX, lineY);
						       }
						   }

						  
						 
						   // Render "Net Amount"
						   if (roundedGrandTotal1 > 0) {
						       currentY += rowHeight;
						       doc.text('Net Amount:', rightAlignX - 40, currentY, { align: 'right' });
						       doc.text(`${roundedGrandTotal1}`, rightAlignX, currentY, { align: 'right' });
						       currentY += rowHeight;

						       // Add a line after Net Amount
						       //doc.line(lineStartX, currentY - 4, lineEndX, currentY - 4);
						   }



						  
						   // Adjust left alignment to create padding to the right side
						 /*  const rightPadding = 1.5; // You can adjust this padding value as per your needs
						   const adjustedLeftAlignX = leftAlignX + rightPadding;
						   // Left section (Terms and Conditions)
						   currentY = sectionStartY;
						   doc.setFont('helvetica', 'bold');
						 //  doc.text('Terms and Conditions:', adjustedLeftAlignX, currentY);
						   currentY += rowHeight;
						   doc.setFont('helvetica', 'normal');*/

						/*  const termsText = dcData.termsOfDelivery || 'Not specified';
						   const wrappedTerms = doc.splitTextToSize(termsText, middleX - adjustedLeftAlignX - 10);
						   wrappedTerms.forEach(line => {
						       doc.text(line, adjustedLeftAlignX, currentY);
						       currentY += rowHeight;
						   });*/

						   // Add padding after Terms and Conditions
						//   currentY += rowHeight;

						//   doc.setFont('helvetica', 'bold');
						  /// doc.text('Payment Terms:', adjustedLeftAlignX, currentY);
						//   currentY += rowHeight;
						//   doc.setFont('helvetica', 'normal');

						/*   const paymentText = dcData.paymentTerms || 'Not specified';
						   const wrappedPayment = doc.splitTextToSize(paymentText, middleX - adjustedLeftAlignX - 10);
						   wrappedPayment.forEach(line => {
						       doc.text(line, adjustedLeftAlignX, currentY);
						       currentY += rowHeight;
						   });*/


						   // Calculate the final section bottom Y based on the max section height
						   maxSectionHeight = currentY ;
						   const finalSectionBottomY1 =  maxSectionHeight;

						   // Calculate the final bottom Y position based on the max height
						 //  const finalSectionBottomY1 = sectionStartY + maxSectionHeight;

						 const finalSectionBottomY2 = currentY ;

						 // Extend the first line to the finalSectionBottomY2
						 doc.setDrawColor(0);
						 doc.setLineWidth(0);
						 doc.line(middleX, sectionStartY - 6, middleX, finalSectionBottomY2); // extend to finalSectionBottomY2

						 // Draw the second line at tableX
						 doc.line(tableX, finalSectionBottomY2, tableX + tableWidth, finalSectionBottomY2);
						 // Draw the vertical line connecting the horizontal lines
						
						
						   // Update 'tableY' for the next section
						   tableY = finalSectionBottomY1;
						   
						   // Step 1: Calculate the Y position for the dividing line
						 //  const divideLineY = finalSectionBottomY2 + 3; // Adjust as necessary

						// words function
						   function numberToWords(number) {
						       const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
						       const teens = ["Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
						       const tens = ["", "Ten", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
						       const thousands = ["", "Thousand", "Lakh", "Crore"];

						       function convertToWords(num) {
						           if (num === 0) return "";
						           if (num < 10) return ones[num];
						           if (num < 20) return teens[num - 11];
						           if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? " " + ones[num % 10] : "");
						           if (num < 1000) return ones[Math.floor(num / 100)] + " Hundred" + (num % 100 !== 0 ? " " + convertToWords(num % 100) : "");
						           for (let i = 0, div = 1000; i < thousands.length; i++, div *= 100) {
						               if (num < div * 100) {
						                   return convertToWords(Math.floor(num / div)) + " " + thousands[i] + (num % div !== 0 ? " " + convertToWords(num % div) : "");
						               }
						           }
						       }

						       // Split into rupees and paise
						       const [rupees, paise] = number.toFixed(2).split(".");

						       let words = convertToWords(parseInt(rupees)) + " Rupees";
						       if (parseInt(paise) > 0) {
						           words += " and " + convertToWords(parseInt(paise)) + " Paisa";
						       }
						       return words + " Only";
						   }
						   // Step 1: Draw the horizontal dividing line
						   doc.setDrawColor(0);
						   doc.setLineWidth(0);
						  //  doc.line(tableX, divideLineY, tableX + tableWidth, divideLineY); // Horizontal dividing line

						
						   // Draw the vertical line
						   doc.setDrawColor(0);
						   doc.setLineWidth(0);
						  // doc.line(verticalLineX, verticalLineYStart, verticalLineX, verticalLineYEnd);

						//   doc.line(tableX, tableY, tableX + 190, tableY); // Draw the horizontal line

						   // Step 2: Calculate the total amount
						 //  const totalAmount = items.reduce((sum, item) => sum + (item.totalWithTax || 0), 0);
						   // Step 2: Use roundedGrandTotal from dcData
						   const totalAmount = dcData.roundedGrandTotal || 0;

						   // Step 3: Convert the total amount to words
						   const totalInWords = numberToWords(totalAmount);

						   // Step 4: Adjust tableY to position the "TOTAL IN WORDS" below the horizontal line
						   //tableY += 4;  // Add a little space below the horizontal line before placing the text

						   // Step 5: Set font and position for the total in words
						   // Step 5: Set font and position for the total in words
						   doc.setFontSize(10);
						   doc.setFont('helvetica', 'bold');

						   // Calculate the center position for the text
						   const textWidth = doc.getTextWidth(`TOTAL IN WORDS: ${totalInWords}`);
						   const centerX = (doc.internal.pageSize.width - textWidth) / 2;

						   // Position the text slightly below the final horizontal line
						 const textY = finalSectionBottomY2 + 6; // Adjust the offset as needed
						// Position the text slightly below the final horizontal line
						//const totalTextY = nextSectionY + 10; // Add a little extra space if needed

						   // Add the centered text
						  doc.text(`TOTAL IN WORDS: ${totalInWords}`, centerX, textY);
						  // Now draw the horizontal line immediately below the text
						  const lineY = textY + 4; // Add a little padding below the text
						  doc.setDrawColor(0);
						  doc.setLineWidth(0);
						  doc.line(tableX, lineY, tableX + tableWidth, lineY);
						  // Step 3: Calculate the Y position for the dividing line
						  const divideLineY = lineY + 3; // Position the dividing line immediately after the horizontal line

						  // Step 4: Add padding for the divided section
						  const dividerPadding = 5;
						  const sectionStartY1 = divideLineY + dividerPadding;

						  // Calculate the half table width for balanced columns
						  const halfTableWidth = tableWidth / 2;
						  const dividerOffset = 15; // Adjust this value to move the divider line slightly to the right
						  const leftColumnX = tableX;
						  const rightColumnX = tableX + halfTableWidth + dividerOffset; // Right column with offset

						  // Fetch Payment Terms and Terms and Conditions from dcData
						  const paymentTerms = dcData.paymentTerms || "1. 50% advance payment\n2. Balance on delivery\n3. Payment within 30 days";
						  const termsConditions = dcData.termsOfDelivery || "1. Goods once sold are not returnable\n2. Prices are subject to change without notice\n3. Warranty as per manufacturer policy";

						  // Step 5: Add Payment Terms heading and content on the left
						  doc.setFontSize(9);
						  doc.setFont('helvetica', 'bold');
						  doc.text("Payment Terms", leftColumnX+1.5, sectionStartY1); // Heading
						  doc.setFontSize(8);
						  doc.setFont('helvetica', 'normal');
						  doc.text(paymentTerms, leftColumnX+1.5, sectionStartY1 + 6, { maxWidth: halfTableWidth-3 }); // Content

						  // Step 6: Add Terms and Conditions heading and content on the right
						  doc.setFontSize(9);
						  doc.setFont('helvetica', 'bold');
						  doc.text("Terms and Conditions", rightColumnX-13, sectionStartY1); // Heading
						  doc.setFontSize(8);
						  doc.setFont('helvetica', 'normal');
						  doc.text(termsConditions, rightColumnX-13, sectionStartY1 + 6, { maxWidth: halfTableWidth-3 }); // Content

						  // Step 7: Calculate the bottom Y position for the next section
						  const maxLines = Math.max(paymentTerms.split("\n").length, termsConditions.split("\n").length);
						  const lineHeight = 4;
						  const nextSectionY = sectionStartY1 + (maxLines * lineHeight) + 16; // Add some padding for the headings and content

						  // Step 8: Draw the bottom horizontal line
						  doc.line(tableX, nextSectionY, tableX + tableWidth, nextSectionY);

						  // Step 9: Add the vertical line between the two columns
						  const verticalLineX = tableX + halfTableWidth + (dividerOffset / 2) - 7.5; // Shift slightly right
						  const verticalLineYStart = lineY; // Start from the dividing line
						  const verticalLineYEnd = nextSectionY; // Extend to the bottom line

						  // Draw the vertical line
						  doc.setDrawColor(0);
						  doc.setLineWidth(0);
						  doc.line(verticalLineX, verticalLineYStart, verticalLineX, verticalLineYEnd);
						 // Add the centered text
						 //doc.text(`TOTAL IN WORDS: ${totalInWords}`, centerX, totalTextY);
						   // Step 6: Adjust tableY for future content
						                doc.setDrawColor(0);
						                            doc.setLineWidth(0);
						                            tableY += 14;
						                        //    doc.line(tableX, tableY, tableX + 190, tableY); // Horizontal line
												// Ensure this line is placed before using 'pageWidth'
												const pageWidth1 = doc.internal.pageSize.width;

												// Add the footer text
												const footerText = "* This is a computer-generated Delivery Challan, no seal and signature required.";
												const footerY = doc.internal.pageSize.height - 13;

												doc.setFont('helvetica', 'bold');
												doc.setFontSize(9);

												// Center the footer text
												doc.text(footerText, pageWidth1 / 2, footerY, { align: 'center' });

						         // Open the PDF in a new tab
						         window.open(doc.output('bloburl'));  // This will open the generated PDF in a new tab
						     };

			           logo.onerror = function() {
			               console.error("Logo image failed to load.");
			               alert("Error loading logo image. Please try again.");
			           };
			       }
	</script>
	
<!-- <div class="modal fade" id="quotationModal" tabindex="-1" aria-labelledby="quotationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl" style="max-width: 100vw;">
		<div class="modal-content">
          <div class="modal-header">
                <h5 class="modal-title" id="quotationModalLabel">View Quotation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"> -->
            
            
<div class="viewQuotationOuterDiv" id="viewQuotationOuterDiv">
	 <div class="viewQuotationInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">View Quotation</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeViewQuotationOuterDiv();">&times;</span></p>		               	  
			</div>
            
            
                <!-- Quotation Form -->
                <form id="quotationForm" style="padding: 20px;">
                  <input type="hidden" id="editRowIndex"> 
                
                <div class="row mb-3 justify-content-between">
						<div class="col-md-3">
							<input type="text" class="form-control" id="qid" placeholder="Quotation ID" disabled />
						</div>
						<div class="col-md-3">
							<input type="datetime-local" class="form-control text-center" id="qdateTime" disabled />
						</div>
					</div>
                
                
                    <div class="row">      
                    	<div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="company_honorifics" class="form-control" readonly>
                        </div>              
                        <div class="col-md-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="vendorName" class="form-control"  list="customerList" autocomplete="off" required>
                            <div id="suggestionsBox" class="suggestions"></div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Customer Legal Name</label>
                            <input type="text" id="vendorlegalNamee" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST Number</label>
                            <input type="text" id="gstnumberr" class="form-control" required>
                        </div>
                         <div class="col-md-2">
                            <label class="form-label">Order Method</label>
                             <input type="text" id="orderMethod" class="form-control" required>                           
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="contact_person_honorifics" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contact Person Name</label>
                             <input type="text" id="personName" class="form-control" required>  
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Designation</label>
                            <input type="text" id="designation" class="form-control" >
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mobile Number</label>
                            <input type="text" id="contactDetails" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Email ID</label>
                            <input type="email" id="emailId" class="form-control">
                        </div>
                         <div class="col-md-6">
                         
                            <label class="form-label">Billing Address</label>
                            <textarea id="shipmentAddress" class="form-control"></textarea>                     
   						</div>
                        <div class="col-md-6"> 
                            <label class="form-label">Delivery Address</label>
                            <textarea id="deliveryAddress" class="form-control"></textarea>
                        </div>
                   </div>    
                   
                   <hr>
                    <!-- GST Selection -->
                    <h5>Tax Type</h5>
                    
                     <hr>
                    <div class="d-flex align-items-center mb-3">
                        <input type="checkbox" id="interState" class="form-check-input me-1" onclick="toggleGST('interState')"> 
                        <label class="form-check-label me-3">Interstate</label>

                        <input type="checkbox" id="outerState" class="form-check-input me-1" onclick="toggleGST('outerState')"> 
                        <label class="form-check-label me-3">Outerstate</label>

                       <!--  <input type="number" id="gstPercentage" class="form-control ms-3" style="width: 100px;" placeholder="GST %" oninput="updateTableHeaders()">
                   -->  
                   </div>

                   <!-- Product Table -->
                    <hr>
                                 
                  
                  <div class="table-responsive">
					<table class="table table-bordered mt-3">
					    <thead class="table bg-secondary">
					        <tr>         
					            <th style="display: none;">Product Name</th>
					            <th>HSN Code</th>
					            <th>Part Number</th>
					            <th>Description</th>
					            <th>Quantity</th>
					            <th>Price</th>
					            <th>Taxable Value</th>
					            <th class="cgst-header d-none">CGST (9%)</th>
					            <th class="sgst-header d-none">SGST (9%)</th>
					            <th class="igst-header d-none">IGST (18%)</th>            
					            <th>Total Value</th>
					            
					        </tr>
					    </thead>
					    <tbody id="productTableBody">
					        <!-- Rows will be dynamically added here -->
					    </tbody>
					</table>
				</div>


		<table style="display: none;" class="table-bordered hiddenProductDetailsTableBoxData">
		    <tbody id="hiddenProductTableBody">
		        <!-- Rows will be dynamically added here -->
		    </tbody>
		</table>
		
			<div class="col-md-12 mt-2">
				<label>Terms And Condition</label>
				<textarea class="form-control" style="font-size: 14px;" readonly id="terms_and_condition" rows="3"></textarea>
			</div>

                </form>
                
                <div class="modal-footer table-responsive p-2">
	                <button type="button" class="btn btn-secondary mx-1" style="font-size: 14px;" onclick="closeViewQuotationOuterDiv();">Close</button>
	                <button type="button" class="btn btn-danger mx-1" style="font-size: 14px;" id="terminateQuotationBtn" onclick="forwardQuotationForReview($('#qid').val(), 4)">Terminate</button>
	                <button type="button" class="btn btn-success mx-1" style="font-size: 14px; display: none;" id="quotationReviewApproveBtn" onclick="updateQuotationStatusAfterReview($('#qid').val(), $('#emailId').val(), 2)">Approve</button>
	                <button type="button" class="btn btn-primary mx-1" style="font-size: 14px; display: none;" id="reviseQuotationBtn" onclick="openReviseQuotationOuterDiv();">Revise</button>
	                <button type="button" class="btn btn-primary mx-1" style="font-size: 14px;" id="quotationSubmitBtnForReview" onclick="forwardQuotationForReview($('#qid').val(), 1)">Submit</button>
	                <!-- <button type="button" class="btn btn-success mx-1" style="font-size: 14px;" id="wonQuotationBtn" onclick="forwardQuotationForReview($('#qid').val(), 3)">Won</button> -->
	                <!-- <button type="button" class="btn btn-danger mx-1" style="font-size: 14px;" onclick="downloadPDF()"> <i class="fas fa-file-pdf"></i>Download PDF</button> -->
	            </div>
                
            </div>
       
    </div>
<!-- </div>
</div> -->


<div class="revise_QuotationOuterDiv" id="revise_QuotationOuterDiv">
	 <div class="revise_QuotationInnerBox">
			<div class="d-flex justify-content-between align-items-center m-0" style="position: sticky; top: 0; background: #fff;">
				<p class="candidatePrfoilesHeading m-0" style="font-size: 14px; padding-left: 10px; font-weight: bold;">Revise Quotation</p>
				<p class="emailFormInnerBoxCloser m-0"><span onclick="closeReviseQuotationOuterDiv();">&times;</span></p>		               	  
			</div>
            
                <!-- Quotation Form -->
                <form id="revise_quotationForm" style="padding: 20px;">
                  <input type="hidden" id="revise_editRowIndex"> 
                
                <div class="row mb-3 justify-content-between">
						<div class="col-md-3">
							<input type="text" class="form-control" id="revise_qid" placeholder="Quotation ID" disabled />
						</div>
						<div class="col-md-3">
							<input type="datetime-local" class="form-control text-center" id="revise_qdateTime" disabled />
						</div>
					</div>
                
                    <div class="row"> 
                   		 <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="revise_company_honorifics" class="form-control" readonly>
                        </div>                   
                        <div class="col-md-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="revise_vendorName" class="form-control"  list="customerList" autocomplete="off" required>
                            <div id="revise_suggestionsBox" class="revise_suggestions"></div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Customer Legal Name</label>
                            <input type="text" id="revise_vendorlegalNamee" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST Number</label>
                            <input type="text" id="revise_gstnumberr" class="form-control" required>
                        </div>
                         <div class="col-md-2">
                            <label class="form-label">Order Method</label>
                             <!-- <input type="text" id="revise_orderMethod" class="form-control" required> --> 
                             <select id="revise_orderMethod" class="form-select">
                                <option value="Online">Online</option>
                                <option value="Phone">Phone</option>
                                <option value="In-Person">In-Person</option>
                            </select>                          
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Honorifics</label>
                            <input type="text" id="revise_contact_person_honorifics" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contact Person Name</label>
                             <!-- <input type="text" id="revise_personName" class="form-control" required> -->  
                        	<select id="revise_personName" class="form-control form-select" required>
                        	 <option id="revise_personNameOptionForPopupFistTime"></option>
       						 <!-- <option value="">Select Contact Person</option> -->
    						</select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Designation</label>
                            <input type="text" id="revise_designation" class="form-control" >
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mobile Number</label>
                            <input type="text" id="revise_contactDetails" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Email ID</label>
                            <input type="email" id="revise_emailId" class="form-control">
                        </div>
                         <div class="col-md-6">
                            <label class="form-label">Billing Address</label>
                            <!-- <input type="checkbox" id="revise_sameAddress" onchange="copyAddress()" style="margin-left:10px;"> Same as Billing Address -->
                            <textarea id="revise_shipmentAddress" class="form-control"></textarea>                     
   						</div>
                        <!-- <div class="col-md-6"> 
                            <label class="form-label">Delivery Address</label>
                            <textarea id="revise_deliveryAddress" class="form-control"></textarea>
                        </div> -->
                        <div class="col-md-6 mt-2"> 
                            <label class="form-label">Delivery Address</label>
                            <!-- <textarea id="deliveryAddress" class="form-control"></textarea> -->
                            <select id="revise_deliveryAddress" class="form-control form-select">
       						 <option id="revise_deliveryAddressOptionForPopupFistTime"></option>
    						</select>
                        </div>
                   </div>    
                   
                   <hr>
                    <!-- GST Selection -->
                    <h5>Tax Type</h5>
                    
                     <hr>
                    <div class="d-flex align-items-center mb-3">
                        <input type="checkbox" id="revise_interState" name="interState" class="form-check-input me-1 revisetaxTypeCheckBox" onchange="toggleGST('interState')"> 
                        <label class="form-check-label me-3">Interstate</label>

                        <input type="checkbox" id="revise_outerState" name="outerState" class="form-check-input me-1 revisetaxTypeCheckBox" onchange="toggleGST('outerState')"> 
                        <label class="form-check-label me-3">Outerstate</label>

                       <!--  <input type="number" id="gstPercentage" class="form-control ms-3" style="width: 100px;" placeholder="GST %" oninput="updateTableHeaders()">
                   -->  
                   </div>

                   <!-- Product Table -->
                    <hr>
                    <h5>Product Details</h5>
                     <hr>
<div class="d-flex justify-content-between align-items-center" style="gap: 10px;">
   
     <div class="col-md-3">
        <select class="form-control form-select" id="productName">
        	<!-- <option id="revise_productNameOptionForPopupFistTime"></option> -->
            <option value="">Select Product</option>
          
        </select>
    </div>
    <div class="col-md-3">
        <input type="text"  class="form-control" id="hsnCode" readonly>
            <!-- <option value="">Select HSN Code</option> -->
          
       
    </div>
    <div class="col-md-3">
        <input type="text"  class="form-control" id="partNumber" readonly>
          <!--   <option value="">Select Part Number</option> -->
            
      
    </div>
    <div class="col-md-3" style="display: none;">
        <input type="text"  class="form-control" id="productDescription" readonly>
            <!-- <option value="">Select Description</option> -->
          
        
    </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-secondary w-100" onclick="addProduct()">Add Product</button>
        </div>

</div>

	<div class="table-responsive">
		<table class="table table-bordered mt-3" style="font-size: 12px;">
		    <thead class="table bg-secondary">
		        <tr>
		            <th>Sl No</th>
		            <!-- <th>Product Name</th> -->
		            <th>HSN Code</th>
		            <th>Part Number</th>
		            <th>Description</th>
		            <th>Quantity</th>
		            <th>Price</th>
		            <th>Taxable Value</th>
		            <th class="revise_cgst-header d-none">CGST (9%)</th>
		            <th class="revise_sgst-header d-none">SGST (9%)</th>
		            <th class="revise_igst-header d-none">IGST (18%)</th>            
		            <th>Total Value</th>
		            <th>Actions</th>
		        </tr>
		    </thead>
		    <tbody id="revise_productTableBody">
		        <!-- Rows will be dynamically added here -->
		    </tbody>
		</table>
	</div>
                                 
                  
<!-- <table class="table table-bordered mt-3">
    <thead class="table bg-secondary">
        <tr>         
            <th>Product Name</th>
            <th>HSN Code</th>
            <th>Part Number</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Taxable Value</th>
            <th class="revise_cgst-header">CGST (9%)</th>
            <th class="revise_sgst-header">SGST (9%)</th>
            <th class="revise_igst-header">IGST (18%)</th>            
            <th>Total Value</th>
            
        </tr>
    </thead>
    <tbody id="revise_productTableBody">
        Rows will be dynamically added here
    </tbody>
</table> -->


			<div class="col-md-12 mt-2">
				<label>Terms And Condition</label>
				<textarea class="form-control" style="font-size: 14px;" id="revise_terms_and_condition" rows="3"></textarea>
			</div>
		
                </form>
                <div class="modal-footer table-responsive p-2">
                <button type="button" class="btn btn-primary" style="font-size: 14px;" onclick="reviseQuotation();" id="reviseQuotationSubmitBtn">Submit</button>
            </div>
          </div>
    </div>


<script>
    $(document).ready(function() {
        var table = $('#productTable').DataTable({
            "paging": true, 
            "searching": true,
             "lengthMenu": [8, 10, 25, 50, 75, 100, 200, 500, 800, 1000],
             "pageLength": 8,
             "pagingType": "full_numbers",
            "info": true,
            "dom": '<"d-flex justify-content-between mb-2"l f>t<"d-flex justify-content-between mt-2"i p>',
            
        });
    });
    
    
    function convertQuotationAs(qid, clickedAs){
    	//alert(qid+" "+clickedAs);
    	$.ajax({
            type: 'POST',
            url: '/dc/save',
            data: {
                "qid": qid,
                "clickedFor": clickedAs
            },
            success: function (response) {
                if (response === 'Delivery Challan saved successfully!') {
                	alert(response);
                }
            },
            error: function (xhr, status, error) {
            	alert('Error inserting data as '+clickedAs);
                console.error('Error inserting data as '+clickedAs);
                console.log('XHR object:', xhr);
                console.log('Status:', status);
                console.log('Error:', error);
            }
        });    	
    }
    
</script>


<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->


<!-- <script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".generate-pdf").forEach((button) => {
        button.addEventListener("click", function () {
            let row = button.closest("tr"); // Get the row
            let doc = new window.jspdf.jsPDF();
            
            // Draw Page Border
            doc.setDrawColor(0); // Black Border
            doc.rect(5, 5, 200, 287); // (x, y, width, height)

            // Load and add logo
            let logo = new Image();
            logo.src = "/assets/img/logo.png";
            logo.onload = function () {
                doc.addImage(logo, "PNG", 20, 10, 40, 20);

                // Define starting y position
                let yStart = 28; 

                // Company Address (Right-Aligned)
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("Melange Systems Private Limited", 200, 15, { align: "right" });
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text("4/1, 7th cross, Kumara Park West,", 200, 22, { align: "right" });
                doc.text("Bangalore, Karnataka - 560020", 200, 28, { align: "right" });
                doc.text("Phone: +91 8023561023", 200, 34, { align: "right" });

                let yPos = yStart + 10; // Adjust for spacing

                // Line before heading
                doc.setDrawColor(0.5);
                doc.line(5, yPos, 205, yPos); // Horizontal Line

                // Quotation Details Heading
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                yPos += 7; // Space before heading
                doc.text("Sales Quotation", 105, yPos, { align: "center" });

                // Line after heading
                doc.setDrawColor(0);
                yPos += 3;
                 doc.line(5, yPos, 205, yPos); // Horizontal Line

                // Extract row data
                let dateTime = row.cells[0].innerText;
                let qid = row.cells[1].innerText;
                let customerName = row.cells[2].innerText;
                let contactPerson = row.cells[3].innerText;
                let mobileNumber = row.cells[5].innerText;
                let emailId = row.cells[6].innerText;
                let orderPlatform = row.cells[7].innerText;
                let deliveryAddress = row.cells[8].innerText;
                let shipmentAddress = row.cells[9].innerText;

                // Customer Details
                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);
                yPos += 10;
                doc.text(`Date: ${dateTime}`, 130, yPos);
                doc.text(`Quotation ID: ${qid}`, 130, yPos+7);
                

               yPos += 0;

// Customer Details Heading (Bold & Underlined)
doc.setFont("helvetica", "bold");
doc.text("Customer Details", 20, yPos);
doc.setLineWidth(0.5);
doc.line(20, yPos + 2, 55, yPos + 2); // Underline
doc.setFont("helvetica", "normal");

// Customer Name & Address
yPos += 10;
doc.text(`Customer: ${customerName}`, 20, yPos);
doc.text(`Address: ${shipmentAddress}`, 20, yPos + 10);

// Contact Details Heading (Bold & Underlined)
yPos += 20;
doc.setFont("helvetica", "bold");
doc.text("Contact Details", 20, yPos);
doc.line(20, yPos + 2, 51, yPos + 2); // Underline
doc.setFont("helvetica", "normal");

// Contact Information
yPos += 10;
doc.text(`Contact Person: ${contactPerson}`, 20, yPos);
doc.text(`Mobile Number: ${mobileNumber}`, 20, yPos + 10);
doc.text(`Email Id: ${emailId}`, 20, yPos + 20);

yPos += 30;
doc.setFont("helvetica", "bold");
doc.text("Delivery Address", 20, yPos);
doc.line(20, yPos + 2, 54, yPos + 2); // Underline
doc.setFont("helvetica", "normal");

// Contact Information
yPos += 10;
doc.text(`${deliveryAddress}`, 20, yPos + 0);
                
                
yPos += 10;
doc.setFont("helvetica", "bold");
doc.text("Product Details", 20, yPos);
doc.setLineWidth(0.5);
doc.line(20, yPos + 2, 51, yPos + 2); // Underline


                // Table Headers
                yPos += 10;
                let xPos = 20;
                let colWidths = [45, 25, 25, 25, 35]; // Adjusted column widths

                doc.setFont("helvetica", "bold");
                doc.setFillColor(200, 200, 200);
                doc.rect(xPos, yPos - 5, 155, 10, "F"); // Header background

                let headers = ["Product Name", "Quantity", "Price", "Discount", "Amount"];
                headers.forEach((header, i) => {
                    doc.text(header, xPos + 2, yPos);
                    xPos += colWidths[i];
                });

                // Table Borders and Data
                doc.setFont("helvetica", "normal");
                yPos += 5;
                let products = [];

                row.cells[10].querySelector("tbody").querySelectorAll("tr").forEach((tr) => {
                    let productName = tr.cells[0].innerText;
                    let quantity = tr.cells[1].innerText;
                    let price = tr.cells[2].innerText;
                    let discount = tr.cells[3].innerText;
                    let cgst = tr.cells[5]?.innerText || "0";
                    let sgst = tr.cells[6]?.innerText || "0";
                    let total = tr.cells[4].innerText;
                    products.push({ productName, quantity, price, discount, cgst, sgst,  total });
                });

                products.forEach((prod) => {
                    xPos = 20;
                    yPos += 10;
                    
                    let rowData = [
                        prod.productName,
                        prod.quantity,
                        prod.price,
                        prod.discount,                        
                        prod.total
                    ];

                    // Draw table cells with borders
                    for (let i = 0; i < rowData.length; i++) {
                        doc.text(rowData[i], xPos + 2, yPos);
                        doc.rect(xPos, yPos - 7, colWidths[i], 10); // Border for each cell
                        xPos += colWidths[i];
                    }
                });
                
               // Calculate total CGST and SGST before using them
// Calculate total CGST, SGST, and Amount
let totalCgst = 0;
let totalSgst = 0;
let totalAmount = 0;

products.forEach((prod) => {
    totalCgst += parseFloat(prod.cgst) || 0; // Convert to float, default to 0 if NaN
    totalSgst += parseFloat(prod.sgst) || 0;
    totalAmount += parseFloat(prod.total) || 0;
});

let finalTotal = totalAmount + totalCgst + totalSgst; // Final Total including GST

// GST Summary (Right Side)
yPos += 10;
let xRightAlign = 115; // Adjust position

//doc.setFont("helvetica", "bold");
//doc.text("GST Summary", xRightAlign, yPos);
//yPos += 10;

doc.setFont("helvetica", "normal");
doc.text(`SGST (9%):      ${totalSgst.toFixed(2)}`, xRightAlign, yPos);
yPos += 5;
doc.text(`CGST (9%):      ${totalCgst.toFixed(2)}`, xRightAlign, yPos);
yPos += 5;
// Underline Above "Total"
let lineStartX = xRightAlign - 0; // Adjust as needed
let lineEndX = xRightAlign + 43;  // Adjust width as needed
let lineY = yPos - 3; // Position slightly above text
doc.line(lineStartX, lineY, lineEndX, lineY); // Draw line
yPos += 3;
// Bold "Total"
doc.setFont("helvetica", "bold");
doc.text(`          Total:    ${finalTotal.toFixed(2)}`, xRightAlign, yPos);
yPos += 3;

// Underline Below "Total"
lineY = yPos + 0; // Position slightly below text
doc.line(lineStartX, lineY, lineEndX, lineY); // Draw line

yPos += 10;

// Convert Number to Words Function
function numberToWords(num) {
    const a = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const b = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

    function convert(n) {
        if (n < 20) return a[n];
        if (n < 100) return b[Math.floor(n / 10)] + (n % 10 !== 0 ? " " + a[n % 10] : "");
        if (n < 1000) return a[Math.floor(n / 100)] + " Hundred" + (n % 100 !== 0 ? " and " + convert(n % 100) : "");
        if (n < 100000) return convert(Math.floor(n / 1000)) + " Thousand" + (n % 1000 !== 0 ? " " + convert(n % 1000) : "");
        return num; // Extend logic if needed
    }

    return num === 0 ? "Zero" : convert(num);
}

// Convert total price to words
let totalInWords = numberToWords(Math.floor(finalTotal));

// Display Total in Words
doc.setFont("helvetica", "bold");
doc.text(`Total Amount in Words: `, 20, yPos);
yPos += 5;
doc.setFont("helvetica", "normal");
doc.text(`${totalInWords} Only`, 20, yPos);


//doc.setFont("helvetica", "bold");
//doc.text(`Total Central GST: ${totalCgst.toFixed(2)}`, xRightAlign, yPos);
//yPos += 5;
//doc.text(`Total State GST: ${totalSgst.toFixed(2)}`, xRightAlign, yPos);


                // Terms & Conditions
yPos += 10;
doc.setFont("helvetica", "bold");
doc.text("Terms & Conditions:", 20, yPos);
doc.setFont("helvetica", "normal");
doc.setFontSize(10);

let terms = [
    "1. Payment Terms:\nThe Buyer agrees to pay 100% of the total amount in advance prior to the release of the goods or services.",
    "2. Validity:\nThis Quote is valid for a period of 30 days from the date of issue. After this period, the prices and terms may be subject to change at the Seller's discretion.",
    "3. Stock Availability:\nThe Buyer must confirm the availability of stock before proceeding with the issuance of a Purchase Order (PO) or making any payment. The Seller does not guarantee the availability of goods until confirmation is provided.",
    "4. Pricing:\nAll prices stated in this Quote are valid for a period of 30 days from the date of issue. After this period, the Seller reserves the right to amend or adjust the pricing. Any change in pricing will be communicated to the Buyer before proceeding with the order."
];

yPos += 5;
terms.forEach((term) => {
    let wrappedText = doc.splitTextToSize(term, 170); // Wrap text within page width
    doc.text(wrappedText, 22, yPos);
    yPos += wrappedText.length * 5; // Adjust spacing dynamically
});


                // Save PDF
                doc.save(`Quotation_${qid}.pdf`);
            };
        });
    });
});
</script> -->


<script>
function openDetails(button) {
	//alert(JSON.stringify(productData))
	 var row = button.closest('tr');
	    var rowIndex = row.rowIndex - 1; // Adjusting for header row
	    //alert(rowIndex);
	    var qId = row.cells[2]?.innerText;
	    var dateTime = row.cells[6]?.innerText;
	    document.getElementById("qid").value = qId;
	    document.getElementById("qdateTime").value = dateTime;
	   //alert(qId);
	   
	   $.ajax({
        url: '/retrieveEmailSentFlagStatusValue',
        type: 'GET',
        data: {
        	quotationId: qId
        },
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	if(data === "2"){
        		$('#quotationReviewApproveBtn').text("Manually Sent");
        	}else if(data === "1"){
        		$('#quotationReviewApproveBtn').text("Email Sent to Customer");
        	}else{
        		$('#quotationReviewApproveBtn').text("Approve");
        	}
        },
        error: function(xhr, status, error) {
            console.error('Failed to get email sent status flag:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
	    
	    fetch(`/getQuotationDetails?id=${qId}`) // API call to fetch data
        .then(response => response.json())
        .then(data => {
        	console.log(JSON.stringify(data));
            // Populate Modal Fields
            document.getElementById("qid").value = data.qid;
            document.getElementById("qdateTime").value = data.dateTime;
            document.getElementById("vendorName").value = data.customerName;
            document.getElementById("vendorlegalNamee").value = data.customerLegalName;
            document.getElementById("gstnumberr").value = data.gstNumber;
            document.getElementById("orderMethod").value = data.orderMethod;
            document.getElementById("personName").value = data.contactPersonName; 
            document.getElementById("designation").value = data.designation;
            document.getElementById("contactDetails").value = data.contactDetails;
            document.getElementById("emailId").value = data.emailId;
            document.getElementById("shipmentAddress").value = data.shipmentAddress;
            document.getElementById("deliveryAddress").value = data.deliveryAddress;
            document.getElementById("company_honorifics").value = data.honorifics1;
            document.getElementById("contact_person_honorifics").value = data.honorifics2;
            
            document.getElementById("revise_qid").value = data.qid;
            //document.getElementById("revise_qdateTime").value = data.dateTime;
            document.getElementById("revise_vendorName").value = data.customerName;
            document.getElementById("revise_vendorlegalNamee").value = data.customerLegalName;
            document.getElementById("revise_gstnumberr").value = data.gstNumber;
            //document.getElementById("revise_orderMethod").value = data.orderMethod;
            document.getElementById("revise_personNameOptionForPopupFistTime").value = data.contactPersonName; 
            document.getElementById("revise_personNameOptionForPopupFistTime").innerHTML = data.contactPersonName;
            document.getElementById("revise_designation").value = data.designation;
            document.getElementById("revise_contactDetails").value = data.contactDetails;
            document.getElementById("revise_emailId").value = data.emailId;
            document.getElementById("revise_shipmentAddress").value = data.shipmentAddress;
            document.getElementById("revise_company_honorifics").value = data.honorifics1;
            document.getElementById("revise_contact_person_honorifics").value = data.honorifics2;
            //document.getElementById("revise_deliveryAddress").value = data.deliveryAddress;
            
            document.getElementById("revise_deliveryAddressOptionForPopupFistTime").value = data.deliveryAddress; 
            document.getElementById("revise_deliveryAddressOptionForPopupFistTime").innerHTML = data.deliveryAddress;
            
            let orderMethodDropDown = document.getElementById("revise_orderMethod");
            let options = orderMethodDropDown.options;
            
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === data.orderMethod) {
                    options[i].selected = true;  // Match found, set as selected
                    break;
                }
            }
            
            //alert(data.review);
            
            if(data.review != 0){
            	$('#quotationSubmitBtnForReview').text("Submitted");
            	$('#quotationSubmitBtnForReview').prop("disabled", true);
            	$('#reviseQuotationBtn').css("display", "block");
            	$('#quotationReviewApproveBtn').css("display", "block");
            	$('#quotationSubmitBtnForReview').css("display", "none");
            }else{
            	$('#quotationSubmitBtnForReview').text("Submit");
            	$('#quotationSubmitBtnForReview').prop("disabled", false);
            	$('#reviseQuotationBtn').css("display", "none");
            	$('#quotationReviewApproveBtn').css("display", "none");
            	$('#quotationSubmitBtnForReview').css("display", "block");
            }
            
            if(data.review === 3){
        		$('#wonQuotationBtn').prop("disabled", true);
        		$('#terminateQuotationBtn').prop("disabled", false);
        		$('#quotationReviewApproveBtn').css("display", "none");
        		$('#reviseQuotationBtn').css("display", "none");
        		$('#quotationSubmitBtnForReview').css("display", "none");
        		$('#terminateQuotationBtn').css("display", "none");
        	}else if(data.review === 4){
        		$('#terminateQuotationBtn').prop("disabled", true);
        		$('#wonQuotationBtn').prop("disabled", false);
        		$('#quotationReviewApproveBtn').css("display", "none");
        		$('#reviseQuotationBtn').css("display", "none");
        		$('#quotationSubmitBtnForReview').css("display", "none");
        		$('#wonQuotationBtn').css("display", "none");
        	}
            
           // alert(data.contactPersonName);
           // Apply tax type logic
            applyTaxType(data.tax_type);
            if(data.tax_type === "interstate"){
            	 document.getElementById("interState").checked = true;
            	 document.getElementById("outerState").checked = false;
            }
            else if(data.tax_type === "outerstate"){
            	 document.getElementById("outerState").checked = true;
            	 document.getElementById("interState").checked = false;
            }
            
         	// Populate product details
            let productTable = document.getElementById("productTableBody");
            productTable.innerHTML = ""; // Clear old data
            
            let productDropdown = document.getElementById("productName");
            
            data.products.forEach((product, index) => {
            	let options = productDropdown.options;
                
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === product.partNumber) {
                    	//alert(product.partNumber);
                        options[i].selected = true;  // Match found, set as selected
                        break;
                    }
                }
                
                populateProductDetailsDataBasedOnSelectedProductNameInRevise(product.partNumber);
                addProduct();
                
                /* let quantityFields = document.querySelectorAll(".quantity");
                let priceFields = document.querySelectorAll(".price");

                if (quantityFields[index]) {
                    quantityFields[index].value = product.quantity;
                }

                if (priceFields[index]) {
                    priceFields[index].value = product.price;
                } */
                
                let quantityFields = document.querySelectorAll("#revise_productTableBody .quantity");
                let priceFields = document.querySelectorAll("#revise_productTableBody .price");

                let lastIndex = quantityFields.length - 1; // Get last added row

                if (quantityFields[lastIndex]) {
                    quantityFields[lastIndex].value = product.quantity;
                    quantityFields[lastIndex].dispatchEvent(new Event('input')); // Trigger calculation
                }

                if (priceFields[lastIndex]) {
                    priceFields[lastIndex].value = product.price;
                    priceFields[lastIndex].dispatchEvent(new Event('input')); // Trigger calculation
                }
                
              //calculateTotalPriceValueAndTaxCalculationForRevisedPopup(product.quantity, product.price);

              //alert(product.hsnCode);
              
              var formatTotal = formatPrice(product.total);
              var formatTotalValue = formatPrice(product.total_value);
              var formatPriceValue = formatPrice(product.price);
            
            //data.products.forEach((product, index) => {
                let row = `<tr>                
                    <td style="display: none;">${product.productName}</td>
                    <td>${product.hsnCode}</td>
                    <td>${product.partNumber}</td>
                    <td>${product.description}</td>
                    <td>${product.quantity}</td>
                    <td>${formatPriceValue}</td>
                    <td>${formatTotal}</td>
                    <td class="cgst-header ${data.tax_type === 'interstate' ? '' : 'd-none'}">${product.cgst || "-"}</td>
                    <td class="sgst-header ${data.tax_type === 'interstate' ? '' : 'd-none'}">${product.sgst || "-"}</td>
                    <td class="igst-header ${data.tax_type === 'outerstate' ? '' : 'd-none'}">${product.igst || "-"}</td>
                    <td>${formatTotalValue}</td>                   
                </tr>`;
                productTable.innerHTML += row;
            });
            
         // Populate product details
            let productHiddenTable = document.getElementById("hiddenProductTableBody");
            productHiddenTable.innerHTML = ""; // Clear old data
            
            data.products.forEach((product, index) => {
                let row = `<tr>     
                	<td>${product.productName}</td>
                    <td>${product.quantity}</td>
                    <td>${product.price}</td>
                    <td>${product.discount}</td>
                    <td>${product.total}</td>                        
                    <td>${product.cgst}</td>
                    <td>${product.sgst}</td>
                    <td>${product.igst}</td>
                </tr>`;
                productHiddenTable.innerHTML += row;
            });

            // Show modal
            //document.getElementById("myModal").style.display = "block";
        })
        .catch(error => console.error("Error fetching quotation:", error));
            
	    // Show the modal
	    document.getElementById("editRowIndex").value = rowIndex;
	    openViewQuotationOuterDiv();
	    
	    /* var quotationModal = new bootstrap.Modal(document.getElementById('quotationModal'));
	    quotationModal.show(); */
	};
	
	function formatPrice(value) {
	    value = parseFloat(value); // Convert string to number
	    if (isNaN(value)) {
	        return "Invalid Number"; // Handle invalid cases
	    }
	    return value % 1 === 0 ? value.toFixed(2) : value;
	}

	/* function toggleGST(selectedType) {
	    let isInterState = selectedType === "interState";
	
	    // Set checkbox values based on selection
	    document.getElementById("interState").checked = isInterState;
	    document.getElementById("outerState").checked = !isInterState;
	
	    // Show/hide table headers based on tax type
	    document.querySelectorAll(".cgst-header, .sgst-header").forEach(header => {
	        header.classList.toggle("d-none", !isInterState);
	    });
	
	    document.querySelectorAll(".igst-header").forEach(header => {
	        header.classList.toggle("d-none", isInterState);
	    });
	} */
	
	function toggleGST(type) {
		//alert(type);
	    if (type === "interState") {
	        document.getElementById("revise_outerState").checked = false;
	    } else {
	        document.getElementById("revise_interState").checked = false;
	    }

	    applyGSTSelection();
	}

// Function to apply settings when fetching data
/* function applyTaxType(taxType) {
    if (taxType === "interstate") {
        document.getElementById("interState").checked = true;
        document.getElementById("outerState").checked = false;
        toggleGST("interState");
    } else if (taxType === "outerstate") {
        document.getElementById("outerState").checked = true;
        document.getElementById("interState").checked = false;
        toggleGST("outerState");
    }
} */


//Function to apply settings when fetching data
function applyTaxType(taxType) {
    if (taxType === "interState") {
        document.getElementById("revise_interState").checked = true;
        document.getElementById("revise_outerState").checked = false;
        toggleGST("interState");
    } else if (taxType === "outerState") {
        document.getElementById("revise_outerState").checked = true;
        document.getElementById("revise_interState").checked = false;
        toggleGST("outerState");
    }
}

$.ajax({
    url: '/returnRecentlyInsertedTermsAndConditionDetail',
    type: 'GET',
    contentType: 'application/json', // Specify content type
    success: function(data) {
    	$('#terms_and_condition').val(data.terms_and_condition_data);
    	$('#revise_terms_and_condition').val(data.terms_and_condition_data);
    },
    error: function(xhr, status, error) {
        console.error('Failed to get terms and condition details:', error);
        console.error('Response text:', xhr.responseText);
    }
});

function updateQuotationStatusAfterReview(quotationId, customerEmail, clickedStatusBtnValue){
	//alert(quotationId+" "+clickedStatusBtnValue);
	$.ajax({
        type: 'POST',
        url: '/updateReviewStatusForQuotationReview',
        data: {
            "reviewStatus": clickedStatusBtnValue,
            "quotationId": quotationId
        },
        success: function (response) {
            if (response === 'success') {
            	if(clickedStatusBtnValue === 2){
            		/* $('#quotationReviewRejectBtn').text("Reject");
                	$('#quotationReviewRejectBtn').prop("disabled", false);
            		$('#quotationReviewApproveBtn').text("Approved");
                	$('#quotationReviewApproveBtn').prop("disabled", true); */
                	//$('#quotationModal').modal('hide');
                	openSendEmailForCustomerOuterDiv(quotationId, customerEmail);
            	}else if(clickedStatusBtnValue === 3){
            		/* $('#quotationReviewApproveBtn').text("Approve");
                	$('#quotationReviewApproveBtn').prop("disabled", false);
            		$('#quotationReviewRejectBtn').text("Rejected");
                	$('#quotationReviewRejectBtn').prop("disabled", true); */
            	}
            }
        },
        error: function (xhr, status, error) {
        	hideLoadingPopup();
            console.error('Error updating quotation after review status record:');
            console.log('XHR object:', xhr);
            console.log('Status:', status);
            console.log('Error:', error);
        }
    });   	
}

function closeSendEmailForCustomerOuterDiv(){
	$('#sendEmailForCustomerOuterDiv').hide();
}

function closeEmailPasswordOuterDiv(){
	$('#emailPasswordOuterDiv').hide();
}

function openEmailPasswordOuterDiv(){
	$('#emailPasswordOuterDiv').show();
}

function closeViewQuotationOuterDiv(){
	document.body.style.overflow="auto";
	$('#viewQuotationOuterDiv').hide();
	location.reload();
}

function openViewQuotationOuterDiv(){
	document.body.style.overflow="hidden";
	$('#viewQuotationOuterDiv').show();
}

function closeReviseQuotationOuterDiv(){
	location.reload();
	$('#revise_QuotationOuterDiv').hide();
}

function openReviseQuotationOuterDiv(){
	$('#revise_QuotationOuterDiv').show();
}

function openSendEmailForCustomerOuterDiv(quotationId, customerEmail){
	
	$('#emailToAddress').val(customerEmail);
	$('#emailSubject').val("Melange sales proposal estimation: "+quotationId);
	
	$.ajax({
        type: 'GET',
        url: '/fetchReportingManagersEmailBasedOnEmpEmail',
        data: {
        	employee_email: $('#emailFromAddress').val()
        	//employee_email: "sanjay.raj@melangesystems.com"
        },
        success: function (response) {
        	let firstEmail = response.first_reporting_manager_email;
            let secondEmail = response.second_reporting_manager_email;
            let emailCCField = $('#emailCCAddress');

            // Ensure both values are not null and compare them
            if (firstEmail && secondEmail) {
                if (firstEmail !== secondEmail) {
                    emailCCField.val(firstEmail + ', ' + secondEmail);
                } else {
                    emailCCField.val(firstEmail); // If both are the same, add only once
                }
            } else if (firstEmail) {
                emailCCField.val(firstEmail);
            } else if (secondEmail) {
                emailCCField.val(secondEmail);
            }
        },
        error: function (xhr, status, error) {
            console.error('Error fetching reporting managers email:');
            console.log('XHR object:', xhr);
            console.log('Status:', status);
            console.log('Error:', error);
        }
    });
	
	$.ajax({
        url: '/returnRecentlyInsertedEmailDraftMessageDetail',
        type: 'GET',
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	$('#emailBody').val(data.email_draft);
        },
        error: function(xhr, status, error) {
            console.error('Failed to get email draft details:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
	
	$.ajax({
        url: '/retrieveEmailSentFlagStatusValue',
        type: 'GET',
        data: {
        	quotationId: quotationId
        },
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	if(data === "2"){
        		$('#emailManuallySentCheckBox').prop("checked", true);
        		$('#downloadPdfManuallyBtn').css("display", "block");
        		$('#email_send_button').text("Manually Sent");
        		$('#quotationReviewApproveBtn').text("Manually Sent");
        		$('#email_send_button').prop("disabled", true);
        	}else if(data === "1"){
        		$('#email_send_button').prop("disabled", false);
        		$('#downloadPdfManuallyBtn').css("display", "none");
        		$('#email_send_button').text("Email Sent to Customer");
        		$('#quotationReviewApproveBtn').text("Email Sent to Customer");
        		$('#emailManuallySentCheckBox').prop("checked", false);
        	}else{
        		$('#email_send_button').text("Send");
        		$('#email_send_button').prop("disabled", false);
        		$('#downloadPdfManuallyBtn').css("display", "none");
        		$('#quotationReviewApproveBtn').text("Approve");
        		$('#emailManuallySentCheckBox').prop("checked", false);
        	}
        },
        error: function(xhr, status, error) {
            console.error('Failed to get email sent status flag:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
	
	//document.getElementById('sendEmailForCustomerOuterDiv').style.display = "block";
	$('#sendEmailForCustomerOuterDiv').show();
}

function sendDataToEmailToTheParticularCustomer(){
	//let fromAddress = $('#emailFromAddress').val().trim();
	let fromAddress = "premchand.s@melangesystems.com";
	let toAddress = $('#emailToAddress').val().trim();
	//let toAddress = "premsgowda25@gmail.com";
	let ccAddress = $('#emailCCAddress').val().trim();
	let subjectName = $('#emailSubject').val().trim();
	let bodyContent = $('#emailBody').val().trim();
	let enteredPaswword = $('#ionos_password').val().trim();
	
	const submitButton = document.getElementById('emailSendBtn');
	
	 if (!enteredPaswword) {
         Swal.fire({ icon: 'warning', title: "Password is required" });
         return;
     }
	
	// Store original button text before changing it
     const originalButtonText = submitButton.innerHTML;
     
     // Disable button and show loading state
     submitButton.disabled = true;
     submitButton.innerHTML = `Validating...`;
	
  	// Validate sender email & password
     fetch('/api/validateSenderCredentials', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ email: fromAddress, password: enteredPaswword })
     })
     .then(response => {
         if (!response.ok) {
             return response.text().then(text => { throw new Error(text); });
         }
         return response.text();
     })
     .then(() => {
         // Close password popup
         closeEmailPasswordOuterDiv();
         
         $.ajax({
             url: '/returnRecentlyInsertedEmailDraftMessageDetail',
             type: 'GET',
             contentType: 'application/json', // Specify content type
             success: function(data) {
             	
             	if(data.email_draft !== bodyContent){

             		let emailDraftData = {
             				email_draft: bodyContent
             		    };
             		
             		$.ajax({
             	        type: "POST",
             	        url: "/insertEmailDraft",
             	        contentType: "application/json",
             	        data: JSON.stringify(emailDraftData),
             	        success: function(response) {
             	        	console.log(response);
             	        },
             	        error: function(xhr) {
             	            alert("Error: " + xhr.responseText);
             	        }
             	    });
             	}
             	
             },
             error: function(xhr, status, error) {
                 console.error('Failed to get email draft details:', error);
                 console.error('Response text:', xhr.responseText);
             }
         });
         
      	  // Proceed with sending email sending...
          sendEmailToTheCustomerAfterValidation(fromAddress, toAddress, ccAddress, subjectName, bodyContent, enteredPaswword);
     })
     .catch(error => {
         Swal.fire({ icon: 'error', title: "Invalid Credentials", text: error.message });
         //alert("Invalid Credentials");
         submitButton.disabled = false;
         submitButton.innerHTML = originalButtonText;
     })
     .finally(() => {
     	// Re-enable button and restore original text
         submitButton.disabled = false;
         submitButton.innerHTML = originalButtonText;
     });
}

function sendEmailToTheCustomerAfterValidation(fromAddress, toAddress, ccAddress, subjectName, bodyContent, enteredPaswword){
	let quotationId = $('#qid').val();
	
	displayOnLoadingPopup();
	
	const { jsPDF } = window.jspdf;
	const doc = new jsPDF();
    
    var rawDateTime = document.getElementById("qdateTime").value;
    
    // Draw Page Border
    doc.setDrawColor(0); // Black Border
    //doc.rect(3, 3, 203.5, 330); // (x, y, width, height)
    doc.rect(3, 3, 203.5, 291); // 297 - 6 for padding

    let mainY = 33;
 	// ✅ HEADER BAR
   	doc.setDrawColor(0); // Black border
    doc.rect(3, 3, 203.5, mainY); // Header box

    // ✅ Add Company Address (Left Side)
    doc.setTextColor(0); // Black text
    doc.setFont("helvictica","bold");
    doc.setFontSize(12);
    doc.text("Melange Systems Private Limited", 7, 10);
    doc.setFontSize(10);
    
    doc.setFont("helvictica","normal");

    doc.setFontSize(10);
    doc.text("(ISO 9001:2015 Certified Company)", 7, 15);
    
    doc.text("4/1, 7th cross, Kumara Park West, Bangalore, Karnataka - 560020", 7, 20);
    //doc.text("Bangalore, Karnataka - 560020", 10,18.5);
    doc.text("Phone: +91 8023561023", 7, 25);
    
    doc.setFont("helvetica", "bold");
    doc.text("GSTIN: 29AACCM4737H1ZA", 7,30, );
    
    doc.text("Udyan Ref No: UDYAM-KR-03-0101576", 7, 35, );
    doc.setFont("helvetica", "normal");
    // ✅ Add Company Logo (Right Side)
   	let logo = new Image();
    logo.src = "/assets/img/logo.png";
    
    //logo.onload = function () {
    doc.addImage(logo, "PNG", 150, 10, 50, 18); // (image, type, x, y, width, height)        

    // Title
    doc.setFontSize(16);

     // Draw the centered text
     let title = "QUOTE";
     let centerX = 105;
     let textY1 = mainY + 10;
     doc.setFont("helvetica", "bold"); 
     doc.text(title, centerX, textY1, { align: "center" });

     // Measure the width of the text
     let textWidth2 = doc.getTextWidth(title);

     // Draw underline manually (a horizontal line below the text)
     let underlineY = textY1 + 1; // slightly below the text
     doc.line(centerX - textWidth2 / 2, underlineY, centerX + textWidth2 / 2, underlineY);

    
    
    
    // doc.setFont("helvetica", "normal");
    //doc.rect(3, 28, 203.5, 10); // Horizontal Line
    
    
    
    // quotation Id dddaaaattteee 
    doc.setFontSize(12);
    //doc.rect(3, 38, 203.5, 10);
    
    doc.text("To,", 7, mainY + 15);
    mainY += 10
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal"); 
    doc.text(document.getElementById("qid").value, 160, mainY + 7);
    
    
    if (rawDateTime) {
        var date = new Date(rawDateTime);
        var day = String(date.getDate()).padStart(2, '0');
        var month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based
        var year = date.getFullYear();
        var formattedDate = `${day}-${month}-${year}`;

        doc.text(formattedDate, 160, mainY + 12);
    }  
    
    //doc.rect(3, 38, 203.5, 60); // Horizontal Line
    //doc.line(105, 48, 105, 98); 
    
    doc.setFont("helvetica", "bold");
    //doc.text("Billing Address", 10, 54  ); 
    //doc.text("Shipping Address", 129, 54  );  
    //doc.rect(3, 48, 102, 10);  // Left Header Box
    //doc.rect(105, 48, 101.5, 10); // Right Header Box
    
    doc.setFont("helvetica", "bold"); 
    doc.setFontSize(10);
	
    let billingAndShippengAddY = mainY + 12;
    
    // Billing Address Section
    // ✅ M/S (Bold) + Vendor Name (Normal) on the Same Line
    let msLabel = document.getElementById("company_honorifics").value;
    
    doc.setFont("helvetica", "bold");
    doc.text(msLabel, 12, billingAndShippengAddY);
    let msLabelWidth = doc.getTextWidth(msLabel);
    doc.setFont("helvetica", "bold");
    doc.text(document.getElementById("vendorlegalNamee").value, msLabelWidth + 12, billingAndShippengAddY); 
	
    
    
    // ✅ Address (Bold) + Address Text (Normal, Wrapped Properly)
    doc.setFont("helvetica", "bold");
    let addressLabel = "Address ";
    //doc.text(addressLabel, 10, billingAndShippengAddY + 6);
    let addressLabelWidth = doc.getTextWidth(addressLabel);
    doc.setFont("helvetica", "normal");

    let addressText = document.getElementById("shipmentAddress").value;
    let maxWidth = 65;
    let addressLines = doc.splitTextToSize(addressText, maxWidth);
    let addressX = addressLabelWidth;
    let addressY = billingAndShippengAddY + 6;

    // Print wrapped address lines
    let lineHeight = 5; // Adjust if your font size changes
    for (let i = 0; i < addressLines.length; i++) {
        doc.text(addressLines[i], addressX - 3, addressY + (i * lineHeight));
    }  

    // ✅ Dynamically Position GSTIN After Address
    let gstY = addressY + (addressLines.length * lineHeight) + 1; // Extra 5px padding after address
    doc.setFont("helvetica"); 
    let gstLabel = "GSTIN";
    //doc.text(gstLabel, 15, gstY);
    
    doc.text(`GSTIN ${document.getElementById("gstnumberr").value}`, 12, gstY);
    
    let gstLabelWidth = doc.getTextWidth(gstLabel);
    doc.setFont("helvetica", "normal");
    //doc.text(document.getElementById("gstnumberr").value, 10 + gstLabelWidth + 9.5, gstY);
    
    let lineHeight1 = 5;
    
    // ------------------ Contact Person ------------------ 
	let contactY = gstY + 2;
	let msLabell = "Contact Person ";
	let contactName = document.getElementById("personName").value;
	let contactDetailsX = 7;
	
	doc.setFont("helvetica","bold");
	doc.text(`Contact Details:`, contactDetailsX, contactY + 5);
	
	
	//contact name
	let contactDetailsTextWidth = doc.getTextWidth("Contact Details");
	let honorificForContactPerson = document.getElementById("contact_person_honorifics").value;
	//contactDetailsX += contactDetailsTextWidth;
	doc.setFont("helvetica", "normal");
	doc.text(honorificForContactPerson + " " +contactName,contactDetailsX + contactDetailsTextWidth + 2,contactY + 5);
	
	// Get the width of the contactName text
	let contactNameAndHonor = honorificForContactPerson + " " +contactName;
	let contactPersonTextWidth = doc.getTextWidth(contactNameAndHonor);		
	doc.setFont("helvetica", "bold");
	doc.text("|",  contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 3,contactY + 5);
	
	// contact person mobile no
	doc.setFont("helvetica", "normal");
	let mobilNo = document.getElementById("contactDetails").value;
	doc.text(mobilNo,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 6,contactY + 5);
	
	let ContactPersonmobilNoTextWidth = doc.getTextWidth(mobilNo); 
	doc.setFont("helvetica", "bold");
	doc.text("|", contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 9,contactY + 5);
	
	//email Id
	let email = document.getElementById("emailId").value;
	doc.setFont("helvetica", "normal");
	doc.text(email ,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 12,contactY + 5);
	
	let msLabelWidthh = doc.getTextWidth(msLabell);
	doc.setFont("helvetica", "normal");
	// doc.text(document.getElementById("personName").value, 15 + msLabelWidthh + 5, contactY);
	
	// ------------------ Mobile Number ------------------
	let mobileY = contactY + lineHeight1;
	doc.setFont("helvetica");
	let gstLabell = "Mobile Number ";
	//doc.text(`Mobile Number :${document.getElementById("contactDetails").value}`, 7, mobileY + 5);
	let gstLabelWidthh = doc.getTextWidth(gstLabell);
	doc.setFont("helvetica", "normal");
	//doc.text(document.getElementById("contactDetails").value, 15 + gstLabelWidthh + 5, mobileY);
	
	// ------------------ Email ID ------------------
	
	doc.setFont("helvetica");
	let gstLabelll = "Email ID ";
	//doc.text(`Email ID            :${document.getElementById("emailId").value}`, 7, emailY + 5);
	let gstLabelWidthhh = doc.getTextWidth(gstLabelll);
	doc.setFont("helvetica", "normal");
	//doc.text(document.getElementById("emailId").value, 15 + gstLabelWidthhh + 17, emailY);
    
	
	// dear sir / madam
	//let Y = contactY + 10;
	let YAfterContactPerson = contactY + 13;
	doc.setFont("helvetica","bold");
	doc.text("Dear Sir / Madam", 7,YAfterContactPerson);
	doc.setFont("helvetica","normal");
	doc.text("We thank for your enquiry and have pleasure in submitting our quotation as below  for you kind consideration.", 9, YAfterContactPerson + 5);
				        
	// shipping address box position
	const boxX = 105;
	const boxY = 48;
	const boxWidth = 101.5;
	
	// Font settings
	doc.setFont("helvetica", "bold");
	doc.setFontSize(10);
	
	// ------------------ Address ------------------
	let addressLabell = "Address ";
	//doc.text(addressLabell, 110, 65);
	let addressLabelWidthh = doc.getTextWidth(addressLabell);
	doc.setFont("helvetica", "normal");
	
	let addressTextt = document.getElementById("deliveryAddress").value;
	let maxWidthh = 60;
	let addressLiness = doc.splitTextToSize(addressTextt, maxWidthh);
	let addressXx = 110 + addressLabelWidthh + 16;
	let addressYy = 65;
	
	//let lineHeight1 = 5;
	/* for (let i = 0; i < addressLiness.length; i++) {
	    //doc.text(addressLiness[i], addressXx, addressYy);
	    addressYy += lineHeight1;
	} */
	
	 
	// ------------------ Dynamically draw the box ------------------
	// The height is from boxY to the final Y position used + padding
	const dynamicBoxHeight = (YAfterContactPerson + lineHeight1) - boxY;
	
	
	
	// doc.rect(boxX, boxY, boxWidth, dynamicBoxHeight); // 🟦 dynamic height box
		        
    //doc.setFontSize(14);
    //doc.rect(3, emailY + 25, 203.5, 10);        
   // doc.text("Product Details", 107, emailY + 30, { align: "center" }  );
    
    const headers = [
        "S.No", "Part Number", "HSN Code", "Description",
        "Quantity", "Price", "Total"
    ];

 // Fetch table data and fix row count to 5
    let tableData = [];
    let rowIndex = 1;

    document.querySelectorAll("#productTableBody tr").forEach((row, idx) => {
        if (idx < 4) { // Limit to 5 rows max
            let cells = row.querySelectorAll("td");
            tableData.push([
                rowIndex.toString(),
                cells[2]?.textContent || "-", //part no
                cells[1]?.textContent || "-", //HSN No
                cells[3]?.textContent || "-",
                cells[4]?.textContent || "-",
                cells[5]?.textContent || "-" ,
                cells[6]?.textContent || "-" 
            ]);
            rowIndex++;
        }
    });
    
   // ✅ Move this before drawing the rows
    while (tableData.length < 4) {
        tableData.push([
            rowIndex.toString(), "", "", "", "", "", ""
        ]);
        rowIndex++;
    }
   
    // Define table starting position
    let startX = 3, startY = YAfterContactPerson + 10;  
    let colWidths = [10, 25, 22, 78.5, 20, 25, 23]; // Column widths
    let rowHeight = 8; // Row height
    doc.setFillColor(211, 211, 211); // Light grey background
    doc.setFont("helvetica", "bold"); // Bold text
    doc.setFontSize(11);

    // Draw table headers
    let currentX = startX;
    headers.forEach((header, index) => {
        doc.rect(currentX, startY, colWidths[index], rowHeight); // Draw cell border
        doc.text(header, currentX + colWidths[index] / 2, startY + 5, { align: 'center' });
        currentX += colWidths[index];
    });
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    
    let { total, tax, finalAmount, aggregateCgst, aggregateSgst, aggregateIgst } = calculateTotalFromTable();
    let amountInWords = numberToWords(total);
    
    	
        // Draw table rows
		let currentY = startY + rowHeight;
		let cellPadding = 2; // Padding inside the cell

		// MSPL_CONNECT(2301-1529-Admin)/src/main/resources/static/assets/font/NotoSans-Regular.ttf
		// assets/img/eye_icons.png
		doc.addFont("assets/font/NotoSans-Regular.ttf", "NotoSans", "normal");
		doc.setFont("NotoSans");
		
		tableData.forEach(row => {
		    let currentX = startX;
		    let maxRowHeight = rowHeight;

		    // Calculate row height based on content
		    let cellHeights = row.map((cell, index) => {
		        let textWithSymbol = (index === 5 || index === 6) && cell ?  "₹ " + formatNumber(cell) : cell;
		        
		        let textLines = doc.splitTextToSize(textWithSymbol, colWidths[index] - (cellPadding * 2));
		        return textLines.length * 5 + (cellPadding * 2);
		    });

		    maxRowHeight = Math.max(...cellHeights);

		    row.forEach((cell, index) => {
		    	
		        let formattedCell = (index === 5 || index === 6) && cell ? "₹ " + formatNumber(cell) : cell;

				let textLines = doc.splitTextToSize(formattedCell, colWidths[index] - (cellPadding * 2));
		        doc.rect(currentX, currentY, colWidths[index], maxRowHeight);

		        let textX = currentX + cellPadding;
		        let alignOption = "left";

		        if (index === 4) {  
		            textX = currentX + colWidths[index] / 2; // Center of the column
		            alignOption = "center";
		        }

		        if (index === 5 || index === 6) {  
		            textX = currentX + colWidths[index] - cellPadding;
		            alignOption = "right";
		        }

		        let textY = currentY + cellPadding + 3;

		        textLines.forEach((line, lineIndex) => {
		            doc.text(line, textX, textY + (lineIndex * 5), { align: alignOption });
		        });

		        currentX += colWidths[index];
		    });

		    currentY += maxRowHeight;
		});

		
		// Draw cells
		let totalColSpan = colWidths.length - 1;
		let totalLabelWidth = 0;
		for (let i = 0; i < totalColSpan; i++) {
		    totalLabelWidth += colWidths[i];
		}
		
		// ✅ Add totals row
		let totalRowY = currentY;
		let totalLabel = "Taxable Amount:";
		let totalValue = `${total}`;
		
		// Set Y position below the table
        let leftY = currentY + 5; // Add padding after the table
        let rightY = currentY; // Add padding after the table
        let bankDetailsYval = leftY - 5; // this is to start amount in worlds after bank details rec ends,
        //doc.rect(3, leftY - 5, 102, 23);     
     
        let bankText = "Bank Details";
        let bankX = 5;
        let bankY = leftY;

        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text(bankText, bankX, bankY);
        
        // Underline by drawing a line under the text
        let textWidth1 = doc.getTextWidth(bankText);
        doc.setLineWidth(0.5); // optional: set thickness of underline
        doc.line(bankX, bankY + 1, bankX + textWidth1, bankY + 1);
        
        leftY += 5
        doc.setFont("helvetica", "normal");
        doc.text("Bank Name: HDFC Bank", 5, leftY);
        leftY += 5
        doc.text("Branch Name:BANGALORE - SESHADRIPURAM", 5, leftY);
        leftY += 5
        doc.text("Bank Account Number: 03677630001106", 5, leftY);
        leftY += 5
        doc.text("Bank IFSC Code: HDFC0000367", 5, leftY);
        
		// Label cell (spans multiple columns)
		//doc.rect(startX, totalRowY, totalLabelWidth, rowHeight);
		doc.text(totalLabel, startX + totalLabelWidth , totalRowY + 5, { align: 'right' });
		
		// Value cell
		//doc.rect(startX + totalLabelWidth, totalRowY, colWidths[colWidths.length - 1], rowHeight);
		// Value cell - RIGHT aligned
		let totalColWidth = colWidths[colWidths.length - 2];
		let totalColRightX = startX + totalLabelWidth + totalColWidth - 5;
		//let totalamouttextWidth = doc.textWidth(totalValue);
		
		doc.setFont("NotoSans");			
		doc.text(`₹ ${totalValue}`, totalColRightX, totalRowY + 5, { align: 'right' });
		
		
		doc.setFont("helvetica", "normal");
		doc.setLineWidth(0.2);
		// doc.rect(105, rightY, 101.5, 23);   
		
		/* 
		if(`${aggregateCgst}` > 0){		
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let aggregateCgsttLabel = "Added CGST:";
			let aggregateCgsttValue = `${aggregateCgst}`;
			
			// Extra row - Label cell (merged columns)
			doc.text(aggregateCgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
	  		
			// Extra row - Value cell (last column)
			// Adjust the X position accordingly
			doc.text(aggregateCgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
        }
		if(`${aggregateSgst}` > 0){	
			
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let aggregateSgsttLabel = "Added SGST:";
			let aggregateSgsttValue = `${aggregateSgst}`;
			
			// Extra row - Label cell (merged columns)
			doc.text(aggregateSgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
	  		
			// Adjust the X position accordingly
			doc.text(aggregateSgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
			
        }
	
		if(`${aggregateIgst}` > 0){
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let aggregateIgstLabel = "Added IGST:";
			let aggregateIgstValue = `${aggregateIgst}`;
			
			// Extra row - Label cell (merged columns)
			doc.text(aggregateIgstLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
	  		
			// Extra row - Value cell (last column)
			// Adjust the X position accordingly
			doc.text(aggregateIgstValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
			
		}
		 */
		// Move Y for next content
		currentY += 5;
		// Define labels and values for the new row
		let totalAmountAfterTaxtLabel = "Total Amount After Tax:";
		let totalAmountAfterTaxValue = `${total}`;
		
		// Extra row - Label cell (merged columns)
		doc.setFont("helvetica", "bold");
		//doc.text(totalAmountAfterTaxtLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		
		// Adjust the X position accordingly
		// doc.text(totalAmountAfterTaxValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
		// Move Y for next content
		currentY += 5;
		// Move Y for next content
		currentY += 5;
		
		
		// Move Y for next content
		currentY += 5;
		// Track the Y position for the "Total in Words" section
		//let totalInWordsYStart = currentY;  
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		doc.setLineWidth(0.2); // Reset to default line thickness before drawing the final box
		
		// Draw the rectangle for total in words
		const totalInWordsHeight = 8;
		doc.rect(3, 27 + bankDetailsYval, 203.5, totalInWordsHeight); // rec start from banckdedetailsYstartFrom + height of the rect
		
		// Draw the text inside the box (vertically center text)
		const textY = 27 + bankDetailsYval + totalInWordsHeight / 2 + 1.5; // +2 for visual alignment
		doc.text(`Total in Words: ${amountInWords}`, 105, textY, { align: "center" });
    
    let termsAndConYAxis = 23 + bankDetailsYval + 17; // height of bank details rec + bankDetails rec Y axis start position + gap between ampunt in words and terms and condistions

    //doc.setFont("helvetica", "bold");
    //doc.setFontSize(10);
    //doc.setMarginTop(20);
    //doc.text(`Terms And Condition:`, 5, termsAndConYAxis);
    
    // Set bold font
	doc.setFont("helvetica", "bold");
	doc.setFontSize(10);
	 

	// Get text from textarea
	let termsTextRaw = $('#terms_and_condition').val().trim();
	
	let currentLine = "";
	let indentX = 5; // Default indentation
	let paragraphSpacing = 4; // Line spacing

	let maxWidth1 = 195; // Reduce max width for wrapping text (adjusted from 170 to 150)

	// Split by new lines and wrap the text
	let termsLines = doc.splitTextToSize(termsTextRaw, maxWidth1);
	
	// Set font for title
	doc.setFont("helvetica", "bold");
	doc.setFontSize(10);
	doc.text("Terms And Condition:", 5, termsAndConYAxis);

	// Underline the title
	const titleWidth = doc.getTextWidth("Terms And Condition:");
	doc.setLineWidth(0.3);
	doc.line(5, termsAndConYAxis + 1, 5 + titleWidth, termsAndConYAxis + 1);

	termsAndConYAxis += 6; // Move to next line after title

	// Set normal font for content
	doc.setFont("helvetica", "normal");
	

	termsLines.forEach((line, index) => {
	    let trimmedLine = line.trim();
	    let wrappedText = doc.splitTextToSize(trimmedLine, maxWidth1);

	    // Check if the line starts with a number (new main point)
	    if (/^\d+\./.test(trimmedLine)) {
	        if (currentLine !== "") {
	            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
	            wrappedCurrent.forEach((text, i) => {
	                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
	                termsAndConYAxis += paragraphSpacing;
	            });
	        }
	        currentLine = trimmedLine;
	        indentX = 5; // Reset indentation for main points
	    } 
	    // Check if line starts with a sub-point (e.g., "i)", "ii)")
	    else if (/^\s*[a-z]+\)/.test(trimmedLine)) {
	        if (currentLine !== "") {
	            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
	            wrappedCurrent.forEach((text, i) => {
	                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
	                termsAndConYAxis += paragraphSpacing;
	            });
	        }
	        indentX = 10; // Set indentation for sub-points
	        currentLine = trimmedLine;
	    } 
	    // Otherwise, it's a continuation of the same point
	    else {
	        currentLine += " " + trimmedLine;
	    }

	    // If it's the last line, print it
	    if (index === termsLines.length - 1) {
	        let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
	        wrappedCurrent.forEach((text, i) => {
	            doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis);
	            termsAndConYAxis += paragraphSpacing;
	        });
	    }
	});


	// Save the document
	//doc.save("TermsAndConditions.pdf");

	
	
	
	 
    doc.setFontSize(8);
    //doc.setTextColor(100); // Optional: subtle gray
    doc.text("*This is a computer-generated quotation, no seal and signature required", 105, 292, { align: "center" });
    
    //};

    // Convert PDF to Blob
    const pdfBlob = new Blob([doc.output("arraybuffer")], { type: "application/pdf" });

    const formData = new FormData();
    formData.append("from", fromAddress);
    formData.append("to", toAddress);
    formData.append("cc", ccAddress);
    formData.append("subject", subjectName);
    formData.append("message", bodyContent);
    formData.append("password", enteredPaswword);
    formData.append("file", pdfBlob, "Quotation.pdf"); // Append blob with filename
    formData.append("quotationId", quotationId);

    $.ajax({
        type: "POST",
        url: "/sendEmailToTheCustomerWithAttachment",
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            //alert(response);
            hideLoadingPopup();
            closeSendEmailForCustomerOuterDiv();
            $('#email_send_button').text("Email Sent to Customer");
            $('#quotationReviewApproveBtn').text("Email Sent to Customer");
            Swal.fire({ icon: 'success', title: "Delivered", text: response });
        },
        error: function(xhr) {
            alert("Error: " + xhr.responseText);
            hideLoadingPopup();
        }
    });
}

document.getElementById("emailManuallySentCheckBox").addEventListener("change", function () {
    let quotationId = $('#qid').val();
    let isChecked = this.checked; // Store the checked state before the AJAX call

    $.ajax({
        url: '/retrieveEmailSentFlagStatusValue',
        type: 'GET',
        data: { quotationId: quotationId },
        contentType: 'application/json', // Specify content type
        success: function (data) {
            if (data !== "1") {
                let emailStatusFlag = isChecked ? "2" : "0"; // Determine flag based on checkbox state

                $.ajax({
                    type: "POST",
                    url: "/updateEmailSentMailStatusForManuallySentByTheAdmin",
                    data: {
                        emailStatusFlag: emailStatusFlag,
                        quotationId: quotationId
                    },
                    success: function (response) {
                        console.log(response);
                    },
                    error: function (xhr) {
                        alert("Error: " + xhr.responseText);
                    }
                });
                
                if(emailStatusFlag === "0"){
                	$('#email_send_button').text("Send");
                    $('#email_send_button').prop("disabled", false);
                    $('#email_send_button').text("Send");
                    $('#downloadPdfManuallyBtn').css("display", "none");
                    $('#quotationReviewApproveBtn').text("Approve");
                }else{
                	$('#email_send_button').text("Sent");
                    $('#email_send_button').prop("disabled", true);
                    $('#email_send_button').text("Manually Sent");
                    $('#downloadPdfManuallyBtn').css("display", "block");
                    $('#quotationReviewApproveBtn').text("Manually Sent");
                }                	
            } else {
                $('#emailManuallySentCheckBox').prop("checked", false);
                $('#email_send_button').text("Send");
                $('#email_send_button').prop("disabled", false);
                alert("The email has already been sent to the customer using the send button!");
            }
        },
        error: function (xhr, status, error) {
            console.error('Failed to get email sent status flag:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
});
</script>



<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->
<script src="/assets/js/jspdf.umd.min.js"></script>

<script>
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        var rawDateTime = document.getElementById("qdateTime").value;
        
        // Draw Page Border
        doc.setDrawColor(0); // Black Border
        //doc.rect(3, 3, 203.5, 330); // (x, y, width, height)
        doc.rect(3, 3, 203.5, 291); // 297 - 6 for padding

        let mainY = 33;
     	// ✅ HEADER BAR
       	doc.setDrawColor(0); // Black border
        doc.rect(3, 3, 203.5, mainY); // Header box

        // ✅ Add Company Address (Left Side)
        doc.setTextColor(0); // Black text
        doc.setFont("helvictica","bold");
        doc.setFontSize(12);
        doc.text("Melange Systems Private Limited", 7, 10);
        doc.setFontSize(10);
        
        doc.setFont("helvictica","normal");

        doc.setFontSize(10);
        doc.text("(ISO 9001:2015 Certified Company)", 7, 15);
        
        doc.text("4/1, 7th cross, Kumara Park West, Bangalore, Karnataka - 560020", 7, 20);
        //doc.text("Bangalore, Karnataka - 560020", 10,18.5);
        doc.text("Phone: +91 8023561023", 7, 25);
        
        doc.setFont("helvetica", "bold");
        doc.text("GSTIN: 29AACCM4737H1ZA", 7,30, );
        
        doc.text("Udyan Ref No: UDYAM-KR-03-0101576", 7, 35, );
        doc.setFont("helvetica", "normal");
        // ✅ Add Company Logo (Right Side)
       	let logo = new Image();
        logo.src = "/assets/img/logo.png";
        
        logo.onload = function () {
        doc.addImage(logo, "PNG", 150, 10, 50, 18); // (image, type, x, y, width, height)        

        // Title
        doc.setFontSize(16);

	     // Draw the centered text
	     let title = "QUOTE";
	     let centerX = 105;
	     let textY1 = mainY + 10;
	     doc.setFont("helvetica", "bold"); 
	     doc.text(title, centerX, textY1, { align: "center" });
	
	     // Measure the width of the text
	     let textWidth2 = doc.getTextWidth(title);
	
	     // Draw underline manually (a horizontal line below the text)
	     let underlineY = textY1 + 1; // slightly below the text
	     doc.line(centerX - textWidth2 / 2, underlineY, centerX + textWidth2 / 2, underlineY);

        
        
        
        // doc.setFont("helvetica", "normal");
        //doc.rect(3, 28, 203.5, 10); // Horizontal Line
        
        
        
        // quotation Id dddaaaattteee 
        doc.setFontSize(12);
        //doc.rect(3, 38, 203.5, 10);
        
        doc.text("To,", 7, mainY + 15);
        mainY += 10
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal"); 
        doc.text(document.getElementById("qid").value, 160, mainY + 7);
        
        
        if (rawDateTime) {
            var date = new Date(rawDateTime);
            var day = String(date.getDate()).padStart(2, '0');
            var month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based
            var year = date.getFullYear();
            var formattedDate = `${day}-${month}-${year}`;

            doc.text(formattedDate, 160, mainY + 12);
        }  
        
        //doc.rect(3, 38, 203.5, 60); // Horizontal Line
        //doc.line(105, 48, 105, 98); 
        
        doc.setFont("helvetica", "bold");
        //doc.text("Billing Address", 10, 54  ); 
        //doc.text("Shipping Address", 129, 54  );  
        //doc.rect(3, 48, 102, 10);  // Left Header Box
        //doc.rect(105, 48, 101.5, 10); // Right Header Box
        
        doc.setFont("helvetica", "bold"); 
        doc.setFontSize(10);
		
        let billingAndShippengAddY = mainY + 12;
        
        // Billing Address Section
        // ✅ M/S (Bold) + Vendor Name (Normal) on the Same Line
        let msLabel = document.getElementById("company_honorifics").value;
        
        doc.setFont("helvetica", "bold");
        doc.text(msLabel, 12, billingAndShippengAddY);
        let msLabelWidth = doc.getTextWidth(msLabel);
        doc.setFont("helvetica", "bold");
        doc.text(document.getElementById("vendorlegalNamee").value, msLabelWidth + 12, billingAndShippengAddY); 
		
        
        
        // ✅ Address (Bold) + Address Text (Normal, Wrapped Properly)
        doc.setFont("helvetica", "bold");
        let addressLabel = "Address ";
        //doc.text(addressLabel, 10, billingAndShippengAddY + 6);
        let addressLabelWidth = doc.getTextWidth(addressLabel);
        doc.setFont("helvetica", "normal");

        let addressText = document.getElementById("shipmentAddress").value;
        let maxWidth = 65;
        let addressLines = doc.splitTextToSize(addressText, maxWidth);
        let addressX = addressLabelWidth;
        let addressY = billingAndShippengAddY + 6;

        // Print wrapped address lines
        let lineHeight = 5; // Adjust if your font size changes
        for (let i = 0; i < addressLines.length; i++) {
            doc.text(addressLines[i], addressX - 3, addressY + (i * lineHeight));
        }  

        // ✅ Dynamically Position GSTIN After Address
        let gstY = addressY + (addressLines.length * lineHeight) + 1; // Extra 5px padding after address
        doc.setFont("helvetica"); 
        let gstLabel = "GSTIN";
        //doc.text(gstLabel, 15, gstY);
        
        doc.text(`GSTIN ${document.getElementById("gstnumberr").value}`, 12, gstY);
        
        let gstLabelWidth = doc.getTextWidth(gstLabel);
        doc.setFont("helvetica", "normal");
        //doc.text(document.getElementById("gstnumberr").value, 10 + gstLabelWidth + 9.5, gstY);
        
        let lineHeight1 = 5;
        
        // ------------------ Contact Person ------------------ 
		let contactY = gstY + 2;
		let msLabell = "Contact Person ";
		let contactName = document.getElementById("personName").value;
		let contactDetailsX = 7;
		
		doc.setFont("helvetica","bold");
		doc.text(`Contact Details:`, contactDetailsX, contactY + 5);
		
		
		//contact name
		let contactDetailsTextWidth = doc.getTextWidth("Contact Details");
		let honorificForContactPerson = document.getElementById("contact_person_honorifics").value;
		//contactDetailsX += contactDetailsTextWidth;
		doc.setFont("helvetica", "normal");
		doc.text(honorificForContactPerson + " " +contactName,contactDetailsX + contactDetailsTextWidth + 2,contactY + 5);
		
		// Get the width of the contactName text
		let contactNameAndHonor = honorificForContactPerson + " " +contactName;
		let contactPersonTextWidth = doc.getTextWidth(contactNameAndHonor);		
		doc.setFont("helvetica", "bold");
		doc.text("|",  contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 3,contactY + 5);
		
		// contact person mobile no
		doc.setFont("helvetica", "normal");
		let mobilNo = document.getElementById("contactDetails").value;
		doc.text(mobilNo,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + 6,contactY + 5);
		
		let ContactPersonmobilNoTextWidth = doc.getTextWidth(mobilNo); 
		doc.setFont("helvetica", "bold");
		doc.text("|", contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 9,contactY + 5);
		
		//email Id
		let email = document.getElementById("emailId").value;
		doc.setFont("helvetica", "normal");
		doc.text(email ,contactDetailsX + contactDetailsTextWidth + contactPersonTextWidth + ContactPersonmobilNoTextWidth + 12,contactY + 5);
		
		let msLabelWidthh = doc.getTextWidth(msLabell);
		doc.setFont("helvetica", "normal");
		// doc.text(document.getElementById("personName").value, 15 + msLabelWidthh + 5, contactY);
		
		// ------------------ Mobile Number ------------------
		let mobileY = contactY + lineHeight1;
		doc.setFont("helvetica");
		let gstLabell = "Mobile Number ";
		//doc.text(`Mobile Number :${document.getElementById("contactDetails").value}`, 7, mobileY + 5);
		let gstLabelWidthh = doc.getTextWidth(gstLabell);
		doc.setFont("helvetica", "normal");
		//doc.text(document.getElementById("contactDetails").value, 15 + gstLabelWidthh + 5, mobileY);
		
		// ------------------ Email ID ------------------
		
		doc.setFont("helvetica");
		let gstLabelll = "Email ID ";
		//doc.text(`Email ID            :${document.getElementById("emailId").value}`, 7, emailY + 5);
		let gstLabelWidthhh = doc.getTextWidth(gstLabelll);
		doc.setFont("helvetica", "normal");
		//doc.text(document.getElementById("emailId").value, 15 + gstLabelWidthhh + 17, emailY);
        
		
		// dear sir / madam
		//let Y = contactY + 10;
		let YAfterContactPerson = contactY + 13;
		doc.setFont("helvetica","bold");
		doc.text("Dear Sir / Madam", 7,YAfterContactPerson);
		doc.setFont("helvetica","normal");
		doc.text("We thank for your enquiry and have pleasure in submitting our quotation as below  for you kind consideration.", 9, YAfterContactPerson + 5);
					        
		// shipping address box position
		const boxX = 105;
		const boxY = 48;
		const boxWidth = 101.5;
		
		// Font settings
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		
		// ------------------ Address ------------------
		let addressLabell = "Address ";
		//doc.text(addressLabell, 110, 65);
		let addressLabelWidthh = doc.getTextWidth(addressLabell);
		doc.setFont("helvetica", "normal");
		
		let addressTextt = document.getElementById("deliveryAddress").value;
		let maxWidthh = 60;
		let addressLiness = doc.splitTextToSize(addressTextt, maxWidthh);
		let addressXx = 110 + addressLabelWidthh + 16;
		let addressYy = 65;
		
		//let lineHeight1 = 5;
		/* for (let i = 0; i < addressLiness.length; i++) {
		    //doc.text(addressLiness[i], addressXx, addressYy);
		    addressYy += lineHeight1;
		} */
		
		 
		// ------------------ Dynamically draw the box ------------------
		// The height is from boxY to the final Y position used + padding
		const dynamicBoxHeight = (YAfterContactPerson + lineHeight1) - boxY;
		
		
		
		// doc.rect(boxX, boxY, boxWidth, dynamicBoxHeight); // 🟦 dynamic height box
			        
        //doc.setFontSize(14);
        //doc.rect(3, emailY + 25, 203.5, 10);        
       // doc.text("Product Details", 107, emailY + 30, { align: "center" }  );
        
        const headers = [
            "S.No", "Part Number", "HSN Code", "Description",
            "Quantity", "Price", "Total"
        ];

     // Fetch table data and fix row count to 5
        let tableData = [];
        let rowIndex = 1;

        document.querySelectorAll("#productTableBody tr").forEach((row, idx) => {
            if (idx < 4) { // Limit to 5 rows max
                let cells = row.querySelectorAll("td");
                tableData.push([
                    rowIndex.toString(),
                    cells[2]?.textContent || "-", //part no
                    cells[1]?.textContent || "-", //HSN No
                    cells[3]?.textContent || "-",
                    cells[4]?.textContent || "-",
                    cells[5]?.textContent || "-" ,
                    cells[6]?.textContent || "-" 
                ]);
                rowIndex++;
            }
        });
        
       // ✅ Move this before drawing the rows
        while (tableData.length < 4) {
            tableData.push([
                rowIndex.toString(), "", "", "", "", "", ""
            ]);
            rowIndex++;
        }
       
        // Define table starting position
        let startX = 3, startY = YAfterContactPerson + 10;  
        let colWidths = [10, 25, 22, 78.5, 20, 25, 23]; // Column widths
        let rowHeight = 8; // Row height
        doc.setFillColor(211, 211, 211); // Light grey background
        doc.setFont("helvetica", "bold"); // Bold text
        doc.setFontSize(11);

        // Draw table headers
        let currentX = startX;
        headers.forEach((header, index) => {
            doc.rect(currentX, startY, colWidths[index], rowHeight); // Draw cell border
            doc.text(header, currentX + colWidths[index] / 2, startY + 5, { align: 'center' });
            currentX += colWidths[index];
        });
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        
        let { total, tax, finalAmount, aggregateCgst, aggregateSgst, aggregateIgst } = calculateTotalFromTable();
        let amountInWords = numberToWords(total);
        
        	
            // Draw table rows
			let currentY = startY + rowHeight;
			let cellPadding = 2; // Padding inside the cell

			// MSPL_CONNECT(2301-1529-Admin)/src/main/resources/static/assets/font/NotoSans-Regular.ttf
			// assets/img/eye_icons.png
			doc.addFont("assets/font/NotoSans-Regular.ttf", "NotoSans", "normal");
			doc.setFont("NotoSans");
			
			tableData.forEach(row => {
			    let currentX = startX;
			    let maxRowHeight = rowHeight;

			    // Calculate row height based on content
			    let cellHeights = row.map((cell, index) => {
			        let textWithSymbol = (index === 5 || index === 6) && cell ?  "₹ " + formatNumber(cell) : cell;
			        
			        let textLines = doc.splitTextToSize(textWithSymbol, colWidths[index] - (cellPadding * 2));
			        return textLines.length * 5 + (cellPadding * 2);
			    });

			    maxRowHeight = Math.max(...cellHeights);

			    row.forEach((cell, index) => {
			    	
			        let formattedCell = (index === 5 || index === 6) && cell ? "₹ " + formatNumber(cell) : cell;

					let textLines = doc.splitTextToSize(formattedCell, colWidths[index] - (cellPadding * 2));
			        doc.rect(currentX, currentY, colWidths[index], maxRowHeight);

			        let textX = currentX + cellPadding;
			        let alignOption = "left";

			        if (index === 4) {  
			            textX = currentX + colWidths[index] / 2; // Center of the column
			            alignOption = "center";
			        }

			        if (index === 5 || index === 6) {  
			            textX = currentX + colWidths[index] - cellPadding;
			            alignOption = "right";
			        }

			        let textY = currentY + cellPadding + 3;

			        textLines.forEach((line, lineIndex) => {
			            doc.text(line, textX, textY + (lineIndex * 5), { align: alignOption });
			        });

			        currentX += colWidths[index];
			    });

			    currentY += maxRowHeight;
			});

			
			// Draw cells
			let totalColSpan = colWidths.length - 1;
			let totalLabelWidth = 0;
			for (let i = 0; i < totalColSpan; i++) {
			    totalLabelWidth += colWidths[i];
			}
			
			// ✅ Add totals row
			let totalRowY = currentY;
			let totalLabel = "Taxable Amount:";
			let totalValue = `${total}`;
			
			// Set Y position below the table
	        let leftY = currentY + 5; // Add padding after the table
	        let rightY = currentY; // Add padding after the table
	        let bankDetailsYval = leftY - 5; // this is to start amount in worlds after bank details rec ends,
	        //doc.rect(3, leftY - 5, 102, 23);     
	     
	        let bankText = "Bank Details";
	        let bankX = 5;
	        let bankY = leftY;

	        doc.setFontSize(10);
	        doc.setFont("helvetica", "bold");
	        doc.text(bankText, bankX, bankY);
	        
	        // Underline by drawing a line under the text
	        let textWidth1 = doc.getTextWidth(bankText);
	        doc.setLineWidth(0.5); // optional: set thickness of underline
	        doc.line(bankX, bankY + 1, bankX + textWidth1, bankY + 1);
	        
	        leftY += 5
	        doc.setFont("helvetica", "normal");
	        doc.text("Bank Name: HDFC Bank", 5, leftY);
	        leftY += 5
	        doc.text("Branch Name:BANGALORE - SESHADRIPURAM", 5, leftY);
	        leftY += 5
	        doc.text("Bank Account Number: 03677630001106", 5, leftY);
	        leftY += 5
	        doc.text("Bank IFSC Code: HDFC0000367", 5, leftY);
	        
			// Label cell (spans multiple columns)
			//doc.rect(startX, totalRowY, totalLabelWidth, rowHeight);
			doc.text(totalLabel, startX + totalLabelWidth , totalRowY + 5, { align: 'right' });
			
			// Value cell
			//doc.rect(startX + totalLabelWidth, totalRowY, colWidths[colWidths.length - 1], rowHeight);
			// Value cell - RIGHT aligned
			let totalColWidth = colWidths[colWidths.length - 2];
			let totalColRightX = startX + totalLabelWidth + totalColWidth - 5;
			//let totalamouttextWidth = doc.textWidth(totalValue);
			
			doc.setFont("NotoSans");			
			doc.text(`₹ ${totalValue}`, totalColRightX, totalRowY + 5, { align: 'right' });
			
			
			doc.setFont("helvetica", "normal");
			doc.setLineWidth(0.2);
			// doc.rect(105, rightY, 101.5, 23);   
			
			/* 
			if(`${aggregateCgst}` > 0){		
				// Move Y for next content
				currentY += 5;
				// Define labels and values for the new row
				let aggregateCgsttLabel = "Added CGST:";
				let aggregateCgsttValue = `${aggregateCgst}`;
				
				// Extra row - Label cell (merged columns)
				doc.text(aggregateCgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		  		
				// Extra row - Value cell (last column)
				// Adjust the X position accordingly
				doc.text(aggregateCgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
	        }
			if(`${aggregateSgst}` > 0){	
				
				// Move Y for next content
				currentY += 5;
				// Define labels and values for the new row
				let aggregateSgsttLabel = "Added SGST:";
				let aggregateSgsttValue = `${aggregateSgst}`;
				
				// Extra row - Label cell (merged columns)
				doc.text(aggregateSgsttLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		  		
				// Adjust the X position accordingly
				doc.text(aggregateSgsttValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
				
	        }
		
			if(`${aggregateIgst}` > 0){
				// Move Y for next content
				currentY += 5;
				// Define labels and values for the new row
				let aggregateIgstLabel = "Added IGST:";
				let aggregateIgstValue = `${aggregateIgst}`;
				
				// Extra row - Label cell (merged columns)
				doc.text(aggregateIgstLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
		  		
				// Extra row - Value cell (last column)
				// Adjust the X position accordingly
				doc.text(aggregateIgstValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
				
			}
			 */
			// Move Y for next content
			currentY += 5;
			// Define labels and values for the new row
			let totalAmountAfterTaxtLabel = "Total Amount After Tax:";
			let totalAmountAfterTaxValue = `${total}`;
			
			// Extra row - Label cell (merged columns)
			doc.setFont("helvetica", "bold");
			//doc.text(totalAmountAfterTaxtLabel, startX + totalLabelWidth - 2, currentY + 5, { align: 'right' });
			
			// Adjust the X position accordingly
			// doc.text(totalAmountAfterTaxValue, startX + totalLabelWidth + totalColWidth - 2, currentY + 5,{ align: 'right' });
			// Move Y for next content
			currentY += 5;
			// Move Y for next content
			currentY += 5;
			
			
			// Move Y for next content
			currentY += 5;
			// Track the Y position for the "Total in Words" section
			//let totalInWordsYStart = currentY;  
			doc.setFont("helvetica", "bold");
			doc.setFontSize(10);
			doc.setLineWidth(0.2); // Reset to default line thickness before drawing the final box
			
			// Draw the rectangle for total in words
			const totalInWordsHeight = 8;
			doc.rect(3, 27 + bankDetailsYval, 203.5, totalInWordsHeight); // rec start from banckdedetailsYstartFrom + height of the rect
			
			// Draw the text inside the box (vertically center text)
			const textY = 27 + bankDetailsYval + totalInWordsHeight / 2 + 1.5; // +2 for visual alignment
			doc.text(`Total in Words: ${amountInWords}`, 105, textY, { align: "center" });
        
        let termsAndConYAxis = 23 + bankDetailsYval + 17; // height of bank details rec + bankDetails rec Y axis start position + gap between ampunt in words and terms and condistions

        //doc.setFont("helvetica", "bold");
        //doc.setFontSize(10);
        //doc.setMarginTop(20);
        //doc.text(`Terms And Condition:`, 5, termsAndConYAxis);
        
        // Set bold font
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		 

		// Get text from textarea
		let termsTextRaw = $('#terms_and_condition').val().trim();
		
		let currentLine = "";
		let indentX = 5; // Default indentation
		let paragraphSpacing = 4; // Line spacing

		let maxWidth1 = 195; // Reduce max width for wrapping text (adjusted from 170 to 150)

		// Split by new lines and wrap the text
		let termsLines = doc.splitTextToSize(termsTextRaw, maxWidth1);
		
		// Set font for title
		doc.setFont("helvetica", "bold");
		doc.setFontSize(10);
		doc.text("Terms And Condition:", 5, termsAndConYAxis);

		// Underline the title
		const titleWidth = doc.getTextWidth("Terms And Condition:");
		doc.setLineWidth(0.3);
		doc.line(5, termsAndConYAxis + 1, 5 + titleWidth, termsAndConYAxis + 1);

		termsAndConYAxis += 6; // Move to next line after title

		// Set normal font for content
		doc.setFont("helvetica", "normal");
		

		termsLines.forEach((line, index) => {
		    let trimmedLine = line.trim();
		    let wrappedText = doc.splitTextToSize(trimmedLine, maxWidth1);

		    // Check if the line starts with a number (new main point)
		    if (/^\d+\./.test(trimmedLine)) {
		        if (currentLine !== "") {
		            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
		            wrappedCurrent.forEach((text, i) => {
		                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
		                termsAndConYAxis += paragraphSpacing;
		            });
		        }
		        currentLine = trimmedLine;
		        indentX = 5; // Reset indentation for main points
		    } 
		    // Check if line starts with a sub-point (e.g., "i)", "ii)")
		    else if (/^\s*[a-z]+\)/.test(trimmedLine)) {
		        if (currentLine !== "") {
		            let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
		            wrappedCurrent.forEach((text, i) => {
		                doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis); // Indent wrapped lines
		                termsAndConYAxis += paragraphSpacing;
		            });
		        }
		        indentX = 10; // Set indentation for sub-points
		        currentLine = trimmedLine;
		    } 
		    // Otherwise, it's a continuation of the same point
		    else {
		        currentLine += " " + trimmedLine;
		    }

		    // If it's the last line, print it
		    if (index === termsLines.length - 1) {
		        let wrappedCurrent = doc.splitTextToSize(currentLine.trim(), maxWidth1);
		        wrappedCurrent.forEach((text, i) => {
		            doc.text(text, i === 0 ? indentX : indentX + 5, termsAndConYAxis);
		            termsAndConYAxis += paragraphSpacing;
		        });
		    }
		});


		// Save the document
		//doc.save("TermsAndConditions.pdf");

		
		
		
		 
        doc.setFontSize(8);
        //doc.setTextColor(100); // Optional: subtle gray
        doc.text("*This is a computer-generated quotation, no seal and signature required", 105, 292, { align: "center" });

        // Save PDF
        doc.save("Quotation.pdf");
        };
    }
    function formatNumber(num) {
        if (!isNaN(num)) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        return num;  // Return as-is if it's not a number.
    }

 	// Function to calculate total and tax from table data
    function calculateTotalFromTable() {
    let totalSum = 0;
    let aggregateCgst = 0;
    let aggregateSgst = 0;
    let aggregateIgst = 0;
    let taxSum = 0;

    document.querySelectorAll(".hiddenProductDetailsTableBoxData tbody tr").forEach(row => {
        let total = parseFloat(row.children[4].innerText) || 0;
        let cgst = parseFloat(row.children[5].innerText) || 0;
        let sgst = parseFloat(row.children[6].innerText) || 0;
        let igst = parseFloat(row.children[7].innerText) || 0;

        console.log("total == " + total.toFixed(2));
        console.log("cgst == " + cgst.toFixed(2));
        console.log("sgst == " + sgst.toFixed(2));
        console.log("igst == " + igst.toFixed(2));

        // **Ensure decimal precision using precise addition**
        totalSum = (totalSum + total);

        console.log("totalSum == " + totalSum.toFixed(2));

        if (cgst === 0 && sgst === 0) {
            aggregateIgst = (aggregateIgst + igst);
            console.log("aggregateIgst == " + aggregateIgst.toFixed(2));

            taxSum = (taxSum + igst);
            console.log("taxSum == " + taxSum.toFixed(2));
        } else if (igst === 0) {
            aggregateCgst = (aggregateCgst + cgst);
            aggregateSgst = (aggregateSgst + sgst);

            console.log("aggregateCgst == " + aggregateCgst.toFixed(2));
            console.log("aggregateSgst == " + aggregateSgst.toFixed(2));

            taxSum = (taxSum + cgst + sgst);
            console.log("taxSum == " + taxSum.toFixed(2));
        }
    });

    let finalAmount = totalSum + taxSum;

    console.log("finalAmount == " + finalAmount.toFixed(2));

    return { 
        total: totalSum.toFixed(2), 
        tax: taxSum.toFixed(2), 
        finalAmount: finalAmount.toFixed(2), 
        aggregateCgst: aggregateCgst.toFixed(2), 
        aggregateSgst: aggregateSgst.toFixed(2), 
        aggregateIgst: aggregateIgst.toFixed(2) 
    };
}
    
    function numberToWords(num) {
        const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
        const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen",
                       "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
        const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

        function twoDigits(n) {
            if (n < 10) return ones[n];
            if (n < 20) return teens[n - 10];
            return tens[Math.floor(n / 10)] + (n % 10 ? " " + ones[n % 10] : "");
        }

        function threeDigits(n) {
            if (n < 100) return twoDigits(n);
            return ones[Math.floor(n / 100)] + " Hundred" + (n % 100 ? " " + twoDigits(n % 100) : "");
        }

        if (num === 0) return "Zero Only";

        let result = "";

        const crore = Math.floor(num / 10000000);
        num %= 10000000;
        if (crore) result += threeDigits(crore) + " Crore ";

        const lakh = Math.floor(num / 100000);
        num %= 100000;
        if (lakh) result += threeDigits(lakh) + " Lakh ";

        const thousand = Math.floor(num / 1000);
        num %= 1000;
        if (thousand) result += threeDigits(thousand) + " Thousand ";

        if (num > 0) result += (result !== "" ? "and " : "") + threeDigits(num);

        
        return result.trim() + " Only";
    }
 	
    $.ajax({
        url: '/returnRecentlyInsertedTermsAndConditionDetail',
        type: 'GET',
        contentType: 'application/json', // Specify content type
        success: function(data) {
        	$('#terms_and_condition').val(data.terms_and_condition_data);
        },
        error: function(xhr, status, error) {
            console.error('Failed to get terms and condition details:', error);
            console.error('Response text:', xhr.responseText);
        }
    });
    
    function forwardQuotationForReview(quotationId, flagStatusValue){
    	$.ajax({
            type: 'POST',
            url: '/updateReviewStatusForQuotationReview',
            data: {
                "reviewStatus": flagStatusValue,
                "quotationId": quotationId
            },
            success: function (response) {
                if (response === 'success') {
                	$('#quotationSubmitBtnForReview').text("Submitted");
                	$('#quotationSubmitBtnForReview').prop("disabled", true);
                	$('#reviseQuotationBtn').css("display", "block");
                	$('#quotationReviewApproveBtn').css("display", "block");
                	$('#quotationSubmitBtnForReview').css("display", "none");
                }
                
                if(flagStatusValue === 3){
            		$('#wonQuotationBtn').prop("disabled", true);
            		$('#terminateQuotationBtn').prop("disabled", false);
            		$('#quotationReviewApproveBtn').css("display", "none");
            		$('#reviseQuotationBtn').css("display", "none");
            		$('#quotationSubmitBtnForReview').css("display", "none");
            		$('#terminateQuotationBtn').css("display", "none");
            	}else if(flagStatusValue === 4){
            		$('#terminateQuotationBtn').prop("disabled", true);
            		$('#wonQuotationBtn').prop("disabled", false);
            		$('#quotationReviewApproveBtn').css("display", "none");
            		$('#reviseQuotationBtn').css("display", "none");
            		$('#quotationSubmitBtnForReview').css("display", "none");
            		$('#wonQuotationBtn').css("display", "none");
            	}
            },
            error: function (xhr, status, error) {
                console.error('Error updating quotation review status record:');
                console.log('XHR object:', xhr);
                console.log('Status:', status);
                console.log('Error:', error);
            }
        });    	
    }
</script>

<script>
function displayOnLoadingPopup(){
	$('#loadingPopup').show();
	$('#loadingPopupPara').text("Loading, please wait...");
}

function hideLoadingPopup(){
	$('#loadingPopup').hide();
}
</script>

<script>
let customers = [];
let selectedContacts = {}; // Stores contacts for each customer

document.addEventListener("DOMContentLoaded", function() {
    fetchCustomers();
});

function fetchCustomers() {
    fetch('/customers')
        .then(response => response.json())
        .then(data => {
            customers = data;
        })
        .catch(error => console.error('Error fetching customers:', error));
}

// Filter customer names based on input
document.getElementById("revise_vendorName").addEventListener("input", function() {
    const input = this.value.toLowerCase();
    const suggestionsBox = document.getElementById("revise_suggestionsBox");

    if (!input) {
        suggestionsBox.style.display = "none";
        return;
    }

    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(input)
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
    }

    // Store contacts globally and show suggestions
    suggestionsBox.innerHTML = filteredCustomers.map((customer, index) => {
        selectedContacts[index] = [
            { name: customer.c1, designation: customer.c11, mobile: customer.c111, email: customer.c1111, honorifics: customer.honorifics_1 },
            { name: customer.c2, designation: customer.c22, mobile: customer.c222, email: customer.c2222, honorifics: customer.honorifics_2 },
            { name: customer.c3, designation: customer.c33, mobile: customer.c333, email: customer.c3333, honorifics: customer.honorifics_3 }
        ].filter(contact => contact.name); // Remove empty contacts

        return `<div onclick="selectCustomer('${customer.name}', '${customer.legalName}', '${customer.gst}', '${customer.billing_address}', '${customer.delivery_address_1}', '${customer.delivery_address_2}', '${customer.delivery_address_3}', '${customer.honorifics_main}', '${index}')">${customer.name}</div>`;
    }).join("");

    suggestionsBox.style.display = "block";
});

// Select customer and populate fields
function selectCustomer(name, legalName, gst, billingAddresss, deliveryAddress1, deliveryAddress2, deliveryAddress3, mainHonorifics, index) {
    document.getElementById("revise_vendorName").value = name;
    document.getElementById("revise_vendorlegalNamee").value = legalName;
    document.getElementById("revise_gstnumberr").value = gst;
    document.getElementById("revise_shipmentAddress").value = billingAddresss; // Populate billing address
    document.getElementById("revise_company_honorifics").value = mainHonorifics;
    
 	// Get the dropdown element
    let deliverySelect = document.getElementById("revise_deliveryAddress");
    
    // Clear existing options
    deliverySelect.innerHTML = "<option value=''>Select Delivery Address</option>";

    // Array of delivery addresses
    let deliveryAddresses = [deliveryAddress1, deliveryAddress2, deliveryAddress3];

    // Add only non-null and non-empty addresses to the dropdown
    deliveryAddresses.forEach(address => {
        if (address && address.trim() !== "") {
            let option = document.createElement("option");
            option.value = address;
            option.textContent = address;
            deliverySelect.appendChild(option);
        }
    });

    populateContactsDropdown(selectedContacts[index]);

    document.getElementById("revise_suggestionsBox").style.display = "none";
}

// Populate contact dropdown dynamically
function populateContactsDropdown(contacts) {
    const contactDropdown = document.getElementById("revise_personName");
    contactDropdown.innerHTML = `<option value="">Select Contact Person</option>` +
        contacts.map(contact => `<option value="${contact.name}" data-designation="${contact.designation}" data-mobile="${contact.mobile}" data-email="${contact.email}" data-honorifics="${contact.honorifics}">${contact.name}</option>`).join("");
}

// Auto-fill details when selecting a contact person
document.getElementById("revise_personName").addEventListener("change", function() {
    const selectedOption = this.options[this.selectedIndex];
    
    document.getElementById("revise_deliveryAddress").value = "";

    if (selectedOption.value) {
    	document.getElementById("revise_contact_person_honorifics").value = selectedOption.dataset.honorifics;
        document.getElementById("revise_designation").value = selectedOption.dataset.designation || "";
        document.getElementById("revise_contactDetails").value = selectedOption.dataset.mobile || "";
        document.getElementById("revise_emailId").value = selectedOption.dataset.email || "";
    } else {
        clearContactFields();
    }
});

// Hide suggestions when clicking outside
document.addEventListener("click", function(event) {
    if (!event.target.closest("#revise_vendorName") && !event.target.closest("#revise_suggestionsBox")) {
        document.getElementById("revise_suggestionsBox").style.display = "none";
    }
});

// Select first suggestion on Enter
document.getElementById("revise_vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        const suggestionsBox = document.getElementById("revise_suggestionsBox");
        if (suggestionsBox.style.display === "block") {
            const firstSuggestion = suggestionsBox.querySelector("div");
            if (firstSuggestion) {
                firstSuggestion.click(); // Simulate a click on the first suggestion
                event.preventDefault(); // Prevent form submission
            }
        }
    }
});

// Clear all related fields on backspace when empty
document.getElementById("revise_vendorName").addEventListener("keydown", function(event) {
    if (event.key === "Backspace" && this.value === "") {
        clearCustomerFields();
    }
});

// Clear customer fields
function clearCustomerFields() {
    document.getElementById("revise_vendorlegalNamee").value = "";
    document.getElementById("revise_gstnumberr").value = "";
    document.getElementById("revise_shipmentAddress").value = "";
    document.getElementById("revise_personName").innerHTML = `<option value="">Select Contact Person</option>`;
    clearContactFields();
}

// Clear contact person fields
function clearContactFields() {
    document.getElementById("revise_designation").value = "";
    document.getElementById("revise_contactDetails").value = "";
    document.getElementById("revise_emailId").value = "";
    document.getElementById("revise_contact_person_honorifics").value = "";
}

function copyAddress() {
    const shipmentAddress = document.getElementById("revise_shipmentAddress").value;
    const deliveryAddress = document.getElementById("revise_deliveryAddress");
    const sameAddress = document.getElementById("revise_sameAddress");

    if (sameAddress.checked) {
        deliveryAddress.value = shipmentAddress;
        deliveryAddress.setAttribute("readonly", true);
    } else {
        deliveryAddress.value = "";
        deliveryAddress.removeAttribute("readonly");
    }
}

let productCount = 0;
const GST_PERCENTAGE = 18; // Fixed 18% GST

function addProduct() {
    productCount++;
    const tableBody = document.getElementById("revise_productTableBody");
    //tableBody.innerHTML = ""; // Clear old data
    
    // Get selected values from dropdowns
    /* const productName = document.getElementById("productName").value;
    const hsnCode = document.getElementById("hsnCode").value;
    const partNumber = document.getElementById("partNumber").value;
    const productDescription = document.getElementById("productDescription").value; */
    
    const productName = document.getElementById("productDescription").value;
    const hsnCode = document.getElementById("partNumber").value;
    const partNumber = document.getElementById("productName").value;
    const productDescription = document.getElementById("hsnCode").value;
    
    // Get checkbox elements correctly
    const interState = document.getElementById("revise_interState");
    const outerState = document.getElementById("revise_outerState");
    
    //alert("productName== "+productName+" hsnCode === "+hsnCode+" partNumber === "+partNumber+" productDescription === "+productDescription);

    // Ensure values are selected before adding
    if (!productName || !hsnCode || !partNumber || !productDescription) {
        alert("Please select all product details before adding.");
        return;
    }
    
    if (!(interState.checked) && !(outerState.checked)) {
        alert("Please select Tax Type Before Adding Products.");
        return;
    }

    // Create a new row
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${productCount}</td>
        <td style="display: none;">${productName}</td>
        <td>${hsnCode}</td>
        <td>${partNumber}</td>
        <td>${productDescription}</td>
        <td><input type="number" style="width: 70px" class="form-control quantity" oninput="calculateTotal(this)"></td>
        <td><input type="number" style="width: 70px" class="form-control price" oninput="calculateTotal(this)"></td>
        <td class="total-without-gst">0.00</td>
        <td class="cgst-value">0.00</td>
        <td class="sgst-value">0.00</td>
        <td class="igst-value">0.00</td>
        <td class="total-with-gst">0.00</td>
        <td><button class="btn btn-outline-danger btn-sm" onclick="removeProduct(this)">Remove</button></td>
    `;

    tableBody.appendChild(row);
    
    // Apply tax selection logic
    applyGSTSelection();

    // Hide IGST column immediately after adding if Interstate is selected
    const igstCell = row.querySelector(".igst-value");
    if (interState.checked) {
        igstCell.style.display = "none"; // Hide IGST
        igstCell.innerText = ""; // Remove text
    }

    // Reset dropdown selections
    document.getElementById("productName").selectedIndex = 0;
    document.getElementById("hsnCode").selectedIndex = 0;
    document.getElementById("partNumber").selectedIndex = 0;
    document.getElementById("productDescription").selectedIndex = 0;
}


function removeProduct(button) {
    button.closest("tr").remove();
    productCount--;
    updateSlNumbers();
}

function updateSlNumbers() {
    document.querySelectorAll("#revise_productTableBody tr").forEach((row, index) => {
        row.cells[0].innerText = index + 1;
    });
}

function calculateTotal(input) {
    const row = input.closest("tr");
    const quantity = parseFloat(row.querySelector(".quantity").value) || 0;
    const price = parseFloat(row.querySelector(".price").value) || 0;
    
    //alert(quantity+" "+price);
    
    let totalWithoutGST = quantity * price;
    let cgst = 0, sgst = 0, igst = 0, totalWithGST = totalWithoutGST;

    if (document.getElementById("revise_interState").checked) {
        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        totalWithGST += cgst + sgst;
        row.querySelector(".cgst-value").innerText = cgst.toFixed(2);
        row.querySelector(".sgst-value").innerText = sgst.toFixed(2);
        row.querySelector(".igst-value").innerText = "—";
    } else if (document.getElementById("revise_outerState").checked) {
        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
        totalWithGST += igst;
        row.querySelector(".cgst-value").innerText = "—";
        row.querySelector(".sgst-value").innerText = "—";
        row.querySelector(".igst-value").innerText = igst.toFixed(2);
    }

    row.querySelector(".total-without-gst").innerText = totalWithoutGST.toFixed(2);
    row.querySelector(".total-with-gst").innerText = totalWithGST.toFixed(2);
}

function calculateTotalPriceValueAndTaxCalculationForRevisedPopup(quantityData, priceData){
	//alert(quantity+" "+price);
    const quantity = parseFloat(quantityData) || 0;
    const price = parseFloat(priceData) || 0;
    
    let totalWithoutGST = quantity * price;
    let cgst = 0, sgst = 0, igst = 0, totalWithGST = totalWithoutGST;

    if (document.getElementById("revise_interState").checked) {
        cgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        sgst = (totalWithoutGST * GST_PERCENTAGE) / 200;
        totalWithGST += cgst + sgst;
        document.querySelector(".cgst-value").innerText = cgst.toFixed(2);
        document.querySelector(".sgst-value").innerText = sgst.toFixed(2);
        document.querySelector(".igst-value").innerText = "—";
    } else if (document.getElementById("revise_outerState").checked) {
        igst = (totalWithoutGST * GST_PERCENTAGE) / 100;
        totalWithGST += igst;
        document.querySelector(".cgst-value").innerText = "—";
        document.querySelector(".sgst-value").innerText = "—";
        document.querySelector(".igst-value").innerText = igst.toFixed(2);
    }

    document.querySelector(".total-without-gst").innerText = totalWithoutGST.toFixed(2);
    document.querySelector(".total-with-gst").innerText = totalWithGST.toFixed(2);
}

/* function toggleGST(type) {
    if (type === "interState") {
        document.getElementById("outerState").checked = false;
    } else {
        document.getElementById("interState").checked = false;
    }

    applyGSTSelection();
} */

function applyGSTSelection() {

    const isInterState = document.getElementById("revise_interState").checked;
    const isOuterState = document.getElementById("revise_outerState").checked;

    // Toggle visibility of header columns
    document.querySelector(".revise_cgst-header").classList.toggle("d-none", !isInterState);
    document.querySelector(".revise_sgst-header").classList.toggle("d-none", !isInterState);
    document.querySelector(".revise_igst-header").classList.toggle("d-none", !isOuterState);

    // Apply correct values and visibility to each row
    document.querySelectorAll("#revise_productTableBody tr").forEach(row => {
        const cgstCell = row.querySelector(".cgst-value");
        const sgstCell = row.querySelector(".sgst-value");
        const igstCell = row.querySelector(".igst-value");

        if (isInterState) {
            cgstCell.style.display = "";
            sgstCell.style.display = "";
            igstCell.style.display = "none"; // Hide IGST
            igstCell.innerText = ""; // Remove text
        } else if (isOuterState) {
            cgstCell.style.display = "none"; // Hide CGST
            sgstCell.style.display = "none"; // Hide SGST
            igstCell.style.display = "";
        } else {
            // If neither is selected, hide all tax columns
            cgstCell.style.display = "none";
            sgstCell.style.display = "none";
            igstCell.style.display = "none";
        }

        // Ensure tax values are recalculated
        calculateTotal(row.querySelector(".quantity"));
    });
}

let productData = []; // Store fetched data globally

document.addEventListener("DOMContentLoaded", function () {
    fetch("/product_list")
        .then(response => response.json())
        .then(data => {
            console.log("Fetched Data:", data); // Debugging
            productData = data; // Store the fetched data globally

            if (data.length > 0) {
                const productSelect = document.getElementById("productName");
                const hsnCodeSelect = document.getElementById("hsnCode");
                const partNumberSelect = document.getElementById("partNumber");
                const productDescriptionSelect = document.getElementById("productDescription");

                // Clear previous options
                productSelect.innerHTML = `<option value="">Select a Product</option>`;
                hsnCodeSelect.innerHTML = `<option value="">Select HSN Code</option>`;
                partNumberSelect.innerHTML = `<option value="">Select Part Number</option>`;
                productDescriptionSelect.innerHTML = `<option value="">Select Description</option>`;

                // Loop through data and add options for Product Name
                data.forEach(product => {
                    productSelect.innerHTML += `<option value="${product.pdescription}">${product.pdescription}</option>`;
                });

                // Add event listener to detect product selection change
              /*   productSelect.addEventListener("change", function () {
                    const selectedProduct = this.value;
                    const selectedData = productData.find(p => p.pname === selectedProduct);

                    if (selectedData) {
                        hsnCodeSelect.innerHTML = `<option value="${selectedData.hsn_code}">${selectedData.hsn_code}</option>`;
                        partNumberSelect.innerHTML = `<option value="${selectedData.part_number}">${selectedData.part_number}</option>`;
                        productDescriptionSelect.innerHTML = `<option value="${selectedData.pdescription}">${selectedData.pdescription}</option>`;
                    } else {
                        // Reset other dropdowns if no product is selected
                        hsnCodeSelect.innerHTML = `<option value="">Select HSN Code</option>`;
                        partNumberSelect.innerHTML = `<option value="">Select Part Number</option>`;
                        productDescriptionSelect.innerHTML = `<option value="">Select Description</option>`;
                    }
                }); */
                
             // Add event listener to detect product selection change
                productSelect.addEventListener("change", function () {
                    const selectedProduct = this.value;
                    const selectedData = productData.find(p => p.pdescription === selectedProduct);

                    if (selectedData) {
                        hsnCodeSelect.value = selectedData.hsn_code;
                        partNumberSelect.value = selectedData.part_number;
                        productDescriptionSelect.value = selectedData.pname;
                    } else {
                        // Reset input fields if no product is selected
                        hsnCodeSelect.value = "";
                        partNumberSelect.value = "";
                        productDescriptionSelect.value = "";
                    }
                });

            } else {
                console.log("No products found.");
            }
        })
        .catch(error => console.error("Error fetching products:", error));
});

function populateProductDetailsDataBasedOnSelectedProductNameInRevise(productName){
	const selectedProduct = productName;
    const selectedData = productData.find(p => p.pdescription === selectedProduct);
    
    const hsnCodeSelect = document.getElementById("hsnCode");
    const partNumberSelect = document.getElementById("partNumber");
    const productDescriptionSelect = document.getElementById("productDescription");

    if (selectedData) {
        hsnCodeSelect.value = selectedData.hsn_code;
        partNumberSelect.value = selectedData.part_number;
        productDescriptionSelect.value = selectedData.pname;
    } else {
        // Reset input fields if no product is selected
        hsnCodeSelect.value = "";
        partNumberSelect.value = "";
        productDescriptionSelect.value = "";
    }
}

document.addEventListener("DOMContentLoaded", function () {
    
    // Function to format date-time in dd/mm/yyyy hh:mm:ss
    function formatDisplayDateTime(date) {
        let dd = String(date.getDate()).padStart(2, '0');
        let mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        let yyyy = date.getFullYear();
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }

    // Function to format date-time for input type datetime-local
    function formatISODateTime(date) {
        let yyyy = date.getFullYear();
        let mm = String(date.getMonth() + 1).padStart(2, '0');
        let dd = String(date.getDate()).padStart(2, '0');
        let hh = String(date.getHours()).padStart(2, '0');
        let min = String(date.getMinutes()).padStart(2, '0');
        let ss = String(date.getSeconds()).padStart(2, '0');

        return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    const dateTimeInput = document.getElementById("revise_qdateTime");

    function updateDateTime() {
        let now = new Date();
        if (dateTimeInput) {
            dateTimeInput.value = formatISODateTime(now); // Update datetime-local input
            dateTimeInput.setAttribute("data-display", formatDisplayDateTime(now)); // Store formatted value
        } else {
            console.error("Date-Time input field not found");
        }
    }

    updateDateTime(); // Set initial value
    setInterval(updateDateTime, 1000); // Update every second
});

function reviseQuotation() {
    let products = [];
    $("#revise_productTableBody tr").each(function() {
        let row = $(this);
        let product = {
            productName: row.find("td:eq(1)").text().trim(),
            hsnCode: row.find("td:eq(2)").text().trim(),
            partNumber: row.find("td:eq(3)").text().trim(),
            description: row.find("td:eq(4)").text().trim(),
            quantity: parseFloat(row.find(".quantity").val()) || 0,
            price: parseFloat(row.find(".price").val()) || 0,
            taxableValue: parseFloat(row.find(".total-without-gst").text().trim()) || 0,
            cgst: parseFloat(row.find(".cgst-value").text().trim()) || 0,
            sgst: parseFloat(row.find(".sgst-value").text().trim()) || 0,
            igst: parseFloat(row.find(".igst-value").text().trim()) || 0,
            total: parseFloat(row.find(".total-with-gst").text().trim()) || 0,
            qid: $("#revise_qid").val().trim(),
        };

        // Ensure no invalid values (remove "—" which is causing backend errors)
        product.cgst = isNaN(product.cgst) ? 0 : product.cgst;
        product.sgst = isNaN(product.sgst) ? 0 : product.sgst;
        product.igst = isNaN(product.igst) ? 0 : product.igst;

       // console.log("Row Data:", product);
        products.push(product);
        
    });
    
    var taxTypeValue;
    
    let checkboxes = document.querySelectorAll('.revisetaxTypeCheckBox');
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
        	taxTypeValue = checkbox.name; // Logs the ID of the checked checkbox
        }
    });
    
    let quotationData = {
        qid: $("#revise_qid").val().trim(),
        qdateTime: $("#revise_qdateTime").val(),
        vendorName: $("#revise_vendorName").val(),
        vendorlegalName: $("#revise_vendorlegalNamee").val(),
        gstnumber: $("#revise_gstnumberr").val(),
        orderMethod: $("#revise_orderMethod").val(),
        personName: $("#revise_personName").val(),
        designation: $("#revise_designation").val(),
        contactDetails: $("#revise_contactDetails").val(),
        emailId: $("#revise_emailId").val(),
        shipmentAddress: $("#revise_shipmentAddress").val(),
        deliveryAddress: $("#revise_deliveryAddress").val(),
        taxType: taxTypeValue,
        products: products,
        honorifics1: $('#revise_company_honorifics').val(),
        honorifics2: $('#revise_contact_person_honorifics').val()
    };

    //alert("Sending Data:", JSON.stringify(quotationData));
    //console.log("Sending Data: ", quotationData); // Debugging Output
    //alert($('#terms_and_condition').val());
    
    let termsAndConditionValue = $('#revise_terms_and_condition').val() || "";  // Ensure it is not null

    $.ajax({
        type: "POST",
        url: "/reviseQuotation/save?termsAndConditionValue=" + encodeURIComponent(termsAndConditionValue),
        contentType: "application/json",
        data: JSON.stringify(quotationData),
        success: function(response) {
            alert(response);
        },
        error: function(xhr) {
            alert("Error: " + xhr.responseText);
        }
    });
}
</script>



</body>
</html>
