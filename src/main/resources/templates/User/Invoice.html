<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Invoice</title>
<!-- 
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
 -->
   <link rel="stylesheet" href="/assets/font/fonts.css">
  
  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
  
  <!--   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">
 <!--  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
  <script src="assets/js/jquery-3.6.4.min.js"></script>
	
	<!-- Add this to your <head> or before the closing </body> tag -->
	<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> -->
	<link rel="stylesheet" href="/assets/css/all.min.css">
	
	<script src="DejaVuSans-normal.js"></script>
	<!-- <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script> -->
	<script src="/assets/js/qrcode.min.js"></script>
	
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->
	<script src="/assets/js/jspdf.umd.min.js"></script>
	
    <style>
         body{
         	font-size: 14px;
         }
         .custom-modal-width {
			  max-width: 95%; /* or any desired width like 1200px, 90vw, etc. */
			  width: 95%;
			}
					 	/* Fullscreen overlay with dim background */
		#loadingPopup {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    background: rgba(0, 0, 0, 0.5); /* Dim background */
		    display: flex;
		    flex-direction: column;
		    justify-content: center;
		    align-items: center;
		    z-index: 9999;
		    font-family: Arial, sans-serif;
		    color: white; /* Text color for better contrast */
		}
		
		/* Spinner animation */
		.spinner {
		    width: 50px;
		    height: 50px;
		    border: 6px solid rgba(255, 255, 255, 0.3); /* Semi-transparent border */
		    border-top-color: white; /* Bright top border */
		    border-radius: 50%;
		    animation: spin 1s linear infinite;
		}
		
		/* Loading text */
		#loadingPopup p {
		    margin-top: 20px;
		    font-size: 18px;
		    font-weight: bold;
		    color: white;
		}
		@keyframes spin {
		    to {
		        transform: rotate(360deg);
		    }
		}
			
         
    </style>
</head>
<body>
<input type="hidden" id="loggedAdminUserType" th:value="${userType}">
<div id="loadingPopup" style="display:none">
	<div class="spinnerAndParaMerger">
	    <div class="spinner"></div>
	    <p id="loadingPopupPara"></p>
    </div>
</div> 

<!-- performa invoice modal -->
<div class="modal fade" id="performaInvoiceModal" tabindex="-1" aria-labelledby="performaInvoiceModalLabel" aria-hidden="true" data-bs-backdrop="static">
	  <div class="modal-dialog modal-xl custom-modal-width">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="performaInvoiceModalLabel">Invoice</h5>
	     
		    <button type="button" class="btn btn-outline-success" onclick="viewPI()">View Invoice</button> 
			<!-- âœ… Add DC button -->
			        <button type="button" class="btn btn-outline-primary m-2" onclick="openDcModalFromInvoice()" >
			          Add DC
			        </button>
  			<div id="approveInvoiceBtn">
	         <!-- <button type="button" class="btn btn-outline-success m-2" onclick="approvePI()" th:if="${loggedAdminDept == 84 or userType == 'admin'}">Approve Invoice</button>  -->
	         <button type="button" class="btn btn-outline-success m-2"
			        onclick="approvePI()"
			        th:if="${userType == 'Admin'}">
			    Approve Invoice
			</button>
	        	
	        </div>
	        
	        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload();" aria-label="Close"></button>
	      </div> 
	      <div class="modal-body">
	        <!-- Purchase Order Form -->
	        <form id="performaInvoiceForm"  method="post" enctype="multipart/form-data">
	        
	             
				<div class="row mb-3 justify-content-between">
				   <input type="hidden" id="approveByAc">
	               <div class="col-md-3">
				    <label class="form-label">Invoice ID</label>
				    <input type="text" class="form-control" id="pi_id" placeholder="Performa Invoice ID" disabled />
				   </div> 			
				   <div class="col-md-3">
				     <label class="form-label">Sales Order ID</label>
				     <input type="text" class="form-control" id="pi_po_id" placeholder="Performa Invoice ID" disabled />
				   </div>
				   				 
				   <div class="col-md-3">
				    <label class="form-label">Date of Supply</label>
					<input type="text" class="form-control" id="pidateTime" readonly />
				   </div>
				</div>
	 			
	          <!-- Row 1 -->
	          <div class="row mb-3">
	          
	            <div class="col-md-4">
	              <label class="form-label">PO Number</label>
	              <input type="text" class="form-control" id="po_number" required readonly>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">PO Date</label>
	              <input type="date" class="form-control" id="pi_date" required readonly>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">PI No</label>
	              <input type="text" class="form-control" id="pi_no">
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">Vendor Code</label>
	              <input type="text" class="form-control" id="pi_vendor_code" required readonly>
	            </div>
	            <div class="col-md-4">
			      <label class="form-label">Mode of Payment</label>
			      <input type="text" class="form-control" id="pi_mode_of_payment" placeholder="Enter payment mode (e.g., NEFT, UPI)" required readonly>
			    </div>
	            
	            <div class="col-md-4">
	              <label class="form-label">Place of supply</label>
	              <input type="text" class="form-control" id="pi_supply_place" required>
	            </div>
	            <div class="col-md-4">
	              <label class="form-label">vehicle No</label>
	              <input type="text" class="form-control" id="pi_vehicle_No" required readonly>
	            </div>
	            
	            <div class="col-md-4">
				  <label class="form-label">State</label>
				  <select class="form-select" id="pi_state" disabled required>
				    <option value="">Select State</option>
				    <option value="1">JAMMU AND KASHMIR</option>
				    <option value="2">HIMACHAL PRADESH</option>
				    <option value="3">PUNJAB</option>
				    <option value="4">CHANDIGARH</option>
				    <option value="5">UTTARAKHAND</option>
				    <option value="6">HARYANA</option>
				    <option value="7">DELHI</option>
				    <option value="8">RAJASTHAN</option>
				    <option value="9">UTTAR PRADESH</option>
				    <option value="10">BIHAR</option>
				    <option value="11">SIKKIM</option>
				    <option value="12">ARUNACHAL PRADESH</option>
				    <option value="13">NAGALAND</option>
				    <option value="14">MANIPUR</option>
				    <option value="15">MIZORAM</option>
				    <option value="16">TRIPURA</option>
				    <option value="17">MEGHALAYA</option>
				    <option value="18">ASSAM</option>
				    <option value="19">WEST BENGAL</option>
				    <option value="20">JHARKHAND</option>
				    <option value="21">ORISSA</option>
				    <option value="22">CHHATTISGARH</option>
				    <option value="23">MADHYA PRADESH</option>
				    <option value="24">GUJARAT</option>
				    <option value="25">DAMAN AND DIU</option>
				    <option value="26">DADAR AND NAGAR HAVELI</option>
				    <option value="27">MAHARASTRA</option>
				    <option value="29">KARNATAKA</option>
				    <option value="30">GOA</option>
				    <option value="31">LAKSHADWEEP</option>
				    <option value="32">KERALA</option>
				    <option value="33">TAMIL NADU</option>
				    <option value="34">PUDUCHERRY</option>
				    <option value="35">ANDAMAN AND NICOBAR</option>
				    <option value="36">TELANGANA</option>
				    <option value="37">ANDHRA PRADESH</option>
				    <option value="97">OTHER TERRITORY</option>
				    <option value="96">OTHER COUNTRY</option>
				  </select>
				</div>
				
				<div class="col-md-4">
				  <label class="form-label">State Code</label>
				  <input type="text" class="form-control" id="pi_state_code" readonly required>
				</div>
				
				<div class="col-md-4">
					<label class="form-label">Transportation Mode</label>
					<input type="text" class="form-control" id="pi_transportMode" readonly>
				</div>
	            <!-- <div class="col-md-4">
	              <label class="form-label">State Code</label>
	              <input type="text" class="form-control" id="pi_state_code" required>
	            </div> -->
	             
	          </div>
	          <hr>
	          <div class="row mb-3">
	          </div>
			    <div class="col-md-3">
				    <label class="form-label">Quotation ID</label> 			     
				    <input type="text" id="pi_quotationId" class="form-control" readonly>
				</div>
				<hr> 
				        <div class="row">      
	                    	<div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="pi_company_honorifics1" class="form-control" readonly>
	                        </div>              
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Name</label>
	                            <input type="text" id="pi_vendorName1" class="form-control"  list="customerList" autocomplete="off" readonly required>
	                            <div id="pi_suggestionsBox1" class="suggestions"></div>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Customer Legal Name</label>
	                            <input type="text" id="pi_vendorlegalNamee1" class="form-control" readonly required>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">GST Number</label>
	                            <input type="text" id="pi_gstnumberr1" class="form-control" readonly required>
	                        </div>
	                        <div class="col-md-2">
	                            <label class="form-label">Order Method</label>
	                             <input type="text" id="pi_orderMethod1" class="form-control" required readonly>                           
	                        </div>
	                        
	                        <div class="col-md-1">
	                            <label class="form-label">Honorifics</label>
	                            <input type="text" id="pi_contact_person_honorifics1" class="form-control" readonly>
	                        </div>
	                        
	                        <div class="col-md-3">
	                            <label class="form-label">Contact Person Name</label>
	                            <input type="text" id="pi_personName1" class="form-control" readonly> 
	                           	<!-- <select id="pi_personName1" class="form-control form-select" >
	       						 	<option value="">Select Contact Person</option>
	    						</select>  -->
	                        </div> 	      
	                                          
	                        <div class="col-md-2">
	                            <label class="form-label">Designation</label>
	                            <input type="text" id="pi_designation1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Mobile Number</label>
	                            <input type="text" id="pi_contactDetails1" class="form-control" readonly>
	                        </div>
	                        <div class="col-md-3">
	                            <label class="form-label">Email ID</label>
	                            <input type="email" id="pi_emailId1" class="form-control" readonly>
	                        </div>
	                   </div>   
			          <!-- Row 2 -->
			          <div class="row mb-3">
			            <div class="col-md-6">
			              <label class="form-label">Customer Billing Address</label>
			              <textarea class="form-control" id="pi_billing_address" rows="2" required readonly></textarea>
			            </div>
			            <div class="col-md-6 mt-2"> 
	                            <label class="form-label">Delivery Address</label>
	    						<textarea class="form-control" id="pi_shipping_address" rows="2" required readonly></textarea>
	                    </div>
			          </div>				
					 <hr>
	            <!-- Row 3 -->
	 			<h5>Tax Type</h5>
	                    
	                     <hr>
	                    <div class="d-flex align-items-center mb-3">
	                        <input type="checkbox" id="pi_interState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('interState')"> 
	                        <label class="form-check-label me-3" style="font-size: 14px;">Intrastate(CGST 9% + SGST 9%)</label>

	                        <input type="checkbox" id="pi_outerState1" style="width: 12px; height: 12px; border-color: #000;" class="form-check-input me-1 taxTypeCheckBox" onclick="toggleGST('outerState')"> 
	                        <label class="form-check-label me-3" style="font-size: 14px;">Interstate(IGST 18%)</label>
	                    </div>        

		          <!-- Table for Items -->
		          <div class="table-responsive mb-3">
		            <table class="table table-bordered" id="pi_items_table" style="font-size:12px;">
		              <thead class="table-light">
		                <tr>
		                  <th>Sl No</th>
		                  <th>Module Name</th>
						  <th>Part No</th>
						  <th>HSN Code</th>
		                  <th>Description</th>
		                  <th>Quantity</th>
		                  <th>Rate</th>
		                  <th>Taxable Value</th>
		                  <th class="cgst-saleheader">CGST (9%)</th>
						  <th class="sgst-saleheader">SGST (9%)</th>
						  <th class="igst-saleheader">IGST (18%)</th>
		                  <th>Total</th>
						  <th class="action-col" style="display: none;">Action</th> <!-- initially hidden -->
		                </tr>
		              </thead>
		              <tbody>
		                <tr>
		                  <td><input type="number" class="form-control" name="slno[]" value="1" readonly></td>
		                  <td><input type="text" class="form-control" name="modules[]"></td>
						  <td><input type="text" class="form-control" name="part_no[]"></td>
						  <td><input type="text" class="form-control" name="hsn_code[]"></td>
		                  <td><input type="text" class="form-control" name="description[]"></td>
		                  <td><input type="number" class="form-control" name="quantity[]" min="1" oninput="calculateTotal(this)"></td>
		                  <td><input type="number" class="form-control" name="price[]" min="0" step="0.01" oninput="calculateTotal(this)"></td>
		                  <td><input type="number" class="form-control saletotal-without-gst" name="line_total[]" readonly></td>
		                  
		                  <td class="cgst-value">
				             <input type="number" class="form-control salecgst" name="cgst[]" value="${product.cgst}" readonly/>
				          </td>
				          <td class="sgst-value">
				              <input type="number" class="form-control salesgst" name="sgst[]"  value="${product.sgst}" readonly/>
				          </td>
				          <td class="igst-value">
				             <input type="number" class="form-control saleigst" name="igst[]"  value="${product.igst}" readonly />
				          </td>
		                  
		                  <td><input type="number" class="form-control saletotal-with-gst" name="total_line_total[]" readonly></td>
						  <td class="action-col" style="display: none;">
						     <button type="button" class="btn btn-danger removeRowBtn" onclick="removeRow(this)">Remove</button>
						  </td>
					  </tr>
		              </tbody>
		            </table>
		            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItemRow()">Add Item</button>
		            <div class="d-flex justify-content-end mt-3" id="summary-section">
					  <table class="table table-sm table-bordered" style="width: 400px; font-size: 12px;">
					    <tbody>
					      <tr><td>Total Amount:</td><td class="text-end" id="summary-total">0.00</td></tr>
					      <tr><td>CGST(9%):</td><td class="text-end" id="summary-cgst">0.00</td></tr>
					      <tr><td>SGST(9%):</td><td class="text-end" id="summary-sgst">0.00</td></tr>
					      <tr><td>IGST(18%):</td><td class="text-end" id="summary-igst">0.00</td></tr>
					      <tr>
							  <td>Tax Amount (GST):</td>
							  <td class="text-end" id="summary-gst-tax">0.00</td>
						  </tr>
						   <tr>
							  <td>Total Amount after GST and before TCS:</td>
							  <td class="text-end" id="total-amount-after-GST-before-TCS">0.00</td>
						  </tr>
							<tr>
							  <td>
							    TCS (0.1%):
							    <!-- <select id="apply-tcs" class="form-select form-select-sm d-inline w-auto ms-2">
							      <option value="no">Not Apply</option>
							      <option value="yes">Apply</option>
							    </select> -->
							  </td>
							  <td class="text-end" id="summary-tcs">0.00</td>
							</tr>

					      <tr><td>Total Tax:</td><td class="text-end" id="summary-tax">0.00</td></tr>
					      <tr><td>Total Amount after Tax:</td><td class="text-end" id="summary-with-tax">0.00</td></tr>
					      <tr><td>GST Payable on Reverse Charges: </td><td class="text-end"><input type="number" id="gst-reverse-charge" placeholder="0.00" step="any" readonly></td></tr>
					      <tr><td>Total Amount after Reverse Charges:</td><td class="text-end" id="total-amount-after-revese-charge">0.00</td></tr>
					      <tr>
							  <td>
							    Round Off (Decimal): 
							   <!--  <select id="round-type" class="form-select form-select-sm d-inline w-auto ms-2">
								  <option value="even">even</option>
								  <option value="odd">odd</option>
								</select> -->
							  </td>
							  <td class="text-end" id="summary-roundoff">0.00</td>
							</tr> 
					     <!--  <tr><td>Round Off (Decimal):</td></tr> -->
					     <tr><td><strong>Net Amount:</strong></td><td class="text-end" id="summary-final">0.00</td></tr>
					    </tbody>
					  </table>
					</div>
		            
		          </div>
		
		          <!-- Grand Total -->
		        <!--   <div class="row mb-3">
		            <div class="col-md-3 ms-auto">
		              <label class="form-label">Grand Total</label>
		              <input type="number" class="form-control" id="pi_grand_total" >
		            </div>
		          </div> -->
				  
				  <!-- File Input for PDF Attachment -->
				  <!-- <div class="row mb-3">
				      <div class="col-md-6">
				          <label class="form-label">Attach PDF</label>
				          <input type="file" class="form-control" id="pi_attachment" name="pi_attachment" accept="application/pdf" onchange="showPreviewButton()">
				          <small class="form-text text-muted">Only PDF files are allowed.</small>
				      </div>
				  </div> -->

				  <!-- Preview Button (Initially Hidden) -->
				  <div id="pi_previewButtonDiv" style="display:none;">
				      <button type="button" class="btn btn-primary" id="previewButton" onclick="previewPDF()">Preview PDF</button>
				  </div>
				  
				  <!-- Terms and Conditions Section -->
				            <div class="col-md-12 mt-3">
				              <label class="form-label">Terms And Conditions</label>
				              <textarea class="form-control" id="pi_terms_and_conditionnew" rows="3"  style="font-size: 14px;">
				               	
				              </textarea>
				            </div>
		          <!-- Submit Button -->
		          <!-- <div class="text-end">
					 <div class="text-end mt-3">
					  <button type="submit" class="btn btn-outline-primary">submit</button>
					  <button type="button" class="btn btn-outline-success" onclick="viewPI()">View PI</button> 
					 </div>
		          </div> --> 
		          
		        </form>
		      </div>
		    </div>
		  </div>
		</div>
		
		<div class="modal fade" id="dcModal" tabindex="-1" aria-labelledby="dcModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-lg">
		    <div class="modal-content shadow-lg border-0 rounded-4">
		      <div class="modal-header bg-primary text-white rounded-top-4">
		        <h5 class="modal-title" id="dcModalLabel">Delivery Challan</h5>
		        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
		      </div>

		      <div class="modal-body px-4 py-3">
				
				<input type="hidden" id="dcPurchaseOrderId" name="purchaseOrderId">
				<input type="hidden" id="dcQuotationId" name="quotationId">

		        <!-- Supplier Address -->
		        <div class="mb-4">
		          <label class="form-label fw-bold">Supplier Address:</label>
		          <div class="bg-light p-3 rounded border">
		           <strong> Melange Systems Pvt Ltd.</strong><br>
		            4/1, 7th Cross Railway Parallel Road<br>
		            Kumara Park West<br>
		            Bangalore - 560020
		          </div>
		        </div>

		        <div class="row g-3">
					<!-- Buyer (Bill to) with Address Textarea, full width -->
					 <div class="col-6">
					   <label for="buyer" class="form-label">Buyer (Bill to)</label>
					   <div id="buyer" class="form-control bg-white" contenteditable="false" style="min-height: 100px;"></div>

					 </div>
					 <!-- Delivery Address, full width -->
					     <div class="col-6">
					         <label for="deliveryAddressdcc" class="form-label">Delivery Address</label>
					         <div id="deliveryAddressdcc" class="form-control bg-white" contenteditable="false" style="min-height: 100px;"></div>
					     </div>
						 
					 <!-- Delivery Note No. -->
					 <div class="col-md-6">
					   <label for="deliveryNoteNo" class="form-label">Delivery Note No.</label>
					   <input type="text" class="form-control" id="deliveryNoteNo" readonly>
					 </div>

					 <!-- Dated -->
					 <div class="col-md-6">
					   <label for="dated" class="form-label">Dated</label>
					   <input type="date" class="form-control" id="dated">
					 </div>
		          <!-- Reference No. & Date -->
		          <div class="col-md-6">
		            <label for="referenceNoDate" class="form-label">PO No. & Date</label>
		            <input type="text" class="form-control" id="referenceNoDate">
		          </div>

		          <!-- Other References -->
		          <div class="col-md-6">
		            <label for="otherReferences" class="form-label">Other References</label>
		            <input type="text" class="form-control" id="otherReferences">
		          </div>

		          


		          <!-- Terms of Delivery -->
		          <div class="col-md-6">
		            <label for="termsOfDelivery" class="form-label">Terms of Delivery</label>
		            <input type="text" class="form-control" id="termsOfDelivery">
		          </div>
				  <!-- Buyer's Order No. -->
				  <div class="col-md-6">
				    <label for="buyersOrderNo" class="form-label">Buyerâ€™s Order No.</label>
				    <input type="text" class="form-control" id="buyersOrderNo">
				  </div>

				

				  <!-- Mode/Terms of Payment -->
				  <div class="col-md-6">
				    <label for="paymentTerms" class="form-label">Mode/Terms of Payment</label>
				    <input type="text" class="form-control" id="paymentTerms">
				  </div>
				  <!-- Dated (for Buyer's Order No.) -->
				  		  <div class="col-md-6">
				  		    <label for="buyersOrderDate" class="form-label">Dated</label>
				  		    <input type="date" class="form-control" id="buyersOrderDate">
				  		  </div>
		        
		        </div>

		        <!-- Table for Goods -->
		        <div class="mt-4">
		          <table class="table table-bordered">
					<thead class="table-light">
					  <tr>
					    <th>Sl</th>
					    <th>Description of Goods</th>
					    <th>HSN/SAC</th>
					    <th>Quantity</th>
					    <th>Rate</th>
					    <th>Taxable Value</th>
						<th class="col-cgst">CGST</th>
						   <th class="col-sgst">SGST</th>
						   <th class="col-igst">IGST</th>
					    <th>Total</th>
					  </tr>
					</thead>

		            <tbody id="goodsTableBody">
		              <!-- Dynamically added rows will go here -->
		              <tr>
		                <td>1</td>
		                <td><input type="text" class="form-control"  placeholder="Enter description"></td>
		                <td><input type="text" class="form-control"  placeholder="Enter HSN/SAC"></td>
		                <td><input type="number" class="form-control"  placeholder="Enter quantity"></td>
		                <td><input type="number" class="form-control"  placeholder="Enter rate"></td>
		                <td><input type="text" class="form-control"  placeholder="Enter unit"></td>
		                <td><input type="number" class="form-control"  placeholder="Enter amount" readonly></td>
		              </tr>
		            </tbody>
		          </table>
				  <!-- Tax Summary Display -->
				 
				   <div id="taxSummaryDiv" class="mt-3"></div>
				   <!-- Rounding Options -->
				   <div>
				       <label>
				           <input type="radio" name="roundingOption" value="odd"> Round to Odd
				       </label>
				       <label>
				           <input type="radio" name="roundingOption" value="even"> Round to Even
				       </label>
				   </div>



				   <div id="amountInWordsDiv" class="mt-3 fw-bold text-start"></div>

				   <h6 class="fw-bold mt-4">Tax Summary</h6>
				   <table class="table table-bordered">
				     <thead class="table-light" id="taxTableHeader">
				       <tr>
				         <th rowspan="2">HSN/SAC</th>
				         <th rowspan="2">Taxable Value</th>
				         <th colspan="2" class="text-center  cgst-header">CGST</th>
				         <th colspan="2" class="text-center sgst-header">SGST</th>
				         <th colspan="2" class="text-center igst-header">IGST</th>
				         <th rowspan="2">Total Tax Amount</th>
				       </tr>
				       <tr>
				         <th  class="cgst-header">Rate (%)</th>
				         <th  class="cgst-header">Amount</th>
				         <th class="sgst-header">Rate (%)</th>
				         <th class="sgst-header">Amount</th>
				         <th class="igst-header">Rate (%)</th>
				         <th class="igst-header">Amount</th>
				       </tr>
				     </thead>
				     <tbody id="taxBreakdownBody">
				       <!-- JS will insert rows here -->
				     </tbody>
				   </table>
				   <div id="taxAmountInWordsDiv" class="fw-bold text-start mt-3"></div>
				   <div class="row mt-4">
				     <div class="col-md-8">
				       <label for="remarks" class="form-label fw-bold">Remarks</label>
				       <textarea id="remarks" class="form-control" rows="2" placeholder="Enter any remarks here"></textarea>
				     </div>
				     <div class="col-md-4">
				       <label for="companyPan" class="form-label fw-bold">Company PAN</label>
				       <input type="text" id="companyPan" class="form-control" placeholder="Enter Company PAN">
				     </div>
				   </div>

		        </div>
		      </div>

		      <div class="modal-footer bg-light border-top-0 rounded-bottom-4">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		        <button type="button" class="btn btn-success" id="saveDCBtn" >Save DC</button>
		      </div>
		    </div>
		  </div>
		</div>
		
		
		
	<div class="table-responsive">
		<table class="table table-bordered mt-3">
	        <thead class="table bg-secondary">
	            <tr>
	                <th>ID</th>
	                <th>Invoice Id</th>
	                <th>Sale Order Id</th>
	                <th>Quotation ID</th>	                
	                <th>Vendor Code</th>
	                <th>Customer Name</th>
					<th>Invoice Date</th> <!-- âœ… New column -->
	                <th>View<th>
	                <!-- Add more headers as needed -->
	            </tr>
	        </thead>
	        <tbody>
	            <tr th:each="invoice, irtStart : ${invoiceLists}">
	            	<td th:text="${irtStart.index+1}"></td>
	                <td th:text="${invoice.invoice_id}">1</td>
	                <td th:text="${invoice.purchaseId}">PO123</td>
	                <td th:text="${invoice.quotationId}">Q456</td>
	                <td th:text="${invoice.vendorCode}">V001</td>
	                <td th:text="${invoice.custName}">John Doe</td>
					<td class="createdDateTime" th:text="${invoice.createdDateTime}">2025-06-24T06:04:24.946Z</td>
	                <td>
					  <a class="btn btn-outline-info btn-sm" title="View"
					     th:onclick="openPerformaInvoiceModal('[[${invoice.invoice_id}]]')">
					     
					    <i class="fas fa-eye"></i>
					  </a>
					</td>
 
	            </tr> 
	        </tbody>
	    </table>
    </div>
    
<!-- script to display perfoma invoice modal -->
<!-- script to display perfoma invoice modal -->
<script>

		document.querySelectorAll(".createdDateTime").forEach(td => {
		  let raw = td.textContent.trim();

		  if (raw) {
		    let date = new Date(raw);
		    if (!isNaN(date)) {
		      let day = String(date.getDate()).padStart(2, "0");
		      let month = String(date.getMonth() + 1).padStart(2, "0");
		      let year = date.getFullYear();

		      let hours = String(date.getHours()).padStart(2, "0");
		      let minutes = String(date.getMinutes()).padStart(2, "0");
		      let seconds = String(date.getSeconds()).padStart(2, "0");

		      td.textContent = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
		    }
		  }
		});
		
		// âœ… Reformat date + Sort rows by createdDateTime (latest first)
		function formatAndSortTable() {
		  const rows = Array.from(document.querySelectorAll("tbody tr"));

		  rows.forEach(row => {
		    let td = row.querySelector(".createdDateTime");
		    let raw = td.textContent.trim();

		    if (raw) {
		      let date = new Date(raw);
		      if (!isNaN(date)) {
		        // âœ… Format display
		        let day = String(date.getDate()).padStart(2, "0");
		        let month = String(date.getMonth() + 1).padStart(2, "0");
		        let year = date.getFullYear();
		        let hours = String(date.getHours()).padStart(2, "0");
		        let minutes = String(date.getMinutes()).padStart(2, "0");
		        let seconds = String(date.getSeconds()).padStart(2, "0");

		        td.textContent = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
		        // âœ… Store timestamp for sorting
		        row.dataset.timestamp = date.getTime();
		      }
		    }
		  });

		  // âœ… Sort rows by timestamp (latest first)
		  rows.sort((a, b) => b.dataset.timestamp - a.dataset.timestamp);

		  // âœ… Append back to tbody
		  const tbody = document.querySelector("tbody");
		  rows.forEach(row => tbody.appendChild(row));
		}

		// Run after DOM is ready
		document.addEventListener("DOMContentLoaded", formatAndSortTable);

	// Attach to the actual Bootstrap modal show event
	document.getElementById('dcModal').addEventListener('shown.bs.modal', function () {
	  fetch('/dc/next-number')
	    .then(response => response.text()) // or .json() based on your API
	    .then(data => {
	      document.getElementById('deliveryNoteNo').value = data;
	    })
	    .catch(error => {
	      console.error('Error fetching DC Number:', error);
	    });
	});


	function numberToWordsIndianWithPaise(amount) {
			    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven',
			        'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen',
			        'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
			    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

			    function getWords(num) {
			        if ((num = num.toString()).length > 9) return 'Overflow';
			        let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
			        if (!n) return '';

			        let str = '';
			        str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + ' Crore ' : '';
			        str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + ' Lakh ' : '';
			        str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + ' Thousand ' : '';
			        str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + ' Hundred ' : '';
			        str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + ' ' : '';
			        return str.trim();
			    }

			    let rupees = Math.floor(amount);
			    let paise = Math.round((amount - rupees) * 100);

			    let rupeeWords = getWords(rupees);
			    let paiseWords = paise > 0 ? getWords(paise) : '';

			    let final = '';
			    if (rupeeWords) final += rupeeWords + ' Rupees';
			    if (rupeeWords && paiseWords) final += ' and ';
			    if (paiseWords) final += paiseWords + ' Paise';

			    return final.trim() + ' Only';
			}
			
			function roundToOddOrEven(value, type) {
			    let floor = Math.floor(value);
			    let ceil = Math.ceil(value);

			    let nearestEven = (Math.abs(floor - value) <= Math.abs(ceil - value)) 
			                      ? (floor % 2 === 0 ? floor : ceil)
			                      : (ceil % 2 === 0 ? ceil : floor);

			    let nearestOdd = (Math.abs(floor - value) <= Math.abs(ceil - value)) 
			                     ? (floor % 2 !== 0 ? floor : ceil)
			                     : (ceil % 2 !== 0 ? ceil : floor);

			    let rounded = (type === "even") ? nearestEven : nearestOdd;
			    let difference = parseFloat((rounded - value).toFixed(2)); // delta in â‚¹
			    
			    return { rounded, difference };
			}

			let finalRoundedTotal = 0; 
			function openDcModalFromInvoice() {
			    const billing = document.getElementById("pi_billing_address").value || '';
			    const delivery = document.getElementById("pi_shipping_address").value || '';
			    const poNo = document.getElementById("po_number").value || '';
			    const poDate = document.getElementById("pi_date").value || '';
			    const modeOfPayment = document.getElementById("pi_mode_of_payment").value || '';
			    const quotationId = document.getElementById("pi_quotationId").value || '';
			    const purchaseOrderId = document.getElementById("pi_po_id").value || '';

			    document.getElementById("buyer").innerText = billing;
			    document.getElementById("deliveryAddressdcc").innerText = delivery;
			    document.getElementById("referenceNoDate").value = `${poNo} - ${poDate}`;
			    document.getElementById("paymentTerms").value = modeOfPayment;
			    document.getElementById("buyersOrderNo").value = poNo;
			    document.getElementById("buyersOrderDate").value = poDate;
			    document.getElementById("dcPurchaseOrderId").value = purchaseOrderId;
			    document.getElementById("dcQuotationId").value = quotationId;
			    document.getElementById("dated").value = new Date().toISOString().split('T')[0];

			    document.getElementById("goodsTableBody").innerHTML = "";
			    document.getElementById("taxBreakdownBody").innerHTML = "";

			    let hasCGST = false;
			    let hasSGST = false;
			    let hasIGST = false;
			    let grandTotal = 0;
			    let totalTaxAmount = 0;

			    const invoiceRows = document.querySelectorAll("#pi_items_table tbody tr");
			    invoiceRows.forEach((row, index) => {
			        const description = row.querySelector('input[name="description[]"]').value || '';
			        const hsn = row.querySelector('input[name="hsn_code[]"]').value || '';
			        const quantity = row.querySelector('input[name="quantity[]"]').value || '';
			        const rate = row.querySelector('input[name="price[]"]').value || '';
			        const taxableValue = parseFloat(row.querySelector('input[name="line_total[]"]').value || '0');
			        const amount = parseFloat(row.querySelector('input[name="total_line_total[]"]').value || '0');

					const cgstAmt = parseFloat(row.querySelector('input[name="cgst[]"]').value || '0');
					const sgstAmt = parseFloat(row.querySelector('input[name="sgst[]"]').value || '0');
					const igstAmt = parseFloat(row.querySelector('input[name="igst[]"]').value || '0');

					const cgstRate = taxableValue > 0 ? ((cgstAmt / taxableValue) * 100).toFixed(2) : '0';
					const sgstRate = taxableValue > 0 ? ((sgstAmt / taxableValue) * 100).toFixed(2) : '0';
					const igstRate = taxableValue > 0 ? ((igstAmt / taxableValue) * 100).toFixed(2) : '0';

					console.log(`âœ… Calculated CGST Amt: ${cgstAmt}`);
					  console.log(`âœ… Calculated SGST Amt: ${sgstAmt}`);
					  console.log(`âœ… Calculated IGST Amt: ${igstAmt}`);
			        const totalWithTax = (taxableValue + parseFloat(cgstAmt) + parseFloat(sgstAmt) + parseFloat(igstAmt)).toFixed(2);
			        grandTotal += parseFloat(totalWithTax);

			        const taxOnly = parseFloat(cgstAmt) + parseFloat(sgstAmt) + parseFloat(igstAmt);
			        totalTaxAmount += taxOnly;

			        if (cgstRate > 0) hasCGST = true;
			        if (sgstRate > 0) hasSGST = true;
			        if (igstRate > 0) hasIGST = true;

			        const productRow = document.createElement("tr");
			        productRow.innerHTML = `
			            <td>${index + 1}</td>
			            <td><input type="text" class="form-control" value="${description}" readonly></td>
			            <td><input type="text" class="form-control" value="${hsn}" readonly></td>
			            <td><input type="number" class="form-control" value="${quantity}" readonly></td>
			            <td><input type="number" class="form-control" value="${rate}" readonly></td>
			            <td><input type="number" class="form-control" value="${taxableValue}" readonly></td>
			            <td class="col-cgst"><input type="number" class="form-control" value="${cgstAmt}" readonly></td>
			            <td class="col-sgst"><input type="number" class="form-control" value="${sgstAmt}" readonly></td>
			            <td class="col-igst"><input type="number" class="form-control" value="${igstAmt}" readonly></td>
			            <td><input type="number" class="form-control" value="${totalWithTax}" readonly></td>
			        `;
			        document.getElementById("goodsTableBody").appendChild(productRow);

			        const taxRow = document.createElement("tr");
			        taxRow.innerHTML = `
			            <td>${hsn}</td>
			            <td>${taxableValue.toFixed(2)}</td>
			            <td class="cgst-header">${cgstRate}</td>
			            <td class="cgst-header">${cgstAmt}</td>
			            <td class="sgst-header">${sgstRate}</td>
			            <td class="sgst-header">${sgstAmt}</td>
			            <td class="igst-header">${igstRate}</td>
			            <td class="igst-header">${igstAmt}</td>
			            <td>${taxOnly.toFixed(2)}</td>
			        `;
			        document.getElementById("taxBreakdownBody").appendChild(taxRow);
			    });

			    const toggleColumn = (selector, show) => {
			        document.querySelectorAll(selector).forEach(el => {
			            el.style.display = show ? "" : "none";
			        });
			    };

			    toggleColumn(".col-cgst, .cgst-header, th.col-cgst", hasCGST);
			    toggleColumn(".col-sgst, .sgst-header, th.col-sgst", hasSGST);
			    toggleColumn(".col-igst, .igst-header, th.col-igst", hasIGST);

				document.getElementById("taxAmountInWordsDiv").innerHTML = 
				    `<p><strong>Tax Amount:</strong> â‚¹${totalTaxAmount.toFixed(2)} <br>
				     <strong>Tax Amount (in words):</strong> ${numberToWordsIndianWithPaise(totalTaxAmount.toFixed(2))}</p>`;

			    // Show total amount and words
			    document.getElementById("taxSummaryDiv").innerHTML = `
			        <p><strong>Total Amount with Tax:</strong> â‚¹${grandTotal.toFixed(2)}</p>
			        <p><strong>Amount Chargeable (in words):</strong> ${numberToWordsIndianWithPaise(grandTotal)}</p>
			    `;

			    // Rounding logic
			    document.querySelectorAll('input[name="roundingOption"]').forEach((radio) => {
			        radio.addEventListener('change', (e) => {
			            const roundingType = e.target.value;
			            const { rounded, difference } = roundToOddOrEven(grandTotal, roundingType);
						finalRoundedTotal = rounded; // ðŸ’¾ Store rounded total
			            const sign = difference > 0 ? '+' : '-';
			            const paisa = Math.abs(Math.round(difference * 100));

			            document.getElementById("taxSummaryDiv").innerHTML = `
			                <p><strong>Total Amount with Tax:</strong> â‚¹${rounded.toFixed(2)}</p>
			                <p><strong>Rounded Amount:</strong> (${sign}${paisa} paise)</p>
			                <p><strong>Amount Chargeable (in words):</strong> ${numberToWordsIndianWithPaise(rounded)}</p>
			            `;
			        });
			    });

			    // Show/hide rounding options based on whether grandTotal has paise
			    const hasPaise = grandTotal % 1 !== 0;
			    const roundingDiv = document.querySelector('[name="roundingOption"]').closest('div');
			    roundingDiv.style.display = hasPaise ? 'block' : 'none';

			    bootstrap.Modal.getInstance(document.getElementById('performaInvoiceModal')).hide();
			    new bootstrap.Modal(document.getElementById('dcModal')).show();
			}

			document.getElementById("saveDCBtn").addEventListener("click", function () {
			    const deliveryChallanData = {
			        buyer: document.getElementById("buyer").innerText,
			        deliveryAddress: document.getElementById("deliveryAddressdcc").innerText,
			        referenceNoDate: document.getElementById("referenceNoDate").value,
			        paymentTerms: document.getElementById("paymentTerms").value,
			        buyersOrderNo: document.getElementById("buyersOrderNo").value,
			        buyersOrderDate: document.getElementById("buyersOrderDate").value,
			        purchaseOrderId: document.getElementById("dcPurchaseOrderId").value,
			        quotationId: document.getElementById("dcQuotationId").value,
			        dated: document.getElementById("dated").value,
			       // roundedGrandTotal: parseFloat(document.querySelector("#taxSummaryDiv p strong").nextSibling.textContent.replace(/[^\d.]/g, '')) || 0,
				   roundedGrandTotal: finalRoundedTotal,

			        supplierAddress: document.getElementById("pi_billing_address").value || '',
			      //  billingCompanyName: document.getElementById("pi_billing_company").value || '',
			        companyPan: document.getElementById("companyPan").value || '',
			        deliveryNoteNo: document.getElementById("deliveryNoteNo")?.value || '',
			        referenceNo: document.getElementById("pi_reference_no")?.value || '',
			        otherReferences: document.getElementById("otherReferences")?.value || '',
			        termsOfDelivery: document.getElementById("termsOfDelivery")?.value || '',
			        remarks: document.getElementById("remarks")?.value || '',
			        goodsDetails: [] // updated key as expected by backend
			    };

				// Collect product rows
				  document.querySelectorAll("#goodsTableBody tr").forEach(row => {
				      const cgst = parseFloat(row.cells[6]?.querySelector('input')?.value || 0);
				      const sgst = parseFloat(row.cells[7]?.querySelector('input')?.value || 0);
				      const igst = parseFloat(row.cells[8]?.querySelector('input')?.value || 0);

				      const good = {
				          description: row.cells[1].querySelector('input').value,
				          hsnSac: row.cells[2].querySelector('input').value,
				          quantity: row.cells[3].querySelector('input').value,
				          rate: row.cells[4].querySelector('input').value,
				          amount: row.cells[5].querySelector('input').value,
				          cgstAmount: cgst.toFixed(2),
				          sgstAmount: sgst.toFixed(2),
				          igstAmount: igst.toFixed(2),
				          totalWithTax: row.cells[9]?.querySelector('input')?.value || '0',
				          perUnit: "Nos",
				          totalTaxAmount: (cgst + sgst + igst).toFixed(2),
				          cgstRate: (cgst > 0) ? 9 : 0,
				          sgstRate: (sgst > 0) ? 9 : 0,
				          igstRate: (igst > 0) ? 18 : 0
				      };

				      deliveryChallanData.goodsDetails.push(good);
				  });
			    // AJAX call to save
			    $.ajax({
			        url: '/delivery-challan/save',
			        type: 'POST',
			        contentType: 'application/json',
			        data: JSON.stringify(deliveryChallanData),
			        success: function (response) {
			            alert('Delivery Challan saved successfully');
			            $('#dcModal').modal('hide');
			        },
			        error: function (error) {
			            alert('Error saving Delivery Challan');
			            console.error(error);
			        }
			    });
			});

function openPerformaInvoiceModal(invoiceId) {
	
    if (!invoiceId || invoiceId.trim() === "") {
        alert("invoiceId is empty");
        return;
    }

    // Strip surrounding quotes if any
    invoiceId = invoiceId.replace(/^"|"$/g, '');
    
    fetch(`/purchase-invoice/getInvoice?invoiceId=${encodeURIComponent(invoiceId)}`)
        .then(response => response.json())
        .then(data => {  
        	
         	if (data.approve_by_ac === "1") {
                document.getElementById("approveInvoiceBtn").style.display = "none";
            } else {
                document.getElementById("approveInvoiceBtn").style.display = "block";
            }  
        	
        	document.getElementById("approveByAc").value = data.approve_by_ac || '';
            // Example: Assigning values to input fields // invoice_id
            document.getElementById("pi_id").value = data.invoice_id || '';
            document.getElementById("pi_po_id").value = data.purchaseId || '';
            document.getElementById("pidateTime").value = data.date_of_supply || '';
            document.getElementById("po_number").value = data.poNumber || '';
            document.getElementById("pi_date").value = data.poDate || '';
            document.getElementById("pi_no").value = data.pi_no || '';
            
            document.getElementById("pi_vendor_code").value = data.vendorCode || '';
            document.getElementById("pi_mode_of_payment").value = data.modeOfPayment || '';
            document.getElementById("pi_supply_place").value = data.supplyPlace || '';
            document.getElementById("pi_vehicle_No").value = data.vehicleNo || '';
            document.getElementById("pi_state").value = data.stateId || '';
            document.getElementById("pi_state_code").value = data.stateCode || '';
            document.getElementById("pi_transportMode").value = data.transportationMode || '';
            document.getElementById("pi_quotationId").value = data.quotationId || '';
 			
            // Example for customer details
            document.getElementById("pi_company_honorifics1").value = data.custHonorifics || '';
            document.getElementById("pi_vendorName1").value = data.custName || '';
            document.getElementById("pi_vendorlegalNamee1").value = data.cusLeagalName || '';
            document.getElementById("pi_gstnumberr1").value = data.gstNo || '';
            document.getElementById("pi_orderMethod1").value = data.orderMehtod || '';

            document.getElementById("pi_contact_person_honorifics1").value = data.contactHonorifics || '';
            document.getElementById("pi_personName1").value = data.contPersonName || '';
            document.getElementById("pi_designation1").value = data.designation || '';
            document.getElementById("pi_contactDetails1").value = data.mobileNo || '';
            document.getElementById("pi_emailId1").value = data.email || '';
            
            document.getElementById("pi_billing_address").value = data.billingAddress || '';
            document.getElementById("pi_shipping_address").value = data.shippingAddress || '';
            document.getElementById("pi_terms_and_conditionnew").value = data.termsAndConditions || '';
            //document.getElementById("pi_grand_total").value = data.grandTotal || '';
            
            document.getElementById("pi_transportMode").value = data.transportMode || '';
            document.getElementById("pi_state_code").value = data.sateCode || '';
            document.getElementById("pi_state").value = data.stateName || '';
            document.getElementById("pi_vehicle_No").value = data.vehicle || '';
            document.getElementById("pi_supply_place").value = data.placeOfSupply || '';
            
            // Check the appropriate Tax Type checkbox based on tax_type value
			const taxType = (data.tax_type || '').toLowerCase();

			if (taxType === 'intrastate') {
			    document.getElementById('pi_interState1').checked = true;
			    document.getElementById('pi_outerState1').checked = false;
			    // toggleGST('interState');
			} else if (taxType === 'interstate') {
			    document.getElementById('pi_outerState1').checked = true;
			    document.getElementById('pi_interState1').checked = false;
			    // toggleGST('outerState');
			} else {
			    document.getElementById('pi_interState1').checked = false;
			    document.getElementById('pi_outerState1').checked = false;
			}

             
            // document.getElementById("summary-total").value = data.totalAmount || '';
            document.getElementById("summary-total").innerText = data.totalAmount || '0.00';

            document.getElementById("summary-cgst").innerText = data.cgst || '0.00';
            document.getElementById("summary-sgst").innerText = data.sgst || '0.00';
            document.getElementById("summary-igst").innerText = data.igst || '0.00';
            document.getElementById("summary-gst-tax").innerText = data.totalTaxGst || '0.00';
            
            document.getElementById("total-amount-after-GST-before-TCS").innerText = data.totalAmtAfterTaxBeforeTcs || '0.00';
            document.getElementById("summary-tcs").innerText = data.tcs || '0.00';
            document.getElementById("summary-tax").innerText = data.totalTax || '0.00';
            document.getElementById("summary-with-tax").innerText = data.totoalTaxAfterTcs || '0.00';
            document.getElementById("gst-reverse-charge").value = data.gstPayableRevCharge || '0.00';
            
            document.getElementById("total-amount-after-revese-charge").innerText = data.totalAmtAfterRevCharge || '0.00';
            document.getElementById("summary-roundoff").innerText = data.roundOffDecimal || '0.00';
            //document.getElementById("summary-final").innerText = data.netAmt || '0.00';
            
            document.getElementById("summary-final").innerText = (data.netAmt != null) ? parseFloat(data.netAmt).toFixed(2) : '0.00';

            // Clear existing rows except the first one (template)
            const tbody = document.querySelector("#pi_items_table tbody");
            tbody.innerHTML = ""; // clear all rows
            // Loop through each item in the invoice
            data.items?.forEach((item, index) => {
             
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td><input type="number" class="form-control" name="slno[]" value="${index + 1}" readonly></td>
                    <td><input type="text" class="form-control" name="modules[]" value="${item.moduleName || ''}" readonly></td>
                    <td><input type="text" class="form-control" name="part_no[]" value="${item.partNo || ''}" readonly></td>
                    <td><input type="text" class="form-control" name="hsn_code[]" value="${item.hsnCode || ''}" readonly></td>
                    <td><input type="text" class="form-control" name="description[]" value="${item.description || ''}" readonly></td>
                    <td><input type="number" class="form-control" name="quantity[]" value="${item.quantity || 0}" readonly></td>
                    <td><input type="number" class="form-control" name="price[]" value="${item.price || 0}" readonly></td>
                    <td><input type="number" class="form-control saletotal-without-gst" name="line_total[]" value="${item.lineTotal || 0}" readonly></td>
                    <td class="cgst-value"><input type="number" class="form-control salecgst" name="cgst[]" value="${item.cgst || 0}" readonly></td>
                    <td class="sgst-value"><input type="number" class="form-control salesgst" name="sgst[]" value="${item.sgst || 0}" readonly></td>
                    <td class="igst-value"><input type="number" class="form-control saleigst" name="igst[]" value="${item.igst || 0}" readonly></td>
                    <td><input type="number" class="form-control saletotal-with-gst" name="total_line_total[]" value="${item.totalValue || 0}" readonly></td>
                    <td class="action-col" style="display: none;"><button type="button" class="btn btn-danger removeRowBtn" onclick="removeRow(this)">Remove</button></td>
                `;

                tbody.appendChild(row);
            });
            // Set tax type checkbox
            if (data.taxType === 'interState') {
                document.getElementById('pi_interState1').checked = true;
                toggleGST('interState');
            } else if (data.taxType === 'outerState') {
                document.getElementById('pi_outerState1').checked = true;
                toggleGST('outerState');
            }

            // TODO: Populate table items
            // You would loop over `data.items` or similar to populate the table rows.

        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });

    var performaInvoiceModal = new bootstrap.Modal(document.getElementById('performaInvoiceModal'));
    performaInvoiceModal.show();
}
</script>
<!-- script to approve Invoice -->
<script>
async function approvePI() {
    const invoiceIdInput = document.getElementById("pi_id");
    if (!invoiceIdInput) {
        alert("Invoice ID not found.");
        return;
    }

    let invoiceId = invoiceIdInput.value.replace(/^"|"$/g, '');

    // Generate PDF with jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4',
    });

    for (let i = 0; i < 1; i++) {
        if (i !== 0) {
            doc.addPage();
        }
        await generateInvoiceContentForUploadPDF(doc, i); // Your existing content logic
    }

    const pdfBlob = doc.output('blob'); // Get Blob from jsPDF

    // Create FormData and append fields
    const formData = new FormData();
    formData.append("invoiceId", invoiceId);
    formData.append("approveByAc", 1);
    formData.append("invoicePdf", pdfBlob, `invoice_${invoiceId}.pdf`);

    
    // Send data to backend using fetch or AJAX
    const loadingPopup = document.getElementById('loadingPopup');
    loadingPopup.style.display = 'flex'; // Show the overlay
    
    fetch('/purchase-invoice/update-approval', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
        	loadingPopup.style.display = 'none';
            alert("Invoice approved and PDF sent successfully!");
            location.reload();
        } else { 
            alert("Failed to approve invoice or send PDF.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong.");
    });
}
</script>


<!-- script to display PI in PDF -->

<script>
async function viewPI() {	  
	  const { jsPDF } = window.jspdf;
	  const doc = new jsPDF({
	    orientation: 'portrait',
	    unit: 'mm',
	    format: 'a4',
	  });

	  for (let i = 0; i < 3; i++) {
	    if (i !== 0) {
	      doc.addPage(); // Add a new page for the next copy
	    }
	    await generateInvoiceContent(doc,i); // Your invoice-generating logic goes here
	  }
	  window.open(doc.output('bloburl'), '_blank');	  
	}
</script>

<script> 
async function generateInvoiceContent(doc,copyIndex) {
    
	const { jsPDF } = window.jspdf;

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
	const pdfMainBorderPAdding = 10;
	const approveBy = document.getElementById("approveByAc").value;
	
	const invoiceNo = document.getElementById('pi_id').value;
	
	if(approveBy != "1") {
		// Add DRAFT watermark 
		doc.setFontSize(120);
		doc.setTextColor(220, 220, 220); // light gray
		doc.setFont(undefined, 'bold');
		doc.text('DRAFT', pageWidth-160 / 2 , (pageHeight / 2) + 50, {
		    angle: 45,
		    align: 'center',
		    opacity: 0.1  // jsPDF v2.5.0+ supports opacity
		});
	}	
	doc.setTextColor(0, 0, 0); // Reset to black

    /* 	if (approveBy === "1") {
	    // Encode the invoice ID for URL safety
	    const encodedInvoiceId = encodeURIComponent(invoiceNo);

	    // 1. Construct the full URL for viewing the invoice
	    const baseUrl = window.location.origin; // e.g., https://yourdomain.com or http://localhost:9376
		const qrText = `${baseUrl}/purchase-invoice/view-pdf?invoiceId=${encodedInvoiceId}`;

	    // 2. Generate QR code as Data URL
	    const qrDataUrl = await QRCode.toDataURL(qrText);

	    // 3. Add QR code image to the PDF
	    const qrX = pageWidth - 35; // Adjust position
	    const qrY = pageHeight - 46; // Adjust position
	    const qrSize = 25; // width & height

	    doc.addImage(qrDataUrl, 'PNG', qrX, qrY, qrSize, qrSize);
	}   */ 

    // Add full-page border
    doc.setLineWidth(0.3);
    doc.rect(pdfMainBorderPAdding, pdfMainBorderPAdding, pageWidth - 20, pageHeight - 20);

    // Data from form
    const poNumber = document.getElementById('po_number').value;
    const poDate = document.getElementById('pi_date').value;
    const vendorCode = document.getElementById('pi_vendor_code').value;

    // Header
    let yAxis = pdfMainBorderPAdding + 5;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text("Melange Systems Private Limited.", pdfMainBorderPAdding +2, yAxis);
    doc.setFontSize(9);
    yAxis += 5;
    doc.setFont("helvetica","normal");
    doc.text("No. 4/1, 7th Cross, Kumara Park West, Bangalore 560020", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.text("Tel: 080-2356 1023, Telefax: 080-2346 2175", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.setFont("helvetica", "bold");
    doc.text("GSTIN: 29AACCM4737H1ZA, CIN: U72200KA2000PTC027922", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.text("Udyam Registration Number: UDYAM-KR-03-0101576", pdfMainBorderPAdding+2 , yAxis);
    
    // âœ… Add Company Logo (Right Side)
   	let logo = new Image();
    logo.src = "/assets/img/compressed_logo.png";
    // logo.onload = function () {
    doc.addImage(logo, "PNG", 140,  pdfMainBorderPAdding + 5, 50, 14); // (image, type, x, y, width, height)        

    // Draw horizontal line below header
    yAxis += 2;
    doc.setLineWidth(0.1); // thinner line
    
    // Rectangle with 3 columns below the header line
    const rectTopY = yAxis; // start a bit below the line
    const rectHeight = 16; // adjust height as needed (this height gives more space for rows)
    const rectLeftX = 10;
    const rectRightX = pageWidth - 10;
    const rectWidth = rectRightX - rectLeftX;
         
    // Column widths based on percentages, making sure they add up to 100%
    const col1Width = rectWidth * 0.70; // 50% width for column 1
    const col2Width = rectWidth * 0.08; // 30% width for column 2
    const col3Width = rectWidth * 0.22; // 20% width for column 3

    doc.setFont("helvetica","normal");
    doc.setLineWidth(0.05); // thinner line

    // Draw outer rectangle
    doc.rect(rectLeftX, rectTopY, rectWidth, rectHeight);

    // Draw Place of Supply:vertical lines for columns
    doc.line(rectLeftX + col1Width - 2, rectTopY, rectLeftX + col1Width - 2, rectTopY + rectHeight); // Line between col1 and col2
    doc.line(rectLeftX + col1Width + col2Width - 4, rectTopY, rectLeftX + col1Width + col2Width - 4, rectTopY + rectHeight); // Line between col2 and col3

    // Draw horizontal lines to create 3 rows in col2 and col3
    const rowHeight = (rectHeight / 3) ; // divide rect height into 3 rows
    doc.line(rectLeftX + col1Width - 2, rectTopY + rowHeight, rectRightX , rectTopY + rowHeight); // Row 1 horizontal line
    doc.line(rectLeftX + col1Width - 2, rectTopY + 2 * rowHeight, rectRightX, rectTopY + 2 * rowHeight); // Row 2 horizontal line

 	// Invoice title
    doc.setFontSize(14);
    doc.setFont("helvetica","bold");
    doc.text("TAX INVOICE", rectLeftX + col1Width / 2, rectTopY + rectHeight - 6, { align: 'center' });
    
     // Optional: headers
     doc.setFontSize(9);
     doc.setFont("helvetica","normal");
     
	 // Text for Column 2 rows
	 /* doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 0.5, { align: 'center' });
	 doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 1.5, { align: 'center' });
	 doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 2.5, { align: 'center' });  
	 */
	 
	  const tickX = rectLeftX + col1Width + col2Width / 2;
	  const tickY = rectTopY + rowHeight * copyIndex + 0.2;
	  const tickBase64 =  "data:image/png;base64,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";
	  
	  doc.addImage(tickBase64, 'PNG', tickX - 5, tickY, 5, 5);

	  //doc.addImage(tickBase64, tickX, tickY, { align: 'center' });
	  
	 // Text for Column 3 rows
	doc.text("Original for Recipient", rectLeftX + col1Width + col2Width - 2, rectTopY + rowHeight * 0.5 + 1.2);
	doc.text("Duplicate Supplier/Transporter", rectLeftX + col1Width + col2Width - 2, rectTopY + rowHeight * 1.5 + 1.2);
	doc.text("Triplicate for Supplier", rectLeftX + col1Width + col2Width - 2, rectTopY + rowHeight * 2.5 + 1.2);

	let mainY = rectTopY + 16;
	let lineSpace=4;
	let verticleLine = mainY+12;
	const piNo = document.getElementById('pi_id').value;
	const invoice_date = document.getElementById('pidateTime').value;
	const formattedPIDate = formatDateToDDMMYYYY(invoice_date);
	const stateCode = "";
	
	mainY = mainY + lineSpace;
	
	doc.text(`Invoice No. :${piNo}`,rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	/* doc.text(`Invoice Date: ${formattedPIDate}`,rectLeftX+2,mainY);
	mainY = mainY + lineSpace; */ 
	
	doc.text(`Invoice Date: ${invoice_date}`,rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text("State: Karnataka",rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text("State Code : 29",rectLeftX+2,mainY);
	
	mainY = rectTopY + 22; //resent the mainY to display vendorcode from begining again
	
	// verticle line
	//right rect
	const rightRectWidth = 110;
	const rightRectX = pageWidth - 5 - rightRectWidth; // 5mm margin from the right edge
	
	// Vertical line between left and right sections
	const centerX = (rectLeftX + (pageWidth - 5)) / 2;
	doc.line(centerX, mainY - 6, centerX, mainY + 18);
	
	//doc.rect(,mainY - 4);
	//doc.line(verticalLineX, mainY - 2, verticalLineX, mainY + 18); // Y range can be adjusted as needed
	const pi_vendor_code = document.getElementById("pi_vendor_code").value;
	const trasnportMode = document.getElementById('pi_transportMode').value;
	const vehicleNo = document.getElementById('pi_vehicle_No').value;
	const dateOfSypply = document.getElementById('pidateTime').value;
	const placeToSupply = document.getElementById('pi_supply_place').value;
	
	mainY = 57;
	doc.text(`Vendor Code: ${pi_vendor_code}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Transportation Mode : ${trasnportMode}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Vehicle Number: ${vehicleNo}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Date of Supply: ${dateOfSypply}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Place of Supply: ${placeToSupply}`,centerX +2,mainY);
	
	// Horizontal line below "Place of Supply:"
	doc.setLineWidth(0.1); // Optional: adjust line thickness
	//doc.line(pdfMainBorderPAdding, mainY+2, pageWidth - 10, mainY+2);
	mainY = mainY;
	doc.line(pdfMainBorderPAdding, mainY+2, pageWidth - 10, mainY+2 );
		
	mainY = mainY + lineSpace;
	
	let pi_billing_address = document.getElementById("pi_billing_address").value;
	
	let currentY = mainY+3;	
	// Set starting Y position
	const startY = currentY; // for vertical line
	const lineHeight = 4; // spacing between lines
    const piVendorName = document.getElementById("pi_vendorName1").value;
    const billingGSTNo = document.getElementById("pi_gstnumberr1").value;
    const pi_state = document.getElementById("pi_state").value;
    const pi_po_id = document.getElementById("po_number").value;
    const piInput = document.getElementById("pi_no");
    const pi_id = piInput && piInput.value ? piInput.value : "-";
    
    const pi_state_element = document.getElementById("pi_state");
    let pi_state_name = pi_state_element.selectedOptions[0].text;
    if (pi_state_name === "Select State") {
        pi_state_name = "";
    }    
    
	const pi_state_code = document.getElementById("pi_state_code").value;
    
	doc.setFont("helvetica","bold");
	doc.text("Details of Receiver / Billed to ", rectLeftX + 2, currentY);
	currentY += lineHeight;
	doc.setFont("helvetica","normal");
	
	doc.text("Name : ", rectLeftX + 2, currentY);
	
	
	//doc.text(piVendorName, rectLeftX + 13, currentY);
	//currentY += lineHeight;
	const maxNameTextWidth2 = (pageWidth / 2) - 30; 
	const wrappedName2 = doc.splitTextToSize(`${piVendorName}`, maxNameTextWidth2);
	
	doc.text(wrappedName2, rectLeftX + 13, currentY);
	
	//doc.text(piVendorName, centerX + 14, currentY);
	currentY += wrappedName2.length * lineHeight;
	
	
	
	// Address: wrap to fit page width
	const maxTextWidth = (pageWidth / 2) - 10; // half the page with margin
	const wrappedAddress = doc.splitTextToSize(`Address : ${pi_billing_address}`, maxTextWidth);
	
	let shippedADdress = document.getElementById("pi_shipping_address").value;
    
	doc.text(wrappedAddress, rectLeftX + 2, currentY);
	currentY += wrappedAddress.length * lineHeight;
	
	doc.text("GSTIN :", rectLeftX + 2, currentY);
	doc.text(`${billingGSTNo}`,rectLeftX + 14,currentY)
	currentY += lineHeight;
	
	doc.text(`State : ${pi_state_name}`, rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	doc.text(`State Code: ${pi_state_code}`, rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	doc.setFont("helvetica","bold");
	//centerX +2
	currentY = mainY+3;
	doc.text("Details of Consignee / Shipped to ", centerX +2, currentY);
	currentY += lineHeight;
	
	doc.setFont("helvetica","normal");
	doc.text("Name :", centerX +2, currentY);
	
	const maxNameTextWidth1 = (pageWidth / 2) - 30; 
	const wrappedName = doc.splitTextToSize(`${piVendorName}`, maxNameTextWidth1);
	
	doc.text(wrappedName, centerX + 14, currentY);
	
	//doc.text(piVendorName, centerX + 14, currentY);
	currentY += wrappedName.length * lineHeight;
	//currentY += lineHeight;
	
	// Wrap the address text
	const maxTextWidth1 = (pageWidth / 2) - 15; // Set max width to half page minus margins
	// alert(shippedADdress);
	const wrappedAddress1 = doc.splitTextToSize(`Address : ${shippedADdress}`, maxTextWidth1);
	
	doc.text(wrappedAddress1, centerX + 2, currentY);
	currentY += wrappedAddress1.length * lineHeight;
	
	doc.text(`GSTIN : ${billingGSTNo}`, centerX +2, currentY);
	currentY += lineHeight;
	doc.text(`State : ${pi_state_name}`, centerX +2, currentY);
	currentY += lineHeight;
	doc.text(`State Code: ${pi_state_code}`, centerX + 2, currentY);
	currentY += lineHeight;
	
	doc.line(pdfMainBorderPAdding, currentY, pageWidth - 10, currentY);
	doc.text(`PO No : ${pi_po_id}`,35,currentY+4);
	doc.text(`PI No : ${pi_id}`,130,currentY+4);
	
	// doc.line(5, currentY+4, pageWidth - 5, currentY+3);
	// Dynamically draw vertical line using final Y value between  / Billed to : AND / Shipped to :
	doc.line(centerX , startY - 5, centerX, currentY);
    
	// Move a little below the last line
	let tableY = currentY + 5.5;
	const startX = pdfMainBorderPAdding;
	const endX = pageWidth - pdfMainBorderPAdding;
	const tableRowHeight = 8;
	
	const cellPaddingX = 2; // Left padding
	const cellPaddingY = 2.5; // Top padding
	
	// Define column headers and their widths
	const columns = [
	  { title: "Sr. No", width: 16 },
	  { title: "Name of Products /Service", width: 81.5 },
	  { title: "HSN/ACS", width: 18.5	},
	  { title: "Qty", width: 20},
	  { title: "Rate", width: 25 },
	  { title: "Taxable Value", width: 29 },
	];

	// Draw table header
	doc.setFontSize(9);
	doc.setFont("helvetica", "bold");
	doc.setLineWidth(0.1); // Set thinner borders for table

	let currentX = startX;
	// Header
	columns.forEach(col => {
	
	  doc.rect(currentX, tableY, col.width, tableRowHeight + 2);
	  const lines = doc.splitTextToSize(col.title, col.width - cellPaddingX * 2);
	  lines.forEach((line, lineIndex) => {
		  const textWidth = doc.getTextWidth(line);
		  const textX = currentX + (col.width - textWidth) / 2;

		  const totalTextHeight = lines.length * lineHeight; // Approx vertical size
		  const baseY = tableY + (tableRowHeight - totalTextHeight) / 2 + (lineIndex * lineHeight) + 4;

		  doc.text(line, textX, baseY);
		});

	  currentX += col.width;
	});

	doc.setFont("helvetica", "normal");
	
	tableY += tableRowHeight + 2;
	const minRowCount = 5;
	const formatValue = (val) => val && !isNaN(val) ? parseFloat(val).toFixed(2) : "";
	const safe = (val) => val && val !== "null" ? val : "";

	const tableBody = document.querySelector("#pi_items_table tbody");
	const rows = tableBody.querySelectorAll("tr");

	rows.forEach((row, rowIndex) => {
	  const cells = row.querySelectorAll("input");
	  
	  const rowData = [
		  rowIndex + 1,                      // Sr. No
		  safe(cells[4].value),             // Module Name
		  safe(cells[3].value),             // HSN Code
		  safe(cells[5].value),             // Quantity
		  safe(cells[6].value),             // Price
		  formatValue(cells[7].value),      // Taxable Value
		];

		  // Determine how many lines max in this row
		  let maxLinesInRow = 1;
		  const cellLinesArray = rowData.map((cell, idx) => {
		    const col = columns[idx];
		    const lines = doc.splitTextToSize(cell.toString(), col.width - cellPaddingX * 2);
		    maxLinesInRow = Math.max(maxLinesInRow, lines.length);
		    return lines;
		  });

		  const tableRowHeight = maxLinesInRow * lineHeight;

		  let currentX = startX;
		  cellLinesArray.forEach((lines, idx) => {
			  const col = columns[idx];

			  // Draw cell
			  doc.rect(currentX, tableY, col.width, tableRowHeight + 2);

			  lines.forEach((line, lineIndex) => {
			    const textY = tableY + cellPaddingY + lineIndex * lineHeight + 2;

			    if ([0, 2, 3, 4, 5].includes(idx)) {
			      // Center align HSN, Qty, Price
			      doc.text(line, currentX + col.width / 2, textY, { align: 'center' });
			    } else {
			      // Default left align
			      doc.text(line, currentX + cellPaddingX, textY);
			    }
			  }); 
			  currentX += col.width;
			});

		  // Move down for next row
		  tableY += tableRowHeight + 2;
		  
		});

		// Add blank rows if needed
		const actualRowCount = rows.length;
		const emptyRowsToAdd = Math.max(0, minRowCount - actualRowCount);

		for (let i = 0; i < emptyRowsToAdd; i++) {
		  const tableRowHeight = lineHeight; // 1 line per empty row
		  let currentX = startX;

		  columns.forEach(col => {
		    doc.rect(currentX, tableY, col.width, tableRowHeight + 3);
		    currentX += col.width;
		  });

		  tableY += tableRowHeight + 3;
		}
		
	let totalPrice = 0;
	let totalTaxable = 0;
	let totalCGST = 0;
	let totalSGST = 0;
	let totalIGST = 0;
	let grandTotal = 0;
	
	let leftX = 107.5;
	let rightX = 200;

	let totalBeforeTax = 0;
	let totalGST = 0;
	let totalAfterGST = 0;
	let tcs = parseFloat(document.getElementById("summary-tcs").innerText) || 0.00;
	let finalTotal = 0;
	
	// First pass: Accumulate totals
	rows.forEach(row => {
	  const cells = row.querySelectorAll("input");

	  totalPrice += parseFloat(cells[6].value) || 0;
	  totalTaxable += parseFloat(cells[7].value) || 0;
	  totalCGST += parseFloat(cells[8].value) || 0;
	  totalSGST += parseFloat(cells[9].value) || 0;
	  totalIGST += parseFloat(cells[10].value) || 0;
	  grandTotal += parseFloat(cells[11].value) || 0;
	});
	
	totalBeforeTax = totalTaxable;
	totalGST = totalCGST + totalSGST + totalIGST;
	totalAfterGST = totalBeforeTax + totalGST;
	//tcs = parseFloat((totalAfterGST * 0.001).toFixed(2)); // 0.1% TCS
	finalTotal = totalAfterGST + tcs;
 
	tableY += tableRowHeight;
	// Footer content
	let footerY = tableY - 3;
	doc.setFontSize(9);
	doc.setFont("helvetica", "normal");

	// Bank Details and Terms
	doc.setFont("helvetica", "normal");
	
	// bank details rect
	doc.rect(pdfMainBorderPAdding, footerY - 5, 97.5, 55);
	
	doc.setFont("helvetica", "bold");
	doc.text("Bank Details :", pdfMainBorderPAdding + 2, footerY);
	doc.setFont("helvetica", "normal");
	doc.text("Bank Name : HDFC Bank ", pdfMainBorderPAdding + 2, footerY + 4);
	doc.text("Branch Name: BANGALORE - SESHADRIPURAM ",  pdfMainBorderPAdding+2, footerY + 8);
	doc.text("Bank Account Number : 03677630001106", pdfMainBorderPAdding+2, footerY + 12);
	doc.text("Bank Branch IFSC : HDFC0000367", pdfMainBorderPAdding+2, footerY + 16);
	
	footerY += 21;
	// Total in Words
	//doc.rect(pdfMainBorderPAdding, footerY , 97.5, 12);
	//doc.text("Total Invoice Amount in Words :", pdfMainBorderPAdding + 2, footerY+4);
	//doc.setFont("helvetica", "bold");
	
	const roundOffInDecimal = document.getElementById("summary-roundoff").innerText; 
	const netAmount = document.getElementById("summary-final").innerText;
	const grandTotalInWords = numberToWords(Math.round(netAmount));
	
	//const gstReverseCharge = document.getElementById("gst-reverse-charge").innerText;
	const gstReverseCharge = parseFloat(document.getElementById("gst-reverse-charge").value) || 0;
	 
	//doc.text(`Rupees ${grandTotalInWords}`, pdfMainBorderPAdding + 2, footerY + 7);
	
	footerY = footerY - 22;
	
	
	doc.line(leftX, footerY - 4 , rightX, footerY - 4 );
	// Total summary
	doc.text("Total Amount Before Tax: ", 110, footerY);
	doc.text(totalBeforeTax.toFixed(2), 195, footerY , { align: 'right' });
	doc.line(leftX, footerY + 1 , rightX, footerY + 1 );
	
	doc.text("CGST(9%):", 110, footerY + 5);
	doc.text(totalCGST.toFixed(2), 195, footerY + 5, { align: 'right' });
	doc.line(leftX, footerY + 6 , rightX, footerY + 6 );
	
	doc.text("SGST(9%):", 110, footerY + 10);
	doc.text(totalSGST.toFixed(2), 195, footerY + 10, { align: 'right' });
	doc.line(leftX, footerY + 11 , rightX, footerY + 11 );
	
	doc.text("IGST(18%):", 110, footerY + 15);
	doc.text(totalIGST.toFixed(2), 195, footerY + 15, { align: 'right' });
	doc.line(leftX, footerY + 16 , rightX, footerY + 16 );
	
	doc.text("Tax Amount : GST :", 110, footerY + 20);
	doc.text(totalGST.toFixed(2), 195, footerY + 20, { align: 'right' });
	doc.line(leftX, footerY + 21 , rightX, footerY + 21 );
	
	doc.text("Total Amount after GST and before TCS:", 110, footerY + 25);
	doc.text(totalAfterGST.toFixed(2), 195, footerY + 25, { align: 'right' });
	doc.line(leftX, footerY + 26 , rightX, footerY + 26 );
	
	doc.text("TCS @0.1%:", 110, footerY + 30);
	doc.text(tcs.toFixed(2), 195, footerY + 30, { align: 'right' });
	doc.line(leftX, footerY + 31 , rightX, footerY + 31 );
	
	doc.text("Total Amount After Tax:", 110, footerY + 35);
	doc.text(finalTotal.toFixed(2), 195, footerY + 35, { align: 'right' });
	doc.line(leftX, footerY + 36 , rightX, footerY + 36 );
	
	// GST Payable
	
	doc.text("GST Payable on Reverse Charges :", 110, footerY + 40);//gstReverseCharge
	doc.text(`${gstReverseCharge}`, 195, footerY + 40, { align: 'right' });
	doc.line(leftX, footerY + 41 , rightX, footerY + 41);  
	
	doc.text("Round off (in decimal):", 110, footerY + 45);//
	doc.text(`${roundOffInDecimal}`, 195, footerY + 45, { align: 'right' });
	doc.line(leftX, footerY + 46 , rightX, footerY + 46);  
	
	doc.setFont("helvetica", "bold");
	doc.text("Net Amount :", 110, footerY + 50);
	doc.text(`${netAmount}`, 195, footerY + 50, { align: 'right' });
	doc.line(leftX, footerY + 51 , rightX, footerY + 51);  
	
	footerY += 57.5;
	//Total Invoice Amount in words bottom border
	doc.line(pdfMainBorderPAdding, footerY, rightX, footerY );
	
	//footerY += 57.5;
	const footerSectionTopY = footerY;
	const footerSectionBottomY = pageHeight-22.5;
	const col2X = 107.5;
	const col3X = 142.5;
	
	// Draw vertical separators
	//doc.line(col2X, footerSectionTopY, col2X, footerSectionBottomY);
	
	//doc.text(`Total Invoice Amount in Words : ${grandTotalInWords}`, (pageWidth-20)/2, footerSectionTopY - 2);	
	doc.text(`Total Invoice Amount in Words : ${grandTotalInWords}`, pageWidth / 2, footerSectionTopY - 2, {
		  align: 'center'
		});

	//verticle lie between terms and condition  and QR
	doc.line(col3X, footerSectionTopY  , col3X, footerSectionBottomY);
 	
	// Stamp area (center)
	doc.setFont("helvetica", "italic");
	doc.text("", 108, footerY + 15); // optional placeholder
		
	// Signature block
	footerY += 10;
	doc.setFont("helvetica", "normal");
	
	// Terms and Conditions
	doc.setFont("helvetica", "normal");
	doc.text("Terms and Conditions :", pdfMainBorderPAdding + 2, footerY);
	doc.setFont("helvetica", "italic");
	doc.text("*Payment Terms :100% RTGS in Advance*", pdfMainBorderPAdding+2, footerY + 4);

	// Define rectangle dimensions
	const rectX = pdfMainBorderPAdding;
	const rectY = pageHeight-22.5;
	const rectWidth1 = pageWidth - 20; // full width minus margins
	const rectHeight1 = 4;

	// Draw the rectangle
	doc.rect(rectX, rectY, rectWidth1, rectHeight1);

	// Set font and center the text
	doc.setFont("helvetica", "normal");
	doc.text(
	  "Declaration: Certified That the Particulars Given Above are True and Correct.",
	  rectX + rectWidth1 / 2,
	  pageHeight-19,
	  { align: 'center' }
	);
	
	// Second rectangle (E.O. & E. and Jurisdiction)
	doc.rect(rectX, pageHeight-18.5, rectWidth1, rectHeight1);

	// Left aligned: E.O. & E.
	doc.text("E.O. & E.", rectX + 1, pageHeight-15);

	// Right aligned: Jurisdiction
	doc.text(
	  "Subject to Bangalore Jurisdiction Only",
	  rectX + rectWidth1 - 1,
	  pageHeight-15,
	  { align: 'right' }
	);
	
	doc.text("*This is a computer-generated invoice, no seal and signature required*",rectX + 45,pageHeight-11);
 	
}
    
async function generateInvoiceContentForUploadPDF(doc,copyIndex) {

	const { jsPDF } = window.jspdf;

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
	const pdfMainBorderPAdding = 10;
	const approveBy = document.getElementById("approveByAc").value;
	
	const invoiceNo = document.getElementById('pi_id').value;
 
	    // Encode the invoice ID for URL safety
	    const encodedInvoiceId = encodeURIComponent(invoiceNo);

	    // 1. Construct the full URL for viewing the invoice
	    const baseUrl = window.location.origin; // e.g., https://yourdomain.com or http://localhost:9376
		const qrText = `${baseUrl}/purchase-invoice/view-pdf?invoiceId=${encodedInvoiceId}`;

	    // 2. Generate QR code as Data URL
	    const qrDataUrl = await QRCode.toDataURL(qrText);

	    // 3. Add QR code image to the PDF
	    const qrX = pageWidth - 35; // Adjust position
	    const qrY = pageHeight - 46; // Adjust position
	    const qrSize = 25; // width & height

	    doc.addImage(qrDataUrl, 'PNG', qrX, qrY, qrSize, qrSize);

    // Add full-page border
    doc.setLineWidth(0.3);
    doc.rect(pdfMainBorderPAdding, pdfMainBorderPAdding, pageWidth - 20, pageHeight - 20);

    // Data from form
    const poNumber = document.getElementById('po_number').value;
    const poDate = document.getElementById('pi_date').value;
    const vendorCode = document.getElementById('pi_vendor_code').value;

    // Header
    let yAxis = pdfMainBorderPAdding + 5;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text("Melange Systems Private Limited.", pdfMainBorderPAdding +2, yAxis);
    doc.setFontSize(9);
    yAxis += 5;
    doc.setFont("helvetica","normal");
    doc.text("No. 4/1, 7th Cross, Kumara Park West, Bangalore 560020", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.text("Tel: 080-2356 1023, Telefax: 080-2346 2175", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.setFont("helvetica", "bold");
    doc.text("GSTIN: 29AACCM4737H1ZA, CIN: U72200KA2000PTC027922", pdfMainBorderPAdding+2 , yAxis);
    yAxis += 5;
    doc.text("Udyam Registration Number: UDYAM-KR-03-0101576", pdfMainBorderPAdding+2 , yAxis);
    
    // âœ… Add Company Logo (Right Side)
   	let logo = new Image();
    logo.src = "/assets/img/compressed_logo.png";
    // logo.onload = function () {
    doc.addImage(logo, "PNG", 140,  pdfMainBorderPAdding + 5, 50, 14); // (image, type, x, y, width, height)        

    // Draw horizontal line below header
    yAxis += 2;
    doc.setLineWidth(0.1); // thinner line
    
    // Rectangle with 3 columns below the header line
    const rectTopY = yAxis; // start a bit below the line
    const rectHeight = 16; // adjust height as needed (this height gives more space for rows)
    const rectLeftX = 10;
    const rectRightX = pageWidth - 10;
    const rectWidth = rectRightX - rectLeftX;
         
    // Column widths based on percentages, making sure they add up to 100%
    const col1Width = rectWidth * 0.70; // 50% width for column 1
    const col2Width = rectWidth * 0.08; // 30% width for column 2
    const col3Width = rectWidth * 0.22; // 20% width for column 3

    doc.setFont("helvetica","normal");
    doc.setLineWidth(0.05); // thinner line

    // Draw outer rectangle
    doc.rect(rectLeftX, rectTopY, rectWidth, rectHeight);

    // Draw Place of Supply:vertical lines for columns
    doc.line(rectLeftX + col1Width - 2, rectTopY, rectLeftX + col1Width - 2, rectTopY + rectHeight); // Line between col1 and col2
    doc.line(rectLeftX + col1Width + col2Width - 4, rectTopY, rectLeftX + col1Width + col2Width - 4, rectTopY + rectHeight); // Line between col2 and col3

    // Draw horizontal lines to create 3 rows in col2 and col3
    const rowHeight = (rectHeight / 3) ; // divide rect height into 3 rows
    doc.line(rectLeftX + col1Width - 2, rectTopY + rowHeight, rectRightX , rectTopY + rowHeight); // Row 1 horizontal line
    doc.line(rectLeftX + col1Width - 2, rectTopY + 2 * rowHeight, rectRightX, rectTopY + 2 * rowHeight); // Row 2 horizontal line

 	// Invoice title
    doc.setFontSize(14);
    doc.setFont("helvetica","bold");
    doc.text("TAX INVOICE", rectLeftX + col1Width / 2, rectTopY + rectHeight - 6, { align: 'center' });
    
     // Optional: headers
     doc.setFontSize(9);
     doc.setFont("helvetica","normal");
     
	 // Text for Column 2 rows
	 /* doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 0.5, { align: 'center' });
	 doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 1.5, { align: 'center' });
	 doc.text("", rectLeftX + col1Width + col2Width / 2, rectTopY + rowHeight * 2.5, { align: 'center' });  
	 */
	 
	  const tickX = rectLeftX + col1Width + col2Width / 2;
	  const tickY = rectTopY + rowHeight * copyIndex + 0.2;
	  const tickBase64 =  "data:image/png;base64,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";
	  
	  doc.addImage(tickBase64, 'PNG', tickX - 5, tickY, 5, 5);

	  //doc.addImage(tickBase64, tickX, tickY, { align: 'center' });
	  
	 // Text for Column 3 rows
	doc.text("Original for Recipient", rectLeftX + col1Width + col2Width - 2, rectTopY + rowHeight * 0.5 + 1.2);
	doc.text("Duplicate Supplier/Transporter", rectLeftX + col1Width + col2Width - 2, rectTopY + rowHeight * 1.5 + 1.2);
	doc.text("Triplicate for Supplier", rectLeftX + col1Width + col2Width - 2, rectTopY + rowHeight * 2.5 + 1.2);

	let mainY = rectTopY + 16;
	let lineSpace=4;
	let verticleLine = mainY+12;
	const piNo = document.getElementById('pi_id').value;
	const invoice_date = document.getElementById('pidateTime').value;
	const formattedPIDate = formatDateToDDMMYYYY(invoice_date);
	const stateCode = "";
	
	mainY = mainY + lineSpace;
	
	doc.text(`Invoice No. :${piNo}`,rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text(`Invoice Date: ${invoice_date}`,rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text("State: Karnataka",rectLeftX+2,mainY);
	mainY = mainY + lineSpace;
	
	doc.text("State Code : 29",rectLeftX+2,mainY);
	
	mainY = rectTopY + 22; //resent the mainY to display vendorcode from begining again
	
	// verticle line
	//right rect
	const rightRectWidth = 110;
	const rightRectX = pageWidth - 5 - rightRectWidth; // 5mm margin from the right edge
	
	// Vertical line between left and right sections
	const centerX = (rectLeftX + (pageWidth - 5)) / 2;
	doc.line(centerX, mainY - 6, centerX, mainY + 18);
	
	//doc.rect(,mainY - 4);
	//doc.line(verticalLineX, mainY - 2, verticalLineX, mainY + 18); // Y range can be adjusted as needed
	const pi_vendor_code = document.getElementById("pi_vendor_code").value;
	const trasnportMode = document.getElementById('pi_transportMode').value;
	const vehicleNo = document.getElementById('pi_vehicle_No').value;
	const dateOfSypply = document.getElementById('pidateTime').value;
	const placeToSupply = document.getElementById('pi_supply_place').value;
	
	mainY = 57;
	doc.text(`Vendor Code: ${pi_vendor_code}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Transportation Mode : ${trasnportMode}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Vehicle Number: ${vehicleNo}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Date of Supply: ${dateOfSypply}`,centerX +2,mainY);
	mainY = mainY + lineSpace;
	doc.text(`Place of Supply: ${placeToSupply}`,centerX +2,mainY);
	
	// Horizontal line below "Place of Supply:"
	doc.setLineWidth(0.1); // Optional: adjust line thickness
	//doc.line(pdfMainBorderPAdding, mainY+2, pageWidth - 10, mainY+2);
	mainY = mainY;
	doc.line(pdfMainBorderPAdding, mainY+2, pageWidth - 10, mainY+2 );
		
	mainY = mainY + lineSpace;
	
	let pi_billing_address = document.getElementById("pi_billing_address").value;
	
	let currentY = mainY+3;	
	// Set starting Y position
	const startY = currentY; // for vertical line
	const lineHeight = 4; // spacing between lines
    const piVendorName = document.getElementById("pi_vendorName1").value;
    const billingGSTNo = document.getElementById("pi_gstnumberr1").value;
    const pi_state = document.getElementById("pi_state").value;
    const pi_po_id = document.getElementById("po_number").value;
    const piInput = document.getElementById("pi_no");
    const pi_id = piInput && piInput.value ? piInput.value : "-";
    
    const pi_state_element = document.getElementById("pi_state");
    let pi_state_name = pi_state_element.selectedOptions[0].text;
    if (pi_state_name === "Select State") {
        pi_state_name = "";
    }    
    
	const pi_state_code = document.getElementById("pi_state_code").value;
    
	doc.setFont("helvetica","bold");
	doc.text("Details of Receiver / Billed to ", rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	doc.setFont("helvetica","normal");
	doc.text("Name : ", rectLeftX + 2, currentY);
	
	
	// doc.text(piVendorName, rectLeftX + 13, currentY);
	// currentY += lineHeight;
	const maxNameTextWidth2 = (pageWidth / 2) - 30; 
	const wrappedName2 = doc.splitTextToSize(`${piVendorName}`, maxNameTextWidth2);
	
	doc.text(wrappedName2, rectLeftX + 13, currentY);
	
	//doc.text(piVendorName, centerX + 14, currentY);
	currentY += wrappedName2.length * lineHeight;
	
	// Address: wrap to fit page width
	const maxTextWidth = (pageWidth / 2) - 10; // half the page with margin
	const wrappedAddress = doc.splitTextToSize(`Address : ${pi_billing_address}`, maxTextWidth);
	
	let shippedADdress = document.getElementById("pi_shipping_address").value;
    
	doc.text(wrappedAddress, rectLeftX + 2, currentY);
	currentY += wrappedAddress.length * lineHeight;
	
	doc.text("GSTIN :", rectLeftX + 2, currentY);
	doc.text(`${billingGSTNo}`,rectLeftX + 14,currentY)
	currentY += lineHeight;
	
	doc.text(`State : ${pi_state_name}`, rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	doc.text(`State Code: ${pi_state_code}`, rectLeftX + 2, currentY);
	currentY += lineHeight;
	
	doc.setFont("helvetica","bold");
	//centerX +2
	currentY = mainY+3;
	doc.text("Details of Consignee / Shipped to ", centerX +2, currentY);
	currentY += lineHeight;
	
	doc.setFont("helvetica","normal");
	doc.text("Name :", centerX +2, currentY);
	//doc.text(piVendorName, centerX + 14, currentY);
	//currentY += lineHeight;
	
	const maxNameTextWidth1 = (pageWidth / 2) - 30; 
	const wrappedName = doc.splitTextToSize(`${piVendorName}`, maxNameTextWidth1);
	
	doc.text(wrappedName, centerX + 14, currentY);
	
	//doc.text(piVendorName, centerX + 14, currentY);
	currentY += wrappedName.length * lineHeight;
	
	// Wrap the address text
	const maxTextWidth1 = (pageWidth / 2) - 15; // Set max width to half page minus margins
	// alert(shippedADdress);
	const wrappedAddress1 = doc.splitTextToSize(`Address : ${shippedADdress}`, maxTextWidth1);
	
	doc.text(wrappedAddress1, centerX + 2, currentY);
	currentY += wrappedAddress1.length * lineHeight;
	
	doc.text(`GSTIN : ${billingGSTNo}`, centerX +2, currentY);
	currentY += lineHeight;
	doc.text(`State : ${pi_state_name}`, centerX +2, currentY);
	currentY += lineHeight;
	doc.text(`State Code: ${pi_state_code}`, centerX + 2, currentY);
	currentY += lineHeight;
	
	doc.line(pdfMainBorderPAdding, currentY, pageWidth - 10, currentY);
	doc.text(`PO No : ${pi_po_id}`,35,currentY+4);
	doc.text(`PI No : ${pi_id}`,130,currentY+4);
	
	// doc.line(5, currentY+4, pageWidth - 5, currentY+3);
	// Dynamically draw vertical line using final Y value between  / Billed to : AND / Shipped to :
	doc.line(centerX , startY - 5, centerX, currentY);
    
	// Move a little below the last line
	let tableY = currentY + 5.5;
	const startX = pdfMainBorderPAdding;
	const endX = pageWidth - pdfMainBorderPAdding;
	const tableRowHeight = 8;
	
	const cellPaddingX = 2; // Left padding
	const cellPaddingY = 2.5; // Top padding
	
	// Define column headers and their widths
	const columns = [
	  { title: "Sr. No", width: 16 },
	  { title: "Name of Products /Service", width: 81.5 },
	  { title: "HSN/ACS", width: 18.5	},
	  { title: "Qty", width: 20},
	  { title: "Rate", width: 25 },
	  { title: "Taxable Value", width: 29 },
	];

	// Draw table header
	doc.setFontSize(9);
	doc.setFont("helvetica", "bold");
	doc.setLineWidth(0.1); // Set thinner borders for table

	let currentX = startX;
	// Header
	columns.forEach(col => {
	
	  doc.rect(currentX, tableY, col.width, tableRowHeight + 2);
	  const lines = doc.splitTextToSize(col.title, col.width - cellPaddingX * 2);
	  lines.forEach((line, lineIndex) => {
		  const textWidth = doc.getTextWidth(line);
		  const textX = currentX + (col.width - textWidth) / 2;

		  const totalTextHeight = lines.length * lineHeight; // Approx vertical size
		  const baseY = tableY + (tableRowHeight - totalTextHeight) / 2 + (lineIndex * lineHeight) + 4;

		  doc.text(line, textX, baseY);
		});

	  currentX += col.width;
	});

	doc.setFont("helvetica", "normal");
	tableY += tableRowHeight + 2;
	const minRowCount = 5;
	const formatValue = (val) => val && !isNaN(val) ? parseFloat(val).toFixed(2) : "";
	const safe = (val) => val && val !== "null" ? val : "";

	const tableBody = document.querySelector("#pi_items_table tbody");
	const rows = tableBody.querySelectorAll("tr");

	rows.forEach((row, rowIndex) => {
	  const cells = row.querySelectorAll("input");
	  
	  const rowData = [
		  rowIndex + 1,                      // Sr. No
		  safe(cells[4].value),             // Module Name
		  safe(cells[3].value),             // HSN Code
		  safe(cells[5].value),             // Quantity
		  safe(cells[6].value),             // Price
		  formatValue(cells[7].value),      // Taxable Value
		];

		  // Determine how many lines max in this row
		  let maxLinesInRow = 1;
		  const cellLinesArray = rowData.map((cell, idx) => {
		    const col = columns[idx];
		    const lines = doc.splitTextToSize(cell.toString(), col.width - cellPaddingX * 2);
		    maxLinesInRow = Math.max(maxLinesInRow, lines.length);
		    return lines;
		  });

		  const tableRowHeight = maxLinesInRow * lineHeight;

		  let currentX = startX;
		  cellLinesArray.forEach((lines, idx) => {
			  const col = columns[idx];

			  // Draw cell
			  doc.rect(currentX, tableY, col.width, tableRowHeight + 2);

			  lines.forEach((line, lineIndex) => {
			    const textY = tableY + cellPaddingY + lineIndex * lineHeight + 2;

			    if ([0, 2, 3, 4, 5].includes(idx)) {
			      // Center align HSN, Qty, Price
			      doc.text(line, currentX + col.width / 2, textY, { align: 'center' });
			    } else {
			      // Default left align
			      doc.text(line, currentX + cellPaddingX, textY);
			    }
			  }); 
			  currentX += col.width;
			});

		  // Move down for next row
		  tableY += tableRowHeight + 2;
		  
		});

		// Add blank rows if needed
		const actualRowCount = rows.length;
		const emptyRowsToAdd = Math.max(0, minRowCount - actualRowCount);

		for (let i = 0; i < emptyRowsToAdd; i++) {
		  const tableRowHeight = lineHeight; // 1 line per empty row
		  let currentX = startX;

		  columns.forEach(col => {
		    doc.rect(currentX, tableY, col.width, tableRowHeight + 3);
		    currentX += col.width;
		  });

		  tableY += tableRowHeight + 3;
		}
		
	let totalPrice = 0;
	let totalTaxable = 0;
	let totalCGST = 0;
	let totalSGST = 0;
	let totalIGST = 0;
	let grandTotal = 0;
	
	let leftX = 107.5;
	let rightX = 200;

	let totalBeforeTax = 0;
	let totalGST = 0;
	let totalAfterGST = 0;
	let tcs = parseFloat(document.getElementById("summary-tcs").innerText) || 0.00;
	let finalTotal = 0;
	
	// First pass: Accumulate totals
	rows.forEach(row => {
	  const cells = row.querySelectorAll("input");

	  totalPrice += parseFloat(cells[6].value) || 0;
	  totalTaxable += parseFloat(cells[7].value) || 0;
	  totalCGST += parseFloat(cells[8].value) || 0;
	  totalSGST += parseFloat(cells[9].value) || 0;
	  totalIGST += parseFloat(cells[10].value) || 0;
	  grandTotal += parseFloat(cells[11].value) || 0;
	});
	
	totalBeforeTax = totalTaxable;
	totalGST = totalCGST + totalSGST + totalIGST;
	totalAfterGST = totalBeforeTax + totalGST;
	//tcs = parseFloat((totalAfterGST * 0.001).toFixed(2)); // 0.1% TCS
	finalTotal = totalAfterGST + tcs;
 
	tableY += tableRowHeight;
	// Footer content
	let footerY = tableY - 3;
	doc.setFontSize(9);
	doc.setFont("helvetica", "normal");

	// Bank Details and Terms
	doc.setFont("helvetica", "normal");
	
	// bank details rect
	doc.rect(pdfMainBorderPAdding, footerY - 5, 97.5, 55);
	
	doc.setFont("helvetica", "bold");
	doc.text("Bank Details :", pdfMainBorderPAdding + 2, footerY);
	doc.setFont("helvetica", "normal");
	doc.text("Bank Name : HDFC Bank ", pdfMainBorderPAdding + 2, footerY + 4);
	doc.text("Branch Name: BANGALORE - SESHADRIPURAM ",  pdfMainBorderPAdding+2, footerY + 8);
	doc.text("Bank Account Number : 03677630001106", pdfMainBorderPAdding+2, footerY + 12);
	doc.text("Bank Branch IFSC : HDFC0000367", pdfMainBorderPAdding+2, footerY + 16);
	
	footerY += 21;
	// Total in Words
	//doc.rect(pdfMainBorderPAdding, footerY , 97.5, 12);
	//doc.text("Total Invoice Amount in Words :", pdfMainBorderPAdding + 2, footerY+4);
	//doc.setFont("helvetica", "bold");
	
	const roundOffInDecimal = document.getElementById("summary-roundoff").innerText; 
	const netAmount = document.getElementById("summary-final").innerText;
	const grandTotalInWords = numberToWords(Math.round(netAmount));
	
	//const gstReverseCharge = document.getElementById("gst-reverse-charge").innerText;
	const gstReverseCharge = parseFloat(document.getElementById("gst-reverse-charge").value) || 0;
	 
	//doc.text(`Rupees ${grandTotalInWords}`, pdfMainBorderPAdding + 2, footerY + 7);
	
	footerY = footerY - 22;
	
	doc.line(leftX, footerY - 4 , rightX, footerY - 4 );
	// Total summary
	doc.text("Total Amount Before Tax: ", 110, footerY);
	doc.text(totalBeforeTax.toFixed(2), 195, footerY , { align: 'right' });
	doc.line(leftX, footerY + 1 , rightX, footerY + 1 );
	
	doc.text("CGST(9%):", 110, footerY + 5);
	doc.text(totalCGST.toFixed(2), 195, footerY + 5, { align: 'right' });
	doc.line(leftX, footerY + 6 , rightX, footerY + 6 );
	
	doc.text("SGST(9%):", 110, footerY + 10);
	doc.text(totalSGST.toFixed(2), 195, footerY + 10, { align: 'right' });
	doc.line(leftX, footerY + 11 , rightX, footerY + 11 );
	
	doc.text("IGST(18%):", 110, footerY + 15);
	doc.text(totalIGST.toFixed(2), 195, footerY + 15, { align: 'right' });
	doc.line(leftX, footerY + 16 , rightX, footerY + 16 );
	
	doc.text("Tax Amount : GST :", 110, footerY + 20);
	doc.text(totalGST.toFixed(2), 195, footerY + 20, { align: 'right' });
	doc.line(leftX, footerY + 21 , rightX, footerY + 21 );
	
	doc.text("Total Amount after GST and before TCS:", 110, footerY + 25);
	doc.text(totalAfterGST.toFixed(2), 195, footerY + 25, { align: 'right' });
	doc.line(leftX, footerY + 26 , rightX, footerY + 26 );
	
	doc.text("TCS @0.1%:", 110, footerY + 30);
	doc.text(tcs.toFixed(2), 195, footerY + 30, { align: 'right' });
	doc.line(leftX, footerY + 31 , rightX, footerY + 31 );
	
	doc.text("Total Amount After Tax:", 110, footerY + 35);
	doc.text(finalTotal.toFixed(2), 195, footerY + 35, { align: 'right' });
	doc.line(leftX, footerY + 36 , rightX, footerY + 36 );
	
	// GST Payable
	
	doc.text("GST Payable on Reverse Charges :", 110, footerY + 40);//gstReverseCharge
	doc.text(`${gstReverseCharge}`, 195, footerY + 40, { align: 'right' });
	doc.line(leftX, footerY + 41 , rightX, footerY + 41);  
	
	doc.text("Round off (in decimal):", 110, footerY + 45);//
	doc.text(`${roundOffInDecimal}`, 195, footerY + 45, { align: 'right' });
	doc.line(leftX, footerY + 46 , rightX, footerY + 46);  
	
	doc.setFont("helvetica", "bold");
	doc.text("Net Amount :", 110, footerY + 50);
	doc.text(`${netAmount}`, 195, footerY + 50, { align: 'right' });
	doc.line(leftX, footerY + 51 , rightX, footerY + 51);  
	
	footerY += 57.5;
	//Total Invoice Amount in words bottom border
	doc.line(pdfMainBorderPAdding, footerY, rightX, footerY );
	
	//footerY += 57.5;
	const footerSectionTopY = footerY;
	const footerSectionBottomY = pageHeight-22.5;
	const col2X = 107.5;
	const col3X = 142.5;
	
	// Draw vertical separators
	//doc.line(col2X, footerSectionTopY, col2X, footerSectionBottomY);
	
	//doc.text(`Total Invoice Amount in Words : ${grandTotalInWords}`, (pageWidth-20)/2, footerSectionTopY - 2);	
	doc.text(`Total Invoice Amount in Words : ${grandTotalInWords}`, pageWidth / 2, footerSectionTopY - 2, {
		  align: 'center'
		});

	//verticle lie between terms and condition  and QR
	doc.line(col3X, footerSectionTopY  , col3X, footerSectionBottomY);
 	
	// Stamp area (center)
	doc.setFont("helvetica", "italic");
	doc.text("", 108, footerY + 15); // optional placeholder
		
	// Signature block
	footerY += 10;
	doc.setFont("helvetica", "normal");
	 
	
	// Terms and Conditions
	doc.setFont("helvetica", "normal");
	doc.text("Terms and Conditions :", pdfMainBorderPAdding + 2, footerY);
	doc.setFont("helvetica", "italic");
	doc.text("*Payment Terms :100% RTGS in Advance*", pdfMainBorderPAdding+2, footerY + 4);

	// Define rectangle dimensions
	const rectX = pdfMainBorderPAdding;
	const rectY = pageHeight-22.5;
	const rectWidth1 = pageWidth - 20; // full width minus margins
	const rectHeight1 = 4;

	// Draw the rectangle
	doc.rect(rectX, rectY, rectWidth1, rectHeight1);

	// Set font and center the text
	doc.setFont("helvetica", "normal");
	doc.text(
	  "Declaration: Certified That the Particulars Given Above are True and Correct.",
	  rectX + rectWidth1 / 2,
	  pageHeight-19,
	  { align: 'center' }
	);
	
	// Second rectangle (E.O. & E. and Jurisdiction)
	doc.rect(rectX, pageHeight-18.5, rectWidth1, rectHeight1);

	// Left aligned: E.O. & E.
	doc.text("E.O. & E.", rectX + 1, pageHeight-15);

	// Right aligned: Jurisdiction
	doc.text(
	  "Subject to Bangalore Jurisdiction Only",
	  rectX + rectWidth1 - 1,
	  pageHeight-15,
	  { align: 'right' }
	);
	
	doc.text("*This is a computer-generated invoice, no seal and signature required*",rectX + 45,pageHeight-11);
 	
	// Show PDF
    //window.open(doc.output('bloburl'), '_blank');

}

//function to convert date formate
function formatDateToDDMMYYYY(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is zero-based
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
}

function numberToWords(num) {
    const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
    const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen",
                   "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

    function twoDigits(n) {
        if (n < 10) return ones[n];
        if (n < 20) return teens[n - 10];
        return tens[Math.floor(n / 10)] + (n % 10 ? " " + ones[n % 10] : "");
    }

    function threeDigits(n) {
        if (n < 100) return twoDigits(n);
        return ones[Math.floor(n / 100)] + " Hundred" + (n % 100 ? " " + twoDigits(n % 100) : "");
    }

    if (num === 0) return "Zero Only";

    let result = "";

    const crore = Math.floor(num / 10000000);
    num %= 10000000;
    if (crore) result += threeDigits(crore) + " Crore ";

    const lakh = Math.floor(num / 100000);
    num %= 100000;
    if (lakh) result += threeDigits(lakh) + " Lakh ";

    const thousand = Math.floor(num / 1000);
    num %= 1000;
    if (thousand) result += threeDigits(thousand) + " Thousand ";

    if (num > 0) {
        if (result !== "" && num < 100) {
            result += "and ";
        }
        result += threeDigits(num);
    }

    const rupeeWord = "Rupees ";

    return rupeeWord + result.trim() + " Only";
}


</script>

<!-- script to state code -->
<script>
  function setStateCode() {
	 
    const select = document.getElementById("pi_state");
    const codeInput = document.getElementById("pi_state_code");
    codeInput.value = select.value;
    
  }
</script>


</body>
</html>