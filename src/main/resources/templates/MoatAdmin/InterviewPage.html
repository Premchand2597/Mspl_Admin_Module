<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>

  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Interview</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
<!--   <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
 -->
   <link rel="stylesheet" href="/assets/font/fonts.css"> 
  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
  <!-- Template Main JS File -->
  <!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->  
  <script src="assets/js/jquery-3.6.4.min.js"></script> 

  <!-- SweetAlert2 Library -->
  <!--  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
  <script src="assets/js/sweetalert2@11.js"></script>
  
    <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <style>
   .table-container {
            max-height: 345px; /* Adjust as needed */
            overflow-y: auto;
            border-radius: 4px;
            position: relative;
        }

        .table-container thead {
            position: sticky;
            top: 0;
            background-color: #f8f9fa; /* Light background for the header */
            z-index: 1; /* Ensure the header is above the scrolling content */
        }

        .table-container::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1; /* Track color */
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888; /* Scrollbar color */
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555; /* Hover color */
        }
        .form-label{
        	font-size: 0.9rem;
        }
  </style> 
</head>
<body>
  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center" style="width:100%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/hrDashboard}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px; max-width:100%; padding:0 2px 0 10px; margin:0;">
				    </a>
				    <i class="bi bi-list toggle-sidebar-btn"></i>
	</div><!-- End Logo -->

    <!-- <div class="search-bar">
      <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Search" title="Enter search keyword">
        <button type="submit" title="Search"><i class="bi bi-search"></i></button>
      </form>
    </div> --><!-- End Search Bar -->

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
          <a class="nav-link nav-icon search-bar-toggle " href="#">
            <i class="bi bi-search"></i>
          </a>
        </li><!-- End Search Icon-->

        <li class="nav-item dropdown">

          <a class="nav-link nav-icon" id="bellIcon" href="#" data-bs-toggle="dropdown" style="display: none;">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number" id="notificationCount"></span>
          </a><!-- End Notification Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications" style="width: 300px;">
            <!-- <li class="dropdown-header">
              <span id="notificationHeaderMessage"></span>
              <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li> -->
            
            <li class="notification-item" id="emptyNotifyDiv" style="display: none;">
              <i class="bi bi-exclamation-circle text-warning"></i>
              <div>
                <h4>Relax</h4>
                <p id="emptyNotificationHeaderMessage"></p>
              </div>
            </li>

            <li id="emptyNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->

            <li class="notification-item" id="leaveRequestNotifyDiv" style="display: none;">
              <i class="bi bi-chat-left-dots text-warning"></i>
              <a href="leaveRequests">
	              <div>
	                <h4 id="leaveNotificationNumberHeader"></h4>
	                <p class="mb-3" id="leaveNotificationMessage"></p>
	              </div>
              </a>
            </li>

            <li id="leaveRequestNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
            
            <li class="notification-item" id="moatNewCandidateNotifyDiv" style="display: none;">
              <i class="bi bi-card-text text-primary"></i>
              <a href="totalCandidatesList">
	              <div>
	                <h4 id="moatNewCandidateNumberHeader"></h4>
	                <p class="mb-3" id="moatNewCandidateNotificationMessage"></p>
	              </div>
              </a>
            </li>

            <li id="moatNewCandidateNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
            
            <li class="notification-item" id="moatSelectedCandidateNotifyDiv" style="display: none;">
              <i class="bi bi-check2-square text-success"></i>
              <a href="selectedCandidatesList">
	              <div>
	                <h4 id="moatSelectedCandidateNumberHeader"></h4>
	                <p class="mb-3" id="moatSelectedCandidateNotificationMessage"></p>
	              </div> 
              </a>
            </li>

            <li id="moatSelectedCandidateNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->

			<li class="notification-item" id="moatRejectedCandidateNotifyDiv" style="display: none;">
              <i class="bi bi-x-square text-danger"></i>
              <a href="rejectedCandidatesList">
	              <div>
	                <h4 id="moatRejectedCandidateNumberHeader"></h4>
	                <p class="mb-3" id="moatRejectedCandidateNotificationMessage"></p>
	              </div> 
              </a>
            </li>

            <li id="moatRejectedCandidateNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
            
            <li class="notification-item" id="q1AppraisalNotifyDiv" style="display: none;">
              <i class="bi bi-card-text text-primary"></i>
              <a href="employeeForm">
	              <div>
	                <h4 id="q1AppraisalNumberHeader"></h4>
	                <p class="mb-3" id="q1AppraisalNotificationMessage"></p>
	              </div> 
              </a>
            </li>

            <li id="q1AppraisalNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
            
            <li class="notification-item" id="q2AppraisalNotifyDiv" style="display: none;">
              <i class="bi bi-card-text text-primary"></i>
              <a href="employeeForm">
	              <div>
	                <h4 id="q2AppraisalNumberHeader"></h4>
	                <p class="mb-3" id="q2AppraisalNotificationMessage"></p>
	              </div> 
              </a>
            </li>

            <li id="q2AppraisalNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
            
            <li class="notification-item" id="q3AppraisalNotifyDiv" style="display: none;">
              <i class="bi bi-card-text text-primary"></i>
              <a href="employeeForm">
	              <div>
	                <h4 id="q3AppraisalNumberHeader"></h4>
	                <p class="mb-3" id="q3AppraisalNotificationMessage"></p>
	              </div> 
              </a>
            </li>

            <li id="q3AppraisalNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
            
            <li class="notification-item" id="q4AppraisalNotifyDiv" style="display: none;">
              <i class="bi bi-card-text text-primary"></i>
              <a href="employeeForm">
	              <div>
	                <h4 id="q4AppraisalNumberHeader"></h4>
	                <p class="mb-3" id="q4AppraisalNotificationMessage"></p>
	              </div> 
              </a>
            </li>

            <li id="q4AppraisalNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
            
            <li class="notification-item" id="appraisalSubmittedNotifyDiv" style="display: none;">
              <i class="bi bi-card-text text-success"></i>
              <a href="apprisalEmployee">
	              <div>
	                <h4 id="appraisalSubmittedNumberHeader"></h4>
	                <p class="mb-3" id="appraisalSubmittedNotificationMessage"></p>
	              </div> 
              </a>
            </li>

            <li id="appraisalSubmittedNotifyDivHorizontalRow" style="display: none;">
              <hr class="dropdown-divider">
            </li>
            
            <!-- ----------------------------------------------------------------------------------------------------- -->
			
          </ul><!-- End Notification Dropdown Items -->

        </li><!-- End Notification Nav -->

        <li class="nav-item dropdown">

          <!-- <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-chat-left-text"></i>
            <span class="badge bg-success badge-number">3</span>
          </a> --><!-- End Messages Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow messages">
            <li class="dropdown-header">
              You have 3 new messages
              <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="message-item">
              <a href="#">
                <img src="assets/img/messages-1.jpg" alt="" class="rounded-circle">
                <div>
                  <h4>Maria Hudson</h4>
                  <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                  <p>4 hrs. ago</p>
                </div>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="message-item">
              <a href="#">
                <img src="assets/img/messages-2.jpg" alt="" class="rounded-circle">
                <div>
                  <h4>Anna Nelson</h4>
                  <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                  <p>6 hrs. ago</p>
                </div>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="message-item">
              <a href="#">
                <img src="assets/img/messages-3.jpg" alt="" class="rounded-circle">
                <div>
                  <h4>David Muldon</h4>
                  <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                  <p>8 hrs. ago</p>
                </div>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="dropdown-footer">
              <a href="#">Show all messages</a>
            </li>

          </ul><!-- End Messages Dropdown Items -->

        </li><!-- End Messages Nav -->

        <li class="nav-item dropdown pe-3">

          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="" id="dynamicProfilePic" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" th:text="${session.empDetailsByEmpId.fullName}"></span>
          </a><!-- End Profile Iamge Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
             <li class="dropdown-header">
              <h6 th:text="${session.empDetailsByEmpId.fullName}"></h6>
              <span th:text="${session.empDetailsByEmpId.roleName}"></span>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <a class="dropdown-item d-flex align-items-center" th:href="@{/viewProfile(empid=${session.empDetailsByEmpId.empid})}">
                <i class="bi bi-person"></i>
                <span>My Profile</span>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <!-- <li>
              <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                <i class="bi bi-gear"></i>
                <span>Account Settings</span>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <a class="dropdown-item d-flex align-items-center" href="pages-faq.html">
                <i class="bi bi-question-circle"></i>
                <span>Need Help?</span>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li> -->

            <li>
              <a class="dropdown-item d-flex align-items-center" th:href="@{/}">
                <i class="bi bi-box-arrow-right"></i>
                <span>Sign Out</span>
              </a>
            </li>

          </ul><!-- End Profile Dropdown Items -->
        </li><!-- End Profile Nav -->

      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
<aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item">
            <a class="nav-link" onclick="displayOnLoadingPopup();" th:href="@{/hrDashboard}">
                <i class="bi bi-grid"></i>
                <span>Dashboard</span>
            </a>
        </li>
        <!-- Loop through the permissions map -->
       <li class="nav-item" th:if="${session.permissions.Interview}">
            <a class="nav-link active" onclick="displayOnLoadingPopup();" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
        </li>
         <li class="nav-item new-feature">
			    <a class="nav-link collapsed" data-bs-target="#presales-submenu" data-bs-toggle="collapse" href="#">
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Pre-sales</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a> 
			    <ul id="presales-submenu" class="nav-content collapse" data-bs-parent="#sidebar-nav">
			        <li>
			            <a th:href="@{/crm}">
			                <i class="bi bi-circle"></i><span>Activity</span>
			            </a>
			        </li>
			        <li>
			            <a th:href="@{/deals}">
			                <i class="bi bi-circle"></i><span>Pipedrive</span>
			            </a>
			        </li>
			    </ul>
			</li>
       <!--  <li class="nav-item" th:if="${session.permissions.Sales}">
            <a class="nav-link" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
        
          <li class="nav-item" th:if="${session.permissions.accounts}">
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>
        
        <li class="nav-item" th:if="${session.permissions.store}">
            <a class="nav-link" th:href="@{/store}">
                <i class="bi bi-shop-window"></i>
                <span>Store</span>
            </a>
        </li> -->
		<li class="nav-item" th:if="${session.permissions.Appraisal}">
		    <a class="nav-link" onclick="displayOnLoadingPopup();" id="apprisalLink" th:href="@{/apprisal_for_HR(empid=${session.empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Appraisal(HR)</span>
		    </a>
		</li>
	    <li class="nav-item">
	        <a class="nav-link" data-bs-target="#components-nav2" data-bs-toggle="collapse" href="#">
	          <i class="bi bi-receipt-cutoff"></i><span>MOAT</span><i class="bi bi-caret-down-fill ms-auto"></i>
	        </a>
	        <ul id="components-nav2" class="nav-content collapse" data-bs-parent="#sidebar-nav">
	        <li>
	            <a href="totalCandidatesList" onclick="displayOnLoadingPopup();">
	              <i class="bi bi-circle"></i><span>Total Candidates</span>
	            </a>
	          </li>
	        <li>
	            <a href="selectedCandidatesList" onclick="displayOnLoadingPopup();">
	              <i class="bi bi-circle"></i><span>Selected Candidates</span>
	            </a>
	          </li>
	          <li>
	            <a href="rejectedCandidatesList" onclick="displayOnLoadingPopup();">
	              <i class="bi bi-circle"></i><span>Rejected Candidates</span>
	            </a>
	          </li>
	          </ul>
	        </li>
	        
	        <li class="nav-item" id="employeeLink">
	        <a class="nav-link" data-bs-target="#components-nav" data-bs-toggle="collapse" href="#">
	          <i class="bi bi-person-plus"></i><span>Employee</span><i class="bi bi-caret-down-fill ms-auto"></i>
	        </a>
	        <ul id="components-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
	          <li>
	            <a href="employeeForm" onclick="displayOnLoadingPopup();">
	              <i class="bi bi-circle"></i><span>Employees</span>
	            </a>
	          </li>
	          	<li>
					<a class="nav-link" onclick="displayOnLoadingPopup();" th:href="@{/attendanceLive(email=${session.empDetailsByEmpId.email})}">
						<i class="bi bi-circle"></i><span>Attendance</span>
					</a>
				</li>
				<li>
					<a class="nav-link" onclick="displayOnLoadingPopup();" th:href="@{/apprisalEmployee}">
						<i class="bi bi-circle"></i><span>Appraisal</span>
					</a>
				</li>
				<li>
					<a class="nav-link" onclick="displayOnLoadingPopup();" th:href="@{/hikeRatingForm}">
						<i class="bi bi-circle"></i><span>Hike Ratings</span>
					</a>
				</li>
	          </ul>
	        </li>
	        
	        <!-- <li class="nav-item">
	        <a class="nav-link" data-bs-target="#components-nav3" data-bs-toggle="collapse" href="#">
	          <i class="bi bi-bookmark"></i><span>Appraisal</span><i class="bi bi-caret-down-fill ms-auto"></i>
	        </a>
	        <ul id="components-nav3" class="nav-content collapse" data-bs-parent="#sidebar-nav">
	          <li>
	            <a class="nav-link" href="apprisalForm">
	              <i class="bi bi-circle"></i><span>Add</span>
	            </a>
	          </li>
	          	<li>
					<a class="nav-link" th:href="@{/attendanceLive(email=${session.empDetailsByEmpId.email})}">
						<i class="bi bi-circle"></i><span>Attendance</span>
					</a>
				</li>
	          </ul>
	        </li> -->
	        
	        <li class="nav-item">
			    <a class="nav-link" onclick="displayOnLoadingPopup();" href="holiday">
			        <i class="bi bi-calendar4-week"></i>
			        <span>Holiday</span>
			    </a>
			 </li>
			<li class="nav-item">
				    <a class="nav-link" onclick="displayOnLoadingPopup();" href="addInterComm">
				        <i class="bi bi-telephone"></i>
				        <span>Communication</span>
				    </a>
			 </li>
			 <li class="nav-item">
				    <a class="nav-link" onclick="displayOnLoadingPopup();" href="groupMailId">
				        <i class="bi bi-envelope-open"></i>
				        <span>Group Mail Id</span>
				    </a>
			 </li>
			 <li class="nav-item">
				    <a class="nav-link" onclick="displayOnLoadingPopup();" href="leaveRequests">
				        <i class="bi bi-journal-text"></i>
				        <span>Leave Requests</span>
				    </a>
			 </li>
			 <li class="nav-item">
				    <a class="nav-link" onclick="displayOnLoadingPopup();" href="viewEvents">
				        <i class="bi bi-megaphone"></i>
				        <span>Announcement</span>
				    </a>
			 </li>
			 <!-- <li class="nav-item">
				    <a class="nav-link" href="viewConvertedEvents">
				        <i class="bi bi-image"></i>
				        <span>Event</span>
				    </a>
			 </li> -->
	    </ul>
</aside>
  <!-- End Sidebar-->

  <main id="main" class="main">
  
  <div id="loadingPopup">
	<div class="spinnerAndParaMerger">
	    <div class="spinner"></div>
	    <p id="loadingPopupPara"></p>
    </div>
</div> 
  
  <input type="hidden" id="roleValue" th:value="${session.role_name}">
  <input type="hidden" id="emp_idValue" th:value="${session.empDetailsByEmpId.empid}">
  
  	<div class="pagetitle">
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="hrDashboard">Home</a></li>
          <li class="breadcrumb-item active">Interview</li>
        </ol>
      </nav>
    </div>
    
    <input type="hidden" id="errorLoginValue" th:value="${error}">
    
    <div th:if="${error}">
	    <script th:inline="javascript">
	    	Swal.fire($('#errorLoginValue').val());
	    </script>
	</div>

		<section class="section dashboard">
			<div class="row">
				<div class="col-lg-12">
					<div class="row" >
						<div class="app app__dark">
							<header class="app-header">
								<img
									src="assets/img/melange_updated_new_logo-modified.png" class="interview_app-logo" alt="interview_logo">
							</header>

							<form class="login" action="postLogin" method="post">
								<input type="hidden" name="loggedInEmail" th:value="${session.empDetailsByEmpId.email}">	
								<div class="login-input-group">
									<div
										class="login-floating-label-form-group login-floating-label-form-group__dark">
										<label>Email</label> <input
											class="login-form-control login-form-control__dark" style="font-size: 14px;"
											type="email" name="email" placeholder="Email" required />
										<p class="help-block text-danger"></p>
									</div>

									<div
										class="login-floating-label-form-group login-floating-label-form-group__dark">
										<label>Password</label> <input
											class="login-form-control login-form-control__dark" style="font-size: 14px;"
											type="password" name="password" placeholder="Password" required />
										<p class="help-block text-danger"></p>
									</div>
								</div>

								<div class="login-form-group">
									<button type="submit" style="font-size: 14px;" class="btn btn__dark btn__xl">Login</button>
								</div>
								
							</form>
						</div>
						<!-- <div th:if="${error}" class="error_msg">
				            <span th:text="${error}"></span>
				       </div> -->
					</div>
				</div>
			</div>
		</section>

	</main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>Melange System pvt ltd</span></strong>. All Rights Reserved
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>


<!-- Template Main JS File -->
<script src="assets/js/main.js"></script>

<script>
function getNotificationCounts() {
	$.ajax({
		type: 'GET',
		url: 'fetchNotificationCountForAllPages',
		success: function (data) {
			//alert(JSON.stringify(data));
			
			 var totalNotificationCount = data.total_notification;
			 var leavePendingCountValue = data.leave_pending_count;
	         var moatNewCandidateCount = data.new_candidate_count;
	         var moatSelectedCandidateCount = data.selected_candidate_count;
	         var moatRejectedCandidateCount = data.rejected_candidate_count;
	         var q1AppraisalCount = data.q1_notify_count;
	         var q2AppraisalCount = data.q2_notify_count;
	         var q3AppraisalCount = data.q3_notify_count;
	         var q4AppraisalCount = data.q4_notify_count;
	         var appraisalSubmittedCount = data.apprisal_submitted_count;
			
			$('#notificationCount').text(totalNotificationCount);
			updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, moatNewCandidateCount, 
			moatSelectedCandidateCount, moatRejectedCandidateCount, q1AppraisalCount, q2AppraisalCount, 
			q3AppraisalCount, q4AppraisalCount, appraisalSubmittedCount);
		},
		error: function (xhr, status, error) {
			console.error('Error fetching data:', error);
			console.log('Error fetching data. Please try again.');
		}
	});
}
	
		$(document).ready(function() {
		  getNotificationCounts(); 
		  setInterval(getNotificationCounts, 1000); 
		});
		
		
		function updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, moatNewCandidateCount, 
				moatSelectedCandidateCount, moatRejectedCandidateCount, q1AppraisalCount, q2AppraisalCount, q3AppraisalCount, q4AppraisalCount, appraisalSubmittedCount) {
					
					var emptyNotifyDiv = $('#emptyNotifyDiv');
					var emptyNotifyDivHorizontalRow = $('#emptyNotifyDivHorizontalRow');
					
					var leaveRequestNotifyDiv = $('#leaveRequestNotifyDiv');
					var leaveRequestNotifyDivHorizontalRow = $('#leaveRequestNotifyDivHorizontalRow');
					
					var moatNewCandidateNotifyDiv = $('#moatNewCandidateNotifyDiv');
					var moatNewCandidateNotifyDivHorizontalRow = $('#moatNewCandidateNotifyDivHorizontalRow');
					
					var moatSelectedCandidateNotifyDiv = $('#moatSelectedCandidateNotifyDiv');
					var moatSelectedCandidateNotifyDivHorizontalRow = $('#moatSelectedCandidateNotifyDivHorizontalRow');
					
					var moatRejectedCandidateNotifyDiv = $('#moatRejectedCandidateNotifyDiv');
					var moatRejectedCandidateNotifyDivHorizontalRow = $('#moatRejectedCandidateNotifyDivHorizontalRow');
					
					var q1AppraisalNotifyDiv = $('#q1AppraisalNotifyDiv');
					var q1AppraisalNotifyDivHorizontalRow = $('#q1AppraisalNotifyDivHorizontalRow');
					
					var q2AppraisalNotifyDiv = $('#q2AppraisalNotifyDiv');
					var q2AppraisalNotifyDivHorizontalRow = $('#q2AppraisalNotifyDivHorizontalRow');
					
					var q3AppraisalNotifyDiv = $('#q3AppraisalNotifyDiv');
					var q3AppraisalNotifyDivHorizontalRow = $('#q3AppraisalNotifyDivHorizontalRow');
					
					var q4AppraisalNotifyDiv = $('#q4AppraisalNotifyDiv');
					var q4AppraisalNotifyDivHorizontalRow = $('#q4AppraisalNotifyDivHorizontalRow');
					
					var appraisalSubmittedNotifyDiv = $('#appraisalSubmittedNotifyDiv');
					var appraisalSubmittedNotifyDivHorizontalRow = $('#appraisalSubmittedNotifyDivHorizontalRow');
					
					if (totalNotificationCount > 0) {
						
						$("#bellIcon").show();
						$("#emptyNotifyDiv").hide();
						$('#emptyNotificationHeaderMessage').text("");
						
						if (leavePendingCountValue > 0) {
							$("#leaveRequestNotifyDiv").show();
							$("#leaveRequestNotifyDivHorizontalRow").show();
							$('#leaveNotificationMessage').text("You have "+leavePendingCountValue+" new leave request");
							$('#leaveNotificationNumberHeader').text("Leave Request!");
						} else {
							$("#leaveRequestNotifyDiv").hide();
						}
						
						if (moatNewCandidateCount > 0) {
							$("#moatNewCandidateNotifyDiv").show();
							$("#moatNewCandidateNotifyDivHorizontalRow").show();
							$('#moatNewCandidateNotificationMessage').text("There is "+moatNewCandidateCount+" new candidate registered for the MOAT");
							$('#moatNewCandidateNumberHeader').text("New Candidate!");
						} else {
							$("#moatNewCandidateNotifyDiv").hide();
						}
						
						if (moatSelectedCandidateCount > 0) {
							$("#moatSelectedCandidateNotifyDiv").show();
							$("#moatSelectedCandidateNotifyDivHorizontalRow").show();
							$('#moatSelectedCandidateNotificationMessage').text("There is "+moatSelectedCandidateCount+" selected candidate from the MOAT");
							$('#moatSelectedCandidateNumberHeader').text("Selected Candidate!");
						} else {
							$("#moatSelectedCandidateNotifyDiv").hide();
						}
						
						if (moatRejectedCandidateCount > 0) {
							$("#moatRejectedCandidateNotifyDiv").show();
							$("#moatRejectedCandidateNotifyDivHorizontalRow").show();
							$('#moatRejectedCandidateNotificationMessage').text("There is "+moatRejectedCandidateCount+" rejected candidate from the MOAT");
							$('#moatRejectedCandidateNumberHeader').text("Rejected Candidate!");
						} else {
							$("#moatRejectedCandidateNotifyDiv").hide();
						}
						
						if (q1AppraisalCount > 0) {
							$("#q1AppraisalNotifyDiv").show();
							$("#q1AppraisalNotifyDivHorizontalRow").show();
							$('#q1AppraisalNotificationMessage').text("Reminder to send Quarter-1 appraisal to employees");
							$('#q1AppraisalNumberHeader').text("Appraisal !");
						} else {
							$("#q1AppraisalNotifyDiv").hide();
						}
						
						if (q2AppraisalCount > 0) {
							$("#q2AppraisalNotifyDiv").show();
							$("#q2AppraisalNotifyDivHorizontalRow").show();
							$('#q2AppraisalNotificationMessage').text("Reminder to send Quarter-2 appraisal to employees");
							$('#q2AppraisalNumberHeader').text("Appraisal !");
						} else {
							$("#q2AppraisalNotifyDiv").hide();
						}
						
						if (q3AppraisalCount > 0) {
							$("#q3AppraisalNotifyDiv").show();
							$("#q3AppraisalNotifyDivHorizontalRow").show();
							$('#q3AppraisalNotificationMessage').text("Reminder to send Quarter-3 appraisal to employees");
							$('#q3AppraisalNumberHeader').text("Appraisal !");
						} else {
							$("#q3AppraisalNotifyDiv").hide();
						}
						
						if (q4AppraisalCount > 0) {
							$("#q4AppraisalNotifyDiv").show();
							$("#q4AppraisalNotifyDivHorizontalRow").show();
							$('#q4AppraisalNotificationMessage').text("Reminder to send Quarter-4 appraisal to employees");
							$('#q4AppraisalNumberHeader').text("Appraisal !");
						} else {
							$("#q4AppraisalNotifyDiv").hide();
						}
						
						if (appraisalSubmittedCount > 0) {
							$("#appraisalSubmittedNotifyDiv").show();
							$("#appraisalSubmittedNotifyDivHorizontalRow").show();
							$('#appraisalSubmittedNotificationMessage').text("There is "+appraisalSubmittedCount+" appraisal has been submitted");
							$('#appraisalSubmittedNumberHeader').text("Appraisal Submitted !");
						} else {
							$("#appraisalSubmittedNotifyDiv").hide();
						}

					}else{
						$("#bellIcon").hide();
						$("#emptyNotifyDiv").show();
						$('#emptyNotificationHeaderMessage').text("Currently there is no any notifications");
					}
				}
		
</script>


<script>
$.ajax({
    type: "GET",
    url: "fetchEmployeeDocumentDetailsOnlyByEmpId",
    data: {
        "emp_id": $('#emp_idValue').val()
    },
    success: function(data) {
        $('#dynamicProfilePic').attr('src', `${data.profilePicPath}`);
    },
    error: function(xhr, status, error) {
        console.error("Error invoking data:", error);
    }
});
</script>


<script>
$.ajax({
    type: "GET",
    url: "checkAppraisalNotificationAndValidationForHR",
    success: function(data) {
    	checkAppraisalDataForValidations(data);
    },
    error: function(xhr, status, error) {
        console.error("Error invoking data:", error);
    }
});

function checkAppraisalDataForValidations(data) {
    if (data && data.length > 0) {
        // Get the current month as a number (0-11)
        const currentMonth = new Date().getMonth() + 1; //Adding 1 to make it 1-12 for easier comparison
        const currentYear = new Date().getFullYear();
        //alert(currentMonth)

       for (let i = 0; i < data.length; i++) {
            // Assuming appraisal_send_month is a number representing the month (1-12)
            if (data[i].appraisal_send_month == currentMonth && data[i].appraisal_sent_year != currentYear) {
                //alert(data[i].appraisal_send_month+" "+data[i].quarter+" "+data[i].id)
            	$.ajax({
                    url: '/updateQuarterFlagAndQuarterBtnEnableFlagForHR', // Your backend URL for saving the CTC offer
                    type: 'POST',
                    data: {
                    	auto_id: data[i].id
                    },
                    success: function (response) {
                        console.log(response+" for "+data[i].quarter);
                    },
                    error: function (xhr, status, error) {
                        alert('Failed to update Appraisal status value: ' + error);
                    }
                });
            }
        }
    }
}

$.ajax({
    type: "GET",
    url: "checkApprisalNotSentDetailsToSendEmailToAdmin",
    success: function(data) {
    	//alert(JSON.stringify(data))
    	sendEmailToAdminWhoseApprisalIsNotSubmitted(data);
    },
    error: function(xhr, status, error) {
        console.error("Error invoking data:", error);
    }
});


function sendEmailToAdminWhoseApprisalIsNotSubmitted(data) {
	
    const finalEmailSendData = [];
    const ajaxRequests = []; // Array to store all AJAX request promises

    data.forEach(item => {
        if (item.apprisal_email_send_to_admin === "1" &&
            (!item.apprisal_email_send_flag || item.apprisal_email_send_flag === "null" || item.apprisal_email_send_flag === "")) {
           
        	displayAppraisalEmailSendingLoadingPopup();

            const request = $.ajax({
                type: "GET",
                url: "fetchTeamLeadAndTeamCoEmpIdByUsingEmployeeEmailAndEmpId",
                data: {
                    empId: item.emp_id,
                    employeeEmail: item.email
                },
                success: function(data2) {
                    if (data2) {
                        finalEmailSendData.push({
                            logged_in_email: $('#loggedInSessionEmailValue').val(),
                            auto_id: item.id,
                            employee_name: item.emp_name,
                            employee_email: data2.employee_email,
                            team_lead_email: data2.team_lead_email,
                            team_co_email: data2.team_co_email,
                            department: item.department,
                            quarter_month_year: item.quarter_month_year
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching team details for", item.emp_id, ":", error);
                }
            });

            ajaxRequests.push(request);
        }
    });

    // Once all requests have completed, process the final data
    $.when(...ajaxRequests).done(() => {
        if (finalEmailSendData.length > 0) {
            $.ajax({
                type: "POST",
                url: "sendEmailToAdminForWhoNotSubmittedTheAppraisal",
                contentType: "application/json",
                data: JSON.stringify(finalEmailSendData),
                success: function(response) {
                    if (response === "Email Sent") {
                        console.log("Emails successfully sent to admins.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error sending email:", error);
                },
                complete: function() {
                    hideLoadingPopup();
                }
            });
        } else {
            console.log("No valid data to send emails.");
            hideLoadingPopup();
        }
    });
}
</script>

<!-- script for spinner -->
<script>
function displayOnLoadingPopup(){
	$('#loadingPopup').show();
	$('#loadingPopupPara').text("Loading, please wait...");
}

function displayAppraisalEmailSendingLoadingPopup(){
	$('#loadingPopup').show();
	$('#loadingPopupPara').text("Please hold on, the appraisal reminder emails are currently being sent...");
}

function hideLoadingPopup(){
	$('#loadingPopup').hide();
}

window.onload = function() {
	hideLoadingPopup();
};
</script>

<!-- script to notification on bottom of the page-->
<!--CHAT BOOT-->

<!-- Include SockJS and Stomp.js libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!-- script to notification on bottom of the page-->
<script>
		//CODE FOR CHATBOOT NOTIFICATION 
		var stompClient = null;
		var employeeMap = {}; // To store the mapping of employee names to emails
		let employeePhotoMap = {};
		let emailToNameMap = {}; // New map for email -> name lookup
		var email = null;
		var visibilityState = document.visibilityState; // Track tab visibility
		var heartbeatInterval = null; // Track heartbeat interval

		function connectWebSocket() {
			
			var socket = new SockJS('/chat-websocket');
						  stompClient = Stomp.over(socket);

						  var email = document.getElementById('loggedInMail').value;
						  console.log(`Connecting WebSocket as: ${email}`);

						  stompClient.connect({ 'email': email }, function (frame) {
						      console.log('Connected to WebSocket:', frame);

							 // subscribeToTypingEvents();
						      // Mark user as active
						      stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));

						      // Subscribe to active users list
						      stompClient.subscribe('/topic/activeUsers', function (message) {
						          var activeUsers = JSON.parse(message.body);
						          updateActiveUserUI(activeUsers);
						      });
							  // Subscribe to user messages
							        stompClient.subscribe('/user/queue/messages', function (message) {
									//	loadMessages();
									//	alert("po2");
							            console.log('Raw WebSocket Message:11', message);
							            var msg = JSON.parse(message.body);
										//alert(msg);
							            console.log('Parsed Messag111e:', msg);
							            console.log(`Received messagesdsd: ${JSON.stringify(msg)}`);
										//alert("(message.read"+msg.read);
									
							            // Display message if it matches the selected employee
							            if (selectedEmployee === msg.senderEmail || selectedEmployee === msg.recipientEmail) {
											console.log(`New message fromss ${msg.senderEmail}: ${msg.content}`);
											console.log("plk "+selectedEmployee);
											console.log("plk "+msg.senderEmail);
											console.log("plk "+msg.recipientEmail);
											//loadMessages();
							                showMessage(
							                    msg.id,               // Message ID
							                    msg.senderEmail,      // Sender's email
							                    msg.content,          // Message content
							                    msg.recipientEmail,   // Recipient's email
							                    msg.timestamp,        // Message timestamp
							                    email,
												msg.read                    // Logged-in user's email
							                );
							            }
								
										loadEmployees();
										loadMessages();
									 	
							        });

							        // Subscribe to notifications
							        stompClient.subscribe('/user/queue/notifications', function (notification) {
										//alert("00");
							            console.log('New Notification:', notification.body);
							            showToastNotification(notification.body);
										loadEmployees();
										//alert("01");
							        });

									//alert("Subscribing to chat updates...");
									stompClient.subscribe('/user/queue/messages', function (message) {
									    console.log('WebSocket Chat Update Received:', message.body); // Log raw message

									    let parsedMessage = JSON.parse(message.body);
									    console.log('Parsed Message:', parsedMessage); // Log parsed JSON

									    if (Array.isArray(parsedMessage)) {
									        parsedMessage.forEach(msg => {
									            console.log(`Message ID: ${msg.id}, Read: ${msg.read}`);
									            if (msg.read) {
									                updateMessageUI(msg);
									            }
									        });
									    } else {
									        console.log("Unexpected message format:", parsedMessage);
									    }

									    // Refresh messages after a delay
									    setTimeout(() => {
									        console.log("Refreshing messages...");
									        loadMessages();
									    }, 3000);
									});

									stompClient.subscribe('/topic/typing', function (message) {
									    console.log("üì© Typing notification received:", message.body);

									    let typingData;
									    try {
									        typingData = JSON.parse(message.body);
									        console.log("‚úÖ Parsed Typing Data:", typingData);
									    } catch (error) {
									        console.error("‚ùå Error parsing typing notification message:", error);
									        return;
									    }

									    let loggedInUserEmail = document.getElementById('loggedInMail')?.value;
									    if (!loggedInUserEmail) return;

									    if (loggedInUserEmail === typingData.recipientEmail && typingData.senderEmail === selectedEmployee) {
									        // Fetch actual typing status from the backend
									        fetch(`/getTypingStatus?senderEmail=${typingData.senderEmail}&recipientEmail=${typingData.recipientEmail}`)
									            .then(response => response.json())
									            .then(data => {
									                console.log("üéØ Actual Typing Status from DB:", data.typing);
													console.log("üéØ Actual Typing Status from DB:", data);
													                console.log("‚ÑπÔ∏è Typing Status (0 or 1):", data.typing);
													                
									                let chatMessages = document.querySelector(".chat-history ul");
									                let chatContainer = document.querySelector(".chat-history"); // The scrollable chat area

									                let typingIndicator = document.getElementById("typingIndicator");
									                
									                if (!typingIndicator) {
									                    typingIndicator = document.createElement("li");
									                    typingIndicator.id = "typingIndicator";
									                    typingIndicator.classList.add("typing-indicator");
									                    typingIndicator.innerHTML = `
									                        <img src="${employeePhotoMap[selectedEmployee] || 'default-profile.jpg'}" alt="User Photo" class="typing-photo">
									                        <span>Typing...</span>
									                    `;
									                    chatMessages.appendChild(typingIndicator);
									                }

									                if (data.typing === 1) { // Ensure it checks the latest typing status
									                    typingIndicator.style.display = "flex";

									                    // Move typing indicator to the bottom
									                    chatMessages.appendChild(typingIndicator);

									                    // Auto-scroll to the bottom
									                    setTimeout(() => {
									                        chatContainer.scrollTop = chatContainer.scrollHeight;
									                    }, 100);
									                } else {
									                    typingIndicator.style.display = "none";
									                }
									            })
									            .catch(error => console.error("‚ùå Error fetching typing status:", error));
									    }
									});


						      // Start heartbeat initially
						      heartbeatInterval = setInterval(() => {
						          if (stompClient && stompClient.connected) {
						              stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
						              console.log("Heartbeat sent for user: " + email);
						          }
						      }, 20000); // 30 seconds

						      // Detect tab visibility change
						  /*    document.addEventListener("visibilitychange", function () {
						          if (document.hidden) {
						              console.log("User switched to another tab. Marking as inactive.");
						              stompClient.send("/app/userInactive", {}, JSON.stringify({ email }));
						              clearInterval(heartbeatInterval); // Stop heartbeat
						              heartbeatInterval = null;
						          } else {
						              console.log("User returned to the application tab. Marking as active.");
						              stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));
						              if (!heartbeatInterval) {
						                  heartbeatInterval = setInterval(() => {
						                      if (stompClient && stompClient.connected) {
						                          stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
						                          console.log("Heartbeat sent for user: " + email);
						                      }
						                  }, 30000);
						              }
						          }
						      });*/

						      // Detect tab close or WebSocket disconnect
						      socket.onclose = function () {
						          console.log("WebSocket disconnected. Updating user status.");
						          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
						      };

						      window.addEventListener('beforeunload', function () {
						          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
						      });

						  });
		}

		function updateActiveUserUI(activeUsers) {
		//	alert("1");
		    const employeeItems = document.getElementById('employeeNames').getElementsByTagName('li');

		    Array.from(employeeItems).forEach(item => {
		        const employeeName = item.querySelector('span').textContent;
		        const email = employeeMap[employeeName]; 
		        const statusIndicator = item.querySelector('.status-indicator'); // Get the status dot

		        if (activeUsers.includes(email)) {
		            item.classList.add('active-user');
		            statusIndicator.style.backgroundColor = '#66cc66'; // Green for active users
		        } else {
		            item.classList.remove('active-user');
		            statusIndicator.style.backgroundColor = '#ff6666'; // Red for inactive users
		        }

		        // If this employee is currently selected, update chat header status
				if (selectedEmployee === email) {
				           const chatStatusIndicator = document.getElementById('chatStatusIndicator');
				           if (activeUsers.includes(email)) {
				               chatStatusIndicator.style.backgroundColor = '#66cc66'; // Green (Online)
				           } else {
				               chatStatusIndicator.style.backgroundColor = '#ff6666'; // Red (Offline)
				           }
				       }
		    });
		}


		// Select an employee to chat with
		function selectEmployee(employeeName) {
			selectedEmployee = employeeMap[employeeName]; // Get the email from the map
			console.log(`Employee selected: ${selectedEmployee}`);

			// Highlight the selected employee
			var employeeItems = document.querySelectorAll('#employeeNames li');
			employeeItems.forEach(function (item) {
				item.classList.remove('active');
			});
			var selectedItem = Array.from(employeeItems).find(item => item.innerHTML === employeeName);
			if (selectedItem) {
				selectedItem.classList.add('active');
			}

			// Update chat header with employee name and photo
			document.querySelector('.chat-about h6').innerText = employeeName;
			document.querySelector('#employeePhoto').src = employeePhotoMap[selectedEmployee] || 'default-profile.jpg';

			// Hide the message icon and dots when an employee is selected
			document.getElementById('message-icon-container').style.display = 'none';
			// Hide the paragraph when an employee is selected
			document.getElementById('logo-text').style.display = 'none';

			// Load messages for the selected employee
			loadMessages();
		}

		function loadEmployees() {
			console.log("Loading employee names...");

			// Fetch employee names from the endpoint
			fetch('/employees/names')
				.then(response => {
					console.log("Response received:", response);
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then(data => {
					console.log("Employee data fetched:", data); // Log the raw data

					const employeeList = document.getElementById('employeeNames');
					if (!employeeList) {
						console.error("Element with ID 'employeeNames' not found.");
						return;
					}

					employeeList.innerHTML = ''; // Clear the list before adding new items

					// Iterate through employee data
					data.forEach(employee => {
						console.log("Processing employee:", employee);

						// Create a list item for each employee
						const li = document.createElement('li');
						li.classList.add('d-flex', 'align-items-center', 'employee-item');

						// Handle missing or empty profile photo paths
						const profilePic = employeePhotoMap[employee.email] || '/static/default-profile.jpg';
						console.log(`Profile picture for ${employee.name}: ${profilePic}`);

						li.innerHTML = `
			                    <img src="${profilePic}" 
			                         alt="Employee Photo" 
			                         class="employee-photo mr-2" />
			                    <span>${employee.name}</span>
			                `;

						// Map employee name to email
						employeeMap[employee.name] = employee.email;
						console.log("Mapped employee:", employee.name, "->", employee.email);
						// Add new reverse mapping (email -> name)
						emailToNameMap[employee.email] = employee.name;
						// Add click event to list item
						li.onclick = () => {
							console.log(`Selected employee: ${employee.name}`);
							selectEmployee(employee.name);
						};

						// Append the list item to the employee list
						employeeList.appendChild(li);

					});

					console.log("Employee names loaded successfully. Employee map:", employeeMap);
					// Call the unread messages function after loading employee data
					fetchUnreadMessages();

					// Set interval to check for new messages every 10 seconds
						setInterval(fetchUnreadMessages, 10000);
				})
				.catch(error => {
					console.error("Error loading employees:", error);
				});
		}


		function loadMessages() {
			// alert("Loading messages...");
			// Get the logged-in user's email and selected employee's email
			var loggedInEmail = document.getElementById('loggedInMail').value;
			var selectedEmployeeEmail = selectedEmployee; // Email is already stored in selectedEmployee

			console.log(`Loading messages between: ${loggedInEmail} and ${selectedEmployeeEmail}`);

			fetch(`/messages?loggedInEmail=${encodeURIComponent(loggedInEmail)}&selectedEmployeeEmail=${encodeURIComponent(selectedEmployeeEmail)}`)
				.then(response => response.json())
				.then(data => {
					console.log("Chat messages loaded:", data);
					// Clear the chat window before displaying messages
					var chatWindow = document.getElementById('chat-window').querySelector('ul');
					chatWindow.innerHTML = '';

					// Display messages
					data.forEach(function (msg) {
						// showMessage(msg.senderEmail, msg.content, msg.recipientEmail, loggedInEmail);
						showMessage(msg.id, msg.senderEmail, msg.content, msg.recipientEmail, msg.timestamp, loggedInEmail);
					});
				})
				.catch(error => console.error("Error loading chat messages:", error));
		}
		let activeDeleteDropdown = null;
		function showMessage(id, senderEmail, message, recipientEmail, timestamp, loggedInEmail) {
			console.log("Message ID:", id);
			console.log(`LoggedInEmailrrr: ${loggedInEmail}, SenderEmail: ${senderEmail}`);

			const isSender = senderEmail === loggedInEmail;
			const senderName = isSender ? "Me" : Object.keys(employeeMap).find(name => employeeMap[name] === senderEmail) || senderEmail;
			const senderPhoto = employeePhotoMap[senderEmail] || 'default-avatar.png';
			const formattedTime = new Date(timestamp).toLocaleString(); // Format timestamp

			console.log(`Message ID: ${id}, Time: ${formattedTime}, From: ${senderEmail}, To: ${recipientEmail}, Content: "${message}"`);

			var chatWindow = document.getElementById('chat-window').querySelector('ul');
			var li = document.createElement('li');
			li.className = isSender ? 'clearfix right' : 'clearfix left';

			li.innerHTML = `
					    <div class="message-container" data-message-id="${id}" onclick="toggleDeleteOption(this)">
					        <img class="sender-photo" src="${senderPhoto}" alt="Sender Photo" />
					        <div class="message ${isSender ? 'my-message' : 'other-message'}">
					            <strong>${senderName}:</strong> ${message}
					        </div>
					    </div>
					    <div class="timestamp" style="text-align: ${isSender ? 'right' : 'left'};">
					        ${formattedTime}
					    </div>
					    ${isSender ? `
					        <div class="message-action-dropdown" >
					            <a class="dropdown-item" href="#" onclick="deleteMessage(this, ${id})">Delete Message</a>
					        </div>
					    ` : ''}`;

			chatWindow.appendChild(li);
			chatWindow.scrollTop = chatWindow.scrollHeight;
		}
		
		/*function fetchUnreadMessages() {
			console.log("Fetching unread messages...");
			var loggedInEmail = document.getElementById('loggedInMail').value;

			fetch(`/unread?email=${loggedInEmail}`)
				.then(response => response.json())
				.then(messages => {
					messages.forEach(message => {
						let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;

						// Show notification with sender's email as a parameter
						showToastNotification(`New message from ${senderName}: ${message.content}`, message.senderEmail);
					});
				})
				.catch(error => console.error("Error fetching unread messages:", error));
		}*/

		let displayedMessageIds = new Set(); // Track displayed messages
		let closedMessageIds = new Set(); // Track closed messages

		function fetchUnreadMessages() {
		    console.log("Fetching unread messages...");
		    var loggedInEmail = document.getElementById('loggedInMail').value;

		    fetch(`/unread?email=${loggedInEmail}`)
		        .then(response => response.json())
		        .then(messages => {
		            messages.forEach(message => {
		                console.log("Processing message ID:", message.id); // Print message ID to console
		                
		                // Ignore messages that were previously closed
		                if (!displayedMessageIds.has(message.id) && !closedMessageIds.has(message.id)) {
		                	
							//alert(1);
		                    let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;
		                    showToastNotification(`New message from ${senderName}: ${message.content}`, message.id, message.senderEmail);
		                    displayedMessageIds.add(message.id); // Mark message as displayed
		                }
						//alert(2);
		            });
		        })
		        .catch(error => console.error("Error fetching unread messages:", error));
		}
		// Global flag to track if the user manually dismissed notifications
		
		/*function showToastNotification(message, senderEmail) {
			
			var toastContainer = document.createElement('div');
			toastContainer.className = 'toast-notification';

			// Add message and close button
			toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close">‚úñ</span>`;

			document.body.appendChild(toastContainer);

			// Animate in
			setTimeout(() => {
				toastContainer.classList.add('show');
			}, 100);

			// Auto-hide after 8 seconds
			let autoHideTimeout = setTimeout(() => closeToast(toastContainer), 10000);

			// Prevent opening chat when clicking the close button
			toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
				event.stopPropagation(); // Prevent click from bubbling to toastContainer
				clearTimeout(autoHideTimeout);
				
				closeToast(toastContainer);
			});

			// Open chat when clicking on the notification
			toastContainer.addEventListener('click', () => {
				openChatWithSender(senderEmail);
				closeToast(toastContainer); // Remove notification when chat opens
			});
		}*/
		function showToastNotification(message, messageId, senderEmail) {
			//alert(1);
		    var toastContainer = document.createElement('div');
		    toastContainer.className = 'toast-notification';
		    toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close">‚úñ</span>`;

		    document.body.appendChild(toastContainer);

		    // Animate in
		    setTimeout(() => {
		        toastContainer.classList.add('show');
		    }, 100);

		    // Auto-hide after 8 seconds
		    let autoHideTimeout = setTimeout(() => closeToast(toastContainer, messageId), 8000);

		    // Prevent opening chat when clicking the close button
		    toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
		        event.stopPropagation(); // Prevent click from bubbling to toastContainer
		        clearTimeout(autoHideTimeout);
		        closedMessageIds.add(messageId); // Mark as closed so it won't be shown again
		        closeToast(toastContainer, messageId);
		    });

		    // Open chat when clicking on the notification
		    toastContainer.addEventListener('click', () => {
		        openChatWithSender(senderEmail);
		        closeToast(toastContainer, messageId); // Remove notification when chat opens
		    });
		}

		// Function to handle toast closing
		/*function closeToast(toast) {
			toast.classList.remove('show');
			setTimeout(() => toast.remove(), 300); // Faster fade-out
		}*/
		// Function to handle toast closing and mark as dismissed
		// Function to handle toast closing
		function closeToast(toast, messageId) {
		    toast.classList.remove('show');
		    setTimeout(() => toast.remove(), 300); // Faster fade-out
		}
		/*	function openChatWithSender(senderEmail) {
				console.log("Opening chat with:", senderEmail);
			    
				// Construct the URL for the UserFavorite page with the senderEmail as a query parameter
				const url = `/my-favorites?email=${encodeURIComponent(senderEmail)}`;
			    
				// Redirect to the UserFavorite page
				window.location.href = url;
			}*/

		function openChatWithSender(senderEmail) {
			console.log("Opening chat with:", senderEmail);

			// Store sender email in sessionStorage
			sessionStorage.setItem("chatSenderEmail", senderEmail);

			// Redirect to the UserFavorite page
			window.location.href = `/my-favorites`;
		}

		// Connect to the WebSocket server and load employees when the page is loaded
		document.addEventListener('DOMContentLoaded', function () {
			//fetchUnreadMessages();
			loadEmployees();
			connectWebSocket();
		});

	</script>

</body>

</html>