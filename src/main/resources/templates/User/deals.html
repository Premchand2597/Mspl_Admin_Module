<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport">

	<title>MSPL CONNECT</title>
	<meta content="" name="description">
	<meta content="" name="keywords">

	<!-- Favicons -->
	<link href="assets/img/favicon.png" rel="icon">
	<link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

	<!-- Google Fonts -->
	<!-- 	<link href="https://fonts.gstatic.com" rel="preconnect">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
		rel="stylesheet"> -->
		
	<link rel="stylesheet" href="/assets/font/fonts.css"> 

	<!-- Vendor CSS Files -->
	<link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
	<link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
	<link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
	<link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
	<link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
	<link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
	<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
	
	<!-- Template Main CSS File -->
	<link href="assets/css/style.css" rel="stylesheet">
	
	<!-- 	<script src="https://code.highcharts.com/highcharts.js"></script> -->
	<script src="assets/js/highcharts.js"></script>
	
	<!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
	<script src="assets/js/jquery-3.6.4.min.js"></script>
	 
	<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
	 <script src="assets/js/sweetalert2@11.js"></script>
	<!--CHAT BOOT-->

			<!-- Include SockJS and Stomp.js libraries -->
			<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
			<!-- Bootstrap CSS -->
	        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> -->
 <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<style>
		* {
			font-size: 14px;
		}

		.card {
			border: 1px solid #ddd;
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 20px;
		}

		.info-card {
			background-color: #fff;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		#attendence-chart {
			width: 100%;
			height: 190px;
			/* Adjust the height as needed */
		}

		/* Example CSS to style disabled items */
		.activity-item .disabled {
			pointer-events: none;
			/* Disable interactions */
			opacity: 0.5;
			/* Make the item appear grayed out */
		}

		.profile-picture {
			width: 40px;
			/* Adjust the size as needed */
			height: 150px;
			/* Ensure the height and width are the same */
			border-radius: 50%;
			/* This makes the image a circle */
			object-fit: cover;
			/* Ensures the image fits within the circle */
		}

		/* Make the body take up the full height of the viewport */
		body {
			display: flex;
			flex-direction: column;
			min-height: 100vh;
			margin: 0;
		}

		/* Ensure the main content takes up all available space */
		main {
			flex: 1;
		}

		/* Style the footer */
		.footer {
			background-color: #f8f9fa;
			/* Light gray background */
			text-align: center;
			/* Center-align text */
			padding: 10px 0;
			/* Add some padding */
			font-size: 14px;
			/* Set font size */
		}

		/* Blinking animation */
		@keyframes blink {

			0%,
			100% {
				opacity: 1;
				/* Fully visible */
			}

			50% {
				opacity: 0;
				/* Invisible */
			}
		}

		/* Target only the Apprisal link for the blinking effect */
		#apprisalLink.blinking {
			animation: blink 0.5s ease-in-out 3;
			/* Blinks 3 times in 0.5s intervals */
		}

		.toast-notification {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: linear-gradient(135deg, #007bff, #00d4ff);
			color: white;
			padding: 15px 20px;
			border-radius: 10px;
			box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			opacity: 0;
			transform: translateX(100%);
			transition: opacity 0.3s ease, transform 0.3s ease-in-out;
			font-family: 'Arial', sans-serif;
			font-size: 14px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			min-width: 250px;
			gap: 10px;
		}

		/* Fade-in effect */
		.toast-notification.show {
			opacity: 1;
			transform: translateX(0);
		}

		/* Close button */
		.toast-close {
			cursor: pointer;
			font-size: 16px;
			opacity: 0.8;
			transition: opacity 0.2s;
		}

		.toast-close:hover {
			opacity: 1;
		}

		/* Fade-out effect */
		.toast-notification:not(.show) {
			opacity: 0;
			transform: translateX(100%);
			transition: opacity 0.3s ease, transform 0.3s ease-in-out;
		}
		

		/* Style for the new feature list item */
			.nav-item.new-feature {
			  position: relative; /* Needed for pseudo-element positioning */
			}

			/* Create the "New" badge with a pseudo-element */
		/*	.nav-item.new-feature::after {
			  content: 'New';
			  position: absolute;
			  top: -8px;
			  right: -10px;
			  background-color: #28a745;
			  color: #fff;
			  font-size: 0.7rem;
			  font-weight: bold;
			  padding: 2px 6px;
			  border-radius: 10px;
			  animation: pulse 2s infinite;
			}*/

			/* Keyframes for a simple pulsating effect */
			/*@keyframes pulse {
			  0% {
			    transform: scale(1);
			    opacity: 1;
			  }
			  50% {
			    transform: scale(1.1);
			    opacity: 0.8;
			  }
			  100% {
			    transform: scale(1);
			    opacity: 1;
			  }
			}*/
			
			/* Ensure version number appears on a new line */
						.release-note-text {
						  display: flex;
						  flex-direction: column; /* Stacks elements vertically */
						  font-size: 1rem;
						}

						/* Optional: Adjust the version number styling */
						.version-number {
						  font-size: 0.9rem;
						  font-weight: bold;
						  color: #555;
						}
						.swal2-container {
						    z-index: 10000 !important;
						}

						.tile:hover {
						    background-color: #e0e0e0;
						    cursor: pointer;
						    transition: background-color 0.3s;
						}	
						.tooltip-text {
						    visibility: hidden;
						    opacity: 0;
						    transition: visibility 0s, opacity 0.2s;
						    z-index: 9999;
						}

						.btn:hover .tooltip-text {
						    visibility: visible;
						    opacity: 1;
						}
						.tile-container {
						    min-height: 200px;
						    background-color: #f8f9fa;
						    padding: 10px;
						    border-radius: 10px;
						    margin-bottom: 20px;
						}

						.draggable {
						    cursor: grab;
						}

						.drag-over {
						    background-color: #e8f5e9;
						    border: 2px dashed #66bb6a;
						    transition: background-color 0.2s, border 0.2s;
						}

						@keyframes glowing {
						    0% {
						        text-shadow: 0 0 5px #fff, 0 0 10px #ff4b2b, 0 0 15px #ff4b2b, 0 0 20px #ff4b2b;
						    }
						    100% {
						        text-shadow: 0 0 10px #fff, 0 0 20px #fbb03b, 0 0 30px #fbb03b, 0 0 40px #fbb03b;
						    }
						}

						@keyframes shimmer {
						    0% {
						        background-position: 0% 50%;
						    }
						    100% {
						        background-position: 100% 50%;
						    }
						}
						@keyframes glowing {
						    0% { background-position: 0% 50%; }
						    100% { background-position: 100% 50%; }
						}

						@keyframes shimmer {
						    0% { opacity: 0.8; }
						    100% { opacity: 1; }
						}

						/* Bigger arrow for select */
						#contactMethod {
						  appearance: none;
						  -webkit-appearance: none;
						  -moz-appearance: none;
						  padding-right: 40px; /* space for arrow */
						  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><polyline points="7 10 12 15 17 10"/></svg>');
						  background-repeat: no-repeat;
						  background-position: right 12px center;
						  background-size: 24px;
						}
						
						
						#meetingcontactMethod {
						  appearance: none;
						-webkit-appearance: none;
					 -moz-appearance: none;
					 padding-right: 40px; /* space for arrow */
					  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><polyline points="7 10 12 15 17 10"/></svg>');
						  background-repeat: no-repeat;
						  background-position: right 12px center;
							  background-size: 24px;
							}
					#taskcontactMethod {
									  appearance: none;
									 -webkit-appearance: none;
								     -moz-appearance: none;
									padding-right: 40px; /* space for arrow */
									  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><polyline points="7 10 12 15 17 10"/></svg>');
									  background-repeat: no-repeat;
									  background-position: right 12px center;
									 background-size: 24px;
								}									
			
					#taskPriority {
												  appearance: none;
												 -webkit-appearance: none;
											     -moz-appearance: none;
												padding-right: 40px; /* space for arrow */
												  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><polyline points="7 10 12 15 17 10"/></svg>');
												  background-repeat: no-repeat;
												  background-position: right 12px center;
												 background-size: 24px;
											}	
											
											.swal2-small-popup {
											    width: 300px !important;
											    padding: 1em !important;
											    font-size: 14px;
											    border-radius: 10px;
											}

											.swal2-small-title {
											    font-size: 18px !important;
											}

											.swal2-small-button {
											    font-size: 14px !important;
											    padding: 6px 12px !important;
											}

											.swal2-small-html {
											    font-size: 13px !important;
											}
											/* Targets all submenu anchor tags under .nav-content */
											.nav-content a {
											    text-decoration: none !important;
											}
											
	</style>
</head>

<body>
	<input type="hidden" id="loggedInDeptName" th:value="${empDetailsByEmpId.deptName}">
	<!-- ======= Header ======= -->
	 <header id="header" class="header fixed-top d-flex align-items-center">
	
		   <div class="d-flex align-items-center logo-container" style="width:45%; margin:0 0 0 10px; padding:5px;">
				    <a class="app-logo" th:href=@{/userDashboard}>
				        <img class="d-none d-lg-block" src="assets/img/logo.png" alt="logo" style="width:200px; height:50px;  padding:0 2px 0 10px; margin:0;">
				    </a>
				    <!--  <i class="bi bi-list toggle-sidebar-btn"></i> -->
				    <!-- <i class="bi bi-chevron-double-left toggle-sidebar-btn" onclick="toggleIconRotation()"></i>	 -->			   
			</div>
   				
   <!-- Include the header fragment -->
   <div th:replace="fragments/header :: header"></div>
  
  </header><!-- End Header -->
	<script>
			function clearSessionStorage() {
			    sessionStorage.clear(); // Clear all session storage data
			}

		</script>
	<!-- ======= Sidebar ======= -->

	<aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/userDashboard}">
                <i class="bi bi-grid"></i>
                <span>Dashboard</span>
            </a>
         </li>
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link " th:href="@{/navbar}">
		        <i class="bi bi-grid"></i>
		        <span>Dashboard</span>
		    </a>
	    </li>
         <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
			<a class="nav-link" th:href="@{/Departmentdoc}">
				<i class="bi bi-journal-bookmark"></i>
				<span>MSPL DocVault</span>
			</a>
		</li>
		
		<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
			<a class="nav-link" th:href="@{/Departmentdoc}">
				<i class="bi bi-journal-bookmark"></i>
				<span>MSPL DocVault</span>
			</a>
		</li>
		<li class="nav-item" th:if="${session.permissions.dispatch && empDetailsByEmpId.deptId==0}">
            <a class="nav-link" th:href="@{/dispatchIframe}">
                <i class="bi bi-truck"></i>
                <span>Dispatched Details</span>
            </a>
        </li>
         <li class="nav-item">
            <a class="nav-link" th:href="@{/viewAdminProfile(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-person"></i>
                <span>My Profile</span>
            </a>
        </li>  
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
			<a class="nav-link" th:href="@{/attendanceLive(email=${empDetailsByEmpId.email})}">
				<i class="bi bi-calendar3"></i>
				<span>Attendance</span>
			</a>
	    </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		     <a class="nav-link" th:href="@{/addInterComm}">
                <i class="bi bi-telephone"></i>
                <span>Communication</span>
            </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		     <a class="nav-link" th:href="@{/groupMailId}">
                <i class="bi bi-envelope-open"></i>
                <span>Group Mail Id</span>
            </a>
	 </li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		<a class="nav-link" th:href="@{/hikeRatingForm}">
			<i class="bi bi-arrow-up-circle"></i><span>Appraisal Ratings</span>
		</a>
	</li>
	<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		<a class="nav-link" th:href="@{/apprisalEmployee}">
			<i class="bi bi-check-square"></i><span>Submitted Appraisals</span>
		</a>
	</li>
	 <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
          <a class="nav-link" href="hrActivity">
	        <i class="bi bi-file-lock"></i><span>Permissions</span>
	    </a>
      </li>
       <!--  <li class="nav-item">
            <a class="nav-link" th:href="@{/InterCommDetails}">
                <i class="bi bi-telephone"></i>
                <span>InterComm Details</span>
            </a>
        </li> -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/adminHoliday}">
                <i class="bi bi-calendar4-week"></i>
                <span>Holiday List</span>
            </a>
        </li>
        <li class="nav-item">
		    <a class="nav-link" th:href="@{/employee}">
		        <i class="bi bi-people"></i>	
		        <span>Employee</span>
		    </a>
	    </li> 
	    <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-card-text"></i>
                <span>Team Leaves</span>
            </a>
        </li>
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
		    <a class="nav-link"  th:href="@{/viewAdminLeaves(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-calendar4-week"></i>
		        <span>Employee Leaves</span>
		    </a>
	 	</li> 
        <li class="nav-item" th:if="${empDetailsByEmpId.deptId>0}">
            <a class="nav-link" th:href="@{/events}">
                <i class="bi bi-megaphone"></i>
                <span>Announcement</span>
            </a>
        </li>
          
        <li class="nav-item">
            <a class="nav-link" th:href="@{/asset}">
                <i class="bi bi-wallet"></i>
                <span>Assets</span>
            </a>
        </li>  
        <li class="nav-item">
			<a class="nav-link" th:href="@{/ongoingProject}">
				<i class="bi bi-card-heading"></i>
				<span>Projects</span>
			</a>
	   </li> 
	  <!--  <li class="nav-item">
            <a class="nav-link" th:href="@{/viewAdminPayslip(empid=${empDetailsByEmpId.empid})}">
                <i class="bi bi-file-text"></i>
                <span>Payslip</span>
            </a>
        </li> -->
	   <!-- Loop through the permissions map -->
         <li class="nav-item" th:if="${permissions.interviewAccess}">
             <a class="nav-link" th:href="@{/moatIframe}">
                <i class="bi bi-vector-pen"></i>
                <span>Interview</span>
            </a>
         </li>
               <li class="nav-item new-feature" th:if="${empDetailsByEmpId.deptId==0}">
			    <a class="nav-link collapsed" data-bs-target="#interview-summary-submenu" data-bs-toggle="collapse" href="#">
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Interview Summary</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a> 
			    <ul id="interview-summary-submenu" class="nav-content collapse" data-bs-parent="#sidebar-nav">
			        <li>
		            <a href="totalCandidatesList">
		              <i class="bi bi-circle"></i><span>Total Candidates</span>
			            </a>
			          </li>
			        <li>
		            <a href="selectedCandidatesList">
		              <i class="bi bi-circle"></i><span>Selected Candidates</span>
		            </a>
		          </li>
		          <li>
		            <a href="rejectedCandidatesList">
		              <i class="bi bi-circle"></i><span>Rejected Candidates</span>
		            </a>
		          </li>
			    </ul>
			</li>
         <li class="nav-item new-feature">
			    <a class="nav-link  active" data-bs-target="#presales-submenu" data-bs-toggle="collapse" href="#" >
			        <i class="bi bi-layout-text-window-reverse"></i>
			        <span>Pre-sales</span>
			        <i class="bi bi-chevron-down ms-auto"></i>
			    </a>
			    <ul id="presales-submenu" class="nav-content" data-bs-parent="#sidebar-nav">
			        <li>
			            <a th:href="@{/crm}">
			                <i class="bi bi-circle"></i><span>Activity</span>
			            </a>
			        </li>
			        <li>
			            <a th:href="@{/deals}" class="active">
			                <i class="bi bi-circle"></i><span>Pipedrive</span>
			            </a>
			        </li>			         
			    </ul>
		 </li>
         <li class="nav-item" th:if="${permissions.sales}">
            <a class="nav-link" th:href="@{/sales}">
                <i class="bi bi-cart3"></i>
                <span>Sales</span>
            </a>
        </li>
         
         <li class="nav-item" th:if="${permissions.accountsAccess}">
            <a class="nav-link" th:href="@{/accounts}">
                <i class="bi bi-person-vcard"></i>
                <span>Accounts</span>
            </a>
        </li>        
		<li class="nav-item" th:if="${permissions.storeAccess}">
		    <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#storeSubmenu" role="button" aria-expanded="false" aria-controls="storeSubmenu">
		        <span>
		            <i class="bi bi-shop-window"></i>
		            <span>Store</span>
		        </span>
		        <i class="bi bi-chevron-down" id="storeArrow"></i>
		    </a>
		    <ul class="collapse list-unstyled ms-3" id="storeSubmenu">
		        <li class="nav-item">
		            <a class="nav-link" th:href="@{/asset}">
		                <i class="bi bi-wallet"></i>
		                <span>Assets</span>
		            </a>
		        </li>
		    </ul>
		</li>

		<li class="nav-item" th:if="${permissions.apprisalAccess}">
		    <a class="nav-link" id="apprisalLink" th:href="@{/apprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Appraisal</span>
		    </a>
		</li>		
		<li class="nav-item" >
		    <a class="nav-link" id="apprisalLink" th:href="@{/employeeApprisal(empid=${empDetailsByEmpId.empid})}">
		        <i class="bi bi-file-text"></i>
		        <span>Employee Appraisal</span>
		    </a>
		</li>
		<li class="nav-item" th:if="${empDetailsByEmpId.deptId==0}">
			    <a class="nav-link" href="feedbackReports">
			        <i class="bi bi-chat-square-text"></i>
			        <span>Feedback Reports</span>
			    </a>
		 </li>
		<li class="nav-item">
				<a class="nav-link" th:href="@{/my-favorites}">
					<i class="bi bi-layout-text-window-reverse"></i>
					<span>To-Chat & Remind</span>
					<span id="unreadCountBadge" class="badge bg-primary" style="display: none;"></span>
				</a>
		</li>
		<li class="nav-item new-feature">
					    <a class="nav-link" th:href="@{/releasenotes}">
					        <i class="bi bi-layout-text-window-reverse"></i>
					        <span class="release-note-text">
					            Release Note 
					            <span class="version-number">(V.0.1.2)</span>
					        </span>
					    </a>
		</li>
    </ul>
</aside>

	<main id="main" class="main">

		<div class="pagetitle  mb-0 d-flex">
			<i class="bi bi-chevron-double-left toggle-sidebar-btn mb-1" onclick="toggleIconRotation()"
				style="font-size:24px;color:#2F73B9;padding:0 10px;margin-left:-10px;margin-top:-10px"></i>
			<nav>
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="userDashboard">Home</a></li>
					<li class="breadcrumb-item active">Pipedrive</li>
				</ol>
			</nav>
			<!-- Toggle Button -->
		<!--	<div class="text-end mb-3">
			    <button class="btn btn-primary" onclick="toggleView()">Toggle View</button>
			</div>-->
		</div><!-- End Page Title -->

		<input type="hidden" id="roleValue" th:value="${session.role_name}">

		<section class="section dashboard">
			
			<div class="row" id="defaultView" >
				<div class="col-lg-3">
				    <div class="card" style="margin-top: -8px;">
				        <div class="card-body" style="display: flex; flex-direction: column; justify-content: space-between; min-height: 200px;">
				            <h5 class="card-title" style="margin-top: -32px;">Call</h5>
				            
				            <!-- Tiles Section -->
				            <div id="callScheduleTiles" class="container my-4 tile-container" style="margin-top: -40px;"></div>
				            
				            <!-- Centered Button -->
				            <button 
				                style="background-color: transparent; color: black; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; margin: auto;" 
				                onclick="openCallScheduleForm()">+</button>
				        </div>
				    </div>
				</div>
				


				<div class="col-lg-3">
				    <div class="card" style="margin-top: -8px;">
				        <div class="card-body" style="display: flex; flex-direction: column; justify-content: space-between; min-height: 200px;">
				            <h5 class="card-title" style="margin-top: -32px;">Meeting</h5>
				            <div id="meetingArrangedTiles" class="container my-4 tile-container"></div>
				            <button 
				                style="background-color: transparent; color: black; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; margin: auto;" 
				                onclick="openMeetingForm()">+</button>
				        </div>
				    </div>
				</div>
			        
				<div class="col-lg-3">
				    <div class="card" style="margin-top: -8px;">
				        <div class="card-body" style="display: flex; flex-direction: column; justify-content: space-between; min-height: 200px;">
				            <h5 class="card-title" style="margin-top: -32px;">Task</h5>
				            <div id="tasksArrangedTiles" class="container my-4 tile-container"></div>
				            <button 
				                style="background-color: transparent; color: black; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; margin: auto;" 
				                onclick="openTaskForm()">+</button>
				        </div>
				    </div>
				</div>
			       <div class="col-lg-3">
			            <div class="card" style="margin-top: -8px;">
			                <div class="card-body">
			                    <h5 class="card-title" style="margin-top: -32px;">Completed</h5>
								<div id="completedArrangedTiles" class="container my-4 tile-container"></div>
								<div id="completedMoreTiles" class="row" style="display: none;"></div>
												<button id="viewMoreCompletedBtn" class="btn btn-sm btn-outline-secondary mt-2" style="display: none;">View More Completed</button>
			                </div>
			            </div>
			        </div>


			    </div>
				
				<!-- Alternate View Container (initially hidden) -->
			<!--	<div id="alternateView" class="row d-none">
				    <div class="col-lg-12">
				        <div class="card">
				            <div class="card-body">
				            
				                <div class="d-flex flex-wrap justify-content-between">
				                    <div class="p-3 bg-light rounded m-2" style="flex: 1 1 200px;">
				                        <h6>Call</h6>
				                        <div id="altCallTiles"></div>
				                    </div>
				                    <div class="p-3 bg-light rounded m-2" style="flex: 1 1 200px;">
				                        <h6>Meeting</h6>
				                        <div id="altMeetingTiles"></div>
				                    </div>
				                    <div class="p-3 bg-light rounded m-2" style="flex: 1 1 200px;">
				                        <h6>Task</h6>
				                        <div id="altTaskTiles"></div>
				                    </div>
				                    <div class="p-3 bg-light rounded m-2" style="flex: 1 1 200px;">
				                        <h6>Completed</h6>
				                        <div id="altCompletedTiles"></div>
				                    </div>
				                </div>
				            </div>
				        </div>
				    </div>
				</div>--->
				<script>
				function toggleView() {
				    const defaultView = document.getElementById("defaultView");
				    const alternateView = document.getElementById("alternateView");

				    if (defaultView.classList.contains("d-none")) {
				        defaultView.classList.remove("d-none");
				        alternateView.classList.add("d-none");
				    } else {
				        defaultView.classList.add("d-none");
				        alternateView.classList.remove("d-none");
				    }
				}
				</script>	
				<div id="callScheduleModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
				    <div class="modal-content" style="background-color: #ffffff; margin: 5% auto; padding: 30px 40px; border-radius: 15px; width: 40%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: relative;">
				        
				        <!-- Close Icon -->
				        <span class="close" onclick="closeCallScheduleForm()" style="color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; position: absolute; top: 20px; right: 30px;">&times;</span>
				        
				        <!-- Heading with Reduced Font Size -->
				        <h3 style="margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; font-size: 22px;">Schedule a Call</h3>
				        
				        <form onsubmit="submitCallScheduleForm(event)">
				            <div class="form-group" style="margin-bottom: 15px; position: relative;">
				                <label>Company Name</label>
								<input type="text" id="callCompanySearchInput" class="form-control" 
								       oninput="searchCompany(this.value, 'call')" 
								       placeholder="Search Company..." 
								       style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
								<ul id="callCompanySearchResults" class="search-results" 
								    style="position: absolute; top: 100%; left: 0; width: 100%; background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; padding: 0; list-style: none;"></ul>

				               		            </div>

				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Contact Person</label>
								<div id="callContactPersonContainer"></div>
				                 </div>
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Phone Number</label>
				                <input type="text" id="callPhoneNumber" class="form-control" readonly style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				            </div>
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Schedule (From - To)</label>
				                <div style="display: flex; gap: 10px;">
				                    <input type="datetime-local" id="fromTime" class="form-control" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;" >
				                    <input type="datetime-local" id="toTime" class="form-control" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				                </div>
				            </div>
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Contact Made Through</label>
				                <select id="contactMethod" class="form-control" >
				                    <option value="">Select Method</option>
				                    <option value="call">Call</option>
				                    <option value="email">Email</option>
				                    <option value="whatsapp">WhatsApp</option>
				                    <option value="sms">SMS</option>
				                </select>
				            </div>
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Notes</label>
				                <textarea id="notes" class="form-control" rows="3" placeholder="Add notes for the call" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
				            </div>
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Description</label>
				                <textarea id="description" class="form-control" rows="3" placeholder="Add description for the call" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
				            </div>
				            <button type="submit" class="btn btn-primary" style="width: 100%; background-color: #007bff; border: none; border-radius: 8px; padding: 12px; font-size: 16px;">Schedule Call</button>
				        </form>
				    </div>
				</div>

				<div id="meetingModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
				    <div class="modal-content" style="background-color: #ffffff; margin: 5% auto; padding: 30px 40px; border-radius: 15px; width: 40%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: relative;">
				        
				        <!-- Close Icon -->
				        <span class="close" onclick="closeMeetingForm()" style="color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; position: absolute; top: 20px; right: 30px;">&times;</span>
				        
				        <!-- Heading -->
				        <h3 style="margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; font-size: 22px;">Meeting Details</h3>
				        
				        <form onsubmit="submitMeetingForm(event)">
							<div class="form-group" style="margin-bottom: 15px; position: relative;">
							    <label>Company Name <span style="color: red;">*</span></label>
								<input type="text" id="meetingCompanySearchInput" class="form-control" 
								       oninput="searchCompany(this.value, 'meeting')" 
								       placeholder="Search Company..." 
								       style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;" required>
								<ul id="meetingCompanySearchResults" class="search-results" 
								    style="position: absolute; top: 100%; left: 0; width: 100%; background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; padding: 0; list-style: none;"></ul>

							   		</div>

									<!-- Meeting Contact Person -->
									<div class="form-group" style="margin-bottom: 15px;">
									    <label>Contact Person <span style="color: red;">*</span></label>
										<div id="meetingContactPersonContainer"></div>
														          
									</div>

									<!-- Meeting Phone Number -->
									<div class="form-group" style="margin-bottom: 15px;">
									    <label>Phone Number <span style="color: red;">*</span></label>
									    <input type="text" id="meetingPhoneNumber" class="form-control" readonly 
									           style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;" required>
									</div>
									<div class="form-group" style="margin-bottom: 15px;">
												                <label>Contact Made Through</label>
												                <select id="meetingcontactMethod" class="form-control" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
												                    <option value="">Select Method</option>
												                    <option value="call">Call</option>
												                    <option value="email">Email</option>
												                    <option value="whatsapp">WhatsApp</option>
												                    <option value="sms">SMS</option>
												                </select>
												            </div>

				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Meeting Title</label>
				                <input type="text" id="meetingTitle" class="form-control" placeholder="Enter meeting title" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				            </div>

				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Participants</label>
				                <textarea id="participants" class="form-control" rows="2" placeholder="Add participants" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
				            </div>

				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Schedule (From - To)</label>
				                <div style="display: flex; gap: 10px;">
				                    <input type="datetime-local" id="meetingFromTime" class="form-control" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				                    <input type="datetime-local" id="meetingToTime" class="form-control" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				                </div>
				            </div>

				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Agenda</label>
				                <textarea id="agenda" class="form-control" rows="3" placeholder="Add meeting agenda" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
				            </div>

				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Location</label>
				                <input type="text" id="meetingLocation" class="form-control" placeholder="Enter location" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				            </div>

				            <button type="submit" class="btn btn-primary" style="width: 100%; background-color: #007bff; border: none; border-radius: 8px; padding: 12px; font-size: 16px;"> Save Meeting Details</button>
				        </form>
				    </div>
				</div>

				<div id="taskModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
				    <div class="modal-content" style="background-color: #ffffff; margin: 5% auto; padding: 30px 40px; border-radius: 15px; width: 40%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: relative;">
				        
				        <!-- Close Icon -->
				        <span class="close" onclick="closeTaskForm()" style="color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; position: absolute; top: 20px; right: 30px;">&times;</span>
				        
				        <!-- Heading -->
				        <h3 style="margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; font-size: 22px;">Create a Task</h3>
				        
				        <form onsubmit="submitTaskForm(event)">
				            <!-- Company Name -->
				            <div class="form-group" style="margin-bottom: 15px; position: relative;">
				                <label>Company Name <span style="color: red;">*</span></label>
				                <input type="text" id="taskCompanySearchInput" class="form-control" 
				                       oninput="searchCompany(this.value, 'task')" 
				                       placeholder="Search Company..." 
				                       style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;" required>
				                <ul id="taskCompanySearchResults" class="search-results" 
				                    style="position: absolute; top: 100%; left: 0; width: 100%; background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; padding: 0; list-style: none;"></ul>
				            </div>

				            <!-- Contact Person -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Contact Person <span style="color: red;">*</span></label>
								<div id="taskContactPersonContainer"></div>
												          
				            </div>

				            <!-- Phone Number -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Phone Number <span style="color: red;">*</span></label>
				                <input type="text" id="taskPhoneNumber" class="form-control" readonly 
				                       style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;" required>
				            </div>

				            <!-- Contact Method -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Contact Made Through</label>
				                <select id="taskcontactMethod" class="form-control" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				                    <option value="">Select Method</option>
				                    <option value="call">Call</option>
				                    <option value="email">Email</option>
				                    <option value="whatsapp">WhatsApp</option>
				                    <option value="sms">SMS</option>
				                </select>
				            </div>

				            <!-- Task Name -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Task Name</label>
				                <input type="text" id="taskName" class="form-control" placeholder="Enter task name" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				            </div>

				            <!-- Assignee -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Assignee</label>
				                <input type="text" id="taskAssignee" class="form-control" placeholder="Assign to" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				            </div>

				            <!-- Assign Date (New Field) -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Assign Date</label>
				                <input type="datetime-local" id="taskAssignDate" class="form-control" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				            </div>

				            <!-- Deadline -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Deadline</label>
				                <input type="datetime-local" id="taskDeadline" class="form-control" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				            </div>

				            <!-- Description -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Description</label>
				                <textarea id="taskDescription" class="form-control" rows="3" placeholder="Add task description" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
				            </div>

				            <!-- Priority -->
				            <div class="form-group" style="margin-bottom: 15px;">
				                <label>Priority</label>
				                <select id="taskPriority" class="form-control" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
				                    <option value="">Select Priority</option>
				                    <option value="high">High</option>
				                    <option value="medium">Medium</option>
				                    <option value="low">Low</option>
				                </select>
				            </div>

				            <!-- Submit Button -->
				            <button type="submit" class="btn btn-primary" style="width: 100%; background-color: #007bff; border: none; border-radius: 8px; padding: 12px; font-size: 16px;">Create Task</button>
				        </form>
				    </div>
				</div>

	<!-- Completed Modal -->
				<div class="modal fade" id="completedModal" tabindex="-1" aria-labelledby="completedModalLabel" aria-hidden="true">
				  <div class="modal-dialog modal-lg modal-dialog-scrollable">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="completedModalLabel">More Completed Schedules</h5>
				        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				      </div>
				      <div class="modal-body">
				        <div id="completedModalTiles" class="row gy-2"></div>
				      </div>
				    </div>
				  </div>
				</div>

			<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
						    <div class="modal-dialog">
						        <div class="modal-content rounded-4 shadow-lg">
						            <div class="modal-header border-0">
						                <h5 class="modal-title" id="feedbackModalLabel">Feedback Form</h5>
						                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						            </div>
						            <div class="modal-body">
						                <form id="feedbackForm" method="post" enctype="multipart/form-data">
						                    <div class="mb-3" style="display: none;">
						                        <label for="feedbackName" class="form-label fw-bold">Your Name</label>
						                        <input type="text" class="form-control" id="feedbackName" name="name" th:value="${empDetailsByEmpId.fullName}" readonly>
						                    </div>
						                    <div class="mb-3" style="display: none;">
						                        <label for="feedbackEmail" class="form-label fw-bold">Your Email</label>
						                        <input type="email" class="form-control" id="feedbackEmail" name="email" th:value="${empDetailsByEmpId.email}" readonly>
						                    </div>
						                    <div class="mb-3">
						                        <label for="feedbackEmailyy" class="form-label fw-bold">To</label>
						                        <div class="to-field-container">
						                            <span class="to-field rounded-pill px-3 py-2 shadow-sm">bugs_msplconnect@melangesystems.com</span>
						                        </div>
						                    </div>
											<div class="mb-3">
											    <label for="bugType" class="form-label fw-bold">Bug Type</label>
											    <select class="form-control" id="bugType" name="bugType" required>
											        <option value="About Application">About Application</option>
											        <option value="New Feature">New Feature</option>
											    </select>
											</div>

						                    <div class="mb-3">
						                        <label for="feedbackMessage" class="form-label fw-bold">Message</label>
						                        <textarea class="form-control" id="feedbackMessage" name="message" rows="4" placeholder="Enter your feedback here..." required></textarea>
						                    </div>
						                    <div class="mb-3">
						                        <label for="feedbackAttachment" class="form-label fw-bold">Attachment (optional)</label>
						                        <input type="file" class="form-control" id="feedbackAttachment" name="attachment" accept=".png, .jpg, .jpeg" multiple>
						                        <small class="text-muted">Max size: 5MB. You can upload multiple images.</small>
						                    </div>
						                    <button type="submit" class="btn btn-primary w-100 mt-3 py-2 shadow-sm" id="submitFeedbackBtn">Submit Feedback</button>
						                </form>
						            </div>
						        </div>
						    </div>
						</div>
			
			<!--<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
			    <div class="modal-dialog modal-dialog-centered" role="document">
			        <div class="modal-content">
			            <div class="modal-header">
			                <h5 class="modal-title" id="modalTitle">Call Schedule Details</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			            </div>
			            <div class="modal-body" id="modalBody">
			              
			            </div>
			            <div id="feedbackSection" style="display:none; margin-top: 15px; padding: 15px; border-top: 1px solid #ddd;">
			                <h6>Call Feedback</h6>
			                <div class="form-group">
			                    <label for="callMadeTime">Call Made Time and Date:</label>
			                    <input type="datetime-local" id="callMadeTime" class="form-control">
			                </div>
			                <div class="form-group">
			                    <label for="callFeedback">Feedback:</label>
			                    <textarea id="callFeedback" class="form-control" rows="3" placeholder="Enter feedback"></textarea>
			                </div>
			                <div class="form-group">
			                    <label for="nextAction">Next Process:</label>
			                    <select id="nextAction" class="form-control" onchange="toggleNextScheduleField()">
			                        <option value="">Select</option>
			                        <option value="meeting">Arrange Meeting</option>
			                        <option value="task_assigned">Task Assigned</option>
			                        <option value="callback">Call Back Again</option>
									<option value="completed">Completed</option>
			                        <option value="no_action">No Further Action(Reject)</option>
			                    </select>
			                </div>
							<div class="form-group" id="nextScheduleGroup" style="display:none;">
							       <label for="nextSchedule">Next Schedule Date and Time:</label>
							       <input type="datetime-local" id="nextSchedule" class="form-control">
							   </div>
			                <button type="button" class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
			            </div>
			            <div class="modal-footer" id="modalFooter">
			               
			            </div>
			        </div>
			    </div>
			</div>-->
			
			<!-- Modal HTML -->
			<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
			    <div class="modal-dialog  modal-dialog-centered" role="document">
			        <div class="modal-content">
			            <div class="modal-header">
			                <h5 class="modal-title" id="modalTitle">Call Schedule Details</h5>
			                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			            </div>
			            <div class="modal-body">
			                <!-- Tabs for Details and Call History -->
			                <ul class="nav nav-tabs" id="callScheduleTabs" role="tablist">
			                    <li class="nav-item" role="presentation">
			                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">Details</button>
			                    </li>
			                    <li class="nav-item" role="presentation">
			                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">Activity History</button>
			                    </li>
								
			                </ul>
			                <div class="tab-content" id="callScheduleTabContent">
			                    <div class="tab-pane fade show active" id="details" role="tabpanel"></div>
			                  <!--  <div class="tab-pane fade" id="history" role="tabpanel">
			                        <div id="historyContent" style="padding: 15px;"></div>
			                    </div>-->
								<div class="tab-pane fade" id="history" role="tabpanel">
								    <div style="padding: 15px;">
								        <!-- Toggle button -->
								        <div style="text-align: right; margin-bottom: 10px;">
								            <button id="toggleGraphBtn" class="btn btn-sm btn-primary">Graphical View</button>
											<button id="downloadExcelBtn" class="btn btn-sm btn-success">Download Data</button>
								        </div>

								        <!-- Card view content -->
								        <div id="historyContent"></div>

								        <!-- Graph view -->
								        <div id="graphContent" style="display: none;">
								            <canvas id="historyChart" width="400" height="250"></canvas>
								            <div style="text-align: right; margin-top: 10px;">
								                <button id="backToListBtn" class="btn btn-sm btn-secondary">Back to List View</button>
								            </div>
								        </div>
								    </div>
								</div>

								<div class="tab-pane fade" id="graph" role="tabpanel">
								       <div style="padding: 15px;">
								           <canvas id="historyChart" width="400" height="250"></canvas>
								       </div>
								   </div>
			                </div>
			            </div>
						<div id="feedbackSection" style="display:none; margin-top: 15px; padding: 15px; border-top: 1px solid #ddd;">
						    <h6>Call Feedback</h6>

						    <!-- Call Info -->
						    <div id="callInfo">
						        <div class="form-group">
						            <label for="callMadeTime">Call Made Time and Date:</label>
						            <input type="datetime-local" id="callMadeTime" class="form-control">
						        </div>
						        <div class="form-group">
						            <label for="callFeedback">Feedback:</label>
						            <textarea id="callFeedback" class="form-control" rows="3" placeholder="Enter feedback"></textarea>
						        </div>
						    </div>

						    <!-- Meeting Info -->
						    <div id="meetingInfo" style="display:none;">
						        <div class="form-group">
						            <label for="meetingDateTime">Meeting Date and Time:</label>
						            <input type="datetime-local" id="meetingDateTime" class="form-control">
						        </div>
						        <div class="form-group">
						            <label for="meetingNotes">Meeting Notes:</label>
						            <textarea id="meetingNotes" class="form-control" rows="3" placeholder="Enter meeting notes"></textarea>
						        </div>
						    </div>
							<!-- Reschedule Info -->
							<div id="rescheduleInfo" style="display:none;">
							    
							    <div class="form-group">
							        <label for="rescheduleReason">Reason for Rescheduling:</label>
							        <textarea id="rescheduleReason" class="form-control" rows="3" placeholder="Enter reason for rescheduling"></textarea>
							    </div>
							</div>

							<!-- Task Completed Info -->
							<div id="taskCompletedInfo" style="display:none; margin-top: 15px;">
								<!-- Reason for Delay -->
								   <div id="delayReasonInCompleted" style="display: none;">
								       <div class="form-group">
								           <label for="reasonInCompleted">Reason for Delay (Task Missed Due Date):</label>
								           <textarea id="reasonInCompleted" class="form-control" rows="3" placeholder="Enter reason for delay"></textarea>
								       </div>
								   </div>
							    <div class="form-group">
							        <label for="taskCompletedDate">Task Completed Date:</label>
							        <input type="datetime-local" id="taskCompletedDate" class="form-control">
							    </div>
							    <div class="form-group">
							        <label for="taskDescriptionfortask">Task Description:</label>
							        <textarea id="taskDescriptionfortask" oninput="console.log('Task description input:', this.value)" class="form-control" rows="3" placeholder="Enter task description"></textarea>
							    </div>
							</div>

							<!-- Task Delay Info -->
							<div id="taskDelayInfo" style="display:none; margin-top: 15px;">
							    <div class="form-group">
							        <label for="taskDelayReason">Reason for Delay:</label>
							        <textarea id="taskDelayReason" class="form-control" rows="3" placeholder="Enter reason for task delay"></textarea>
							    </div>
							</div>

						    <!-- Common fields -->
						    <div class="form-group">
						        <label for="nextAction">Next Process:</label>
						        <select id="nextAction" class="form-control" onchange="toggleNextScheduleField()">
						            <option value="">Select</option>
						            <option value="meeting">Arrange Meeting</option>
						            <option value="task_assigned">Task Assigned</option>
						            <option value="callback">Call Back Again</option>
						            <option value="completed">Completed</option>
						            <option value="no_action">No Further Action (Reject)</option>
						        </select>
						    </div>

						    <div class="form-group" id="nextScheduleGroup" style="display:none;">
						        <label for="nextSchedule">Next Schedule Date and Time:</label>
						        <input type="datetime-local" id="nextSchedule" class="form-control">
						    </div>

						    <button type="button" class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
						</div>

			            <div class="modal-footer" id="modalFooter"></div>
			        </div>
			    </div>
			</div>

			<!-- Modal -->
			<div class="modal fade" id="dropActionModal" tabindex="-1" aria-labelledby="dropActionModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="dropActionModalLabel">Choose an Action</h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			      </div>
			      <div class="modal-body" id="dropModalBody">
			        <!-- Buttons will be injected here -->
			      </div>
			    </div>
			  </div>
			</div>


			<!-- Feedback Modal -->
			<div class="modal fade" id="CallfeedbackModal" tabindex="-1" role="dialog" aria-labelledby="callfeedbackModalLabel" aria-hidden="true">
			    <div class="modal-dialog" role="document">
			        <div class="modal-content">
			            <div class="modal-header">
			                <h5 class="modal-title" id="callfeedbackModalLabel">Call Feedback</h5>
			                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			                    <span aria-hidden="true">&times;</span>
			                </button>
			            </div>
			            <div class="modal-body">
			                <form id="feedbackForm">
			                    <div class="form-group">
			                        <label for="callFeedback">Feedback</label>
			                        <textarea id="callFeedback" class="form-control" rows="3" required></textarea>
			                    </div>
			                    <div class="form-group">
			                        <label for="nextProcess">Next Process</label>
			                        <input type="text" id="nextProcess" class="form-control" required>
			                    </div>
			                    <input type="hidden" id="callId">
			                </form>
			            </div>
			            <div class="modal-footer">
			                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
			                <button type="button" class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
			            </div>
			        </div>
			    </div>
			</div>
		</section>




	</main><!-- End #main -->

	<!-- ======= Footer ======= -->
	<!--<footer id="footer" class="footer">
  		<div class="copyright">
  			Copyright &copy; <span id="currentYear"></span> <strong><span>Melange Systems Private
  					Limited</span></strong>. All Rights Reserved
  		</div>
  	</footer>-->
	<script>
		var currentYear = new Date().getFullYear();
		document.getElementById("currentYear").innerHTML = currentYear;
	</script>

	<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
			class="bi bi-arrow-up-short"></i></a>

	<!-- Vendor JS Files -->
	<script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
	<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="assets/vendor/chart.js/chart.umd.js"></script>
	<script src="assets/vendor/echarts/echarts.min.js"></script>
	<script src="assets/vendor/quill/quill.js"></script>
	<script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
	<script src="assets/vendor/tinymce/tinymce.min.js"></script>
	<script src="assets/vendor/php-email-form/validate.js"></script>

	<!-- Template Main JS File -->
	<script src="assets/js/main.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
	
		function loadCallSchedules() {
		    fetch("/call-scheduleall")
		        .then(response => response.json())
		        .then(data => {
					const now = new Date(); // current full datetime

					function getScheduleDate(schedule) {
					    let dateStr = null;
					    if (schedule.nextSchedule && schedule.nextSchedule.trim() !== "") {
					        dateStr = schedule.nextSchedule.trim();
					    } else if (schedule.fromTime && schedule.fromTime.trim() !== "") {
					        dateStr = schedule.fromTime.trim();
					    }
					    if (!dateStr) return null;

					    // Ensure correct ISO format for Date parsing
					    dateStr = dateStr.replace(" ", "T");
					    const dateObj = new Date(dateStr);
					    if (isNaN(dateObj)) return null;
					    return dateObj; // return full date-time
					}

					data.sort((a, b) => {
					    const dateA = getScheduleDate(a);
					    const dateB = getScheduleDate(b);

					    if (!dateA && !dateB) return 0;
					    if (!dateA) return 1;
					    if (!dateB) return -1;

					    function datePriority(d) {
					        if (d.getTime() === now.getTime()) return 0;
					        if (d > now) return d.getTime() - now.getTime(); // future dates ascending
					        return 8640000000000000 + (now.getTime() - d.getTime()); // past dates pushed after future
					    }

					    return datePriority(dateA) - datePriority(dateB);
					});

					    console.log("Datasssssssss: " + JSON.stringify(data)); 
		            const tilesContainer = document.getElementById("callScheduleTiles");
					const meetingArrangedContainer = document.getElementById("meetingArrangedTiles");
					const taskArrangedContainer = document.getElementById("tasksArrangedTiles");
					const completedArrangedContainer = document.getElementById("completedArrangedTiles");

					
		            tilesContainer.innerHTML = "";
					meetingArrangedContainer.innerHTML = "";
					taskArrangedContainer.innerHTML = "";
					completedArrangedContainer.innerHTML = "";
					const completedOverflow = []; // To store extra completed tiles

					 data.forEach((schedule,index) => {
			                // Create the main tile (card)
			                const tile = document.createElement("div");
			                tile.classList.add("card", "mb-2", "shadow-sm", "draggable-tile");
							
			                tile.style.borderRadius = "12px";
			                tile.style.transition = "transform 0.2s, box-shadow 0.2s";
			                tile.style.width = "100%";
			                tile.style.margin = "0 auto";
			                tile.style.padding = "0"; // Remove padding for compact height

							// Add drag attributes
							               tile.setAttribute("draggable", "true");
							               tile.setAttribute("data-id", schedule.id);
							               tile.addEventListener("dragstart", handleDragStart);
							               tile.addEventListener("dragend", handleDragEnd);


		                // Card body
		                const cardBody = document.createElement("div");
		                cardBody.classList.add("card-body", "d-flex", "align-items-center", "justify-content-between");
		                cardBody.style.padding = "10px"; // Reduced padding for compact layout

		                // Company and contact info
		                const infoContainer = document.createElement("div");
		                infoContainer.classList.add("info-container");
						// Add the updated card subheading instead of next task and schedule
						// Add the updated card subheading instead of next task and schedule
						// Add the updated card subheading instead of next task and schedule
						if (schedule.nextAction === "callback" || schedule.nextAction === "Task") {
						    const updatedCardSubheading = document.createElement("p");
						    updatedCardSubheading.textContent = "Updated";
						    updatedCardSubheading.style.fontSize = "10px"; // Smaller font size
						    updatedCardSubheading.style.fontWeight = "bold";
						    updatedCardSubheading.style.backgroundColor = "#f0f8ff"; // Light background color
						    updatedCardSubheading.style.padding = "2px 8px";
						    updatedCardSubheading.style.borderRadius = "4px";
						    updatedCardSubheading.style.color = "#3e2a47"; // Brown text color
						    updatedCardSubheading.style.margin = "0"; // Remove default margin
						    updatedCardSubheading.style.float = "right"; // Align to the right
						    updatedCardSubheading.style.display = "inline-block"; // Prevent height increase

						    // Adding text shadow for glowing effect
						    updatedCardSubheading.style.textShadow = "0 0 5px rgba(255, 255, 255, 0.7), 0 0 10px rgba(255, 255, 255, 0.5), 0 0 15px rgba(255, 255, 255, 0.3)";

						    // Adding shimmering glowing background effect using keyframes
						    updatedCardSubheading.style.background = "linear-gradient(45deg, #f0f8ff, #d1e8e2, #f0f8ff)";
						    updatedCardSubheading.style.backgroundSize = "200% 200%";
						    updatedCardSubheading.style.animation = "shineEffect 3s linear infinite";

						    infoContainer.appendChild(updatedCardSubheading); // Append subheading first
						}

						// Adding CSS for the animation
						const style = document.createElement('style');
						style.innerHTML = `
						@keyframes shineEffect {
						    0% {
						        background-position: 200% 0;
						    }
						    50% {
						        background-position: -200% 0;
						    }
						    100% {
						        background-position: 200% 0;
						    }
						}`;
						document.head.appendChild(style);

		                const companyName = document.createElement("h5");
		                companyName.textContent = schedule.companyName;
		               // companyName.classList.add("card-title", "text-primary", "mb-0", "fw-bold");
					   companyName.classList.add("card-title", "mb-0", "fw-bold");
					   companyName.style.color = "#3e2a47"; // Brown

		                companyName.style.fontSize = "15px"; // Slightly reduced font size
		                companyName.style.marginBottom = "2px"; // Remove gap

		                const contactPerson = document.createElement("p");
		                contactPerson.textContent = schedule.contactPerson;
		                contactPerson.classList.add("card-text", "text-muted", "mb-0");
		                contactPerson.style.fontSize = "13px"; // Smaller font size
		                contactPerson.style.margin = "0"; // Remove gap

						const scheduleTime = document.createElement("p");

						let dateToUse = null;

						if (schedule.nextSchedule && schedule.nextSchedule.trim() !== "") {
						    dateToUse = schedule.nextSchedule;
						} else if (schedule.fromTime && schedule.fromTime.trim() !== "") {
						    dateToUse = schedule.fromTime;
							console.log("Schedule Time displayed:", schedule.fromTime);

						}
						// Log the displayed schedule time text
						console.log("Schedule Time displayed:", dateToUse);

						if (dateToUse) {
						    // Replace space with 'T' for ISO 8601 compliance
						    const isoDateTime = dateToUse.replace(" ", "T");
						    const dateObj = new Date(isoDateTime);

						    if (!isNaN(dateObj)) {
						        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
						        scheduleTime.textContent = dateObj.toLocaleString('en-US', options);
						    } else {
						        scheduleTime.textContent = "Invalid Schedule Time";
						    }
						} else {
						    scheduleTime.textContent = "No Schedule Time";
						}
						// Log the displayed schedule time text
						console.log("Schedule Time displayed:", scheduleTime.textContent);

						scheduleTime.classList.add("card-text", "text-muted", "mb-0");
						scheduleTime.style.fontSize = "12px";
						scheduleTime.style.marginTop = "4px";

							
		                infoContainer.appendChild(companyName);
		                infoContainer.appendChild(contactPerson);
						infoContainer.appendChild(scheduleTime);
						// Add the next task and schedule date if the nextAction is "Call Back Meeting" or "Task"
						// Add th

		                // Arrow button with tooltip
		                const arrowButton = document.createElement("button");
		                arrowButton.classList.add("btn", "btn-light", "rounded-circle", "shadow-sm", "d-flex", "justify-content-center", "align-items-center");
		                arrowButton.style.width = "30px";  // Smaller width
		                arrowButton.style.height = "30px"; // Smaller height
		                arrowButton.style.transition = "background-color 0.2s, transform 0.2s";
		                arrowButton.style.position = "relative";
		                arrowButton.style.padding = "0";
		                arrowButton.style.border = "none";

		                // Tooltip
		                const tooltip = document.createElement("span");
		                tooltip.classList.add("tooltip-text");
		                tooltip.style.position = "absolute";
		                tooltip.style.bottom = "40px";
		                tooltip.style.left = "50%";
		                tooltip.style.transform = "translateX(-50%)";
		                tooltip.style.backgroundColor = "#444";
		                tooltip.style.color = "#fff";
		                tooltip.style.padding = "5px 8px";
		                tooltip.style.borderRadius = "4px";
		                tooltip.style.fontSize = "12px";
		                tooltip.style.opacity = "0";
		                tooltip.style.transition = "opacity 0.2s";

						// Date handling
						let fromDateString = "";

						// Debug the actual value of next_schedule
						console.log("Raw next_schedule:", schedule.nextSchedule);

						// Use next_schedule if available, otherwise fallback to fromTime
						if (schedule.nextSchedule != null && schedule.nextSchedule.trim() !== "") {
						    fromDateString = schedule.nextSchedule.trim();
						    console.log("Using next_schedule:", fromDateString);
						} else if (schedule.fromTime && schedule.fromTime.trim() !== "") {
						    fromDateString = schedule.fromTime.trim();
						    console.log("Falling back to fromTime:", fromDateString);
						} else {
						    console.log("No valid date found in next_schedule or fromTime.");
						}

						// Normalize only non-ISO formats (skip normalization if it's a proper ISO datetime)
						if (fromDateString.includes("-") && !fromDateString.includes("T")) {
						    const parts = fromDateString.split("-");
						    if (parts[0].length !== 4) {
						        const original = fromDateString;
						        fromDateString = `${parts[2]}-${parts[1]}-${parts[0]}`;
						        console.log(`Normalized date from ${original} to ${fromDateString}`);
						    }
						}

						// Create date objects
						const fromDate = new Date(fromDateString).setHours(0, 0, 0, 0);
						const today = new Date().setHours(0, 0, 0, 0);

						console.log("From date (ms):", fromDate, " | Today (ms):", today);
						let arrowStrokeColor = "white"; // default color for arrow

						if (schedule.nextAction === "completed") {
						    arrowButton.style.backgroundColor = "#f5f5f5"; // Light grey
						    arrowButton.style.border = "1px solid #ccc";  // Border for visibility
						    arrowStrokeColor = "#757575"; // Medium grey arrow for visibility
						    tooltip.textContent = "Completed";
						    console.log("Date status: Completed");
						} else if (fromDate === today) {
						    arrowButton.style.backgroundColor = "#66bb6a"; // Lighter green for today
						    tooltip.textContent = "Today";
						    console.log("Date status: Today");
						} else if (fromDate < today) {
						    arrowButton.style.backgroundColor = "#ef5350"; // Lighter red for past
						    tooltip.textContent = "Overdue";
						    console.log("Date status: Overdue");
						} else {
						    arrowButton.style.backgroundColor = "#bdbdbd"; // Lighter grey for future
						    tooltip.textContent = "Upcoming";
						    console.log("Date status: Upcoming");
						}

		                // Arrow icon (smaller)
		                arrowButton.innerHTML = `
		                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
		                        <path d="M15 18L9 12L15 6" stroke="${arrowStrokeColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
		                    </svg>
		                `;

		                // Tooltip show/hide
		                arrowButton.addEventListener("mouseover", () => {
		                    arrowButton.style.transform = "scale(1.1)";
		                    tooltip.style.opacity = "1";
		                });
		                arrowButton.addEventListener("mouseout", () => {
		                    arrowButton.style.transform = "scale(1)";
		                    tooltip.style.opacity = "0";
		                });

		                // Add click event to fetch full details
		                arrowButton.addEventListener("click", () => {
		                    fetchCallScheduleDetails(schedule.id);
		                });

		                // Append the tooltip and arrow button
		                arrowButton.appendChild(tooltip);

		                // Append elements to the tile
		                cardBody.appendChild(infoContainer);
		                cardBody.appendChild(arrowButton);
		                tile.appendChild(cardBody);
						
		        		// Append to the correct container based on nextAction
		                if (schedule.nextAction === "meeting") {
		                    meetingArrangedContainer.appendChild(tile);
		                } else	if (schedule.nextAction === "task_assigned") {
							  taskArrangedContainer.appendChild(tile);
						 } else	if (schedule.nextAction === "completed") {
							if (completedArrangedContainer.childElementCount < 2) {
							           completedArrangedContainer.appendChild(tile);
							       } else {
							           completedOverflow.push(tile);
							       }
						  } else {
		                    tilesContainer.appendChild(tile);
		                }
		
      //  tilesContainer.appendChild(tile);
    });

	// Setup modal and button logic
	const completedModalTiles = document.getElementById("completedModalTiles");
	const viewMoreBtn = document.getElementById("viewMoreCompletedBtn");

	if (completedOverflow.length > 0) {
	    viewMoreBtn.style.display = "block";

	    viewMoreBtn.onclick = () => {
	        completedModalTiles.innerHTML = ""; // Clear modal

			// Create rows of 3 tiles
			for (let i = 0; i < completedOverflow.length; i += 3) {
			    const row = document.createElement("div");
			    row.className = "row mb-3"; // space between rows

			    for (let j = i; j < i + 3 && j < completedOverflow.length; j++) {
			        const col = document.createElement("div");
			        col.className = "col-md-4 mb-3"; // 3 per row

			        col.appendChild(completedOverflow[j]);
			        row.appendChild(col);
			    }

			    completedModalTiles.appendChild(row);
			}

	        // Show modal
	        const modal = new bootstrap.Modal(document.getElementById('completedModal'));
	        modal.show();
	    };
	} else {
	    viewMoreBtn.style.display = "none";
	}
	// Add drag and drop event listeners to the containers
	          addDragDropHandlers(tilesContainer);
	          addDragDropHandlers(meetingArrangedContainer);
			  addDragDropHandlers(taskArrangedContainer);
			  addDragDropHandlers(completedArrangedContainer);
})
.catch(error => console.error("Error fetching call schedules:", error));
}


		
		function handleDragStart(e) {
		    e.dataTransfer.setData("text/plain", e.target.dataset.id);
		    e.target.classList.add("dragging");
		}

		function handleDragEnd(e) {
		    e.target.classList.remove("dragging");
		}

		function addDragDropHandlers(container) {
		    container.addEventListener("dragstart", e => {
		        const draggedTile = e.target;
		        if (draggedTile && draggedTile.dataset && draggedTile.dataset.id) {
		            // Set the dragged element ID
		            e.dataTransfer.setData("text/plain", draggedTile.dataset.id);
		            // Set the source container ID (parent element's id)
		            e.dataTransfer.setData("source-container", draggedTile.parentElement.id);
		        }
		    });

		    container.addEventListener("dragover", e => {
		        e.preventDefault();
		        container.classList.add("drag-over");
		    });

		    container.addEventListener("dragleave", () => {
		        container.classList.remove("drag-over");
		    });

		    container.addEventListener("drop", e => {
		        e.preventDefault();
		        container.classList.remove("drag-over");

		        const id = e.dataTransfer.getData("text/plain");
		        const sourceContainerId = e.dataTransfer.getData("source-container");
		        const targetContainerId = container.id;

		        const draggedTile = document.querySelector(`[data-id='${id}']`);

		        // Example usage of container IDs and dragged element ID
		        console.log("Dragged tile ID:", id);
		        console.log("Source container ID:", sourceContainerId);
		        console.log("Target container ID:", targetContainerId);

		        if (draggedTile && sourceContainerId !== targetContainerId) {
		            showDropForm(id, container, sourceContainerId);
					// Now auto-select dropdown option based on target container id
					const nextActionSelect = document.getElementById("nextAction1");
					       if (!nextActionSelect) return;

					       // Set the value based on target container id
					       switch (targetContainerId) {
					           case "callScheduleTiles":
					               nextActionSelect.value = "callback";
					               break;
					           case "tasksArrangedTiles":
					               nextActionSelect.value = "task_assigned";
					               break;
					           case "meetingArrangedTiles":
					               nextActionSelect.value = "meeting";
					               break;
								   case "completedArrangedTiles":
								           nextActionSelect.value = "completed";
								           break;
					           default:
					               nextActionSelect.value = "";
					               break;
					       }

					       // Disable the dropdown to prevent user changes
					       nextActionSelect.disabled = true;

					       // Call toggle function manually to update UI
					       toggleNextScheduleFieldneww();
		        }
		    });
		}

		let currentCallId1 = null; 
		let feedbackFlag = null;

		function showDropForm(id, container,sourceContainerId) {
			//alert("container "+ sourceContainerId);
		    const modalBody = document.getElementById("dropModalBody");
		    modalBody.innerHTML = ""; // Clear previous content

		    const buttonGroup = document.createElement("div");
		    buttonGroup.classList.add("button-group", "d-flex", "gap-2", "flex-wrap");

		    if (sourceContainerId === "tasksArrangedTiles") {
		        buttonGroup.innerHTML = `
		            <button type="button" class="btn btn-info" onclick="handleTaskAction('${id}', 5)">Task Status</button>
		           
		        `;
		    } else if (sourceContainerId  === "callScheduleTiles") {
		        buttonGroup.innerHTML = `
		            <button type="button" class="btn btn-success" onclick="startFeedbackcall('${id}', 1)" >Yes, Call Made</button>
		           
		        `;
		    } else if (  sourceContainerId === "meetingArrangedTiles") {
		        buttonGroup.innerHTML = `
		            <button type="button" class="btn btn-primary" onclick="showMeetingFields('${id}',3)">Meeting Held</button>
		           
		        `;
		    } else {
		        buttonGroup.innerHTML = `
		            <button type="button" class="btn btn-success" onclick="completed('${id}', 1)">Completed</button>
		           
		        `;
		    }

		    modalBody.appendChild(buttonGroup);

		    // Add hidden common fields
		    const commonFields = document.createElement("div");
		    commonFields.id = "commonFieldsContainer";
		    commonFields.style.display = "none"; // hidden by default
		    commonFields.innerHTML = `
		        <div class="form-group mt-3">
		            <label for="nextAction1">Next Process:</label>
		            <select id="nextAction1" class="form-control" onchange="toggleNextScheduleFieldneww()">
		                <option value="">Select</option>
		                <option value="meeting">Arrange Meeting</option>
		                <option value="task_assigned">Task Assigned</option>
		                <option value="callback">Call Back Again</option>
		                <option value="completed">Completed</option>
		                <option value="no_action">No Further Action (Reject)</option>
		            </select>
		        </div>

		        <div class="form-group" id="nextScheduleGroup1" style="display:none;">
		            <label for="nextSchedule1">Next Schedule Date and Time:</label>
		            <input type="datetime-local" id="nextSchedule1" class="form-control">
		        </div>

		        <button type="button" class="btn btn-primary mt-3" onclick="submitFeedback1()">Submit Feedback</button>
		    `;
		    modalBody.appendChild(commonFields);

		    const modal = new bootstrap.Modal(document.getElementById('dropActionModal'));
		    modal.show();
		}

		
		function completed(id, status) {
		    const modalBody = document.getElementById("dropModalBody");

		    // Remove all previously injected field groups
		    ['meetingFieldsContainer', 'rescheduleFieldsContainer', 'feedbackFieldsContainer', 'taskFieldsContainer', 'taskDelayFieldsContainer', 'completedFieldsContainer'].forEach(containerId => {
		        const existing = document.getElementById(containerId);
		        if (existing) existing.remove();
		    });

		    // Clear and set only the Submit Feedback button inside commonFieldsContainer
		    const commonFields = document.getElementById("commonFieldsContainer");
		    if (commonFields) {
		        commonFields.innerHTML = `
		            <button type="button" class="btn btn-primary mt-3" onclick="submitFeedback1()">Submit Feedback</button>
		        `;
		        commonFields.style.display = "block";
		    }

		    // Create and insert completed field
		    const completedFields = document.createElement("div");
		    completedFields.id = "completedFieldsContainer";
		    completedFields.innerHTML = `
		        <div class="form-group mt-3">
		            <label for="completedDescription">Is your entire track completed? Describe:</label>
		            <textarea id="completedDescription" class="form-control" rows="3" placeholder="Enter completion details"></textarea>
		        </div>
		    `;

		    modalBody.insertBefore(completedFields, commonFields);
		}

		
		function handleTaskAction(id, flag) {
			currentCallId1 = id; 
						feedbackFlag = flag; 
						
		    const modalBody = document.getElementById("dropModalBody");

		    // Remove all previously injected field groups
		    ['meetingFieldsContainer', 'rescheduleFieldsContainer', 'feedbackFieldsContainer', 'taskFieldsContainer', 'taskDelayFieldsContainer'].forEach(id => {
		        const existing = document.getElementById(id);
		        if (existing) existing.remove();
		    });

		    // Inject fields based on statusCode
		    let fieldsHTML = '';
		    let containerId = '';

		    if (flag === 5) { // Task Completed
		        containerId = 'taskFieldsContainer';
		        fieldsHTML = `
		            <div class="form-group mt-3">
		                <label for="taskCompletedDate1">Task Completed Date:</label>
		                <input type="datetime-local" id="taskCompletedDate1" class="form-control">
		            </div>
		            <div class="form-group mt-2">
		                <label for="taskDescriptionfortask1">Task Description:</label>
		                <textarea id="taskDescriptionfortask1" oninput="console.log('Task description input:', this.value)" class="form-control" rows="3" placeholder="Enter task description"></textarea>
		            </div>
		        `;
		    } else if (flag === 6) { // Task Delayed
		        containerId = 'taskDelayFieldsContainer';
		        fieldsHTML = `
		            <div class="form-group mt-3">
		                <label for="taskDelayReason">Reason for Delay:</label>
		                <textarea id="taskDelayReason" class="form-control" rows="3" placeholder="Enter reason for task delay"></textarea>
		            </div>
		        `;
		    }

		    if (fieldsHTML) {
		        const fieldContainer = document.createElement("div");
		        fieldContainer.id = containerId;
		        fieldContainer.innerHTML = fieldsHTML;
		        modalBody.insertBefore(fieldContainer, document.getElementById("commonFieldsContainer"));
		        showCommonFields();
		    }
		}


		function startFeedbackcall(id, flag) {
			currentCallId1 = id; 
			feedbackFlag = flag; 
			
		    const modalBody = document.getElementById("dropModalBody");

		    // Remove any existing similar fields to avoid duplication
		    const existingMeetingFields = document.getElementById("meetingFieldsContainer");
		    if (existingMeetingFields) existingMeetingFields.remove();

		    const existingRescheduleFields = document.getElementById("rescheduleFieldsContainer");
		    if (existingRescheduleFields) existingRescheduleFields.remove();

		    const existingFeedbackFields = document.getElementById("feedbackFieldsContainer");
		    if (existingFeedbackFields) existingFeedbackFields.remove();

		    const feedbackFields = document.createElement("div");
		    feedbackFields.id = "feedbackFieldsContainer";
		    feedbackFields.innerHTML = `
		        <div class="form-group mt-3">
		            <label for="callMadeTime1">Call Made Time and Date:</label>
		            <input type="datetime-local" id="callMadeTime1" class="form-control">
		        </div>
		        <div class="form-group mt-2">
		            <label for="callFeedback1">Feedback:</label>
		            <textarea id="callFeedback1" class="form-control" rows="3" placeholder="Enter feedback"></textarea>
		        </div>
		    `;

		    modalBody.insertBefore(feedbackFields, document.getElementById("commonFieldsContainer"));
		    showCommonFields(); // optional if you're using the same logic to reveal a shared section
		}

		// Show the meeting input fields and reveal common section
		function showMeetingFields(id, flag) {
			currentCallId1 = id; 
						feedbackFlag = flag; 
						
		    const modalBody = document.getElementById("dropModalBody");

		    // Remove existing meeting fields if any
		    const existingMeetingFields = document.getElementById("meetingFieldsContainer");
		    if (existingMeetingFields) existingMeetingFields.remove();
			const existingRescheduleFields = document.getElementById("rescheduleFieldsContainer");
				    if (existingRescheduleFields) existingRescheduleFields.remove();

		    const meetingFields = document.createElement("div");
		    meetingFields.id = "meetingFieldsContainer";
		    meetingFields.innerHTML = `
		        <div class="form-group mt-3">
		            <label for="meetingDateTime1">Meeting Date and Time:</label>
		            <input type="datetime-local" id="meetingDateTime1" class="form-control">
		        </div>
		        <div class="form-group mt-2">
		            <label for="meetingNotes1">Meeting Notes:</label>
		            <textarea id="meetingNotes1" class="form-control" rows="3" placeholder="Enter meeting notes"></textarea>
		        </div>
		    `;
		    modalBody.insertBefore(meetingFields, document.getElementById("commonFieldsContainer"));
		    showCommonFields();
		}

		function showRescheduleFields(id) {
		    const modalBody = document.getElementById("dropModalBody");

		    // Remove existing reschedule or meeting fields if any
		   const existingMeetingFields = document.getElementById("meetingFieldsContainer");
		    if (existingMeetingFields) existingMeetingFields.remove();

		   const existingRescheduleFields = document.getElementById("rescheduleFieldsContainer");
		    if (existingRescheduleFields) existingRescheduleFields.remove();

		    const rescheduleFields = document.createElement("div");
		    rescheduleFields.id = "rescheduleFieldsContainer";
		    rescheduleFields.innerHTML = `
		        <div class="form-group mt-3">
		            <label for="rescheduleReason1">Reason for Rescheduling:</label>
		            <textarea id="rescheduleReason1" class="form-control" rows="3" placeholder="Enter reason for rescheduling"></textarea>
		        </div>
		    `;
		    modalBody.insertBefore(rescheduleFields, document.getElementById("commonFieldsContainer"));
		    showCommonFields();
		}


		// Reveal the common section
		function showCommonFields() {
		    const commonFields = document.getElementById("commonFieldsContainer");
		    if (commonFields) {
		        commonFields.style.display = "block";
		    }
		}
		
		function toggleNextScheduleFieldneww() {
				    const nextAction1 = document.getElementById("nextAction1").value;
				    const nextScheduleGroup1 = document.getElementById("nextScheduleGroup1");

				    // Show the schedule date and time field for specific actions
				    if (nextAction1 === "meeting" || nextAction1 === "callback" || nextAction1 === "task_assigned") {
				        nextScheduleGroup1.style.display = "block";
				    } else {
				        nextScheduleGroup1.style.display = "none";
				    }
				}
		
		function toggleNextScheduleField() {
		    const nextAction = document.getElementById("nextAction").value;
		    const nextScheduleGroup = document.getElementById("nextScheduleGroup");

		    // Show the schedule date and time field for specific actions
		    if (nextAction === "meeting" || nextAction === "callback" || nextAction === "task_assigned") {
		        nextScheduleGroup.style.display = "block";
		    } else {
		        nextScheduleGroup.style.display = "none";
		    }
		}
		let currentCallId = null;
		let currentCallStatus = null;
		// Function to fetch and display full details of the call schedule in a modal
	
		
		/*function updateModalFooter(schedule, id) {
		    const modalFooter = document.getElementById("modalFooter");
		    const today = new Date().toISOString().split('T')[0];
		    const scheduleDate = schedule.fromTime.split('T')[0];
		    let footerHTML = "";

		    if (today === scheduleDate) {
		        if (schedule.nextAction === "callback" || schedule.nextAction === null || schedule.nextAction === "") {
		            footerHTML = `
		                <button type="button" class="btn btn-success" onclick="startFeedback(${id}, 1)">Yes, Call Made</button>
		                <button type="button" class="btn btn-warning" onclick="startFeedback(${id}, 2)">Attempted, No Response</button>
		            `;
		        } else if (schedule.nextAction === "meeting") {
		            footerHTML = `
		                <button type="button" class="btn btn-primary" onclick="startFeedback(${id}, 3)">Meeting Held</button>
		                <button type="button" class="btn btn-danger" onclick="startFeedback(${id}, 4)">Rescheduled</button>
		            `;
		        } else if (schedule.nextAction === "task_assigned") {
		            footerHTML = `
		                <button type="button" class="btn btn-info" onclick="startFeedback(${id}, 5)">Task Status</button>
		                <button type="button" class="btn btn-danger" onclick="startFeedback(${id}, 6)">Task Delayed</button>
		            `;
		        } else {
		            footerHTML = `
		                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		            `;
		        }
		    } else {
		        footerHTML = `
		            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		        `;
		    }

		    modalFooter.innerHTML = footerHTML;
		}*/
		function updateModalFooter(schedule, id) {
		    const modalFooter = document.getElementById("modalFooter");
		    let footerHTML = "";

		    if (schedule.nextAction === "callback" || schedule.nextAction === null || schedule.nextAction === "") {
		        footerHTML = `
		            <button type="button" class="btn btn-success" onclick="startFeedback(${id}, 1)">Yes, Call Made</button>
		            <button type="button" class="btn btn-warning" onclick="startFeedback(${id}, 2)">Attempted, No Response</button>
		        `;
		    } else if (schedule.nextAction === "meeting") {
		        footerHTML = `
		            <button type="button" class="btn btn-primary" onclick="startFeedback(${id}, 3)">Meeting Held</button>
		            <button type="button" class="btn btn-danger" onclick="startFeedback(${id}, 4)">Rescheduled</button>
		        `;
		    } else if (schedule.nextAction === "task_assigned") {
		        footerHTML = `
		            <button type="button" class="btn btn-info" onclick="startFeedback(${id}, 5, '${schedule.nextSchedule}')">Task Status</button>
		    
		        `;
		    } else {
		        footerHTML = `
		            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		        `;
		    }

		    modalFooter.innerHTML = footerHTML;
		}

		
		function fetchCallScheduleDetails(id) {
		    fetch(`/call-scheduleget/${id}`)
		        .then(response => response.json())
		        .then(data => {
		            currentScheduleId = id;
		            schedule = data;

		            const modalTitle = document.getElementById("modalTitle");
		            const detailsTab = document.getElementById("details");
		            const feedbackSection = document.getElementById("feedbackSection");
					let formattedFromTime = schedule.fromTime;
					if (schedule.fromTime) {
					    const dateObj = new Date(schedule.fromTime);
					    const day = String(dateObj.getDate()).padStart(2, '0');
					    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
					    const year = dateObj.getFullYear();

					    const hours = String(dateObj.getHours()).padStart(2, '0');
					    const minutes = String(dateObj.getMinutes()).padStart(2, '0');
					    const seconds = String(dateObj.getSeconds()).padStart(2, '0');

					    formattedFromTime = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
					}
		            modalTitle.textContent = `Details for ${schedule.companyName}`;
					let detailsHTML = `
					    <div style="border-radius: 12px; border: 1px solid #ddd; padding: 20px; background-color: #f9f9f9; margin-bottom: 15px;">
					        <h5 style="margin-bottom: 15px;"><i class="fas fa-info-circle" style="color: #1a99aa;"></i> First Pinch Information</h5>
					        <p><strong>Company Name:</strong> ${schedule.companyName}</p>
					        <p><strong>Contact Person:</strong> ${schedule.contactPerson}</p>
					        <p><strong>Contact Number:</strong> ${schedule.phoneNumber}</p>
					        <p><strong>Contact Method:</strong> ${schedule.contactMethod}</p>
					        <p><strong>Call Date:</strong> ${formattedFromTime}</p>
					        <p><strong>Description:</strong> ${schedule.description || "N/A"}</p>
					        <p><strong>Note:</strong> ${schedule.notes || "N/A"}</p>
					    </div>
					`;
						function normalizeNextActionnew(action) {
						    if (!action) return '';
						    const lower = action.toLowerCase();
						    if (lower.includes('callback')) return 'Call';
						    if (lower.includes('meeting')) return 'Meeting';
						    if (lower.includes('task_assigned')) return 'Task';
						    if (lower.includes('completed')) return 'Completed';
						    return action; // fallback original string if no match
						}
						if (schedule.callMadeTime || schedule.feedback || schedule.nextAction || schedule.nextSchedule) {
						    detailsHTML += `
						    <div style="border-radius: 12px; border: 1px solid #ccc; padding: 20px; background-color: #f4f4f4;">
						        <h5 style="margin-bottom: 15px;"><i class="fas fa-reply" style="color: #1a99aa;"></i> Follow-Up Details</h5>`;

						    const isMeeting = schedule.callStatus === 3 || schedule.callStatus === 4;
						    const isTaskCompleted = schedule.callStatus === 5;

						    if (schedule.callMadeTime) {
						        const dateObj = new Date(schedule.callMadeTime);
						        const formattedCallMadeTime = `${String(dateObj.getDate()).padStart(2, '0')}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${dateObj.getFullYear()} ${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}:${String(dateObj.getSeconds()).padStart(2, '0')}`;
						        detailsHTML += `<p><strong>${isTaskCompleted ? 'Task Completed Date Time' : (isMeeting ? 'Meeting Made Time' : 'Call Made Time')}:</strong> ${formattedCallMadeTime}</p>`;
						    }

						    if (schedule.feedback) {
						        detailsHTML += `<p><strong>${isTaskCompleted ? 'Task Feedback' : (isMeeting ? 'Meeting Feedback' : 'Feedback')}:</strong> ${schedule.feedback}</p>`;
						    }

						    if (schedule.nextAction) {
						        const normalizedAction = normalizeNextActionnew(schedule.nextAction);
						        detailsHTML += `<p><strong>Next Action:</strong> ${normalizedAction}</p>`;
						    }

						    if (schedule.nextSchedule) {
						        const dateObj = new Date(schedule.nextSchedule);
						        const formattedNextSchedule = `${String(dateObj.getDate()).padStart(2, '0')}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${dateObj.getFullYear()} ${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}:${String(dateObj.getSeconds()).padStart(2, '0')}`;
						        detailsHTML += `<p><strong>Next Schedule:</strong> ${formattedNextSchedule}</p>`;
						    }

						    detailsHTML += `</div>`;
						}


		            detailsTab.innerHTML = detailsHTML;
		            feedbackSection.style.display = "none";

		            updateModalFooter(schedule, id);  // Show buttons or close on details tab load

					// Fetch and render history
// Fetch and render history
					fetch(`/call-schedule-history/${id}`)
					    .then(response => response.json())
					    .then(historyList => {
							console.log("Fetched history data:", historyList); //  This line logs the data

					        const historyContent = document.getElementById("historyContent");
					     /*   let historyHTML = historyList.map(item => `
					            <div style="margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; position: relative;">
					                <h6 style="font-weight: bold; color: #3e2a47;">Call Date: ${new Date(item.callMadeTime).toLocaleString()}</h6>
					                <p><strong>Feedback:</strong> ${item.feedback}</p>
					                <p><strong>Next Schedule:</strong> ${new Date(item.nextSchedule).toLocaleString()}</p>
					                <p><strong>Action:</strong> ${item.nextAction}</p>
					            </div>
					        `).join("");*/
							
							// Calculate total tracking days if COMPLETED exists
							      let totalTrackingDaysText = "";
							      const completedEntry = historyList.find(item => item.nextAction && item.nextAction.toLowerCase().includes("completed"));

							      if (completedEntry && historyList.length > 1) {
							          const sortedBySchedule = [...historyList].sort((a, b) => new Date(a.nextSchedule) - new Date(b.nextSchedule));
							          const startDate = new Date(sortedBySchedule[0].nextSchedule);
							          const endDate = new Date(sortedBySchedule[sortedBySchedule.length - 1].nextSchedule);

							          const diffTime = endDate - startDate;
							          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // days

							          totalTrackingDaysText = `<p style="margin: 6px 0; font-size: 13px; color: #303030;"><strong>Cumulative Follow-up Period:</strong> ${diffDays} day${diffDays !== 1 ? 's' : ''}</p>`;
							      }
							let historyHTML = historyList.map((item, index) => {
							    const processLabel = `${index + 1}${getOrdinalSuffix(index + 1)} Process` + (item.reschedule ? " - Reschedule" : "");

								// Determine dynamic date label
								let dateLabel = "Date";
								if (item.nextAction) {
								    const action = item.nextAction.toLowerCase();
								    if (action.includes("callback")) {
								        dateLabel = "Call Date";
								    } else if (action.includes("meeting")) {
								        dateLabel = "Meeting Date";
								    } else if (action.includes("task_assigned")) {
								        dateLabel = "Task Date";
								    } else if (action.includes("completed")) {
								        dateLabel = "Completed Date";
								    }
								}
								// Normalize action label
								let activityType = "Other";
								if (item.nextAction) {
								    const action = item.nextAction.toLowerCase();
								    if (action.includes("callback")) {
								        activityType = "Call";
								    } else if (action.includes("meeting")) {
								        activityType = "Meeting";
								    } else if (action.includes("task_assigned")) {
								        activityType = "Task";
								    } else if (action.includes("completed")) {
								        activityType = "COMPLETED";
								    }
								}
								// Decide which date to show in the <h6>
								   const displayDate = activityType === "COMPLETED" ? item.nextSchedule : item.callMadeTime;

							    return `
							        <div style="
							            margin-bottom: 12px;
							            border-radius: 10px;
							            border: 1px solid #cfd8dc;
							            padding: 10px 12px;
							            background-color: #f0f4f8;
							            position: relative;
							            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
							            transition: transform 0.2s;
							        " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
							            <span style="
							                position: absolute;
							                top: 8px;
							                right: 12px;
							                padding: 4px 10px;
							                background: linear-gradient(90deg, #1a73e8, #4fc3f7);
							                background-size: 200% 200%;
							                color: #ffffff;
							                border-radius: 8px;
							                font-weight: 600;
							                font-size: 11px;
							                text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
							                box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
							                animation: glowing 2s infinite alternate, shimmer 3s infinite linear;
							            ">${processLabel}</span>
										<h6 style="font-weight: 600; color: #1a237e; font-size: 14px;">${dateLabel}: ${new Date(displayDate).toLocaleString()}</h6>

											${activityType !== "COMPLETED" ? `<p style="margin: 4px 0; font-size: 13px;"><strong>Client Response:</strong> ${item.feedback}</p>` : ""}
											${activityType !== "COMPLETED" 
											  ? `<p style="margin: 4px 0; font-size: 13px;"><strong>Was Scheduled:</strong> ${new Date(item.nextSchedule).toLocaleString()}</p>` 
											  : ""}            
							          
							           <p style="margin: 4px 0; font-size: 13px;"><strong>Activity Type:</strong> ${activityType}</p>
										${item.taskDelayReason && item.taskDelayReason.trim() !== "" 
										           ? `<p style="margin: 4px 0; font-size: 13px;"><strong>Delay Reason:</strong> ${item.taskDelayReason}</p>` 
										           : ""}
												   ${activityType === "COMPLETED" ? totalTrackingDaysText : ""}
							        </div>
							    `;
							}).join("");
							
							

					        historyContent.innerHTML = historyHTML || "<p>No history available</p>";
							document.getElementById("downloadExcelBtn").onclick = function () {
							    if (!historyList || historyList.length === 0) {
							        alert("No history data to download.");
							        return;
							    }

							    const sheetData = historyList.map((item, index) => {
							        const processLabel = `${index + 1}${getOrdinalSuffix(index + 1)} Process${item.reschedule ? " - Reschedule" : ""}`;

							        let activityType = "Other";
							        if (item.nextAction) {
							            const action = item.nextAction.toLowerCase();
							            if (action.includes("callback")) {
							                activityType = "Call";
							            } else if (action.includes("meeting")) {
							                activityType = "Meeting";
							            } else if (action.includes("task_assigned")) {
							                activityType = "Task";
							            } else if (action.includes("completed")) {
							                activityType = "COMPLETED";
							            }
							        }

							        return {
							            "Process": processLabel,
							            "Activity Type": activityType,
							            "Date": new Date(item.callMadeTime).toLocaleString(),
							            "Client Feedback": item.feedback,
							            "Was Scheduled": new Date(item.nextSchedule).toLocaleString(),
							            "Delay Reason": item.taskDelayReason || ""
							        };
							    });

							    const worksheet = XLSX.utils.json_to_sheet(sheetData);

							    // Make header bold
							    const headerKeys = Object.keys(sheetData[0]);
							    const range = XLSX.utils.decode_range(worksheet['!ref']);
							    for (let col = range.s.c; col <= range.e.c; col++) {
							        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
							        if (!worksheet[cellAddress]) continue;
							        if (!worksheet[cellAddress].s) worksheet[cellAddress].s = {};
							        worksheet[cellAddress].s = {
							            font: { bold: true }
							        };
							    }

							    const workbook = XLSX.utils.book_new();
							    XLSX.utils.book_append_sheet(workbook, worksheet, "Call History");

							    const fileName = `${schedule.companyName.replace(/\s+/g, "_")}_Followup_Track_Record.xlsx`;

							    XLSX.writeFile(workbook, fileName);
							};

							  
							if (schedule.callMadeTime || schedule.feedback || schedule.nextAction || schedule.nextSchedule) {
							    const isCompleted = schedule.nextAction && schedule.nextAction.toLowerCase().includes("completed");

							    historyContent.innerHTML += `
							        <div style="
							            margin-bottom: 15px; 
							            border-radius: 8px; 
							            border: 1px solid #ddd; 
							            padding: 10px; 
							            background-color: #f9f9f9;
							            position: relative;
							        ">
									${!isCompleted ? `
										<h6 style="font-weight: bold; color: #3e2a47;">
										      ${(() => {
										          let dateLabel = "Activity Date";
										          const status = schedule.callStatus;

										          if (status === 1 || status === 2) {
										              dateLabel = "Previous Call Date";
										          } else if (status === 3 || status === 4) {
										              dateLabel = "Previous Meeting Date";
										          } else if (status === 5 || status === 6) {
										              dateLabel = "Previous Task Date";
										          }

										          const callDate = schedule.callMadeTime ? new Date(schedule.callMadeTime).toLocaleString() : "N/A";
										          return `${dateLabel}: ${callDate}`;
										      })()}
										  </h6>
										${schedule.feedback ? (() => {
										    let label = "Details of Previous Activity";
										    const status = schedule.callStatus;

										    if (status === 1 || status === 2) {
										        label = "Details of Previous Call";
										    } else if (status === 3 || status === 4) {
										        label = "Details of Previous Meeting";
										    } else if (status === 5 || status === 6) {
										        label = "Details of Previous Task";
										    }

										    return `<p><strong>${label}:</strong> ${schedule.feedback}</p>`;
										})() : ''}
										${schedule.nextAction ? (() => {
										    let displayAction = schedule.nextAction;

										    switch (schedule.nextAction.toLowerCase()) {
										        case "callback":
										            displayAction = "Call";
										            break;
										        case "meeting":
										            displayAction = "Meeting";
										            break;
										        case "task_assigned":
										            displayAction = "Task";
										            break;
										        case "completed":
										            displayAction = "Completed";
										            break;
										        default:
										            // Capitalize the first letter if it's an unknown value
										            displayAction = schedule.nextAction.charAt(0).toUpperCase() + schedule.nextAction.slice(1);
										    }

										    return `<p><strong>Next Action:</strong> ${displayAction}</p>`;
										})() : ''}

							              ${schedule.nextSchedule ? `<p><strong>Next Schedule:</strong> ${new Date(schedule.nextSchedule).toLocaleString()}</p>` : ''}

							          
							                <span style="
							                    position: absolute;
							                    top: 10px;
							                    right: 15px;
							                    padding: 3px 8px;
							                    background: linear-gradient(90deg, #fbb03b, #ff4b2b);
							                    background-size: 200% 200%;
							                    color: #fff;
							                    border-radius: 12px;
							                    font-weight: bold;
							                    font-size: 12px;
							                    text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
							                    box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
							                    animation: glowing 1.5s infinite alternate, shimmer 3s infinite linear;
							                ">Upcoming</span>
							            ` : `
							                <p style="margin-top: 10px; font-size: 13px; font-style: italic; color: #777;">No further schedules.</p>
							            `}
							        </div>
							    `;
							}

							
							
							//const actionCategories = ['Call', 'Meeting', 'Meeting Rescheduled', 'Task', 'Completed'];
							const actionCategories = ['Call', 'Meeting', 'Task', 'Completed'];
							//const actionCategories = ['Call', 'Meeting', 'Task', 'Completed', 'Other'];

							   function normalizeAction(item) {
							       const lower = item.nextAction.toLowerCase();

							       if (lower.includes('callback')) return 'Call';
							       if (lower.includes('meeting')) return 'Meeting'; // Always return 'Meeting'
							       if (lower.includes('task_assigned')) return 'Task';
							       if (lower.includes('completed')) return 'Completed';
							       return 'Other';
							   }

							   const feedbackData = historyList.map((item, index) => ({
							       x: normalizeAction(item),
							       y: index + 1,
							       feedback: item.feedback,
							       callMadeTime: item.callMadeTime,
							       nextAction: item.nextAction,
								   taskDelayReason: item.taskDelayReason,
							       reschedule: item.reschedule // Keep for tooltip logic
							   }));

							   const ctx = document.getElementById('historyChart').getContext('2d');

							   if (window.historyChartInstance) {
							       window.historyChartInstance.destroy();
							   }

							   window.historyChartInstance = new Chart(ctx, {
							       type: 'line',
							       data: {
							           labels: actionCategories,
							           datasets: [{
							               label: 'Interaction Timeline',
							               data: feedbackData.map(point => ({
							                   x: point.x,
							                   y: point.y
							               })),
							               borderColor: '#1a73e8',
							               backgroundColor: '#1a237e',
							               tension: 0.4,
							               fill: false,
							               pointRadius: 6,
							               showLine: true
							           }]
							       },
							       options: {
							           responsive: true,
							           plugins: {
							               title: {
							                   display: true,
							                   text: 'Timeline of User Interactions'
							               },
										   tooltip: {
										       bodyFont: {
										           size: 12
										       },
										       boxPadding: 5,
										       multiLine: true,
										       callbacks: {
										           title: function (context) {
										               const dataPoint = feedbackData[context[0].dataIndex];
										               return (dataPoint.x === 'Meeting' && dataPoint.reschedule)
										                   ? 'Meeting Rescheduled'
										                   : dataPoint.x;
										           },
												   label: function (context) {
												       const dataPoint = feedbackData[context.dataIndex];
												       const normalizedAction = normalizeAction(dataPoint);

												       // Wrap text at 60 characters
												       const wrapText = (text, maxLength = 60) => {
												           const words = text.split(' ');
												           const lines = [];
												           let line = '';
												           for (const word of words) {
												               if ((line + word).length > maxLength) {
												                   lines.push(line.trim());
												                   line = word + ' ';
												               } else {
												                   line += word + ' ';
												               }
												           }
												           if (line) lines.push(line.trim());
												           return lines;
												       };

												       const lines = [
												           `Date: ${new Date(dataPoint.callMadeTime).toLocaleString()}`,
												           `Activity Type: ${normalizedAction}`
												       ];

												       if (dataPoint.feedback && dataPoint.feedback.trim() !== "") {
												           const wrappedFeedback = wrapText(`Client Response: ${dataPoint.feedback}`);
												           lines.push(...wrappedFeedback);
												       }

												       if (dataPoint.taskDelayReason && dataPoint.taskDelayReason.trim() !== "") {
												           lines.push(`Delay Reason: ${dataPoint.taskDelayReason}`);
												       }

												       return lines;
												   }

										       }
										   }

							           },
							           scales: {
							               x: {
							                   type: 'category',
							                   labels: actionCategories,
							                   title: {
							                       display: true,
							                       text: 'Action Type'
							                   }
							               },
							               y: {
							                   beginAtZero: true,
							                   title: {
							                       display: true,
							                       text: 'Event Sequence'
							                   },
							                   ticks: {
							                       precision: 0,
							                       stepSize: 1
							                   }
							               }
							           }
							       }
							   });
								  // Toggle functionality
								         document.getElementById('toggleGraphBtn').onclick = function () {
								             document.getElementById('historyContent').style.display = 'none';
								             document.getElementById('graphContent').style.display = 'block';
								         };

								         document.getElementById('backToListBtn').onclick = function () {
								             document.getElementById('graphContent').style.display = 'none';
								             document.getElementById('historyContent').style.display = 'block';
								         };
					    })
					    .catch(error => console.error("Error fetching history:", error));


		            $('#detailsModal').modal('show');
		        })
		        .catch(error => console.error("Error fetching schedule details:", error));
		}
		// Function to get ordinal suffix (1st, 2nd, 3rd, etc.)
		function getOrdinalSuffix(num) {
		    const lastDigit = num % 10;
		    const lastTwoDigits = num % 100;
		    if (lastTwoDigits >= 11 && lastTwoDigits <= 13) return "th";
		    if (lastDigit === 1) return "st";
		    if (lastDigit === 2) return "nd";
		    if (lastDigit === 3) return "rd";
		    return "th";
		}
		document.addEventListener('DOMContentLoaded', () => {
		    const detailsTabBtn = document.getElementById('details-tab');
		    const historyTabBtn = document.getElementById('history-tab');
		    const modalFooter = document.getElementById("modalFooter");

		    detailsTabBtn.addEventListener('shown.bs.tab', () => {
		        if (schedule && currentScheduleId) {
		            updateModalFooter(schedule, currentScheduleId);
		        }
		    });

		    historyTabBtn.addEventListener('shown.bs.tab', () => {
		        // Hide buttons when history tab is active
		        modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;
		    });
		});
		
	
		function startFeedback(id, status, nextScheduleDateStr = null) {
			//alert("hii");
		    currentCallId = id;
		    currentCallStatus = status;
		//	alert("Step 2: Set currentCallId and currentCallStatus");

		    // Show the feedback section
		    const feedbackSection = document.getElementById("feedbackSection");
			//alert("Step 3: Got feedbackSection element");
		    feedbackSection.style.display = "block";
			//alert("Step 4: Displayed feedback section");

		    // Clear the modal footer buttons
		    const modalFooter = document.getElementById("modalFooter");
			//alert("Step 5: Got modalFooter element" + modalFooter);
		    modalFooter.innerHTML = "";
		//	alert("Step 6: Cleared modalFooter content");

		    // Get all info sections
		    const callInfo = document.getElementById("callInfo");
		    const meetingInfo = document.getElementById("meetingInfo");
		    const rescheduleInfo = document.getElementById("rescheduleInfo");
		    const taskCompletedInfo = document.getElementById("taskCompletedInfo");
		    const taskDelayInfo = document.getElementById("delayReasonInCompleted");
		//	alert("Step 7: Got all info section elements");
		    // Hide all sections first
		    callInfo.style.display = "none";
		    meetingInfo.style.display = "none";
		    rescheduleInfo.style.display = "none";
		    taskCompletedInfo.style.display = "none";
		    taskDelayInfo.style.display = "none";

			// Reference to nextScheduleGroup div
			const nextScheduleGroup = document.getElementById("nextScheduleGroup");

			// Automatically set the next action based on the status
			const nextActionSelect = document.getElementById("nextAction");
			if (status === 2) { // Attempted, No Response
			    nextActionSelect.value = "callback";
			    nextScheduleGroup.style.display = "block"; // Show nextScheduleGroup
			} else if (status === 4) { // Rescheduled
			    nextActionSelect.value = "meeting";
			    nextScheduleGroup.style.display = "block"; // Show nextScheduleGroup
			} else {
			    nextActionSelect.value = ""; // Reset if no specific default
			    nextScheduleGroup.style.display = "none"; // Hide nextScheduleGroup
			}
		//	nextActionSelect.classList.add("readonly-select");

		    // Show the relevant section based on status
		    if (status === 1 || status === 2) {
		        callInfo.style.display = "block";
		    } else if (status === 3) {
		        meetingInfo.style.display = "block";
		    } else if (status === 4) {
		        rescheduleInfo.style.display = "block";
		    } else if (status === 5) {
		        taskCompletedInfo.style.display = "block";
				// Check if task is delayed based on nextScheduleDate
				       if (nextScheduleDateStr) {
				           const now = new Date();
				           const nextScheduleDate = new Date(nextScheduleDateStr);
				           const delayReasonDiv = document.getElementById("delayReasonInCompleted");
				           if (nextScheduleDate < now) {
				               delayReasonDiv.style.display = "block";
				           } else {
				               delayReasonDiv.style.display = "none";
				           }
				       }
		    } else if (status === 6) {
		        taskDelayInfo.style.display = "block";
		    }
		}




		
		/*function submitFeedback() {
		    const callMadeTime = document.getElementById("callMadeTime").value;
		    const feedback = document.getElementById("callFeedback").value.trim();
		    const nextAction = document.getElementById("nextAction").value;
		    const nextSchedule = document.getElementById("nextSchedule").value.trim();

		    // Validate fields
		    if (!callMadeTime || !feedback || !nextAction || (nextScheduleGroup.style.display === "block" && !nextSchedule)) {
		        alert("Please fill all required fields.");
		        return;
		    }

		    const feedbackData = {
		        callMadeTime: callMadeTime,
		        feedback: feedback,
		        nextAction: nextAction,
		        status: currentCallStatus,
		        nextSchedule: nextScheduleGroup.style.display === "block" ? nextSchedule : null
		    };
			// Console log the data you're about to send
			   console.log("Submitting feedback data:", feedbackData);

		    fetch(`/call-feedback/${currentCallId}`, {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(feedbackData)
		    })
		    .then(response => {
		        if (response.ok) {
		            alert("Feedback submitted successfully");
		            $('#detailsModal').modal('hide');
					loadCallSchedules();
		        } else {
		            alert("Failed to submit feedback.");
		        }
		    })
		    .catch(error => console.error("Error submitting feedback:", error));
		}*/
	
		function submitFeedback1() {
		    let callMadeTime = null;
		    let feedback = null;

		    // Check for Task fields first
		    const taskDateElem = document.getElementById("taskCompletedDate1");
		    const taskDescElem = document.getElementById("taskDescriptionfortask1");

		    if (taskDateElem && taskDescElem) {
		        callMadeTime = taskDateElem.value;
		        feedback = taskDescElem.value;
		    } else {
		        // Check for Meeting fields
		        const meetingDateTimeElem = document.getElementById("meetingDateTime1");
		        const meetingNotesElem = document.getElementById("meetingNotes1");

		        if (meetingDateTimeElem && meetingNotesElem) {
		            callMadeTime = meetingDateTimeElem.value;
		            feedback = meetingNotesElem.value;
		        } else {
		            // Use regular call fields
		            callMadeTime = document.getElementById("callMadeTime1").value;
		            feedback = document.getElementById("callFeedback1").value;
		        }
		    }

		    const nextAction = document.getElementById("nextAction1").value;
		    const nextScheduleElem = document.getElementById("nextSchedule1");
		    const nextSchedule = nextScheduleElem && nextScheduleElem.style.display !== "none" ? nextScheduleElem.value : null;

		    if (!currentCallId1) {
		        alert("Call ID not found. Please restart the feedback process.");
		        return;
		    }

		    if (!callMadeTime) {
		        alert("Please enter the Call Made Time / Meeting Date / Task Completed Date.");
		        return;
		    }

		    if (!nextAction) {
		        alert("Please select the Next Process.");
		        return;
		    }

		    const feedbackData = {
		        callMadeTime,
		        feedback,
		        nextAction,
		        nextSchedule,
		        status: feedbackFlag
		    };

		    console.log("Submitting feedback data:", feedbackData);

		    fetch(`/call-feedback/${currentCallId1}`, {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(feedbackData)
		    })
		    .then(response => {
		        if (response.ok) {
		            alert("Feedback submitted successfully");
					$('#dropActionModal').modal('hide');
		        } else {
		            alert("Failed to submit feedback. Server responded with status " + response.status);
		        }
		    })
		    .catch(error => {
		        console.error("Error submitting feedback:", error);
		        alert("Failed to submit feedback. Please try again.");
		    });
		}



		function submitFeedback() {
				    const nextAction = document.getElementById("nextAction").value;
				    const nextScheduleGroup = document.getElementById("nextScheduleGroup");
				    const nextSchedule = document.getElementById("nextSchedule").value.trim();

				    // Detect visible section
				    const isCall = document.getElementById("callInfo").style.display !== "none";
				    const isMeeting = document.getElementById("meetingInfo").style.display !== "none";
				    const isReschedule = document.getElementById("rescheduleInfo").style.display !== "none";
				    const isTaskCompleted = document.getElementById("taskCompletedInfo").style.display !== "none";
				    const isTaskDelayed = document.getElementById("taskDelayInfo").style.display !== "none";

				    let feedbackData = {
				        nextAction: nextAction,
				        status: currentCallStatus,
				        nextSchedule: nextScheduleGroup.style.display === "block" ? nextSchedule : null
				    };

				    // Handle Call feedback
				    if (isCall) {
				        const callMadeTime = document.getElementById("callMadeTime").value;
				        const feedback = document.getElementById("callFeedback").value.trim();

				        if (!callMadeTime || !feedback || !nextAction || (nextScheduleGroup.style.display === "block" && !nextSchedule)) {
				            alert("Please fill all required fields for call feedback.");
				            return;
				        }

				        feedbackData.callMadeTime = callMadeTime;
				        feedbackData.feedback = feedback;
				    }

				    // Handle Meeting feedback
				    if (isMeeting) {
				        const meetingDateTime = document.getElementById("meetingDateTime").value;
				        const meetingNotes = document.getElementById("meetingNotes").value.trim();

				        if (!meetingDateTime || !meetingNotes || !nextAction || (nextScheduleGroup.style.display === "block" && !nextSchedule)) {
				            alert("Please fill all required fields for meeting feedback.");
				            return;
				        }

				        feedbackData.meetingDateTime = meetingDateTime;
				        feedbackData.meetingNotes = meetingNotes;
				    }

				    // Handle Reschedule feedback
				    if (isReschedule) {
				        const rescheduleReason = document.getElementById("rescheduleReason").value.trim();

				        if (!rescheduleReason || !nextAction || (nextScheduleGroup.style.display === "block" && !nextSchedule)) {
				            alert("Please fill all required fields for rescheduling.");
				            return;
				        }

				        feedbackData.rescheduleReason = rescheduleReason;
						feedbackData.feedback = rescheduleReason; // Ensure it reaches backend as feedback
						  feedbackData.isReschedule = true; // <-- Flag added here
				    }

				    // Handle Task Completed
				    if (isTaskCompleted) {
				        const taskCompletedDate = document.getElementById("taskCompletedDate").value;
				       // const taskDescription = document.getElementById("taskDescription").value.trim();
					   const taskDescriptionRaw = document.getElementById("taskDescriptionfortask").value;
					   console.log("Raw taskDescription:", JSON.stringify(taskDescriptionRaw));
					   const taskDescription = taskDescriptionRaw.trim();
					   console.log("Trimmed taskDescription:", JSON.stringify(taskDescription));

						
						console.log("taskCompletedDate:", taskCompletedDate);
						console.log("taskDescription:", taskDescription);
						console.log("nextAction:", nextAction);
						console.log("nextScheduleGroup.style.display:", nextScheduleGroup.style.display);
						console.log("nextSchedule:", nextSchedule);
						// Check if task is delayed
						   let taskDelayReason = null;
						   if (document.getElementById("delayReasonInCompleted").style.display !== "none") {
						       taskDelayReason = document.getElementById("reasonInCompleted").value.trim();
						       if (!taskDelayReason) {
						           alert("Please provide a reason for the delay.");
						           return;
						       }
						       feedbackData.taskDelayReason = taskDelayReason;
						       console.log("taskDelayReason:", taskDelayReason);
						   }
						   
				        if (!taskCompletedDate || !taskDescription || !nextAction || (nextScheduleGroup.style.display === "block" && !nextSchedule)) {
				            alert("Please fill all required fields for task completion.");
				            return;
				        }

				        feedbackData.taskCompletedDate = taskCompletedDate;
				        feedbackData.taskDescription = taskDescription;
				    }

				    // Handle Task Delayed
				    if (isTaskDelayed) {
				        const taskDelayReason = document.getElementById("reasonInCompleted").value.trim();

				        if (!taskDelayReason || !nextAction || (nextScheduleGroup.style.display === "block" && !nextSchedule)) {
				            alert("Please fill all required fields for task delay.");
				            return;
				        }

				        feedbackData.taskDelayReason = taskDelayReason;
						//alert("isTaskDelayed:", isTaskDelayed);
						 // alert("taskDelayReason (value):", taskDelayReason);

				    }
					// Final check before sending
					//alert("Full feedbackData JSON:", JSON.stringify(feedbackData, null, 2));
				    // Log and send
				    console.log("Submitting feedback data:", feedbackData);

				    fetch(`/call-feedback/${currentCallId}`, {
				        method: 'POST',
				        headers: {
				            'Content-Type': 'application/json'
				        },
				        body: JSON.stringify(feedbackData)
				    })
				    .then(response => {
				        if (response.ok) {
				            alert("Feedback submitted successfully");
				            $('#detailsModal').modal('hide');
				            loadCallSchedules();
				        } else {
				            alert("Failed to submit feedback.");
				        }
				    })
				    .catch(error => console.error("Error submitting feedback:", error));
				}



		document.addEventListener("DOMContentLoaded", loadCallSchedules);
		function submitCallScheduleForm(event) {
		    event.preventDefault();

		    const companyName = document.getElementById("callCompanySearchInput").value.trim();
		   // const contactPerson = document.getElementById("callContactPerson").value.trim();
		   // Find contact person container
		      const container = document.getElementById("callContactPersonContainer");

		      let contactPerson = "";

		      // Check if container has an input or select element
		      const input = container.querySelector("input");
		      const select = container.querySelector("select");

		      if (input) {
		          contactPerson = input.value.trim();
		      } else if (select) {
		          // get selected option text
		          contactPerson = select.options[select.selectedIndex].text.trim();
		          // If default option is selected, treat as empty
		          if (!select.value) {
		              contactPerson = "";
		          }
		      }
		    const phoneNumber = document.getElementById("callPhoneNumber").value.trim();
		    const fromTime = document.getElementById("fromTime").value;
		    const toTime = document.getElementById("toTime").value;
		    const contactMethod = document.getElementById("contactMethod").value;
		    const notes = document.getElementById("notes").value.trim();
		    const description = document.getElementById("description").value.trim();

		    // Frontend validation
		    if (!companyName || !contactPerson || !phoneNumber || !fromTime || !toTime || !contactMethod || !description) {
				Swal.fire({
				    icon: 'warning',
				    title: 'Missing Fields',
				    html: '<small>Please fill in all required fields before submitting.</small>',
				    confirmButtonColor: '#f0ad4e',
				    confirmButtonText: 'OK',
				    customClass: {
				        popup: 'swal2-small-popup',
				        title: 'swal2-small-title',
				        confirmButton: 'swal2-small-button',
				        htmlContainer: 'swal2-small-html'
				    }
				});

		        return;
		    }

		    const callSchedule = {
		        companyName,
		        contactPerson,
		        phoneNumber,
		        fromTime,
		        toTime,
		        contactMethod,
		        notes,
		        description
		    };

		    fetch("/call-schedulesave", {
		        method: "POST",
		        headers: {
		            "Content-Type": "application/json"
		        },
		        body: JSON.stringify(callSchedule)
		    })
		    .then(response => {
		        if (!response.ok) {
		            throw new Error("Server rejected the request");
		        }
		        return response.json();
		    })
		    .then(data => {
				Swal.fire({
				    icon: 'success',
				    title: 'Call Scheduled!',
				    html: '<small>Your call has been added to the schedule.</small>',
				    confirmButtonText: 'OK',
				    confirmButtonColor: '#28a745',
				    customClass: {
				        popup: 'swal2-small-popup',
				        title: 'swal2-small-title',
				        confirmButton: 'swal2-small-button',
				        htmlContainer: 'swal2-small-html'
				    },
				    timer: 3000,
				    timerProgressBar: true
				}).then(() => {
		            closeCallScheduleForm();
		            document.querySelector("form").reset();
		        });
		    })
		    .catch(error => {
		        console.error("Error scheduling call:", error);
				Swal.fire({
				    icon: 'error',
				    title: 'Failed!',
				    html: '<small>Something went wrong. Please try again later.</small>',
				    confirmButtonText: 'OK',
				    confirmButtonColor: '#d33',
				    customClass: {
				        popup: 'swal2-small-popup',
				        title: 'swal2-small-title',
				        confirmButton: 'swal2-small-button',
				        htmlContainer: 'swal2-small-html'
				    }
				});

		    });
		}


		function submitMeetingForm(event) {
		    event.preventDefault();
			// Find the container div for meeting contact person
			   const container = document.getElementById("meetingContactPersonContainer");

			   let contactPerson = "";

			   if (container) {
			       // Look for input or select inside the container
			       const input = container.querySelector("input");
			       const select = container.querySelector("select");

			       if (input) {
			           contactPerson = input.value.trim();
			       } else if (select) {
			           contactPerson = select.options[select.selectedIndex].text.trim();
			           if (!select.value) {
			               contactPerson = "";
			           }
			       }
			   } else {
			       console.warn("meetingContactPersonContainer not found");
			   }
		    const meetingData = {
		        companyName: document.getElementById('meetingCompanySearchInput').value,
		      //  contactPerson: document.getElementById('meetingContactPerson').value,
			  contactPerson: contactPerson, 
		        phoneNumber: document.getElementById('meetingPhoneNumber').value,
		        fromTime: document.getElementById('meetingFromTime').value,
		        toTime: document.getElementById('meetingToTime').value,
		        contactMethod: document.getElementById('meetingcontactMethod').value,
		        meetingTitle: document.getElementById('meetingTitle').value,
		        participants: document.getElementById('participants').value,
		        agenda: document.getElementById('agenda').value,
		        location: document.getElementById('meetingLocation').value
		    };

		    const callData = {
		        companyName: meetingData.companyName,
		        contactPerson: meetingData.contactPerson,
		        phoneNumber: meetingData.phoneNumber,
		        fromTime: meetingData.fromTime,
		        toTime: meetingData.toTime,
		        contactMethod: meetingData.contactMethod,
		        description: meetingData.agenda,
		        nextAction: "meeting",
				nextSchedule:meetingData.fromTime
		    };

		    // Save to MeetingSchedule
		    fetch('/meetings/save', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(meetingData)
		    }).then(response => {
		        if (response.ok) {
		            // Save to CallSchedule after successful meeting save
		            return fetch('/savemeeting', {
		                method: 'POST',
		                headers: {
		                    'Content-Type': 'application/json'
		                },
		                body: JSON.stringify(callData)
		            });
		        } else {
		            throw new Error('Failed to save meeting.');
		        }
		    }).then(response => {
		        if (response.ok) {
		            alert('Meeting scheduled and logged successfully!');
		            closeMeetingForm(); // your modal close function
		            // Optionally reset form here
		        } else {
		            throw new Error('Failed to log call schedule.');
		        }
		    }).catch(error => {
		        console.error('Error:', error);
		        alert('An error occurred while saving.');
		    });
		}

		function submitTaskForm(event) {
		    event.preventDefault();
			// Find the container div for task contact person
			   const container = document.getElementById("taskContactPersonContainer");

			   let contactPerson = "";

			   if (container) {
			       const input = container.querySelector("input");
			       const select = container.querySelector("select");

			       if (input) {
			           contactPerson = input.value.trim();
			       } else if (select) {
			           contactPerson = select.options[select.selectedIndex].text.trim();
			           if (!select.value) {
			               contactPerson = "";
			           }
			       }
			   } else {
			       console.warn("taskContactPersonContainer not found");
			   }
		    const taskData = {
		        companyName: document.getElementById('taskCompanySearchInput').value,
		        //contactPerson: document.getElementById('taskContactPerson').value,
				contactPerson: contactPerson,
		        phoneNumber: document.getElementById('taskPhoneNumber').value,
		        contactMethod: document.getElementById('taskcontactMethod').value,
		        taskName: document.getElementById('taskName').value,
		        assignee: document.getElementById('taskAssignee').value,
		        assignDate: document.getElementById('taskAssignDate').value,
		        deadline: document.getElementById('taskDeadline').value,
		        description: document.getElementById('taskDescription').value,
		        priority: document.getElementById('taskPriority').value
		    };

		    // Call Schedule Data Mapping
		    const callData = {
		        companyName: taskData.companyName,
		        contactPerson: taskData.contactPerson,
		        phoneNumber: taskData.phoneNumber,
		        fromTime: taskData.assignDate,
		        toTime: taskData.deadline,
		        nextSchedule: taskData.deadline,
		        contactMethod: taskData.contactMethod,
		        description: taskData.description,
		        nextAction: "task_assigned"
		    };

		    // Save Task Data
		    fetch('/tasks/save', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(taskData)
		    }).then(response => {
		        if (response.ok) {
		            // Save Call Schedule Data
		            return fetch('/savetask', {
		                method: 'POST',
		                headers: {
		                    'Content-Type': 'application/json'
		                },
		                body: JSON.stringify(callData)
		            });
		        } else {
		            throw new Error('Failed to create task.');
		        }
		    }).then(response => {
		        if (response.ok) {
		            alert('Task and Call Schedule created successfully!');
		            closeTaskForm(); // Close the modal
		        } else {
		            alert('Failed to create call schedule.');
		        }
		    }).catch(error => {
		        console.error('Error:', error);
		        alert('An error occurred.');
		    });
		}


		
	       function openCallScheduleForm() {
	           document.getElementById("callScheduleModal").style.display = "block";
	       }
	       function closeCallScheduleForm() {
	           document.getElementById("callScheduleModal").style.display = "none";
	       }
		   
		   function openMeetingForm() {
		       document.getElementById("meetingModal").style.display = "block";
		   }

		   function closeMeetingForm() {
		       document.getElementById("meetingModal").style.display = "none";
		   }

		   
		   function openTaskForm() {
		       document.getElementById("taskModal").style.display = "block";
		   }

		   function closeTaskForm() {
		       document.getElementById("taskModal").style.display = "none";
		   }

		   
		/*   function openCallScheduleForm() {
			//alert("lll");
		       document.getElementById("callScheduleModal").style.display = "block";

		       // Fetch all company names when the modal is opened
		       const companySelect = document.getElementById("companyName");
		       if (companySelect.children.length <= 1) { // Avoid duplicate loading
		           fetch("/crmcompanies")
		               .then(response => response.json())
		               .then(data => {
		                   data.forEach(company => {
		                       const option = document.createElement("option");
		                       option.value = company.id;
		                       option.textContent = company.companyName;
		                       companySelect.appendChild(option);
		                   });
		               })
		               .catch(error => console.error("Error fetching company names:", error));
		       }
		   }

		   document.getElementById("openCallModalButton").addEventListener("click", openCallScheduleForm);
		   function fetchCompanyDetails(companyId) {
		       alert("pp"); // Corrected the typo
		       
		       if (companyId) {
		           fetch(`/crmcompanies/${companyId}`)
		               .then(response => response.json())
		               .then(company => {
		                   document.getElementById("contactPerson").value = company.customerName || "";
		                   document.getElementById("phoneNumber").value = company.contactNumber || "";
		               })
		               .catch(error => console.error("Error fetching company details:", error));
		       } else {
		           document.getElementById("contactPerson").value = "";
		           document.getElementById("phoneNumber").value = "";
		       }
		   }*/
		   
		   function searchCompany(query, type) {
		      // alert("Search triggered with query: " + query + " | Type: " + type);

		       const resultsContainerId = type === 'call' ? 'callCompanySearchResults' 
		                                : type === 'meeting' ? 'meetingCompanySearchResults' 
		                                : 'taskCompanySearchResults';
		       const resultsContainer = document.getElementById(resultsContainerId);

		       if (query.trim() === "") {
		        //   alert("Empty query. Hiding results.");
		           resultsContainer.style.display = "none";
		           resultsContainer.innerHTML = "";
		           return;
		       }

		       fetch("/crmcompanies")
		           .then(response => response.json())
		           .then(data => {
		              // alert("Company data fetched. Total records: " + data.length);

		               const filteredCompanies = data.filter(company => 
		                   company.customerName.toLowerCase().includes(query.toLowerCase())
		               );
		               //alert("Filtered companies count: " + filteredCompanies.length);

		               if (filteredCompanies.length > 0) {
		                   resultsContainer.innerHTML = filteredCompanies.map(company => `
		                       <li onclick="selectCompany('${company.id}', '${company.customerName}', '${type}')"
		                           style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
		                           ${company.customerName}
		                       </li>
		                   `).join("");
		                   resultsContainer.style.display = "block";
		                  // alert("Search results displayed.");
		               } else {
		                   resultsContainer.innerHTML = "<li style='padding: 10px;'>No companies found</li>";
		                   resultsContainer.style.display = "block";
		                 //  alert("No matching companies found.");
		               }
		           })
		           .catch(error => console.error("Error fetching company names:", error));
		   }


		   function selectCompany(companyId, companyName, type) {
		       const inputId = type === 'call' ? 'callCompanySearchInput' 
		                     : type === 'meeting' ? 'meetingCompanySearchInput' 
		                     : 'taskCompanySearchInput';

		       const resultsContainerId = type === 'call' ? 'callCompanySearchResults' 
		                              : type === 'meeting' ? 'meetingCompanySearchResults' 
		                              : 'taskCompanySearchResults';

		       const contactPersonContainerId = type === 'call' ? 'callContactPersonContainer' 
		                                     : type === 'meeting' ? 'meetingContactPersonContainer' 
		                                     : 'taskContactPersonContainer';

		       const phoneNumberId = type === 'call' ? 'callPhoneNumber' 
		                             : type === 'meeting' ? 'meetingPhoneNumber' 
		                             : 'taskPhoneNumber';

		       // Set the selected company name in the input field
		       document.getElementById(inputId).value = companyName;
		       document.getElementById(resultsContainerId).style.display = "none";

		       // Fetch company details and fill contact person(s) and phone number(s)
		       fetch(`/crmcompanies/${companyId}`)
		           .then(response => response.json())
		           .then(company => {
		               const container = document.getElementById(contactPersonContainerId);
		               const phoneNumberInput = document.getElementById(phoneNumberId);

		               // Clear container and phone number input first
		               container.innerHTML = "";
		               phoneNumberInput.value = "";

		               const contacts = company.contactPersons || [];

		               if (contacts.length === 0) {
		                   // No contacts found - clear fields
		                   container.innerHTML = `<input type="text" class="form-control" readonly value="No contact persons found" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">`;
		                   phoneNumberInput.value = "";
		               } else if (contacts.length === 1) {
		                   // One contact - auto fill and readonly input
		                   const contact = contacts[0];
		                   container.innerHTML = `<input type="text" class="form-control" readonly value="${contact.contactPerson}" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">`;
		                   phoneNumberInput.value = contact.contactNumber || "";
		               } else {
		                   // Multiple contacts - create a dropdown to select contact person
		                   const select = document.createElement("select");
		                   select.className = "form-control";
		                   select.style.padding = "10px";
		                   select.style.borderRadius = "8px";
		                   select.style.border = "1px solid #ddd";

		                   // Add default option
		                   const defaultOption = document.createElement("option");
		                   defaultOption.text = "-- Select Contact Person --";
		                   defaultOption.value = "";
		                   select.add(defaultOption);

		                   // Add contacts as options
		                   contacts.forEach(contact => {
		                       const option = document.createElement("option");
		                       option.value = contact.id;  // you can store id here
		                       option.text = contact.contactPerson;
		                       option.dataset.phone = contact.contactNumber || "";
		                       select.add(option);
		                   });

		                   container.appendChild(select);

		                   // Clear phone number input initially
		                   phoneNumberInput.value = "";

		                   // Update phone number input on contact person selection
		                   select.addEventListener("change", function() {
		                       const selectedOption = select.options[select.selectedIndex];
		                       phoneNumberInput.value = selectedOption.dataset.phone || "";
		                   });
		               }
		           })
		           .catch(error => console.error("Error fetching company details:", error));
		   }

		   // Close the search dropdown when clicking outside the form group
		   document.addEventListener("click", function(event) {
		       if (!event.target.closest(".form-group")) {
		           document.getElementById("callCompanySearchResults").style.display = "none";
		           document.getElementById("meetingCompanySearchResults").style.display = "none";
		           document.getElementById("taskCompanySearchResults").style.display = "none";
		       }
		   });


		   
		   function markCallMade(id) {
		       fetch(`/update-status/${id}/1`, {
		           method: 'PUT',
		           headers: {
		               'Content-Type': 'application/json'
		           }
		       })
		       .then(response => response.text())
		       .then(message => {
		           if (message === "Call status updated successfully") {
		               Swal.fire({
		                   icon: 'success',
		                   title: 'Success',
		                   text: message,
		                   showConfirmButton: false,
		                   timer: 1500
		               });
		           } else {
		               Swal.fire({
		                   icon: 'error',
		                   title: 'Error',
		                   text: message
		               });
		           }
		           $('#detailsModal').modal('hide');
				   $('#callfeedbackModal').modal('show');  // Show the feedback modal
				    document.getElementById("callId").value = id;  
		       })
		       .catch(error => {
		           console.error("Error updating call status:", error);
		           Swal.fire({
		               icon: 'error',
		               title: 'Error',
		               text: 'Failed to update call status. Please try again.'
		           });
		       });
		   }

		   function markCallNotMade(id) {
		       fetch(`/update-status/${id}/0`, {
		           method: 'PUT',
		           headers: {
		               'Content-Type': 'application/json'
		           }
		       })
		       .then(response => response.text())
		       .then(message => {
		           if (message === "Call status updated successfully") {
		               Swal.fire({
		                   icon: 'success',
		                   title: 'Success',
		                   text: message,
		                   showConfirmButton: false,
		                   timer: 1500
		               });
		           } else {
		               Swal.fire({
		                   icon: 'error',
		                   title: 'Error',
		                   text: message
		               });
		           }
		           $('#detailsModal').modal('hide');
				   $('#callfeedbackModal').modal('show');  // Show the feedback modal
				    document.getElementById("callId").value = id;  
		       })
		       .catch(error => {
		           console.error("Error updating call status:", error);
		           Swal.fire({
		               icon: 'error',
		               title: 'Error',
		               text: 'Failed to update call status. Please try again.'
		           });
		       });
		   }
		   function markCallAttempted(id) {
		       fetch(`/markCallAttempted/${id}/2`, {
		           method: 'PUT'
		       })
		       .then(response => {
		           if (response.ok) {
		               alert("Call status updated to 'Attempted, No Response'");
		               $('#detailsModal').modal('hide');
		           } else {
		               alert("Failed to update call status.");
		           }
		       })
		       .catch(error => console.error("Error updating call status:", error));
		   }

	   </script>
		<script>
		document.getElementById("feedbackForm").addEventListener("submit", function (event) {
			    event.preventDefault(); // Prevent default form submission

			    $.ajax({
			        url: 'recentlySavedTicketNumber',
			        type: 'GET',
			        success: function (response) {
			            let recentlyInsertedTicketIdData = response;

			            // Get the current date
			            var today = new Date();
			            var year = today.getFullYear();
			            var month = today.getMonth() + 1; // JavaScript months are 0-based

			            // Calculate the financial year
			            var financialYearStart = month >= 4 ? year : year - 1; // Fiscal year starts in April
			            var financialYearEnd = financialYearStart + 1;

			            // Format as FYY-YY
			            var financialYear = `F${financialYearStart % 100}-${financialYearEnd % 100}`;

			            // Department Name
			            var loggedInDeptName = $('#loggedInDeptName').val();

			            let incrementedNumber = "0001"; // Default number if response is empty or null

			            // Check if recentlyInsertedTicketIdData is not empty or null
			            if (recentlyInsertedTicketIdData) {
			                // Extract the last part of the ticket (e.g., 0001)
			                let ticketParts = recentlyInsertedTicketIdData.split("/");
			                let lastPart = ticketParts[ticketParts.length - 1];

			                // Increment the extracted number
			                let numericValue = parseInt(lastPart, 10) + 1;
			                incrementedNumber = numericValue.toString().padStart(4, '0'); // Pad with leading zeros
			            }

			            // Construct the feedback ticket
			            var feedbackTicket = `MSPL/FT/${financialYear}/${loggedInDeptName}/${incrementedNumber}`;

			            // Add feedback ticket to the form data
			            let formData = new FormData(document.getElementById("feedbackForm"));
			            formData.append("id", feedbackTicket);
			            formData.append("emp_id", $('#emp_idSessionValue').val());

			            const submitButton = document.getElementById("submitFeedbackBtn");
			            submitButton.disabled = true; // Disable the submit button to prevent multiple submissions

			            const loadingSwal = Swal.fire({
			                title: 'Submitting feedback...',
			                text: 'Please wait while we submit your feedback.',
			                showConfirmButton: false,
			                allowOutsideClick: false, // Prevent closing when clicking outside
			                            allowEscapeKey: false, // Prevent closing when pressing escape key
			                didOpen: () => {
			                    Swal.showLoading(); // Display the loading spinner
			                }
			            });

			            // Append files to form data
			            let files = document.getElementById("feedbackAttachment").files;
			            if (files.length > 0) {
			                for (let i = 0; i < files.length; i++) {
			                    formData.append(`attachment[${i}]`, files[i]); // Use unique keys
			                }
			            }

			            let bugType = document.getElementById("bugType").value;
			            formData.append("bugTypeff", bugType); // Add the bug type to the form data

			            // Debugging: Log formData entries before the fetch call
			            console.log("Logging formData entries:");
			            for (let [key, value] of formData.entries()) {
			                if (value instanceof File) {
			                    console.log(`Key: ${key}, File Name: ${value.name}, Size: ${value.size}`);
			                } else {
			                    console.log(`Key: ${key}, Value: ${value}`);
			                }
			            }

			            // Make AJAX request to submit feedback
			            fetch("/submitFeedback", {
			                method: "POST",
			                body: formData
			            })
			                .then(response => response.json())
			                .then(data => {
			                    loadingSwal.close();
			                    submitButton.disabled = false; // Re-enable the button
			                    if (data.success) {
			                        $('#feedbackModal').modal('hide');
			                        Swal.fire({
			                            title: 'Success!',
			                            text: 'Your feedback has been submitted successfully.',
			                            icon: 'success',
			                            allowOutsideClick: false, // Prevent closing when clicking outside
			                                        allowEscapeKey: false, // Prevent closing when pressing escape key
			                            customClass: {
			                                popup: 'custom-swal-font'
			                            },
			                            confirmButtonText: 'OK'
			                        }).then((result) => {
			                            if (result.isConfirmed) {
			                                    Swal.fire({
			                                            html: 'We sincerely appreciate your feedback! Please find your feedback ticket details below.<br><br>' + 
			                                    '<strong>' + feedbackTicket + '</strong>', // Display the feedback ticket on a new line
			                                    allowOutsideClick: false, // Prevent closing when clicking outside
			                                                allowEscapeKey: false, // Prevent closing when pressing escape key
			                                    customClass: {
			                                        popup: 'custom-swal-font'
			                                    },
			                                    confirmButtonText: 'OK'
			                                });
			                            }
			                        });
			                    } else {
			                        Swal.fire({
			                            title: 'Error!',
			                            text: 'There was an error submitting your feedback.',
			                            icon: 'error',
			                            allowOutsideClick: false, // Prevent closing when clicking outside
			                                        allowEscapeKey: false, // Prevent closing when pressing escape key
			                            customClass: {
			                                popup: 'custom-swal-font'
			                            },
			                            confirmButtonText: 'OK'
			                        });
			                    }
			                })
			                .catch(error => {
			                    console.error('Error:', error);
			                    loadingSwal.close();
			                    submitButton.disabled = false; // Re-enable the button
			                    Swal.fire({
			                        title: 'Error!',
			                        text: 'There was an error submitting your feedback.',
			                        icon: 'error',
			                        allowOutsideClick: false, // Prevent closing when clicking outside
			                                    allowEscapeKey: false, // Prevent closing when pressing escape key
			                        customClass: {
			                            popup: 'custom-swal-font'
			                        },
			                        confirmButtonText: 'OK'
			                    });
			                });
			        },
			        error: function (xhr, status, error) {
			            alert('Failed to fetch recently inserted feedback ticket: ' + error);
			        }
			    });
			});


			   // Clear form fields when the modal is closed
			   document.getElementById('feedbackModal').addEventListener('hidden.bs.modal', function () {
			       const feedbackForm = document.getElementById('feedbackForm');
			       feedbackForm.reset(); // Reset the form fields
			       document.getElementById('feedbackAttachment').value = ""; // Clear file input manually
			   });
	</script>



	<script>

		var formattedDate;

		/* $.ajax({
			 type: 'GET', 
			 url: 'viewHolidays', 
			 success: function(data) {
				   //alert(JSON.stringify(data));
				   updateHolidayDetailsData(data);
				   },
			 error: function(xhr, status, error) {
				 console.error('Error fetching data:', error);
				 console.log('Error fetching data. Please try again.');
			 }
		 });*/

		/*function updateHolidayDetailsData(data) {
		  var viewEmpDetailsTBody = document.getElementById('viewHolidayDetailsTBody');
		  
		  viewEmpDetailsTBody.innerHTML = ''; 
		  
		  if (data && data.length > 0) {
			  for (var i = 0; i < data.length; i++) {
				  
				  var row = "<tr class='custom_tr'>" +
							 "<td><div class='edittt_div' onclick='editPopUp(\"" + data[i].id + "\")'><img alt='view_icon' src='assets/images/ams_edit_icon5.png' class='view_icon'></div></td>" +
								"<td><div class='delete_div' onclick='deleteById(" + data[i].id + ")'><img alt='edit_icon' src='assets/images/ams_delete_icon6.png' class='edit_icon'></div></td>" + 					"<td style='display: none;'>" + data[i].id + "</td>" +
								"<td>" + (i+1) + "</td>" +
								"<td class='dateColumn dateFormatter' id='dateFormat'>" + data[i].date + "</td>" +
								"<td>" + data[i].day + "</td>" +
								"<td>" + data[i].name + "</td>" +
								"</tr>";
		
				  viewEmpDetailsTBody.innerHTML += row; //Append row HTML
			  }
			  
		   // Format dates after all rows are appended
			  formatDates();
			  
		  } else {
			  var noDataRow = "<tr><td colspan='6'>No data available</td></tr>";
			  viewEmpDetailsTBody.innerHTML = noDataRow; // Display 'No data available'
		  }
		}*/


	


	</script>

	<script>
		var loggedInRole = document.getElementById('roleValue').value;

		if (loggedInRole === "HR") {
			document.getElementById('employeeLink').style.display = "block";
			document.getElementById('holidayForm').style.display = "block";
			//document.getElementById('compProjectLink').style.display="none";
			//document.getElementById('addEmployeeLink').style.display="block";
		} else if (loggedInRole === "Super Admin") {
			document.getElementById('employeeLink').style.display = "none";
			document.getElementById('holidayForm').style.display = "none";
			document.getElementById('holidayTable').style.width = "100%";
			//document.getElementById('compProjectLink').style.display="block";
			//document.getElementById('addEmployeeLink').style.display="none";
		}
	</script>
	<script>
		function getLeavePendingCount() {
			$.ajax({
				type: 'GET',
				url: '/getProjectNames',
				success: function (projectNames) {
					console.log('Project namesssss:', projectNames);

					if (projectNames.length > 0) {
						projectNames.forEach(function (projectName) {
							console.log('Fetching notifications for project:', projectName); // Debug log
							getNotificationCounts(projectName); // Pass projectName here
						});
					} else {

						console.error('No project names found for the given user.');
						$('#notification_list_message').text('No projects found for your email.');
						$('#defaultBox').show();
						getDefaultNotificationCounts();

					}
				},
				error: function (xhr, status, error) {
					console.error('Error fetching project names:', error);
					$('#notification_list_message').text('Error fetching project names. Please try again later.');
					$('#defaultBox').show();
					getDefaultNotificationCounts();

				}
			});
		}


		function getNotificationCounts(projectName) {
					console.log('Inside getNotificationCounts for project:', projectName);
					$.ajax({
						type: 'GET',
						url: 'fetchNotificationCountForAllPages',
						data: {projectName: projectName},
						success: function (data) {
							console.log("=======" + JSON.stringify(data));

							var totalNotificationCount = data.total_notification;
							var leavePendingCountValue = data.leave_pending_count;
							var newProjectCountValue = data.newProjectCount;
							var appraisalCountValue = data.appraisalCountValue;
							var appraisalTwoDaysCountValue = data.appraisalTwoDaysCountValue;
							var appraisalOneDayCountValue = data.appraisalOneDayCountValue;
							var ToDoListNotification = data.toDoListNotification;
							var eventsNotification = data.eventsNotification;
							var featuresNotification = data.featuresNotification;
							var releaseNotification = data.releaseNotification;
							var quotationNotification = data.quotationNotification || 0;
							var revisedQuotationNotification = data.revisedQuotationNotification || 0;
							$('#notificationCount').text(totalNotificationCount);
							updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, newProjectCountValue, appraisalCountValue, appraisalTwoDaysCountValue, appraisalOneDayCountValue, ToDoListNotification, eventsNotification, featuresNotification,releaseNotification,quotationNotification,revisedQuotationNotification);
						},
						error: function (xhr, status, error) {
							console.error('Error fetching data:', error);
							console.log('Error fetching data. Please try again.');
						}
					});
				}

				function getDefaultNotificationCounts() {
					//console.log('Fetching general notification counts.');
					$.ajax({
						type: 'GET',
						url: 'fetchNotificationCountForAllPagesWithoutProject',
						success: function (data) {
							console.log("General notification data:", JSON.stringify(data));

							var totalNotificationCount = data.total_notification || 0;
							var leavePendingCountValue = data.leave_pending_count || 0;
							var newProjectCountValue = data.newProjectCount || 0;
							var appraisalCountValue = data.appraisalCountValue || 0;
							var appraisalTwoDaysCountValue = data.appraisalTwoDaysCountValue || 0;
							var appraisalOneDayCountValue = data.appraisalOneDayCountValue || 0;
							var toDoListNotification = data.toDoListNotification || 0;
							var eventsNotification = data.eventsNotification || 0;
							var featuresNotification = data.featuresNotification || 0;
							var releaseNotification = data.releaseNotification || 0;
							var quotationNotification = data.quotationNotification || 0;
							var revisedQuotationNotification = data.revisedQuotationNotification || 0;
							$('#notificationCount').text(totalNotificationCount);
							updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, newProjectCountValue, appraisalCountValue, appraisalTwoDaysCountValue, appraisalOneDayCountValue, toDoListNotification, eventsNotification, featuresNotification,releaseNotification,quotationNotification,revisedQuotationNotification);
						},
						error: function (xhr, status, error) {
							//console.error('Error fetching general notifications:', error);
							$('#notification_list_message').text('Error fetching notifications. Please try again later.');
						}
					});
				}


				$(document).ready(function () {
					getLeavePendingCount();
				setInterval(getLeavePendingCount, 1000);
				});

				function updateNotificationDetailData(totalNotificationCount, leavePendingCountValue, newprojectCountValue, appraisalCountValue, appraisalTwoDaysCountValue, appraisalOneDayCountValue, ToDoListNotification, eventsNotification, featuresNotification,releaseNotification,quotationNotification,revisedQuotationNotification) {
					var emptyNotifyDiv = $('#emptyNotifyDiv');
					//var leaveRequestNotifyDiv = $('#leaveRequestNotifyDiv');

					var leaveRequestNotifyDiv = $('#leaveRequestNotifyDiv');
					var leaveRequestNotifyDivHorizontalRow = $('#leaveRequestNotifyDivHorizontalRow');

					var moatNewCandidateNotifyDiv = $('#moatNewCandidateNotifyDiv');
					var moatNewCandidateNotifyDivHorizontalRow = $('#moatNewCandidateNotifyDivHorizontalRow');

					var appraisalNotifyDiv = $('#appraisalNotifyDiv');
					var appraisalNotifyDivHorizontalRow = $('#appraisalNotifyDivHorizontalRow');

					var appraisalTwoDaysNotifyDiv = $('#appraisalTwoDaysNotifyDiv');
					var appraisalTwoDaysNotifyDivHorizontalRow = $('#appraisalTwoDaysNotifyDivHorizontalRow');

					var appraisalOneDayNotifyDiv = $('#appraisalOneDayNotifyDiv');
					var appraisalOneDayNotifyDivHorizontalRow = $('#appraisalOneDayNotifyDivHorizontalRow');

					var ToDoListNotifyDiv = $('#ToDoListNotifyDiv');
					var ToDoListNotifyDivHorizontalRow = $('#ToDoListNotifyDivHorizontalRow');

					var EventNotifyDiv = $('#EventNotifyDiv');
					var EventNotifyDivHorizontalRow = $('#EventNotifyDivHorizontalRow');

					var FeaturesNotifyDiv = $('#FeaturesNotifyDiv');
					var FeaturesNotifyDivHorizontalRow = $('#FeaturesNotifyDivHorizontalRow');

					var ReleaseNotifyDiv = $('#ReleaseNotifyDiv');
								var ReleaseNotifyDivHorizontalRow = $('#ReleaseNotifyDivHorizontalRow');

								var QuotationNotifyDiv = $('#quotationNotifyDiv');
								var QuotationNotifyDivHorizontalRow = $('#quotationNotifyDivHorizontalRow');

								var ReviseQuotationNotifyDiv = $('#RevisequotationNotifyDiv');
														var ReviseQuotationNotifyDivHorizontalRow = $('#RevisequotationNotifyDivHorizontalRow');

								
					if (totalNotificationCount > 0) {
						$("#bellIcon").show();
						$("#emptyNotifyDiv").hide();
						$('#emptyNotificationHeaderMessage').text("");

						if (leavePendingCountValue > 0) {
							leaveRequestNotifyDiv.show();
							$('#leaveNotificationMessage').text("You have " + leavePendingCountValue + " new leave Notification");
							$('#leaveNotificationNumberHeader').text("Leave Request!");
						} else {
							leaveRequestNotifyDiv.hide();
						}
						if (newprojectCountValue > 0) {
							moatNewCandidateNotifyDiv.show();
							moatNewCandidateNotifyDivHorizontalRow.show();
							$('#moatNewCandidateNotificationMessage').text("There is " + newprojectCountValue + " New Project Task Assigned");
							$('#moatNewCandidateNumberHeader').text("Project!");
						} else {
							moatNewCandidateNotifyDiv.hide();

						} if (appraisalCountValue > 0) {
							appraisalNotifyDiv.show();
							appraisalNotifyDivHorizontalRow.show();
							$('#appraisalNotificationMessage').text("There is " + appraisalCountValue + " Appraisal Form Assigned");
							$('#appraisalNumberHeader').text("Appraisal!");
						} else {
							appraisalNotifyDiv.hide();
						} if (appraisalTwoDaysCountValue > 0) {
							appraisalTwoDaysNotifyDiv.show();
							appraisalTwoDaysNotifyDivHorizontalRow.show();
							$('#appraisalTwoDaysNotificationMessage').text("Reminder: Complete and submit your appraisal form at your earliest convenience.");
							$('#appraisalTwoDaysNumberHeader').text("Appraisal!");
						} else {
							appraisalTwoDaysNotifyDiv.hide();
						} if (appraisalOneDayCountValue > 0) {
							appraisalOneDayNotifyDiv.show();
							appraisalOneDayNotifyDivHorizontalRow.show();
							$('#appraisalOneDayNotificationMessage').text("Reminder: Just one more day until the appraisal form submission deadline. Please take action!");
							$('#appraisalOneDayNumberHeader').text("Appraisal!");
						} else {
							appraisalOneDayNotifyDiv.hide();
						} if (ToDoListNotification > 0) {
							ToDoListNotifyDiv.show();
							ToDoListNotifyDivHorizontalRow.show();
							$('#ToDoListNotificationMessage').text("Time is ticking! Don't forget to complete your task before the deadline.");
							$('#ToDoListNumberHeader').text("Reminder!");
						} else {
							ToDoListNotifyDiv.hide();
						} if (eventsNotification > 0) {
							EventNotifyDiv.show();
							EventNotifyDivHorizontalRow.show();
							$('#EventNotificationMessage').text("There is  " + eventsNotification + " new event has been scheduled. Mark your calendars!");
							$('#EventNumberHeader').text("Announcements!");
						} else {
							EventNotifyDiv.hide();
						} if (featuresNotification > 0) {
							FeaturesNotifyDiv.show();
							FeaturesNotifyDivHorizontalRow.show();
							$('#FeaturesNotificationMessage').text("There is  " + featuresNotification + " new feature update is now available! explore the latest enhancements.");
							$('#FeaturesNumberHeader').text("Latest Update!");
						} else {
							FeaturesNotifyDiv.hide();
						}				if (releaseNotification > 0) {
											ReleaseNotifyDiv.show();
											ReleaseNotifyDivHorizontalRow.show();
											$('#ReleaseNotificationMessage').html(
											    /*'There is a latest release available! Click here to see the details. Version: <b>V.0.1.1</b>'*/
											);	$('#ReleaseNumberHeader').text("Latest Release About Policy Update!");
										} else {
											ReleaseNotifyDiv.hide();
										}								if (quotationNotification > 0) {
																			QuotationNotifyDiv.show();
																			QuotationNotifyDivHorizontalRow.show();
																			$('#quotationNotificationMessage').html(
																			    /*'There is a latest release available! Click here to see the details. Version: <b>V.0.1.1</b>'*/
																				`You have <b>${quotationNotification}</b> approved quotation${quotationNotification > 1 ? 's' : ''} . Click to view.`
																			);	$('#quotationNumberHeader').text("Approved Quotations");
																		} else {
																			QuotationNotifyDiv.hide();
																		}																if (revisedQuotationNotification > 0) {
																																			ReviseQuotationNotifyDiv.show();
																																			ReviseQuotationNotifyDivHorizontalRow.show();
																																			$('#RevisequotationNotificationMessage').html(
																																			    /*'There is a latest release available! Click here to see the details. Version: <b>V.0.1.1</b>'*/
																																				`You have <b>${revisedQuotationNotification}</b> revised quotation${revisedQuotationNotification > 1 ? 's' : ''} awaiting your attention.`
																																			);	$('#RevisequotationNumberHeader').text("Revised Quotations");
																																		} else {
																																			ReviseQuotationNotifyDiv.hide();
																																		}
					} else {
						$("#bellIcon").hide();
						$("#emptyNotifyDiv").show();
						$('#emptyNotificationHeaderMessage').text("Currently there are no notifications");
					}
				}



	</script>
	<input type="hidden" id="emp_idSessionValue" th:value="${empId}" />

	<script>
		$.ajax({
			type: "GET",
			url: "fetchEmployeeDocumentDetailsOnlyByEmpId",
			data: {
				"emp_id": $('#emp_idSessionValue').val()
			},
			success: function (data) {
				$('#dynamicProfilePic').attr('src', `${data.profilePicPath}`);
			},
			error: function (xhr, status, error) {
				console.error("Error invoking data:", error);
			}
		});
	</script>

<!-- 	<script>
		window.onload = function () {
			var apprisalLink = document.getElementById("apprisalLink");
			if (apprisalLink) {
				apprisalLink.classList.add('blinking');  // Add blinking class
				apprisalLink.focus();  // Set focus after animation
			}
		};
	</script> -->
	<script>
		/*let inactivityTimeout;
			const timeoutDuration = 14400000; // 10 minutes in milliseconds

			function updateUserStatusAndLogout() {
			    const emailElement = document.getElementById('loggedInMail');
			    if (!emailElement) {
			        console.error('Email element not found.');
			        return;
			    }
			    
			    const email = emailElement.value;

			    fetch('/updateUserStatus', {
			        method: 'POST',
			        headers: { 'Content-Type': 'application/json' },
			        body: JSON.stringify({ email: email }) // Corrected JSON structure
			    }).then(() => {
			        window.location.href = '/'; // Redirect to login page
			    }).catch(error => console.error('Error updating user status:', error));
			}

		
			// Reset inactivity timer on user activity
			function resetInactivityTimer() {
			    clearTimeout(inactivityTimeout);
			    inactivityTimeout = setTimeout(updateUserStatusAndLogout, timeoutDuration);
			}

			// Attach event listeners
			window.onload = resetInactivityTimer;
			document.onmousemove = resetInactivityTimer;
			document.onkeypress = resetInactivityTimer;
			document.ontouchstart = resetInactivityTimer;
			

			let isNavigatingAway = false;

							// Detect internal navigation (links clicked within the same domain)
							document.addEventListener("click", function (event) {
							    let target = event.target.closest("a");
							    if (target && target.href.includes(window.location.origin)) {
							        isNavigatingAway = true;
							    }
							});

							// Handle back/forward navigation
							window.addEventListener("popstate", function () {
							    isNavigatingAway = true;
							});


							// Store session flag only when user reloads
							
							// Store session flag when the page loads
							sessionStorage.setItem("isReloading", "true");

							// Remove session flag on page load and check reload
							window.addEventListener("load", function () {
							    if (sessionStorage.getItem("isReloading") === "true") {
									
							       // alert("Page reloaded!"); // Debug alert for reload
							        console.log("Page reload detected");
									sendUserStatusUpdate();
							        sessionStorage.removeItem("isReloading"); // Remove flag after detecting reload
							    }
							});

							// Function to send status update on reload
							function sendUserStatusUpdate() {
							    const emailElement = document.getElementById("loggedInMail");
							    if (!emailElement) {
							        console.error("Email element not found.");
							        return;
							    }

							    const email = emailElement.value;
							    const formData = new FormData();
							    formData.append("email", email);

							    // Send API request on reload
							    navigator.sendBeacon("/updateUserStatusOnReload", formData);
							}
							// Detect page visibility changes
							document.addEventListener("visibilitychange", () => {
							    if (document.visibilityState === "visible") {
							        isNavigatingAway = false; // Reset if user is still on the site
							    }
							});

							
							// Handle tab/window close
							function handleTabClose(event) {
								
								console.log("pkljj ");
							    if (isNavigatingAway) {
							        console.log("Navigating within site, not sending API request.");
							        return; // Ignore if navigating within the site
							    }

							    const isReloading = sessionStorage.getItem("isReloading") === "true";
							    const emailElement = document.getElementById("loggedInMail");
								console.log("Checking isReloading:", isReloading);
							    if (!emailElement) {
							        console.error("Email element not found.");
							        return;
							    }

							    const email = emailElement.value;
							    const formData = new FormData();
							    formData.append("email", email);

							    if (isReloading) {
							       // alert("Page is reloading, API request not sent."); // Alert for reload
							        console.log("Reload detected, skipping API call.");
							        return; // Do not send API call on reload
							    }

							   // alert("Tab or window closed! Sending API request."); // Alert for tab close
							    console.log("Sending API request to /updateUserStatusOnClose for:", email);
							    
							    // Use sendBeacon for reliability
							    navigator.sendBeacon("/updateUserStatusOnClose", formData);
							}

							// Use pagehide and beforeunload (for better reliability)
							window.addEventListener("pagehide", handleTabClose);
							window.addEventListener("beforeunload", handleTabClose);*/
						
	</script>

	<script>
			  let inactivityTimeout;
			  const timeoutDuration = 14400000; // 15 minutes in milliseconds
			  
			  // Reset the timeout when there is any user activity (e.g., mouse move, key press, etc.)
			  function resetInactivityTimer() {
			    clearTimeout(inactivityTimeout);
			    inactivityTimeout = setTimeout(() => {
			      window.location.href = '/'; // Redirect to the login page
			    }, timeoutDuration);
			  }

			  // Attach event listeners to reset the timer on user activity
			  window.onload = resetInactivityTimer;
			  document.onmousemove = resetInactivityTimer;
			  document.onkeypress = resetInactivityTimer;
			  document.ontouchstart = resetInactivityTimer;
			</script>


	<div class="chat-app" style="display: none;">
		<div id="plist" class="people-list">
			<div class="input-group mb-3">
				<input type="text" id="searchInputModal" class="form-control" placeholder="Search..."
					aria-label="Search">
				<span class="input-group-text">
					<i class="bi bi-search"></i>
				</span>

			</div>
			<ul id="employeeNames" class="list-unstyled chat-list mt-2 mb-0">
				<!-- Employee names will be dynamically populated here -->
			</ul>
		</div>

		<div class="chat">
			<div class="chat-header clearfix">
				<div class="row w-100">

					<!-- Employee Photo and Name Section -->
					<div class="col-lg-6 d-flex align-items-center">
						<div class="chat-about d-flex align-items-center">
							<img id="employeePhoto" class="employee-photo" src="default-avatar.png"
								alt="Employee Photo" />
							<h6 class="m-b-0 ml-2" id="employeeName">Select an Employee</h6>
						</div>
					</div>
					<!-- Right aligned three dots (Vertical) -->
					<div class="col-lg-6 text-right">
						<div class="dropdown custom-dropdown">
							<button class="btn btn-outline-secondary" type="button" id="dropdownMenuButton"
								data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fa fa-ellipsis-v"></i>
							</button>
							<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
								<li><a class="dropdown-item" href="#">Delete Chat</a></li>
								<li><a class="dropdown-item" href="#">Mute</a></li>
								<li><a class="dropdown-item" href="#">Contact Info</a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<div id="chat-window" class="chat-history">
				<ul class="m-b-0">
					<!-- Chat messages will be populated here dynamically -->

				</ul>
				<div id="message-icon-container" class="message-icon" style="display: none;">

					<!-- Plain square message icon SVG (behind) -->
					<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
						<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
						<g id="SVGRepo_iconCarrier">
							<path
								d="M10 9H17M10 13H17M7 9H7.01M7 13H7.01M21 20L17.6757 18.3378C17.4237 18.2118 17.2977 18.1488 17.1656 18.1044C17.0484 18.065 16.9277 18.0365 16.8052 18.0193C16.6672 18 16.5263 18 16.2446 18H6.2C5.07989 18 4.51984 18 4.09202 17.782C3.71569 17.5903 3.40973 17.2843 3.21799 16.908C3 16.4802 3 15.9201 3 14.8V7.2C3 6.07989 3 5.51984 3.21799 5.09202C3.40973 4.71569 3.71569 4.40973 4.09202 4.21799C4.51984 4 5.0799 4 6.2 4H17.8C18.9201 4 19.4802 4 19.908 4.21799C20.2843 4.40973 20.5903 4.71569 20.782 5.09202C21 5.51984 21 6.0799 21 7.2V20Z"
								stroke="#94b7db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
						</g>
					</svg>

					<!-- SVG with animation -->
					<svg class="animated-icon" viewBox="0 0 374 374" fill="none" xmlns="http://www.w3.org/2000/svg">
						<g clip-path="url(#clip0)">
							<path
								d="M318.084 132.622C311.339 101.37 287.642 82 256.652 82C238.423 82 217.459 89.3248 197.954 102.509C191.574 106.904 182.642 106.904 176.079 102.672C155.298 88.9992 135.246 82 116.652 82C85.6626 82 61.9647 101.533 55.2199 133.111C44.2824 183.896 80.923 252.26 187.017 291C292.746 251.446 329.204 183.082 318.084 132.622Z" />
							<path
								d="M187.466 0C187.366 0 187.166 0 186.866 0C85.666 0 3.36603 82.3 3.36603 183.5C3.36603 224.8 17.466 264.9 43.266 297.2L16.566 359.3C14.366 364.4 16.766 370.3 21.766 372.4C23.566 373.2 25.566 373.4 27.466 373.1L125.366 355.9C144.966 363 165.566 366.6 186.366 366.5C287.566 366.5 369.866 284.2 369.866 183C370.066 82.1 288.366 0.1 187.466 0ZM192.966 269.8C188.966 271.3 184.666 271.3 180.666 269.8C149.066 257.1 124.466 238.3 109.466 215.4C95.966 194.7 90.766 171.4 94.866 149.9C100.466 121.4 121.866 102.3 148.266 102.3C160.966 102.3 173.866 106.5 186.766 114.7C199.366 106.5 212.466 102.3 225.066 102.3C251.866 102.3 272.866 120.9 278.466 149.6C286.066 188.8 262.666 241.3 192.966 269.8Z" />
						</g>
						<defs>
							<clipPath id="clip0">
								<rect width="373.232" height="373.232" fill="white" />
							</clipPath>
						</defs>
					</svg>



					<!-- Dots Animation -->
					<div class="dots">
						<div class="dot"></div>
						<div class="dot"></div>
						<div class="dot"></div>
					</div>




				</div>


			</div>
			<!-- Move the paragraph outside the chat window -->
			<p id="logo-text"
				style="text-align: center; font-size: 14px; color: #6c757d; margin-top: 10px; display: none;">
				"Reach out to your colleagues and stay on top of your projects with quick, seamless communication."
			</p>
			<div class="chat-message clearfix">
				<div class="custom-input-group mb-0">
					<input type="text" id="message" class="custom-form-control" placeholder="Enter your message..." />
					<div class="custom-input-group-append">
						<button class="custom-send-btn" onclick="sendMessage()">
							<i class="ri ri-send-plane-2-fill"></i>
						</button>
					</div>
				</div>

			</div>
		</div>
	</div>
	<input type="hidden" th:value="${loggedInUserEmail}" id="loggedInMail">
	<input type="hidden" id="loggedAdminEmpId2" th:value="${empId}">

	<script>
		    function fetchUnreadCount() {
		        console.log("Fetching unread message count...");

		        var userEmailElement = document.getElementById('loggedInMail');
		        if (!userEmailElement) {
		            console.error("Error: #loggedInMail element not found!");
		            return;
		        }

		        var userEmail = userEmailElement.value;
		        console.log("User email:", userEmail);

		        if (!userEmail) {
		            console.warn("No email found, skipping fetch.");
		            return;
		        }

		        fetch(`/unread-count?email=${encodeURIComponent(userEmail)}`)
		            .then(response => {
		                console.log("Response received:", response);
		                return response.json();
		            })
		            .then(count => {
		                console.log("Unread count:", count);

		                const badge = document.getElementById("unreadCountBadge");
						
						
						
		                if (!badge) {
		                    console.error("Error: #unreadCountBadge element not found!");
		                    return;
		                }

		                if (count > 0) {
		                    badge.textContent = count;
		                    badge.style.display = "inline-block";
							
							
		                } else {
		                    badge.style.display = "none";
							
		                }
		            })
		            .catch(error => console.error("Error fetching unread messages:", error));
		    }

		    setInterval(fetchUnreadCount, 5000); // Fetch count every 5 seconds
		    fetchUnreadCount(); // Initial fetch
		</script>

	<script>
		//CODE FOR CHATBOOT NOTIFICATION 
		var stompClient = null;
		var employeeMap = {}; // To store the mapping of employee names to emails
		let employeePhotoMap = {};
		let emailToNameMap = {}; // New map for email -> name lookup
		var email = null;
		var visibilityState = document.visibilityState; // Track tab visibility
		var heartbeatInterval = null; // Track heartbeat interval

		function connectWebSocket() {
			
			var socket = new SockJS('/chat-websocket');
						  stompClient = Stomp.over(socket);

						  var email = document.getElementById('loggedInMail').value;
						  console.log(`Connecting WebSocket as: ${email}`);

						  stompClient.connect({ 'email': email }, function (frame) {
						      console.log('Connected to WebSocket:', frame);

							 // subscribeToTypingEvents();
						      // Mark user as active
						      stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));

						      // Subscribe to active users list
						      stompClient.subscribe('/topic/activeUsers', function (message) {
						          var activeUsers = JSON.parse(message.body);
						          updateActiveUserUI(activeUsers);
						      });
							  // Subscribe to user messages
							        stompClient.subscribe('/user/queue/messages', function (message) {
									//	loadMessages();
									//	alert("po2");
							            console.log('Raw WebSocket Message:11', message);
							            var msg = JSON.parse(message.body);
										//alert(msg);
							            console.log('Parsed Messag111e:', msg);
							            console.log(`Received messagesdsd: ${JSON.stringify(msg)}`);
										//alert("(message.read"+msg.read);
									
							            // Display message if it matches the selected employee
							            if (selectedEmployee === msg.senderEmail || selectedEmployee === msg.recipientEmail) {
											console.log(`New message fromss ${msg.senderEmail}: ${msg.content}`);
											console.log("plk "+selectedEmployee);
											console.log("plk "+msg.senderEmail);
											console.log("plk "+msg.recipientEmail);
											//loadMessages();
							                showMessage(
							                    msg.id,               // Message ID
							                    msg.senderEmail,      // Sender's email
							                    msg.content,          // Message content
							                    msg.recipientEmail,   // Recipient's email
							                    msg.timestamp,        // Message timestamp
							                    email,
												msg.read                    // Logged-in user's email
							                );
							            }
								
										loadEmployees();
										loadMessages();
									 	
							        });

							        // Subscribe to notifications
							        stompClient.subscribe('/user/queue/notifications', function (notification) {
										//alert("00");
							            console.log('New Notification:', notification.body);
							            showToastNotification(notification.body);
										loadEmployees();
										//alert("01");
							        });

									//alert("Subscribing to chat updates...");
									stompClient.subscribe('/user/queue/messages', function (message) {
									    console.log('WebSocket Chat Update Received:', message.body); // Log raw message

									    let parsedMessage = JSON.parse(message.body);
									    console.log('Parsed Message:', parsedMessage); // Log parsed JSON

									    if (Array.isArray(parsedMessage)) {
									        parsedMessage.forEach(msg => {
									            console.log(`Message ID: ${msg.id}, Read: ${msg.read}`);
									            if (msg.read) {
									                updateMessageUI(msg);
									            }
									        });
									    } else {
									        console.log("Unexpected message format:", parsedMessage);
									    }

									    // Refresh messages after a delay
									    setTimeout(() => {
									        console.log("Refreshing messages...");
									        loadMessages();
									    }, 3000);
									});

									stompClient.subscribe('/topic/typing', function (message) {
									    console.log(" Typing notification received:", message.body);

									    let typingData;
									    try {
									        typingData = JSON.parse(message.body);
									        console.log(" Parsed Typing Data:", typingData);
									    } catch (error) {
									        console.error(" Error parsing typing notification message:", error);
									        return;
									    }

									    let loggedInUserEmail = document.getElementById('loggedInMail')?.value;
									    if (!loggedInUserEmail) return;

									    if (loggedInUserEmail === typingData.recipientEmail && typingData.senderEmail === selectedEmployee) {
									        // Fetch actual typing status from the backend
									        fetch(`/getTypingStatus?senderEmail=${typingData.senderEmail}&recipientEmail=${typingData.recipientEmail}`)
									            .then(response => response.json())
									            .then(data => {
									                console.log(" Actual Typing Status from DB:", data.typing);
													console.log(" Actual Typing Status from DB:", data);
													                console.log(" Typing Status (0 or 1):", data.typing);
													                
									                let chatMessages = document.querySelector(".chat-history ul");
									                let chatContainer = document.querySelector(".chat-history"); // The scrollable chat area

									                let typingIndicator = document.getElementById("typingIndicator");
									                
									                if (!typingIndicator) {
									                    typingIndicator = document.createElement("li");
									                    typingIndicator.id = "typingIndicator";
									                    typingIndicator.classList.add("typing-indicator");
									                    typingIndicator.innerHTML = `
									                        <img src="${employeePhotoMap[selectedEmployee] || 'default-profile.jpg'}" alt="User Photo" class="typing-photo">
									                        <span>Typing...</span>
									                    `;
									                    chatMessages.appendChild(typingIndicator);
									                }

									                if (data.typing === 1) { // Ensure it checks the latest typing status
									                    typingIndicator.style.display = "flex";

									                    // Move typing indicator to the bottom
									                    chatMessages.appendChild(typingIndicator);

									                    // Auto-scroll to the bottom
									                    setTimeout(() => {
									                        chatContainer.scrollTop = chatContainer.scrollHeight;
									                    }, 100);
									                } else {
									                    typingIndicator.style.display = "none";
									                }
									            })
									            .catch(error => console.error(" Error fetching typing status:", error));
									    }
									});


						      // Start heartbeat initially
						      heartbeatInterval = setInterval(() => {
						          if (stompClient && stompClient.connected) {
						              stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
						              console.log("Heartbeat sent for user: " + email);
						          }
						      }, 20000); // 30 seconds

						      // Detect tab visibility change
						  /*    document.addEventListener("visibilitychange", function () {
						          if (document.hidden) {
						              console.log("User switched to another tab. Marking as inactive.");
						              stompClient.send("/app/userInactive", {}, JSON.stringify({ email }));
						              clearInterval(heartbeatInterval); // Stop heartbeat
						              heartbeatInterval = null;
						          } else {
						              console.log("User returned to the application tab. Marking as active.");
						              stompClient.send("/app/userConnected", {}, JSON.stringify({ email }));
						              if (!heartbeatInterval) {
						                  heartbeatInterval = setInterval(() => {
						                      if (stompClient && stompClient.connected) {
						                          stompClient.send("/app/userHeartbeat", {}, JSON.stringify({ email }));
						                          console.log("Heartbeat sent for user: " + email);
						                      }
						                  }, 30000);
						              }
						          }
						      });*/

						      // Detect tab close or WebSocket disconnect
						      socket.onclose = function () {
						          console.log("WebSocket disconnected. Updating user status.");
						          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
						      };

						      window.addEventListener('beforeunload', function () {
						          stompClient.send("/app/userDisconnected", {}, JSON.stringify({ email }));
						      });

						  });
		}

		function updateActiveUserUI(activeUsers) {
		//	alert("1");
		    const employeeItems = document.getElementById('employeeNames').getElementsByTagName('li');

		    Array.from(employeeItems).forEach(item => {
		        const employeeName = item.querySelector('span').textContent;
		        const email = employeeMap[employeeName]; 
		        const statusIndicator = item.querySelector('.status-indicator'); // Get the status dot

		        if (activeUsers.includes(email)) {
		            item.classList.add('active-user');
		            statusIndicator.style.backgroundColor = '#66cc66'; // Green for active users
		        } else {
		            item.classList.remove('active-user');
		            statusIndicator.style.backgroundColor = '#ff6666'; // Red for inactive users
		        }

		        // If this employee is currently selected, update chat header status
				if (selectedEmployee === email) {
				           const chatStatusIndicator = document.getElementById('chatStatusIndicator');
				           if (activeUsers.includes(email)) {
				               chatStatusIndicator.style.backgroundColor = '#66cc66'; // Green (Online)
				           } else {
				               chatStatusIndicator.style.backgroundColor = '#ff6666'; // Red (Offline)
				           }
				       }
		    });
		}


		// Select an employee to chat with
		function selectEmployee(employeeName) {
			selectedEmployee = employeeMap[employeeName]; // Get the email from the map
			console.log(`Employee selected: ${selectedEmployee}`);

			// Highlight the selected employee
			var employeeItems = document.querySelectorAll('#employeeNames li');
			employeeItems.forEach(function (item) {
				item.classList.remove('active');
			});
			var selectedItem = Array.from(employeeItems).find(item => item.innerHTML === employeeName);
			if (selectedItem) {
				selectedItem.classList.add('active');
			}

			// Update chat header with employee name and photo
			document.querySelector('.chat-about h6').innerText = employeeName;
			document.querySelector('#employeePhoto').src = employeePhotoMap[selectedEmployee] || 'default-profile.jpg';

			// Hide the message icon and dots when an employee is selected
			document.getElementById('message-icon-container').style.display = 'none';
			// Hide the paragraph when an employee is selected
			document.getElementById('logo-text').style.display = 'none';

			// Load messages for the selected employee
			loadMessages();
		}

		function loadEmployees() {
			console.log("Loading employee names...");

			// Fetch employee names from the endpoint
			fetch('/employees/names')
				.then(response => {
					console.log("Response received:", response);
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then(data => {
					console.log("Employee data fetched:", data); // Log the raw data

					const employeeList = document.getElementById('employeeNames');
					if (!employeeList) {
						console.error("Element with ID 'employeeNames' not found.");
						return;
					}

					employeeList.innerHTML = ''; // Clear the list before adding new items

					// Iterate through employee data
					data.forEach(employee => {
						console.log("Processing employee:", employee);

						// Create a list item for each employee
						const li = document.createElement('li');
						li.classList.add('d-flex', 'align-items-center', 'employee-item');

						// Handle missing or empty profile photo paths
						const profilePic = employeePhotoMap[employee.email] || '/static/default-profile.jpg';
						console.log(`Profile picture for ${employee.name}: ${profilePic}`);

						li.innerHTML = `
			                    <img src="${profilePic}" 
			                         alt="Employee Photo" 
			                         class="employee-photo mr-2" />
			                    <span>${employee.name}</span>
			                `;

						// Map employee name to email
						employeeMap[employee.name] = employee.email;
						console.log("Mapped employee:", employee.name, "->", employee.email);
						// Add new reverse mapping (email -> name)
						emailToNameMap[employee.email] = employee.name;
						// Add click event to list item
						li.onclick = () => {
							console.log(`Selected employee: ${employee.name}`);
							selectEmployee(employee.name);
						};

						// Append the list item to the employee list
						employeeList.appendChild(li);

					});

					console.log("Employee names loaded successfully. Employee map:", employeeMap);
					// Call the unread messages function after loading employee data
					fetchUnreadMessages();

					// Set interval to check for new messages every 10 seconds
						setInterval(fetchUnreadMessages, 10000);
				})
				.catch(error => {
					console.error("Error loading employees:", error);
				});
		}


		function loadMessages() {
			// alert("Loading messages...");
			// Get the logged-in user's email and selected employee's email
			var loggedInEmail = document.getElementById('loggedInMail').value;
			var selectedEmployeeEmail = selectedEmployee; // Email is already stored in selectedEmployee

			console.log(`Loading messages between: ${loggedInEmail} and ${selectedEmployeeEmail}`);

			fetch(`/messages?loggedInEmail=${encodeURIComponent(loggedInEmail)}&selectedEmployeeEmail=${encodeURIComponent(selectedEmployeeEmail)}`)
				.then(response => response.json())
				.then(data => {
					console.log("Chat messages loaded:", data);
					// Clear the chat window before displaying messages
					var chatWindow = document.getElementById('chat-window').querySelector('ul');
					chatWindow.innerHTML = '';

					// Display messages
					data.forEach(function (msg) {
						// showMessage(msg.senderEmail, msg.content, msg.recipientEmail, loggedInEmail);
						showMessage(msg.id, msg.senderEmail, msg.content, msg.recipientEmail, msg.timestamp, loggedInEmail);
					});
				})
				.catch(error => console.error("Error loading chat messages:", error));
		}
		let activeDeleteDropdown = null;
		function showMessage(id, senderEmail, message, recipientEmail, timestamp, loggedInEmail) {
			console.log("Message ID:", id);
			console.log(`LoggedInEmailrrr: ${loggedInEmail}, SenderEmail: ${senderEmail}`);

			const isSender = senderEmail === loggedInEmail;
			const senderName = isSender ? "Me" : Object.keys(employeeMap).find(name => employeeMap[name] === senderEmail) || senderEmail;
			const senderPhoto = employeePhotoMap[senderEmail] || 'default-avatar.png';
			const formattedTime = new Date(timestamp).toLocaleString(); // Format timestamp

			console.log(`Message ID: ${id}, Time: ${formattedTime}, From: ${senderEmail}, To: ${recipientEmail}, Content: "${message}"`);

			var chatWindow = document.getElementById('chat-window').querySelector('ul');
			var li = document.createElement('li');
			li.className = isSender ? 'clearfix right' : 'clearfix left';

			li.innerHTML = `
					    <div class="message-container" data-message-id="${id}" onclick="toggleDeleteOption(this)">
					        <img class="sender-photo" src="${senderPhoto}" alt="Sender Photo" />
					        <div class="message ${isSender ? 'my-message' : 'other-message'}">
					            <strong>${senderName}:</strong> ${message}
					        </div>
					    </div>
					    <div class="timestamp" style="text-align: ${isSender ? 'right' : 'left'};">
					        ${formattedTime}
					    </div>
					    ${isSender ? `
					        <div class="message-action-dropdown" >
					            <a class="dropdown-item" href="#" onclick="deleteMessage(this, ${id})">Delete Message</a>
					        </div>
					    ` : ''}`;

			chatWindow.appendChild(li);
			chatWindow.scrollTop = chatWindow.scrollHeight;
		}
		
		/*function fetchUnreadMessages() {
			console.log("Fetching unread messages...");
			var loggedInEmail = document.getElementById('loggedInMail').value;

			fetch(`/unread?email=${loggedInEmail}`)
				.then(response => response.json())
				.then(messages => {
					messages.forEach(message => {
						let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;

						// Show notification with sender's email as a parameter
						showToastNotification(`New message from ${senderName}: ${message.content}`, message.senderEmail);
					});
				})
				.catch(error => console.error("Error fetching unread messages:", error));
		}*/

		let displayedMessageIds = new Set(); // Track displayed messages
		let closedMessageIds = new Set(); // Track closed messages

		function fetchUnreadMessages() {
		    console.log("Fetching unread messages...");
		    var loggedInEmail = document.getElementById('loggedInMail').value;

		    fetch(`/unread?email=${loggedInEmail}`)
		        .then(response => response.json())
		        .then(messages => {
		            messages.forEach(message => {
		                console.log("Processing message ID:", message.id); // Print message ID to console
		                
		                // Ignore messages that were previously closed
		                if (!displayedMessageIds.has(message.id) && !closedMessageIds.has(message.id)) {
							//alert(1);
		                    let senderName = emailToNameMap[message.senderEmail] || message.senderEmail;
		                    showToastNotification(`New message from ${senderName}: ${message.content}`, message.id, message.senderEmail);
		                    displayedMessageIds.add(message.id); // Mark message as displayed
		                }
						//alert(2);
		            });
		        })
		        .catch(error => console.error("Error fetching unread messages:", error));
		}
		// Global flag to track if the user manually dismissed notifications
		
		/*function showToastNotification(message, senderEmail) {
			
			var toastContainer = document.createElement('div');
			toastContainer.className = 'toast-notification';

			// Add message and close button
			toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close"></span>`;

			document.body.appendChild(toastContainer);

			// Animate in
			setTimeout(() => {
				toastContainer.classList.add('show');
			}, 100);

			// Auto-hide after 8 seconds
			let autoHideTimeout = setTimeout(() => closeToast(toastContainer), 10000);

			// Prevent opening chat when clicking the close button
			toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
				event.stopPropagation(); // Prevent click from bubbling to toastContainer
				clearTimeout(autoHideTimeout);
				
				closeToast(toastContainer);
			});

			// Open chat when clicking on the notification
			toastContainer.addEventListener('click', () => {
				openChatWithSender(senderEmail);
				closeToast(toastContainer); // Remove notification when chat opens
			});
		}*/
		let displayedMessageIdsonreload = new Set(JSON.parse(sessionStorage.getItem("displayedNotifications")) || []);

		function showToastNotification(message, messageId, senderEmail) {
			//alert(1);
			if (displayedMessageIdsonreload.has(messageId)) {
						       return; // Skip if already shown
						   }

						   displayedMessageIdsonreload.add(messageId);
						   sessionStorage.setItem("displayedNotifications", JSON.stringify([...displayedMessageIdsonreload]));

		    var toastContainer = document.createElement('div');
		    toastContainer.className = 'toast-notification';
		    toastContainer.innerHTML = `<p>${message}</p> <span class="toast-close"></span>`;

		    document.body.appendChild(toastContainer);

		    // Animate in
		    setTimeout(() => {
		        toastContainer.classList.add('show');
		    }, 100);

		    // Auto-hide after 8 seconds
		    let autoHideTimeout = setTimeout(() => closeToast(toastContainer, messageId), 8000);

		    // Prevent opening chat when clicking the close button
		    toastContainer.querySelector('.toast-close').addEventListener('click', (event) => {
		        event.stopPropagation(); // Prevent click from bubbling to toastContainer
		        clearTimeout(autoHideTimeout);
		        closedMessageIds.add(messageId); // Mark as closed so it won't be shown again
		        closeToast(toastContainer, messageId);
		    });

		    // Open chat when clicking on the notification
		    toastContainer.addEventListener('click', () => {
		        openChatWithSender(senderEmail);
		        closeToast(toastContainer, messageId); // Remove notification when chat opens
		    });
		}

		// Function to handle toast closing
		/*function closeToast(toast) {
			toast.classList.remove('show');
			setTimeout(() => toast.remove(), 300); // Faster fade-out
		}*/
		// Function to handle toast closing and mark as dismissed
		// Function to handle toast closing
		function closeToast(toast, messageId) {
		    toast.classList.remove('show');
		    setTimeout(() => toast.remove(), 300); // Faster fade-out
		}
		/*	function openChatWithSender(senderEmail) {
				console.log("Opening chat with:", senderEmail);
			    
				// Construct the URL for the UserFavorite page with the senderEmail as a query parameter
				const url = `/my-favorites?email=${encodeURIComponent(senderEmail)}`;
			    
				// Redirect to the UserFavorite page
				window.location.href = url;
			}*/

		function openChatWithSender(senderEmail) {
			console.log("Opening chat with:", senderEmail);

			// Store sender email in sessionStorage
			sessionStorage.setItem("chatSenderEmail", senderEmail);

			// Redirect to the UserFavorite page
			window.location.href = `/my-favorites`;
		}

		// Connect to the WebSocket server and load employees when the page is loaded
		document.addEventListener('DOMContentLoaded', function () {
			//fetchUnreadMessages();
			loadEmployees();
			connectWebSocket();
		});

	</script>
<!-- script to focuse the side nav link when page gets loaded -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let activeLink = document.querySelector(".nav-link.active");
        if (activeLink) {
            activeLink.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    });
</script>
</body>

</html>